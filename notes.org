#+TITLE: My Notes
#+OPTIONS: H:4
#+STARTUP: overview
#+STARTUP: align
#+TODO: TODO IN-PROGRESS WAITING DONE

* PHP
** Configuration
<<<php:config>>>

Get php configuration files location ~php --ini~
Get a php config variable ~grep memory_limit /etc/php.ini~

Apache php.ini :: /etc/php/7.0/apache2/php.ini (better to create .php page with ~<?php phpinfo(); ?>~ to see the config)
Extra ini files are loaded in /etc/php/7.0/apache2/conf.d. e.g.
#+BEGIN_EXAMPLE
20-curl.ini -> /etc/php/7.0/mods-available/curl.ini
#+END_EXAMPLE

Changing php.ini requires restarting apache

Configuration setting can be set in places depending on which mode it is

PHP_INI_USER	Entry can be set in user scripts (like with ini_set()) or in the Windows registry. Since PHP 5.3, entry can be set in .user.ini
PHP_INI_PERDIR	Entry can be set in php.ini, .htaccess, httpd.conf or .user.ini (since PHP 5.3)
PHP_INI_SYSTEM	Entry can be set in php.ini or httpd.conf
PHP_INI_ALL	Entry can be set anywhere

*** <<<php:ini:mail>>>
http://php.net/manual/en/mail.configuration.php

#+BEGIN_EXAMPLE
[mail function]
; For Win32 only.
; http://php.net/smtp
SMTP = localhost
; http://php.net/smtp-port
smtp_port = 25

; For Win32 only.
; http://php.net/sendmail-from
;sendmail_from = me@example.com

; For Unix only.  You may supply arguments as well (default: "sendmail -t -i").
; http://php.net/sendmail-path
;sendmail_path =

; Force the addition of the specified parameters to be passed as extra parameters
; to the sendmail binary. These parameters will always replace the value of
; the 5th parameter to mail().
;mail.force_extra_parameters =

; Add X-PHP-Originating-Script: that will include uid of the script followed by the filename
mail.add_x_header = On

; The path to a log file that will log all mail() calls. Log entries include
; the full path of the script, line number, To address and headers.
;mail.log =
; e.g. change to 
; mail.log = /var/log/phpmaillog

; Log mail to syslog (Event Log on Windows).
;mail.log = syslog
#+END_EXAMPLE

Enable mail.log, make sure /var/log/phpmaillog has www-data:www-data as the apache

You may need to change the sendmail_path to a php wrapper instead of just adding mail.log location
http://www.matteomattei.com/how-to-log-email-sent-from-php-through-mail-function/
https://www.howtoforge.com/how-to-log-emails-sent-with-phps-mail-function-to-detect-form-spam

*** php.ini prod dev
[[https://github.com/php/php-src/blob/master/php.ini-production][prod]] [[https://github.com/php/php-src/blob/master/php.ini-development][dev]]

The value can be a string, a number, a PHP constant (e.g. E_ALL or M_PI), one of the INI constants (On, Off, True, False, Yes, No and None) or an expression (e.g. E_ALL & ~E_NOTICE), a quoted string ("bar"), or a reference to a previously set variable or directive (e.g. ${foo})

Expression
Expressions in the INI file are limited to bitwise operators and parentheses:
- |  bitwise OR
- ^  bitwise XOR
- &  bitwise AND
- ~  bitwise NOT
- !  boolean NOT

Boolean
- True :: use 1, On, True or Yes
- False :: use 0, Off, False or No

Empty string
#+BEGIN_EXAMPLE
foo =         
; sets foo to an empty string
foo = None
; sets foo to an empty string
foo = "None"
; sets foo to the string 'None'
#+END_EXAMPLE

Sample production
#+BEGIN_EXAMPLE
[PHP]
; copy from https://github.com/php/php-src/blob/master/php.ini-production

;;;;;;;;;;;;;;;;;;;
; Custom php.ini  ;
;;;;;;;;;;;;;;;;;;;

memory_limit = 128M
post_max_size = 100M
upload_max_filesize = 100M
session.cookie_lifetime = 2000000

[mail function]
; For Win32 only.
; http://php.net/smtp
;SMTP = localhost
; http://php.net/smtp-port
;smtp_port = 25

; For Win32 only.
; http://php.net/sendmail-from
;sendmail_from = me@example.com

; For Unix only.  You may supply arguments as well (default: "sendmail -t -i").
; http://php.net/sendmail-path
;sendmail_path =

; Force the addition of the specified parameters to be passed as extra parameters
; to the sendmail binary. These parameters will always replace the value of
; the 5th parameter to mail().
;mail.force_extra_parameters =
#+END_EXAMPLE

** $_SERVER
<<<php:$_SERVER>>>
[[https://stackoverflow.com/questions/6474783/which-server-variables-are-safe][Which are safe?]]

GATEWAY_INTERFACE
SERVER_ADDR
SERVER_SOFTWARE
DOCUMENT_ROOT
SERVER_ADMIN
SERVER_SIGNATURE

*** Partyly safe
HTTPS

HTTP_HOST :: see below

REQUEST_TIME
REQUEST_URI

REMOTE_ADDR
REMOTE_HOST :: 
  - relies on reverse DNS lookups and may hence be spoofed by DNS attacks against server (at that time you have bigger problems anyway)
  - Its value may be a proxy, which is a simple reality of the TCP/IP protocol and nothing you can do.
REMOTE_PORT

SERVER_PROTOCOL
SERVER_NAME :: see below
SERVER_PORT

SCRIPT_FILENAME


REMOTE_* :: values are guaranteed to be the valid address of the client as verified by a TCP/IP handshake. Because it's the address the response will be sent to

*** HTTP_HOST and SERVER_NAME
curl -H "Host: notyourdomain.com" http://yoursite.com/
By default, HTTP_HOST or SERVER_NAME is notyourdomain.com
Attackers might trigger a lot of requests and cause your website that is cached by a proxy (Varnish, Cloudflare) to have wrong cache that has content which points to the attacker's domain. Cache poisoning.

Solution
Never display $_SERVER['HTTP_HOST'] or $_SERVER['SERVER_NAME']

#+BEGIN_EXAMPLE
$config['site_url'] = 'http://' . $_SERVER['HTTP_HOST'] . '/index.php';
$config['cp_url']   = 'http://' . $_SERVER['HTTP_HOST'] . '/system/index.php';

$domain = 'example.com';
$config['site_url'] = 'http://' . $domain . '/index.php';
$config['cp_url']   = 'http://' . $domain . '/system/index.php';

$domains = array('domain.com', 'dev.domain.com', 'staging.domain.com', 'localhost');
if (in_array($_SERVER['HTTP_HOST'], $domains)) {
    $domain = $_SERVER['HTTP_HOST'];
}
else {
    $domain = 'localhost';
}
#+END_EXAMPLE

** $_FILES POST method uploads
http://www.php.net/manual/en/features.file-upload.post-method.php

enctype="multipart/form-data"

'userfile' is the <input> name attribute. If no name, then it's 'file' > $_FILES['file']

$_FILES['userfile']['name']
The original name of the file on the client machine.

$_FILES['userfile']['type']
The mime type of the file, if the browser provided this information. An example would be "image/gif". This mime type is however not checked on the PHP side and therefore don't take its value for granted.

$_FILES['userfile']['size']
The size, in bytes, of the uploaded file.

$_FILES['userfile']['tmp_name']
The temporary filename of the file in which the uploaded file was stored on the server.

$_FILES['userfile']['error']
The error code associated with this file upload.

POST as array
#+BEGIN_EXAMPLE
<form action="" method="post" enctype="multipart/form-data">
<p>Pictures:
<input type="file" name="pictures[]" />
<input type="file" name="pictures[]" />
<input type="file" name="pictures[]" />
<input type="submit" value="Send" />
</p>
</form>

foreach ($_FILES["pictures"]["error"] as $key => $error) {
    if ($error == UPLOAD_ERR_OK) {
        $tmp_name = $_FILES["pictures"]["tmp_name"][$key];
        // basename() may prevent filesystem traversal attacks;
        // further validation/sanitation of the filename may be appropriate
        $name = basename($_FILES["pictures"]["name"][$key]);
        move_uploaded_file($tmp_name, "data/$name");
    }
}
#+END_EXAMPLE

** Delete file, unlink
Use absolute path. See dirname

#+BEGIN_EXAMPLE
$files = [
    './first.jpg',
    './second.jpg',
    './third.jpg'
];

foreach ($files as $file) {
    if (file_exists($file)) {
        unlink($file);
    } else {
        // File not found.
    }
}
#+END_EXAMPLE

** Module, Extension
*** bz2
*** bcmath
*** calendar
*** enchant
*** exif
*** gd
- XPM Suport :: libXpm

*** gettext
*** intl
require debian pkg libicu-dev

*** pspell
*** soap
require debian pkg libxml2-dev

*** sockets
*** tidy
*** xmlrpc
** Locale
In Linux, you can run =locale -a= to get a list of codes
Linux return multi-letter codes. You can use 3-letter or 2-letter codes as a backup.
[[https://www.w3.org/WAI/ER/IG/ert/iso639.htm][ISO 639 3-letter codes]]

** Date
*** Create a custom date
**** mktime return Unix timestamp
$_u_time = mktime(11,0,0,11,22,2016); // hour, min, sec, month, day, year, $is_dst(daylight saving, 0 or 1)

**** String to Time
$_u_time = strtotime('2016-11-01');

// ISO date string. Refer to js:time:iso
$_u_time = strtotime('2011-10-05T14:48:00.000Z')

**** Unix timestamp (int) to datetime object
$_u_time = strtotime('2016-11-01');

$a = new DateTime();
$a->setTimestamp($_u_time);

$now = new DateTime();

**** Format difference between 2 Datetime objects
$interval = $now->diff($a);
echo $interval->format('%R%a days');

*** Date in Other Languages (Locale)
$_u_time = mktime (11, 0, 0, 11, 22, 2016);
setlocale(LC_TIME, 'fr_FR.utf8','fra'); // try fr_FR.utf8 first, if fail, try fra
$_fr_time = array();
$_fr_time[] = strftime('%A', $_u_time); // format a date/time according to locale settings
$_fr_time[] = trim(strftime('%e', $_u_time)); // day of month, single digit with leading space if it's single digit..
$_fr_time[] = strftime('%B', $_u_time);
$_fr_time[] = strftime('%Y', $_u_time);
$_fr_time = ucwords(implode(' ', $_fr_time));
echo $_fr_time;

*** Change timezone
#+BEGIN_EXAMPLE
$timezone = date_default_timezone_get(); // UTC
var_dump($timezone); // UTC

var_dump(date('Y/m/d h:i:s a',time())); // e.g. 7pm

date_default_timezone_set('America/Toronto');

var_dump(date('Y/m/d h:i:s a',time())); // e.g. 7pm +4 = 11pm
date_default_timezone_set($timezone); // UTC
var_dump(date('Y/m/d h:i:s a',time())); // e.g. 7pm
#+END_EXAMPLE

** Multibyte
*** Remove 4 byte characters
<<<php:4byte>>>
PHP UTF-8 character range is wider than MySQL utf8. MySQL's true UTF-8 is utf8mb4 but sometimes it's hard change.
mysql:charset d7:mysql:charset 

Here's how to remove any 4 byte character.

#+BEGIN_EXAMPLE
function replace4byte( $string ) {
  return preg_replace( '%(?:
          \xF0[\x90-\xBF][\x80-\xBF]{2}      # planes 1-3
        | [\xF1-\xF3][\x80-\xBF]{3}          # planes 4-15
        | \xF4[\x80-\x8F][\x80-\xBF]{2}      # plane 16
    )%xs', '', $string );
}

var_dump( 
  replace4byte( 'd' ), 
  replace4byte( 'd_Emoji_d' ) 
);
#+END_EXAMPLE

** Array
*** array_merge, array_merge_recursive
array_merge
- only merge on the first level
- If key is the same, value at later array will overwrite the first array's value.

array_merge_recursive
- If key is the same, values will be appended as array
- Very different from array_merge

*** Last element
$_last = end($target_array);
reset($target_array);

*** Search Value and Return Key
Case insensitive search
#+BEGIN_EXAMPLE
$a= array(
'k1'=> 'one',
'k2' => 'one1',
'k3' => 'three',
);

print_r( preg_grep( "/ONe$/i" , $a ) );
// Array ( [k1] => one )
#+END_EXAMPLE

Use ~in_array('string', $a)~ for case sensitive search

*** Change Case for All Keys
#+BEGIN_EXAMPLE
$_lower_GET = array_change_key_case($_GET, CASE_LOWER);
// Or CASE_UPPER
#+END_EXAMPLE

*** Get values of a column in a multidimensional array
You have this array
#+BEGIN_EXAMPLE
$records = array(
    array(
        'id' => 2135,
        'first_name' => 'John',
        'last_name' => 'Doe'
    ),
    array(
        'id' => 3245,
        'first_name' => 'Sally',
        'last_name' => 'Smith'
    ),
    array(
        'id' => 5342,
        'first_name' => 'Jane',
        // Notice! there's no last_name     
    ),
    array(
        'id' => 5623,
        'first_name' => 'Peter',
        'last_name' => 'Doe'
    )
);
#+END_EXAMPLE

array_column($records, 'last_name') is
#+BEGIN_EXAMPLE
['Doe', 'Smith', 'Doe']
#+END_EXAMPLE

array_column($records, 'last_name', 'id') is
#+BEGIN_EXAMPLE
[ 2135 => 'Doe', 3245 => 'Smith', 5623=>'Doe']
#+END_EXAMPLE

Require PHP 5.5+

*** Remove values
Single dimension
#+BEGIN_EXAMPLE
$arr = ['nice_item', 'remove_me', 'another_liked_item', 'remove_me', 'remove_me_also'];
$arr = array_diff($arr, ['remove_me', 'remove_me_also']);
#+END_EXAMPLE

*** Change values of all elements
<<<php:array_map>>>

#+BEGIN_EXAMPLE
function sanitize($s) {
  return htmlspecialchars($s);
}
$a = array('harmless', '<bad>', '>>click here!<<');
$a = array_map('sanitize', $a);
echo implode(' ', $a);
#+END_EXAMPLE

*** array_filter
callback function should return true or false. By default, only value is passed to the callback function.
Unless flag is used
#+BEGIN_EXAMPLE
$arr = ['a' => 1, 'b' => 2, 'c' => 3, 'd' => 4];

var_dump(array_filter($arr, function($k) {
    return $k == 'b';
}, ARRAY_FILTER_USE_KEY));

var_dump(array_filter($arr, function($v, $k) {
    return $k == 'b' || $v == 4;
}, ARRAY_FILTER_USE_BOTH));
#+END_EXAMPLE

Original index number is used!

** String
*** String to HTML, <<<php:DOMDocument>>>
Refer to d7:ellipsis

#+BEGIN_EXAMPLE
$dom = new DOMDocument;
$dom->loadHTML($xml);
$imgs = $dom->getElementsByTagName('img');
foreach ( $imgs as $img ) {
  echo $img->nodeValue, PHP_EOL;
  echo $img->getAttribute('src');
}
// To get the first img
$_first_img = $imgs->item(0);

echo $_first_img->getAttribute('src');
#+END_EXAMPLE

*** String Ellipsis, Trim
wp:ellipsis d7:ellipsis

*** Encode HTML
htmlspecialchars produces less code than htmlentities
#+BEGIN_EXAMPLE
echo htmlentities('<Il était une fois un être>.');
// Output: &lt;Il &eacute;tait une fois un &ecirc;tre&gt;.
//                ^^^^^^^^                 ^^^^^^^

echo htmlspecialchars('<Il était une fois un être>.');
// Output: &lt;Il était une fois un être&gt;.
//                ^                 ^
#+END_EXAMPLE

Drupal check_plain is ~htmlspecialchars($text, ENT_QUOTES, 'UTF-8');~

& (ampersand) :: &amp;
" (double quote) :: &quot;, unless ENT_NOQUOTES is set
' (single quote) :: &#039; (for ENT_HTML401) or &apos; (for ENT_XML1, ENT_XHTML or ENT_HTML5), but only when ENT_QUOTES is set
< (less than) :: &lt;
> (greater than) :: &gt;

#+BEGIN_EXAMPLE
// Sanitize $_POST value to safe html text
if (!function_exists("check_plain")) {
  function check_plain($text) {
    return htmlspecialchars($text, ENT_QUOTES, 'UTF-8');
  }
}
#+END_EXAMPLE

*** Replace last
#+BEGIN_EXAMPLE
function str_lreplace($search, $replace, $subject)
{
    $pos = strrpos($subject, $search);

    if($pos !== false)
    {
        $subject = substr_replace($subject, $replace, $pos, strlen($search));
    }

    return $subject;
}
#+END_EXAMPLE

*** Start with
#+BEGIN_EXAMPLE
$target_prefix = '/inventory/';
if( strcasecmp(substr($request_uri, 0, strlen($target_prefix)), $target_prefix) === 0 ){
  $q['pagename'] = urlencode('inventory');
  unset($q['name']);
}
#+END_EXAMPLE
** URL
#+BEGIN_EXAMPLE
$query_string = 'foo=' . urlencode($foo) . '&bar=' . urlencode($bar);
echo '<a href="mycgi?' . htmlentities($query_string) . '">';
#+END_EXAMPLE

To encode path
#+BEGIN_EXAMPLE
echo '<a href="ftp://user:', rawurlencode('foo @+%/'),
     '@ftp.example.com/x.txt">';
echo '<a href="http://example.com/department_list_script/',
    rawurlencode('sales and marketing/Miami'), '">';
#+END_EXAMPLE

urlencode encodes spaces as plus signs current URL
#+BEGIN_EXAMPLE
$url = $_SERVER['REQUEST_URI'];
$parts = parse_url($url);
parse_str($parts['query'], $query);
echo $query['email'];

$str = "first=value&arr[]=foo+bar&arr[]=baz";

parse_str($str, $output);
echo $output['first'];  // value
echo $output['arr'][0]; // foo bar
echo $output['arr'][1]; // baz
#+END_EXAMPLE

** Include file
#+BEGIN_EXAMPLE
include __DIR__ . "/../abc.";

# PHP version < 5
include dirname(__FILE__) . "/../../../../../wp-content/themes/a-theme/includes/thank-you.php"; 
#+END_EXAMPLE

** Random Integer Number
There're several ways

#+BEGIN_EXAMPLE
$numbers = range(0,12); // 0, 1, 2, ..., 12
shuffle($numbers);
echo $numbers[0];
#+END_EXAMPLE

#+BEGIN_EXAMPLE
echo(mt_rand(10,100)); // min: 0, max: 100
$rnd = rand(pow(10, 8-1), pow(10, 8)-1); // random 7 digits integer
#+END_EXAMPLE

** encrypt, decrypt

#+BEGIN_EXAMPLE
$data = "hello";
$method = "aes-256-cbc";
$key = "123455";
$iv = "1234567890123456"; // has to be 16 bytes or 16 text characters
$iv = openssl_random_pseudo_bytes(16); // $iv should be different every time

$options = 0; // If $data, $key and $iv are normal text like above, 0 can be used. Output is base64 encoded string
// Otherwise use OPENSSL_RAW_DATA. Output is binary

$encryptedMessage = openssl_encrypt($data, $method, $key, $options, $iv);

echo $encryptedMessage.PHP_EOL; // because $options is 0, the encrypted message is base64 encoded

$decryptedMessage = openssl_decrypt($encryptedMessage, $method, $key, $options, $iv);
#+END_EXAMPLE

If $encryptedMessage, $key and $iv are all hex, you need to convert them to binary to decrypt
<<<php:openssl_decrypt>>>
Refer to nodejs:decrypt
#+BEGIN_EXAMPLE
$fromNode = 'encryptedString$intializedVector';
$fromNode = explode('$', $fromNode);
$key = '64 hex characters'; // same as in nodejs

$data = hex2bin($fromNode[0]);
$keyAES = hex2bin($key);
$iv = hex2bin($fromNode[1]);
$options = OPENSSL_RAW_DATA; // Input are all binary, output is binary, too. 
// But because the encrypted message is a string, the decrypted message is a string.

$decrypted = openssl_decrypt($data, 'aes-256-cbc', $keyAES, $options, $iv);

// If $data, $keyAES and $iv are raw data (bytes), use OPENSSL_RAW_DATA as $options
// if all 3 of them are string, use 0 as $options
#+END_EXAMPLE

** HTML encode and decode
#+BEGIN_EXAMPLE
$t = '<a href="http://expample.com">Hello L\'automobile from "Me"</a>';
var_dump(htmlentities($t, ENT_QUOTES, 'UTF-8'));
var_dump(html_entity_decode($t, ENT_QUOTES, 'UTF-8'));
// The same as D7 decode_entities($t)
#+END_EXAMPLE

ENT_QUOTES is to convert both single ~&#039;~ and double ~&quot;~ quotes.

** Heredoc, Nowdoc
Heredoc result is a double-quoted string
#+BEGIN_EXAMPLE
$html = <<<HTML
<span>{$obj->name[1]}</span>
HTML;
#+END_EXAMPLE

Nowdoc can't expand variables and the result is single quoted string
#+BEGIN_EXAMPLE
echo <<<'EOT'
<span>{$obj->name[1]}</span>
EOT;
#+END_EXAMPLE

** Buffer
<<<php:buffer>>>
http://php.net/manual/en/book.outcontrol.php
https://phpfashion.com/everything-about-output-buffering-in-php
Send headers to browser after php has begun outputting data.

#+BEGIN_EXAMPLE
// set header
ob_start();
echo "Hello\n";

setcookie("cookiename", "cookiedata");

// the same header cannot be set because it's already been sent
ob_end_flush();
#+END_EXAMPLE

ob_start() can be stacked

Flush means send to output

ob_end_flush :: send and turn off output buffering
ob_get_flush :: send, return and turn off
ob_flush :: send
ob_clean :: erase the output buffer
ob_end_clean :: erase and turn off
ob_get_clean :: return and erase = ob_get_contents + ob_end_clean
ob_get_contents :: return

ob_get_length

#+BEGIN_EXAMPLE
ob_start();
?>
    <div id="site_header">
        <div id="site_header_inner">
            <div id="site_header_logo"><?php echo $PhpVar; ?></div>
            <div id="site_header_countdown">BARE XX DAGER IGJEN</div>
        </div>
    </div>
<?php
$output = ob_get_clean();
//ob_flush();

return $output;
#+END_EXAMPLE

** Template System
#+BEGIN_EXAMPLE
static public function renderHeader($data = array()) {
  $localData = array();
  return self::renderView(__DIR__ . '/../views/header.php', $localData);
}

static private function renderView($path, $data=array()) {
  ob_start();
  if (file_exists($path)) {
    include ($path);
  }
  // else throw new TemplateNotFoundException();
  return ob_get_clean();
}
#+END_EXAMPLE

header.php
#+BEGIN_EXAMPLE
<?php echo $data['a']; ?>
#+END_EXAMPLE

** Image
*** GD vs Imagick
GD is the oldest. Imagick might not exist in some hosting.

#+BEGIN_EXAMPLE
if(extension_loaded('gd')) {
    print_r(gd_info());
}
else {
    echo 'GD is not available.';
}

if(extension_loaded('imagick')) {
    $imagick = new Imagick();
    print_r($imagick->queryFormats());
}
else {
    echo 'ImageMagick is not available.';
}
#+END_EXAMPLE

GD only supports JPG, PNG, GIF, WBMP, WebP, XBM and XPM.
If TIFF needs to be supported, use Imagick.

*** Create image in memory and output
#+BEGIN_EXAMPLE
$data = 'iVBORw0KGgoAAAANSUhEUgAAABwAAAASCAMAAAB/2U7WAAAABl'
       . 'BMVEUAAAD///+l2Z/dAAAASUlEQVR4XqWQUQoAIAxC2/0vXZDr'
       . 'EX4IJTRkb7lobNUStXsB0jIXIAMSsQnWlsV+wULF4Avk9fLq2r'
       . '8a5HSE35Q3eO2XP1A1wQkZSgETvDtKdQAAAABJRU5ErkJggg==';
$data = base64_decode($data);

$im = imagecreatefromstring($data);
if ($im !== false) {
  header('Content-Type: image/png');
  imagepng($im);
  imagedestroy($im);
}
else {
    echo 'An error occurred.';
}
#+END_EXAMPLE

I think header:cache-control is automatically set to no cache
To set Content-Length, do this
#+BEGIN_EXAMPLE
ob_start();
imagejpeg($img);

header('Content-Type: image/jpg');
header("Content-length: " . ob_get_length()); 
// images do not compression e.g. gzip

imagedestroy($im);
// send it
ob_flush();
#+END_EXAMPLE

*** Resize image
[[https://github.com/claviska/SimpleImage][SimpleImage - GD library]]

#+BEGIN_EXAMPLE
require 'SimpleImage.php';
try {
  // Create a new SimpleImage object
  $image = new \claviska\SimpleImage();
  //$new_file = __DIR__ . '/'.$file_path.$file_no_ext.'_200x200f.'.$ext;
  $new_file = $file_path.$file_no_ext.'_200x200f.'.$ext;

  $image
    ->fromFile($file_orig_full)              // load parrot.jpg
    //->autoOrient()                        // adjust orientation based on exif data
    ->bestFit(200, 200)
    ->toFile($new_file);                         // output to the screen
  $localW = $image->getWidth();
  $localH = $image->getHeight();
  var_dump($localW, $localH);
} catch(Exception $err) {
  // Handle errors
  echo $err->getMessage();
}
#+END_EXAMPLE

** Apply XSLT on XML
#+BEGIN_EXAMPLE
$xml = new DOMDocument;
$xml->load('cdcatalog.xml');

$xsl = new DOMDocument;
$xsl->load('cdcatalog.xsl');

$proc = new XSLTProcessor;
$proc->importStyleSheet($xsl);

echo $proc->transformToXML($xml);
#+END_EXAMPLE

** Block Referral Traffic
#+BEGIN_EXAMPLE
if ( isset( $_SERVER['HTTP_REFERER'] ) ) {
  $_referer_domain = array(
    "~timebie\.com~i",
    "~ana-white\.com~i",
    "~mlizcochico\.com~i",
    "~adishofdailylife\.com~i",
    "~techvibes\.com~i",
    "~sociableblog\.com~i",
    "~laurenconrad\.com~i",
    "~gingerhotels\.com~i",
    "~grammarist\.com~i",
    "~dobbersports\.com~i",
    "~netsidebar\.com~i",
    "~myhomeideas\.com~i",
    "~fhm\.com~i",
    "~gamezebo\.com~i"
  );

  foreach ( $_referer_domain as $_referer ) {
    if ( preg_match( $_referer, $_SERVER['HTTP_REFERER'] ) ) {
      exit;
    }
  }
  // php:parse_url
  $_referrer = parse_url($_SERVER['HTTP_REFERER']);
  if ($_referrer !== false && !is_null($_referrer['host'])
      && preg_match( "~oralhealthgroup\.com~i", $_referrer['host'] )) {
    $_p = (isset($_GET['p'])) ? $_GET['p'] : '';
    $_subid = (isset($_GET['subid'])) ? $_GET['subid'] : '';
    $_uid = (isset($_GET['uid'])) ? $_GET['uid'] : '';
    if ($_p !== '' && $_subid !== '' && $_uid !== '') {
      exit;
    }
  }
}
#+END_EXAMPLE

** PHPDoc <<<PHPDoc>>>
https://www.drupal.org/coding-standards/docs
https://www.drupal.org/node/1354
The docblock has to be immediately above the code.

#+BEGIN_EXAMPLE
/**
 * One-line summary, ending in a period (.).
 *
 * Additional paragraph of explanation.
 * Additional paragraph of explanation.
 *
 * @since 3.1.0
 * @param string $mail
 *   The email address. The description can be longer if necessary, and if so,
 *   you can wrap it to another line. Indented by 2 spaces
 * @param string $from
 *   (optional) The email address to send the mail from, if different from
 *   the site-wide address.
 * @param string $bcc One line description.
 * @return int One line description.
 */
#+END_EXAMPLE

Order of sections
- One-line summary ending in a period .
- Addtional paragraphs of explanation
- @var :: PHPDoc:@var
- @param :: only for function
- @return
- @throws
- @ingroup
- @deprecated
- @see :: PHPDoc:@see
- @todo
- @Plugin

Separate different-type sections by a blank line
#+BEGIN_EXAMPLE
// blank line
@param first param
@param second param
// blank line
@return
#+END_EXAMPLE

*** Tag reference
**** @code
#+BEGIN_EXAMPLE
 * Example usage:
 * @code
 * mymodule_print('Hello World!');
 * @endcode
 * Text to immediately follow the code block.
#+END_EXAMPLE

*** datatype <<<PHPDoc:datatype>>>
#+BEGIN_EXAMPLE
int
string|bool
\Drupal\Core\Database\StatementInterface
int[]
\Drupal\node\NodeInterface[]
$this
static
null
object
resource
true
false
float
#+END_EXAMPLE

Examples
#+BEGIN_EXAMPLE
@return $this
@return static
#+END_EXAMPLE

*** @var <<<PHPDoc:@var>>>
@var [PHPDoc:datatype]
#+BEGIN_EXAMPLE
class FooBar {

  /**
   * The database connection object for this statement's DatabaseConnection.
   *
   * @var \Drupal\Core\Database\Connection
   */
  public $dbh;

}
#+END_EXAMPLE

*** @see <<<PHPDoc:@see>>>
#+BEGIN_EXAMPLE
@see AnotherClassName::Methodname() or AnotherClassName::$varname
@see elementname() => to search a function or method
@see $elementname => to search var in the current class
#+END_EXAMPLE

*** @example
It can be used to demo by presenting the contents of files that use them.

#+BEGIN_EXAMPLE
@example [location] [<start-line> [<number-of-lines>] ] [<description>]
@example example1.php Some Description
#+END_EXAMPLE

** mysqli
#+BEGIN_EXAMPLE
$mysqli = new mysqli("localhost", "my_user", "my_password", "world");

/* check connection */
if (mysqli_connect_errno()) {
    printf("Connect failed: %s\n", mysqli_connect_error());
    exit();
}

$mysqli->query("CREATE TEMPORARY TABLE myCity LIKE City");

$city = "'s Hertogenbosch";

$city = $mysqli->real_escape_string($city);

if ($mysqli->query("INSERT into myCity (Name) VALUES ('$city')")) {
    printf("%d Row inserted.\n", $mysqli->affected_rows);
}


// You don't have to close it
// $mysqli->close();
#+END_EXAMPLE

** OOP
OOP Features
- Abstraction
- Encapsulation (expose functionality and access control)
  - protected :: accessed within class, inherited (parent) / inheriting (child) classes
  - private :: only the current class can access
  - prefix underscore for protected and private properties' names
- Hierarchy (inheritance)
- Modularity (accomplish one task)
- Polymorphism (interface :: interact with classes without knowing what class it is) 

*** Sample
#+BEGIN_EXAMPLE
$rest = new RestJson('12345', 'trucks', 'new');
// Class name should use UpperCamel, can have underscores and numbers
// SampleXmlClass, not SampleXMLClass
// Names should not include Drupal, Class
// Interface should always prefix "Interface"
class RestJson {
  // constant: strings, booleans, integers
  const MY_CONSTANT_VAR = 1;

  public static $valid_address_types = [
     RestJson::MY_CONSTANT_VAR => 'Residence',
  ];

  public static $filterables; // singleton. same for every instance.

  public $lwp_options, $listings; // can be different for each instance

  // Can only be updated by static function/method

  // variable and function names should be lowerCamel and avoid underscores

  // variable can have default value that is static. e.g. value of time() is not allowed or reference to another varialbe $a = $b

  public function __construct($did, array $industry, $condition)  {
    // Call a static function
    $this->lwp_options = self::getLwpOptions();
    // Call a instance function
    $this->listings = $this->getListings();
   
  }

  public static getLwpOptions() {
    // A static function can return a value
    // can change a static property
    // self::$filterables[] = '123';
    // But can't access the instance $this
    // Can't modify instance value $this->aPropertyName
    // Can't call instance method $this->aMethod();
  }
}

// Class::method()
// Class::$property
#+END_EXAMPLE

*** Inheritance
Child can override parent's constants but not constants declared in interface
Child can override parent's methods but with the same name and arguments (except constructors)
Child can override parent's methods and make them have the same or less restricted visibility
#+BEGIN_EXAMPLE
// class ParentChild extends Parent {}
class AddressResidence extends Address {}
#+END_EXAMPLE

*** Abstract Class
Abstract class cannot be instantiated
If a method is abstract, any class (not abstract class) that extends that abstract class containing the method must also declare a method with the same name and arguments.
If a class has an abstract method, then the class itself must be abstract.

#+BEGIN_EXAMPLE
abstract class Address {
  public function __construct() {
    $this->_init();
  }

  /**
   * Force extending classes to implement init method.
   */
  abstract protected function _init();
}

class AddressBusiness extends Address {
  // Methods that implement abastract method
  // must have the same scope OR less restrictive
  protected function _init() {
    $this->_setAddressTypeId(Address::ADDRESS_TYPE_BUSINESS);
  }
}
#+END_EXAMPLE

*** Interface
Specify what methods must be implemented but not how
A class can implement multiple interfaces
Use ~final~ in parent class to prevent child class from overriding the method/property

#+BEGIN_EXAMPLE
final public function load() {}
#+END_EXAMPLE

*** Interface vs Abstract Class
- Interfaces  can have no state or implementation
- a class that implements an interface must provide an implementation of all the methods of the interface
- abstract classes may contain state (data members) and/or implementation (methods)
- abstract classes can be inherited without implementing the abstract methods
- interfaces may be multiple-inherited, abstract classes may not. Biggest difference.

*** Use trait with interface
Always use a trait that fulfils one, all or extra capabilities that are
- required by an interface that the current class implements
- or required by an abstract class that the current class extends

#+BEGIN_EXAMPLE
interface Person {
    public function greet();
    public function eat($food);
}

trait EatingTrait {
    public function eat($food)
    {
        $this->putInMouth($food);
    }

    private function putInMouth($food)
    {
        // digest delicious food
    }
}

class NicePerson implements Person {
    use EatingTrait;

    public function greet()
    {
        echo 'Good day, good sir!';
    }
}

class MeanPerson implements Person {
    use EatingTrait;

    public function greet()
    {
        echo 'Your mother was a hamster!';
    }
}
#+END_EXAMPLE

*** Magic Methods
http://php.net/manual/en/language.oop5.magic.php
Starts with 2 underscores. They are for:
- Trigger custom behavior
- Customize object creation
- Ignore scope :: access or change hidden properties
- With magic method, the performance is about 3 to 10 times slower..

**** Overloading
These are to dynamically "create" a property or method of an instance that has not been declared, or is not visible in the current scope.

Can't be used in static properties.

__set() is triggered when writing data to inaccessible properties
__get() is triggered when reading data from inaccessible properties.

They are all public functions

#+BEGIN_EXAMPLE
protected $_postal_code;

function __get($name) {
  
  if (!$this->_postal_code) {
    $this->_postal_code = $this->_postal_code_guess();
  }
  $protected_property_name = '_' . $name;
  if (property_exists($this, $proteced_property_name)) {
   return $this->$protected_property_name;
  }

  trigger_error('Undefined property via __get:' . $name);
  return NULL;
}
#+END_EXAMPLE

**** __construct, __destruct
#+BEGIN_EXAMPLE
class BaseClass {
  function __construct() {
    print "In BaseClass constructor\n";
  }
}

class SubClass extends BaseClass {
  function __construct() {
    parent::__construct();
    print "In SubClass constructor\n";
  }
}
#+END_EXAMPLE

**** __toString()
Turn an object to a string when ~echo $obj;~ Exception cannot be thrown within __toString() method.

**** __clone()

#+BEGIN_EXAMPLE
class SubObject
{
  static $instances = 0;
  public $instance;

  public function __construct() {
    $this->instance = ++self::$instances;
  }

  public function __clone() {
    $this->instance = ++self::$instances;
  }
}

class MyCloneable
{
  public $object1;
  public $object2;

  function __clone()
  {
    // Force a copy of this->object, otherwise
    // it will point to same object. (shallow copy)
    $this->object1 = clone $this->object1;
  }
}

$obj = new MyCloneable();

$obj->object1 = new SubObject();
$obj->object2 = new SubObject();

$obj2 = clone $obj;


print("Original Object:\n");
print_r($obj);

print("Cloned Object:\n");
print_r($obj2);


Original Object:
MyCloneable Object
(
  [object1] => SubObject Object
(
  [instance] => 1
        )

    [object2] => SubObject Object
(
  [instance] => 2
        )

)
Cloned Object:
MyCloneable Object
(
  [object1] => SubObject Object
(
  [instance] => 3
        )

    [object2] => SubObject Object
(
  [instance] => 2
        )

)
#+END_EXAMPLE

*** Clone, copy and reference
$obj1 == $obj2 :: do 2 objects have the same property names and values
$obj1 === $obj2 :: do 2 objects have the same properties and also are those 2 instances of the same class
get_class($obj1) ::
$obj1 instanceof AddressBusiness ::

Clone, rather than just $obj1=$obj2, __clone magic method can be used.
Reference is faster than clone and direct copy. But when ~===~ is used to compare the two, they are different.

#+BEGIN_EXAMPLE
$address_business = new AddressBusiness(array(
  'street_address_1' => '123 Phony Ave',
  'city_name' => 'Villageland',
  'subdivision_name' => 'Region',
  'country_name' => 'Canada',
));

$address_park = new AddressPark(array(
  'street_address_1' => '789 Missing Circle',
  'street_address_2' => 'Suite 0',
  'city_name' => 'Hamlet',
  'subdivision_name' => 'Territory',
  'country_name' => 'Australia',
));
echo $address_park;

echo '<h2>Cloning AddressPark</h2>';

$address_park_clone = clone $address_park;

echo '$address_park_clone is ' . ($address_park == $address_park_clone ?
  '' : 'not ') . ' a copy of $address_park.';
// $address_park_clone is a copy of $address_park

echo '<h2>Copying AddressBusiness reference</h2>';

$address_business_copy = &$address_business;

echo '$address_business_copy is ' . ($address_business === $address_business_copy ?
  '' : 'not ') . ' a copy of $address_business.';
// $address_business_copy is a copy of $address_business

echo '<h2>Setting address_business_copy as a new AddressPark</h2>';
$address_business = new AddressPark();

echo '$address_business_copy is ' . ($address_business === $address_business_copy ?
  '' : 'not ') . ' a copy of $address_business.';

// $address_business_copy is not a copy of $address_business

echo '<br/>$address_business is class ' . get_class($address_business) . '.';

// $address_business is class AddressPark.

echo '<br/>$address_business_copy is ' . ($address_business_copy instanceof
AddressBusiness ? '' : 'not ') . ' an AddressBusiness.';

// $address_business_copy is an AddressPark
#+END_EXAMPLE

*** Autoload Classes
#+BEGIN_EXAMPLE
function my_autoloader($class) {
    include 'classes/' . $class . '.class.php';
}

spl_autoload_register('my_autoloader');

// Or, using an anonymous function as of PHP 5.3.0
spl_autoload_register(function ($class) {
    include 'classes/' . $class . '.class.php';
});
#+END_EXAMPLE

#+BEGIN_EXAMPLE
namespace Foobar;

class Foo {
    static public function test($name) {
        print '[['. $name .']]';
    }
}

spl_autoload_register(__NAMESPACE__ .'\Foo::test'); // As of PHP 5.3.0
#+END_EXAMPLE

*** Design Pattern
**** Singleton Pattern
e.g. database connection

**** Lazy Initialization
- at the beginning properties are null and populated on demand
- If null, set and return
- If value, just return

**** Factory Method
Creat objects without specifying class
#+BEGIN_EXAMPLE
class Address {
  const ADDRESS_TYPE_RESIDENCE = 2;
  
  static public $valid_address_types = array(
    Address::ADDRESS_TYPE_RESIDENCE => 'Residence',
    Address::ADDRESS_TYPE_BUSINESS => 'Business',
    Address::ADDRESS_TYPE_PARK => 'Park',
  );

  final public static function getInstance($address_type_id, $data = []) {
    $class_name = 'Address'. self::$valid_address_types[$address_type_id];
    if (!class_exists($class_name)) {
      throw new ExceptionAddress('Address subclass not found. cannot create: ', self::ADDRESS_ERROR_UNKNOWN_SUBCLASS);
    }
    return new $class_name($data);
  }
}

// end class

$address_residence = AddressFactory::getInstance(Address::ADDRESS_TYPE_RESIDENCE);
#+END_EXAMPLE

**** Strategy Pattern
- Finite number of strategies, check each one if it can be satisfied in a loop, the last strategy is the best preferred one
- Each strategy implements a common interface which has a check method: isAvailable and a action-method: display
- Each strategy is singleton
- The best strategy is chosen in an Lazy Initialization process

#+BEGIN_EXAMPLE
class Address {
  const ADDRESS_ERROR_NO_DISPLAY_STRATEGY = 1002;

  private static $_display_strategies = [
    'AddressDisplayNoCountry', 'AddressDisplayFull', 'AddressDisplayPark'
  ];

  private $_display_strategy;

  function display() {
    // Lazy initialization
    if (is_null($this->_display_strategy)) {
      foreach (self::$_display_strategies as $strategy_class_name) {
        if ($strategy_class_name::isAvailable($this)) {
          $this->_display_strategy = $strategy_class_name;
        }
      }
    }
    if (!$this->_display_strategy) {
      throw new Exception('No display strategy found', self::ADDRESS_ERROR_NO_DISPLAY_STRATEGY);
    }
    $display_strategy = $this->_display_strategy;
    return $display_strategy::display($this);

  }

}
#+END_EXAMPLE

#+BEGIN_EXAMPLE
interface AddressDisplay {
  /**
   * AddressDisplay an Address.
   * @return string
   */
  public static function display($address);

  /**
   * Is this method of display available?
   * @return boolean
   */
  public static function isAvailable($address);
}
#+END_EXAMPLE

#+BEGIN_EXAMPLE
class AddressDisplayFull implements AddressDisplay {
  /**
   * Display an addess with a country.
   */
  public static function display($address) {
    $output = AddressDisplayNoCountry::display($address);
    $output .= '<br/>';
    $output .= $address->country_name;
    return $output;
  }

  /**
   * Is this method of display available?
   * @return boolean
   */
  public static function isAvailable($address) {
    return $address->country_name ? TRUE : FALSE;
  }
}
#+END_EXAMPLE

**** Dependency Injection

#+BEGIN_EXAMPLE
class StoreService {
    private $geolocationService;

    public function __construct(GeolocationService $geolocationService) {
        $this->geolocationService = $geolocationService;
    }

    public function getStoreCoordinates($store) {
        return $this->geolocationService->getCoordinatesFromAddress($store->getAddress());
    }
}
#+END_EXAMPLE

#+BEGIN_EXAMPLE
interface GeolocationService {
    public function getCoordinatesFromAddress($address);
}

class GoogleMaps implements GeolocationService { ...

class OpenStreetMap implements GeolocationService { ...
#+END_EXAMPLE

**** Decorator
Class Book has 3 methods: getAuthor, getTitle, getAuthorAndTitle

Decorator BookTitleDecorator adds methods: resetTitle and showTitle. When it instaniates, it resets the title of an instance of Book (in this example, the original title is not changed)
Decorator BookTitleStarDecorator extends BookTitleDecorator and adds method ~starTitle~ which outputs title in a different format
Decorator BookTitleExclaimDecorator extends BookTitleDecorator and adds metod ~exclaimTitle~ which outputs title in another different format

Decorator adds a wrapper on top of the original class Book with extra functions. This way it doesn't change other instances of the Book class.

Because the base decorator BookTitleDecorator has dependency injection of class Book, it also has Dependency Injection design pattern.

Moreover, a decorator has to know which class the decorator decorates. But this class can be abstract (superclass).

#+BEGIN_EXAMPLE
$patternBook = new Book('Gamma, Helm, Johnson, and Vlissides', 'Design Patterns');
$decorator = new BookTitleDecorator($patternBook);
$starDecorator = new BookTitleStarDecorator($decorator);
$exclaimDecorator = new BookTitleExclaimDecorator($decorator);
 
  writeln('showing title : ');
  writeln($decorator->showTitle());
  writeln('');
 
  writeln('showing title after two exclaims added : ');
  $exclaimDecorator->exclaimTitle();
  $exclaimDecorator->exclaimTitle();
  writeln($decorator->showTitle());
  writeln('');
 
  writeln('showing title after star added : ');
  $starDecorator->starTitle();
  writeln($decorator->showTitle());
  writeln('');
 
  writeln('showing title after reset: ');
  writeln($decorator->resetTitle());
  writeln($decorator->showTitle());
  writeln('');

  writeln('END TESTING DECORATOR PATTERN');

  function writeln($line_in) {
    echo $line_in."<br/>";
  }
#+END_EXAMPLE

#+BEGIN_EXAMPLE
class Book {
    private $author;
    private $title;
    function __construct($title_in, $author_in) {
        $this->author = $author_in;
        $this->title  = $title_in;
    }
    function getAuthor() {
        return $this->author;
    }
    function getTitle() {
        return $this->title;
    }
    function getAuthorAndTitle() {
      return $this->getTitle().' by '.$this->getAuthor();
    }
}

class BookTitleDecorator {
    protected $book;
    protected $title;
    public function __construct(Book $book_in) {
        $this->book = $book_in;
        $this->resetTitle();
    }   
    //doing this so original object is not altered
    function resetTitle() {
        $this->title = $this->book->getTitle();
    }
    function showTitle() {
        return $this->title;
    }
}

class BookTitleExclaimDecorator extends BookTitleDecorator {
    private $btd;
    public function __construct(BookTitleDecorator $btd_in) {
        $this->btd = $btd_in;
    }
    function exclaimTitle() {
        $this->btd->title = "!" . $this->btd->title . "!";
    }
}

class BookTitleStarDecorator extends BookTitleDecorator {
    private $btd;
    public function __construct(BookTitleDecorator $btd_in) {
        $this->btd = $btd_in;
    }
    function starTitle() {
        $this->btd->title = Str_replace(" ","*",$this->btd->title);
    }
}
#+END_EXAMPLE

*** Namespace
./index.php
#+BEGIN_EXAMPLE
include_once __DIR__."/../app/config.php";
include_once __DIR__."/../app/controllers/sys-curl.php"
#+END_EXAMPLE

./../app/config.php
#+BEGIN_EXAMPLE
namespace MyApp\Abc;
class CONFIG {
  static public function config() {
    return 'abc';
  }
}
#+END_EXAMPLE

./../app/controllers/sys-curl.php
#+BEGIN_EXAMPLE
namespace MyApp\Abc;
class SYS_CURL {
  public function PULL() {
    $config = CONFIG::config();
  }
}
#+END_EXAMPLE

** Http Request
cURL-less method for PHP5 but requires file_get_contents. Some host might disable file_get_contents. Use cURL method
#+BEGIN_EXAMPLE
$url = 'http://server.com/path';
$data = array('key1' => 'value1', 'key2' => 'value2');

// use key 'http' even if you send the request to https://...
$options = array(
    'http' => array(
        'header'  => "Content-type: application/x-www-form-urlencoded\r\n",
        'method'  => 'POST',
        'content' => http_build_query($data)
    )
);
$context  = stream_context_create($options);
$result = file_get_contents($url, false, $context);
if ($result === FALSE) { /* Handle error */ }

var_dump($result);
#+END_EXAMPLE

#+BEGIN_EXAMPLE
$url = 'http://www.someurl.com';
$myvars = 'myvar1=' . $myvar1 . '&myvar2=' . $myvar2;

$ch = curl_init();
// use curl_setopt to set each one
// curl_setopt( $ch, CURLOPT_POST, 1);

// use curl_setopt_array to set multiple
$options = array(
 CURLOPT_URL => $url,
 CURLOPT_POSTFIELDS => $myvars,
 CURLOPT_FOLLOWLOCATION =>  1,
 CURLOPT_HEADER => 0,
 CURLOPT_RETURNTRANSFER => 1
);

curl_setopt_array($ch, $options);

$response = curl_exec( $ch );
curl_close($ch);
#+END_EXAMPLE

** Troubleshooting
*** Parse error: syntax error, unexpected end of file
Or ~Parse error: syntax error, unexpected 'endwhile' (t_endwhile)~

Check if php ~short_open_tag~ is enabled. Default is not enabled. 
Then search ~<? ~ with a space and replace them with ~<?php~

** Naming Convention
ClassNamesLike
methodName
propertyName
function_name (global function)
FunctionNamesLike (local function) 
$variable_name
$localVariableName

CONSTANTS_LIKE_THIS

Global names must be prefixed or use namespace.

** Shell Exec Command
#+BEGIN_EXAMPLE
echo shell_exec("whoami");
#+END_EXAMPLE

** Session
PHP relies on client cookie PHPSESSID to identify session.

Javascript XMLHttpRequest made on the same domain always transfer all cookies.

#+BEGIN_EXAMPLE
// need to start session. check if session is already started.
if (session_id() == "")
  session_start();
#+END_EXAMPLE

** RESTful
GET /tickets - Retrieves a list of tickets
GET /tickets/12 - Retrieves a specific ticket
POST /tickets - Creates a new ticket
PUT /tickets/12 - Updates ticket #12
PATCH /tickets/12 - Partially updates ticket #12
DELETE /tickets/12 - Deletes ticket #12

Read Put request
#+BEGIN_EXAMPLE
$method = $_SERVER['REQUEST_METHOD'];
if ('PUT' === $method) {
    parse_str(file_get_contents('php://input'), $_PUT);
    var_dump($_PUT); //$_PUT contains put fields 
}
#+END_EXAMPLE

* phpMyAdmin
Just put sql-admin to any Wordpress website root directory and run http://yourwebsiteip:port/sql-admin
You don't need to do anything else.

It first loads sql-admin\libraries\config.default.php and then load sql-admin\config.inc.php
To create a config.inc.php, just duplicate sql-admin/config.sample.inc.php

* Drupal
** Install Drupal on Windows
https://www.drupal.org/node/970492

** Update Core
pantheon:drupal:core

https://www.drupal.org/docs/7/updating-your-drupal-site/how-to-update-drupal-core
Summary
- Make backup
- Download and Extract
- Set website on maintenance mode
- Delete all files and folders except /sites. 
- If you make changes else where, reapply them after copy and paste.
 - Such as /profile folder if Drupal installation is built from a distribution
- Some updates don't include settings.php. If it includes, replace the old one in /sites/default/ with the new one and apply your previous changes
- If you have modified files such as .htaccess or robots.txt, reapply those changes
- replace favicon.ico
- Login as user 1 and run update.php
- Disable maintenance mode

*** 7.x
Legend
- If no changes for .htaccess, web.config, robots.txt nor settings.php, then there's no description. Otherwise, it will indicate which ones to update.
7.50 :: d7:ts:module is missing robots.txt, default.settings.php, add .editorconfig file
7.51, 7.52
[[https://www.drupal.org/project/drupal/releases/7.53][7.53]] :: update jQuery to 1.7-1.11.0
[[https://www.drupal.org/project/drupal/releases/7.54][7.54]]
[[https://www.drupal.org/project/drupal/releases/7.55][7.55]]
[[https://www.drupal.org/project/drupal/releases/7.56][7.56]] :: security

*** Troubleshoot
**** The following module is missing from the file system
<<<d7:ts:module is missing>>>
https://www.drupal.org/node/2487215

My situation is that a module is installed but removed from file system without disabling and uninstalling it
Because the module code no longer exists, so I need to manually remove traces in db.
D7
#+BEGIN_EXAMPLE
drush sql-query "DELETE from system where name = 'old_module1' AND type = 'module';"
#+END_EXAMPLE

If module name is not found in db, most likely the code incorrectly refers to a non-existing module such as drupal_get_path('module', 'deletedmodname'). Do backtrace to identify.

** Update Module
- Read module README first
- Usually just remove the module directory and put the new one in
- And run update.php

** Module
*** Custom Module
**** Show all errors
settings.php
#+BEGIN_EXAMPLE
error_reporting(E_ALL);
ini_set('display_errors', TRUE);
ini_set('display_startup_errors', TRUE);
$conf['error_level'] = 2;
// UI > Administration > Configuration > Development > logging > 'All messages'
#+END_EXAMPLE

**** .info file
[[https://www.drupal.org/node/542202#files][Instructions]]

Module name must contain only lower-case and undersocre
sites/all/modules/custom/my_module or sites/all/themes/custom/my_theme
my_module.info, my_module.module

Use ~;~ at the beginning of a line to mark as comment
~name = A Human Readable Name~
~description = More is <a href="">here</a>.~ It can only one line with 255 characters and it's HTML (e.g. accented characters)!
~core = 7.x~ Can't specify minor version.
~package = Views~ ~package = Example modules~
If your module comes with other modules or it's meant to be used exclusively with other modules, provide the package name here. 
More than 4 modules that depend on each other can make a package.

~files[] = includes/context.inc~ This .inc file should be class or interface. To include .inc with plain functions

Clear cache when .info is changed

A submodule under a package may not add parent module to dependencies and submodule names can be anything given the parent module is ~examples~:
- action_example
- action_examples
- example_action

#+BEGIN_EXAMPLE
dependencies[] = entity
dependencies[] = views (>=3.12)
dependencies[] = exampleapi (1.x)
dependencies[] = exampleapi (>7.x-1.5)
dependencies[] = exampleapi (>1.0, <=3.2, !=3.0)
dependencies[] = system (>=7.53)
#+END_EXAMPLE

Optional
#+BEGIN_EXAMPLE
configure = admin/config/content/my_mymodule

; hide on modules page. e.g. SimpleTest where end-users should never enable the testing modules
hidden = TRUE
#+END_EXAMPLE

**** Refactor, include .inc files
#+BEGIN_EXAMPLE
function ctools_include($file, $module = 'ctools', $dir = 'includes') {
  static $used = array();

  $dir = '/' . ($dir ? $dir . '/' : '');

  if (!isset($used[$module][$dir][$file])) {
    require_once DRUPAL_ROOT . '/' . drupal_get_path('module', $module) . "$dir$file.inc";
    $used[$module][$dir][$file] = TRUE;
  }
}

// ctools_include('utility', 'ctools', 'includes');
// ctools_include('macro', 'mymodule', 'includes');
#+END_EXAMPLE

**** lili.api.php
Just include this in module root directory and all hooks will be defined

*** Feeds - Package: Feeds
Requires d7:ctools d7:job_scheduler
Test requires: date:date entity_translation:entity_translation feeds_xpathparser:feeds_xpathparser i18n:i18n_taxonomy link:link rules:rules variable:variable
Submodules: 
- feeds_import
- feeds_news
- feeds_ui

#+BEGIN_EXAMPLE
$feed_obj = feeds_source($feed_id,$feed->feed_nid);
$feed_obj->existing()->import(); // Use this so no jobs are inserted in batch

// Sequence
$this = feeds_source;
hook_feeds_before_import($this)
hook_feeds_after_parse($this, $parser_result)
FeedsProcessor.inc->process parser_result
releaseLock()
hook_feeds_after_import($this)
#+END_EXAMPLE

Import drush command runtime can be long. Output something every 5 minutes to prevent drush command timeout
Do this in one of the hooks: 
- hook_feeds_before_update
- hook_feeds_presave 
- hook_feeds_after_save

#+BEGIN_EXAMPLE
function lili_feeds_presave(FeedsSource $source, $entity, $item) {

 $request_time = lili_custom_cache('timecounter');
 $interval = 60 * 5;
 if (!is_null($request_time)) {
  $row_counter = lili_custom_cache('rowcounter');
  lili_custom_cache('rowcounter',++$row_counter);
  $current_time = time();
  $seconds = $current_time - $request_time;
  if (floor($seconds/$interval) > 0) {
   lili_custom_cache('timecounter', $current_time);
   print "Presave row #$row_counter. $seconds seconds have passed.\n";
  } 
 }
 else {
  lili_custom_cache('timecounter', REQUEST_TIME);
  lili_custom_cache('rowcounter', 1);
 }

}
#+END_EXAMPLE

**** New Feed Tamper Plugin
The plugin does this: Drupal download file with real file extension

#+BEGIN_EXAMPLE
// Implements hook_ctools_plugin_directory()
function lili_ctools_plugin_directory($module, $plugin) {
 if ($module == 'feeds_tamper') {
  return 'plugins'; // path_to_lili_module/plugins/lili_*.inc
 }
}

// lili_change_image_extension.inc
// You can refer to path_to_feeds_tamper_module/plugins/explode.inc
$plugin = array(
  'form' => 'lili_image_extension_form',
  'callback' => 'lili_image_extension_callback',
  'validate' => 'lili_image_extension_validate', // optional
  'name' => 'Convert Image URL Extension',
  'category' => 'T and T', // group name
  'multi' => 'direct',
  // If multiple values are injected to the plugin,
  // 'direct' will pass the whole array as $field to callback
  // while 'loop' will loop over and pass each value to callback
);

function lili_image_extension_form($importer, $element_key, $settings) {
  $form = array();
  $form['info'] = array(
    '#markup' => t('Converts source image URLs that don\'t have regular image extension: jpg, png, etc.'),
  );

  // Extra variables to pass to $settings in callback
  $form['importer_name'] = array(
      '#type' => 'hidden',
      '#title' => t('Importer machine name'),
      '#default_value' => isset($settings['importer_name']) ? $settings['importer_name'] : $importer->id,
  );

  return $form;
}

function lili_image_extension_validate(&$settings) {
  // Validate $settings.
}

function lili_image_extension_callback($result, $item_key, $element_key, &$field, $settings, $source) {
  //settings has the importer name
  //$settings['importer_name']
  //$field has the importing field text value
  if (!is_array($field)) {
    $field = array($field);
  }

  $val = array();

  foreach ($field as $f) {
    $val[] = _lili_save_file_with_extension($f);
  }
  $field = $val;
}
#+END_EXAMPLE

**** XPath
Children nodes Photo under Images node.
Simply Images/Photo, the result is already array
Concate multiple nodes
=concat(photo1,';',photo2)= then explode

*** Feeds Tamper - feeds_tamper - Package: Feeds
Requires feeds
Submodule: feeds_tamper_ui

*** Feeds Tamper Importer - feeds_tamper_importer - Package: Feeds
Requires feeds_tamper

*** Feeds XPath Parser - feeds_xpathparser - Package: Feeds
Requires feeds

*** Feeds entity processor - feeds_entity_processor - Package: Feeds
Requires feeds d7:entity

*** XML Sitemap
/admin/config/search/xmlsitemap/settings
Uncheck /Prefetch URL aliases during sitemap generation/

*** ThemeKey
<<<d7:module:themekey>>>

You can switch to a different based on some rules!
If you are not clear about some rules, you can just search in code. e.g. search 'system:query_string'

*** Devel
devel requires nothing
sub modules :: devel_generate, devel_node_access (off)

http://ratatosk.net/drupal/tutorials/debugging-drupal.html

dpm($input, $name = null) use drupal_set_message and Krumo to dispaly in 'message' area
kpr($input, $return = FALSE, $name=NULL) uses Krumo print in page header not 'message' area.
dvm($input, $name = NULL) use Krumo to var_dump in 'message' area. Good for copy and paste
dpr($input, $return = FALSE, $name = NULL) print in page header not in 'message' area.

*** Administrator menu - admin_menu - Package: Administration
Requires nothing
Submodules: admin_devel, admin_menu_toolbar

*** Administration Views - admin_views - Package: Administration
Requies d7:views d7:views_bulk_operations

*** Administer Users by Role - administerusersbyrole
Requires chain_menu_access

Allow users to edit/delete other users

*** Variable
[[https://www.drupal.org/project/variable][variable]] requires nothing <<<d7:m:variable>>>

*** Libraries
requires nothing

*** Module Filter
[[https://www.drupal.org/project/module_filter][module_filter]] :: requires nothing

*** Geocoder
Requires d7:geophp d7:ctools d7:entity <<<d7:geocoder>>>
An API and widget to geocode text field into GIS data types.

*** Entity View Modes - entity_view_mode
Requires nothing <<<d7:entity_view_mode>>>
Recommends d7:field_ui
Create custom View Mode: Default, Teaser under Manage Display
d7:ds can also create view mode

*** wysiwyg
requires nothing
Allows the use of client-side editors to edit content
7.x-2.2 to 7.x-2.4 (support TinyMCE from 3.3.9.2 to 4.5.7)

**** Installation & Config
Setup assign text format to trusted roles: admin/config/content/formats
Follow README.md to config Text Format (e.g. Full HTML). Basically remove any restrictions.
Installation Instructions on config page: /admin/config/content/wysiwyg
TinyMCE installation instructions are missing.. Refer to this https://www.drupal.org/docs/7/modules/wysiwyg/installation
Basically, download from TinyMCE and put it in sites/all/libraries/tinymce

If TinyMCE editor is upgraded, make sure the options for the Wysiwyg profile using TinyMCE is the same as before
admin/config/content/wysiwyg/profile e.g. https://www.todaystrucking.com/admin/config/content/wysiwyg/profile/full_html/edit
You need to save the profile after the TinyMCE editor is updated.

Supported editor versions: https://www.drupal.org/project/wysiwyg

***** [[https://www.tinymce.com/docs/configure/][All TinyMCE settings]]
To config other TinyMCE settings and the Wysiwyg module UI doesn't provide, use hook_wysiwyg_editor_settings_alter()

****** HTML elements are stripped off
In /admin/config/content/wysiwyg/profile/full_html/edit, keep Verify HTML on.
#+BEGIN_EXAMPLE
function lili_wysiwyg_editor_settings_alter( &$settings, $context ) {
  dpm($settings,  'settings');
  dpm($context, 'context');
  $settings['extended_valid_elements'] .= ',script[language|type|src]';
}
#+END_EXAMPLE

verify_html (bool) :: clean up HTML elements that are allowed for ~valid_elements~, ~extended_valid_elements~ and ~invalid_elements~
valid_elements (string) :: there're some but <script> is not allowed

**** Troubleshoot
Fields in node or block configuration might be empty or some elements are missing after save. 
To see the HTML, disable javascript in Chrome.

*** IMCE Wysiwyg bridge: imce_wysiwyg
https://www.drupal.org/project/imce_wysiwyg
7.x-1.0
requires imce and wysiwyg

*** IMCE
requires nothing
7.x-1.10 to 7.x-1.11
IMCE is an image/file uploader and browser that supports personal directories and quota.

*** Block Group
[[https://www.drupal.org/project/blockgroup][blockgroup]] :: requires core Block <<<d7:blockgroup>>>
This module extends the standard drupal block system with block groups. Each block group provides a new block as well as a corresponding region. Child blocks can be moved into any group region. The position and the settings of the parent block are propagated to its children. Also block groups are nestable.

*** MultiBlock
<<<d7:multiblock>>> [[https://www.drupal.org/project/multiblock][multiblock]] :: Built-in in D8. Requires core Block

*** [[https://www.drupal.org/project/conditional_fields][Conditional Fields]]
[[https://www.drupal.org/project/conditional_fields][conditional_fields]] :: <<<d7:module:conditional fields>>>

Conditional Fields for Drupal 7 is an user interface to the new [[https://api.drupal.org/api/drupal/includes%2521common.inc/function/drupal_process_states/7.x][States API]], plus the ability to modify fields appearance and behavior on certain conditions when viewing content.

Conditional Fields allows you to manage sets of dependencies between fields. When a field is “dependent”, it will only be available for editing and displayed if the state of the “dependee” field matches the right condition.
When editing a node (or any other entity type that supports fields, like users and categories), the dependent fields are dynamically modified with the States API.
A simple use case would be defining a custom “Article teaser" field that is shown only if a "Has teaser" checkbox is checked, but much more complex options are available.

It works on AJAX node edit/new form

*** Search404
[[https://www.drupal.org/project/search404][search404]] :: requires core search

If a user goes to http://example.com/does/not/exist, this module will do a search for "does not exist" and shows the result of the search instead of the 404 page. 

*** Google Analytics
[[https://www.drupal.org/project/google_analytics][google_analytics]] :: requires nothing

*** Elysia Cron
[[https://www.drupal.org/project/elysia_cron][elysia_cron]] :: Requires nothing.
Don't put a cron key in Elysia otherwise the cron run in drush will not work.

*** SMTP Authentication Support
[[https://www.drupal.org/project/smtp][smtp]] :: requires nothing

*** Entity API - entity
[[https://www.drupal.org/project/entity][entity]] : sub module entity_token <<<d7:entity>>>
Requires nothing

*** Chaos Tools - ctools
[[https://www.drupal.org/project/ctools][ctools]] :: no dependencies <<<d7:ctools>>>
From [[https://www.drupal.org/project/ctools/releases/7.x-1.10][7.x-1.10]] to [[https://www.drupal.org/project/ctools/releases/7.x-1.12][7.x-1.12]]

$modulepath/help/
$modulepath/help/plugins-creating.html :: all plugin types

*** Address Field - addressfield - Package: Fields
Requires d7:ctools

Field List: admin/reports/fields

/moduels/field/field.api.php
https://api.drupal.org/api/drupal/modules%21field%21field.api.php/7.x

*** Email - email - Package: Fields
Requires nothing

*** Geofield - Package: Fields
Requires d7:geophp d7:ctools
Used with d7:geocoder

*** Viewfield - Package: Fields
Requires d7:views
e.g. An order has multiple items, store those items into a field

*** Field collection - field_collection - Package: Fields
Requires d7:entity
Test require d7:entity_translation
Any number of fields can be attached to a field-collection field which is an entity.

*** Social Field - socialfield - Package: Fields
Requires nothing

*** Video Embed Field - video_embed_field - Package: Media
Requires d7:ctools core image
New field type
Used with video_embed_* modules

Have to install other modules to support different providers e.g. video_embed_facebook, video_embed_brightcove

*** Display Suite - ds - Package: Display Suite
Requires d7:ctools <<<d7:ds>>>
Submoduels
- ds_devel :: requires devel
- ds_extras :: admin/structure/ds/list/extras
 - Field Templates :: theme a field. To theme a display field, you don't need to enable it
 - Extra Fields
 - Other
  - Region to block ::
    Create a region and move fields into that region Content Type > Manage Display > Block regions
    This will create a block which can be used in other places/regions in Blocks setting
  - View mode per node :: specify a view mode for each node
- ds_format
- ds_forms
- ds_search
  Integrate search engine such as module apachesolr and d7:search_api_solr to display the search results for a content type
- ds_ui

https://www.youtube.com/playlist?list=PL7E361A55994F1648

Can display fields of a content type into a layout which has several regions under Manage Display

A display field can be created for a content type display. This field is for theming only not physically create a field in db.
Field value can be PHP code and Token can be used.
- Field :: custom field with PHP and Token
- Block field :: display a block
- Dynamic field :: choose a variable to display e.g. node_body, menu
- Preprocess field :: display a variable e.g. Node Url (machine name node_url)

Later theme that display field using ds_extras 

View Mode :: Default, Teaser
Create a view mode. d7:entity_view_mode can also create view modes.
To display a view that returns multiple nodes of a content type, go to Format > Show > Display suite > Settings
Choose the custom view mode and also specify the first item to use View Mode #1 and the second item to use View Mode #2, etc.
Custom hook can be selected in this setting to make customization

*** Entity Reference - entityreference
entityreference :: requires d7:ctools d7:entity <<<d7:entityreference>>>
In D8 core
Add a entity reference field which you can use an entity reference view as a list of values to select from as values in that field.
Refer to d7:entity reference view

*** Webform
<<<d7:webform>>> [[https://www.drupal.org/project/webform][webform]] :: 7.x-3.x requires nothing. 7.x-4.x requries d7:ctools d7:views 3

hook_form_alter, hook_form_webform_client_form_alter, (> 7.x-4.4 use hook_form_webform_client_form_NID_alter) 
Modify in $form['submitted']

*** Webform Validation
[[https://www.drupal.org/project/webform_validation][webform_validation]] :: requires d7:webform

*** Panels
[[https://www.drupal.org/project/panels][panels]] :: drag-and-drop layout for admin
Requires: d7:ctools
Has a lot of security updates
From 7.x-3.6 to 7.x-3.9

*** File Entity
[[https://www.drupal.org/project/file_entity][file_entity]] <<<d7:file entity>>>
Requires: d7:ctools, core: Field, Field SQL storage, File

From 7.x-2.0-beta2 to 7.x-2.3

*** Facet API
<<<d7:facetapi>>> facetapi :: requires d7:ctools
Sub modules: current_search, facetapi_bonus

*** Search API - search_api
Requires entity <<<d7:search_api>>>
sub modules :: search_api_views (views), search_api_facetapi (d7:facetapi)
https://www.drupal.org/docs/7/modules/search-api
https://www.youtube.com/watch?v=hcAM0HrEk4c

**** Glossary
For example, a "Node index" for indexing nodes. It would contain the fields that should be indexed and their types, the data alterations and processors to use and some other settings. The details of how to index data are independent of these settings, and server-specific. Index settings are independent of the inner mechanics of the search server.

A server is a concrete way to index and search data. It could, e.g., represent a certain database, a connection to an external search server, etc.
How exactly the data is stored is determined by the server's service class, but is not important for the overall functionality of the Search API.
A server can have an arbitrary number of indexes attached to it, whose search data is then indexed on that server.

When creating a server, a service class has to be chosen

**** Index
If an index is updated, reindex all content.
***** Select index fields
Indexed for those fields for which you want to store data on the search server. These fields can then be searched, used for filtering and sorting, and maybe also used for other purposes.

Note that only fields of type Fulltext can be used in fulltext searches. So when you want to find individual words contained in this field, not just the whole field value, use this type. Other types can be used, e.g., for filtering and sorting.

Fields indexed with type "Fulltext" and multi-valued fields (marked with 1) cannot be used for sorting. The boost is used to give additional weight to certain fields, e.g. titles or tags. It only takes effect for fulltext fields.

***** Add Related Fields
Items of a certain type might be connected to, or might reference, other kinds of data. For instance, content will always have an author, could also contain references to taxonomy terms, etc. With the Add related fields form at the bottom of the page you can add the fields of those related items to the list, so they can be indexed, too. Use this if you want, e.g., to index the user roles of a node's author. You can also add nested related fields, e.g., the node's author's profile's image's file type.

***** Customize Workflow (Filters Tab)
https://www.drupal.org/node/1254452

****** Data alterations
Bundle filter
Lets you to prevent entities from being indexed based on their bundle (content type for nodes, vocabulary for taxonomy terms, etc.). This way you can, for instance, create an index solely for news.
Language control
Allows you to control the language of items stored in the index. This is done by providing two different functionalities:
Normally, the content of the Item language property (which is automatically added by the Search API for all indexed items) is determined by the item's language property, if available, and otherwise set to undefined. With this data alteration, you can select any other property as an alternative source for the item language, which will then be used instead. Note that the selected field has to contain a single valid ISO language code for each item for this to work, though.
You can then also select the languages items in this index may have. Items with any other language (defined by the Item language property) will be rejected during indexing.

Node access
Adds node access checks to searches on this index. This is done by adding a new field, Node access information that stores the relevant access data. When the Node access information, author, and Status fields are present and indexed, appropriate filters will be automatically added to all searches so that they only return results that the current user is allowed to view. Some searches (e.g., search views) provide the option to override this behaviour on a per-search basis, though. Check the corresponding module's documentation for details.
In any case, you have to keep in mind that these access checks are solely based on the indexed data. If a node is edited in a way that changes its accessibility (e.g., by being unpublished), this change will only take effect once the node is indexed in its latest state. This means that there is potentially a gap between changing the node and the update of the access checks on search results, meaning that—depending on the data displayed for search results—users could in that time see data that should not be accessible to them. If you need to avoid that, use the index's Index items immediately option.

Also note that access on the individual fields is never checked — don't include them in the display, if they contain sensitive data. Refer to hook_node_access_records() and hook_node_grants() on implementing node access checks. The node access data stored in the index is based on the node_access table which is affected by hook_node_access_records().
The data alteration is only available for node indexes.

Search views do not filter based on node access by default. There is a simple option in the query settings called "Additional access checks on result entities" that will do an access check after the actual query is run, but this option should only be used as a last result. Search results counts and facets will not reflect the further restriction applied by views.

The proper way to do the node access checks in views is to add a filter on Indexed Node: Node access information. This can be complicated because it is important to know what values the field will hold, and this information can not be output through fields in the view itself. One must look to the data stored in the search server. In the case of Solr, this can be accomplished by examining the sm_search_api_access_node field in the schema browser. A sample value for one configuration of taxonomy access control was node_access_taxonomy_access_role:2. One could make a views search display for authenticated users for example that included all results, and a display for anonymous users that checked that the Node Access Information value is not equal to node_access_taxonomy_access_role:2 in the example above. A brief example can be found in this Drupal Answers answer

URL field
Adds a field containing the URL at which the entity can be displayed. For some item types, like nodes, this URL is already available, but this data alteration can be used to also add them for other types.

Aggregated fields
Offers the ability to add additional fields to the entity, containing the data from one or more other fields. Use this, e.g., to have a single field containing all data that should be searchable, or to make the text from a string field, like a taxonomy term, also fulltext-searchable.
The type of aggregation can be selected from a set of values: you can, e.g., collect the text data of all contained fields, or add them up, count their values, etc.

Complete entity view
Adds a field containing the whole HTML content of the entity as it is viewed on the site. The view mode used can be selected. This allows you to index exactly „what the user sees“, which is often what is expected, but might differ from just indexing the contents of other fields.
Note that this might not work for items of all types. All core entity types except files are supported, though.

Index hierarchy
Allows you to index hierarchical fields along with all their parents. Most importantly, this can be used to index taxonomy term references along with all parent terms. This way, when an item, e.g., has the term New York, it will also be matched when filtering for USA or North America.

****** Processors
A processor can do preprocess data that is being indexed, preprocess search queries, and postprocess search results
Refer to service class documentation of the server.

Ignore case
Makes searches on selected fields case-insensitive. Some servers might do this automatically, for all others this should probably always be activated, at least for fulltext fields.

HTML filter
Strips HTML tags from selected fields and decodes HTML entities. If you are indexing HTML content (like node bodies) and the search server doesn't handle HTML on its own, this should be activated to avoid indexing HTML tags, as well as to give e.g. terms appearing in a heading a higher boost.

Tokenizer
This processor allows you to specify how indexed fulltext content is split into seperate tokens – which characters are ignored and which treated as white-space that seperates words.

Stopwords
Enables the admin to specify a stopwords file, the words contained in which will be filtered out of the text data indexed. This can be used to exclude too common words from indexing, for servers not supporting this natively.

Highlighting
Adds highlighting of search terms to the search results.

**** [[https://www.drupal.org/docs/7/modules/search-api/getting-started/search-forms-and-results-pages/search-api-views/creating-a][Create a search view]] or a search page
https://www.drupal.org/docs/7/modules/search-api/getting-started/search-forms-and-results-pages/search-api-views
Admin > Structure > Views > Add new view (admin/structure/views/add)

View name: Search
Show: [the name of the Search index] (in the case of fuzzysearch the default is "Default fuzzysearch index")
Create a page [tick]
Page title: Search
Path: search
Display format: Unformatted list of Rendered entity
Items to display: 10, use pager
Continue & edit (the new View)

Format: Show: Rendered entity | Settings

View mode: Search results
Filter criteria

Fulltext search: Expose this filter, Required, Remember the last selection, Use as: search keys
Sort criteria

Search: Relevance, descending (if you don’t have an order with fuzzysearch you will get a PDO exception)
Page settings

Access: Permission: view published content
Advanced

No results behaviour: Global: Text area “No results matched your search.”
Exposed form

Exposed form in block: Yes (This option will only show up on Page displays.)
Exposed form style settings: Submit button text: Search
Save the View. Add the exposed form block to a region.
Note that you will only receive results for partial matches that are longer than the minimum word length specified in the Index configuration.

Views based on Search API use as base table a search_api_index_* table, not the usual node table or other ones supported by Views. That is why the Search views are selected at the views' creation moment, and it can not be changed later.

**** [[https://www.drupal.org/docs/7/modules/search-api/getting-started/search-forms-and-results-pages/search-api-views/convert-an][Convert an existing view to search api]]
If the views to be converted use the row plugins Content (node), Fields or Rendered entity, the conversion may be easier (see further). If not (the selected row plugins were others), then unfortunately the views should be fully recreated manually: create a brand new search_api view and recreate all the elements from your old view by hand.

For views using Content, Fields or Rendered entity row plugins:
Export the view to be converted. Save this code as a backup.
Modify the view, removing all the Filters (contextual or not), all the Sort criteria and all the Relationships. Write down the removed items: you will need to recreate them manually using the indexed versions.
When the view is clean of filters and sort criteria, export it again.
In the export code, the 5th line will contain the
$view->base_table
variable. Change it to the search api index to be used in the view (the index must have been created before):

$view->base_table = 'search_api_index_<name_of_your_index>';
Maybe fiddle around with fields (see below).
Go to admin/structure/views/import and import the modified code. Do not forget to select the option Replace an existing view if one exists with the same name. (NOTE: currently there is a bug in Ctools 1.x that makes the Import option not to be shown for administrator users different than uid=1, here is the issue: #870938: Add new permission for controlling imports ).
Add the previously removed Filters, Sort criteria and Relationships, selecting them from the now available indexed versions.
Process will be easy if the views to be converted used the Rendered entity row plugin, since no changes will be required for the row contents.

Field fiddling

For fields there is no general recipe, although these hints should catch most cases:

Care that your index contains all needed fields or create them when import errors bug you.
Look for lines that look like this:
$handler->display->display_options['fields']['field_FOO']['table'] = 'TABLE'
If TABLE is 'views', don't change.
If TABLE is 'node' (or your base table) or 'field_data_FOO', change to 'search_api_index_<name_of_your_index>'

**** Configure Facet, Facet Blocks
A block is created for each facet configured. Even though it's set to appear on all pages, it won't display for a search view or a search page.

**** Views Filter > Search: Fulltext search
**** Current Search Block
current_search is installed with d7:facetapi. /admin/config/search/current_search

**** Other useful modules
https://www.drupal.org/node/1999262
https://www.drupal.org/docs/7/modules/search-api/extension-modules

**** Developer Documentation
https://www.drupal.org/docs/7/modules/search-api/developer-documentation
https://www.drupal.org/docs/7/modules/search-api/advanced-site-building-tutorials

***** Execute a search in code
#+BEGIN_EXAMPLE
// Replace "node_index" with you index's machine name.
$query = search_api_query('node_index');

$query->condition('type', 'product', '=');
$filter = $query->createFilter('OR');
$filter->condition('field_category', 'book', '=');
$filter->condition('field_category', 'magazine', '=');
$query->filter($filter); 

$data=$query->execute();
$results=$data['results'];
print_r($results);
#+END_EXAMPLE

***** Combined fields to do IN or OR across multiple fields
https://www.drupal.org/docs/7/modules/search-api/advanced-site-building-tutorials/combining-fields
https://www.drupal.org/project/search_api_combined

Limitation
At present the module has been tested for multiple term references and not with any other field type. It is currently set to index all combined fields as lists of items so it will not work with multiple fields that have single values that expect to stay as single values -- where this is important is in sorting, for instance, since you cannot sort by multiple values with Solr.

**** API of Search API
http://www.drupalcontrib.org/api/drupal/contributions%21search_api%21search_api.api.php/7
path-to-mod/search_api/search_api.api.php

Search search_api*.api.php
search_api_solr.api.php

*** Search API Solr - search_api_solr - Package: Search
[[https://www.drupal.org/project/search_api_solr][search_api_solr]] requires d7:search_api and core Search <<<d7:search_api_solr>>>
It's more powerful than module apachesolr
It creates View Mode called Search Index in each content type

Setup an account and create an index on Opensolr.com

On OpenSolr UI, upload the 4.x or corresponding Solr version based on OpenSolr version.
path-to-mod/search_api_solr/solr-conf/4.x
https://opensolr.com/blog/2011/09/how-to-use-with-drupal

Lucene version :: search lucene in solr-conf/4.x, e.g. solr.luceneMatchVersion=LUCENE_40
<luceneMatchVersion>${solr.luceneMatchVersion:LUCENE_40}</luceneMatchVersion>

In bundle (e.g. node type abc), setup Manage Display for the Search Index.

**** Debug
In OpenSolr UI for an index (tnt_dev), there's a button Browse Data.
https://path-to-aws.opensolr.com/solr/tnt_dev/select?q=*:*&wt=json&indent=true&start=0&rows=5

Insert a key-value pair to search
https://path-to-aws.opensolr.com/solr/tnt_dev/select?q=im_field_industry:337&wt=json&indent=true&start=0&rows=5

Retrieve the request made to Solr and response from Solr
In =search_api_solr/includes/solr_connection.inc= add a line below ~protected function makeHttpRequest~

#+BEGIN_EXAMPLE
drupal_set_message(check_plain($url)); // <-- Add this line to retrieve request
$result = drupal_http_request($url, $options);
drupal_set_message(check_plain($result->data)); // <-- Add this line to retrieve response
#+END_EXAMPLE

*** Search API Solr Overrides - search_api_solr_overrides
Requires d7:search_api_solr
Provides site/environment specific overrides for search_api_solr configuration in settings.php

*** Views
[[https://www.drupal.org/project/views][Views]], sub module Views UI <<<d7:views>>> d7:viewsapi
Requires d7:ctools
From [[https://www.drupal.org/project/views/releases/7.x-3.12][7.x-3.12]] to [[https://www.drupal.org/project/views/releases/7.x-3.15][7.x-3.16]]

*** Better Exposed Filters
[[https://www.drupal.org/project/better_exposed_filters][better_exposed_filters]] d7:better exposed filters
Requires d7:ctools d7:views
Group under Views
[[https://www.drupal.org/project/better_exposed_filters/releases/7.x-3.3][7.x-3.3]], [[https://www.drupal.org/project/better_exposed_filters/releases/7.x-3.4][7.x-3.4]]

*** Views Bulk Operations
[[https://www.drupal.org/project/views_bulk_operations][views_bulk_operations]] : sub module actions_permissions <<<d7:views_bulk_operations>>>
Requires: d7:entity d7:views

*** Administration views
[[https://www.drupal.org/project/admin_views][admin_views]]: d7:views d7:views_bulk_operations

*** Media
[[https://www.drupal.org/project/media][media]]
Requires: d7:file entity, d7:ctools, d7:views

From 7.x-2.0-beta1 to 7.x-2.9

*** Internationalization - i18n
[[https://www.drupal.org/project/i18n][i18n]] requires core locale and d7:m:variable

<<<d7:m:i18n>>>

- Add a language :: admin/config/regional/language
- Go to pages that use t('string to translate', [], ['langcode'=>"fr"]) with non default options

Once a language is added (default language is chosen), node created will have $node->language = 'en'

*** S3 File System s3fs
requires module libraries, library =AWS SDK for PHP 2.x=, PHP 5.3.3+ with ~allow_url_fopen = On~ in =php.ini=

#+BEGIN_EXAMPLE
drush dl s3fs
drush en s3fs
# update.php is not necessary
#+END_EXAMPLE

Download library
#+BEGIN_EXAMPLE
# In Pantheon, 
drush make --no-core code/sites/all/modules/s3fs/s3fs.make code

# Or 
drush make --no-core sites/all/modules/s3fs/s3fs.make
#+END_EXAMPLE

Check if library is downloaded =sites/all/libraries/awssdk2/aws-autoloader.php=

Drupal setting :: /admin/config/media/s3fs/settings or in settings.php
Set Cache-Control header to be ~public, max-age=604800~
Refer to header:cache-control

settings.php
#+BEGIN_EXAMPLE
$conf['awssdk2_access_key'] = 'YOUR ACCESS KEY'; 
$conf['awssdk2_secret_key'] = 'YOUR SECRET KEY'; 
$conf['s3fs_root_folder'] = 'thenyourroot'; // bucketroot/thenyourroot/*
$conf['s3fs_bucket'] = 'YOUR BUCKET NAME'; 
$conf['s3fs_region'] = 'YOUR REGION'';
#+END_EXAMPLE

Go to =admin/config/media/file-system= and set the Default download method to Amazon Simple Storage Service
Refer to aws:s3 about how to setup user with correct permission policy

** Debug
watchdog('LOG_TYPE','message');
watchdog('LOG_TYPE', $message, array(), WATCHDOG_ERROR);
array() is to t() $message. Don't forget to put empty array otherwise you will have to manually clean up the watchdog table!

If error or warning messages are printed using drupal_set_message, 
modify the `drupal_set_message` function so that it prints debug_backtrace
#+BEGIN_EXAMPLE
if ($type == 'error') {
  $message .= ' '. print_r(debug_backtrace(DEBUG_BACKTRACE_PROVIDE_OBJECT,3),1);
}
#+END_EXAMPLE

You can throw an Exception
#+BEGIN_EXAMPLE
throw new Exception(print_r($val));
#+END_EXAMPLE

** Configuration, Setting
Override configuration and setting based on the current dev environment
settings.php
$conf['admin_theme'] = 'seven';
pantheon:environment

For assigning permissions to roles, e.g. enable anonymous for Devel, you have to do it manually  

[[https://www.drupal.org/node/1525472][Variable name and its default value]]
- admin_theme :: 'seven'
- preprocess_css :: "1"/"0", aggregate.
- preprocess_js :: "1"/"0", aggregate.
- cache :: "1"/"0", cache pages for anonymous users
- block_cache :: "1"/"0", cache blocks
- cache_lifetime :: "0", none. Minimum cache lifetime
- error_level :: "0"/"1"/"2", none/error and warnings/all messages. Logging and errors.

If setting is an array, you have to override the whole array. Can't override a key value.

<<<d7:mysql:charset>>>
Since Drupal 7.50, Drupal now supports 4 byte UTF-8 with MySQL.
You will first need to run a custom drush command provided by a [[https://www.drupal.org/project/utf8mb4_convert][utf8mb4_convert module]] to convert
all Drupal database, tables and fields to charset utf8mb4 and collation utf8mb4_general_ci
Then change the database connection settings in settings.php
[[https://www.drupal.org/node/2754539][Drupal Doc]]

The utf8mb4_convert module requires inno_large_prefix=true when MySQL server is bootup.
Otherwise a test (->utf8mb4IsSupported) can't pass before any actions.
To bypass the test, re-create any string index columns varchar(255) to varchar(191)
For example:
ALTER TABLE cache_block CHANGE cid cid VARCHAR(191) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;

Do this for any problematic column the module returns.

For new website, changing the database connectio settings in settings.php is good enough.

If MySQL server doesn't bootup with inno_large_prefix=true, all indexed columns will have max varchar(191)

As a quick workaround, you can remove all php:4byte characters.

Refer to mysql:charset for important info

** URL Alias
Setup pattern for each node type
Configuration > Search and metadata > URL Aliases > Patterns

** Link, Module Path, Theme Path
*** Link
Empty link!
#+BEGIN_EXAMPLE
// Basic syntax: l($text, $path, array $options = array())
l($text, 
  '', 
  array('fragment'=>' ', 
        'html'=>TRUE, // if $text is HTML, set this to true
        'external'=>TRUE,
  //    'attributes' => array(
  //       'target'=> '_blank'
  //       'class' => ['classA'],
  //     ),
  )
);
#+END_EXAMPLE

Function l add class="active" when the path is current_path(). Use url() instead.

#+BEGIN_EXAMPLE
url($path = NULL, $options = array())
#+END_EXAMPLE
Get URL alias
url() just returns a url. $options are the same as l().
url('taxonomy/term/1');

To embed a url directly to HTML href, you should check_url($url)
To embed a url directly as a URL parameter, echo 'http://abc.com/?t='.urlencode($url);

*** Current External URL, <<<d7:url>>> <<<d7:current_path>>>
#+BEGIN_EXAMPLE
url(current_path(), array('absolute' => TRUE));

# With query parameters
url(current_path(), array('absolute' => TRUE, 'query' => drupal_get_query_parameters()));
#+END_EXAMPLE

current_path still works when 404. Don't var_dump or print current_path() directly as it might have XSS

url
- absolute :: append http
- base_url :: override the default $base_url with a custom base url, e.g. http://abc.com without trailing stash 

*** Module Path, Theme Path
global $base_url;
$mod_path =  $base_url.base_path().drupal_get_path('module', 'lili_mod_name');
$theme_pat = $base_url.base_path().drupal_get_path('theme', 'lili_theme_name');

Both have no trailing slash

*** global $base_url
No trailing slash
http://abc.com

*** XSS
Tests
#+BEGIN_EXAMPLE
http://a.ca/abc-xyz--><form><button formaction='/esi.attack.sim'><!--
http://a.ca/abc-xyz--><script src='a' onerror=alert(document.domain)>
#+END_EXAMPLE

** Translate
*** t()
$text = t("This is !name's website", array('!name' => $username));
$text = t("This is @name's website", array('@name' => $username));
$text = t("This is %name's website", array('%name' => $username));
$text = t(check_plain($text));
$link = l(t("Link text"), "node/123");
$link = t('Visit the <a href="@url">settings</a> page', array('@url' => url('admin')));

// `%` and `@` use `check_plain()`
// `%` adds `<em class="placehoder"></em>`
// `!` straight output.

t('Thursday',[],['langcode'=>'fr']);
t('Thursday',[],['context'=> 'some context', 'langcode'=>'fr']);

d7:m:i18n

*** Translate Date and Time
#+BEGIN_EXAMPLE
// Have to load all terms then Translate Interface can show up admin/config/regional/translate/translate

$_fr_days_translation = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
$_fr_months_translation = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
foreach ($_fr_days_translation as $_t_i) {
  t($_t_i, [],['langcode'=>'fr']);
}

// format_date with F (long month name) adds context..
foreach ($_fr_months_translation as $_t_i) {
  t($_t_i, [],['context'=>'Long month name','langcode'=>'fr']);
}

$_u_time = mktime (11, 0, 0, $_u_time['month'], $_u_time['day'], $_u_time['year']);
$_fr_time = format_date($_u_time, 'custom', 'l j F Y', NULL, 'fr');

echo $_fr_time;
#+END_EXAMPLE

** Global Variables
https://api.drupal.org/api/drupal/globals/7.x

- $base_url :: 'http://www.yoursite.com' wihtout trailing slash 

https://www.drupal.org/node/2537572

[[https://www.drupal.org/node/2537572][Drupal Properties]]
$_SERVER['*']
- QUERY_STRING :: query string without q e.g. 'foo=bar&koo=hoo'

** Common Functions
<<<d7:functions>>>

*** drupal_add_html_head
drupal_add_html_head($tag, 'unique-name');
// $head in html.tpl.php
$tag = array(
  '#tag'        => 'meta',
  '#attributes' => array(
    'property' => 'og:url',
    'content'  => $base_url,
  ),
);
drupal_add_html_head( $meta_og, 'lili_og_url' );

*** drupal_set_title
drupal_set_title($title = NULL, $output = CHECK_PLAIN);
- $title :: if NULL, leave the current unchanged

*** drupal_goto
drupal_goto($path = '', array $options= array(), $http_response_code= 302)

- $path :: a drupal path 'node/123' or a full url
- $options :: URL optoins to pass to url()

Redirect to homepage
drupal_goto('<front>'); 

*** drupal_valid_path($path, $dynamic_allow= TRUE)
$_path = current_path();

if (drupal_valid_path($_path)) {
  // Current user has access to this path/page
}

** Theme
*** System Theme
Default theme file is located at 
=sites/all/modules/mod_path/modname/templates/theme-name.tpl.php=

- template.php
- html.tpl.php
- page.tpl.php
- region.tpl.php
- block.tpl.php
- node.tpl.php
- comment-wrapper.tpl.php
- comment.tpl.php

d7:View_Theming

**** Fast detect if it's a node page
if (arg(0)=='node') {
  $node_id = arg(1);
} 

**** Include file in *.tpl.php
include(drupal_get_path('theme', 'theme_name').'/example-file-template.tpl.php');

If the file is in the same folder
<?php include 'abc.php'; ?>

**** html.tpl.php
Get node if it's a node page
$node = menu_get_object();
if (isset($node->type)) { ... }

**** page.tpl.php
Get node if it's a node page
hook_preprocess_page(&$variables) {
  if (!empty($variables['node']) && $variables['node']->type == 'NODETYPE') {
    $variables['greeting'] = 'Custom Greeting';
  }
}

*** Form Theme
$form['#theme'][] = 'lili_form';
If no custom theme function, d7:hook_theme d7:theme_*, is defined, then the default template file is
/sites/all/themes/your_theme/templates/form/lili_form.tpl.php

*** Region
Region can hold multiple blocks. If module d7:blockgroup is installed, a block group is a region but it can be included in other region or block group.
Define a region in mytheme.info e.g. ~regions[header] = Header~
Render a region in template files ~print render($page['header'])~

*** Block
**** [[https://api.drupal.org/api/drupal/modules%2521block%2521block.api.php/function/hook_block_info/7.x][hook_block_info]]
#+BEGIN_EXAMPLE
function hook_block_info() {
  $blocks             = array();
  $blocks['my_block'] = array(
    'info'  => t( 'My Custom Block' ),
    'cache' => DRUPAL_CACHE_PER_ROLE,
  );

  return $blocks;
}
#+END_EXAMPLE

Use `DRUPAL_NO_CACHE` for development, then `DRUPAL_CACHE_GLOBAL`. Default is `DRUPAL_CACHE_PER_ROLE`

If `Cache Block` is disabled and unchecked in Drupal Performance setting, all blocks will not be cached. Refer to d7:cache block

The delta `my_block` only needs to be unique within the module. HTML ID is `block-MODULENAME-DELTA`

Now the block can be seen in the default theme Blocks admin page /admin/structure/block
Place the new block to a region. To assign a block to multiple regions, install d7:MultiBlock module:
Then go /admin/structure/block/instances to create another instance of the newly created block type.

**** [[https://api.drupal.org/api/drupal/modules%2521block%2521block.api.php/function/hook_block_view/7.x][hook_block_view]]
#+BEGIN_EXAMPLE
<?php
/**
 * Implements hook_block_view().
 */
function lili_block_view( $delta = '' ) {
  $block = array();

  switch ( $delta ) {
    case 'my_block' :
      $block['content'] = _lili_my_block_view();
      break;
  }

  return $block;
}

/**
 * Custom function to assemble renderable array for block content.
 * Returns a renderable array with the block content.
 * @return
 *   returns a renderable array of block content.
 */
function _lili_my_block_view() {
  $block = array();

  // Capture the image file path and form into HTML with attributes
  $image_file = file_load( variable_get( 'block_image_fid', '' ) );
  $image_path = '';

  if ( isset( $image_file->uri ) ) {
    $image_path = $image_file->uri;
  }

  $image = theme_image( array(
    'path'       => ( $image_path ),
    'alt'        => t( 'Image description here.' ),
    'title'      => t( 'This is our block image.' ),
    'attributes' => array( 'class' => 'class_name' ),
  ) );

  // Capture WYSIWYG text from the variable
  $text = variable_get( 'text_variable', '' );

  // Block output in HTML with div wrapper
  $block = array(
    'image'   => array(
      '#prefix' => '',
      '#type'   => 'markup',
      '#markup' => $image,
    ),
    'message' => array(
      '#type'   => 'markup',
      '#markup' => $text,
      '#suffix' => '',
    ),
  );
  
  // directly return a form as block
  // return drupal_get_form('lili_another_form');
  // or return ['some thing' => drupal_get_form('lili_another_form')];
  return $block;
}
#+END_EXAMPLE

**** [[https://api.drupal.org/api/drupal/modules%2521block%2521block.api.php/function/hook_block_view_alter/7.x][hook_block_view_alter]]
#+BEGIN_EXAMPLE
function lili_block_view_alter( &$data, $block ) {
  if ( $block->module == 'block' && $block->delta == '3' ) {
    // $data['subject']: title of the block

    $data['content'] = '';
  }
}
#+END_EXAMPLE

**** Configurable Block: [[https://api.drupal.org/api/drupal/modules%2521block%2521block.api.php/function/hook_block_configure/7.x][hook_block_configure]], [[https://api.drupal.org/api/drupal/modules%2521block%2521block.api.php/function/hook_block_save/7.x][hook_block_save]]
hook_block_configure
#+BEGIN_EXAMPLE
/**
 * Implements hook_block_configure().
 */
function lili_block_configure( $delta = '' ) {
  $form = array();

  switch ( $delta ) {
    case 'my_block' :
      // Text field form element
      $form['text_body'] = array(
        '#type'          => 'text_format',
        '#title'         => t( 'Enter your text here in WYSIWYG format' ),
        '#default_value' => variable_get( 'text_variable', '' ),
      );

      // File selection form element
      $form['file'] = array(
        '#name'              => 'block_image',
        '#type'              => 'managed_file',
        '#title'             => t( 'Choose an Image File' ),
        '#description'       => t( 'Select an Image for the custom block.  Only *.gif, *.png, *.jpg, and *.jpeg images allowed.' ),
        '#default_value'     => variable_get( 'block_image_fid', '' ),
        '#upload_location'   => 'public://block_image/',
        '#upload_validators' => array(
          'file_validate_extensions' => array( 'gif png jpg jpeg' ),
        ),
      );
      break;
  }

  return $form;
}

/**
 * Implements hook_block_save().
 */
function lili_block_save( $delta = '', $edit = array() ) {
  switch ( $delta ) {
    case 'my_block' :
      // Saving the WYSIWYG text
      variable_set( 'text_variable', $edit['text_body']['value'] );

      // Saving the file, setting it to a permanent state, setting a FID variable
      $file         = file_load( $edit['file'] );
      $file->status = FILE_STATUS_PERMANENT;
      file_save( $file );
      $block = block_load( 'lili', $delta );
      file_usage_add( $file, 'lili', 'block', $block->bid );
      variable_set( 'block_image_fid', $file->fid );
      break;
  }
}
#+END_EXAMPLE

**** Block API Sequence
hook_block_configure: Define a configuration form for a block.
hook_block_info: Define all blocks provided by the module.
hook_block_info_alter: Change block definition before saving to the database.
hook_block_save: Save the configuration options from hook_block_configure().
block_list
  - _block_load_blocks
    - hook_block_list_alter
  - _block_render_blocks: render a set of blocks for one region. Check if it's cacheable, then get and set cache_block
    - _block_get_cache_id
    - hook_block_view: Return a rendered or renderable view of a block.
    - hook_block_view_alter: Perform alterations to the content of a block.
    - hook_block_view_MODULE_DELTA_alter: Perform alterations to a specific block.

**** Render a block
If a block is assigned to a region "content"
Markup of the the block is $page['content']['block_123']

#+BEGIN_EXAMPLE
$SIDEBAR_CONTENT = json_encode($page['content']['block_'.$block_id]);
$SIDEBAR_CONTENT = json_decode($SIDEBAR_CONTENT,true);
$SIDEBAR_CONTENT = $SIDEBAR_CONTENT['#markup'];
#+END_EXAMPLE

*** Custom Theme Function
Module theme: =theme('modname_theme-name',$data)=
<<<d7:hook_theme>>> 
- $existing :: array. existing themes
- $type :: string. Whether a theme, module, etc. is being processed. e.g. Is it a parent theme?
- $theme :: the name of theme, module, etc. is being processed
- $path :: the directory path of theme or module

Return an array
- variables :: theme function takes no parameter array(). Assign null to key-value for default values.
- path :: Use with 'template'
  - If theme_* function is used, you don't need to specify 'path' and 'template'
  - Whether or not hook_theme is defined in template.php or in a module, the path default is to the module or theme
  - But you should make the path to sites/all/themes/your_theme/templates/ or sites/all/modules/mod_path/modname/templates
  - e.g. 'path' => drupal_get_path('module', 'panels') . '/templates', 'path' => drupal_get_path('theme', 'panels') . '/templates',
  - if path is not defined but template is defined as a path to file (theme/template_file_name), then
    - hook_theme defined in template.php :: path_to_theme/theme/template_file_name.tpl.php
    - hook_theme defined in a module :: path_to_module/theme/template_file_name.tpl.php
  - if path is not defined but template is defined as a file (template_file_name), then
    - hook_theme defined in template.php :: path_to_theme/template_file_name.tpl.php
    - hook_theme defined in a module :: path_to_module/template_file_name.tpl.php
 
- template ::
  - Assuming the theme function name is theme_lili_flair
  - Default file name is lili_flair and the actual file is lili_flair.tpl.php

<<<d7:theme_*>>>

#+BEGIN_EXAMPLE
function lili_theme( $existing, $type, $theme, $path ) {
  return array(
    'lili_flair' => array(
      'variables' => array(
        'text' => NULL,
      ),
    ),
  );
}

function theme_lili_flair( $variables ) {
  if ( ! empty( $variables['text'] ) ) {
    return '<span class="li-tag li-tag-pill li-tag-color">' . $variables['text'] . '</span>';
  } else {
    return '';
  }
}

echo theme('lili_flair',array('text'=>'hi'));

// In xxx.tpl.php use $text directly
#+END_EXAMPLE

*** Sub theme
https://www.drupal.org/docs/7/theming/creating-a-sub-theme

The name of your sub-theme must start with an alphabetic character and can only contain lowercase letters, numbers and underscores. 

Folder my_subtheme
name = My Subtheme

parent theme's .info file
base theme = theme_name

The sub-theme inherits most properties of the base theme. The important exceptions are 
- regions
- core version
- color info
- features
- parent theme's logo (logo.png/logo.jpg)
- parent theme's favicon.ico
- theme-settings.php

You probably want to copy the regions section of your base theme's info file, along with its core version declaration.

If your base theme supports the color module and you'd like your sub-theme to support it, you probably also want to copy the color folder from your base theme and add the line from your base theme's info file to your sub-themes info file that looks like:
#+BEGIN_EXAMPLE
stylesheets[all][] = css/colors.css
#+END_EXAMPLE

and then copy the colors.css from base theme to the css folder of the sub-theme.

Style sheets and JavaScripts are inherited. If you want to override, create relevant files and add these to .info
#+BEGIN_EXAMPLE
stylesheets[all][] = style.css
scripts[] = script.js
features[] = logo
#+END_EXAMPLE

Template.php funciton inheritance
- Anything defined in the parent theme's template.php file will be inherited. This includes theme function overrides, preprocess functions and anything else in that file. Each sub-theme should also have its own template.php file, where you can add additional functions or override functions from the parent theme.
- theme functions, e.g. theme('[hook]', $var,...), When a sub-theme overrides a theme function, no other version of that is called.
- preprocess functions, e.g. [theme]_preprocess_page is called before page.tpl.php is rendered. 
  - Unlike theme functions, preprocess functions are not overriden in a sub-theme.
  - Instead, the parent theme preprocess function will be called first, and the sub-theme preprocess function will be called next
  - There is no way to prevent all functions in the parent theme from being inherited. The only way to remove a parent themes' preprocess function is through hook_theme_registry_alter().

Page, node, block and other template (.tpl.php) file inheritance
e.g. node--blog.tpl.php building on an inherited node.tpl.php
A single hyphen is still used to separate words. The double hyphen always indicates a more targeted override of what comes before the "--".
e.g. node--long-content-type-name.tpl.php

Add a template file with the same name in sub-theme folder to have it override the template from the parent theme.

Screen shots inheritance

#+BEGIN_EXAMPLE
name = Jean
description = A subtheme of Bartik, which is a flexible, recolorable theme with many regions.
core = 7.x
base theme = bartik

stylesheets[all][] = css/jean.css
stylesheets[all][] = css/colors.css

regions[header] = Header
regions[help] = Help
regions[page_top] = Page top
regions[page_bottom] = Page bottom
regions[highlighted] = Highlighted

regions[featured] = Featured
regions[content] = Content
regions[sidebar_first] = Sidebar first
regions[sidebar_second] = Sidebar second

regions[triptych_first] = Triptych first
regions[triptych_middle] = Triptych middle
regions[triptych_last] = Triptych last

regions[footer_firstcolumn] = Footer first column
regions[footer_secondcolumn] = Footer second column
regions[footer_thirdcolumn] = Footer third column
regions[footer_fourthcolumn] = Footer fourth column
regions[footer] = Footer

settings[shortcut_module_link] = 0
#+END_EXAMPLE

Create the folder: /sites/all/themes/jean
Create the file /sites/all/themes/jean/jean.info
Create a blank file named: /sites/all/themes/jean/css/jean.css
Copy from bartik or create your own: /sites/all/themes/jean/logo.png
In order to get the color module to work with your subtheme, you will need to do the following:
- Copy the file /themes/bartik/css/colors.css to /sites/all/themes/jean/css/colors.css
- Copy the folder and its contents /themes/bartik/color/ to /sites/all/themes/jean/color/
- Go to the Administration > Appearance page to enable your new subtheme called Jean. Now you can add CSS to your jean.css file, and it will apply to your new subtheme.

*** 404 page
page--404.tpl.php could be in theme folder or theme's templates folder
#+BEGIN_EXAMPLE
function jean_preprocess_page(&$vars) {
  $header = drupal_get_http_header('status');
  if ($header == '404 Not Found') {
    $vars['theme_hook_suggestions'][] = 'page__404';
  }
}
#+END_EXAMPLE

*** Contributed themes
**** Omega
https://www.drupal.org/project/omega

**** Corolla
https://www.drupal.org/project/corolla

** Drush
*** version =drush version=
*** Debug =-vd=
*** Alias
=drush sa= list all aliases
pantheon:drupal:alias

*** User
drush user-login yourusername
drush user-create newuser --mail="a@b.com" --password="password"
drush user-add-role "administrator" newuser

*** Module
=drush vset maintenance_mode 1= set to maintenance mode
=drush vset maintenance_mode 0= remove maintenance mode
=drush dl devel= Download a module
=drush en devel= Enable a module
=drush dis devel= Disable a module
=drush pmu devel= Uninstall a module. Won't delete code files
=drush up <modulename> -y= Update a module. Don't need to visit update.php
=drush up --no-core= Update all modules.
=drush pml= List all modules that are enabled, disabled, not installed, installed.
=drush pml --pipe= list modules in code name

#+BEGIN_EXAMPLE
drush up <modulename> = drush upc <modulename> + drush updb
#+END_EXAMPLE

Remove incorrectly removed modules in db d7:ts:module is missing

*** Detect if it's drush
#+BEGIN_EXAMPLE
if (drupal_is_cli() && function_exists('drush_main')) return true;
return false;
#+END_EXAMPLE

*** Watchdog
**** Delete
#+BEGIN_EXAMPLE
# delete all logs
drush wd-del all

drush wd-del --type=cron

drush wd-del --severity=notice
#+END_EXAMPLE

**** Tail Recent Log Messages
#+BEGIN_EXAMPLE
drush watchdog-show --tail --full --count=50
#+END_EXAMPLE

*** SQL Query
#+BEGIN_EXAMPLE
drush sql-query "SELECT * FROM users WHERE uid=1"
#+END_EXAMPLE

*** Drupal Cache
Clear all Drupal Cache
#+BEGIN_EXAMPLE
drush cc all
#+END_EXAMPLE

*** Fields
// Field Name, Feild Type, Bundles
drush field-info fields

// Field type, Default widget, Widgets
drush field-info types

*** Custom Drush
hook_drush_command() and drush_hook_your_command() in hook.drush.inc

#+BEGIN_EXAMPLE
function li_drush_command() {
  $items['feeds-import-tnt']=[
    'description' => '...',
    'options' => [
      'feed-id' => ['description' => dt('Feed ID to import') ]
    ], // if there is no param, don't include 'options'
    'examples' => [
      'drush feeds-import-tnt --feed-id=123' => "Test example",
    ]
  ];
  return $items;
}

function drush_li_feeds_import_tnt() {
  $feed_id = drush_get_option('feed-id');
}
// drush feeds-import-tnt --feed-id=123
#+END_EXAMPLE

drupal_set_message()
- stdout. No logging. Can be used multiple times in a drush command. 
- =[status]= at the end of each line
- not print out immediately

Use the following every 3 minutes to prevent drush command timeout
#+BEGIN_EXAMPLE
print "hello\n"; // print out immediately
drush_print(); // drush_print uses print
drush_print_r($array);
#+END_EXAMPLE

*** Pantheon Drush

** Node API <<<d7:api:node>>>
https://api.drupal.org/api/drupal/modules%21node%21node.api.php/7.x
https://api.drupal.org/api/drupal/modules%21node%21node.api.php/group/node_api_hooks/7.x

[[https://www.drupal.org/node/49768][Node object]]

*** Update a node
#+BEGIN_EXAMPLE
$node = node_load($nid);
$node->fieldname['und'][0]['value'] = 'field value';
node_save($node);
#+END_EXAMPLE

d7:field_attach_update doens't trigger hook_node_presave and other node hooks
#+BEGIN_EXAMPLE
$article_nodes = node_load_multiple(array(), array('type' => 'article'));
foreach ($article_nodes as $article_node) {
  $article_node->body[LANGUAGE_NONE][0]['value'] = 'body value';
  field_attach_update('node', $article_node);
}
#+END_EXAMPLE

Recommended: use d7:entity_metadata_wrapper to update to avoid putting language code

** Views <<<d7:viewsapi>>>
*** UI
**** Contextual filter with term name not term id
Choose =Content: Has taxonomy term ID=
Check =Specify validation criteria=
Validator =Taxonomy Term=, Filter value type =Term name converted to Term ID=
Check =Transform dashes in URL to spaces in term name filter values=
**** Path vs Link
Content: Path with Rewrite Result option "Use absolute link" is the raw path.
**** Field value is taxonomy ID not taxonomy name
Use Rewrite Result "[field_name-tid]" 
*** Entity Reference View
Require d7:entityreference module <<<d7:entity reference view>>>

*** View Object
Hooks use $view object.
**** Properties
args :: array(
 0 => '37',
)
name :: 'tt_taxonomy'
current_display :: 'page'
**** Methods
$v->get_items_per_page(); // Return nothong in hook_views_pre_build
$v->set_items_per_page(10); // hook_views_pre_build

*** hook_views_api
#+BEGIN_EXAMPLE
Views 3.x
/**
 * Implements hook_views_api().
 */
function my_module_views_api() {
  return array(
    'api' => 3,
  );
}
#+END_EXAMPLE

All Views hook code should be placed in my_module.views.inc which is located in module root directory if 'path' is not defined.
All hooks' callbacks (Class definition) such as plugin and custom filter callback should be included in my_module.info as separate files

*** hook_views_query_alter
Put it in MODULENAME.views.inc based on hook_views_api. But I had success to just include this hook in .module file
One way to avoid setup the *.views.inc is to use Views GUI to assign an Query Tag then use hook_query_TAG_alter but it runs twice.. So stick with hook_views_query_alter

#+BEGIN_EXAMPLE
// dpm($query->where);
// One condition
$c1 = [
 'field' => 'node.status',
 'value' => 1,
 'operator' => '='
];

$c2 = [
 'field' => 'node_search_index.word',
 'value' => '% burger %',
 'operator' => 'LIKE'
];

$c3 = [
 'field' => 'node.uid = :node_uid',
 'value' => [':node_uid' => '5'],
 'operator' => 'formula'
];

$c4 = [
 'field' => 'node.type',
 'value' => ['ns_newsletter'],
 'operator' => 'in'
];

// a condition group
$cg1 = [
  'field' => object::Drupal\Core\Database\Query\Condition
];

[ 'conditions' => [ $c1, $c2 ]
  'args' => [],
  'type' => 'AND'
],
[ 'conditions' => [ $c3, $c4 ]
  'args' => [],
  'type' => 'AND'
],
[ 'conditions' => [ $cg1 ]
  'args' => [],
  'type' => 'AND'
]
#+END_EXAMPLE

#+BEGIN_EXAMPLE
function mymod_views_query_alter(&$view, &$query) {
  dpm($view, __FUNCTION__);
  dpm($query, __FUNCTION__);
  if ($view->name == 'lili_view' && $view->current_display == 'page') {
    foreach ($query->where as &$condition_group) {
      _recursively_alter_query_conditions($condition_group['conditions']);
    }
  }
  // add a where condition group
  // views_plugin_query_default::add_where($group, $field, $value = NULL, $operator = NULL)
  $cg_count = count($query->where);
  $query->add_where($cg_count, '0', '1', '=');
}

// helper function: (takes in conditions group argument)
function _recursively_alter_query_conditions(&$conditions) {
  // foreach condition in condition group
  foreach ($conditions as &$condition) {
    // if condition is itself a condition group
    if (isset($condition['field']) && is_a($condition['field'], 'Drupal\Core\Database\Query\Condition')) {
      // call the helper function on it
      _recursively_alter_query_conditions($condition['field']->conditions());
    }
    else {
      // check if we want to alter the condition and if so alter it
      _alter_query_condition($condition);
    }
  }
}

// separate helper function to determine if the condition is one we want to alter
function _alter_query_condition(&$condition) {
  if (isset($condition['field']) && ($condition['field'] === 'node_search_index.word')) {
    $condition['value'] = "%{$condition['value']}%";
    $condition['operator'] = 'LIKE';
  }
  if (isset($condition['field']) && ($condition['field'] === 'node_search_dataset.data')) {
    // here we're using trim to eliminate both the unwanted whitespace and the '%' symbols,
    // which then get added back via string concatenation
    $condition['value'] = "%" . trim($condition['value'], " \t\n\r\0\x0B%") . "%";
  }
}
#+END_EXAMPLE

*** hook_views_pre_build
*** hook_views_pre_render
**** Change Global Custom Text
Change the field value with tokens in Views UI
#+BEGIN_EXAMPLE
function lili_views_pre_render(&$view) {
	if ($view->name == 'lili_view' && $view->current_display == 'page') {

		// Change value for specific rows
		foreach ($view->result as $k => $r) {
			if ($f = &$r->field_field_flag) {
				$o = $f[0]['rendered']['#markup'];
				$o = theme('lili_theme_flair', array('text'=>$o));
				$f[0]['rendered']['#markup'] = $o;
			}

			// Taxonomy field
			if ($f = &$r->field_field_category) {
				$exclude_tids = array(1,2,3);
				foreach ($f as $k => $v) {
					if (!in_array($v['raw']['tid'], $exclude_tids)) {
						// Remove from display
						unset($f[$k]);
					}
				}
			}
			
		}

		// Only change global custom text for a subset of contextual filter value
		// The first context filter value
		if ($view->args[0] == 'filter_value') {
			// Check View UI Theme Information to get the Global Custom Text field ID
			if (isset($view->field['field_thumbnail']->options['exclude'])) {
				// Exclude display
				$view->field['field_thumbnail']->options['exclude'] = 1;
			}
			if (isset($view->field['nothing']->options['alter']['text'])) {
				// Change a field's CSS Class setting for all records
				$view->field['nothing']->options['element_class'] = '';
				$o = $view->field['nothing']->options['alter']['text'];
				$view->field['nothing']->options['alter']['text'] = 'hello'.$o;
			}
		}
	}
}
#+END_EXAMPLE

*** Custom View Filter hook_views_data_alter
http://precessionmedia.com/blog/how-create-custom-filter-handler-views

#+BEGIN_EXAMPLE
/**
 * Implements hook_views_data_alter().
 */
function my_module_views_data_alter(&$data) {
  $data['node']['title_count']['title'] = 'Title word count';
  $data['node']['title_count']['help'] = 'Count the number of words in titles.';
  $data['node']['title_count']['filter']['handler'] = 'my_module_handler_filter_field_count';
}
#+END_EXAMPLE

my_module.info
#+BEGIN_EXAMPLE
files[] = my_module_handler_filter_field_count.inc
#+END_EXAMPLE

my_module_handler_filter_field_count.inc
#+BEGIN_EXAMPLE
class my_module_handler_filter_field_count extends views_handler_filter_numeric {
  function operators() {
    $operators = parent::operators();
    // We won't be using regex in our example
    unset($operators['regular_expression']);
 
    return $operators;
  }
 
  // Helper function to return a sql expression
  // for counting words in a field.
  function field_count() {
    // Set the real field to the title of the node
    $this->real_field = 'title';
 
    $field = "$this->table_alias.$this->real_field";
    return "LENGTH($field)-LENGTH(REPLACE($field,' ',''))+1";
  }
 
  // Override the op_between function
  // adding our field count function as parameter
  function op_between($field) {
    $field_count = $this->field_count();
 
    $min = $this->value['min'];
    $max = $this->value['max'];
 
    if ($this->operator == 'between') {
      $this->query->add_where_expression($this->options['group'], "$field_count BETWEEN $min AND $max");
    }
    else {
      $this->query->add_where_expression($this->options['group'], "($field_count <= $min) OR ($field_count >= $max)");
    }
  }
 
  // Override the op_simple function
  // adding our field count function as parameter
  function op_simple($field) {
    $field_count = $this->field_count();
 
    $value = $this->value['value'];
 
    $this->query->add_where_expression($this->options['group'], "$field_count $this->operator $value");
  }
}
#+END_EXAMPLE

In Views UI, add a filter with name "Title word count" with descript "Count the number of words in titles."

*** Better Exposed Filters Module
<<<d7:better exposed filters>>>
If you want checkboxes or radio buttons instead of the Views Basic Exposed Form which is dropdown select.

Change BEF form hook_form_views_exposed_form_alter
#+BEGIN_EXAMPLE
function lili_form_views_exposed_form_alter(&$form, &$form_state) {
  if (isset($form['#id'])) {
    switch ($form['#id']) {
      case 'views-exposed-form-your-form-name':
        // ...
        break;
    }
  }
}
#+END_EXAMPLE
The form id is views-exposed-form-view--machine-name-display-machine-name

*** Custom Views Plugin hook_views_plugins
*** Views API Order
hook_views_pre_view
hook_views_pre_build
hook_views_post_build
hook_views_pre_execute
hook_views_post_execute
hook_views_pre_render
hook_views_post_render

*** Embed View and Display
views_embed_view('view_name','display_id'); Doesn't display view title
#+BEGIN_EXAMPLE
$arg1 = $arg2 = '123';
print views_embed_view('view_name','display_id',$arg1,$arg2);
#+END_EXAMPLE

#+BEGIN_EXAMPLE
$my_view_name = 'magazines';
$my_display_name = 'block_1';
$my_view = views_get_view($my_view_name);
if (is_object($my_view)) {
  $my_view->set_display($my_display_name);
  $my_view->pre_execute();
  echo $my_view->render($my_display_name);
}
#+END_EXAMPLE

*** View Theming
<<<d7:View_Theming>>>

View, named foobar. Style: unformatted. Row styel: Fields. Display: Page.

- views-view-foobar--page.tpl.php
- views-view-page.tpl.php
- views-view--foobar.tpl.php
- views-view.tpl.php

- views-view-unformatted--foobar--page.tpl.php
- views-view-unformatted--page.tpl.php
- views-view-unformatted--foobar.tpl.php
- views-view-unformatted.tpl.php

- views-view-fields--foobar--page.tpl.php
- views-view-fields--page.tpl.php
- views-view-fields--foorbar.tpl.php
- views-view-fields.tpl.php

** Ellipsis <<<d7:ellipsis>>>
Use truncate_utf8 for plain text string
#+BEGIN_EXAMPLE
truncate_utf8($string, $max_length, $wordsafe = FALSE, $add_ellipsis = FALSE, $min_wordsafe_length = 1)
#+END_EXAMPLE

This can be used in custom module. Trim first, then remove scraps of html
e.g. ~<a>fda</~, ~<a>fda</a~ and ~<a>fda<~ will become ~<a>fda~
'html' => true will close any unclosed html tags.
#+BEGIN_EXAMPLE
views_trim_text(array(
            'max_length' => 200,
            'word_boundary' => TRUE,
            'ellipsis' => TRUE,
            'html' => TRUE, // optional
          ), 'Long String');
// Output
Long String<span class="ellipsis">...</span>
#+END_EXAMPLE

Source code
#+BEGIN_EXAMPLE
function views_trim_text($alter, $value) {
  if (drupal_strlen($value) > $alter['max_length']) {
    $value = drupal_substr($value, 0, $alter['max_length']);
    // TODO: replace this with cleanstring of ctools
    if (!empty($alter['word_boundary'])) {
      $regex = "(.*)\b.+";
      if (function_exists('mb_ereg')) {
        mb_regex_encoding('UTF-8');
        $found = mb_ereg($regex, $value, $matches);
      }
      else {
        $found = preg_match("/$regex/us", $value, $matches);
      }
      if ($found) {
        $value = $matches[1];
      }
    }
    // Remove scraps of HTML entities from the end of a strings
    $value = rtrim(preg_replace('/(?:<(?!.+>)|&(?!.+;)).*$/us', '', $value));

    if (!empty($alter['ellipsis'])) {
      $value .= t('...');
    }
  }
  if (!empty($alter['html'])) {
    $value = _filter_htmlcorrector($value);
  }

  return $value;
}

function _filter_htmlcorrector($text) {
  return filter_dom_serialize(filter_dom_load($text));
}
function filter_dom_load($text) {
  $dom_document = new DOMDocument();
  // Ignore warnings during HTML soup loading.
  @$dom_document->loadHTML('<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /></head><body>' . $text . '</body></html>');

  return $dom_document;
}

function filter_dom_serialize($dom_document) {
  $body_node = $dom_document->getElementsByTagName('body')->item(0);
  $body_content = '';

  if ($body_node !== NULL) {
    foreach ($body_node->getElementsByTagName('script') as $node) {
      filter_dom_serialize_escape_cdata_element($dom_document, $node);
    }

    foreach ($body_node->getElementsByTagName('style') as $node) {
      filter_dom_serialize_escape_cdata_element($dom_document, $node, '/*', '*/');
    }

    foreach ($body_node->childNodes as $child_node) {
      $body_content .= $dom_document->saveXML($child_node);
    }
    return preg_replace('|<([^> ]*)/>|i', '<$1 />', $body_content);
  }
  else {
    return $body_content;
  }
}

// Adds comments around the <!CDATA section in a dom element.
function filter_dom_serialize_escape_cdata_element($dom_document, $dom_element, $comment_start = '//', $comment_end = '') {
  foreach ($dom_element->childNodes as $node) {
    if (get_class($node) == 'DOMCdataSection') {
      // See drupal_get_js().  This code is more or less duplicated there.
      $embed_prefix = "\n<!--{$comment_start}--><![CDATA[{$comment_start} ><!--{$comment_end}\n";
      $embed_suffix = "\n{$comment_start}--><!]]>{$comment_end}\n";

      // Prevent invalid cdata escaping as this would throw a DOM error.
      // This is the same behavior as found in libxml2.
      // Related W3C standard: http://www.w3.org/TR/REC-xml/#dt-cdsection
      // Fix explanation: http://en.wikipedia.org/wiki/CDATA#Nesting
      $data = str_replace(']]>', ']]]]><![CDATA[>', $node->data);

      $fragment = $dom_document->createDocumentFragment();
      $fragment->appendXML($embed_prefix . $data . $embed_suffix);
      $dom_element->appendChild($fragment);
      $dom_element->removeChild($node);
    }
  }
}
#+END_EXAMPLE

** Form
*** Form API
https://api.drupal.org/api/drupal/developer%21topics%21forms_api_reference.html/7.x

*** Form alter hooks
Called in order, from general to specific
=hook_form_alter= 
=hook_form_BASE_FORM_ID_alter=, Refer BASE_FORM_ID to =$form_state['build_info']['base_form_id']=
=hook_form_FORM_ID_alter=. Refer FORM_ID to =$form['#id']=

Set default value and hide a form from display or filling
#+BEGIN_EXAMPLE
// Entity reference form field
$form['field_dealer'][LANGUAGE_NONE][0]['target_id']['#default_value'] = 123;
$form['field_dealer'][LANGUAGE_NONE][0]['#printed'] = TRUE;
#+END_EXAMPLE

#+BEGIN_EXAMPLE
hook_form_FORM_ID_alter(&$form, &$form_state, $form_id)
#+END_EXAMPLE

*** Form IDs of system forms
=node= :: node new/edit
=user_profile= :: page/user/<uid>

lili_node_form_alter

node type (content type) ad_listing, that node's new/edit form is
lili_form_ad_listing_node_form_alter using hook_form_FORM_ID_alter hook

Some modules alter the form before your custom alters. Such as field dependency module d7:module:conditional fields

*** Confirm Form
e.g. Confirm before delete
#+BEGIN_EXAMPLE
// Menu
$items['dealer_user/%/delete'] = array(
	'title' => 'Delete a user',
	'page callback' => 'drupal_get_form',
	'page arguments' => array('lili_delete_dealer_user_confirm',1),
	'access callback' => 'lili_user_has_delete_right',
	'access arguments' => array(1, array('Dealer Admin')),
	'type' => MENU_LOCAL_TASK,
);

function lili_delete_dealer_user_confirm($form, &$form_state, $id) {
	$form['delete'] = array(
		'#type' => 'value',
		'#value' => $id,
	);
	return confirm_form($form,
		t('Are you sure you want to delete this user?'), // Question
		'dealer_manage_users',  // Path to go to if No
		t('This action cannot be undone.'), // Description
		t('Delete Button'), // Yes: text
		t('Cancel Button') // No: text
		//, $name default 'confirm': internal name used to refer to the confirmation item.
	);
}

function lili_delete_dealer_user_confirm_submit($form, &$form_state) {
	if ($uid = $form_state['values']['delete']) {
		$u = user_load($uid);
		user_cancel();
		drupal_set_message(t('The user account has been deleted!'));
	}
	$form_state['redirect'] = 'dealer_manager_users';
}

function lili_user_has_delete_right($uid = 0, array $roles) {
	global $user;
	// If user is anonymous
	if (user_is_anonymous()) {
		return FALSE;
	}
	if (in_array('administrator', $user->roles)) {
		return TRUE;
	}
	if (array_intersect($roles, $user->roles)) {
		return TRUE;
	}
}
#+END_EXAMPLE

*** form_load_include
Include files whenever a form is loaded.
form_load_include(&$form_state, $type, $module, $name = NULL) {}
// if name is omitted, then $module.$type is loaded.
// return The filepath of the loaded include file, or FALSE if the include file was
// not found or has been loaded already.
// file is always included even the form is cached.
form_load_include($form_state, 'inc', 'tnt', 'tnt.pages');

*** Form Ajax
https://www.drupal.org/docs/7/api/javascript-api/ajax-forms-in-drupal-7

https://api.drupal.org/api/drupal/developer%21topics%21forms_api_reference.html/7.x#ajax

#+BEGIN_EXAMPLE
/**
 * Ajax-enabled select element causes replacement of a set of checkboxes
 * based on the selection.
 */
function ajax_example_autocheckboxes($form, &$form_state) {

  $default = !empty($form_state['values']['howmany_select']) ? $form_state['values']['howmany_select'] : 1;

  $form['howmany_select'] = array(
    '#title' => t('How many checkboxes do you want?'),
    '#type' => 'select',
    '#options' => array(1 => 1, 2 => 2, 3 => 3, 4 => 4),
    '#default_value' => $default,
    '#ajax' => array(
      'callback' => 'ajax_example_autocheckboxes_callback',
      'wrapper' => 'checkboxes-div',
      'method' => 'replace',
      'effect' => 'fade',
    ),

  );


  $form['checkboxes_fieldset'] = array(
    '#title' => t("Generated Checkboxes"),
    // The prefix/suffix provide the div that we're replacing, named by
    // #ajax['wrapper'] above.
    '#prefix' => '<div id="checkboxes-div">',
    '#suffix' => '</div>',
    '#type' => 'fieldset',
    '#description' => t('This is where we get automatically generated checkboxes'),
  );

  $num_checkboxes = !empty($form_state['values']['howmany_select']) ? $form_state['values']['howmany_select'] : 1;
  for ($i = 1; $i <= $num_checkboxes; $i++) {
    $form['checkboxes_fieldset']["checkbox$i"] = array(
      '#type' => 'checkbox',
      '#title' => "Checkbox $i",
    );
  }

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Submit'),
  );

  return $form;
}

/**
 * Callback element needs only select the portion of the form to be updated.
 * Since #ajax['callback'] return can be HTML or a renderable array (or an
 * array of commands), we can just return a piece of the form.
 */
function ajax_example_autocheckboxes_callback($form, $form_state) {
  return $form['checkboxes_fieldset'];
}
#+END_EXAMPLE

#ajax['event'] :: which jquery event triggers AJAX. Don't need to set. Default is fine.
#ajax['callback'] :: return HTML or renderable array to replace #ajax['wrapper']. By the time it gets called, the form is recalculated/rebuilt in PHP and you can return $form['the_field_name'] directly. The callback function can't change any state or form settings. Do it in form builder functions: hook_form, hook_form_alter. Callback function is called after all the form processing fuctions.
#ajax['wrapper'] :: HTML container.

*** Form field loaded with terms of a taxonomy fields
<<<d7:form:taxonomy field>>>
#+BEGIN_EXAMPLE
$parts_makes = ['0' => t('Make')]; // First option
$_terms = taxonomy_allowed_values(field_info_field('field_parts_make'));

// [123] => term123_name, [345] => term345_name, ...

if ($language->language == 'en') {
  $parts_makes += $_terms;
}
else {
  $parts_make_terms = $_terms;
  foreach ($parts_make_terms as $tid => $name) {
    $i18n_object = i18n_get_object('taxonomy_term', $tid);
    if ($translated_term = $i18n_object->localize($language->language)) {
      $parts_makes[$tid] = (!empty($translated_term->name)) ? $translated_term->name : $parts_make_terms[$tid];
    }
  }
}

$form['make'] = [
  '#type' => 'select',
  '#options' => $parts_makes,
];
#+END_EXAMPLE

** Action
hook_info_action
return ['action_name' => $an_action];

$an_action :: array
- 'permissions' :: this is specific for View Bulk Operations (VBO). e.g. array('switch users')
- 'behavior' :: array. VBO uses one of views_property, changes_property, creates_property, deletes_property

[[https://www.drupal.org/node/2052067#permissions][VBO Permissions]]

** Field API <<<d7:api:field>>>
*** Field Formatter
Content Type > Manage Display > Format for a field
hook_field_formatter_info tells Drupal a new field formatter that will apply to what field types.
If a formatter has a setting, a summary and a form needs to be defined in order to show a gear icon next to summary in Manage Display

hook_field_formatter_info :: hook_field_formatter_info_alter

#+BEGIN_EXAMPLE
function text_field_formatter_info() {
  return array(
    'text_default' => array(
      'label' => t('Default'),
      'field types' => array('text', 'text_long', 'text_with_summary'),
    ),
    'text_plain' => array(
      'label' => t('Plain text'),
      'field types' => array('text', 'text_long', 'text_with_summary'),
    ),

    'text_trimmed' => array(
      'label' => t('Trimmed'),
      'field types' => array('text', 'text_long', 'text_with_summary'),
      'settings' => array('trim_length' => 600),
    ),

    'text_summary_or_trimmed' => array(
      'label' => t('Summary or trimmed'),
      'field types' => array('text_with_summary'),
      'settings' => array('trim_length' => 600),
    ),
  );
}
#+END_EXAMPLE

hook_field_formatter_settings_summary

#+BEGIN_EXAMPLE
function text_field_formatter_settings_summary($field, $instance, $view_mode) {
  $display = $instance['display'][$view_mode];
  $settings = $display['settings'];

  $summary = '';

  if (strpos($display['type'], '_trimmed') !== FALSE) {
    $summary = t('Trimmed limit: @trim_length characters', array('@trim_length' => $settings['trim_length']));
  }

  return $summary;
}
#+END_EXAMPLE

hook_field_formatter_settings_form

#+BEGIN_EXAMPLE
function text_field_formatter_settings_form($field, $instance, $view_mode, $form, &$form_state) {
  $display = $instance['display'][$view_mode];
  $settings = $display['settings'];

  $element = array();

  if (strpos($display['type'], '_trimmed') !== FALSE) {
    $element['trim_length'] = array(
      '#title' => t('Trimmed limit'),
      '#type' => 'textfield',
      '#field_suffix' => t('characters'),
      '#size' => 10,
      '#default_value' => $settings['trim_length'],
      '#element_validate' => array('element_validate_integer_positive'),
      '#description' => t('If the summary is not set, the trimmed %label field will be shorter than this character limit.', array('%label' => $instance['label'])),
      '#required' => TRUE,
    );
  }

  return $element;
}
#+END_EXAMPLE

hook_field_formatter_view :: use settings to return result (HTML). Use hook_field_formatter_prepare_view to add info for field values being displayed.

#+BEGIN_EXAMPLE
function text_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
  $element = array();

  switch ($display['type']) {
    case 'text_default':
    case 'text_trimmed':
      foreach ($items as $delta => $item) {
        $output = _text_sanitize($instance, $langcode, $item, 'value');
        if ($display['type'] == 'text_trimmed') {
          $output = text_summary($output, $instance['settings']['text_processing'] ? $item['format'] : NULL, $display['settings']['trim_length']);
        }
        $element[$delta] = array('#markup' => $output);
      }
      break;

    case 'text_summary_or_trimmed':
      foreach ($items as $delta => $item) {
        if (!empty($item['summary'])) {
          $output = _text_sanitize($instance, $langcode, $item, 'summary');
        }
        else {
          $output = _text_sanitize($instance, $langcode, $item, 'value');
          $output = text_summary($output, $instance['settings']['text_processing'] ? $item['format'] : NULL, $display['settings']['trim_length']);
        }
        $element[$delta] = array('#markup' => $output);
      }
      break;

    case 'text_plain':
      foreach ($items as $delta => $item) {
        $element[$delta] = array('#markup' => strip_tags($item['value']));
      }
      break;
  }

  return $element;
}
#+END_EXAMPLE

Usage

#+BEGIN_EXAMPLE
$node = node_load($view->result[0]->_field_data['nid']['entity']->nid);
$settings = array(
  'label'    => 'hidden',
  'type'     => 'text_summary_or_trimmed',
  'settings' => array('trim_length' => 800),
);
$node_summary = field_view_field('node', $node, 'body', $settings);
print render($node_summary);
#+END_EXAMPLE

** Database
*** Close Comment for Existing Nodes
0 = No, 1 = Closed (read only), 2 = Open (Read/Write)
#+BEGIN_EXAMPLE
UPDATE node, node_revision
SET node.comment = 1, node_revision.comment = 1
WHERE node_revision.nid = node AND node.type = 'article'
#+END_EXAMPLE

*** Structure
**** node
nid* :: INT
vid :: The current node_revision.vid version id
uid :: author id
type :: string, e.g. article, 
title
created :: 
sticky :: int, 0. 1 means to show on top of query result
promote :: int, 0. 1 means to show on homepage

**** field_data_body
entity_type* :: string, e.g. node
deleted* :: int, 0 not deleted
entity_id* :: int, e.g. node id
language* :: string
delta* :: int, multiple values, start as 0
bundle :: string, e.g. node type article
revision_id :: int

body_value :: longtext
body_summary :: longtext

**** field_data_field_custom_term_reference
field_custom_term_referecen_tid :: int

**** taxonomy_term_data
tid* :: int
vid :: int, vocabulary id. see taxonomy_vocabulary
name :: string, term name
weight :: int

**** taxonomy_vocabular
vid* ::
name ::
machine_name

**** field_data_field_contributor (entity reference)
field_contributor_target_id :: int

**** url_alias
pid* :: int, path id
source :: string, e.g. node/2, taxonomy/term/11
alias :: string
language :: string, e.g. und

**** Export Query
#+BEGIN_EXAMPLE
SELECT n.title,
  b.body_value,
  GROUP_CONCAT(t.name SEPARATOR ', ') AS Category,
  IFNULL(na.title,'') AS author,
  CONCAT('http://domain.com/',u.alias) as url,
  FROM_UNIXTIME(n.created) as post_date

FROM node AS n
  INNER JOIN field_data_body b ON b.entity_id=n.nid AND b.delta=0
  INNER JOIN field_data_field_category c ON c.entity_id=n.nid AND c.deleted=0
  LEFT JOIN taxonomy_term_data t ON t.tid = c.field_category_tid
  INNER JOIN field_data_field_contributor a ON a.entity_id=n.nid AND a.deleted=0
  LEFT JOIN node as na ON na.nid=a.field_contributor_target_id
  INNER JOIN url_alias u ON u.source = concat('node/',n.nid)

WHERE FROM_UNIXTIME(n.created)
      BETWEEN '2014-01-01 00:00:00' AND '2014-12-31 23:59:59'
  AND n.type ='article'
GROUP BY n.nid
ORDER BY n.created DESC
#+END_EXAMPLE

Export taxonomy vocabular
#+BEGIN_EXAMPLE
SELECT
  t.tid                                         AS tid,
  t.name,
  h.parent                                      AS parent_tid,
  t.weight,
  CONCAT('http://yourweb.com/', u.alias)                        AS url

FROM taxonomy_vocabulary v
  LEFT JOIN taxonomy_term_data t ON t.vid = v.vid
  LEFT JOIN taxonomy_term_hierarchy h ON h.tid = t.tid
  LEFT JOIN field_data_field_mega_title mega_title
    ON mega_title.entity_id = t.tid
  LEFT JOIN field_data_field_mega_story_title mega_story_title
    ON mega_story_title.entity_id = t.tid
  LEFT JOIN field_data_field_landing_page_type splash
    ON splash.entity_id = t.tid
  LEFT JOIN url_alias u ON u.source = concat('taxonomy/term/', t.tid)
WHERE
  0 = 0
  AND v.machine_name = 'articles'

ORDER BY h.parent, t.weight
#+END_EXAMPLE

**** Export File URI, file_managed
<<<d7:db:file uri>>>
#+BEGIN_EXAMPLE
SELECT n.nid, n.title
,ds_i_fm.uri AS splash_image -- e.g. public://abc.jpg
,REGEXP_REPLACE(ds_i_fm.uri, "^(s3://)(.*)", 'http://s3.amazonaws.com/abc.com/\\2') AS splash_image, -- s3://abc.jpg
FROM node AS n
LEFT JOIN field_data_field_image ds_i ON ds_i.entity_id=n.nid AND ds_i.deleted=0
LEFT JOIN file_managed ds_i_fm ON ds_i_fm.fid = ds_i.field_image_fid
WHERE n.type = 'article'
  AND n.nid = 123
#+END_EXAMPLE

**** file_usage
fid
id :: e.g. node id

**** system
d7:ts:module is missing

**** users
*uid :: int(10)
name :: 
pass ::
mail :: email
init :: initial email
created :: int(11), unix time
access :: int(11), unix time. previous time user accessed the site
login :: int(11), unix time
status :: tinyint(4)

**** users_role
uid
rid

**** role
rid*
name
weight

** Query
Use [[https://www.drupal.org/docs/7/api/database-api/static-queries][db_query]] as much as possible. db_select is slow because it calls alter hooks.
Both can only be looped once using foreach

Use db_query or db_select to get all nids, load all nodes at once and then manipulate fields.

db_query is meant for simple select query. [[https://www.drupal.org/node/310075][db_select]] is dynamic query
*** db_select
#+BEGIN_EXAMPLE
$q = db_select( 'node', 'n' );
$q->join( 'field_data_body', 'b', 'n.nid=b.entity_id AND b.delta=0' );
$q->innerJoin( 'field_data_field_category', 'nc'
  , 'n.nid=nc.entity_id AND nc.deleted=0' );
$q->innerJoin( 'taxonomy_term_hierarchy', 'tH', 'tH.tid=nc.field_category_tid' );

if ( ! is_null( $termID ) ) {
  $articleCats = array( $termID );
}

$q->fields( 'n', array( 'nid', 'title', 'created' ) )
  ->fields( 'b', array( 'body_summary', 'body_value' ) )
  ->condition( 'n.status', 1 )// Published.
  ->condition( 'n.type', 'article' )// article not page.
  ->condition(
    db_or()
      ->condition( 'nc.field_category_tid', $articleCats, 'IN' )
      ->condition( 'tH.parent', $articleCats, 'IN' )
  )
  ->range( $i_start, $i_length )
  ->groupBy( 'n.nid' )
  ->orderBy( 'created', 'DESC' );

// debug a query
print_r($query->__toString());
print_r($query->arguments());

$r = $q->execute();

$nids = [ ];
foreach ( $result as $n ) {
  $nids[] = $n->nid;
}
$nodes = node_load_multiple( $nids );

foreach ( $nodes as $node ) {
  $nodeID    = $node->nid;
  $nodeTitle = $node->title;
  $nodeBody  = lili_getFieldSafe( $node, 'body' );
  $nodeURL   = url( "node/" . $node->nid );

  $nodeSplashObj = field_get_items( 'node', $node, 'field_splash_image' );

  if ( is_array( $nodeSplashObj ) ) {
    // $nodeSplashObj['#item']['uri'];
    // $nodeSplashObj['#item']['width'];
    // $nodeSplashObj['#item']['height'];
  }

  // Entity Reference
  $nodeFlag = field_get_items('node',$nodeObj,'field_flag');
  if ($nodeFlag) {
    $nodeFlag = field_view_value('node', $node, 'field_flag', $nodeFlag[0]);
    $nodeFlag = $nodeFlag['#markup'];
    $nodeFlag = theme_infscroll_flair(array('text'=>$nodeFlag));
  }
  else {
    $nodeFlag = '';
  }

}

function lili_getFieldSafe( $node, $field ) {
  $s = field_get_items( 'node', $node, $field );
  if ( $s ) {
    $s = ( $s[0]['safe_value'] ) ? $s[0]['safe_value'] : '';
  } else {
    $s = '';
  }

  return $s;
}
#+END_EXAMPLE

*** db_query
https://www.drupal.org/docs/7/api/database-api/static-queries
https://api.drupal.org/api/drupal/includes%21database%21database.inc/function/db_query/7.x

#+BEGIN_EXAMPLE
$query = db_query("SELECT nid, title FROM {node}");
$records = $query->fetchAll(); // get all records into an indexed array of stdClass
$records = $query->rowCount();
foreach ($records as $record) {
  // Do something.
}

// placeholders should not be escaped or quoted
$result = db_query("SELECT nid, title FROM {node} WHERE created > :created", 
array(
  ':created' => REQUEST_TIME - 3600,
));

db_query("SELECT * FROM {node} WHERE nid IN (:nids)", array(':nids' => array(13, 42, 144)));

// query options, use 'target' and 'fetch' only
'target' => 'default', // or 'slave'
'fetch' => PDO::FETCH_OBJ // or PDO::FETCH_ASSOC, PDO::FETCH_NUM, PDO::FETCH_BOTH or a string of a class name

$sql = "SELECT name, quantity FROM goods WHERE vid = :vid";
$result = db_query($sql, array(':vid' => $vid));
if ($result) {
  while ($row = $result->fetchAssoc()) {
    // fetch next row as an associative array
    // vs fetch next row as an object $result->fetchObject()
    // Do something with:
    // $row['name']
    // $row['quantity']
  }
}

// Get the first column result set as one single array
$nids = $result->fetchCol();
// Column number can be specified otherwise default to first column
$nids = $result->fetchCol(2);

// say first column is node id, then load all nodes
$nodes = node_load_multiple( $nids );
#+END_EXAMPLE

Other fetch usage
#+BEGIN_EXAMPLE
// Fetch data from specific column from next row
// Defaults to first column if not specified as argument
$data = $result->fetchColumn(1); // Grabs the title from the next row

// Retrieve all records as stdObjects into an associative array 
// keyed by the field in the result specified. 
// (in this example, the title of the node)
$result->fetchAllAssoc('title');

// Retrieve a 2-column result set as an associative array of field 1 => field 2.
$result->fetchAllKeyed();
// Also good to note that you can specify which two fields to use
// by specifying the column numbers for each field
$result->fetchAllKeyed(0,2); // would be nid => created
$result->fetchAllKeyed(1,0); // would be title => nid

#+END_EXAMPLE

*** db_delete
Same syntax as db_select

#+BEGIN_EXAMPLE
$num_deleted = db_delete('node')
  ->condition('nid', 5)
  ->execute();
#+END_EXAMPLE

Clear cache is needed if field_data_field_xxx are deleted.
Delete a required field for node (nid) <<<d7:db:delete required field>>>
#+BEGIN_EXAMPLE
$q = db_delete('field_data_field_trailer_make');
$q->condition('entity_id', $node->nid);
$r = $q->execute();
#+END_EXAMPLE

*** hook_query_TAG_alter
<<<hook_query_TAG_alter>>>
#+BEGIN_EXAMPLE
function mymod_query_node_is_not_tagged_alter(QueryAlterableInterface $query) {
  $query->leftJoin('field_data_field_tags', 'o', 'node.nid = o.entity_id AND o.entity_type = :entity_type');
  $query->isNull('o.field_tags_tid');
}
#+END_EXAMPLE

** Entity
Node, user, taxonomy are all entities.

*** EntityFieldQuery
Use this to get entities of one type that have certain:
- entity properties (propertyCondition: status, changed, etc)
- field values (fieldCondition)
- entity meta data (entityCondition: bundle, entity_type, entity_id and revision_id)
- It's essentially db_select except EFQ can't do joins
- It's a lot slower
- But it provides simple syntax
- It's good for quick filtering entities by basic field values and return entity ids
- Preferred over db_select
- EFQ can return any type of entities including nodes of various types
- EFQ can only return essential fields such as node nid, vid and type
- Use EFQ result nids and node_load_multiple or entity_load
- Use EFQ result nids and get values of a field for all nodes (load only one field for all nodes)
- If you want custom fields and node->title, better to use node_load_multiple or entity_load
- By default without addMetaData, EFQ requires permissions of all the fields!

#+BEGIN_EXAMPLE
$_q = new EntityFieldQuery();
$_r = $_q
->entityCondition('entity_type', 'node') // taxonomy_term, user
->entityCondition('bundle', 'newsletter') // node type or content type
->fieldCondition('field_active','value',1,'=') // boolean field, only 1 or 0
->fieldCondition('field_news_publishdate', 'value', $year . '%', 'like') // Text LIKE
->fieldOrderBy('field_ns_newsletter_unique_id', 'value', 'DESC') // Sort
->fieldCondition('field_a_term_reference_field', 'tid', 123) // field Term Reference
->fieldCondition('field_a_term_reference_field', 'tid', $tids) // field Term Reference multiple has at least one value in array $tids
->fieldCondition('field_dealer', 'target_id', 12345, '=') // field Entity Reference, single value
->fieldCondition('field_contacts', 'target_id', 12345) // field Entity Reference, multiple values have one 12345
/* NOT IN
12345 not in mutliple target_id: you have to do one query to show all and do one with 'IN' and 
get the difference
$_r_all = (!empty($_r_all['node'])) ? $_r_all['node'] : array();
$_r_in_12345 = (!empty($_r_in_12345['node'])) ? $_r_in12345['node'] : array();
$_r = array_diff_key($_r_all, $_r_in_12345);
*/

->propertyCondition('status',1) 
// status, type, nid, uid, rui, type, created
// search for "Implements hook_entity_info()" will show all entity properties

// Operators
// Default '='
// <>, >, >=, <, <=
// STARTS_WITH, CONTAINS
// IN, NOT IN (does not work)
// BETWEEN :: propertyCondtion('created', array($start, $end), 'BETWEEN')

->range(0,10)
// Random order. hook_query_TAG_alter
->addTag('random')

/* If you run EFQ in Drupal Cron, by default the user is anonymous
   You should run EFQ as a user
*/
->addMetaData('account', user_load(1))
->execute();

/* array(
 'node' => // follow the entity_type: e.g. node, taxonomy_term, user 
 array(
  28912 => obj(nid => 28912) // could be uid, nid, tid
  ...
 )
)
*/

// or $_r['user']
if (!empty($_r['node'])) {
  $nodes = node_load_multiple(array_keys($_r['node']));
  // If you just want to load a handful of fields, you don't have to load the whole nodes
  // $stories = $_r['node'];
  // Get all fields of the entity type first
  // $fields = field_info_instances('node', 'story'); // node type is story
  // Get the field id
  // $field_id = $fields['field_story_image']['field_id'];
  // Attach the field to the entities loaded by EFQ
  // field_attach_load('node', $stories, FIELD_LOAD_CURRRENT,
  //  array('field_id' => $field_id));
  // All the values of field_story_image of all nodes
  // $output = field_get_items('node', $stories, 'field_story_image');
}
#+END_EXAMPLE

*** Update a field of an entity only
<<<d7:field_attach_update>>> Recommend d7:entity_metadata_wrapper
node_save could invoke other hooks and hence cause errors in saving a field value
#+BEGIN_EXAMPLE
$node = node_load($nid);
$node->field_fieldname[LANGUAGE_NONE][0]['value'] = 'some value';
node_save($node);
#+END_EXAMPLE

Use field_attach_update() instead
#+BEGIN_EXAMPLE
$node = node_load($nid);
$node->field_fieldname[LANGUAGE_NONE][0]['value'] = 'some value';

unset($node->field_unwanted_1); // remove unwanted fields
field_attach_update('node', $node);
#+END_EXAMPLE

Without node_load
#+BEGIN_EXAMPLE
$node = new stdClass();
$node->id = $id_value; // node id
$node->type = $content_type; // aka content type

$node->field_fieldname[LANGUAGE_NONE][0]['value'] = 'some value';
field_attach_update('node', $node);
#+END_EXAMPLE

May be better to call field_attach_presave which node_save does
#+BEGIN_EXAMPLE
field_attach_presave('node', $node); // call hook_field_attach_presave
field_attach_update('node', $node);
#+END_EXAMPLE

*** entity_metadata_wrapper <<<d7:entity_metadata_wrapper>>>

Get a field value of an entity (node). Add a wrapper first `$_wrapper=entity_metadata_wrapper('node',$node);`.
$node can be a node/entity object or the node/entity id. Entity API module is needed.
Then list all fields using `$_wrapper->getPropertyInfo();`
Then get a specific field `$_wrapper->field_name->value();` or `->raw();`
// Unified way of getting $node->title, $user->name, ...
$wrapper->label(); or $wrapper->title->value();
// Unified way of getting $node->nid, $user->uid, ...
$wrapper->getIdentifier();
// Unified way of getting $node->type, ...
$wrapper->getBundle();

// Text field
$old_value = $wrapper->field_my_text->value();
if (isset($old_value)) {
  // non-null, could be empty or 0
}
$wrapper->field_my_text = 'new value';

// Longtext
$wrapper->body->value(); // Array of: value, safe_value, format, and optionally summary + safe_summary.
$wrapper->body->value->value(); // Filtered value.
$wrapper->body->value->raw(); // Unfiltered value.
$wrapper->body->format->value(); // The selected text format.
$wrapper->body->value = 'new value';

// Link
$wrapper->field_my_link->value(); // Array of: url, title, attributes.
$wrapper->field_my_link->url->value(); // Hyperlink destination.
$wrapper->field_my_link->title->value(); // Hyperlink text.
$wrapper->field_my_link->attributes->value(); // Array of: target, title, etc.
$wrapper->field_my_link->url = 'http://mediacurrent.com';
$wrapper->field_my_link->title = 'Do Drupal Right';

// Radio and Checkbox
$v = $wrapper->field_my_radio->value(); // on = 1, off = 0
$info = field_info_field('field_my_radio'); // on = New, off = Used
$allowed_values = $info['settings']['allowed_values'];
$label = $allowed_values[$v]; // on = New, off = Used

// Delete a value, unset a field, taxonomy in selectlist is different
$wrapper->field_foobar = NULL;

// Save
$wrapper->save();

// Select list of taxonomy or entity reference, General Usage
Append index
`$term = $_wrapper->field_taxonomy_a[0]->value();`
If only one value is allowed, it doesn't have index.
Loop
foreach ($_wrapper->field_list_of_values as $item) {
//  do something
}

// Taxonomy in select list
For taxonomy term field which can be multiple values, you still need to specify the index
`$term = $_wrapper->field_taxonomy_a[0]->value();` // this might be wrong..

Multiple Tax Terms
#+BEGIN_EXAMPLE
$a = $wrapper->$field->value();
if (isset($a)) {
  echo $a[0]->name;
  echo $a[0]->tid;
}
#+END_EXAMPLE

Single Tax Term
#+BEGIN_EXAMPLE
$a = $wrapper->$field->value();
if (isset($a)) {
  echo $a->name;
  echo $a->tid;
}
#+END_EXAMPLE

Multiple Files
#+BEGIN_EXAMPLE
$a = $wrapper->$field->value();
if (isset($a)) {
  $r=$a;
  foreach ($r as $k => $v) {
    $r[$k]['url'] = file_create_url($r[$k]['uri']);
    // convert URI to public URL
    // Drupal doesn't provide public 'url'
  }
  echo $r[0]['uri'];
  echo $r[1]['uri'];
}
#+END_EXAMPLE

Term id of the first value of a multiple value field
`$tid = $_wrapper->field_taxonomy_a[0]->raw();`
For taxonomy term field which can only have one value:
Term ID: `$_wrapper->field_tax_1->raw();`
Check empty `if (isset($tid))`

Term name: `$_wrapper->field_tax_1->name->value();`
Or in a multi value list `$v = $_wrapper->field_tax_1[0]->value(); echo $v->name;`

Add a term or entity reference: `$_w->field_tax_1[] = 42; $_w->save();`
Set as a whole `$_w->field_tax_1->set(array(42,43)); $_w->save();`

Change a term for a single tax field $_w->field_tax_1->set(42); $_w->save();

A required field can't be unset. Refer to d7:db:delete required field
Unset a term for a single tax field unset($_w->field_tax_1)
Unset a term for a multi tax field 
#+BEGIN_EXAMPLE
foreach($wrapper->field_foobar as $delta => $item)  {
  if ($item->nid->value() == $my_id) {
    unset($wrapper->field_foobar[$delta]);
    $wrapper->save();
    break;
  }
}
#+END_EXAMPLE

Set empty value for tax term field
#+BEGIN_EXAMPLE
$wrapper->field_example_multiple->set();
$wrapper->field_example_multiple = array();
$wrapper->field_example_multiple = NULL;
#+END_EXAMPLE

Loop
#+BEGIN_EXAMPLE
foreach ($_wrapper->field_industry as $taxonomy_wrapper) {
  $industry = $taxonomy_wrapper->tid->value();
}
#+END_EXAMPLE

A list of text
#+BEGIN_EXAMPLE
// All values in a list text as an array
$wrapper->field_list_text->value();

foreach ($wrapper->field_taxonomy_terms->getIterator() as $delta => $term_wrapper) {
  // $term_wrapper may now be accessed as a taxonomy term wrapper.
  $label = $term_wrapper->name->value();
  // list text, delta is 0, 1
  // List text value $term_wrapper->value();
}
#+END_EXAMPLE

If the list of text field only allows one value, then the value is
~$w->field_list_text->value();~ The same as getting a text field

// Entity reference in select list
Single value. Tid is $tid = $wrapper->field_list_entity->raw();
Check empty `if (isset($tid)) { echo $wrapper->field_list_entity->value()->title}`
Multiple values.

https://www.drupal.org/documentation/entity-metadata-wrappers
http://www.mediacurrent.com/blog/entity-metadata-wrapper

** Entityform
D7 uses entityform module. D8 is called EForm.
Load an entityform
#+BEGIN_EXAMPLE
// Load the module file. Optional
// module_load_include('inc', 'entityform', 'entityform-admin');
$_contact_form = entityform_empty_load('entityform_id');
$mode = 'submit'; 
// Default. Other: 'edit'
$form_context = 'page'; 
// Default. Ohter: 'embedded'
$_renderable_form = entityform_form_wrapper($_contact_form, $mode, $form_context );
#+END_EXAMPLE

Try to prefill entityform in hook_form_FORM_ID_alter(). Say the entityform is named dealer_contact
The hook is lili_form_dealer_contact_entityform_edit_form_alter

Use modal in CTools, you will need t:
- [[https://www.drupal.org/project/entityform][Entityform]]
- [[https://www.drupal.org/project/modal][Modal operations]]
- [[https://www.drupal.org/project/modal_forms][Modal forms (with ctools)]]
- Enable the Modal entityforms module
- Create a link (e.g. in View)
#+BEGIN_EXAMPLE
<a href="/modal/entityform/YOUR_FORM_IDENTIFIER/nojs/0" 
   class="ctools-use-modal ctools-modal-modal-popup-small">Open Entity Form in Popup!</a>
#+END_EXAMPLE

** User
*** Get user fields
global $user

~$account = user_load($user->uid)~ to load all fields

or use d7:entity_metadata_wrapper to get a couple fields

$user_wrapper = entity_metadata_wrapper('user', $user);
drupal_set_message('<pre>'.var_export($user_wrapper->field_node->raw(),1).'</pre>'); // Raw value
drupal_set_message('<pre>'.var_export($user_wrapper->field_node->value(),1).'</pre>'); 

*** user_access
<<<d7:user_access>>>
user_access($string, $account = NULL)
$account
- NULL. current logged in user

*** user_is_logged_in, user_has_role
user_is_logged_in && user_has_role(3) :: check if current user is admin

anonymous :: 1
authenticated user :: 2
administrator :: 3

** Menu
*** hook_menu: 'page callback'
You can print or echo some rendered HTML and then drupal_exit() or exit().
drupal_exit() prevents hoo_exit() from running.
Or print and echo some HTML and return NULL;
No header or footer will be added. The page is pure what you output here.

Or you can return a renderable array. Header and footer will be included.
- return $form. You may theme the form by $form['#theme'][] = 'custom_theme_name'; and return $form
- return theme('custom_theme_name', ['vars'=>...]);

In page callback function, you can manipulate some variables used in html.tpl.php and page.tpl.php
Such as change the page title drupal_set_title
Refer to d7:functions

*** hook_menu: 'file'
You can local the page callback function in a different file. e.g. 'lili.pages.inc'
The path is the current module path

*** hook_menu: 'type'
- MENU_CALLBACK :: A hidden internal callback. Best for return plain text in API calls.
- MENU_LOCAL_ACTION :: An action specific to the parent, usually rendered as a link
- MENU_LOCAL_TASK :: A task specific to the parent item, usually rendered as a tab.
- MENU_NORMAL_ITEM :: Shown in menu and breadcrumbs
- MENU_SUGGESTED_ITEM :: A normal menu item, hidden until enabled by an administrator

*** hook_menu: 'access callback', 'access arguments'
access callback
- default is 'user_access' d7:user_access
- custom callback must return boolean
- Often used callbacks: 'user_is_logged_in'
- TRUE is for anyone to access

access arguments
- e.g. ['administer nodes']

*** Embed a View Page
#+BEGIN_EXAMPLE
function lili_menu() {
  $items['path-different-from-view/%'] = array(
    'title' => t('page title');
    'page callback' => 'views_embed_view',
    'page arguments' => array('view_id', 'dispaly_id', 1),
    'type' => MENU_CALLBACK,
    'access callback' => TRUE,
  );
  return $items;
}
#+END_EXAMPLE
 
*** Array to CSV
page callback
drupal_add_http_header('Content-Type', 'text/csv; utf-8');
drupal_add_http_header('Content-Disposition', 'attachment;filename=csvfile.csv');

$fp = fopen('php://output', 'w');
fputcsv($fp, [$year. ' Ranking of Top 100 Carriers']);
$_columns = '#,Company,Web Site,Total,Trucks,Tractors,Trailers,O/OS,Employees';
$_columns = explode(',',$_columns);
fputcsv($fp, $_columns);

foreach ($data as $d) {
  $line   = [ ];
  $line[] = $d->this_rank;
  $line[] = $d->company_name;
  $line[] = $d->web_address;
  $line[] = $d->total_vehicles;
  $line[] = $d->trucks;
  $line[] = $d->tractors;
  $line[] = $d->trailers;
  $line[] = $d->owner_operators;
  $line[] = $d->full_time_employees;

  fputcsv( $fp, $line );
}

fclose($fp);
drupal_exit();

*** Json

#+BEGIN_EXAMPLE
function lili_menu() {
  $items['newsletter/archive/%/%'] = array(
    'title' => "",
    'page callback' => '_lili_archive_by_newsletter_json',
    'page arguments' => array(2,3),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );

  return $items;
}

function _lili_archive_by_newsletter_json($pub_id,$newsletter_name, $page = 1, $items = 20) {
  drupal_add_http_header('Access-Control-Allow-Origin','*'); // CORS		
  $_result['total'] = '...';
  $_result['items'] = array('...');

  drupal_json_output($_result);
  //return 'hello';
}
#+END_EXAMPLE

** Taxonomy
*** Get taxonomy terms of a node, ready for display with language
#+BEGIN_EXAMPLE
$categories = field_get_items('node', $node, 'field_category');
array(
0 => array(
  'tid' => 17,
  'taxonomy_term' => obj
),
...
)
#+END_EXAMPLE

*** Get multiple terms
#+BEGIN_EXAMPLE
$tids = array(1,2,3); // Default:array()
$conditions = array(); // Default
taxonomy_term_load_multiple($tids, $conditions);
array(
17 => obj(
  tid => '17',
  ...
)
...
)
#+END_EXAMPLE

*** Get term by name
#+BEGIN_EXAMPLE
$_limit_to_vocab = 'vocab_name'; // Default NULL.
$term_is_parent = taxonomy_get_term_by_name('video', $_limit_to_vocab);
#+END_EXAMPLE

*** Get all children of a term
Get a term that is parent
#+BEGIN_EXAMPLE
$_limit_to_vocab = 'vocab_name'; // Default NULL.
$term_is_parent = taxonomy_get_term_by_name('video', $_limit_to_vocab);

// Get the first item in array
$term_is_parent = reset($term_is_parent);

echo $term_is_parent->tid; // parent term id

// Get all children of a term
$children = taxonomy_get_children($term-tid);
$children_tids = array_keys($children);
#+END_EXAMPLE

*** Get a vocabulary by name and all terms
#+BEGIN_EXAMPLE
$_vocab = taxonomy_vocabulary_machine_name_load('vocab_name');

// Get all terms of a vocabulary without extra fields
$_terms = taxonomy_get_tree($_vocab->vid);

// Get term ids only of all terms under a vocabulary
$_q = new EntityFieldQuery();
$_term_ids = $_q 
->entityCondition('entity_type', 'taxonomy_term')
->propertyCondition('vid', $_vocab->vid)
->execute();
foreach ($_term_ids['taxonomy_term'] as $term) {
  $term->id;
}

// Get all fields of all terms under a vocabulary
$_terms_with_all_fields = entity_load('taxonomy_term', FALSE, array('vid' => $_vocab->vid));
/* array(
17 => obj(
 tid => '17',
 ...
),
...
)
*/

// Or

$parent = 0; // Default
$max_depth = NULL; // Default
$load_entities = TRUE; // Default:False
$_terms_with_all_fields = taxonomy_get_tree($_vocab->vid, $parent, $max_depth, $load_entities);
array(
0 => obj(
  tid => '17',
  ...
)
...
)
#+END_EXAMPLE

*** Get terms of a vocabulary ready for form
d7:form:taxonomy field

** Cache
*** Setting
Configuration > Peformance (/admin/config/development/performance)
Always check `Cache pages for anonymous users`
Check `Cache blocks` for logged-in users.
Set 0 for `Minimum Cache Lifetime` (cache_lifetime)
`cache_set()` with no $expire time will have cache_lifetime. Set $expire in cache_set to overide.
When cache_lifetime is reached in Redis, cache key and value will be removed from Redis.
Start with 15 mins and go up as you need for `Expiration of cached pages`
Bandwidth Optimization: 
- `Compress cached pages` if your server (Pantheon) already delivers content in gzip, then don't check it
-  Always check `Aggregate and compress CSS files` and `Aggregate JavaScript files`

*** Same page request
#+BEGIN_EXAMPLE
function lili_cache($field, $set = NULL) {
  $custom_cache = &drupal_static(__FUNCTION__);
  if (!isset($custom_cache)) {
    $custom_cache = array();
  }
  if ($set !== NULL && $field !== NULL ) {
    // $set_field_value = lili_cache('field_name', 123);
    $custom_cache[$field] = $set;
  } 
  elseif ($field !==  NULL && $set == NULL &&
      ( !isset($custom_cache[$field]) || $custom_cache[$field] == NULL ) 
     ) {
    // Set default
    // $set_field_value = lili_cache('field_name');
    switch ($field) {
      case "field_name":
        // complicated
        $custom_cache[$field] = '';
        break;
      case "truck_makes_array":
        $_terms = lili_cache('truck_makes_obj');
        $a = [];
        foreach ($_terms as $k => $v) {
          $a[$v->name] = (tid) $v->tid;
        }
        $custom_cache[$field] = $a;
        break;
      case "truck_makes_obj":
        $vocab = taxonomy_vocabulary_machine_name_load('truck_makes');
        $terms = taxonomy_get_tree($vocab->vid);
        $custom_cache[$field] = (!empty($terms)) ? $terms : [];
        break;
    } 
  }
 
  if (!isset($custom_cache[$field])) {
    $custom_cache[$field] = NULL;
  }

  return $custom_cache[$field];
}

// Set
lili_cache('current_node',$node);
// Get lili_cache('current_node');
#+END_EXAMPLE

*** Cache variables in cache table, and clear them
#+BEGIN_EXAMPLE
function my_module_function() {
  $my_data = &drupal_static( __FUNCTION__ );
  if ( ! isset( $my_data ) ) {
    if ( $cache = cache_get( 'my_module_data' ) ) {
      $my_data = $cache->data;
    } else {
      // Do your expensive calculations here, and populate $my_data
      // with the correct stuff..
      cache_set( 'my_module_data', $my_data, 'cache' );
      // Set cache with an expiry time
      // cache_set('my_module_data', $my_data, 'cache', time() + 360);
    }
  }
  return $my_data;
}
#+END_EXAMPLE

Clear one variable cache ~cache_clear_all('my_module_data', 'cache');~
Clear all variables start with `my_module`: ~cache_clear_all('my_module', 'cache', TRUE);~

*** Cache block <<<d7:cache block>>>
If there're modules setup node_grants, variable block_cache in Performance will be FALSE and disabled. 
You will see table cache_block is empty. In Pantheon, cache is in Redis
Here's how to Enable caching for specific blocks only.
In settings.php
#+BEGIN_EXAMPLE
$conf['block_cache_bypass_node_grants'] = "TRUE";
$conf['block_cache'] = "TRUE";
#+END_EXAMPLE

Set all blocks to DRUPAL_NO_CACHE (_block_get_cache_id($block))
Set the blocks to cache to have any one of
- DRUPAL_CACHE_GLOBAL
- DRUPAL_CACHE_PER_PAGE
- DRUPAL_CACHE_PER_ROLE
- DRUPAL_CACHE_PER_USER
- DRUPAL_CACHE_CUSTOM (in this case you need to setup own caching in hook_block_view or hook_block_view_MODULE_DELTA)
But not DRUPAL_NO_CACHE

** File
Read local or remote file to an object of strings
#+BEGIN_EXAMPLE
$result = drupal_http_request($url);
/*
obj(
 code // int 200
 headers
)
*/

$path = 'public://afolder/';
$replace = FILE_EXISTS_RENAME; // Default
// FILE_EXISTS_REPLACE, FILE_EXISTS_ERROR
file_unmanaged_save_data($result->data, $path, $replace);
#+END_EXAMPLE

<<<file_unmanaged_save_data>>>($data, $destination, $replace)
#+BEGIN_EXAMPLE
// $destination is folder path not folder path + filename
$temp_name = 'temporary://auniquefilename'
file_put_contents($temp_name,$data); // return number of bytes or false
file_unmanaged_move($temp_name,$destination, $replace); // rename
#+END_EXAMPLE

<<<Drupal download file with real file extension>>>
#+BEGIN_EXAMPLE
/**
 * Download external file to temporary filesystem
 * with correct file extension based on content-type in http response header
 *
 * @param $url string Full external URL of a file
 *
 * @return string Local file path with correct file extension
 */
function _lili_save_file_with_extension( $url ) {
  $filename  = $url;
  $extension = '';
  $result    = drupal_http_request( $url );

  if ( $result->code == 200 && isset( $result->headers['content-type'] ) ) {
    $mime_type_extension = array(
      'image/jpeg'  => 'jpg',
      'image/jpg'   => 'jpg',
      'image/png'   => 'png',
      'image/x-png' => 'png',
      'image/gif'   => 'gif'
    );

    foreach ( $mime_type_extension as $k => $v ) {
      if ( strcasecmp( $k, $result->headers['content-type'] ) == 0 ) {
        $extension = $v;
        break;
      }
    }

    if ( $extension !== '' ) {
      // Save file with correct file extension
      $filename = 'temporary://import_' . str_replace( ".", "_", microtime( TRUE ) ) . "." . $extension;
      file_put_contents( $filename, $result->data );
    }
  }

  return $filename;
}
#+END_EXAMPLE

** Image Handling (Core)
*** Setting
Define Image Styles ~/admin/config/media/image-style~
Use it in image field display or in code.
Image toolkit ~/admin/config/media/image-toolkit~ reduces the JPEG quality if Image Styles is applied.

Both Image Styles and Image toolkit don't modify the original images but instead create new images in real time.

*** Code
An image is a file. Get a image field:
#+BEGIN_EXAMPLE
$w = entity_metadata_wrapper('node', $node);
$images = $w->field_images->value();
if (isset($images)) {
  // If the image field is set to only hold one image, then
  // $images is ['uri'=>'...']
  foreach ($r as $k => $v) {
    $r[$k]['url'] = file_create_url($v['uri']);
    // convert internal URI to public URL. Drupal doens't provide public url by default.
    // This step doesn't create a file, just create a link
    // Get the image style public url
    $r[$k]['thumbnail'] = image_style_url('thumbnail', $v['uri']);
    // It creates an image styled link in db, when requesting the public url, the image will be created
  }
}
#+END_EXAMPLE

*** Get File URI from db d7:db:file uri
** Basic Ajax
#+BEGIN_EXAMPLE
// Create a menu to receive ajax
$items['newsletter/builder_entry/%'] = array(
    'title' => "",
    'page callback' => '_lili_add_session_handler',
    'page arguments' => array(2),
    'access callback' => 'user_access',
    'access arguments' => array('newsletter builder access'),
    'type' => MENU_CALLBACK,
);

function _lili_add_session_handler($command) {
if (!isset($_POST['ids'])) {
    return drupal_not_found();
  }

  if ($command === "manage") {
    // Add to the session variable detailing what items are added
    $_SESSION['session_name'] = array();

    $ids = json_decode($_POST['ids']);
    foreach ($ids as $id) {
      $id = trim($id);
      $_SESSION['session_name']["item_" . $id] = $id;
    }
  }
  else {
    return drupal_not_found();
  }
}

// Javascript
$.ajax({
 type: "POST",
 url: '?q=newsletter/builder_entry/manage',
 data: "ids=" + 'some string',
 success: function(e) {
   // do something
 },
 dataType: "json"
});
#+END_EXAMPLE

** Javascript API
[[https://www.drupal.org/docs/7/api/javascript-api/javascript-api-overview][Javascript API Overview]]

{
 'settings': {},
 'behaviors': {},
 'themes': {},
 'locale': {}
}

*** Settings
Pass PHP variable to javascript

PHP. Use camelCasing.
#+BEGIN_EXAMPLE
$my_settings = array(
  'basePath' => $base_path,
  'animationEffect' => variable_get('effect', 'none')
);
drupal_add_js(array('myModule'=>$my_settings), 'setting');
#+END_EXAMPLE

Javascript
#+BEGIN_EXAMPLE
var basePath = Drupal.settings.myModule.basePath;
var effect = Drupal.settings.myModule.animationEffect;
#+END_EXAMPLE

*** Behaviors
https://www.lullabot.com/articles/understanding-javascript-behaviors-in-drupal
https://www.amazeelabs.com/en/blog/drupal-behaviors-quick-how
https://www.drupal.org/node/756722

Any property defined in Drupal.behaviors will get called when DOM is ready or when Drupal.attachBehaviors() runs.
Drupal.attachBehaviors(); means attach all behaviors. When DOM is ready, Drupal runs:

#+BEGIN_EXAMPLE
// Attach all behaviors.
$(function () {
  Drupal.attachBehaviors(document, Drupal.settings);
});

// Syntax: Drupal.attachBehanviors(context, settings);
// When context is not defined, it's the document object in javascript
// when settings is not defined, Drupal.settings is used
// So Drupal.attachBehaviors(); is the same as Drupal.attachBehaviors(document, Drupal.settings);
#+END_EXAMPLE

Other modules might run multiple Drupal.attachBehaviors(); or Drupal.attachBehaviors(custom_context, custom_settings);

All properties defined in Drupal.behaviors will get called when Drupa.attachBehaviors(..., ...); runs! Some common situations:

- After an admin overlay has been loaded into the page.
- After AJAX Form API has submitted a form
- When an AJAX request returns a command that modifies HTML, such as ajax_command_replace()
- CTools calls it after a modal has been loaded
- Media calls it after media browser has been loaded
- Panels calls it after in-place editing has been completed
- Views calls it after loading a new page that uses AJAX
- Views Load More calls it after loading the next chunk of items
- Javascript from custom modules may call Drupal.attahcBehaviors() when they add or change parts of the page.
  - Such as drupal_add_js('jQuery(document).ready(function () { Drupal.attachBehaviors(); });', 'inline'); 

So you need to attach any event once using $('',context).once() !

This is mymod_path/js/drupal.behaviors.js
#+BEGIN_EXAMPLE
(function ($) {
  Drupal.behaviors.MODULENAME = {
    attach: function (context, settings) {
      console.log('This runs every time Drupal.attachBehaviors(); is called');
      // Run something only once (e.g. set jQuery event)
      $('.nav-flyout', context).once('remove-modals', function () {
        // After this is run, all elements selected will have a new class 'remove-modals-processed'
        $(document).keyup(function (e) {
          if (e.keyCode == 27) {
            $('.nav-flyout', context).removeClass('js-flyout-active');
          }
        });
      });
    }
  }
}(jQuery));
#+END_EXAMPLE

In Drupal
#+BEGIN_EXAMPLE
function hook_preprocess_page(&$vars) {
  // Append a property in Drupal.settings only. And before a behavior is attached and it will be run e.g. when DOM is ready
  drupal_add_js(array('MODULENAME' => array('php_var_1' => variable_get('php_var_1', ''))), 'setting');
  drupal_add_js(drupal_get_path('module', 'MODULENAME') . '/js/drupal.behaviors.js');
}
#+END_EXAMPLE

** Email
Define an email template using hook_mail()
#+BEGIN_EXAMPLE
function lili_mail($key, &$message, $params) {
 // Need to overwrite headers content type if email is html
 $message['headers']['Content-Type'] = 'text/html; charset=UTF-8; format=flowed';

 // $message['from'] is initially set by $from from drupal_mail(). 
 // If not provided, will use sidewide setting
 // $message['to'] and 'language' are set by $to from drupal_mail().

 switch ($key) {
  case 'template_1':
    // Use $params
    $message['subject'] = 'This is subject';
    $message['body'][] = 'Extra';
    $message['headers']['Bcc'] = 'bcc@abc.com';
    break;
 } 
}

// Send email
$module = 'lili'; // module name that the template is defined hook_mail
$to = 'to@abc.com';
$from = 'from@abc.com'; // Default Null
$language = language_default();
$send = TRUE; // Default TRUE 
$params = array(); // Extra params to pass to hook_mail() as $params
// hook_mail_alter can change to false so that it doesn't get sent out
$result = drupal_mail($module, 'template_1', $to, $language, $params, $from, $send);
/*
$result => array(
 'result' => NULL (cancelled by hook_mail_alter())
            or $system->mail($message) (!$result['result'] is true means fail)
)
*/
#+END_EXAMPLE

** OOP
D7 refers to [[https://www.drupal.org/project/oop_examples][oop_examples module]].

One quick way to include a class is to put the class inside any file e.g. $moddir/lib/reader.inc
And include when it's needed using module_load_include('inc', 'modename', 'lib/reader');

* Wordpress
** Migrate database
At your previous host, access phpMyAdmin.
Load your WordPress database by clicking the database name in the left hand menu pane.
Click the "export" tab at the top right.
Under "export, highlight all the tables and select "SQL". These are the default settings.
Under "options" make sure that "add DROP TABLE/ VIEW/ PROCEDURE/ FUNCTION" is selected.
Ensure that "Save as File" towards the bottom of the page is selected.
Click Go

For import, just hit Import tab and import. Watch out for the timeout limit.

Change website url
Open wp_options table, change siteurl to http://yourwebsite.com

Do it on code level
#+BEGIN_EXAMPLE
define('WP_HOME','http://'.$_SERVER[HTTP_HOST].'/');
define('WP_SITEURL','http://'.$_SERVER[HTTP_HOST].'/');
#+END_EXAMPLE

Go to wp-admin > Settings > Permalink and save to update the permalink

** Redirect a path a Wordpress website
<<<wp:redirect path to wp>>>
abc.com/enterprise to another Wordpress website abc.com
DB is abc_enterprise and abc

abc.com is inside a docker container using apache2

abc.com uses Nginx and initial setup is
#+BEGIN_EXAMPLE
server {
   listen 80;
   server_name abc.com www.abc.com;

   location / {
      proxy_set_header   X-Real-IP   $remote_addr;
      proxy_set_header   Host        $http_host;
      proxy_pass         http://127.0.0.1:9977;
   }

}
#+END_EXAMPLE

*** Method 1: Apache
Directly create or copy a sub directory under abc.com root
/var/www/html/enterprise

Create a new database called abc_enterprise and import the db
/var/www/html/enterprise/wp-config.php

If the enterprise site is a complete new wp installation, you don't need to do this
#+BEGIN_EXAMPLE
define( 'WP_HOME', '/enterprise' );
define( 'WP_SITEURL', '/enterprise' );

// Change the db setting
define('DB_NAME', 'abc_enterprise');
#+END_EXAMPLE

/var/www/html/enterprise/.htaccess
#+BEGIN_EXAMPLE
# BEGIN WordPress
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /enterprise/
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /enterprise/index.php [L]
</IfModule>

# END WordPress
#+END_EXAMPLE

Then go to wp-admin and save the permalink

abc.com/enterprise/abc has $_SERVER['REQUEST_URI'] appear as ~/abc~ on /var/www/html/enterprise/index.php

- Redirect abc.com/xyz to abc.com/enterprise/ijk use /var/www/html/.htaccess
#+BEGIN_EXAMPLE
RedirectMatch 302 ^/psup/?$ /enterprise/ijk/
#+END_EXAMPLE

- Rewrite abc.com/ijk to abc.com/enterprise/real-page so that URL remains abc.com/ijk in address bar
use /var/www/html/.htaccess
#+BEGIN_EXAMPLE
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
RewriteRule ^ijk/?(.*)$ /enterprise/ijk [L]
</IfModule>
#+END_EXAMPLE

Then in /var/www/html/enterprise/wp-content/themes/your-theme/functions.php

NOTE: $_SERVER['REQUEST_URI'] is /ijk in ./enterprise/index.php
#+BEGIN_EXAMPLE
function cs_rewrite_request($query){

  $request_uri = urldecode($_SERVER['REQUEST_URI']);
  //var_dump($request_uri);
  /* for pages */
  if( 0 === strpos($request_uri, '/ijk') ){
    $query['pagename'] = urlencode('real-page');
    unset($query['name']);
  }

  return $query;
}
add_filter( 'request', 'cs_rewrite_request', 9999, 1 );
#+END_EXAMPLE

If you want abc.com/enterprise/real-page to redirect to abc.com/ijk which shows the real-page
/var/www/html/.htaccess
#+BEGIN_EXAMPLE
RedirectMatch 302 ^/enterprise/real-page/?$ /ijk/
#+END_EXAMPLE

Fix image urls
#+BEGIN_EXAMPLE
UPDATE wp_posts SET post_content=(REPLACE (post_content, '<old url>','<new url>'));
UPDATE wp_posts SET post_content=(REPLACE (post_content, 'abc-ent-dev.com','abc.com/enterprise'));
#+END_EXAMPLE

*** Method 2: (Not working..) Nginx proxy to another

Refer to nginx:redirect path to proxy

abc.com Nginx becomes
#+BEGIN_EXAMPLE

server {
   listen 80;
   server_name alectraconservation.com www.alectraconservation.com;

   location ^~ /enterprise/ {
     proxy_set_header   X-Real-IP   $remote_addr;
     proxy_set_header   Host        $http_host;
     proxy_pass http://127.0.0.1:8787/;
   }

    location / {
      proxy_set_header   X-Real-IP   $remote_addr;
      proxy_set_header   Host        $http_host;
      proxy_pass         http://127.0.0.1:9977;
   }

}
#+END_EXAMPLE

Refer to http://www.ur-ban.com/2015/07/27/nginx-proxy_pass-wordpress-in-a-sub-directory/
Change WP_HOME and WP_SITEURL
#+BEGIN_EXAMPLE
$_SERVER['REQUEST_URI'] = str_replace("/wp-admin/", "/enterprise/wp-admin/",  $_SERVER['REQUEST_URI']);
define( 'WP_SITEURL', '/enterprise' );
define( 'WP_HOME', '/enterprise' );
#+END_EXAMPLE

** Email
Add this after ~require_once(ABSPATH . 'wp-settings.php');~ in wp-config.php
This way you don't need to have linux:sendmail installed on Linux

[[https://codex.wordpress.org/Plugin_API/Action_Reference/phpmailer_init][Doc]]

#+BEGIN_EXAMPLE
// configure phpmailer
add_action( 'phpmailer_init', 'mail_relay' );
function mail_relay( $phpmailer ) {
    $phpmailer->isSMTP();
    $phpmailer->Host = 'smtp.gmail.com';
    $phpmailer->SMTPAutoTLS = true;
    $phpmailer->SMTPAuth = true; 
    $phpmailer->Port = 465;
    $phpmailer->Username = '<admin email>';
    $phpmailer->Password = '<app password>';

    // Additional settings
    $phpmailer->SMTPSecure = "ssl"; 
    $phpmailer->From = "<admin email>";
    $phpmailer->FromName = "<your name>";
}
// configure phpmailer.
#+END_EXAMPLE

Without bootstrap wp, assuming test.php file is at root
#+BEGIN_EXAMPLE
<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);

echo 'hello';

// PHPMailer Gmail Example
// https://github.com/PHPMailer/PHPMailer/blob/master/examples/gmail.phps

$recipient_email = 'a@b.com';
$recipient_name = 'First Last';
$sender_name = 'Sender Name';
$subject = 'Testing';
$html = ('
    <html>
    <head>
      <title>This is a test</title>
    </head>
    <body>
      <h1>Testing headline</h1> 
      <p>Testing body content</p>
    </body>
    </html>
  ');
$text = 'pure text testing';

// php's native mail
// mail($recipient_email, $subject, $text);

require("wp-includes/class-phpmailer.php");
$mail = new PHPMailer();

$mail->isSMTP(); // Set mailer to use SMTP
//Enable SMTP debugging
// 0 = off (for production use)
// 1 = client messages
// 2 = client and server messages
$mail->SMTPDebug = 2;

$mail->Host = 'smtp.gmail.com';
// use
// $mail->Host = gethostbyname('smtp.gmail.com');
// if your network does not support SMTP over IPv6

$mail->SMTPAuth = true; // set to false if Username, Password, SMTPSecure are empty
$mail->Username = 'username@gmail.com';
$mail->Password = 'password';
$mail->SMTPSecure = 'tls'; // Enable TLS encryption, `ssl` also accepted

$mail->Port = 587; // 587 for tls

$mail->CharSet = 'UTF-8';

$mail->SetFrom('donotreply@b.com', $sender_name);

$mail->AddAddress($recipient_email, $recipient_name);

$mail->Subject = $subject;

//$mail->addReplyTo('replyto@example.com', 'First Last');

//Replace the plain text body with one created manually
// $mail->AltBody = 'This is a plain-text message body';

//Attach an image file
//$mail->addAttachment('images/phpmailer_mini.png');

$mail->MsgHTML($html);

if (!$mail->Send()) {
  echo "Mailer Error: " . $mail->ErrorInfo;
}
else {
  echo "successful!";
}
#+END_EXAMPLE

** PHP redirect
<<<wp:php:redirect>>>
https://rudrastyh.com/wordpress/change-specific-urls.html
Use functions.php to achieve

Redirect, same can be achieved using .htaccess
#+BEGIN_EXAMPLE
function rudr_url_redirects() {
	/* in this array: old URLs=>new URLs  */
	$redirect_rules = array(
		array('old'=>'/category/uncategorized/','new'=>'/category/Uncategorized/'), // category
		array('old'=>'/contacts/','new'=>'/Contacts/'), // page
		array('old'=>'/hello-world/','new'=>'/hello-planet/'), // post
		array('old'=>'/tag/wordpress/','new'=>'/tag/WordPress/') // post tag
	);
	foreach( $redirect_rules as $rule ) :
		// if URL of request matches with the one from the array, then redirect
		if( urldecode($_SERVER['REQUEST_URI']) == $rule['old'] ) :
			wp_redirect( site_url( $rule['new'] ), 301 );
			exit();
		endif;
	endforeach;
}
 
add_action('template_redirect', 'rudr_url_redirects');
#+END_EXAMPLE

Redirect by changing request based on the $_SERVER['REQUEST_URI']
#+BEGIN_EXAMPLE
function rudr_rewrite_request($query){
 
	$request_uri = urldecode($_SERVER['REQUEST_URI']);
 
	/* for categories */
	if ( $request_uri == '/category/Uncategorized/' )
		$query['category_name'] = 'uncategorized';
 
	/* for pages */
	if ( $request_uri == '/Contacts/' ){
		$query['pagename'] = urlencode('contacts');
		unset($query['name']);
	}
 
	/* for posts */
	if ( $request_uri == '/hello-planet/' )
		$query['name'] = 'hello-world';
 
	/* for tags */
	if( $request_uri == '/tag/WordPress/' )
		$query['tag'] = 'wordpress';
 
	return $query;
}
 
add_filter( 'request', 'rudr_rewrite_request', 9999, 1 );
#+END_EXAMPLE

Change permalink
For posts and pages
#+BEGIN_EXAMPLE
function rudr_post_permalink( $url, $post ){
	if( !is_object( $post ) )
		$post = get_post( $post_id );
 
	$replace = $post->post_name;
 
	/* We should use a post ID to make a replacement. It is required if you use urf-8 characters in your URLs */
 
	if( $post->ID == 1 ) 
		$replace = 'hello-planet';
	if( $post->ID == 12 ) 
		$replace = 'Contacts';
 
	$url = str_replace($post->post_name, $replace, $url );
	return $url;
}
 
add_filter( 'post_link', 'rudr_post_permalink', 'edit_files', 2 );
add_filter( 'page_link', 'rudr_post_permalink', 'edit_files', 2 );
add_filter( 'post_type_link', 'rudr_post_permalink', 'edit_files', 2 );
#+END_EXAMPLE

For categories and tags
#+BEGIN_EXAMPLE
function rudr_term_permalink( $url, $term, $taxonomy ){
	$replace = $term->slug;
 
	/* by ID as well */
	if( $term->term_id == 5 ) 
		$replace = 'Uncategorized';
	if( $term->term_id == 55 ) 
		$replace = 'WordPress';
 
	$url = str_replace($term->slug, $replace, $url );
 
	return $url;
}
 
add_filter( 'term_link', 'rudr_term_permalink', 10, 3 );
#+END_EXAMPLE

** CLI
[[https://wp-cli.org/commands][Wordpress CLI Commands]]
WP CLI Pantheon

*** WP CLI Install, Upgrade

#+BEGIN_EXAMPLE
# Assuming you are at ~ folder
curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
# Check phar
php wp-cli.phar --info
chmod +x wp-cli.phar
# GoDaddy Shared Hosting doesn't allow sudo. Ignore this for GoDaddy
# sudo mv wp-cli.phar /usr/local/bin/wp
alias wp='~/wp-cli.phar'
echo "alias wp='~/wp-cli.phar'" >> .bashrc
source .bashrc
#+END_EXAMPLE

Set Global parameters in wp-cli.yml under Wordpress root folder http://wp-cli.org/config/
Use -- in front for wp command
#+BEGIN_EXAMPLE
# Very important. To avoid error: $_SERVER['HTTP_HOST'] 
url: http://www.yourwebsite.com
#+END_EXAMPLE

Use --skip-plugins to avoid errors while loading plugins that cause this kind of error
Fatal error: Uncaught Error: Call to a member function xxx on null

Check wp-cli installation
~wp --info~, ~wp plugin list --debug~ or ~wp plugin list --skip-plugins --debug~

If you see this error, time to upgrade WP CLI
Fatal error: Class 'WP_Post_Type' not found in /Applications/MAMP/htdocs/wp-includes/post.php on line 1031

~sudo wp cli update~

*** Global Parameters
- --debug
- --quiet
- --user=<id|login|email>
- --require=<path> :: Load PHP file, can be used multiple times

*** User
#+BEGIN_EXAMPLE
List users
terminus wp 'user list' --site=<site> --env=<env>=

Add a user
wp user create lili li@xxx.ca --user_pass=letterandnumbers --role=administrator

Update password
wp user update lili --user_pass=lettersandnumbers

Give role
wp user add-role lili administrator
#+END_EXAMPLE

*** Core
wp core version
wp core update

*** Plugin
[[https://wordpress.org/plugins][Wordpress Official Plugin Directory]]

wp plugin install fly-dynamic-image-resizer

Options
- --activate :: activate after installation

wp plugin status
wp plugin update akismet
wp plugin activate plugin_name
wp plugin uninstall Plugin_name

*** Theme
wp theme status

** Conditional Tags
<<<wp:conditional tags>>>
[[https://codex.wordpress.org/Conditional_Tags][These]] are related the wp:query:main only.

** Template Tags
<<<wp:template tags>>>
wp-includes/xxx-template.php
*** post-thumbnail <<<wp:t:thumbnail>>>
get_post_thumbnail_id($post = null);

the_post_thumbnail_* :: has to be current post, calls get_the_post_thumbnail_*
get_the_post_thumbnail_* :: can specify which post, calls wp_get_attachment_image_src

You can wp:f:add_image_size
Image size :: $size
NOTICE: If the thumbnail has no physical file that has corresponding size, the_post_thumbnail_url will 
get the original image file, the_post_thumbnail will use the original file with in src and apply width/height attributes
in HTML to achieve the purpose.
- 'post-thumbnail' :: default
- array(100, 100) :: Grab the biggest size in width and height image file possible.
- array(100, 9999) :: Grab the biggest size in width and height image file possible.

You can resize an image file on the fly using fly-dynamic-image-resizer

the_post_thumbnail($size, $attr='') :: echo html
the_post_thumbnail_url($size) :: echo url
the_post_thumbnail_caption($post = null) :: echo thumbnail caption

wp_get_attachment_image_src( $attachment_id, $size = 'thumbnail', $icon = false ) is just like the_post_thumbnail but returns an array [url, width, height, is_intermediate]. url is $thumb[0]

*** post <<<wp:t:post>>>
*** category <<<wp:t:category>>>
*** general <<<wp:t:general>>>
** Functions
*** get_bloginfo, Site tagline, Sitetitle
retrieves info about the current site

https://developer.wordpress.org/reference/functions/get_bloginfo/

*** get_the_ID() - ID of current item or false
*** wp_get_post_terms($post_id, $tax, $args)
Get the slugs of the terms under taxonomy publication
=wp_get_post_terms($post_id, 'publication', ['field' => 'slugs'])=
*** wp_editor
<<<wp:f:wp_editor>>>
Render an editor for field in a page in the typical fashion used in Posts and Pages.
[[https://codex.wordpress.org/Function_Reference/wp_editor][Doc]]

May be used in wp:action:edit_page_form wp:action:edit_form_advanced
Use wp:f:update_post_meta in wp:action:save_post for storing the new field

*** Translate
Use tool:Poedit

**** Translate Functions
$text can't be a variable. And use single quotes instead of "".

Use sprintf() and printf for subsitutions. The msgid is "You have chosen the %s theme"
#+BEGIN_EXAMPLE
echo sprintf( __( 'You have chosen the %s theme.' ) , the_color() );
printf( __( 'You have chosen the %s theme.' ) , the_color() );
#+END_EXAMPLE

echo __('some text', 'textdomain'); // return
'textdomain' is optional but it has to be a string not a variable! Default it's 'default'

_e() is the same as __() but echoes

Plural or single
echo _n('There is a comment', 'There are comments', get_comments_number());

Context
echo _x('post a link', 'A link to the post');
'A link to the post' matches msgctxt "A link to the post" in .po file.

_ex is the same as _x but echoes
echo _ex('post link', 'Submit a link');

**** Setup, .po and .mo files
Load textdomain in child theme which overwrites the textdomain defined in parent theme
Do this in theme functions.php
#+BEGIN_EXAMPLE
function smart_mag_child_theme_locale() {
  $_r = load_child_theme_textdomain( 'textdomain-name', get_stylesheet_directory() . '/languages' );
  // textdomain-name can be defined in parent theme or a new textdomain
  // if textdomain-name has been defined earlier, then this will overwrite

  // Check if textdomain inclusion is successful
  //if ( $_r ) var_dump( 'success!' );

  if ( is_admin() ) {
    // load another textdomain
  }
}
add_action( 'after_setup_theme', 'smart_mag_child_theme_locale' );
#+END_EXAMPLE

Usually translate-ready theme will provide a .pot file which is a template file for .po and .mo files.
Open .pot in tool:Poedit, generate a new translation. What Poedit saves is 2 files: .po and .mo.

Open .po file later, make changes and save to overwrite .po and .mo files. File .pot is no longer needed.

Catalog > Properties > Translation properties
Specifiy the language
Plural Forms by default is
#+BEGIN_EXAMPLE
nplurals=2; plural=n != 1;
#+END_EXAMPLE

Might need to specify the path in code for .po file. '.' means the current path.
#+BEGIN_EXAMPLE
"X-Poedit-SearchPath-0: .\n"
#+END_EXAMPLE

Catalog > Properties > Sources keywords contain all the Wordpress translation functions

#+BEGIN_EXAMPLE
__
_e
_n:1,2
_x:1,2c
_ex:1,2c
#+END_EXAMPLE

=:1,2= indicates the function has 2 parts. =2c= means the 2nd argument is a context/comment.

tool:Poedit can help you change most of the fields except that it can't specify context msgctxt.

For those situations, directly edit .po and open .po in Poedit and save to get the .mo file.

Some examples

Comments and reference
#+BEGIN_EXAMPLE
This is a reference
#: woocommerce/loop/orderby.php:23
This is a comment
#. Author of the plugin/theme
#+END_EXAMPLE

Concatenate multiple lines
#+BEGIN_EXAMPLE
#: 404.php:18
msgid ""
"We're sorry, but we can't find the page you were looking for. It's probably "
"some thing we've done wrong but now we know about it and we'll try to fix "
"it. In the meantime, try one of these options:"
msgstr ""
#+END_EXAMPLE

sprintf and printf subsitutions
#+BEGIN_EXAMPLE
#: archive.php:101
msgid "Yearly Archives: %s"
msgstr ""
#+END_EXAMPLE

Context
#+BEGIN_EXAMPLE
#: bbpress/auth-modal.php:69
msgctxt "bbPress"
msgid "Favorites"
msgstr ""
#+END_EXAMPLE

Complex context
#+BEGIN_EXAMPLE
#: comments.php:53
msgid ""
"Logged in as <a href=\"%1$s\">%2$s</a>. <a href=\"%3$s\" title=\"Log out of "
"this account\">Log out?</a>"
msgstr ""
#+END_EXAMPLE

Poedit save fr_CA.po and fr_CA.mo files. Copy and place them into the right place and then on Wordpress
Settings > General > Site Lanuage to match fr_CA

*** add_image_size
<<<wp:f:add_image_size>>>
Use wp:action:after_setup_theme
Every newly uploaded image will have image files with all defined image sizes.

#+BEGIN_EXAMPLE
function lili_theme_setup() {
 add_image_size('lili-w700', 700, 9999); // fixed width, unlimited height
 add_image_size('lili-w700h600', 700, 600, true); // crop in exact dimension 
}
#+END_EXAMPLE

*** add_management_page
wp:action:admin_menu
Add sub menu to Tools admin menu

add_management_page(
 'Page title', // string
 'Menu title', // string
 'manage_options', // string. Capability that is required.
 'menu_slug', // string
 'callbackFunct', // string or array($this, 'options_page')
);

*** add_post_type_support
<<<wp:f:add_post_type_support>>>

add_post_type_support($post_type, $supports);

- $post_type :: string
- $supports :: string/array
  - title
  - editor :: content
  - author
  - thumbnail :: current theme must support Post Thumbnails
  - excerpt
  - trackbacks
  - custom-fields :: wp:Custom_Fields. Don't have to add 'custom-fields' in order to use wp:plugin:acf
  - comments
  - revisions
  - page-attributes :: menu order, hierarchical must be true
  - post-formats :: add post formats

add_action('init', 'lili_custom_post_type');
function lili_custom_post_type() {
  $labels = [
    // array, wp:register_post_type:labels
  ];

  $args = [
    'label' => 'Plural Name', // string
    'labels' => $labels,
    'description' => '', // string, optional
    'public' => false,
    /* Default. bool.
     *       exclude_from_search, publicly_queryable, show_in_nav_menus, show_ui
     * true:               false,               true,              true, true
     * false:               true,              false,             false, false
     */
    'exclude_from_search' => false, // default. optional. 'site/?s=search-term'
    'publicly_queryable' => true, // optional. take 'public' value.
    /* ?post_type={post_type_key},
     * ?{post_type_key}={single_post_slug},
     * ?{post_type_query_var}={single_post_slug}
     */
    'show_ui' => true, // optional. bool. default take 'public' value.
    'show_in_nav_menus' => true, // optional. bool. inherits 'public' value.
    'show_in_menu' => true, // optional, bool or string. default inherits show_ui
    // false :: do not display in admin menu
    // true :: display as a top level menu
    // 'some string' :: display as a submenu of a menu 'some string'
    'show_in_admin_bar' => true, // optional, bool, default inherits show_in_menu
    'supports' => ['title', 'editor'], // optional. array/bool. wp:f:add_post_type_support

  ];

  register_post_type('movies', $args);

}

Use wp:action:pre_get_posts to enable query for this new post type

*** add_rewrite_rule, add_rewrite_tag
<<<wp:f:add_rewrite_rule>>> <<<wp:f:add_rewrite_tag>>>
wp:action:init

Need to flush Settings -> Permalinks and just click Save Changes without any changes to add into db:wp_options:rewrite_rules
#+BEGIN_EXAMPLE
// add_rewrite_rule($regex, $redirect, $after = 'bottom');
function custom_rewrite_basic() {
  add_rewrite_rule('^leaf/([0-9]+)/?', 'index.php?page_id=$matches[1]', 'top');
}
add_action('init', 'custom_rewrite_basic');
#+END_EXAMPLE

$after :: This can either be 'top' or 'bottom'. 'top' will take precedence over WordPress's existing rules, where 'bottom' will check all other rules match first.

$matches[] to retrieve the values of a matched URL, capture group data starts at 1, not 0.

#+BEGIN_EXAMPLE
function custom_rewrite_tag() {
  add_rewrite_tag('%food%', '([^&]+)');
  add_rewrite_tag('%variety%', '([^&]+)');
}
add_action('init', 'custom_rewrite_tag', 10, 0);

function custom_rewrite_rule() {
  add_rewrite_rule('^nutrition/([^/]*)/([^/]*)/?','index.php?page_id=12&food=$matches[1]&variety=$matches[2]','top');
}
add_action('init', 'custom_rewrite_rule', 10, 0);
#+END_EXAMPLE

Create a page called Nutrition with page id 12 and use a custom template my-custom-template.php:
#+BEGIN_EXAMPLE
/**
 * Template Name: Nutritional Information
 */
get_header(); 

global $wp_query;
echo 'Food : ' . $wp_query->query_vars['food'];
echo '<br />';
echo 'Variety : ' . $wp_query->query_vars['variety'];
// ... more ...
get_footer();
#+END_EXAMPLE

*** remove_meta_box
<<<wp:f:remove_meta_box>>>

remove_meta_box( $id, $page, $context);
- Return 
- $id :: string
  - authordiv
  - categorydiv
  - comemntstatusdiv
  - commentsdiv
  - formatdiv
  - pageparentdiv
  - postcustom
  - postexcerpt
  - postimagediv
  - revisionsdiv
  - slugdiv
  - submitdiv
  - tagsdiv-post_tag
  - tagsdiv-{$tax-name}
  - {$tax-name}div
  - trackbacksdiv
  - ...
- $page :: string. Type of screen
  - post
  - page
  - attachment
  - link
  - dashboard
  - any custom post type e.g. 'my-product'
- $context :: string. 'normal', 'advanced', or 'side'
  - Post edit screen :: normal, side and advanced
  - Comments screen :: normal and side
  - Menu meta boxes :: side
- Return nothing

*** get_template_part
wp:f:get_template_part

*** get_the_excerpt, the_excerpt
the_excerpt() echoes current post and it calls get_the_excerpt($post=null)
If no excerpt is set in UI, it pulls the first 55 words. If it's set, it displays the whole manually set text.

*** wp_remote_get, wp_remote_post, wp_remote_head, wp_remote_request
#+BEGIN_EXAMPLE
$response = wp_remote_get( 'http://www.example.com/index.html' );
// url has to include protocal e.g. http://
if ( is_array( $response ) ) {
  $header = $response['headers']; // array of http header lines
  $body = $response['body']; // use the content
}

wp_remote_get( 'http://www.example.com/index.php?action=foo', array( 'timeout' => 120, 'httpversion' => '1.1' ) );
#+END_EXAMPLE

Methods to work with $response
- wp_remote_retrieve_body() - Retrieves just the body from the response.
- wp_remote_retrieve_header() - Gives you a single HTTP header based on name from the response.
- wp_remote_retrieve_headers() - Returns all of the HTTP headers in an array for processing.
- wp_remote_retrieve_response_code() - Gives you the number for the HTTP response. This should be 200, but could be 4xx or even 3xx on failure.
- wp_remote_retrieve_response_message() - Returns the response message based on the response code.

Default options
#+BEGIN_EXAMPLE
global $wp_version;
$args = array(
    'timeout'     => 5, // seconds
    'redirection' => 5, // how many times
    'httpversion' => '1.0',
    'user-agent'  => 'WordPress/' . $wp_version . '; ' . home_url(),
    'blocking'    => true, // php will stop until the request is processed. false to just ping but wp_remote_get will return false
    'headers'     => array(),
    'cookies'     => array(),
    'body'        => null,
    'compress'    => false,
    'decompress'  => true,
    'sslverify'   => true,
    'stream'      => false,
    'filename'    => null
); 
#+END_EXAMPLE

*** wp_localize_script
This must be called after the script has been registered using wp_register_script() or wp_enqueue_script()
#+BEGIN_EXAMPLE
wp_register_script('unique_handle', 'path/to/myscript.js' );

$translation_array = array(
  'some_string' => 'hello';
  'a_value' => '10'
);

// Pass vars in $translation_array to file path/to/myscript.js
wp_localize_script( 'unique_handle', 'object_name', $translation_array );

wp_enqueue_script( 'unique_handle' );

<script>
  console.log( object_name.some_string);
</script>
#+END_EXAMPLE

If you just want to define pass PHP variables and don't want to create empty js files
#+BEGIN_EXAMPLE
wp_localize_script( 'jquery', 'mynamesapce', array('ajaxurl' => admin_url( 'admin-ajax.php' ) ) );
#+END_EXAMPLE

*** register_post_type
<<<wp:f:register_post_type>>>
wp:action:init wp:action:pre_get_posts wp:plugin:acf

register_post_type( $post_type, $args );
https://codex.wordpress.org/Function_Reference/register_post_type

- $post_type :: string. < 20 characters. All lowercase and no space
- $args :: array of arguments

#+BEGIN_EXAMPLE
add_action('init', 'lili_custom_post_type');
function lili_custom_post_type() {
  $labels = [
    // array, wp:register_post_type:labels
  ];

  $args = [
    'label' => 'Plural Name', // string
    'labels' => $labels,
    'description' => '', // string, optional
    'public' => false,
    /* Default. bool.
     *       exclude_from_search, publicly_queryable, show_in_nav_menus, show_ui
     * true:               false,               true,              true, true
     * false:               true,              false,             false, false
     */
    'exclude_from_search' => false, // default. optional. 'site/?s=search-term'
    'publicly_queryable' => true, // optional. take 'public' value.
    /* ?post_type={post_type_key},
     * ?{post_type_key}={single_post_slug},
     * ?{post_type_query_var}={single_post_slug}
     */
    'show_ui' => true, // optional. bool. default take 'public' value.
    'show_in_nav_menus' => true, // optional. bool. inherits 'public' value.
    'show_in_menu' => true, // optional, bool or string. default inherits show_ui
    // false :: do not display in admin menu
    // true :: display as a top level menu
    // 'some string' :: display as a submenu of a menu 'some string'
    'show_in_admin_bar' => true, // optional, bool, default inherits show_in_menu
    'supports' => ['title', 'editor'], // optional. array/bool. wp:f:add_post_type_support
	  //  Don't have to add 'custom-fields' in order to use wp:plugin:acf

  ];

  register_post_type('movies', $args);

}

add_action( 'pre_get_posts', 'lili_pre_get_posts' );
// Should not call this in template because in template the $query is already run
function lili_pre_get_posts( $query ) {
  if ( ! is_page() && ! is_home() && $query->is_main_query() ) {
    $query->set( 'post_type', array( 'post', 'movies' ) );
  }
  // this function should return nothing.
}
#+END_EXAMPLE

**** labels
<<<wp:register_post_type:labels>>>

*** register_nav_menus
<<<wp:f:register_nav_menus>>> used in wp:action:init
[[https://codex.wordpress.org/Function_Reference/register_nav_menus][Register custom nav menus]]
#+BEGIN_EXAMPLE
function register_my_menus() {
  register_nav_menus(
    array(
      'main-menu' => __('Main Menu'),
      'about-menu' => __('About Menu'),
      'services-menu' => __('Services Menu')
    )
  );
}
#+END_EXAMPLE

*** wpautop
<<<wp:f:wpautop>>> used in wp:filter:the_content wp:filter:the_excerpt
Change double line-breaks in text into <p>...</p>

*** shortcode_unautop
<<<wp:f:shortcode_unautop>>> used in wp:filter:the_content
Ensure shortcodes are not wrapped in <p>...</p>

*** wp_reset_postdata
<<<wp:f:wp_reset_postdata>>>
After ~global $post~ is modified by wp:query:secondary, reset it to the original that was set by wp:query:main

#+BEGIN_EXAMPLE
<?php
// example args
$args = array( 'posts_per_page' => 3 );

// the query
$the_query = new WP_Query( $args );
?>

<?php if ( $the_query->have_posts() ) : ?>

	<!-- start of the loop -->
	<?php while ( $the_query->have_posts() ) : $the_query->the_post(); ?>
		<?php the_title(); ?>
		<?php the_excerpt(); ?>
	<?php endwhile; ?><!-- end of the loop -->

	<!-- put pagination functions here -->
	<?php wp_reset_postdata(); ?>

<?php else:  ?>

<p><?php _e( 'Sorry, no posts matched your criteria.' ); ?></p>

<?php endif; ?>
#+END_EXAMPLE

*** wp_reset_query
<<<wp:f:wp_reset_query>>>
Restore the $wp_query and global post data to the original main query.
Should be called after query_posts().

Avoid to use it. To alter main query parameters before it's made, use wp:filter:pre_get_posts

#+BEGIN_EXAMPLE
<?php

$args = array ( 'post_parent' => 5 );
query_posts( $args );

if ( have_posts() ):
    while ( have_posts() ) :
        the_post();

        // Do stuff with the post content.
        the_title();
        the_permalink(); // Etc.

    endwhile;
else:
    // Insert any content or load a template for no posts found.
endif;

wp_reset_query();

?>
#+END_EXAMPLE

*** update_post_meta
<<<wp:f:update_post_meta>>>

** Current URL, and slug
Current URL on your website
<<<php:parse_url>>>
#+BEGIN_EXAMPLE
global $wp;
$current_url = home_url(add_query_arg(array(), $wp->request)); 
// echo esc_url($current_url);

$url = 'http://username:password@hostname:9090/path?arg=value#anchor';
$_url_array = parse_url($url); 
// keys are scheme, host, port, user, pass, path, query (after ?), fragment (after #)

if ($_url_array !== false && !is_null($_url_array['host']) {}
#+END_EXAMPLE

Slug
#+BEGIN_EXAMPLE
$_post = get_post();
if (!empty($_post) && $_post->post_name == 'your-slug') {
  // do something
}
#+END_EXAMPLE

Site url
#+BEGIN_EXAMPLE
// http://google.com without trailing slash
get_site_url();
#+END_EXAMPLE

** WP Custom Fields
<<<wp:Custom_Fields>>>
*** Get Custom Fields
Normal
#+BEGIN_EXAMPLE
print_r(get_post_custom_keys()); // Get all keys as an array
print_r(get_post_custom()); // Get keys and values as an array
print_r(get_post_custom_values('fieldkey')); // Get values as an array

// get all meta
$meta = get_post_meta(get_the_ID());
global $post;
echo get_post_meta($post->ID, 'my-ad', true);
#+END_EXAMPLE

Plugin is different :: wp:plugin:types

*** Custom Fields in WP_Meta_Query
Custom fields created by wp:plugin:acf can use WP_Meta_Query as normal.

Custome fields creasted by wp:plugin:types, like a set of checkboxes, in WP_Query, you should use the LIKE operator. 
Refer to WP Types Custom Field Checkbox and WP Meta Query

*** Create Custom Fields for Custom Post Type
Use wp:plugin:acf

** WP_Query The Loop <<<wp:The_Loop>>>
<<<wp:query:main>>>

The main query/loop is based on the URL request and is processed before templates are loaded
Only the wp:conditional tags use the main query/loop

<<<wp:query:secondary>>>

The secondary query/loop is ~new WP_Query~ in theme template or plugin files. It's also caled The Loop.
wp:template tags use the secondary query/loop.

By default, The Loop uses the main query's current post to set global $post.

~new WP_Query()~ and ~the_post~ (called in ~have_posts()~) modify The Loop and hence global $post is modified. 

When these functions are used, you need to run wp:f:wp_reset_postdata to reset global $post to the original.

Notice :: ~new WP_Query()~ doesn't change wp:query:main

*** Syntax

#+BEGIN_EXAMPLE
<?php 
 $query = new WP_Query('cat=-3,-8'); 
 // Use query_posts($query_array | $string) instead of creating a new WP_Query then you don't have to prefix $query for methods
 // But query_posts change the global $wp_query 
?>

<?php if ( $query->have_posts() ) : while ( $query->have_posts() ) : $query->the_post(); ?>
 <?php //  set the global $post to individual one in $query ?>
 <div><?php the_content(); ?></div>

 <?php if ( has_post_thumbnail() ): ?>
  <img src="<?php the_post_thumbnail_url('large'); ?>">
  <?php the_post_thumbnail(); ?>
 <?php endif; ?>

<?php endwhile; ?>
<?php wp_reset_postdata(); // set back global $post to original ?>
<?php endif; ?>

<?php $query->rewind_posts(); // in order to loop $query again ?>

#+END_EXAMPLE

*** <<<WP_Query>>>
Generator: https://generatewp.com/wp_query/

Use: WP_Meta_Query, WP Tax Query, WP Order and Orderby
Use filters: 
- wp:filter:post_limits
- pre_option_posts_per_rss wp:filter:pre_option
- wp:filter:posts_clauses
Use actions: wp:action:pre_get_posts

#+BEGIN_EXAMPLE
$args = array(
 'post_type' => array('editorial', 'blog'), // blog or editorial
 'post_status' => array('publish'),
 'posts_per_page' => -1, // int. -1 shows all posts. Doesn't work in feed (Default 10). Use wp:filter:post_limits
 'meta_query' => $meta_query, // $meta_query is a nested array parsed by WP_Meta_Query
 'tax_query' => $tax_query,
 'order' => 'DESC', // default, 'ASC'
 'orderby' => 'date', // default, which is post_date
);

$query = new WP_Query($args);
#+END_EXAMPLE

*** <<<WP_Meta_Query>>>
**** Fields for WP_Query
Use these fields directly in WP_Query

**** Nesting
Nested: key1=value1 OR (key2=value2 AND key3=value3)

#+BEGIN_EXAMPLE
$meta_args = array(
 'relation' => 'OR', // Optional.
 array(
   'key' => 'key1',
   'value' => 'value1',
   'compare' => '=', //default
 ),

 array(
   'relation' => 'AND',
   array(
     'key' => 'key2',
     'value' => 'value2',
     'compare' => '=',
   ),
   array(
     'key' => 'key3',
     'value' => 'value3',
     'compare' => '=',
   ),
 ),
  
);

$meta_query = new WP_Meta_Query($meta_args); // parse args array

#+END_EXAMPLE

**** Operators
compare
- =, !=
- >, >=, <, <=
- LIKE, NOT LIKE
- IN, NOT IN
- BETWEEN, NOT BETWEEN
- EXISTS, NOT EXISTS
- REGEXP, NOT REGEXP :: MySQL REGEX
- RLIKE (synonym of REGEXP) 

type 
In MySQL, it means CAST(the field, to a type)
- NUMERIC
- BINARY
- CHAR
- DATE :: works with 'compare' value BETWEEN only if the date is stored as YYYY-MM-DD
- DATETIME
- DECIMAL
- SIGNED, UNSIGNED :: MySQL Integer
- TIME :: MySQL Date and Time

<<<WP Types Custom Field Checkbox and WP Meta Query>>>
Say the wpcf-newsletters custom field created by WP Types has 2 checkboxes are selected: enligne and pw.
The following 2 strings will appear in the serialized json string as value in WP_Meta_Query
#+BEGIN_EXAMPLE
a:1:{i:0;s:7:"enligne";}
a:1:{i:0;s:2:"pw";}
#+END_EXAMPLE 

Select the posts that have checkbox enligne checked.
#+BEGIN_EXAMPLE
$meta_query = array(
 array(
  'key' => 'wpcf-newsletters',
  'value' => 'a:1:{i:0;s:7:"enligne";}',
  'compare' => 'LIKE',
 ),
);
#+END_EXAMPLE

*** <<<WP Tax Query>>>
#+BEGIN_EXAMPLE
$tax_query = array(
 'relation' => 'AND', // Optional 
 array(),
 array(
   'taxonomy' => '',
   'field' => 'term_id', // string :: term_id (default), name, slug or term_taxonomy_id
   'terms' => 'bob', // int/string/array :: multiple terms
   'operator' => 'IN', // string :: IN (default), NOT IN, AND, EXISTS, NOT EXISTS
 ),
);
#+END_EXAMPLE

*** <<<WP Order and Orderby>>>
2 parameters: order and orderby. They are strings not arrays.

**** orde
- DESC :: default
- ASC

**** orderby
- date :: default, which is post_date
- modified :: modified date
- ID :: post id
- parent :: parent id
- rand :: random order
- comment_count
- author
- title
- name :: post name post slug
- type :: post type
List goes on...

** RSS

<<<wp:f:get_template_part>>> includes any template in child theme

#+BEGIN_EXAMPLE
function lili_RSS() {
 add_feed('lili-editorial', 'lili_editorial_RSS');
}
add_action('init', 'lili_editorial_RSS');
function lili_editorial_RSS() {
 get_template_part('rss','feedname');
 // rss is slug and feedname is an extra name
 // Search in order
 // /themes/child/rss-feedname.php
 // /themes/parent/rss-feedname.php
 // /themes/child/rss.php
 // /themes/parent/rss.php

 // the feed url is http://you.com/feed/lili-editorial which is the feed name defined in add_feed
}
#+END_EXAMPLE

Default template /wp-includes/feed-rss2.php
Functions to use in The Loop: /wp-includes/feed.php

#+BEGIN_EXAMPLE
<?php
$args = array(
	'post_type' => array('blog'), // e.g. any
	'tag' => 'editors-choice',
	'orderby' => 'date', // Default. e.g. title
	'order' => 'DESC', // Default. e.g. ASC
);
?>
query_posts($args);
<?php while (have_posts()) : the_post(); ?>
<item>
  <title><?php the_title_rss(); ?></title>
  <?php if (has_post_thumbnail($post->ID)) : ?>
  <?php
    $image = wp_get_attachment_image_src(
    get_post_thumbnail_id( $post->ID ),
    'thumbnail'
    );
  ?>
  <feature_image><?php echo $image[0]; ?></feature_image>
  <?php endif; ?>
  <pubDate><?php echo mysql2date('D, d M Y H:i:s +0000',
				get_post_time('Y-m-d H:i:s', true),
				false); ?></pubDate>
  <?php // Text Version ?>
  <excerpt><![CDATA[<<?php echo get_the_exerpt(); ?>]]></excerpt>
  <excerpt_html><![CDATA[<<?php echo the_exerpt_rss(); ?>]]></excerpt_html>
  <?php echo the_category_rss('rss2'); // categories and tags ?>
</item>  
<?php endwhile; ?>
#+END_EXAMPLE

** Default filters and actions 
<<<wp:default filters>>> wp-includes/default-filters.php

** add_filter
*** Syntax, remove_filter
Modify internal data / function returned

For example, WP_Query gets internal settings for building a query.
You can temporary add_filter to change the internal settings, then build a WP_Query, later remove_filter 
so that you only change the internal setting for that query building without affecting other usage.  

add_filter( 
 'tagname', 
 'lili_funct',
  10, // int. Priority, lower number sooner
  2, // int. Accepted args, default is 1! Be careful
)

apply_filters( 'tagname', $result, $var1);

// callback should take 2 variables
function lili_funct($result, $var1) {
 return $result;
}

remove_filter(
  'tagname',
  'lili_funct',
  10 // priority, must match the add_filter priority, default is 10
)

#+BEGIN_EXAMPLE
function remove_filter_the_title() {
	remove_filter('the_title', 'before_post_title', 10);
}
add_action( 'wp_head', 'remove_filter_the_title', 1 );

function add_filter_the_title() {
	add_filter('the_title', 'before_post_title', 10, 2);
}
add_action( 'wp_head', 'add_filter_the_title', 3 );
#+END_EXAMPLE

*** post_limits
<<<wp:filter:post_limits>>>
For feed, use pre_option_posts_per_rss wp:filter:pre_option

function lili_f_post_limits($limit, $query) {
 return 'LIMIT 0, 25';
 return $limit;
}

*** posts_clauses
<<<wp:filter:posts_clauses>>>
Modify WP_Query object before it runs
#+BEGIN_EXAMPLE
function lili_posts_clauses($clauses, $query) {
  /*
  $clauses => [
    'where' => '...',
    'groupby' => '',
    'join' => '',
    'orderby' => 'wp_posts.post_date DESC',
    'distinct' => '',
    'fields' => 'wp_posts.*',
    'limits' => 'LIMIT 0, 20',
  ]
  $query is WP_Query object
  */
  // Identify a certain WP_Query
  $_s = lili_request_cache('trigger_posts_clauses');
  if ($_s == 'situationA') {
    $_old = $clauses['where'];
    $clauses['orderby'] = '';
    $_limit = explode(",",$clauses['limits']);
    $clauses['limits']='';
    $_limit_feature = end($_limit) - 3;
    reset($_limit);
    $_features_and_news = <<<SQL
SELECT * FROM
(SELECT p2.ID
FROM wp_posts p2
WHERE p2.post_type IN ('en-vedette')
ORDER BY p2.post_date DESC
LIMIT {$_limit_feature}
) AS sq1

UNION

SELECT * FROM
(SELECT p2.ID
FROM wp_posts p2
INNER JOIN wp_term_relationships tr ON tr.object_id = p2.ID
INNER JOIN wp_terms t ON t.term_id = tr.term_taxonomy_id
WHERE p2.post_type = 'nouvelles' AND t.slug = 'homepage-3-squares'
ORDER BY p2.post_date DESC
LIMIT 3) AS sq2
SQL;
    $clauses['where'] = $_old." AND wp_posts.ID IN ($_features_and_news)";
    // reset cache
    lili_request_cache('trigger_posts_clauses', '');
  }

  return $clauses;
}
#+END_EXAMPLE

*** page_link
<<<wp:filter:page_link>>> => get_permalink

#+BEGIN_EXAMPLE
// When set to true, a structural link will be returned, rather than the actual URI. Example: http://www.example.com/%postname% 
// instead of http://www.example.com/my-post

function append_query_string( $url, $post, $leavename=false ) {

  if ( $post->post_type == 'post' ) {
    $url = add_query_arg( 'foo', 'bar', $url );
  }
  return $url;
}
add_filter( 'post_link', 'append_query_string', 10, 3 );
#+END_EXAMPLE

*** pre_option_(option_name)
<<<wp:filter:pre_option>>>
Temporarily alter an option without changing in database.

*** template_include
<<<wp:filter:template_include>>>

#+BEGIN_EXAMPLE
function pubx_cuw_template_include($template) {
  global $wp;
  try {
    $_url = explode('/',$wp->request);
    if (!empty($_url) && count($_url) == 3) {
      $adunit=$_url[1];
      $adsize=$_url[2];
      $dfp = array(
        'em_CUW_BB_1' => ['95740733/'.$adunit, '300x250'],
        'em_CUW_BB_2' => ['95740733/'.$adunit, '300x250'],
        'em_CUW_BB_3' => ['95740733/'.$adunit, '300x250'],
        'em_CUW_LB_1' => ['95740733/'.$adunit, $adsize], // 640x90, 300x90
        'em_CUW_LB_2' => ['95740733/'.$adunit, $adsize], // 640x90, 300x90
      );

      if (isset($dfp[$adunit]) && strlen($adsize) < 10) {
        $_ad_unit = $dfp[$adunit][0];
        $_ad_size = $dfp[$adunit][1];
        $htmlFile = <<<HTML
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Canadian Underwriter Partnership</title>
<script src="//code.jquery.com/jquery-1.10.2.js"></script>
</head>
<body>
  <script>
    var rnd=Math.floor(Math.random() * (999999 - 10 +1)) + 10;
    var theUrl="//pubads.g.doubleclick.net/gampad/adx?iu=/{$_ad_unit}&sz={$_ad_size}&c=" + rnd;
    var xmlHttp = null;
    xmlHttp = new XMLHttpRequest();
    xmlHttp.open( "GET", theUrl );
    xmlHttp.send();
    xmlHttp.onreadystatechange = function() {
      if (xmlHttp.readyState==4 && xmlHttp.status==200) {
        var xmlDoc = $.parseHTML( xmlHttp.response );
        var adlink = $(xmlDoc).find('a').attr('href');
        if (typeof adlink == "undefined") adlink = "//www.example.com";
        window.location = adlink;
      }
    }
  </script>
</body>
</html>
HTML;

        global $wp_query;
        $wp_query->is_404 = false;
        status_header(200);
        echo $htmlFile;
        $new_template = locate_template( ['empty_page.php'] );
        return $new_template;
      }
    }
    elseif (other_situation) {
      // you can just flush a buffer or output something 
      // then set some headers
      // and a response code
      // then exit();
    }
  }
  catch (Exception $e) {
    return $template;
  }

  return $template;

}
add_filter('template_include', 'pubx_cuw_template_include',99);
#+END_EXAMPLE

*** flush_rewrite_rules_hard
<<<wp:filter:flush_rewrite_rules_hard>>>
Stop wp to modify .htaccess inside the Wordpress block
#+BEGIN_EXAMPLE
add_filter( 'flush_rewrite_rules_hard', '__return_false' );

// __return_false is a wp function

// remove the filter 
remove_filter( 'flush_rewrite_rules_hard', 'filter_flush_rewrite_rules_hard', 10, 1 ); 
#+END_EXAMPLE

*** tiny_mce_before_init
<<<wp:filter:tiny_mce_before_init>>>
[[https://codex.wordpress.org/Plugin_API/Filter_Reference/tiny_mce_before_init][Change TinyMCE settings]]
https://codex.wordpress.org/TinyMCE Default setting
https://www.tinymce.com/docs/configure/

#+BEGIN_EXAMPLE
add_filter( 'tiny_mce_before_init', 'myformatTinyMCE' );
function myformatTinyMCE( $in ) {
  $in['wordpress_adv_hidden'] = FALSE; // enable advanced edit mode

  //region elements that are not included will be removed. Add all elements.
  $opts = '*[*]';
  $in['valid_elements'] = $opts;
  $in['extended_valid_elements'] = $opts;
  //endregion

  //region To ensure p tag is not removed when switching between Visual and Text modes
  $in['wpautop'] = false;
  $in['indent'] = true;
  //endregion

  //region p tag will not be added for any new line.
  // To create a paragraph in Visual mode, Shift+Enter. Otherwise, enter will simply create a <br>
  // This helps TinyMCE wraps shortcode on any line with p tag.
  $in['force_p_newlines'] = false;
  $in['forced_root_block'] = '';
  //endregion

  return $in;
}
#+END_EXAMPLE

To be safe, add this for Wordpress to remove p tag wrapped around shortcode
#+BEGIN_EXAMPLE
add_filter( 'the_content', 'tgm_io_shortcode_empty_paragraph_fix' );
function tgm_io_shortcode_empty_paragraph_fix( $content ) {
  $array = array(
    '<p>['    => '[',
    ']</p>'   => ']',
    ']<br />' => ']'
  );
  return strtr( $content, $array );
}
#+END_EXAMPLE

*** the_content
<<<wp:filter:the_content>>>
Change the content of the post after retrieved from db and before it's printed to the screen.
[[https://codex.wordpress.org/Plugin_API/Filter_Reference/the_content][Doc]]
#+BEGIN_EXAMPLE
add_filter( 'the_content', 'wpautop');
// remove_filter( 'the_content', 'wpautop');
add_filter( 'the_content', 'shortcode_unautop'  );
#+END_EXAMPLE

*** upload_mimes
<<<wp:filter:upload_mimes>>>
Add mime type so that wp can handle its content-type header to browser for upload and sending.
#+BEGIN_EXAMPLE
function cc_mime_types($mimes) {
  $mimes['svg'] = 'image/svg+xml';
  return $mimes;
}
add_filter('upload_mimes', 'cc_mime_types');
#+END_EXAMPLE

*** widget_text
<<<wp:filter:widget_text>>>
wp:f:add_shortcode

** add_action, do_action, do_action_ref_array
*** Basic
Event based
add_action( string $tag,
  string $function_name,
  int $priority = 10,
  int $accepted_args = 1 // number of args the function accepts
)

add_action( 'atag' is called by do_action( 'atag' or do_action_ref_array( 'atag'

*** wp_head, wp_footer, get_footer
Refer to wp:default filters
wp_head(); and wp_footer(); are usually called in header/footer.php
get_footer action is called at the beginning of the get_footer(); function, which will include footer.php file later.

If a parameter is passed, footer-[$name].php is also included and you can play around $name in the get_footer hook like this
#+BEGIN_EXAMPLE
function themeslug_footer_hook( $name ) {
	if ( 'new' == $name ) { ?>
		<script>
			(function($) {
				//put all your jQuery goodness in here.
			})(jQuery);
		</script>
	<?php
	}
}
add_action( 'get_footer', 'themeslug_footer_hook' );
#+END_EXAMPLE

*** wp_enqueue_scripts
Can use wp_enqueue_style and wp_enqueue_script. Priority might be needed to change to greater 10
to load after default theme/style.css
#+BEGIN_EXAMPLE
function lili_scripts() {
 wp_enqueue_style('lili-custom-styles', get_stylesheet_directory_uri().'/css/style.css');
}
add_action( 'wp_enqueue_scripts', 'lili_scripts', 20);
#+END_EXAMPLE

*** init
<<<wp:action:init>>>
Fires after Wordpress has finished loading but before any headers are sent.
User is already authenticated.
Useful for intercepting $_GET or $_POST

wp:f:register_nav_menus
wp:f:add_rewrite_rule

*** after_setup_theme
<<<wp:action:after_setup_theme>>>
Called each page load after the theme is initialized. 
Do basic setup, registration and init actions for a theme

*** pre_get_posts
<<<wp:action:pre_get_posts>>>
Provide a chance to modify $query object (or do something else) before it's run.
Do not use this to alter query for single Page requests.

add_action( 'pre_get_posts', 'lili_pre_get_posts' );
// Should not call this in template because in template the $query is already run
function lili_pre_get_posts( $query ) {
  if ( ! is_page() && ! is_home() && $query->is_main_query() ) {
    $query->set( 'post_type', array( 'post', 'movies' ) );
  }
  // this function should return nothing.
}

*** admin_menu
<<<wp:action:admin_menu>>>

*** admin_head
<<<wp:action:admin_head>>>

#+BEGIN_EXAMPLE
function my_custom_admin_head() {
  echo '<style>[for="wp_welcome_panel-hide"] {display: none !important;}</style>';
}
add_action( 'admin_head', 'my_custom_admin_head' );

// Add inline JS in the admin head with the <script> tag

function my_custom_admin_head() {
  echo '<script type=""text/javascript">console.log('admin script')</script>';
}
add_action( 'admin_head', 'my_custom_admin_head' );
#+END_EXAMPLE

*** add_meta_boxes, add_meta_boxes_{post_type}
lili_add_meta_boxes($post_type, $post) takes 2 arguments, no return. 
lili_add_meta_boxes_{post_type}($post) takes 1 argument, no return.

Use wp:f:add_meta_box, wp:f:remove_meta_box or modify global $wp_meta_boxes;

$wp_meta_boxes['post-type']['normal']['core']['postexcerpt']['title'] = 'Your title';

You can change the title, callback (complete change to another function) and different context. 
The callback most likely outputs a label, form field and some description.

You can either completely change the callback or use wp:filter:gettext to change the translation

*** edit_page_form
<<<wp:action:edit_page_form>>>
Fires after 'normal' context meta boxes have been output for the 'page' post type.
Control admin Edit Page form.

wp:f:wp_editor

#+BEGIN_EXAMPLE
function volunteer_hours_editor() {
  $content = get_post_meta(get_the_ID(), 'volunteer-hours', true);
  $settings = array('textarea_name' => 'volunteer-hours');
  //wpautop($content);
  wp_editor( $content, 'volunteer-hours', $settings);
}
#+END_EXAMPLE

*** edit_form_advanced
<<<wp:action:edit_form_advanced>>>
Same as wp:action:edit_page_form but for all post types other than 'page'

*** save_post
<<<wp:action:save_post>>>
Called when a post or page is created or updated, which could be from an import, post/page edit form, xmlrpc, or post by email. The data for the post is stored in $_POST, $_GET or the global $post_data, depending on how the post was edited. For example, quick edits use $_POST.

wp:f:update_post_meta

#+BEGIN_EXAMPLE
add_action( 'save_post', 'save_post', 10, 2 );
function save_post( $post_id, $post ) {
  if ( !current_user_can( 'edit_post', $post_id ) )
    return $post_id;
    update_post_meta( $post_id, 'volunteer-hours', stripslashes( wpautop($_POST['volunteer-hours']) ) );
}
#+END_EXAMPLE

** add_shortcode
<<<wp:f:add_shortcode>>>
#+BEGIN_EXAMPLE
// [bartag foo="foo-value"]

// Use underscore instead of hyphen e.g. bar_tag
function bartag_func( $atts, $content, $tag ) {
  $a = shortcode_atts( array(
    'class' => 'something', // default value
    'attr_2' => 'something else', // 2nd attribute
  ), $atts );

  // get current post
  // global $post; $post->ID

  // Use return not echo
  return '<span class="'.esc_attr($a['class']).'">'
         .$content
         // or
         // .do_shortcode($content)
         ."foo = {$a['foo']}"
         .'</span>';

/*
ob_start();
?> <HTML> <here> ... <?php
return ob_get_clean();
*/

}
add_shortcode( 'bartag', 'bartag_func' );

// In order to run shortcode in Widgets, add this
add_filter('widget_text','do_shortcode');
// wp:filter:widget_text
#+END_EXAMPLE

Pass array to shortcode attribute
#+BEGIN_EXAMPLE
$data = [
 [],[],[]
];

var_dump(serialize($data));

// use single quotes
[your-shortcode data='serialized-string']

function your_shortcode_cb() {
  ...
  $data = unserialize($a['data']);
}

#+END_EXAMPLE

** Options, Settings
<<<WP All Options>>>
/wp-admin/options.php

[[https://codex.wordpress.org/Option_Reference][Option Reference]]

noindex, nofollow
Settings > Reading > toggle Search Engine Visibility - Discourage search engines from indexing this site

** Ellipsis and trim, strip HTML and PHP tags
<<<wp:ellipsis>>>
wp_trim_words($text) :: strip HTML and PHP tags and truncate string in words
#+BEGIN_EXAMPLE
function wp_trim_words( $text, $num_words = 55, $more = null ) {
  if ( null === $more ) {
    $more = __( '&hellip;' );
  }

  $original_text = $text;
  $text = wp_strip_all_tags( $text );

  /*
   * translators: If your word count is based on single characters (e.g. East Asian characters),
   * enter 'characters_excluding_spaces' or 'characters_including_spaces'. Otherwise, enter 'words'.
   * Do not translate into your own language.
   */
  if ( strpos( _x( 'words', 'Word count type. Do not translate!' ), 'characters' ) === 0 && preg_match( '/^utf\-?8$/i', get_option( 'blog_charset' ) ) ) {
    $text = trim( preg_replace( "/[\n\r\t ]+/", ' ', $text ), ' ' );
    preg_match_all( '/./u', $text, $words_array );
    $words_array = array_slice( $words_array[0], 0, $num_words + 1 );
    $sep = '';
  } else {
    $words_array = preg_split( "/[\n\r\t ]+/", $text, $num_words + 1, PREG_SPLIT_NO_EMPTY );
    $sep = ' ';
  }

  if ( count( $words_array ) > $num_words ) {
    array_pop( $words_array );
    $text = implode( $sep, $words_array );
    $text = $text . $more;
  } else {
    $text = implode( $sep, $words_array );
  }

  /**
   * Filters the text content after words have been trimmed.
   *
   * @since 3.3.0
   *
   * @param string $text          The trimmed text.
   * @param int    $num_words     The number of words to trim the text to. Default 55.
   * @param string $more          An optional string to append to the end of the trimmed text, e.g. &hellip;.
   * @param string $original_text The text before it was trimmed.
   */
  return apply_filters( 'wp_trim_words', $text, $num_words, $more, $original_text );
}
#+END_EXAMPLE

wp_strip_all_tags($string)
#+BEGIN_EXAMPLE
function wp_strip_all_tags($string, $remove_breaks = false) {
  $string = preg_replace( '@<(script|style)[^>]*?>.*?</\\1>@si', '', $string );
  $string = strip_tags($string);

  if ( $remove_breaks )
    $string = preg_replace('/[\r\n\t ]+/', ' ', $string);

  return trim( $string );
}
#+END_EXAMPLE

** Ajax <<<wp:ajax>>>
*** Ajax on wp admin pages
Javascript global variable ajaxurl is defined on admin pages

functions.php
#+BEGIN_EXAMPLE
add_action( 'admin_enqueue_scripts', 'add_ajax_file');
function add_ajax_file() {
  wp_enqueue_script( 'ajax_custom_script', plugins_url( '/js/my.js' , __FILE___), array('jquery') );
}

add_action( 'wp_ajax_my_action', 'my_action');

function my_action() {
  global $wpdb;
  $data = intval($_POST['data']);
  echo $data;
  // echo json_encde($data);
  wp_die();
} 
#+END_EXAMPLE

my.js
#+BEGIN_EXAMPLE
jQuery(document).ready(function($) {
  var data = {
    'action': 'my_action',
    'data': 'some data'
  }
  $.post(ajaxurl, data, function(r) {
    console.log('response:', r);
  });
})
#+END_EXAMPLE

*** Ajax on wp front end pages
Define global variable mynamespace.ajaxurl
functions.php
#+BEGIN_EXAMPLE
add_action( 'wp_enqueue_scripts', 'add_custom_namespace' );

function add_custom_namespace() {
  wp_localize_script( 'jquery', 'mynamespace', 
   array(
    'ajaxurl' => admin_url('admin-ajax.php'),
    'data' => 'some data'
   ) 
  );
}
#+END_EXAMPLE

my.js
#+BEGIN_EXAMPLE
jQuery(document).ready(function($) {
  var data = {
    'action': 'my_action',
    'data': mynamespace.data
  }
  $.post(mynamespace.ajaxurl, data, function(r) {
    console.log('response:', r);
  });
})
#+END_EXAMPLE

functions.php
#+BEGIN_EXAMPLE
add_action( 'wp_ajax_my_action', 'my_action');
add_action( 'wp_ajax_nopriv_my_action', 'my_action'); // non-logged in users

// same my_action
#+END_EXAMPLE

** Wordpress Theme
*** functions.php
<<<wp:theme:functions>>>
#+BEGIN_EXAMPLE
add_theme_support( 'post-thumbnails' );

// wp:action:init
#+END_EXAMPLE

*** Template Files
[[https://codex.wordpress.org/Theme_Development#Template_Files][All Template Files]]
single.php
single-{post-type}.php
archive.php
archive-{post-type}.php

if single.php and archive.php don't exist, wp looks for index.php

*** Page template
Hierarchy
- Global Custom Page Template :: can be applied to multiple pages. Set in Edit Post > Page Attributes > Template
- page-{slug}.php :: for one specific page. Directly put them in theme folder
- page-{id}.php :: for one specific page. Directly put them in theme folder
- page.php :: refer to conditional tags
- singular.php
- index.php

**** Global Custom Page Template
Put these global template files in theme subfolder page-templates .
File name can be anything but follow page_two-columns.php. Don't use ~page-~ as prefix!
Make a copy of page.php to start

#+BEGIN_EXAMPLE	
<?php
/**
 * Template Name: Full Width Page
 *
 * @package WordPress
 * @subpackage Twenty_Fourteen
 * @since Twenty Fourteen 1.0
 */
#+END_EXAMPLE

*** Header template
header-{name}.php

<?php get_header( $name ); ?>

*** Widgets
**** Create sidebar
#+BEGIN_EXAMPLE
function lili_widgets_init() {
  $args = array(
	'name'          => __( 'Sidebar name', 'theme_text_domain' ),
	'id'            => 'unique-sidebar-id', // %1$s
	'description'   => '',
        'class'         => '', // %2$s, will have ~sidebar-~ prepended
	'before_widget' => '<li id="%1$s" class="widget %2$s">',
	'after_widget'  => '</li>',
	'before_title'  => '<h2 class="widgettitle">',
	'after_title'   => '</h2>' );
  register_sidebar( $args );

  // register_sidebar( $args2 );
  
  // Create multiple sidebars with the same config
  $args = array(
	'name'          => __('Sidebar %d'),
        'id'            => 'sidebar',          
	'description'   => '',
	'class'         => '',
	'before_widget' => '<li id="%1$s" class="widget %2$s">',
	'after_widget'  => '</li>',
	'before_title'  => '<h2 class="widgettitle">',
	'after_title'   => '</h2>' );

  // register_sidebars( 2, $args );

}
add_action('widgets_init', 'lili_widgets_init');
#+END_EXAMPLE

*** Functions used in template
#+BEGIN_EXAMPLE
// In template
<?php wp_head(); ?>

// In plugin
add_action('wp_head', 'lili_wphead_dfp');
function lili_wphead_dfp() {
 // add inline script to header
 $o = "<script>...</script>";
 echo $o;
}

// Load with dependancy (jQuery is loaded)
function lili_wphead_dfp() {
 if ( wp_script_is( 'jquery', 'done' ) ) {
?>
<script type="text/javascript">
// jQuery code 
</script>
<?php
 }
}
#+END_EXAMPLE

*** Good themes
[[https://themeforest.net/item/newspapaer/5489609][Newspaper]]

** Transient API
WordPress cache API in database.
=DELETE FROM wp_options WHERE option_name LIKE ('%\_transient\_%')=

** Custom Cache
Same page request custom cache

#+BEGIN_EXAMPLE
function lili_request_cache($field, $set = NULL) {
  static $custom_cache;
  if (!isset($custom_cache)) {
    $custom_cache = [];
  }
  if ($set !== NULL && $field !== NULL ) {
    // $set_field_value = _f('field_name', 123);
    $custom_cache[$field] = $set;
  }
  elseif ($field !==  NULL && $set == NULL &&
          ( !isset($custom_cache[$field]) || $custom_cache[$field] == NULL )
  ) {
    // Set default
    // $set_field_value = _f('field_name');
    switch ($field) {
      case "trigger_posts_clauses":
        $custom_cache[$field] = '';
        break;
    }
  }

  if (!isset($custom_cache[$field])) {
    $custom_cache[$field] = NULL;
  }

  return $custom_cache[$field];
}
#+END_EXAMPLE

** Custom page
wp:filter:template_include

** Database
[[https://codex.wordpress.org/Database_Description][Database Description]]

*** wp_posts
ID :: int
post_type :: varchar(20), 'post'
post_status :: varchar(20), 'publish'

*** wp_terms, wp_term_relationships
- wp_terms
term_id :: int, auto_increment
name :: varchar(200)
slug :: varchar(200)
term_group :: int

- wp_term_relationships
object_id :: int, (e.g. ID in wp_posts), 0
term_taxonomy_id :: int, 0
term_order :: int, 0

** Plugins
*** Custom Plugin
https://codex.wordpress.org/Plugin_Resources
https://codex.wordpress.org/Writing_a_Plugin
https://developer.wordpress.org/plugins/the-basics/#getting-started

https://github.com/DevinVinson/WordPress-Plugin-Boilerplate

https://github.com/levonlee/gridli-vue

Use hyphen for plugin name and folder `wp_content/plugins/li-custom/li-custom.php`

*** Resize image on the fly
<<<fly-dynamic-image-resizer>>>

$image = fly_get_attachment_image_src(
 get_post_thumbnail_id(),
 array(160, 9999),
 false // true to crop to exact dimension
);

$image :: array(
 'src',
 'width',
 'height'
);

fly_add_image_size('lili-w600', 600, 9999, true);
$image = fly_get_attachment_image($post->id, 'lili-w600'); // HTML
*** Advanced Custom Fields - ACF
<<<wp:plugin:acf>>>
https://wordpress.org/plugins/advanced-custom-fields/

Add a field group and then add custom fields under the group.
Use Location to define rules to assign the field group to a custom post type.
You can hide the default post fields (Content editor, comments, categories, etc.)
Make custom fields required

In wp:The_Loop, to display a custom field :: the_field('field_name')
To get the value :: get_field('field_name'); 
*** types :: Toolset Types
<<<wp:plugin:types>>>

WP Types is different! Use <<<types_render_field>>>

#+BEGIN_EXAMPLE
$newsletters = types_render_field('newsletters', array('output'=>'raw'));
// the real field name is actually wpcf-newsletters
// For single line (text) field, use 'output'=>'raw'
// For WYSIWYG field, use 'output'=>'html'. 'raw' might be plain text
// For Image field

$_image = types_render_field('field-image', array('output'=>'raw'));
// Output original full image url
// If 'output' => 'raw', 'size' and 'resize' will be ignored

// use 'url' => 'true' to output the url of the resized image.
$args = array('output'=>'normal', 'url'=>'true', 'width'=> 300, 'resize'=>'proportional');
// Output image url of a fixed width and dynamic height

$args = array('output'=>'normal', 'url'=>'true', 'size'=>'medium', 'resize'=>'proportional' );
// Output image url of a max width and height
// if 'size' is set, 'width' and 'height' will be ignored

/* 
 * 'size' => 'custom_image_size' | 'full' | 'large' | 'medium' | 'thumbnail'
 * Set 'size' and also 'resize' => 'crop' | 'proportional' | 'stretch' | 'pad'
 * If resize is necessary, set 'output' => 'normal'
 * 'padding_color' => 'transparent' | hex when resize=>pad
 */
// For Image field.
#+END_EXAMPLE

Refer to WP Types Custom Field Checkbox and WP Meta Query

*** Super Cache (SuperCache)
Warning: include(/var/www/html/wp-content/plugins/wp-super-cache/wp-cache-base.php): failed to open stream

If you encounter this problem, your WP_CACHE cache folder is not set properly. Check `wp-config.php`. You should see 

#+BEGIN_EXAMPLE
define('WP_CACHE',true);
define('WPCACHEHOME', ABSPATH. 'wp-content/plugins/wp-super-cache/');
#+END_EXAMPLE

There's another place where the cache folder is defined: `$cache_path` in `wp-content/wp-cache-config.php` 

Uninstall
To manually uninstall:

	• Turn off caching on the plugin settings page and clear the cache.
	• Deactivate the plugin on the plugins page.
	• Remove the WP_CACHE define from wp-config.php. It looks like define( 'WP_CACHE', true );
	• Remove the Super Cache mod_rewrite rules from your .htaccess file.
	• Remove the files wp-content/advanced-cache.php and wp-content/wp-cache-config.php
	• Remove the directory wp-content/cache/
	• Remove the directory wp-super-cache from your plugins directory.

If all else fails and your site is broken
	• Remove the WP_CACHE define from wp-config.php. It looks like define( 'WP_CACHE', true );
	• Remove the rules (see above) that the plugin wrote to the .htaccess file in your root directory.
	• Delete the wp-super-cache folder in the plugins folder.
	• Optionally delete advanced-cache.php, wp-cache-config.php and the cache folder in wp-content/.

*** Yoast SEO (wordpress-seo)
How to SEO? https://yoast.com/wordpress-seo/

**** Open Graph
Use at least 200x200 pixels image for `og:image`
You need to resave the post/article on WP first (to prevent WP Super Cache as FB crawler gets to the page differently) and then run Facebook Open Graph Object Debugger

*** all-in-one-seo-pack
*** Disqus
If you receive a lot of errors about dsq_sync_forum in Apache logs, it is caused by Disqus tries to sync with WP comments so frequently.

First in WP Disqus setting, check "Disable automated comment importing"

Empty all cron rows in wp-options table `UPDATE wp_options SET option_value='' WHERE option_name='cron';"`

https://wordpress.org/support/topic/high-server-load-and-dsq_sync_forum-problem?replies=6

*** captcha
*** all-in-one-event-calendar
*** contact-form-7
*** contact-form-plugin
receive messages from customers to your email addresses. Download, activate and paste [bestwebsoft_contact_form] shortcode on any page, post or widget to display the form. Customize the form styles and contents easily with the pre-build options.

*** custom-search-plugin
Custom Search plugin adds custom post types and taxonomies to WordPress website search results. A quick and easy way to search everything within custom post types and taxonomies.

*** custom-permalinks
Change URL to any structure for individual post, page, tag or category.
Need to resave Permalinks setting

*** hc-custom-wp-admin-url

*** tinymce-advanced, 
Add, remove and arrange buttons shown on the Visual Editor toolbar.
Enable or disable 15 plugins for TinyMCE.
Modify options such as keeping the paragrah tags in the Text editor and importing CSS classes from the theme's editor-style.css

** Debug, WP_Error
https://codex.wordpress.org/Function_Reference/WP_Error
Function may return WP_Error object. Catch error
#+BEGIN_EXAMPLE
$post = wp_insert_post([]);
if ( is_wp_error($post) ) {
 echo $post->get_error_message();
}
#+END_EXAMPLE

In wp-config.php
#+BEGIN_EXAMPLE
define( 'WP_DEBUG', true );
#+END_EXAMPLE

Or anywhere
#+BEGIN_EXAMPLE
error_reporting(E_ALL);
ini_set('display_errors', 1);
#+END_EXAMPLE

** Installation Language
Download additional language packs from [[https://make.wordpress.org/polyglots/teams/][here]]
Upload thme to wp-content/languages
Then change the language in each User Profile.

** File Permissions
All files should be chmod:644 and all folders chmod:755
wp-config.php should be chmod:660 or chmod:664
#+BEGIN_EXAMPLE
find . -type f -exec chmod 644 {} +
find . -type d -exec chmod 755 {} +
chmod 660 wp-config.php
#+END_EXAMPLE

Run this to check which files are not 644 and which directories are not 755
<<<wp:check file permissions>>>
#+BEGIN_EXAMPLE
find . -type d -not -perm 755 -o -type f -not -perm 644
find . -type d -not -perm 755 -not -path "./.git/*" -o -type f -not -perm 644 -not -path "./.git/*"
#+END_EXAMPLE

** Auto update
https://codex.wordpress.org/Configuring_Automatic_Background_Updates

wp-config.php
#+BEGIN_EXAMPLE
define( 'WP_AUTO_UPDATE_CORE', true );
#+END_EXAMPLE

Value of true – Development, minor, and major updates are all enabled
Value of false – Development, minor, and major updates are all disabled
Value of 'minor' – Minor updates are enabled, development, and major updates are disabled

Fine tune
add_filter( 'allow_dev_auto_core_updates', '__return_true' );           // Enable development updates 
add_filter( 'allow_minor_auto_core_updates', '__return_true' );         // Enable minor updates
add_filter( 'allow_major_auto_core_updates', '__return_true' );         // Enable major updates

** SSL
#+BEGIN_EXAMPLE
// Force HTTPS logins and administration
define('FORCE_SSL_ADMIN', true);

// The above also means this below
//define('FORCE_SSL_LOGIN', true);

define('WP_HOME','https://'.$_SERVER[HTTP_HOST]);
define('WP_SITEURL','https://'.$_SERVER[HTTP_HOST]);
#+END_EXAMPLE

You can now try to go to wp-admin
If W3 Total Cache is installed, Performance > Page Cache > enable Cache SSL (https) requests
If some security plugin is installed, make sure no SSL is enforced for any pages because Apache at the end will cover that.

Use ssl:test tools to identify problematic links
Fix legacy content in DB
https://css-tricks.com/moving-to-https-on-wordpress/
#+BEGIN_EXAMPLE
// double quotes
UPDATE wp_posts 
SET    post_content = ( Replace (post_content, 'src="http://', 'src="//') )
WHERE  Instr(post_content, 'jpeg') > 0 
        OR Instr(post_content, 'jpg') > 0 
        OR Instr(post_content, 'gif') > 0 
        OR Instr(post_content, 'png') > 0;

// single quote
UPDATE wp_posts 
SET   post_content = ( Replace (post_content, "src='http://", "src='//") )
WHERE  Instr(post_content, 'jpeg') > 0 
        OR Instr(post_content, 'jpg') > 0 
        OR Instr(post_content, 'gif') > 0 
        OR Instr(post_content, 'png') > 0;

// Custom Fields
UPDATE wp_postmeta 
SET meta_value=(REPLACE (meta_value, 'iframe src="http://','iframe src="//'));
#+END_EXAMPLE

Force redirect to https on Apache for all pages :: apache:https

** UC: Simple HTML page with form submit
Create a url path /abc which points to index.html (can't have php files)
*** /abc/index.html
#+BEGIN_EXAMPLE
<script src='https://www.google.com/recaptcha/api.js'></script>

<div id="form-frame" class="form">
  <div class="form-input">
    <div id="err-message"></div>
  </div>
  <div class="form-input">
    <label for="li-fname">Full Name</label>
    <input type="text" name="li-fname" id="li-fname">
  </div>
  <div class="form-input news-input">
    <label for="li-sub-promo">How did you hear about this promotion?</label>
    <select name="li-sub-promo" id="li-sub-promo">
      <option value="Website">Website</option>
      <option value="Radio">Radio</option>
      <option value="TV">TV</option>
      <option value="Referral">Referral</option>
      <option value="Brochure">Brochure</option>
      <option value="Email">Email</option>
      <option value="Newsletter">Newsletter</option>
      <option value="Online Ads">Online Ads</option>
      <option value="Social Media">Social Media</option>
    </select>
  </div>
  <div class="form-input news-input">
    <label for="small-business-lighting">Programs of Interest
      <br>(Check all that apply)</label>
    <div class="li-newsbox">
      <input type="checkbox" name="li-newsbox" id="small-business-lighting">Small
      Business Lighting<br>
      <input type="checkbox" name="li-newsbox"
             id="business-registration-incentives">Business Refrigeration
      Incentives
    </div>
  </div>
  <div class="form-input">
    <label>&nbsp;</label>
    <div class="g-recaptcha" data-sitekey="[[your_google_recaptcha_public_key]]"></div>
    <div id="captcha-verify"></div>
  </div>

  <div class="form-input submit-input" id="form-submit">
    <label>&nbsp;</label>
    <a href="javascript:;" onclick="javascript:submit_form();">Submit</a>
  </div>

</div>
<script type="text/javascript"
        src="/abc/lb/js/app.js"></script>
<script type="text/javascript"
        src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
#+END_EXAMPLE

*** /abc/lb/js/app.js
#+BEGIN_EXAMPLE
function submit_form(){

  var send_msg = document.getElementById('form-submit');
  var pre_send = ('<label>&nbsp;</label><a href="javascript:;" onclick="javascript:submit_form();">Submit</a>');
  var post_send =  ('<label>&nbsp;</label><a id="send-blank">Sending...</a>');

  var validate_form = pre_validate_cf();
  var message = document.getElementById('err-message');
  var form_data = '';
  var form_return = '';

  send_msg.innerHTML = post_send;

  if (validate_form!=0) {

    send_msg.innerHTML = pre_send;
    message.innerHTML = 'Please correct the following errors: <ul>'+validate_form+'</ul>';
    message.style.display = 'block';

  }
  else {

    message.style.display = 'none';

    /* -- SEND TO SERVER -- */
    var name = encodeURIComponent(document.getElementById('li-fname').value);
    var email = encodeURIComponent(document.getElementById('li-email').value);
    var phone = encodeURIComponent(document.getElementById('li-phone').value);
    var company = encodeURIComponent(document.getElementById('li-company').value);
    var address = encodeURIComponent(document.getElementById('li-address').value);
    var promo = encodeURIComponent(document.getElementById('li-sub-promo').value);

    var bus_lighting = is_checked('small-business-lighting');
    var bus_reg_incentives = is_checked('business-registration-incentives');

    form_data = 'name='+name+'&email='+email+'&phone='+phone+'&company='+company+'&address='+address+'&promo_hear='+promo+'&bus_lighting='+bus_lighting+'&bus_reg_incentives='+bus_reg_incentives;

    cf_form_req(form_data);

  }
}

function cf_form_req(params){

  var send_msg = document.getElementById('form-submit');
  var pre_send = ('<label>&nbsp;</label><a href="javascript:;" onclick="javascript:submit_form();">Submit</a>');
  var post_send =  ('<label>&nbsp;</label><a id="send-blank">Sending...</a>');
  var message = document.getElementById('err-message');
  var recaptcha = '';
  recaptcha = grecaptcha.getResponse();
  var params_full = params +'&recaptcha='+ recaptcha;

  send_msg.innerHTML = post_send;

  var url = "/wp-content/themes/li-cdm-lp/lb/api-localbusiness/cf-form-post.php";

  $.ajax({
    url : url,
    type: "POST",
    data : params_full,
    success: function(data)
    {

      console.log(data);

      if(data=='true'){
        document.getElementById('form-validated').style.display = 'block';
        ga('send', 'event', {
          eventCategory: 'Form Submit Success',
          eventAction: 'click',
          eventLabel: event.target.href
        });

        console.log('submit');
      }else {
        message.style.display = 'block';
        send_msg.innerHTML = pre_send;
        message.innerHTML = 'Please correct the following errors: <ul>'+data+'</ul>';
      }

    }
  });
}

function google_captcha_verify(){
  var v = grecaptcha.getResponse();
  if(v.length == 0) { return false; }
  else { return true; }
}

function pre_validate_cf(){

  var name = document.getElementById('li-fname');
  var email = document.getElementById('li-email');
  var phone = document.getElementById('li-phone');
  var company = document.getElementById('li-company');
  var address = document.getElementById('li-address');

  var bus_lighting = is_checked('small-business-lighting');
  var bus_reg_incentives = is_checked('business-registration-incentives');
  var google_captcha = google_captcha_verify();

  //var captcha = document.getElementById('captcha-verify');

  var clean_css = 'border:1px #2ac158 solid';
  var err_css = 'border:1px #FF0000 solid';

  var check = '';
  var log_data = '';

  if(name.value == null || name.value==''){
    check = '<li>Please enter your name.</li>';
    log_data = '[ Empty First Name ],';
    name.style.cssText = err_css;
  }else {
    log_data = '[ First Name: '+name.value+' ],';
    name.style.cssText = clean_css;
  }

  if(email.value == null || email.value==''){
    check += '<li>Please enter your email.</li>';
    log_data += '[ Empty Email ],';
    email.style.cssText = err_css;
  }else if(validate_email(email.value)=='false'){
    check += '<li>Please enter a valid email.</li>';
    log_data += '[ Invalid Email: '+email.value+' ],';
    email.style.cssText = err_css;
  }else {
    log_data += '[ Email: '+email.value+' ],';
    email.style.cssText = clean_css;
  }

  if(phone.value == null || phone.value==''){
    check += '<li>Please enter your phone number.</li>';
    phone.style.cssText = err_css;
  }else if(validate_phone(phone)!=true){
    check += '<li>Please enter a valid phone number. Format: 000-000-0000</li>';
    phone.style.cssText = err_css;
  }else {
    phone.style.cssText = clean_css;
  }

  if(company.value == null || company.value==''){
    check += '<li>Please enter your company name.</li>';
    company.style.cssText = err_css;
  }else {
    company.style.cssText = clean_css;
  }

  if(address.value == null || address.value == ''){
    check += '<li>Please enter your company address</li>';
    address.style.cssText = err_css;
  }else {
    address.style.cssText = clean_css;
  }

  if(google_captcha!== true ){
    check += '<li>Please verify you are not a robot.</li>';
  }

  if(bus_lighting!== 'Checked'){
    if(bus_reg_incentives!=='Checked'){
      check += '<li>Please select a program of interest.</li>';
    }else {

    }
  }

  /* IF VALID -- Clear Check, Set to 0 */
  if(check==''){check=0;}

  return check;
}

function is_checked(id){
  if(document.getElementById(id).checked) {
    return( "Checked" );
  }else {
    return( "Not Checked" );
  }
}

function close_form(){
  document.getElementById('form-validated').style.display = 'none';
}
#+END_EXAMPLE

*** /wp-content/themes/li-cdm-lp/lb/api-localbusiness/cf-form-post.php
#+BEGIN_EXAMPLE
<?php
/* --- CLASS INCLUSION --- */
include('form-clean.php');
$FORMCLEAN = new FORM_CLEAN();

session_start();

$recipients_sbl = array('iamadmin@abc.com');

/* --- PARAMS (Pre-Clean) --- */
$C_NAME 			= $FORMCLEAN->clean($_POST['name']);
$C_EMAIL 			= $FORMCLEAN->clean($_POST['email']);
$C_PHONE			= $FORMCLEAN->clean($_POST['phone']);
$C_COMPANY 			= $FORMCLEAN->clean($_POST['company']);
$C_ADDRESS			= $FORMCLEAN->clean($_POST['address']);
$C_PROMO			= $FORMCLEAN->clean($_POST['promo_hear']);
$C_BUS_LIGHTING = $FORMCLEAN->clean($_POST['bus_lighting']);
$C_BUS_INCENTIVES = $FORMCLEAN->clean($_POST['bus_reg_incentives']);

/* --- VALIDATE --- */
$C_NAME_VALIDATE 				= 	$FORMCLEAN->validate($C_NAME,'Name');
$C_EMAIL_VALIDATE 				= 	$FORMCLEAN->validate($C_EMAIL,'Email');
$C_PHONE_VALIDATE				=	$FORMCLEAN->validate($C_PHONE,'Phone');
$C_COMPANY_VALIDATE				=	$FORMCLEAN->validate($C_COMPANY,'Company');
$C_ADDRESS_VALIDATE				=	$FORMCLEAN->validate($C_ADDRESS,'Address');


// validate reCaptcha
$C_CAPTCHA_VALIDATE = '';
$C_CAPTCHA = $_POST['recaptcha'];
$C_CAPTCHA_google_request = array(
  'url' => 'https://www.google.com/recaptcha/api/siteverify',
  'options' => array(
    'secret' => 'your_recaptcha_secret_key',
    'response' => $C_CAPTCHA,
  ));

$ch = curl_init();
$options = array(
  CURLOPT_URL => $C_CAPTCHA_google_request['url'],
  CURLOPT_POSTFIELDS => http_build_query($C_CAPTCHA_google_request['options']),
  CURLOPT_FOLLOWLOCATION =>  1,
  CURLOPT_HEADER => 0,
  CURLOPT_RETURNTRANSFER => 1
);
curl_setopt_array($ch, $options);
$C_CAPTCHA_google_result = json_decode(curl_exec( $ch ), true);
curl_close($ch);

if (!(is_array($C_CAPTCHA_google_result) && $C_CAPTCHA_google_result['success'] === true)) {
  $C_CAPTCHA_VALIDATE = ('<li>reCaptcha Match Fails </li>');
}
// validate reCaptcha.

$EMAIL_TO = '';

$SOURCE_CODE = 'Li-Local-Business';

$VALIDATE = str_replace('0','',$C_NAME_VALIDATE.$C_EMAIL_VALIDATE.$C_PHONE_VALIDATE.$C_COMPANY_VALIDATE.$C_ADDRESS_VALIDATE.$C_CAPTCHA_VALIDATE);

if($VALIDATE==''){

  if($C_BUS_LIGHTING=='Checked'){

    /* --- SEND EMAIL (TO ADMINISTRATOR) --- */
    $EMAIL_TO = implode(',', $recipients_sbl);
    //$EMAIL_TO .= 'joseph.alonzi@cleversamurai.com';
    $SUBJECT = '[ Li ] - Small Business Lighting Signup';
    $EMAIL_FROM = 'donotreply@abc.com';

    $MESSAGE = ('
					<html>
						<head>
							<title>[ Li ] - Small Business Lighting Signup</title>
						</head>
						<body>

						 <h1>[ Li ] - Small Business Lighting Signup</h1>

						 <b>Name:</b> '.$C_NAME.'<br />
						 <b>Email:</b> '.$C_EMAIL.'<br />
						 <b>Phone:</b> '.$C_PHONE.'<br /><br />

						<b>How Did You Hear About Us?</b> '.$C_PROMO.'<br /><br />

						 <b>Business Name:</b> '.$C_COMPANY.'<br />
						 <b>Business Address:</b> '.$C_ADDRESS.'<br /><br />

						 The following email: '.$C_EMAIL.' has shown interest in Small Business Lighting.

						<br />
						---
						<br />
						Source Code: '.$SOURCE_CODE.$_debug.'

						</body>
					</html>
					');

    $HEADERS  = 'MIME-Version: 1.0' . "\r\n";
    $HEADERS .= 'Content-type: text/html; charset=iso-8859-1' . "\r\n";
    $HEADERS .= 'From: Li <'.$EMAIL_FROM.'>' . "\r\n";
    mail($EMAIL_TO, $SUBJECT, $MESSAGE, $HEADERS);

  }

  unset($_SESSION['C_CAPTCHA']);
  session_destroy();

  /* --- IF ALL VALIDATES, AND THE EMAIL HAS BEEN SENT --- */
  echo 'true';

}
else {
  echo $VALIDATE;
}
#+END_EXAMPLE

*** /wp-content/themes/li-cdm-lp/lb/api-localbusiness/form-clean.php
#+BEGIN_EXAMPLE
<?php

class FORM_CLEAN{

  public function clean($input){

    /* -- Simple Clean -- */
    $input = preg_replace('#<script(.*?)>(.*?)</script>#is', '', $input);
    $input = str_replace('<?php','',$input);
    $input = str_replace('?>','',$input);
    $input = str_replace("1=1;--",'',$input);
    $input = strip_tags($input);

    return $input;

  }

  public function validate($input,$name){

    $error=0;

    if($input==''){
      $error++;
    }

    if($error!=0){
      return '<li> '.$name.' field is empty or invalid.';
    }else {
      return $error;
    }

  }

  public function check_convert($str){

    if($str=='true'){
      $str='YES';
    }else {
      $str='NO';
    }

    return $str;

  }
  
}
#+END_EXAMPLE

* ColdFusion
** cfsetting
Override the server setting for a particular page
#+BEGIN_EXAMPLE
<cfsetting enablecfoutputonly="yes|no" 
           requesttimeout="300" 
           showdebugoutput="yes|no">
#+END_EXAMPLE

** Text
#+BEGIN_EXAMPLE
FindNoCase("the", "The sentence") returns integer position
0 if not found
#+END_EXAMPLE

** Mail
#+BEGIN_EXAMPLE
<cfmail to="1@a.com,2@b.com" from="" subject="" type="text/html">
  <cfmailparam name="X-SMTPAPI" value='{"category": ["abc-xyz"]}' />
  <p>...</p>
</cfmail>
#+END_EXAMPLE

** Function
#+BEGIN_EXAMPLE
<cffunction name="getSiteDetail" access="public" returntype="query">
  <cfargument name="intID" type="numeric" default="0">
  <cfset var getSite = "">
  <cfquery name="getSite" datasource="..." dbtype="ODBC">
     SELECT *
     FROM Site
     WHERE ID <> 7
     <cfif argument.intID neq 0>
       AND ID = <cfqueryparam value="#Arguments.intID#" CFSQLType="CF_SQL_NUMERIC">
     </cfif>
     ORDER BY Site.sname
  </cfquery>
  <cfreturn getSite>
</cffunction>

<cfinvoke component="functions.banner" 
          method="getSiteDetail" 
          returnvariable="getSite">
  <cfinvokeargument name="intID" value="#Form.ssite2#">
</cfinvoke>
#+END_EXAMPLE

** Query
#+BEGIN_EXAMPLE
<!--- Access --->
<cfquery name="queryname" datasource="abc" dbtype="ODBC">
  SELECT *
  FROM tblOne
</cfquery>
#+END_EXAMPLE

*** Get Identity After Insert
Access
#+BEGIN_EXAMPLE
<cftransaction>
  <cfquery name="insertQ" datasource="abc">
    INSERT INTO aTable (col1, col2)
    VALUES (1,2)
  </cfquery>
  <cfquery name="getID" datasource="abc">
    SELECT @@identity AS RecordID
  </cfquery>
</cftransaction>

<cfoutput>#getID.recordID#</cfoutput>
#+END_EXAMPLE

TSQL

#+BEGIN_EXAMPLE
<cfquery>
SET NOCOUNT ON;
INSERT INTO aTable (col1,col2)
VALUES (1,2)
SELECT SCOPE_IDENTITY() AS RecordID;
</cfquery>
#+END_EXAMPLE

*** Insert Null
#+BEGIN_EXAMPLE
<cfquery>
  UPDATE tTable SET
  <cfif isDefined('form.formFieldA')>
    intField = <cfqueryparam value="#form.formFieldA#" cfsqltype="cf_sql_numeric">
  <cfelse>
    intField = <cfqueryparam value="" cfsqltype="cf_sql_numeric" null="1">
  </cfif>
</cfquery>
#+END_EXAMPLE

** Fast form to Database

Checkbox
#+BEGIN_EXAMPLE
<input type="checkbox" name="dLocked" value="1">

<cfparam name="form.dLocked" default="0" overwrite="false">
INSERT INTO aTable (dLocked)
VALUES (
<cfqueryparam value="#form.dLocked#" CFSQLType="CF_SQL_BIT">
)
#+END_EXAMPLE

#+BEGIN_EXAMPLE
<!--- Insert --->
<form action="site_new.cfm" method="post">
  <input name="Sname" type="text" size="30" maxlength="255">
</form>

# site_new.cfm
<cfinsert datasource="aDB" tablename="TableName">

<!--- Update. cfupdate doesn't work... use cfquery --->
<cfif isDefined("form.phone")> 
    <cfupdate datasource="cfdocexamples" tablename="EMPLOYEES"> 
</cfif> 
 
<cfquery name="empTable" datasource="cfdocexamples"> 
    SELECT * FROM EMPLOYEES 
</cfquery> 
 
<!--- This code shows the contents of the employee table and allows you to choose a row for updating. ---> 
<table border="1"> 
<cfoutput query="empTable"> 
    <tr> 
        <td>#firstName#</td> 
        <td>#lastName#</td> 
        <td>#phone#</td> 
        <td><a href="cfupdate.cfm?id=#emp_id#">Edit</a></td> 
    </tr> 
</cfoutput> 
</table> 
 
<cfif isDefined("url.id")> 
    <cfquery name="phoneQuery" datasource="cfdocexamples"> 
        SELECT * FROM employees WHERE emp_id=#url.id# 
    </cfquery> 
<!--- This code displays the row to edit for update. ---> 
    <cfoutput query="phoneQuery"> 
        <form action="cfupdate.cfm" method="post"> 
        #phoneQuery.firstName# #phoneQuery.lastName#  
        <input name="phone" type="text" value="#phone#" size="12">  
        <input type="submit" value="Update"> 
        <input name="emp_id" type="hidden" value="#emp_id#"> 
        <!--- The emp_id is passed as a hidden field to be used as a primary  
            key in the CFUPDATE. ---> 
        </form> 
    </cfoutput> 
</cfif>
#+END_EXAMPLE

** Loop
<cfloop query="aQueryname" startRow="1" endRow="10" group="Customer_ID">
  #aQueryName.CurrentRow#
</cfloop>

startRow, endRow and group are optional.

Array
<cfset local.objPath = GetPageContext().getRequest().getServletPath() />
<cfset local.apiNS = ArrayNew(2) />
<cfset local.apiNS[1] = ["v1", "json"] />
<cfset local.apiNS[2] = ["v2", "json2"] />
<cfset local.apiVer = 0 />
<cfset Request.apiCFC = 'json' />

<cfloop array="#local.apiNS#" item="i">
  <cfif FindNoCase('/' & i[1] & '/', local.objPath, 1)>
    <cfset local.apiVer = i[1] />
    <cfset Request.apiCFC = i[2] />
    <cfbreak>
  </cfif>
</cfloop>

** Remote Address
<cfif cgi.REMOTE_ADDR eq "127.0.0.1">

** cftry
#+BEGIN_EXAMPLE
<cftry>
  <!--- Do something --->
  <cfcatch type="any">
    <cfdump var="#cfcatch#">
  </cfcatch>
</cftry>
#+END_EXAMPLE

** cfdump
Save cfdump in a string
#+BEGIN_EXAMPLE
<cfsavecontent variable="theDump">
  <cfdump var="#form.uploadSizesAll#" expand="yes" format="text">
</cfsavecontent>
<cfset sError = theDump>
#+END_EXAMPLE

** Javascript
#+BEGIN_EXAMPLE
<cfoutput>
  <script>
    var #toscript(form.afield, "jsVarName")#;
  </script>
</cfoutput>
#+END_EXAMPLE

* CSS
** Position, box-sizing
Default position is static. left, right, top, bottom have not effect
relative is relative to default static position, use left, right, top and bottom

Other elements adjacent to position:relative element will no be adjusted to fit into
any gap left by the element (treat the relative element as static)

position:fixed is relative to viewport

A "positioned" element is one whose position is anything except static.

postion:absolute is positioned relative to the nearest positioned ancestor.
If there's no positioned ancestors, document body is used.

When elements are positioned, they can overlap other elements.

box-sizing: border-box | padding-box | content-box (default); 

** Horizontal Center Absolute
The absolute element is positioned related to the first position:relative parent

Center that abosulte element in relate to that parent

Notice: any parents will not expand in width and height according to that absolute child element 
#+BEGIN_EXAMPLE
.grandchild {
  position: absolute;
  margin-left: auto;
  margin-right: auto;
  left: 0;
  right: 0;
}
#+END_EXAMPLE

** Transform, Transition
css:animation

*** Transition
transition: /transition-property/ /transition-duration/ /transition-timing-function/ /transition-delay/

- transition-property :: can be 'all'
- transition-timing-function :: default linear
  - ease-in :: slow start
  - ease-out :: slow end
  - e.g. use ease-in for div:hover and ease-out in div

- transition-delay :: delay n seconds before the current transition starts.

#+BEGIN_EXAMPLE
div {
  width: 100px;
  height: 100px;
  background: red;
  transition: width 2s linear 3s, height 2s linear 3s, transform 2s linear 3s;
}
#+END_EXAMPLE

*** Transform

#+BEGIN_EXAMPLE
div:hover {
  width: 300px;
  height: 300px;
  transform: 
    rotate(180deg) 
    translate(-20px, 0)
    scale(0.9, 2)
    skew(30deg, 20deg);
}
/* You can turn off all transform */
/* transform: none; */
#+END_EXAMPLE

** Link
#+BEGIN_EXAMPLE
// In order
a:link {} /* Unvisited and normal */
a:visited {}
a:hover {}
a:active {}
#+END_EXAMPLE

** Text
*** Ellipsis
Single Line
#+BEGIN_EXAMPLE
div.test {
 white-space: nowrap;
 width: 200px; // width has to be defined
 overflow: hidden; // needed
 text-overflow: ellipsis; // change to inherit when hover then the clipped text will show
}
#+END_EXAMPLE

Multiple Lines (IE and Edge will not show 3 dots)

#+BEGIN_EXAMPLE
.excerpt {
  display: block;
  display: -webkit-box;
  font-weight: normal;
  font-size: 15px;
  line-height: 1.4;
  -webkit-line-clamp: 9;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  height: 189px; /* 15*1.4*9 */
}
#+END_EXAMPLE

*** Long Word
#+BEGIN_EXAMPLE
word-wrap: break-word; // allow to break a long word
#+END_EXAMPLE

*** Font size, line-height, letter-spacing
font-size in child elements inherit parent element
em uses the current element's font-size or its closest parent element which has font-size defined
rem is always relative to the <html> element
vw and vh are the viewport width and height. 1vw is 1% of vw

Google recommends line-height is at least 1.2

line-height is normal means to use user agent style. Most likely default is 1 not 1.2

letter-spacing, padding using em is relative to the current element's font size

** CSS Selectors
<<<CSS Selectors>>>

div > p :: select p elements where the direct parent is div
div + p :: select p elements that are placed immediately after div (div's children)
p ~ ul :: select ul elements that are preceded by a p element
#+BEGIN_EXAMPLE
<p></p>
<ul></ul>
#+END_EXAMPLE

a[target] :: <a>'s with target attribute
a[target=_blank]
a[title~=flower] :: containing a word or followed by a hypen (not match flowers)
a[lang|=en] :: starting with a word or followed by a hyphen (en, en-us)
div[class^="test"] :: starting with (anything)
div[class$="test"] :: ending with (anything)
a[href*="w3schools"] :: containing

a:active
a:hover
a:link
a:visited

p::after :: <img> can't have pseudo element
p::before
p::first-letter
p::first-line
p::selection
div::selection -- the selected portion of an element (e.g. select text)

input:checked
input[type="text"]:disabled
input:enabled
input:focus
input:invalid
input:valid
input:optional
input:required
 
p:empty -- has no children including text nodes

div:not(p) -- all children elements except <p>'s
div:not(.aClass) :: all div elements except the ones with class aClass

p:first-child -- <p>'s are the first child of any elements
p:last-child
p:nth-child(2)
p:nth-child(7n-1)
tr:nth-child(even)
tr:nth-child(odd)
p:nth-last-child(2)
p:only-child -- <p>'s are the only child of any elements

div p:first-of-type -- <div> has 4 children <p>'s and first child is <a>. Select 1st of <p> children.
div p:last-of-type
div p:nth-of-type(2)
div p:only-of-type

=#news:target= -- anchor name id=news matches the URL hash

** Specificity
(a, b, c, d) start with (0, 0 , 0 ,0)
a - inline add 1
b - each id add 1
c - class, pseudo-class and attribute add 1
d - element add 1

Pseudo-class :not is not considered as pesudo-class in specificity calculation.
But anything inside it counts.

** Functions
*** attr(data-attr-1)
#+BEGIN_EXAMPLE
a::after {
 content: " (" attr(href) ")";
}
#+END_EXAMPLE

*** calc()
No parenthesis is allowed inside calc()
#+BEGIN_EXAMPLE
<div>Some Text...</div>

// Always leave 50px on both sides for space
// and take all that is left for width

div {
 width: calc(100% - 100px); /* calculate */
 margin-left: 50px;
}

// 3 columns minus gutter
.item {
  width: calc(100%/3 - 10px/3);
}
#+END_EXAMPLE

*** counter
#+BEGIN_EXAMPLE
body {
 counter-reset: section;
}
h1 {
 counter-reset: subsection;
}
h1::before {
 counter-increment: section,
 content: "Section " counter(section) ". ";
}
h2::before {
 counter-increment: subsection;
 content: counter(section) "." counter(subsection) " ";
}
#+END_EXAMPLE

** border-image
border-image: source slice width outset repeat|initial|inherit;
border-image: none   100%   1     0     stretch

** background
background: bg-color bg-image position/bg-size bg-repeat bg-origin bg-clip bg-attachment initial|inherit;

#+BEGIN_EXAMPLE
background: url(img_flwr.gif) right bottom no-repeat, url(paper.gif) left top repeat;
#+END_EXAMPLE

*** background-position
background-position: right center; // align right on X and align center on Y
background-position: right bottom;
background-position: right 100px bottom -100px; //  for right/left or top/bottom, +- pixels
background-position: calc(50% - 100px) calc(50% + 100px); // for center, calc has be used

*** background-size
background-size: 20px auto;
background-size: 50% auto; // sets the width of the bg image in percent of the parent element.
background-size: contain; // bg image might not cover all content area
background-size: cover; // content area might not see the whole bg image

Stretch on y-axis and repeat on x-axis
background: url() center repeat-x;
background-size: auto 100%;

*** background-clip, background-origin
background-clip: border-box; // default. largest area
// padding-box, content-box

// For background image
background-origin: border-box; // default. largest area
// padding-box, content-box

*** Add dark layer on a background image
15% darker
#+BEGIN_EXAMPLE
// Before
background: url(/slide-03.jpg) no-repeat center center;

// After
background: linear-gradient(to bottom, rgba(0, 0, 0, 0.15) 0%, rgba(0, 0, 0, 0.15) 100%), url('/slide-03.jpg') no-repeat center center;
#+END_EXAMPLE

** List style
<'list-style-type'> || <'list-style-position'> || <'list-style-image'>
Can't control the image size.

** Color
*** <<<CSS inherit color>>>
You can grab the parent `color` css property and use it in any color properties in child element
#+BEGIN_EXAMPLE
<div class="parent">
 <div class="child">
 </div>
</div>

.parent {
 color: red;
 background-color: blue;
}
.child {
 background-color: currentColor; /* take the parent color: red */
 color: currentColor; /* Take the parent color: red */
}
#+END_EXAMPLE

*** rgb(), rgba()
<<<CSS rgba>>>
#+BEGIN_EXAMPLE
#f03
#ff0033
#FF0033
rgb(255, 0, 51) // no fraction all integers
rgb(100%, 0%, 20%) // all % no integer

#f030     // 0% opaque red
#ff003300 // 0% opaque red
#FF003388 // 50% opaque red
rgba(255,0,0,0.7) // 70% opaque red

#+END_EXAMPLE

*** hsl(), hsla()
Hue :: integer, angle degree of the color circle. Red is 0, Green is 120, Blue is 240
Saturation :: percentage. 0% is grey
Lightness :: 100% is white, 0% is black, 50% is normal

#+BEGIN_EXAMPLE
hsla(240, 100%, 50%, 0.05) // 5% opaque blue
#+END_EXAMPLE

** Gradient
Both CSS gradient and CSS repeat gradient can be stacked in background-image

<<<CSS gradient>>>

#+BEGIN_EXAMPLE
linear-gradient(45deg, blue, red);
// to bottom, to top
// to right, to left
// to bottom right, to top left
linear-gradient(to bottom, blue, white 80%, orange);
// blue at 0%, white at 80%, orange at 100%
linear-gradient(to right, red, orange, yellow, green, blue);
// evenly distributed

background: linear-gradient(to right, rgba(255,255,255,0), rgba(255,255,255,1))
           ,url(/bg.jpg);
// Use it with background image

radial-gradient(red, yellow, rgb(30, 144, 255)); // evenly spaced
radial-gradient(red 5%, yellow 25%, #1E90FF 50%);
radial-gradient(
 circle, 
 // Shape can circle or ellipse
 // Default farthest-side
 // Fade from the center point to the ___
 // closest-corner, closest-side, farthest-corner, farthest-side
 yellow, #f06d06
);
// Change from center point to corner
radial-gradient(
 circle farthest-corner at top right,
 yellow, #f06d06
);
#+END_EXAMPLE

<<<CSS repeat gradient>>>

#+BEGIN_EXAMPLE
// On top of percentage, px can be used in repeat gradient
repeating-linear-gradient(-45deg, red, red 5px, white 5px, white 10px);
#+END_EXAMPLE

** opacity
0, 0.3, 1. The lower the value the more transparent
Child elements inherits the parent opacity value
If you don't want to carry opacity to children, define rgba color in parent elements
CSS rgba

** Shadow
Shadows can be stacked
#+BEGIN_EXAMPLE
box-shadow: h-shadow v-shadow blur spread color |inset|initial|inherit;
text-shadow: h-shadow v-shadow blur-radius color|none|initial|inherit;
#+END_EXAMPLE

** @font-face
Most widely accepted font format is WOFF then TTF and OTF.
Only IE supports EOT

#+BEGIN_EXAMPLE
@font-face {
 font-family: myFirstFont;
 src: url(sansation_light.woff);
}

// Another for bold
@font-face {
 font-family: myFirstFont;
 src: url(sansation_bold.woff);
 font-weight: bold;
/*
 font-stretch: normal | condensed | semi condensed | extra condensed | ultra condensed | expanded | ...;
 font-style: normal | italic | oblique 
*/
}
#+END_EXAMPLE

Web Safe Fonts
- Arial, Arial Black
- Comic Sans MS
- Courier New
- Georgia
- Impact / Charcoal
- Lucida Sans / Lucida Grande
- Tahoma / Geneva
- Times New Roman
- Trebuchet MS
- Verdana

[[http://www.cssfontstack.com/][Web Safe Fonts in PC and Mac]]

** @media
@media not|only /mediatype/ and (/media feature/) {}
<link rel="stylesheet" media="mediatype and|not|only (media feature)" href="style.css">

*** Syntax
not /mediatype/
only /mediatype/

Each media feature, key:value or key, must be wrapped in ()
Some media feature doesn't have a value.

=not /mediatype/= and =only /mediatype/= can be chained with OR (separated by comma) but not =and=
#+BEGIN_EXAMPLE
// This works
@media screen and (min-width:200px), not print and (min-width:300px) {}

// This syntax is wrong
@media screen and (min-width:200px) and not print and (min-width:300px) {}
#+END_EXAMPLE

Note :: =not /mediatype/= is different from =not(/mediafeature/)=

Nested media queries (@media inside another @media) is supported on all browsers except IE11 and below.

*** Testing
#+BEGIN_EXAMPLE
var mql = window.matchMedia("(orientation: portrait)");
// window.addListener(handlerOrientationChange);
handlerOrientationChange(mql);

function handlerOrientationChange(mql) {
 if (mql.mathces) {
  console.log('media query matches');
 }
 else {
  console.log('media query does not match');
 }
}
#+END_EXAMPLE

*** Media Types
all, print, screen, speech

#+BEGIN_EXAMPLE
@media screen and (max-width: 1000px) and (min-width: 700px) {}
// Use comma for OR
@media screen and (max-width: 699px) and (min-width: 520px), (min-width: 1151px) {}
#+END_EXAMPLE

<<<meta viewport>>>
#+BEGIN_EXAMPLE
<meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
// Set the width of the page to follow the screen-width of the device
// Initial zoom level 1.0

// Prevent zoom: add maximum-scale=1.0, user-scalable=0
// the above won't be WCAG compliant
#+END_EXAMPLE

*** Features
| Key           | Min/Max? | value                                                       |
| orientation   | no       | landscape, portrait. Not reliable when soft keyboard opens  |
| color         | yes      | int, number of colors. (color) for color device             |
| aspect-ratio  | yes      | int1/int2                                                   |
| grid          | no       | 0, 1 or (grid). The last suggests it's a device with 1 font |
| width, height | yes      | viewport                                                    |
| monochrome    | yes      | 0 (not mono) or int                                         |
| resolution    | yes      | 300dpi or 2dppx                                             |
|               |          |                                                             |

*** Responsive Design

Progressive Method :: start from mobile layout, add content to bigger screen size
Graceful Method :: start from desktop layout, remove content to smaller screen size

#+BEGIN_EXAMPLE
/* {
 box-sizing: border-box;
}
.row:after {
 content: "";
 clear:both;
 display:block;
}
[class*="col-"] {
 float: left;
 padding: 15px;
 width: 100%;
}
@media only screen and (min-width: 600px) {
    .col-s-1 {width: 8.33%;}
    .col-s-2 {width: 16.66%;}
    .col-s-3 {width: 25%;}
    .col-s-4 {width: 33.33%;}
    .col-s-5 {width: 41.66%;}
    .col-s-6 {width: 50%;}
    .col-s-7 {width: 58.33%;}
    .col-s-8 {width: 66.66%;}
    .col-s-9 {width: 75%;}
    .col-s-10 {width: 83.33%;}
    .col-s-11 {width: 91.66%;}
    .col-s-12 {width: 100%;}
}
@media only screen and (min-width: 768px) {
    .col-1 {width: 8.33%;}
    .col-2 {width: 16.66%;}
    .col-3 {width: 25%;}
    .col-4 {width: 33.33%;}
    .col-5 {width: 41.66%;}
    .col-6 {width: 50%;}
    .col-7 {width: 58.33%;}
    .col-8 {width: 66.66%;}
    .col-9 {width: 75%;}
    .col-10 {width: 83.33%;}
    .col-11 {width: 91.66%;}
    .col-12 {width: 100%;}
}

<div class="row">
 <div class="col-3 col-s-3 menu">
  <ul>
   <li>Menu 1</li>
   <li>Menu 2</li>
   <li>Menu 3</li>
 </div>
 
 <div class="col-6 col-s-9">
  long content...
 </div>

 <div class="col-3 col-s-12">
  right sidebar...
 </div>
</div>
#+END_EXAMPLE

*** Viewport sizes of device
http://viewportsizes.com/

#+BEGIN_EXAMPLE

@media only screen and (max-width:1920px){}

/* iPadPro@H1366 */
@media only screen and (max-width:1400px){}

/* iPad@H1024 */
@media only screen and (max-width:1267px){}

/* iPadPro@1024 */
@media only screen and (max-width:1201px){}

@media only screen and (max-width:1023px){}

@media only screen and (max-width:967px){}

/* iPad@768, iPhone6+@H736, Nexus 6P/5X@H732 */
@media only screen and (max-width:867px){}

/* iPhone6@H667 */
@media only screen and (max-width:697px){}

/* GalaxyS5@H640 */
@media only screen and (max-width:645px){}

/* iPhone5@H568 */
@media only screen and (max-width:597px){}

@media only screen and (max-width:467px){}

/* iPhone6+@414, Nexus 6P/5X@412 */
@media only screen and (max-width:420px){}

/* iPhone6@375, GalaxyS5@360 */
@media only screen and (max-width:375px){}

/* iPhone5@320 */
@media only screen and (max-width:320px){}
#+END_EXAMPLE

** @keyframes

<<<css:animation>>>

animation: /name/ /duration/ /timing-function/ /delay/ /iteration-count/ /direction/ /fill-mode/ /play-state/;

#+BEGIN_EXAMPLE
@keyframes fa-spin {
 0%   { transform: rotate(0deg); }
 100% { transform: rotate(359deg); } 
}
.fa-spin {
 animation: fa-spin 2s linear 3s infinite alternate;
/* 
  2s - duration
  3s - delay
  infinite - animation-iteration-count
  alternate - animation-direction

  animation-fill-mode:
    none (default, after animation ends, styles go back to before start) | 
    forwards (after animation ends, styles got applied) | 
    backwards (before animation starts and during delay, apply styles defined in the 1 iteration, e.g. from and to ) | 
    both;
*/
}
.fa-repeat:before {
  content: "\f01e";
}
<i class="fa fa-repeat fa-spin"></i>
// Spinner made in FontAwesome 
#+END_EXAMPLE

Javascript starts keyframes animation
#+BEGIN_EXAMPLE
<div id="myDIV" onclick="startAnimation()">Click to start animation</div>
var x = document.getElementById("myDIV");
function startAnimation() {
 x.style.animation = "fa-spin 2s liner 3s infinite alternate"; // Standard
}
#+END_EXAMPLE 

Javascript animation event listners
#+BEGIN_EXAMPLE
x.addEventListner("animationstart", func1);
x.addEventListner("animationiteration", func2);
x.addEventListner("animationend", func3);
#+END_EXAMPLE

** @import

#+BEGIN_EXAMPLE
/* @import should appear before any css styles defined in a css file */
@import "mystyle.css";
@import url("mystyle.css");
@import "mystyle.css" print;
/* only media types not media features */
#+END_EXAMPLE

** @viewport
WD. Only Edge. Same as meta viewport.

#+BEGIN_EXAMPLE
@media screen and (max-width: 400px) {
 @-ms-viewport { width: 320px; }
 /* Define the viewport size */
}
#+END_EXAMPLE

** @supports

#+BEGIN_EXAMPLE
@supports not (display:flex) {}
@supports (display: flex) or 
          (display: -ms-flexbox) or
          (display: -moz-box) {}

@supports (transition-property: color) or 
          ( (animation-name: myAnimation) and (transform: rotate(225deg) )
          ) {}
#+END_EXAMPLE

** Flexbox
<<<css:flex>>>
Container could be display:flex or display:inline-flex
Flexbox is good for aligning child elements with irregular or unknown or inconsistent width and height
And the number of child elements are unknown
Good for vertical and horizontal center a child element inside a container (parent)

#+BEGIN_EXAMPLE
.container {
 display: flex;
 /* flex-flow: <flex-direction> <flex-wrap> */
 
 /* flex-direction: row | row-reverse | column | column-reverse; */
 /* main axis is by default horizontally left to right 
  * main axis is changed by direcion css property (say change it ot rtl, right to left)
  * row is left to right , column is top to bottom
  *
  */
 /* flex-wrap: nowrap | wrap | wrap-reverse; */
    flex-flow: row wrap;
    
 /* justify-content: flex-start | flex-end | center | space-between | space-around; */
 /* e.g. you can change from flex-end to space-around for menu nav with @media queries */
    justify-content: space-around;   
 
 /* align-items: flex-start | flex-end | center | baseline | stretch; */
 /* This is for aligning items on one line (default x axis) on cross axis (y axis) */
 /* relative to the same line. e.g. you have 3 lines of items and each line holds 3 items. 
  * 3 items on each line have different height
  * how do the 3 items align on y axis on every line?
  * default is stretch
  */ 

 /* align-content: stretch | flex-start | flex-end | center | space-between | space-around;
  * This is for space between multiple lines
  * e.g. There're 3 lines of items and each line has 3 items 
  * How do the 3 lines align on the y axis on each line?
  * default is stretch
  * It only works when there are multiple lines and the container height is larger than total children height
  */

  /* It's always to set width and height in container */
  width: 100%;
}

.item {
 /* order: <integer>; // optional */

 /* flex: none | <flex-grow> <flex-shrink> <flex-basis> */

 /* flex-grow: 0 | <number>; */
 /* 0 is default and means do not enlarge item in width (default x axis) */

 /* flex-shrink: 1 | <number> */
 /* 1 is default and means do not shrink item in width (default x axis) */
 
 /* flex-basis: auto | <length>; */
 /* auto is default. if it's 0, extra space will not be factored in. Always use auto */

 /* don't set width in flex item */
 flex: 0 0 100px; /* instead of width:100px */
 flex: 0 0 50%; /* width: 50% */
 /* However, flex-basis is not guaranteed and it's based on max-width and min-width */

 flex: 1 0 auto; /* grow to the rest of the width, no shrink, auto */
 
 /* Override align-items in container */
 /* align-self: auto | flex-start | flex-end | center | baseline | stretch; */

}

.item_1 {
 /* Set margin:auto in an item will absorb all space of the current line in current direction
 margin-right: auto;
 /* all other items to the right of item_1 will not have extra space */
}
#+END_EXAMPLE

Insert a line break in flex items. Might not be easy..
#+BEGIN_EXAMPLE
.line-break {width: 100%}

<div class="container">
 <div class="item">1</div>
 <div class="item">2</div>
 <div class="line-break"></div>
 <div class="item">3</div>
 <div class="item">4</div>
</div>
#+END_EXAMPLE

Flex is so powerful.

You can flex-grow a child's width or height (depending on the flex-direction of the container),
so that the child takes up the remaining width or height of the container.
Just remember to set the width or height for the container.

Combine with Bootstrap div.container and div.row, you can set a specific row to take the rest of the container height.
You don't have to get height of any other rows.

#+BEGIN_EXAMPLE
.container.flex-column {
  display:flex;
  flex-direction:column;
  height: 100%; /* Make sure the container has a height */
  /* This is to take the height of the parent of the container */
}

.row.cover-row {
  flex-grow:1;
}
#+END_EXAMPLE

*** Examples
#+BEGIN_EXAMPLE
.flex-r-nw-sb {
  /* row nowrap space-between */
  display:flex;
  flex-flow: row nowrap;
  width:100%;
}
.flex-r-nw-sb-fs {
  /* row nowrap space-between don't stretch items' height on each line */
  display:flex;
  justify-content:space-between;
  flex-flow: row nowrap;
  align-items:flex-start;
  width:100%;
}

.flex-r-nw-sb-mq-r-w-c {
  /* row nowrap space-between */
  /* same as flex-r-nw-sb but with @media query */
  display:flex;
  
  flex-flow: row nowrap;
  width:100%;
}

@media only screen and (max-width: 597px) {
  .flex-r-nw-sb-mq-r-w-c {
    flex-flow: row wrap;
  }
}
#+END_EXAMPLE

** Grid
https://css-tricks.com/snippets/css/complete-guide-grid/

*** container: display, grid-template-columns, grid-template-rows
<<<css:grid-template-columns>>> <<<css:grid-template-rows>>>

#+BEGIN_EXAMPLE
<!-- div.container has to be the direct parent of all grid items -->
<div class="container">
 <!-- .item are direct descendants -->
 <div class="item item-1"></div>
 <div class="item item-2">
  <div class="sub-item">
    <!-- .sub-item is not a grid item! -->
  </div>
 </div>
 <div class="item item-3"></div>
</div>

.container {
 display: grid | inline-grid | subgrid;
 /* subgrid to indicate the grid container is a grid item of another grid container and 
    it should take the parent's sizes of rows/columns  
 */

 /* Don't use column, float, clear and vertical-align in grid container as they have no effect */

 /*
 grid-template-columns: <track-size> ... | <line-name> <track-size> ...;
 grid-template-rows: <track-size> ... | <line-name> <track-size> ...;

 <track-size> - can be a length, a percentage, or a fraction of the free space in the grid (unit is fr)
 <line-name> - an arbitrary name
 */

 grid-template-columns: 40px 50px auto 50px 40px; /* 5 columns */
 grid-template-rows: 25% 100px auto; /* 3 rows */
 
 /* Add line names
 grid-template-columns: [first] 40px [line2] 50px [line3] auto [col4-start] 50px [five] 40px [end];
 grid-template-rows: [row1-start] 25% [row1-end row2-start] 100px [third-line] auto [last-line];

 /* Any row or column line can have multiple names: [row1-end row-start]
    Any row or column line can have the same name */

 grid-template-columns: repeat(3, 20px [col-start]) 5%;
 /* equivalent to */
 grid-template-columns: 20px [col-start] 20px [col-start] 20px [col-start] 5%;
 
 /* Free space is defined as total space minus any fixed size items */
 grid-template-columns: 1fr 50px 1fr 1fr;
 /* each column will take (total width - 50px) * (1/3) */
}
#+END_EXAMPLE

*** <<<container: grid-template-areas>>>, items: grid-area
<<<css:grid-template-areas>>>

#+BEGIN_EXAMPLE
.item-a{
  grid-area: header;
}
.item-b{
  grid-area: main;
}
.item-c{
  grid-area: sidebar;
}
.item-d{
  grid-area: footer;
}

.container{
  grid-template-columns: 50px 50px 50px 50px;
  grid-template-rows: auto;
  grid-template-areas: "header header header header"
                       "main main . sidebar"
                       "footer footer footer footer";
d}
/* . means that single cell is empty. You can have multiple dots without space ".." */
/*
The first row line and column line of footer area have an extra name "footer-start"
The last row line and column line of footer aree have an extra name "footer-end"
*/
#+END_EXAMPLE

*** container: grid-template
Shorthand for setting css:grid-template-rows, css:grid-template-columns and css:grid-template-areas

#+BEGIN_EXAMPLE
.container {
  grid-template: none | subgrid | <grid-template-rows> / <grid-template-columns>;
}
#+END_EXAMPLE

*** container: grid-column-gap, grid-row-gap, grid-gap
<<<css:grid-gap>>>
Gutter size: space inbetween 2 row lines or column lines. But start and end space is always 0.

#+BEGIN_EXAMPLE
grid-column-gap: 10px;
grid-row-gap: 15px;
grid-gap: <grid-column-gap> <grid-row-gap>;
#+END_EXAMPLE

*** container: justify-items, items: justify-self
<<<css:justify-items>>>
#+BEGIN_EXAMPLE
justify-items: start | end | center | stretch (default);
/* Adjust content in a grid item along the row axis
   start: align to left end of the grid area
   end: right
   stretch: fills the whole width of the grid area
*/

.item {
 justify-self: /* To overwrite .container: justify-items */
}
#+END_EXAMPLE

*** container: align-items, items: align-self
<<<css:align-items>>>
#+BEGIN_EXAMPLE
align-items: start | end | center | stretch (default);
/* Adjust content in a grid item along the column axis
   start: align content to the top of the grid area
   end: bottom
   stretch: fills the whole height of the grid area
*/

.item {
  align-self: start | end | center | stretch (default);
}
#+END_EXAMPLE

*** container: justify-content
Align the grid along the row axis.
If all grid items are sized with non-flexible units like px, the total size of grid might be less than the size of its grid container.
Total width of all grids is less than width of its grid container.
start: align all grids to the left of the grid container
end: right
stretch: resize the grid items to allow the grid to fill the full width of the grid container
space-around: place an even amount of space between each grid item, with half-sized spaces on the far ends
space-between: place an even amount of space between each grid item, with no space at the far ends
space-evenly: place an even amount of space between each grid item, including the far ends
#+BEGIN_EXAMPLE
justify-content: start | end | center | stretch | space-around | space-between | space-evenly
#+END_EXAMPLE

*** container: align-content
Align the grid along the column axis.
Total height of all grids is less than height of its grid container.
start: align all grids to the top of the grid container
#+BEGIN_EXAMPLE
align-content: start | end | center | stretch | space-around | space-between | space-evenly
#+END_EXAMPLE

*** container: grid-auto-columns, grid-auto-rows
<<<css:grid-auto-columns>>> <<<css:grid-auto-rows>>>
Implicit grid tracks are created when items have positioned or resized (items: grid-column, grid-row) outside of the defined grid (container: grid-template-areas).
Implicit grid tracks will have 0 width by default until it's set.
Implicit grid tracks of 2 columns and 2 rows are set.
#+BEGIN_EXAMPLE
grid-template-columns: 60px 60px;
grid-tempalte-rows: 90px 90px;
/* 2x2 grids are created. 3 row lines and 3 column lines */
/* but item-b is out of bound */
.item-b {
 grid-column: 5 / 6; /* From the 5th column line to the 6th */
 grid-row: 2 / 3; /* From the 2nd row line to the 3rd */
}
/* It's 5x2 grids now. */
grid-auto-columns: 60px; /* the implicit grid tracks width is 60px but .item-b is auto */
grid-auto-rows: auto;
#+END_EXAMPLE

*** container: grid-auto-flow
<<<css:grid-auto-flow>>>
For items that are not positioned (items: grid-column, grid-row) nor 
put in a named area (items: grid-area) which is later used by container: grid-template-areas,
these items are "not explicitly placed on the grid".
Use this to control the auto placement
#+BEGIN_EXAMPLE
grid-auto-flow: row | column | row dense | column dense
/* row : fill rows first (default)
   column: fill columns first
   dense : fill smaller items first (order of items might change!)
*/
#+END_EXAMPLE

#+BEGIN_EXAMPLE
<section class="container">
  <div class="item-a">item-a</div>
  <div class="item-b">item-b</div>
  <div class="item-c">item-c</div>
  <div class="item-d">item-d</div>
  <div class="item-e">item-e</div>
</section>

.container { /* 5x2 */
  display: grid;
  grid-template-columns: 60px 60px 60px 60px 60px;
  grid-template-rows: 30px 30px;
  grid-auto-flow: row;
}
.item-a { /* 2x1 */
  grid-column: 1;
  grid-row: 1 / 3;
}
.item-e { /* 2x1 */
  grid-column: 5;
  grid-row: 1 / 3;
}
#+END_EXAMPLE

*** container: grid
css:grid-template-rows css:grid-template-columns css:grid-auto-flow
css:grid-auto-columns css:grid-auto-rows
#+BEGIN_EXAMPLE
grid: none | <grid-template-rows> / <grid-template-columns> | <grid-auto-flow> [<grid-auto-rows> [/ <grid-auto-columns>]];
#+END_EXAMPLE

*** item: grid-column-start, grid-column-end, grid-row-start, grid-row-end
<<<css:grid-column-start>>> <<<css:grid-column-end>>> <<<css:grid-row-start>>> <<<css:grid-row-end>>>

#+BEGIN_EXAMPLE
.item {
  grid-column-start: <number> | <name> | span <number> | span <name> | auto
  grid-column-end: <number> | <name> | span <number> | span <name> | auto
  grid-row-start: <number> | <name> | span <number> | span <name> | auto
  grid-row-end: <number> | <name> | span <number> | span <name> | auto
}
#+END_EXAMPLE

#+BEGIN_EXAMPLE
.item-a {
  grid-column-start: 2;
  grid-column-end: five; /* line-name */
  grid-row-start: row1-start;
  grid-row-end: 3;
}

.item-b {
  grid-column-start: 1;
  grid-column-end: span col4-start; /* span to a line-name */
  grid-row-start: 2;
  grid-row-end: span 2; /* span 2 rows */
}
#+END_EXAMPLE

*** <<<items: grid-column, grid-row>>>
css:grid-column-start css:grid-column-end css:grid-row-start css:grid-row-end

Position and resize an item
#+BEGIN_EXAMPLE
grid-column: <grid-column-start> / <grid-column-end>;
grid-row: <grid-row-start> / <grid-row-end>;
#+END_EXAMPLE

#+BEGIN_EXAMPLE
.item-c {
  grid-column: 3 / span 2;
  grid-row: third-line / 4;
}
#+END_EXAMPLE

*** <<<items: grid-area>>>
css:grid-template-areas

#+BEGIN_EXAMPLE
grid-area: <name> | <grid-row-start> / <grid-column-start> / <grid-row-end> / <grid-column-end>
#+END_EXAMPLE

*** item: justify-self, align-self
Used to overwrite grid container's css:justify-items, css:align-items

** Horizontal and Vertical Center
If both the parent and child are blocks, use flexbox.
For text
#+BEGIN_EXAMPLE
.center {
 height:200px;
 position:relative;
}
.center p {
 margin:0;
 position:absolute;
 top:50%;
 left:50%;
 transform: translate(-50%, 50%);
}
#+END_EXAMPLE

bs:Center Tags Vertically center span inside h1

Vertically align <img> and <span> inside <a>
#+BEGIN_EXAMPLE
a {
  line-height:20px;
  display:block;
  vertical-align:middle;
}
a img {
  height: 15px; /* let's say the img's height is 15px */
}
a span {
  display:inline-block;
  vertical-align:middle;
  line-height:1em;
}
#+END_EXAMPLE

** Column for text

#+BEGIN_EXAMPLE
<div>
 <h2>Title takes 2 columsn</h2>
 long text..
</div>
div {
 column-count: 3;
 column-gap: 40px;
 column-rule-style: solid; /* just like border */
 column-rule-width: 1px;
 column-rule-color: lightblue;
 column-rule: 1px solid lightblue;
}
div h2 {
 column-span: 2;
}

div.fixedWidth {
 columns: 200px; /* column-count will be auto */
 overflow-x: scroll;
 height: 600px; /* So that scrollbar shows on x axis */
}

#+END_EXAMPLE

** Shape
At the end of 2016, only Chrome, Safari, iOS and Android browswers support shape.

#+BEGIN_EXAMPLE
<div class="conainer">
  <img id="image" src="a.jpg">
  <p id="content">Long text</p>
</div>

img {
 display: block;
 float:left;
 width: 100%;
 height: auto;
 shape-outside: url(shape.png); /* polygon can be used */
 /* png has areas that are partially or completely transparent */
 shape-image-threshold: 0.9; /* The shape is any areas that have opacity greater than 0.9 */
 shape-margin: 20px; 
}

#+END_EXAMPLE

** SVG
xml header should be removed when used in HTML
#+BEGIN_EXAMPLE
<?xml version="1.0" encoding="utf-8"?>
#+END_EXAMPLE

*** Make SVG, Optimize SVG, IE 11
Exported from AI and [[http://petercollingridge.appspot.com/svg-optimiser][optimize it]]

Or use nodejs:svgo

IE 11 doesn't support url('a.svg') in background CSS. Use nodejs:svgo to convert to URL encoded.
#+BEGIN_EXAMPLE
div.svgbg {
  background-image:url('url-encoded-svg');
}
#+END_EXAMPLE

*** SVG as background image IE 11 <<<svg:ie11>>>
AI export .svg by default is responsive and no width and height attributes are in <svg>
You may add width and height to <svg> based on viewBox
#+BEGIN_EXAMPLE
// before
<svg viewBox="0 0 22.77 28.96">

// after
<svg viewBox="0 0 22.77 28.96" width="22.77" height="28.96">
#+END_EXAMPLE

If it still doesn't work, move <styles> to attributes

You need to export .svg in Adobe Illustrator using one of these mode for the Styling
- Presentation Attributes :: fill="none" stroke="#cfdf00" stroke-width="0.44"
- Inline Style :: style="fill:none;stroke:#cfdf00;stroke-width:0.4399999976158142px"

But not Internal Style.

If AI already exports the .svg, use nodejs:svgo:move styles

*** SVG as background image dynamic size
You can only control size in this method
#+BEGIN_EXAMPLE
.logo {
 background: url(logo.svg) no-repeat top left;
 background-size: contain;
 width: 100px;
 height: 82px;
}
#+END_EXAMPLE

*** <<<CSS in SVG>>>

Inline CSS
#+BEGIN_EXAMPLE
<svg xmlns="http://www.w3.org/2000/svg"
    xmlns:xlink="http://www.w3.org/1999/xlink">

    <style type="text/css" >
      <![CDATA[

        circle.myGreen {
           stroke: #006600;
           fill:   #00cc00;
        }
       circle.myRed {
          stroke: #660000;
          fill:   #cc0000;
       }

      ]]>
    </style>

    <circle  class="myGreen" cx="40" cy="40"  r="24"/>
    <circle  class="myRed"   cx="40" cy="100" r="24"/>
</svg>
#+END_EXAMPLE

External CSS

#+BEGIN_EXAMPLE
<?xml-stylesheet type="text/css" href="svg-stylesheet.css" ?>
<svg xmlns="http://www.w3.org/2000/svg"
    xmlns:xlink="http://www.w3.org/1999/xlink">
    <circle cx="40" cy="40" r="24"
       style="stroke:#006600; fill:#00cc00"/>
</svg>
#+END_EXAMPLE

Embedded CSS in SVG only affects the SVG not other elements in the global HTML if svg is not inline with global HTML.

Closed strokes forms shapes or path. Shapes or path's can be filled. And stroke (color) and stroke-width (default 1px when stroke is set) can be set.

*** SVG Zoom and Pan

#+BEGIN_EXAMPLE
<g id="parentGraphic">
 <rect />
 <text></text>
</g>

<!-- use copy an element -->
<use href="#parentGraphic" transform="translate(40, 30) scale(0.9)"></use>
#+END_EXAMPLE

#+BEGIN_EXAMPLE
<!-- Original -->
<svg currentScale="1" width="300px" height="200px" viewbox="0 0 300 200">
<!-- Don't use currentScale to zoom -->

<!-- Move down 200/200*25=25px and move right 300/300=50 px -->
<svg width="300px" height="200px" viewbox="-50 -25 300 200">

<!-- Enlarge 50% -->
<svg width="300px" height="200px" viewbox="0 0 150 100">

<!-- Enlarge 50%, move down 200/100*25=50px and move right 300/150*50=100px -->
<svg width="300px" height="200px" viewbox="-50 -25 150 100">

viewBox = <min-x> <min-y> <w> <h>
#+END_EXAMPLE

Assuming min-x and min-y is both 0
Original width and height is width and height (200x200)

50% smaller, just change w and h to w*2 and h*2

Now the circle radius is shrank from 100 to 50
You need to move down and right 50px

200/(w*2)*<min-y>=50
<min-y> = 50/200*(w*2)

<min-y> = -(target move down amount)/(svg width)*(w*(shrink factor))
<min-x> = -(target move right amount )/(svg height)*(h*(shrink factor))

** Use Cases
*** Fix parent height less than total children height
#+BEGIN_EXAMPLE
<div class="clearfix">
  <div style="">Div 1 doesn't float</div>
  <div style="float: left;">Div 2</div>
</div>

/* Solution 1 */
.clearfix::after {
 content: " ";
 display:block;
 clear:both;
 height:0;
}

/* Solution 2 */
.clearfix {
 display:inline-block;
 width:100%;
}
#+END_EXAMPLE

*** Image inside a div
Div's height is greater than img. add display:block in <img>
#+BEGIN_EXAMPLE
<div class="item">
    <img src="http://placehold.it/230x20/?text=6" style="display:block">
</div>
#+END_EXAMPLE

*** Transparent Image
#+BEGIN_EXAMPLE
<img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
 width="100" height="100">
#+END_EXAMPLE

*** Button Hover Double Quotes
#+BEGIN_EXAMPLE
<button class="button" style=""><span>Hover </span></button>
.button {
 display: inline-block;
 border-radius: 4px;
 background-color: #f4511e;
 border: none;
 color: #FFFFFF;
 text-align: center;
 font-size: 28px;
 padding: 20px;
 width: 200px;
 transition: all 0.5s;
 cursor: pointer;
 margin: 5px;
}
.button span {
 cursor: pointer;
 position: absolute;
 opacity: 0;
 top: 0;
 right: -20px;
 transition: 0.5s;
}
.button:hover span {
  padding-right: 25px; 
/*
push button text to left and create padding
for double quotes to push to the right of padding
*/
}
.button:hover span:after {
 opacity: 1;
 right: 0;
}
#+END_EXAMPLE

*** Text Label
Flair is a fixed font-size squared tag.

<span class="li-tag li-tag-color">Flair</span>
.li-tag{
  display:inline-block;
  margin-right: .5em;
  padding: 0 2px;
  border:1px solid;
  border-radius: 2px;
  font-size:x-small;
  white-space:nowrap;
  vertical-align:middle;
}
.li-tag-color{
  background-color:#f5f5f5;
  color: #555;
  border-color: #ddd;
}
.li-tag-red{
  background-color:#d9534f;
  color: #ffffff;
  border-color: #d9534f;
}

Vertical align inside h1, h2
h1 .li-tag, h2 .li-tag, h3 .li-tag {
  margin-top: -0.5em;
}

h1, h2 must have font-size defined

*** Button with icon on the left
#+BEGIN_EXAMPLE
// No space in button
<button class="li-button has-icon"><span><a href="">Youtube</a></span></button>

<style>
.li-button {
  display:inline-block;
  padding:0 8px 0 5.5px;
  border:solid 1px transparent;
  border-radius:.25em;
  background-color:#0072BC;
  color:#ffffff;
  vertical-align:middle;
  /* Overwrite default button styles */
  outline:0;
  text-decoration:none;
  cursor:none;
}
.li-button.has-icon::before {
  margin-right:6px;
  background:url(icon.svg) no-repeat;
  background-size:16px 12px;
  width:16px;
  height:12px;
  content:'';
  display:inline-block;
  vertical-align:middle;
}
.li-button span {
  vertical-align:middle;
  font-size:12px;
}
</style>
#+END_EXAMPLE

*** Vertical Line Separator in <li>

#+BEGIN_EXAMPLE
<ul class="ul">
  <li><a href="">1</a></li>
  <li><a href="">2</a></li>
</ul>

.ul li:last-child {
  margin-right: 5px;
}
.ul li:not(:first-child):before {
  content: "|";
  padding:0 5px;
}
#+END_EXAMPLE

*** Wrap h1 around a div on the right, float right sequence
#+BEGIN_EXAMPLE
<div class="div">
  <a href=""><img></a>
</div>
<h1>Long text...</h1>
.div {
  display:block;
  float:right;
}
h1 {
  clear: none; /* default is none */
}

/* Make it take the whole width */
@media (max-width: 425px) {
    .div {
        display:block;
        text-align: center;
        width:100%;
    }
}
#+END_EXAMPLE

#+BEGIN_EXAMPLE
<div id="div1" style="float:right"></div>
<div id="div2" style="float:right"></div>
<h1>...</h1>
<!-- Sequence: h1, div2, div1 -->
#+END_EXAMPLE

*** 100% width and with margin
The trick is not specify 100% width and set the margin
Or
#+BEGIN_EXAMPLE
margin-left: 15px;
/* width: 100% */
width calc(100% - 15px);
#+END_EXAMPLE

*** Align text with elements
Use flex
#+BEGIN_EXAMPLE
<div class="flex-r-w-fs-center">
  <div class="app-information-title p-r-10 p-t-5"><span>A Title</span></div>
  <div class="app-information-btns">
    <a href="#" role="button" class="btn btn-green-overnight" target="_blank">Sign up</a>
    <a href="#" role="button" class="btn btn-green-overnight">FAQs</a>
    <a href="#" role="button" class="btn btn-green-overnight" target="_blank">Learn more</a>
  </div>
</div>

.app-information-title {
  font-size:26px;
  font-family: 'tg-medium';
  font-weight: normal;
}
.app-information-title span{
  line-height:33px;
}
#+END_EXAMPLE

*** Circle Number List
#+BEGIN_EXAMPLE
.numberCircle {
    border-radius: 50%;
    behavior: url(PIE.htc); /* remove if you don't care about IE8 */

    width: 36px;
    height: 36px;
    padding: 8px;
    
    background: #fff;
    border: 2px solid #666;
    color: #666;
    text-align: center;
    
    font: 32px Arial, sans-serif; /* 32 + padding/2 = width = height */
}
#+END_EXAMPLE

#+BEGIN_EXAMPLE
<span style="font-size: 450%; color: #FF5722;">&#9312;</span>
#+END_EXAMPLE

#+BEGIN_EXAMPLE
<span class="step">1</span>

span.step {
  background: #cccccc;
  border-radius: 0.8em;
  -moz-border-radius: 0.8em;
  -webkit-border-radius: 0.8em;
  color: #ffffff;
  display: inline-block;
  font-weight: bold;
  line-height: 1.6em;
  margin-right: 5px;
  text-align: center;
  width: 1.6em; 
}
#+END_EXAMPLE

Just change the font size to enlarge/shrink the button. Or width, line-height and the border-radius to only affect the circle (border-radius = half of the width and line-height values)

*** superscript, subscript uneven line height
#+BEGIN_EXAMPLE
<p>Some Text <sup>OM</sup>Office Mark

p {
  line-height:1.5em; /* if line-height:0 doesn't work, try increase p line-height or lower sup font-size*/
}
sup {
  /* font-size:0.5em; */
  line-height:0;
}
#+END_EXAMPLE

*** Swap image in @media
css
#+BEGIN_EXAMPLE
.flex-r-w-fs-center-mq-r-w-sa-center {
  display:flex;
  flex-flow:row wrap;
  justify-content:flex-start;
  align-items:center;
}

.footer-logos > div {
  margin:15px 10px;
  background-color:red;
}
.footer-logos > div > div > img{
  display:block;
  margin:0 auto;
}

@media only screen and (max-width: 697px) {
  .footer-logos.flex-r-w-fs-center-mq-r-w-sa-center {
    justify-content:space-around;
  }
}

@media only screen and (max-width: 320px) {
  .footer-logos > div {
    width:100%;
    margin-top:2em;
  }

  .footer-logos .cs-i-1 {
    background:transparent url('http://placehold.it/137x42/?text=137x42') center center no-repeat;
    height:42px;
  }
  .footer-logos .cs-i-2 {
    background:transparent url('http://placehold.it/137x49/?text=137x49') center center no-repeat;
    height:49px;
  }
  .footer-logos .cs-i-3 {
    background:transparent url('http://placehold.it/137x64/?text=137x64') center center no-repeat;
    height:64px;
  }
  .footer-logos .cs-i-4 {
    background:transparent url('http://placehold.it/137x37/?text=137x37') center center no-repeat;
    height:37px;
  }
  .footer-logos .cs-items {
    margin:0.5em auto;
    width:137px;
  }
  .footer-logos .cs-items img {
    visibility:hidden;
  }

}
#+END_EXAMPLE

#+BEGIN_EXAMPLE
<div class="footer-logos flex-r-w-fs-center-mq-r-w-sa-center">
  <div>
    <div class="cs-items cs-i-1">
      <img src="http://placehold.it/81x25/?text=81x25" alt="#1 Logo"/>
    </div>
  </div>
  <div>
    <div class="cs-items cs-i-2">
      <img src="http://placehold.it/92x25/?text=92x25" alt="#2 Logo"/>
    </div>
  </div>
  <div>
    <div class="cs-items cs-i-3">
      <img src="http://placehold.it/54x25/?text=86x25" alt="#3 Hydro"/>
    </div>
  </div>
  <div>
    <div class="cs-items cs-i-4">
      <img src="http://placehold.it/70x25/?text=70x25" alt="#4 Logo"/>
    </div>
  </div>
</div>
#+END_EXAMPLE

*** Hightlight element when the hash and id of element match
#+BEGIN_EXAMPLE
:target {
  animation: contenthighlight 1s ease;
}
@keyframes contenthighlight {
  0% { border-left-color: red; }
  100% { border-left-color: white; }
}
#+END_EXAMPLE

* Bootstrap
** Mobile Meta Setup
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
// Put this as close to the <head> as possible
// To use the latest IE, chrome=1 is optional
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
// shrink-to-fit is for Safari
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
// Bootstrap css and js files are about 170kb
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" 
  integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" 
  crossorigin="anonymous">
</head>
<body>
<!-- HTML Code -->
<script
  src="https://code.jquery.com/jquery-1.12.4.min.js"
  integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
  crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" 
  integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" 
  crossorigin="anonymous"></script>
</body>
</html>

** Global
- box-sizing is border-box including *:before and *:after
- font-size 16px is declared on <html> and font-size:1rem on <body>
- BS3 default font-size is 14px
- <body> also sets global font-family and line-height
- <body> has background-color #fff
- bootstrap.js requries jQuery
- By default, flexbox is not enabled
- If flexbox is enabled:
  - entire grid system switches from float to flex
  - input groups move from table to flex
  - media components move from table to flex
  - After flex is enabled, you might have problems with IE9 and IE10

[[https://v4-alpha.getbootstrap.com/migration/][BS4 vs BS3]]

[[http://www.bootply.com][Hands on different versions of Bootstrap]]

** Content
*** Native font stack 
Switched from Helvetica Neue, Helvetica and Arial to:
- -apply-system (Safari for OS X and iOS)
- BlinkMacSystemFont (Chrome for OS X)
- Segoe UI (Windows)
- Robot (Android)
- Helvetica Neue, Arial, sans-serif !default;

*** h1, h2 heading elements
- heading elements :: margin-bottom: .5rem, no margin-top
- .h1 .h2 :: to imitate heading display without margins 
- Add .display-1, ..., .display-4 to change the size and display for <h1>, <h2>, etc.
- Add <small class="text-muted">secondary heading text</small> to <h1>
  - inline with text in <h1>, light color

*** <p>
- margin-bottom: 1rem, no margin-top
- Add .lead to <p> to make it more standout. 

*** Lists <ul> <ol> <dl>
- margin-bottom: 1rem, no margin-top
- Except nested lists
- add .list-unstyled to <ul>, <ol>. Only only apply for Level-1 children <li>
- add .list-inline to <ul, <ol> and .list-inline-item to li
- add .dl-horizontal to <dl>

*** Horinzontal Center (text, truncate, block)
- Add .text-center in column
- Add .center-block in column (margin:0 auto)
- Add .text-truncate in column can truncate text and provides ellipsis

*** Special Text
- <kbd> User input :: <kbd>cd</kbd>, <kbd><kbd>ctrl</kbd> + <kbd>,</kbd></kbd>
- <pre> has margin-top removed and add margin-bottom: 1rem;
- add .pre-scrollable to <pre> to set a max-height and make it horizontally scrollable
- <code>&lt;em&gt;</code> :: red text 
- <samp>&lt;em&gt;</samp>
- add .small to imitate <small> (normally it's 85% of parent font-size)
- <mark> light yellow
- <s>, <del> strike
- <ins> same as <u> underline
- <em>, <i> and <var> look the same 
- add .initialism to cap and make font size 90% <abbr title="full term">HTML</abbr>
- add .blockquote-reverse to <blockquote><p>...</p><footer>...</footer></blockquote> 

*** Vertical Align
- Only applies to inline, inline-block, inline-table and table cell
- .align-baseline, .align-top, .align-middle, .align-bottom
- .align-text-bottom, .align-text-top

*** Table
- Add class="table" to <table>
  - add .table-inverse (dark) to inverse color
  - add .table-striped to add color to even or odd row within <tbody>
  - add .table-bordered
  - add .table-hover
  - add .table-sm (or .table-condensed) to remove cell padding
  - add .table-reflow to transpose
- Add scope="row" to the first td (or th) in each <tr> inside <tbody>
- Add class="thead-inverse" or thead-default in <thead> to make table header dark or light
- Add colors to rows or individual cells. If table-inverse, use bg-* or text-*
  - .table-active (.active) :: light grey
  - .table-success (.success) :: light green
  - .table-info (.info) :: light blue
  - .table-warning (.warning) :: light yellow
  - .table-danger (.danger) :: light red
- Wrap table.table inside div.table-responsive to make table horizontal scrollable on small devices (under 768px)

*** Image
.img-responsive BS3 .img-fluid BS4

#+BEGIN_EXAMPLE
<!-- block, max-width: 100%; height: auto; -->
<img src="" class="img-responsive">

<!-- add .center-block to <img> to center .img-responsive -->

<!-- Or center an image as inline -->
<img src="" class="img-responsive img-circle" style="display:inline">
#+END_EXAMPLE

max-width and max-height

<div class="img-container" style="width:300px;height:168px;">
  <img src="...">
</div>
.img-container img {
  max-width: 100%;
  max-height: 100%;
}

Image shapes :: img-circle, img-rounded, img-thumbnail

*** Colors
text-muted, text-primary, -success, -info, -warning, -danger
             btn-primary, -success, -info, -warning, -danger
              bg-primary, -success, -info, -warning, -danger

*** Quick float content .pull-left, .pull-right
Not to be used in .navbar. Use .navbar-left or .navbar-right instead.

** Layout
*** Grid
#+BEGIN_EXAMPLE
<div class="container">
  <div class="row">
    <div class="col-*-*"></div>
  </div>
  <div class="row">
    <div class="col-*-*"></div>
    <div class="col-*-*"></div>
    <div class="col-*-*"></div>
  </div>
  <div class="row">
    ...
  </div>
</div>
#+END_EXAMPLE

For all sizes, 15px on each side of a column
.container has a fixed max-width based on different viewports.
.container-fluid takes 100% of the viewport width and the same as .container
.row is a horizontal group of columns. Only columns can be immediate children of rows.

15px on each side of a column

| BS4       |           |           |          |          |          |
|           | <576px    | >=576px   | >=768px  | >=992px  | >=1200px |
| Class     | .col-xs-  | .col-sm-  | .col-md- | .col-lg- | .col-xg- |
| container | none/auto | 540px     | 720px    | 960px    | 1140px   |
| max width |           |           |          |          |          |
|           |           |           |          |          |          |
| BS3       |           |           |          |          |          |
|           |           | <768px    | >=768px  | >=992px  | >=1200px |
| Class     |           | .col-xs-  | .col-sm- | .col-md- | .col-lg- |
| container |           | none/auto | 750px    | 970px    | 1170px   |
| max width |           |           |          |          |          |

col-lg-9 :: non large size will have 100% width
col-md-7 col-lg-9 :: small size and extra small will have 100% width
col-xs-9 col-md-7 :: large size will have 7 columns, small size will have 9 columns

728px :: requires (BS4) md-12, lg-9, xg-8; (BS3) sm-12, md-9, lg-8
300px :: requries (BS4) md-5, lg-4, xg-3; (BS3) sm-5, md-4, lg-3

When column has 100% width, margin-bottom is 25px

div.clearfix.visible-*-(block, inline-block) to prevent strange wrapping with uneven height content at certain viewport size

Offset Columns
col-md-offset-* :: increase the left margin of a column by n columns
Offset can be used to horizontally center a column
div.col-xs-offset-3.col-xs-6 :: to the left 3 columns, width 6 columns, to the right 3 columns
.col-xs-offset-3 carries forward to bigger size. In order to remove offset for larger sizes, add .col-sm-offset-0

Change Column Ordering
col-sm-push-*, col-sm-pull-* :: col-sm-push-8, col-sm-pull-4. Only at sm the columns are pushed/pulled.
This only works when elements can be floated in one row. When they are stacked, this trick doesn't work.

*** Responsive Utility
<<<bs:responsive utility>>>
- .hidden-*-down :: e.g. .hidden-md-down hides an element on xs, sm and md viewports
- .hidden-*-up :: .hidden-md-up hides an element on md, lg and xg viewports
- combine .hidden-*-down and .hidden-*-up to only show element for a specific viewport size
- .hidden-* :: * is xs, sm, lg, xl
- .hidden-print :: hide element for print device
- .visible-print-block :: only visible in print as display: block
- .visible-print-inline :: only visible in print as display: inline
- .visible-print-inline-block :: only visible in print as display: inline-block
- .visible-*-block, -inline, -inline-block where * is xs, sm, lg, xl

*** Media Object
Align media (image, video, audio) to the left or right of a content block

#+BEGIN_EXAMPLE
<div class="media">
  <!-- .media-middle, .media-bottom, default is top -->
  <!-- .media-left, .media-right -->
  <a class="media-left" href="#">
    <img class="media-object" src="..." alt="...">
  </a>
  <div class="media-body">
    <h4 class="media-heading">Media Heading</h4>
    Some Description...
    <!-- Nest another media object -->
  </div>
</div>
#+END_EXAMPLE

Put multiple li.media inside ul.media-list. Good for layout comments

** Utilities
*** Spacing Utility (Boostrap 4)
- m :: margin
- p :: padding
- t, b, l, r :: top, bottom, left, right
- x :: *-left and *-right
- y :: *-top and *-bottom
- a :: all 4 sides
- mt-0 :: margin top 0
- mx-auto :: same as .center-block

In Bootstrap 3, use .form-group to create margin-bottom: 15px

*** Responsive Utility
bs:responsive utility

*** Responsive helpers (embed and float)
<<<bootstrap:responsive helpers>>>
Apply to <iframe>, <embed>, <video> and <object> to maintain media size ratio

#+BEGIN_EXAMPLE
<div class="embed-responsive embed-responsive-16by9">
  <iframe class="embed-responsive-item" src="//www.youtube.com/embed/zpOULjyy-n8?rel=0" allowfullscreen></iframe>
</div>
#+END_EXAMPLE

BS3 4by3 and 16by9. BS4 added 21by9 and 1by1

Control floats based on viewport size breakpoint
float-xs-left, float-xs-right, float-xs-none

Raw CSS
#+BEGIN_EXAMPLE
<div class="videoWrapper-16-9">
  <!-- Copy & Pasted from YouTube -->
  <iframe width="560" height="349" src="http://www.youtube.com/embed/n_dZNLr2cME?rel=0&hd=1" frameborder="0" allowfullscreen></iframe>
</div>

.videoWrapper-16-9 {
  position: relative;
  padding-bottom: 56.25%; /* 16:9 */
  padding-top: 25px;
  height: 0;
}
.videoWrapper-16-9 iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}
#+END_EXAMPLE

*** Border (BS4)
- .rounded
- .rounded-circle
- .rounded-top, right, left, bottom

*** Text
<<<bs:text align>>>
- BS4 :: .text-*-left, .text-*-right, .text-*-center, * is xs, sm, md, lg, xl
- BS3 :: .text-justify, .text-left, right, center

Text nowrap :: .text-nowrap

Text color
- .text-muted
- .text-primary, -success, -info, ...

Font weight
- .font-weight-bold, .font-weight-normal
- .font-italic

** Components
*** Alert
Wrap text in div with .alert and one of the alert color class
- alert-success
- alert-info
- alert-warning
- alert-danger

100% width block with inner and outter spacing

Non-dismissible
#+BEGIN_EXAMPLE
<div class="alert alert-danger" role="alert">
  Some text with
  <a href="#" class="alert-link"> a link </a> 
  some other text
</div>
#+END_EXAMPLE

Dismissable
#+BEGIN_EXAMPLE
<div class="alert alert-warning alert-dismissible" role="alert">
  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
    <span aria-hidden="true">&times;</span>
  </button>
  <strong>Warning!</strong> Better check yourself, you're not looking too good.
</div>
#+END_EXAMPLE

*** Jumbotron
.page-header :: Extra space on top and some on bottom
#+BEGIN_EXAMPLE
<div class="page-header">
  <h1>Example page header <small>Subtext for header</small></h1>
</div>
#+END_EXAMPLE

Jumbotron :: 100% width
BS4 uses h.display-3, p.lead
#+BEGIN_EXAMPLE
<div class="jumbotron">
  <h1 class="display-3">Hello, world!</h1>
  <p class="lead">Text.</p>
  <hr class="my-2">
  <p>Another paragraph.</p>
  <p class="lead">
    <a class="btn btn-primary btn-lg" href="#" role="button">Learn more</a>
  </p>
</div>
#+END_EXAMPLE
*** Tag (BS4) Label (BS3)
<<<bs:tag>>>
Used in <button>, <h1> as inline element and in bs:list group 
<span class="tag tag-default">New</span>
<span class="label label-info">New</span>

tag-pill or badge in BS3 can collapse when there's no content
<span class="tag tag-pill tag-default">Default</span>

<<<bs:Center Tags>>> Vertically center span inside h1
h1,h2,h3 {
  vertical-align:middle;
}

h1>.tag, h2>.tag, h3>.tag {
  vertical-aign:middle;
  margin-top:-0.5em;
  font-size: 50%; /* default is 75%. Make the tag smaller */
}

*** Progress
Contextual classes :: progress-success, etc.
.progress-striped

BS4
#+BEGIN_EXAMPLE
<div class="text-xs-center" id="example-caption-4">Some Text appears on top progress bar</div>
<progress class="progress" value="75" max="100" aria-describedby="example-caption-4"></progress>
#+END_EXAMPLE

BS3 is more reliable..

Contextual classes :: progress-bar-success, etc.
.progress-bar-striped
Add .active to .progress-bar-striped to animate the stripes right to left

#+BEGIN_EXAMPLE
<div class="progress">
  <div class="progress-bar"
       role="progressbar"
       aria-valuenow="0"
       aria-valuemin="0"
       aria-valuemax="100"
       style="min-width: 2em;">
    0%
  </div>
</div>
<div class="progress">
  <div class="progress-bar"
       role="progressbar"
       aria-valuenow="2"
       aria-valuemin="0"
       aria-valuemax="100"
       style="min-width: 2em; width: 2%;">
    2%
  </div>
</div>

<!-- Align multiple .progress-bar's on one line in ratio -->
<div class="progress">
  <div class="progress-bar progress-bar-success" style="width: 35%">
    <span class="sr-only">35% Complete (success)</span>
  </div>
  <div class="progress-bar progress-bar-warning progress-bar-striped" style="width: 20%">
    <span class="sr-only">20% Complete (warning)</span>
  </div>
  <div class="progress-bar progress-bar-danger" style="width: 10%">
    <span class="sr-only">10% Complete (danger)</span>
  </div>
</div>
#+END_EXAMPLE

*** Button, Button Group
<<<bs:button>>>
Used in bs:nav bs:navbar
Add .btn.btn-default to <a>, <button> and <input>
Only button.btn can be used as button in nav

btn-default, btn-primary, btn-success, info, warning, danger

btn-lg, btn-sm, btn-xs

btn-block :: full width of parent

Add .active to .btn to show the button is pressed

Button with icon
#+BEGIN_EXAMPLE
<a href="#" class="btn btn-default btn-lg">
 <span class="glyphicon glyphicon-search"></span> Button Large
</a>
#+END_EXAMPLE

<<<bs:btn-group>>>
Use role="group" for .btn-group and .btn-group-vertical
div.btn-group to align <button>s horizontally without padding nor margin
div.btn-group-vertical to align <button>s vertically without padding nor margin

Use role="toolbar" for .btn-toolbar
When there're multiple div.btn-group or div.btn-group-vertical, use div.btn-toolbar to wrap them.

To group a bs:dropdown with <button>s, use div.btn-group to wrap the dropdown all together.

*** Form
<<<bs:form>>>
- .sr-only :: add to <label> to hide it
- .form-group :: add to <div> which wraps each form field to add margin-bottom
  - .form-group-lg, .form-group-sm :: sizing 

**** .form-control
- .form-control :: add to <input>, <select>, <textarea> to make it width 100%
- .form-control-file :: add to <input type=file> for 100% width 
  - input.form-control-lg, input.form-control-sm :: sizing (BS4)
  - input.input-lg, input.input-sm :: sizing (BS3) 

**** Help Text (after <input>)
- .form-text (.help-block) :: block-level help text. p.form-text or div.form-text
- .text-muted :: inline help text small.text-muted or span.text-muted
- aria-describedby attribute (may also refer to the feedback)

#+BEGIN_EXAMPLE
<div class="form-group">
  <label for="inputPassword">Password</label>
  <input type="password" id="inputPassword" class="form-control" aria-describedby="passwordHelpInline">
  <small id="passwordHelpInline" class="text-muted">
    Must be 8-20 characters long.
  </small>
</div>
#+END_EXAMPLE

**** .form-inline
- By default, <form> doesn't have to have any class
- .form-inline :: add to <form> and any form field to make it inline. Only works for md and above viewport sizes

**** Checkbox and Radio
- div.checkbox (.form-check BS4), div.radio (BS3 only)
- label.checkbox-inline (.form-check-inline BS4), label.radio-inline (BS3 only)
- label.form-check-label (BS4 only)
- input.form-check-input (BS4 only)

<div class="checkbox">
  <label>
    <input id="a" type="checkbox">
    Only one checkbox
  </label>
</div>

<div class="form-group">
 <label class="checkbox-inline">
    <input name="a" id="a1" type="checkbox">
    Checkbox #1
 </label>
 <label class="checkbox-inline">
    <input name="a" id="a2" type="checkbox">
    Checkbox #2
  </label>
</div>

**** .input-group
<<<bs:form:input-group>>>
Group multiple inputs of different types (or even text) in one line. Good for making very short form

#+BEGIN_EXAMPLE
<div class="form-group">
  <label class="sr-only" for="exampleInputAmount">Amount (in dollars)</label>
  <div class="input-group">
    <div class="input-group-addon">
      <input type="checkbox" checked>
    </div>
    <input type="text" class="form-control" id="exampleInputAmount" placeholder="Amount">
    <div class="input-group-addon">.00</div>
  </div>
</div>

<div class="form-group">
  <div class="input-group">
    <input type="text" class="form-control" placeholder="Search terms">
    <span class="input-group-btn">
      <button class="btn btn-default" type="submit">Go!</button>
    </span>
  </div>
</div>
#+END_EXAMPLE

**** Align fields in columns
Add .col-*-* to <label> and container of form field. Also add .control-label to <label>
<div class="form-group">
  <label class="col-sm-2 control-label" for="inputComments">Comments</label>
  <div class="col-sm-10">
    <textarea class="form-control" id="inputComments"></textarea>
  </div>
</div>

Align Submit button
<div class="form-group">
  <div class="col-sm-10 col-sm-offset-2">
    <input type="submit" class="btn btn-default" value="submit">
  </div>
</div>

Align checkbox/radio
<div class="form-group">
 <div class="col-sm-10 col-sm-offset-2">
   <label class="checkbox-inline">
      <input name="a" type="checkbox">
      Checkbox #2
   </label>
 </div>
</div>

**** Validation and Feedback
Add validation class to div.form-group to add color as a whole
- .has-success
- .has-warning
- .has-error
- .has-feedback

Validation feedback with icon and/or text (only input type=text)
- .has-feedback :: add to div.form-group
- .control-label :: add to <label>
- span.glyphicon.glyphicon-ok.form-control-feedback :: icon inside field (BS3)
- input.form-control-warning, -success, -danger :: icon inside field (BS4)
- div.form-control-feedback :: feedback in text

#+BEGIN_EXAMPLE
<div class="form-group has-feedback">
  <label class="control-label" for="inputName">Name</label>
  <input class="form-control" id="inputName" type="text" placeholder="Name">
  <span class="glyphicon glyphicon-ok form-control-feedback"></span>
</div>
#+END_EXAMPLE
*** Thumbnail (BS3)
div.thumbnail is a block with padding 4px and border 1px.
Place it inside a column for layout

*** List group
<<<bs:list group>>>
Used in bs:panel bs:list group

- Parent and child can be any HTML elements.
- <ul> <li> will not have hovering effect
- Add contextual classes to li.list-group-item 
  - list-group-item-success, info, warning, danger

#+BEGIN_EXAMPLE
<div class="list-group">
  <!-- may use .disabled, .active -->
  <li class="list-group-item disabled">
    <!-- may use bs:tag -->
    New Mails
    <span class="tag tag-default tag-pill float-xs-right">14</span>
  </li>

  <!-- BS4: link as a button, use <div> as parent -->
  <a class="list-group-item list-group-item-action">
    Dapibus ac facilisis in
  </a>

  <!-- BS3: link as a button, use <div> as parent -->
  <button type="button" class="list-group-item">
    Dapibus ac facilisis in
  </button>

  <!-- Custom Content BS3 -->
  <a href="#" class="list-group-item">
    <h4 class="list-group-item-heading">Heading</h4>
    <p class="list-group-item-text">...</p>
  </a>

  <!-- Custom Content BS4 -->
  <a href="#" class="list-group-item list-group-item-action">
    <h4 class="list-group-item-heading">Heading</h4>
    <p class="list-group-item-text">...</p>
  </a>

</div>
#+END_EXAMPLE

*** Panel (BS3 only)
<<<bs:panel>>>
3 rows layout 100% width with padding

Contextual classes: panel-success, ...

#+BEGIN_EXAMPLE
<div class="panel panel-default">

  <div class="panel-heading">
    <h2 class="panel-title">Title</h2>
  </div>

  <div class="panel-body">
    <p>Panel Content</p>
  </div>

  <!-- may add any HTML or BS components -->

  <div class="panel-footer">
    <a href="#">Some Action</a>
  </div>

</div>
#+END_EXAMPLE

.panel-collapse
- Expand and collapse a panel bs:collapse
- Place .panel-body inside .panel-collpse
- .list-group can replace .panel-body inside .panel-collapse

#+BEGIN_EXAMPLE
<!-- add role="tablist" and aria-multiselectable -->
<div class="panel-group"
     id="accordion"
     role="tablist"
     aria-multiselectable="true">

  <div class="panel panel-default">
    <!-- add role="tab" and id for each panel-heading -->
    <div class="panel-heading"
         role="tab"
         id="headingOne">
      <h4 class="panel-title">
        <!-- For each .panel-title
             - add regular bs:collapse action button with data-parent
        -->

        <!-- This panel opens initially -->
        <!-- no .collapsed in <a> means it expands initially -->
        <!-- aria-expanded="true" not false! -->
        <a role="button"
           data-toggle="collapse"
           data-parent="#accordion"
           href="#collapseOne"
           aria-expanded="true"
           aria-controls="collapseOne">
          Collapsible Group Item #1
        </a>
      </h4>
    </div>

    <!-- .collapse.in :: displays content initially -->
    <div id="collapseOne"
         class="panel-collapse collapse in"
         role="tabpanel"
         aria-labelledby="headingOne">
      <div class="panel-body">
        ...
      </div>
    </div>

  </div>

  <div class="panel panel-default">
    <div class="panel-heading" role="tab" id="headingTwo">
      <h4 class="panel-title">
        <!-- .collapsed :: collapse content initially -->
        <a class="collapsed"
           role="button"
           data-toggle="collapse"
           data-parent="#accordion"
           href="#collapseTwo"
           aria-expanded="false"
           aria-controls="collapseTwo">
          Collapsible Group Item #2
        </a>
      </h4>
    </div>

    <!-- .collapse :: hides content initially -->
    <div id="collapseTwo"
         class="panel-collapse collapse"
         role="tabpanel"
         aria-labelledby="headingTwo">
      <div class="panel-body">
        ...
      </div>
    </div>
  </div>

</div>
#+END_EXAMPLE

*** Card, Card Group, Card Deck (BS4)
<<<bs:card>>>
Panel is replaced by Card in BS4

#+BEGIN_EXAMPLE
<!-- add .card-inverse to make text color white.
     contextual classes :: card-primary, info, etc.
     outline color :: card-outline-primary, info, etc.
-->
<div class="card">

  <!-- .card-header in <h*> -->
  <h3 class="card-header">Featured</h3>
  <!--  header can have bs:nav, tabs or pills -->
  <!-- just add .card-header-tabs --->
  <div class="card-header">
    <ul class="nav nav-tabs card-header-tabs">
      ...
    </ul>
  </div>

  <!-- .card-img without -top or -bottom centers the image inside .card -->
  <img class="card-img-top" src="..." alt="Card image cap">
  <!-- Overlay content on image -->
  <div class="card-img-overlay">
    <h4 class="card-title">Image title</h4>
    <p class="card-text">...</p>
    <p class="card-text"><small class="text-muted">...</small></p>
  </div>

  <!-- Wrap text with .card-block -->
  <div class="card-block">
    <h4 class="card-title">Card title</h4>
    <p class="card-text">...</p>
    <!-- regular button -->
    <a href="#" class="btn btn-primary">Go</a>
  </div>

  <div class="card-block">
    <!-- .card-title and .card-subtitle in <h*> -->
    <h4 class="card-title">Card title</h4>
    <h6 class="card-subtitle text-muted">Support card subtitle</h6>
  </div>

  <!-- bs:list group -->
  <ul class="list-group list-group-flush">
    <li class="list-group-item">Cras justo odio</li>
    <li class="list-group-item">Dapibus ac facilisis in</li>
    <li class="list-group-item">Vestibulum at eros</li>
  </ul>

  <div class="card-block">
    <!-- .card-link -->
    <a href="#" class="card-link">Card link</a>
    <a href="#" class="card-link">Another link</a>
  </div>

  <img class="card-img-bottom" src="..." alt="Card image cap">

  <div class="card-footer">2 days ago</div>
  <!-- .card-header in <h*> -->
  <h3 class="card-footer">2 days ago</h3>

</div>
#+END_EXAMPLE

Card Group
- wrap all .card inside div.card-group
- each .card will have equal height with no spacing like in a table

Card Deck
- Like .card-group but with spacing
- wrap all .card inside div.card-deck
- if flex is not enabled, wrap div.card-deck with div.card-deck-wrapper

Card Columns
- Masonry
- Wrap all .card inside div.card-columns

*** Dropdown (js)
<<<bs:dropdown>>> For navigation purpose. 
Used in bs:nav bs:navbar bs:btn-group

#+BEGIN_EXAMPLE
<!-- .open :: dropdown state is always open -->
<div class="dropdown open">
  <!-- .dropdown-toggle turn something into a dropdown toggle -->
  <!-- data-toggle :: attach js dropdown event -->
  <button
    type="button" id="dropdownMenuButton"
    class="btn btn-secondary dropdown-toggle"
    data-toggle="dropdown"
    aria-haspopup="true"
    aria-expanded="false">
    Dropdown button <span class="caret"></span>
    <!-- BS4 does't have to define caret -->
  </button>
  
  <!-- BS4 no longer requires menu items to be <li><a /></li> but you have to use .dropdown-item -->
  <!-- <ul> <li> <a> are used in BS3 -->
  <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
    <h6 class="dropdown-header">Combo A (not selectable)</h6>
    <a class="dropdown-item" href="#">1</a>
    <a class="dropdown-item" href="#">2</a>
    <a class="dropdown-item" href="#">3</a>
    <!-- BS3 use .divider -->
    <div role="separator" class="dropdown-divider"></div>
    <h6 class="dropdown-header">Combo B (not selectable)</h6>
    <a class="dropdown-item" href="#">4</a>
    <!-- disabled -->
    <a class="dropdown-item disabled" href="#">5 (Sold out!)</a>
    <a class="dropdown-item" href="#">6</a>
  </div>
</div>
#+END_EXAMPLE

To group a bs:dropdown with <button>s, use div.btn-group to wrap the dropdown all together.

#+BEGIN_EXAMPLE
<div class="btn-group" role="group" aria-label="...">
  <button type="button" class="btn btn-info">Button #1</button>
  <button type="button" class="btn btn-info">Button #2</button>

  <!-- dropdown starts here -->
  <div class="btn-group" role="group">
    <button
      type="button"
      class="btn btn-info dropdown-toggle"
      data-toggle="dropdown"
      aria-haspopup="true"
      aria-expanded="false">
      Button #3: Dropdown
      <!-- BS4 doesn't need to manually add a caret -->
      <!-- <span class="caret"></span> -->
    </button>

    <!-- add ul.dropdown-menu mentioned above -->
  </div>

</div>
#+END_EXAMPLE

*** Navigation (js), tab (js)
**** .nav, .nav-tabs, .nav-pills, tablist (js)
<<<bs:nav>>> :: May use 
- bs:dropdown as a nav item
- bs:tab to show and hide content
- bs:scrollspy :: <a href="#home">

Items are blocks float to left or stacked vertically

#+BEGIN_EXAMPLE
<!-- nav-tabs or nav-pills -->
<!-- .nav-stacked :: add to ul -->
<!-- .nav-justified :: add to ul. Center tabs/pills -->
  
<ul class="nav nav-tabs">
  
  <!-- BS4 for <li> :: add .nav-item and remove role="presentation" -->
  <li role="presentation" class="active">
    <!-- BS4 for <a> :: add .nav-link -->
    <a href="#">Item 1</a>
  </li>
  <li role="presentation" class="disabled"><a href="#">Item 2</a></li>
  <li role="presentation"><a href="#">Item 3</a></li>

  <!-- Item can be a bs:dropdown -->
  <li role="presentation" class="dropdown">
    <button
      class="dropdown-toggle"
      data-toggle="dropdown"
      aria-haspopup="true"
      aria-expanded="false">
      Item 4
    </button>

    <ul class="dropdown-menu">
      ...
    </ul>
  </li>

</ul>
#+END_EXAMPLE

<<<bs:tab>>>
Display content when nav-tabs or nav-pills is clicked $().tab data-toggle="tab"
#+BEGIN_EXAMPLE
<!-- add role="tablist" -->
<ul class="nav nav-tabs"
    role="tablist"
    id="myTab">
  <!-- Be sure to add .active -->
  <!-- BS4 for <li> :: add .nav-item and remove role="presentation" -->
  <li role="presentation" class="active">
    <!-- <a> ::
         add role="tab", data-toggle="tab", aria-controls="..."
         BS4 :: add .nav-link
         may use data-target instead of href
     -->
    <a href="#item1"
       data-toggle="tab"
       role="tab"
       aria-controls="item1">Item 1</a>
  </li>


  <li role="presentation" class="active">
    <!-- <a> ::
         add role="tab", data-toggle="tab", aria-controls="..."
         BS4 :: add .nav-link
     -->
    <a href="#item1"
       data-toggle="tab"
       role="tab"
       aria-controls="item2">Item 2</a>
  </li>

</ul>

<div class="tab-content">
  <!-- effect :: .fade to div.tab-pane -->
  <div class="tab-pane active"
       id="item1"
       role="tabpanel">
    Item 1 content
  </div>

  <div class="tab-pane active"
       id="item2"
       role="tabpanel">
    Item 2 content
  </div>
</div>
#+END_EXAMPLE

**** Navbar (js)
<<<bs:navbar>>> is responsive
Use bs:collapse

div.collapse collpses at viewport <768px which is xs in BS3 and sm in BS4

Background image to navbar 
#+BEGIN_EXAMPLE
@media (min-width:768px) {
  .navbar {
    background:url('../images/nav-bg.jpg') center repeat-x #222;
    background-size:auto 100%;
  }
}

@media (max-width:768px) {
  .navbar .navbar-header{
    background:url('../images/nav-bg.jpg') center repeat-x #222;
    background-size:auto 100%;
  }
}
#+END_EXAMPLE

#+BEGIN_EXAMPLE
<!-- .navbar-fixed-bottom | .navbar-fixed-top :: add to <nav> if navbar is fixed -->
<!-- .navbar-default | .navbar-inverse (black and white) -->
<!-- customize color, border using .navbar-default -->
<nav class="navbar navbar-default">
  <!-- Without div.container, the navbar will align to left -->
  <div class="container">

    <!-- Add branding -->
    <div class="navbar-header">
      <!-- Style toggle button -->
      <button type="button"
              class="navbar-toggle"
              data-toggle="collapse"
              data-target="#myNavbar"
              aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <a class="navbar-brand" href="">Website Name</a>
      <!-- Add a logo in a.navbar-brand. Height should 20px. -->
      <p class="navbar-text">optional: extra text</p>
    </div>

    <!-- .collapse is display: none; -->
    <div class="collapse navbar-collapse" id="myNavbar">
      <ul class="nav navbar-nav">
        <li><a href="#">Submenu 1</a></li>
        <li><a href="#">Submenu 2</a></li>

        <!-- bs:dropdown -->
        <li>
          <a href="#"
             class="dropdown-toggle"
             data-toggle="dropdown"
             role="button"
             aria-haspopup="true"
             aria-expanded="false">Submenu 3</a>
          <ul class="dropdown-menu">
            ...
          </ul>
        </li>

      </ul> <!-- ul.navbar-nav ends -->

      <!-- Add extra text -->
      <p class="navbar-text">optional: extra text</p>

      <!-- Add a bs:button -->
      <button type="button" class="btn btn-default navbar-btn">sign in</button>

      <!-- Add a bs:form or bs:form:input-group -->
      <form class="navbar-form navbar-right" role="search">
        <div class="form-group">
          ...
        </div>
      </form>

    </div>
    <!-- div.collapse ends -->

  </div>
  <!-- div.container ends -->
</nav>
#+END_EXAMPLE

**** Breadcrumb
Simple align links horizontally

#+BEGIN_EXAMPLE
<ol class="breadcrumb">
  <li class="breadcrumb-item"><a href="#">Home</a></li>
  <li class="breadcrumb-item"><a href="#">Library</a></li>
  <li class="breadcrumb-item active">Data</li>
</ol>
#+END_EXAMPLE

**** Pagination and pager
Simply align links horizontally
BS3 recommends to replace <a> with <span> when li.disabled

#+BEGIN_EXAMPLE
<nav aria-label="Page navigation">
  <!-- .pagination-lg | .pagination-sm :: add to ul -->
  <ul class="pagination">
    <!-- li.disabled -->
    <li class="disabled">
      <a href="#" aria-label="Previous">
        <span aria-hidden="true">&laquo;</span>
      </a>
    </li>

    <!-- li.active -->
    <li class="active">
      <a href="#">1</a> <span class="sr-only">(current)</span>
    </li>

    <li><a href="#">2</a></li>
    <li><a href="#">3</a></li>
    <li><a href="#">4</a></li>
    <li><a href="#">5</a></li>

    <li>
      <a href="#" aria-label="Next">
        <span aria-hidden="true">&raquo;</span>
      </a>
    </li>
  </ul>
</nav>
#+END_EXAMPLE

Pager :: Simple Previous and Next buttons with no pages 
#+BEGIN_EXAMPLE
<!-- add <nav>, classes li.previous, li.next to align buttons to both ends -->
<!-- remove <nav>, classes li.previous, li.next to center them -->
<nav aria-label="...">
  <ul class="pager">
    <li class="previous disabled">
      <a href="#"><span aria-hidden="true">&larr;</span> Older</a>
    </li>
    <li class="next">
      <a href="#">Newer <span aria-hidden="true">&rarr;</span></a>
    </li>
  </ul>
</nav>
#+END_EXAMPLE

BS4 structure is a little different
- .page-item :: add to every <li>
- .page-link :: add to every li>a
- .disabled :: add to li and add tabindex="-1" to li>a. <a> will have pointer-events: none.
- Optionally remove <a> if li.disabled :: BS3 seems to recommend this behavior

*** Carousel (js)
Don't add data-ride if it's triggered by javascript

Pictures have to be the same width and height.

#+BEGIN_EXAMPLE
<!-- Options
data-interval :: 5000
data-pause :: "hover" | null
data-wrap :: true
keyboard :: true
-->
<div id="carousel-example-generic"
     class="carousel slide"
     data-ride="carousel">

  <ol class="carousel-indicators">
    <!-- An item must have .active -->
    <li data-target="#carousel-example-generic" data-slide-to="0" class="active"></li>
    <li data-target="#carousel-example-generic" data-slide-to="1"></li>
    <li data-target="#carousel-example-generic" data-slide-to="2"></li>
  </ol>

  <div class="carousel-inner" role="listbox">
    <!-- An item must have .active -->
    <!-- BS4 :: use .carousel-item instead of .item -->
    <div class="item active">
      <img src="..." alt="...">
      <div class="carousel-caption">
        <h3>...</h3>
        <p>...</p>
      </div>
    </div>

    <div class="item">
      <img src="..." alt="...">
      <div class="carousel-caption">
        ...
      </div>
    </div>

    <!--  more items -->
  </div>

  <!-- Controls -->
  <!-- data-slide could be
  prev, next, cycle, pause, number (integer starting from 0)
  -->
  <a class="left carousel-control"
     href="#carousel-example-generic"
     role="button"
     data-slide="prev">
    <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
    <span class="sr-only">Previous</span>
  </a>
  <a class="right carousel-control"
     href="#carousel-example-generic"
     role="button"
     data-slide="next">
    <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
    <span class="sr-only">Next</span>
  </a>

</div>

<script>
  $(function() {
    $('#carousel-example-generic').carousel({
      // options :: see above
    });
    /* Other methods refer to data-slide
    e.g. .carousel('cycle') ...
     */

    // Catch events
    // slide.bs.carousel :: start
    // slid.bs.carousel :: complete
    // Event object
    // direction :: 'left' | 'right'
    // relatedTarget :: DOM element that is about to be active
    $('#carousel-example-generic').on('slide.bs.carousel', function(e) {
     // do something
    });

  });
</script>
#+END_EXAMPLE

*** Modal (js)

#+BEGIN_EXAMPLE
<!-- When a modal is open, it adds .modal-open to <body> and also
      a .modalbackdrop to provide a click area to dismiss the modal
--->
<button type="button" class="btn btn-primary btn-lg"
        data-toggle="modal"
        data-target="#myModal">
  Launch demo modal
</button>

<!-- remove .fade to remove animation -->
<div class="modal fade"
     id="myModal"
     tabindex="-1"
     role="dialog"
     aria-labelledby="myModalLabel">

  <!-- Sizing :: in modal-dialog, add modal-lg, modal-sm -->
  <div class="modal-dialog" role="document">

    <div class="modal-content">

      <div class="modal-header">
        <button type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title" id="myModalLabel">Modal title</h4>
      </div>

      <div class="modal-body">
        <!-- stack .row to use grid -->
        <!-- Any HTML or BS components -->
        <!-- form field autofocus has no effect. Refer to javascript below -->
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-default"
                data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>

    </div>

  </div>

</div>

<script>
  /* Options :: data-*
     backdrop :: true. Use 'static' to not close the modal on click
     keyboard :: true. Esp key closes the modal
     show :: true. Show when initialized
     remote :: deprecated.
  */

  /* Methods
     .modal(options)
     method_name :: toggle, show, hide, and
     handUpdate (readjust positioning. Only needed if modal height changes while it opens)
     .modal('method_name')
  */

  /* Event types:
  show.bs.modal :: start.
  shown.bs.modal :: finished (after transition is complete)
  hide.bs.modal :: start to hide
  hidden.bs.modal :: finished being hidden
  loaded.bs.modal :: content has been loaded through remote option
     Event object
   e.relatedTarget :: If triggered by a click, it's the clicked element
   */
  $('#myModal').on('show.bs.modal', function(e) {
    // Using the same modal to display different content
    var button = $(e.relatedTarget);
    var data = button.data('lili-content');
    // Do some Ajax
    var modal = $(this);
    modal.find('.modal-title').text('...');
    modal.find('.modal-body').innerHTML = '...';

    <!-- form field autofocus has no effect. Use this workaround -->
    $('#fieldInputID').focus();
  });
</script>
#+END_EXAMPLE

*** Collapse (js)
<<<bs:collapse>>> :: Button to expand or collapse content
Used in bs:navbar bs:panel bs:card (accordion)

#+BEGIN_EXAMPLE
<!-- Action Button as <a> -->
<a class="btn btn-primary"
   role="button"
   data-toggle="collapse"
   href="#collapseExample"
   aria-expanded="false"
   aria-controls="collapseExample">
  Link with href
</a>

<!-- Action Button as <button> -->
<button class="btn btn-primary"
        type="button"
        data-toggle="collapse"
        data-target="#collapseExample"
        aria-expanded="false"
        aria-controls="collapseExample">
  Button with data-target
</button>

<!-- .collapse :: hide content initially -->
<div class="collapse" id="collapseExample">
  <!-- BS4 :: use .card.card-block instead of .well -->
  <div class="well">
    ...
  </div>
</div>
#+END_EXAMPLE

*** Tooltip (js)
Need to initiate in javascript

#+BEGIN_EXAMPLE
<button type="button" class="btn btn-default" 
        data-toggle="tooltip" 
        data-placement="left" 
        title="Tooltip on left">Tooltip on left</button>

<a href="#"
   data-toggle="tooltip"
   data-placement="bottom"
   title="">Tooltip on bottom</a>

<script>
  $('[data-toggle="tooltip"]').tooltip();
</script>
#+END_EXAMPLE

*** Popover (js)
Need to initiate in javascript
A title can be specified

data-trigger can be click | hover | focus | manual

#+BEGIN_EXAMPLE
<a tabindex="0"
   class="btn btn-lg btn-danger"
   role="button"
   data-toggle="popover"
   data-container="body"
   data-trigger="focus"
   title="Dismissible popover"
   data-content="And here's some amazing content. It's very engaging. Right?">
  Click on anywhere to dismiss the popover
</a>

<button type="button"
   class="btn btn-lg btn-danger"
   role="button"
   data-toggle="popover"
   data-trigger="focus"
   title="Dismissible popover"
   data-content="And here's some amazing content. It's very engaging. Right?">
  Must click on the button again to dismiss the popover
</button>

<script>
  $('[data-toggle="popover"]').popover();
</script>
#+END_EXAMPLE

*** Scrollspy (js)
Must use with bs:nav

#+BEGIN_EXAMPLE
<body data-spy="scroll" data-target="#navbar-example">
  ...
  <div id="navbar-example">
    <ul class="nav nav-tabs" role="tablist">
      ...
    </ul>
  </div>
  ...
</body>

<style>
body {
  position: relative;
}
</style>
#+END_EXAMPLE

** Mockup Tools
[[http://www.layoutit.com/][LayoutIt.com]] BS3
http://www.bootply.com/

** v4
*** Spacing
mt, pt
mx, p-x for left and right
my, py for top and bottom

size
m-0
m-1 to $spacer * .25
m-2 $spacer * .5
m-3 $spacer
m-4 $spacer * 1.5
m-5 $spacer * 3
m-auto

$spacer is 1 rem

*** flex
https://getbootstrap.com/docs/4.0/utilities/flex/

**** Use case
Left and right
#+BEGIN_EXAMPLE
<section class="search-bar">
  <div class="page-wrap container">
    <div class="d-flex flex-wrap align-items-center">
      <h1 class="mr-auto p-2 text-white text-uppercase">New And Used Inventory</h1>
      <a href="/admin" class="p-2 btn btn-light btn-sm bg-white text-primary" role="button">Adminstrator Login</a>
    </div>
  </div>
</section>
#+END_EXAMPLE

**** display
#+BEGIN_EXAMPLE
.d-flex
.d-inline-flex
.d-sm-flex
.d-sm-inline-flex
.d-md-flex
.d-md-inline-flex
.d-lg-flex
.d-lg-inline-flex
.d-xl-flex
.d-xl-inline-flex
#+END_EXAMPLE

**** flex-row
#+BEGIN_EXAMPLE
.flex-row
.flex-row-reverse
.flex-column
.flex-column-reverse
.flex-sm-row
.flex-sm-row-reverse
.flex-sm-column
.flex-sm-column-reverse
.flex-md-row
.flex-md-row-reverse
.flex-md-column
.flex-md-column-reverse
.flex-lg-row
.flex-lg-row-reverse
.flex-lg-column
.flex-lg-column-reverse
.flex-xl-row
.flex-xl-row-reverse
.flex-xl-column
.flex-xl-column-reverse
#+END_EXAMPLE

**** justify-content
#+BEGIN_EXAMPLE
.justify-content-start
.justify-content-end
.justify-content-center
.justify-content-between
.justify-content-around
.justify-content-sm-start
.justify-content-sm-end
.justify-content-sm-center
.justify-content-sm-between
.justify-content-sm-around
.justify-content-md-start
.justify-content-md-end
.justify-content-md-center
.justify-content-md-between
.justify-content-md-around
.justify-content-lg-start
.justify-content-lg-end
.justify-content-lg-center
.justify-content-lg-between
.justify-content-lg-around
.justify-content-xl-start
.justify-content-xl-end
.justify-content-xl-center
.justify-content-xl-between
.justify-content-xl-around
#+END_EXAMPLE

**** align-items
#+BEGIN_EXAMPLE
.align-items-start
.align-items-end
.align-items-center
.align-items-baseline
.align-items-stretch
.align-items-sm-start
.align-items-sm-end
.align-items-sm-center
.align-items-sm-baseline
.align-items-sm-stretch
.align-items-md-start
.align-items-md-end
.align-items-md-center
.align-items-md-baseline
.align-items-md-stretch
.align-items-lg-start
.align-items-lg-end
.align-items-lg-center
.align-items-lg-baseline
.align-items-lg-stretch
.align-items-xl-start
.align-items-xl-end
.align-items-xl-center
.align-items-xl-baseline
.align-items-xl-stretch
#+END_EXAMPLE

**** auto margin
#+BEGIN_EXAMPLE
<!-- all three left -->
<div class="d-flex">
  <div class="p-2">Flex item</div>
  <div class="p-2">Flex item</div>
  <div class="p-2">Flex item</div>
</div>

<!-- left right right-->
<div class="d-flex">
  <div class="mr-auto p-2">Flex item</div>
  <div class="p-2">Flex item</div>
  <div class="p-2">Flex item</div>
</div>

<!-- left left right -->
<div class="d-flex">
  <div class="p-2">Flex item</div>
  <div class="p-2">Flex item</div>
  <div class="ml-auto p-2">Flex item</div>
</div>
#+END_EXAMPLE

*** color
https://getbootstrap.com/docs/4.0/utilities/colors/

.bg-white
.text-white

primary :: blue
secondary :: grey
success :: green
danger :: red
warning :: yellow
info :: cyan
light :: light grey
muted :: darker grey similary to secondary

*** text
.text-lowercase
-uppercase
-capitalize

*** Popover
Require popper.js
Need to be initialized using javascript
#+BEGIN_EXAMPLE
// initialize all
$(function () {
  $('[data-toggle="popover"]').popover()
})

//
#+END_EXAMPLE

button not dismissable
#+BEGIN_EXAMPLE
<button type="button" 
 class="btn btn-lg btn-danger" 
 data-toggle="popover" 
 title="Popover title" 
 data-content="And here's some amazing content. It's very engaging. Right?">Click to toggle popover</button>
#+END_EXAMPLE

<a> dismissable (click somewhere else)
#+BEGIN_EXAMPLE
<a tabindex="0" 
   class="btn btn-lg btn-danger" 
   role="button" 
   data-toggle="popover" 
   data-trigger="focus" 
   title="Dismissible popover" 
   data-content="And here's some amazing content. It's very engaging. Right?">Dismissible popover</a>
#+END_EXAMPLE

Events
*.bs.popover
show, shown, hide, hidden, inserted
#+BEGIN_EXAMPLE
$('#myPopover').on('shown.bs.popover', function () {
  // do something…
})
#+END_EXAMPLE

Methods

trigger mode manual if you want to distinguish hover and click events
#+BEGIN_EXAMPLE
$('.action-call[data-toggle="popover"]').popover({trigger:'manual'})
    .on({
      mouseenter: function() {$(this).popover('show');},
      mouseleave: function() {$(this).popover('hide');},
      click: function() {window.open('tel:'+$(this).data('phone'));}
    });
#+END_EXAMPLE

* HTML
** DOM
*** Document Object
[[https://developer.mozilla.org/en/docs/Web/API/Document][Document properties and methods]]

| document.methodName() or     | Notes                                                    | Use in       |
| document.propertyName        |                                                          | Element Obj? |
|------------------------------+----------------------------------------------------------+--------------|
| createElement("p")           | appendChild                                              | no           |
| createTextNode("text node"); | appendChild                                              | no           |
| createAttribute('data-id')   | appendChild                                              | no           |
|                              |                                                          |              |
| getElementById("id")         | null or element object                                   | no           |
| getElementsByClassName       | NodeList                                                 | yes          |
| getElementsByTagName("p")    | NodeList                                                 | yes          |
| querySelector('#id')         | 1st matched element. null or exception or element object | yes          |
| querySelectorAll('#id')      | Static NodeList or exception                             | yes          |
|                              |                                                          |              |
| normalize()                  | remove empty text nodes and join adjacent text nodes     | yes          |
|                              |                                                          |              |

*** NodeList Object
<<<NodeList>>>
NodeList Object appears like an array (loop like an array) but cannot use Array Methods such as valueOf(), join(), forEach().

<<<Static NodeList>>> means changes to DOM have no effect.

All NodeList objects are live objects meaning changes
that are made in other code places reflect on all NodeList objects that were previously found.

var myNodeList = document.getElementsByTagName("P");
console.log(myNodeList.length); 
var firstP = myNodeList[0];
var firstP = myNodeList.item(0); // same as above, return null if not exists
var firstP = document.getElementsByTagName("p")[0]; // same as above

console.log(firstP.innerHTML);
firstP.style.backgroundColor = "red";

for (var i=0; i < myNodeList.length; i++) {
 myNodeList[i].style.backgroundColor = "red";
} 

Another way to loop NodeList

#+BEGIN_EXAMPLE
Array.prototype.forEach.call(
 aNodeListArray,
 function(item) {
  console.log(item.id);
 }
);
#+END_EXAMPLE

*** <<<Element Object>>>
[[https://developer.mozilla.org/en-US/docs/Web/API/Element][Element Properties and Methods]]

| element.methodName() or        | Notes                                           | Use in   |
| element.propertyName           |                                                 | Document |
|                                |                                                 | Object?  |
|--------------------------------+-------------------------------------------------+----------|
| accessKey                      | get/set accessKey                               |          |
| addEventListerner()            | refer to event attributes without 'on'          | yes      |
|                                | e.addEventListerner("click", myFunction,false ) |          |
|                                | false for bubbling, true for capturing          |          |
| removeEventListener()          | anonymous function will not work                | yes      |
|                                |                                                 |          |
| click()                        | simulate a click on an element                  | no       |
| blur()                         |                                                 | no       |
| focus()                        |                                                 | no       |
|                                |                                                 |          |
| innerHTML                      | get/set                                         | no       |
|                                |                                                 |          |
| appendChild(newChildNode)      | move element to the end of another element      | no       |
|                                | <<<appendChild>>>                               |          |
| removeChild(childNode)         |                                                 | no       |
| list.insertBefore(newnode,     |                                                 |          |
| list.childNodes[0])            |                                                 |          |
|                                |                                                 |          |
| <<<parentNode>>>               | read only                                       | no       |
| <<<parentElement>>>            | read only                                       | no       |
|                                |                                                 |          |
| .cloneNode()                   |                                                 |          |
|                                |                                                 |          |
| attributes                     | read only. NamedNodeMap                         | no       |
| getAttribute("class")          | attribute value in string                       | no       |
| getAttributeNode("class")      | Attr object                                     | no       |
|                                |                                                 |          |
| .childElementCount             | the number of child element nodes not text      |          |
|                                | and comment nodes                               |          |
| .childNodes                    | NodeList object. .childNodes.length             |          |
|                                | var c = e.childNodes[0].text                    |          |
| .children                      | exclude text and comment nodes.                 |          |
|                                | HTMLCollection object.                          |          |
| classList                      | read only. DOMTokenList                         | no       |
| className                      | get/set                                         | no       |
|                                |                                                 |          |
| clientHeight                   | height + padding, no border and scrollbar       | no       |
| clientWidth                    |                                                 | no       |
| clientTop                      | Top border width                                | no       |
| clientLeft                     | Left border width                               | no       |
| offsetWidth                    | width+padding+border+scrollbar but no margin    | no       |
| offsetHeight                   |                                                 | no       |
| .offsetLeft, offsetTop         | relative to offsetParent                        |          |
| .scrollHeight, .scrollWidth    | width+padding only                              |          |
| .scrollLeft, .scrollTop        | pixels are scrolled                             |          |
|                                |                                                 |          |
| e1.compareDocumentPosition(e2) | compare positions of elements                   |          |
| e1.contains(e2)                | if e2 is a descendant of e1                     |          |
| .contentEditable               |                                                 |          |
|                                |                                                 |          |
| .firstChild                    | child node                                      |          |
| .firstElementChild             | child element node                              |          |
| .nextSibling                   |                                                 |          |
| .nextElementSibling            |                                                 |          |
|                                |                                                 |          |
| .hasAttribute("onclick")       |                                                 |          |
| .hasAttributes()               | has any attributes?                             |          |
| .hasChildNodes()               | has any child nodes                             |          |
|                                |                                                 |          |
| .isEqualNode(e1,e2)            |                                                 |          |
|                                |                                                 |          |
| .nodeName                      | tag name                                        |          |
| .tagName                       | tag name in upppercase                          |          |
| .nodeValue                     |                                                 |          |
|                                |                                                 |          |

*** Event Object
Property
| type             | event name. e.g. mousedown                                 |
| timeStamp        | event occured                                              |
| bubbles          | true or false                                              |
| defaultPrevented | if method preventDefault() was called                      |
| currentTarget    | the element event happens on                               |
| target           | the (child) element event happens on                       |
| view             | get reference of the Window object where the event occured |
|                  |                                                            |

Method
| preventDefault()           | stop defeault event action                                            |
| stopImmediatePropagation() | stop other listerns of the same event (e.g. click) on the same target |
| stopPropagation()          | stop bubbling                                                         |

**** MouseEvent Object
| altKey        | whether ALT key was pressed                                                      |
| shiftKey      | whether Shift key was pressed                                                    |
| ctrlKey       | whether Ctrl key was pressed                                                     |
| button        | 0 left click, 1 middle, 2 right                                                  |
| which         | button + 1: 0: no button, 1 left, 2 middle, 3 right                              |
| buttons       | one or more buttons. More button such as browse back button.Safari not supported |
| clientX       | relative to current window (viewport).                                           |
| clientY       |                                                                                  |
| pageX         | relative to the fully rendered content area. Height might be larger than         |
| pageY         | viewport height.                                                                 |
| screenX       | relative to the screen. e.g. number of monitors and monitor screen               |
| screenY       |                                                                                  |
| relatedTarget | use with mouseover event to find the element the cursor jsut exited or           |
|               | with the mouseout event to find the element the cursor just entered              |

**** KeyboardEvent Object
Keyboard code (KC) - actual key on keyboard (always lowercase)
Unicode Character code (UCC) - result Unicode character (Shift + w = W, return the character code of W)

| altKey   | whether alt is pressed                         |
| ctrlKey  |                                                |
| shiftKey |                                                |
| metaKey  | whether meta is pressed. Windows key           |
| key      | key name on keyboard (F1,Enter..)              |
| keyCode  | keypress-0, keydown,keyup-UCC. All browsers.   |
| charCode | keypress-UCC, keydown,keyup-0. All browsers.   |
| which    | keypress-UCC, keydown,keyup-UCC. All browsers. |
| location | 4 numbers 0 - standard,1 - left,               |
|          | 2 - right (CTRL), 3 - numpad                   |
|          |                                                |

If you want to return UCC for all events cross all browsers use this:
var x = event.charCode || event.keyCode;

**** HashChangeEvent Object
newURL :: the URL after the hash has been changed
oldURL

**** PageTransitionEvent
For events: onpageshow and onpagehide
persisted :: whether the page was cached

**** FocusEvent Object
relatedTarget :: the element related to the element that triggered the event
event.relatedTarget.tagName;

**** AnimationEvent Object
animationName :: keyframe name
elapsedTime :: number of seconds the transition has been running

*** <<<DOMTokenList>>> Object
A collection of space-separated tokens.

| DOMTokenList.methodName() | Notes                                                            |
| or                        |                                                                  |
| DOMTokenList.propertyName |                                                                  |
|---------------------------+------------------------------------------------------------------|
| length                    | read only                                                        |
| add("class2Name")         |                                                                  |
| remove("class2Name")      |                                                                  |
| replace("old","new")      |                                                                  |
| toggle('class2Name')      | if exists, removes and return false. If not, add and return true |
| contains("class2Name")    |                                                                  |

*** <<<NamedNodeMap>>> Object
A collection of Attr object 's. Loopable like an Array but no Array methods.

*** <<<Attr Object>>>
An attribute node.

| name  |   |
| value |   |

** Global Attributes
Can be applied to any element
| accesskey       | Add shortcut. M-accesskey         |
| download        | filename. force download          |
| contenteditable | true or false. Become editable    |
| contextmenu     | right click menu. Only in Firefox |
| dir             | ltr, rtl or auto. text direction. |
| hidden          |                                   |
| spellcheck      | true or false                     |
| tabindex        | Tab button. 1 is first            |
| title           | tool tip                          |
|                 |                                   |

Drag-and-Drop

#+BEGIN_EXAMPLE
// ondropover allows this tag to receive dropped elements.
// ondrop defines what to do with the traferred data
<div id="div1" ondrop="drop(e)" ondragover="allowDrop(e)"></div>
// Make a tag draggable: draggable="true"
// <a> and <img> are by default draggable
// ondragstart defines what data to pass to ondrop
<img id="drag1" src="http://placehold.it/300x250" draggable="true" ondragstart="drag(e)">

<script>
function drag(e) {
  // Pass the dragged element id
  ev.dataTransfer.setData("text", ev.target.id);
}

function allowDrop(e) {
  e.preventDefault();
} 

function drop(e) {
  e.preventDefault();
  var data = e.dataTransfer.getData("text");
  e.target.appendChild(document.getElementById(data));
}
</script>
#+END_EXAMPLE

** Event Attributes
Capturing phrase: DOM heirarchy up
Bubbling phrase (default): DOM heirarchy down

These objects have implemented EventTarget interface which can receive events and may have listeners:
- element, document, window
- XMLHttpRequest, AudioNode, AudioContext and others

*** Windows Event in body tag
| onafterprint, onbeforeprint | only IE and FF                                |
| onbeforeunload              | before page is closed/refreshed               |
| onunload                    | after page is closed/refreshed                |
| onhashchange                | when URL hash is changed                      |
| onload                      | when an object is loaded:                     |
|                             | body, frame, frameset, iframe,                |
|                             | img, link, script, style                      |
|                             | Not run when it's loaded from cache           |
| onpageshow                  | similar to onload but always triggers         |
| onpagehide                  | similar to onunload but onunload event causes |
|                             | the page to not be cached.                    |
| onresize                    |                                               |
|                             |                                               |

*** Form Event Attributes
Also can be applied on almost all elements.

| oncontextmenu | right click to bring context menu                           |
| onreset       |                                                             |
| onsearch      | <input type="search" onsearch="">. IE and FF not supported  |
| onselect      | when text is selected in <input type="text"> or <textarea>  |
| onblur        | leave a form field. opposite of onfocus                     |
| onfocus       | opposite of onblur                                          |
| onfocusin     | similar to onfocus but bubbles. FF not supported            |
| onfocusout    | similar to onblur but bubbles.FF not supported              |
| onchange      | oninput and lose focus. also works on <select> and <keygen> |
| oninput       | not working on <select> and <keygen>                        |
|               |                                                             |

*** Mouse Events, Clipboard Events, Keyboard Events
| ondblclick   | double click                                      |
|              |                                                   |
| ondragstart  |                                                   |
| ondrag       | being dragged                                     |
| ondragend    |                                                   |
|              |                                                   |
| ondragenter  | when dragged element enters the drop target       |
| ondragover   | over the drop target                              |
| ondragleave  | leave the drop target                             |
| ondrop       | is dropped on the drop target                     |
|              |                                                   |
| onscroll     |                                                   |
| onwheel      | only Chrome and FF                                |
|              |                                                   |
| oncopy       |                                                   |
| oncut        |                                                   |
| onpaste      |                                                   |
|              |                                                   |
| onmousedown  |                                                   |
| onmouseenter | when move into child element                      |
| onmouseleave | when moving out of the element (not its children) |
| onmousemove  | when moving inside an element                     |
| onmouseover  | when onto this element                            |
| onmouseout   | when moving out of the element and its children   |
|              |                                                   |
| onkeydown    | evens are in order. works for all keys            |
| onkeypress   | Some keys are not fired: C, A, S, ESC, etc.       |
| onkeyup      | when releasing a key                              |

*** Media Events
Elements: audio, img, embed, object, video
Events in order:

| onloadstart      |   |
| ondurationchange |   |
| onloadedmetadata |   |
| onloadeddata     |   |
| onprogress       |   |
| oncanplay        |   |
| oncanplaytrhough |   |
|                  |   |

*** Animation Events
Refer to CSS @keyframes.
animationstart
animationend
animationiteration :: when animaiton repeats

*** Transition Event
transitionend

*** Misc events
| onerror | when an error occurs while loading an external file: <img> |

** Canvas
** Tags, HTML5 Elements
*** HTML Tags
| Tag      | Usage                             | Notes                                                     |
|----------+-----------------------------------+-----------------------------------------------------------|
| a        | download="filename"               | force download                                            |
| abbr     | title="World Health Organization" | abbreviation WHO                                          |
| address  |                                   | author or owner (not just address) of a document          |
|          |                                   | or an article. display:block, italic author               |
| base     | href,target                       | base url and target for <a> tags                          |
|          |                                   |                                                           |
| article  |                                   | affect outline                                            |
| aside    |                                   |                                                           |
| section  | headline tag is required          | affect outline                                            |
| main     | Use it once                       | not descendant of other tags                              |
| nav      |                                   | affect outline                                            |
|          |                                   |                                                           |
| cite     | <cite>U of T Professor</cite>     | wrap a person's title                                     |
| dfn      | <dfn>HTML</dfn> is ...            | A term to be defined                                      |
| mark     | highlight text                    | background yellow and text in black                       |
| s        |                                   | text-decoration: line-through                             |
| q        | <q cite="abc.com">Build</q>       | Double quotes                                             |
| ruby     | <ruby>a <rt>sound</rt></ruby>     |                                                           |
| wbr      | <wbr>alongword</wbr>              | the word will not be broken for line break                |
|          |                                   |                                                           |
| meter    | min,max,high,low,optimum          | value                                                     |
| progress | max, value                        |                                                           |
|          |                                   |                                                           |
|          |                                   |                                                           |
| colgrup, | specify styles and span for       |                                                           |
| col      | columns in a table                |                                                           |
|          |                                   |                                                           |
| iframe   | srcdoc=""                         | IE & Edge not supported. Repalce double quote with &quot; |
|          | sandbox=""                        | empty to apply all restrictions                           |
|          |                                   | e.g. allow-forms allow-same-origin                        |
| input    | autocomplete="on or off"          | default on. turn off for a specific field                 |
|          | autofocus=""                      |                                                           |
|          | formmethod="get or post"          | overwrite <form> type="submit, image"                     |
|          | formaction="another.php"          | overwrite <form> type="submit, image"                     |
|          | formenctype="multipart/form-data" | overwrite <form> type="submit, image"                     |
|          | formtarget="_blank"               | overwrite <form> type="submit, image"                     |
|          | min="1" max="1979-12-31"          | for type="date" or type="number"                          |
|          | multiple                          | for type="file"                                           |
|          | pattern="regex"                   | for type=text,date,search,url,tel,email,password          |
|          |                                   | escape " in regex with \x22                               |
|          | placeholder="hint"                |                                                           |
|          | step="3"                          | -3,0,3,6 can be accepted. type="number"                   |
|          | type=email, url                   |                                                           |
|          | required                          | no in IE                                                  |
|          | type="range" min max              | slide control                                             |
|          | type="search"                     |                                                           |
|          | disabled="disabled"               | not selectable, editable and not submitted                |
|          | readonly="readonly"               | selectable, not editable and get submitted                |
| samp     | sample computer output            |                                                           |
| code     | monospace                         |                                                           |
| kbd      | monospace                         |                                                           |
| var      | variable name                     |                                                           |
|          |                                   |                                                           |
| li       | value="100"                       | increment by 1                                            |
|          |                                   |                                                           |

*** Picture tag, <img srcset>
The srcset attribute (without sizes) is used to serve larger—but otherwise identical—image sources to high resolution displays only.
<img srcset="examples/images/image-384.jpg 1x, examples/images/image-768.jpg 2x" alt="…">

The srcset and sizes syntaxes are used to provide the browser with a list of image sources that are identical apart from their size (same aspect ratio, same focal point) and how they’ll be displayed, then allow the browser to choose the source best for the user’s current viewport size, display density, and the size of that image in the page layout.

In order to test img with srcset and sizes, you need to open InCognito and resize the window size not choosing a simulated device.

#+BEGIN_EXAMPLE
<img
sizes="(min-width: 40em) 80vw, 100vw"
srcset="examples/images/medium.jpg 375w,
        examples/images/large.jpg 480w,
        examples/images/extralarge.jpg 768w"
alt="…">
#+END_EXAMPLE

The picture element is used when you need explicit control over which source is shown at set viewport sizes.

#+BEGIN_EXAMPLE
<picture>
 <source srcset="a.jpg" media="(min-width: 600px)">
 <source srcset="b.jpg" media="(min-width: 500px)"> 
 <source srcset="fallback.jpg">
 <img src="fallback.jpg">
</picture>
#+END_EXAMPLE

img tag with srcset
small is 500x100, medium is 1000x200, and large is 2000x400
Device with screen width of 320px and 1x display (non-retina)
Then chooses the one that is closest to 1
500  / 320 = 1.5625
1000 / 320 = 3.125
2000 / 320 = 6.25

#+BEGIN_EXAMPLE
<img src="small.jpg" srcset="medium.jpg 1000w, large.jpg 2000w">
#+END_EXAMPLE

By default sizes="100vw", which is 100% viewport (320px in the above example)
Extra media query can be added 
#+BEGIN_EXAMPLE
sizes="(max-width: 300px) 100vw, 300px"
#+END_EXAMPLE

Which means if media query matches, use 100vw. If not match, use 300px

Responsive image which takes 100% width. Define the largest width image first
This is the wordpress way.
#+BEGIN_EXAMPLE
<img src="medium.jpg" width="1000" height="200" 
     srcset="large.jpg 2000w, small.jpg 500w"
     sizes="(max-width: 1000px) 100vw, 1000px">
// make sure img tag is responsive
img {
  max-width:100%;
  height:auto;
}
#+END_EXAMPLE

#+BEGIN_EXAMPLE
<picture>
  <source media="(max-width: 799px)" srcset="elva-480w-close-portrait.jpg">
  <source media="(min-width: 800px)" srcset="elva-800w.jpg">
  <img src="elva-800w.jpg" alt="Chris standing up holding his daughter Elva">
</picture>
#+END_EXAMPLE

*** Term/name in a list
#+BEGIN_EXAMPLE
<dl>
  <dt>Term #1</dt>
  <dd>Description of Term #1</dd>
  <dt>Term #2</dt>
  <dd>Description of Term #2</dd>
</dl>
#+END_EXAMPLE

** Video
MP4 is the most compatible video format. Uses H.264 video codec and AAC audio codec.
WebM is Google for HTML5. Uses VP8 video codec and Vorbis audio codec. Doesn't support in iOS, Safari nor old IE.
FLV is Flash only. Uses H.263 video codec and MP3 audio codec.

** Meta
*** Meta Refresh (redirect)
#+BEGIN_EXAMPLE
<meta http-equiv="refresh" content="0;URL='http://abc.com'" />
// "0" means zero second.
#+END_EXAMPLE

*** Open Graph Protocol
<<<html:og>>>
Required properties for every page
- og:title
- og:type :: article, video, video.movie, etc. Refer to [[http://ogp.me/#types][ogp types]]
- og:image
- og:url

<meta property="og:title" content="" />

** HTTP Header
All headers - https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers

*** Age
A non-negative integer of seconds that the object (response) has been in a proxy cache (CDN, Varnish)

*** Cache-Control
<<<header:cache-control>>>
https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control

- Directives
must-revalidate :: force to verify the status before using the cache and expired ones should not be used.
no-cache :: browser has to check Etag and makes a roundtrip request. If file in server is new, it will be downloaded.
no-store :: no cache should be stored in request or response
no-transform
public :: response can be cached in all devices
private :: response can be cached for a single user (user's browser) but not in shared cache (public CDN, Varnish)
proxy-revalidate
max-age=<seconds> :: 
post-check=0, pre-check=0 :: (Discouraged) Old IE does not cache and always ask from server

- Common usage
  - public, max-age=2592000 :: cache for a month
  - no-cache, must-revalidate, post-check=0, pre-check=0 :: no cache and always ask from server

*** Expires
When the response is considered stale.
Set to 0 means the response is expired.
If Cache-Control has max-age or s-max-age, Expires is ignored.

** Email
*** View email source on Outlook
Open the email, in Move tab under Message, Actions > Other Actions > View Source

*** Doctype
https://litmus.com/community/templates
#+BEGIN_EXAMPLE
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="robots" content="noindex, nofollow">
  <link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>

  <title>Product Update Hybrid</title>

  <style type="text/css">
    @import url(https://fonts.googleapis.com/css?family=Montserrat);
    body, table, td, a{-webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%;}
    table, td{mso-table-lspace: 0pt; mso-table-rspace: 0pt;}
    img{border: 0; height: auto; line-height: 100%; outline: none; text-decoration: none; -ms-interpolation-mode: bicubic;}
    table{border-collapse: collapse !important;}
    body{font-family: 'Montserrat', Arial, sans-serif; height: 100% !important; margin: 0 !important; padding: 0 !important; width: 100% !important;}
    
    /* https://github.com/seanpowell/Email-Boilerplate */

    div[style*="margin: 16px 0;"] { margin:0 !important; }

    a[x-apple-data-detectors] {
      color: inherit !important;
      text-decoration: none !important;
      font-size: inherit !important;
      font-family: inherit !important;
      font-weight: inherit !important;
      line-height: inherit !important;
    }
  </style>

  <!--[if mso]>
  <style type="text/css">
    .body-text {
      font-family: Arial, sans-serif !important;
    }
  </style>
  <![endif]-->

</head>
#+END_EXAMPLE

https://litmus.com/community/learning/24-how-to-code-a-responsive-email-from-scratch
Use XHTML 1.0 Transitional

#+BEGIN_EXAMPLE
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="format-detection" content="telephone=no"> 
<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=no;">
<meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE" />

    <title>Page title</title>

    <style type="text/css"> 
        @media screen and (max-width: 630px) {

        }
    </style>


</head>

<body style="padding:0; margin:0">

<table border="0" cellpadding="0" cellspacing="0" style="margin: 0; padding: 0" width="100%">
    <tr>
        <td align="center" valign="top">

        </td>
    </tr>
</table>

</body>
</html>
#+END_EXAMPLE

Style
#+BEGIN_EXAMPLE
<style>
  @import url(http://fonts.googleapis.com/css?family=Roboto:300); /*Calling our web font*/

  /* Some resets and issue fixes */
body, table, td, a{-webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%;}
      table, td{mso-table-lspace: 0pt; mso-table-rspace: 0pt;}
      img{border: 0; height: auto; line-height: 100%; outline: none; text-decoration: none; -ms-interpolation-mode: bicubic;}
      table{border-collapse: collapse !important;}
      body{font-family: 'Montserrat', Arial, sans-serif; height: 100% !important; margin: 0 !important; padding: 0 !important; width: 100% !important;}

  #outlook a{ padding:0; }
  .ReadMsgBody{ width:100%; }
  .ExternalClass{ width:100%; }
  .backgroundTable{ margin:0 auto; padding:0; width:100%; !important; }
  .ExternalClass *{ line-height:115%; }
  /* End reset */

  /* These are our tablet/medium screen media queries */
  @media screen and (max-width:630px){

    /* Display block allows us to stack elements */
    *[class="mobile-column"]{ display:block; }
    /* Some more stacking elements */
    *[class="mob-column"]{ float:none !important; width:100% !important; }
    /* Hide stuff */
    *[class="hide"]{ display:none !important; }
    /* This sets elements to 100% width and fixes the height issues too, a god send */
    *[class="100p"]{ width:100% !important; height:auto !important; }
    /* For the 2x2 stack */
    *[class="condensed"]{ padding-bottom:40px !important; display:block; }
    /* Centers content on mobile */
    *[class="center"]{ text-align:center !important; width:100% !important; height:auto !important; }
    /* 100percent width section with 20px padding */
    *[class="100pad"]{ width:100% !important; padding:20px; }
    /* 100percent width section with 20px padding left & right */
    *[class="100padleftright"]{ width:100% !important; padding:0 20px 0 20px; }
    /* 100percent width section with 20px padding top & bottom */
    *[class="100padtopbottom"]{ width:100% !important; padding:20px 0px 20px 0px; }

  }
</style>
#+END_EXAMPLE

*** Guidelines
[[https://www.campaignmonitor.com/dev-resources/guides/mobile][Campaign Monitor Mobile Design Guide]]

| Element   | Note                                                        |
|-----------+-------------------------------------------------------------|
| table     | always assign align, width,border, cellpadding, cellspacing |
| tr        | <tr style="padding:0;margin:0;line-height:0;" height="15">  |
|           | <td>&nbsp;</td>                                             |
|           | </tr> // empty row with height                              |
|           |                                                             |
| td        | Wrap text in td                                             |
|           |                                                             |
| Attribute |                                                             |
|-----------+-------------------------------------------------------------|
| style     | use =display: none!important;=                              |
|           |                                                             |

Inline text full width separator. Change attribute size and style height when needed.
#+BEGIN_EXAMPLE
<hr noshade color="#FFFFFF" width="100%" size="1" 
    style="padding:0; margin:8px 0 8px 0; border:none; width:100%; height: 1px; color:#FFFFFF; background-color: #FFFFFF" />
#+END_EXAMPLE

#+BEGIN_EXAMPLE
<h2 style="font-family: 'Montserrat', Arial, sans-serif; font-size:20px; line-height:26px; color:#222222; font-weight:bold; text-transform:uppercase; padding:0 20px; margin:0;">You've been invited to this years event</h2>
#+END_EXAMPLE

*** Responsive
#+BEGIN_EXAMPLE
<style>
.sectionContainer {
  background-color: #ffffff;
  padding-right:10px !important;
  padding-left:10px !important;
}
.sectionTable {
  background-color: #ffffff;
}
@media only screen and (max-width:640px) {
.sectionTable {
  max-width:640px !important;
  width:100% !important;
}
}
@media only screen and (max-width:480px) {
.sectionTable {
  max-width:480px !important;
  width:100% !important;
}
.sectionContent .s480-w0 {
  display:none !important;
}
} 
</style>

<table>
  <tr>
    <td class="sectionContainer">
      <table border="0" cellpadding="0" cellspacing="0" width="640" class="sectionTable">
        <tr style="padding:0;margin:0;line-height:0;" height="15"><td>&nbsp;</td></tr>
        <tr>
          <td align="center" valign="middle" style="background-color:#004663;color:#ffffff;margin:0;font-size:24px;font-family:Georgia;font-weight:normal;">
            Section #1  
          </td>
        </tr>
        <tr style="padding:0;margin:0;line-height:0;" height="10"><td>&nbsp;</td></tr>
        <tr>
          <td align="center" valign="top">
            
          </td>
        </tr>
      </table>
    <td>
  </tr>
</table>
#+END_EXAMPLE

*** Even 3 columns
#+BEGIN_EXAMPLE
<td align="center" valign="top" style="font-size:0;">
  <!--[if (gte mso 9)|(IE)]>
  <table align="center" border="0" cellspacing="0" cellpadding="0" width="600">
    <tr>
      <td align="left" valign="top" width="190">
  <![endif]-->
  <div style="display:inline-block; max-width:33.3333%; min-width:190px; vertical-align:top; width:100%;" class="mobile-wrapper">

    <table align="left" border="0" cellpadding="0" cellspacing="0" width="100%" style="max-width:190px;" class="max-width">
      <tbody><tr>
        <td align="center" valign="top" style="font-family: Open Sans, Helvetica, Arial, sans-serif; padding-top: 25px;">

          <img src="icon-shield.png" width="50" height="50" border="0" style="display: block;">

          <h3 style="font-size: 18px; line-height: 24px;">Gmail</h3>
          <p style="color: #999999; font-size: 14px; line-height: 20px;">
            Mandeville carneiro robbins goas ross kelly ragan rodriguez stig jordan hodgekiss merlin yeaman
            <br><br>
            <a href="http://litmus.com" target="_blank" style="text-decoration: none; color: #75b6c9;">Read more →</a>
          </p>

        </td>
      </tr>
      </tbody></table>
  </div>
  <!--[if (gte mso 9)|(IE)]>
  </td>
  <td width="15" style="font-size: 1px;">&nbsp;</td>
  <td align="left" valign="top" width="190">
  <![endif]-->
  <div style="display:inline-block; max-width:33.3333%; min-width:190px; vertical-align:top; width:100%;" class="mobile-wrapper">
    <table align="center" border="0" cellpadding="0" cellspacing="0" width="100%" style="max-width:190px;" class="max-width">
      <tbody><tr>
        <td align="center" valign="top" style="font-family: Open Sans, Helvetica, Arial, sans-serif; padding-top: 25px;">

          <img src="icon-cloud-lock.png" width="50" height="50" border="0" style="display: block;">

          <h3 style="font-size: 18px; line-height: 24px;">Outlook</h3>
          <p style="color: #999999; font-size: 14px; line-height: 20px;">
            Mandeville carneiro robbins goas ross kelly ragan rodriguez stig jordan hodgekiss merlin yeaman
            <br><br>
            <a href="http://litmus.com" target="_blank" style="text-decoration: none; color: #75b6c9;">Read more →</a>
          </p>

        </td>
      </tr>
      </tbody></table>
  </div>
  <!--[if (gte mso 9)|(IE)]>
  </td>
  <td width="15" style="font-size: 1px;">&nbsp;</td>
  <td align="left" valign="top" width="190">
  <![endif]-->
  <div style="display:inline-block; max-width:33.3333%; min-width:190px; vertical-align:top; width:100%;" class="mobile-wrapper">
    <table align="right" border="0" cellpadding="0" cellspacing="0" width="100%" style="max-width:190px; float: right;" class="max-width">
      <tbody><tr>
        <td align="center" valign="top" style="font-family: Open Sans, Helvetica, Arial, sans-serif; padding-top: 25px;">

          <img src="icon-key.png" width="50" height="50" border="0" style="display: block;">

          <h3 style="font-size: 18px; line-height: 24px;">Lotus</h3>
          <p style="color: #999999; font-size: 14px; line-height: 20px;">
            Mandeville carneiro robbins goas ross kelly ragan rodriguez stig jordan hodgekiss merlin yeaman
            <br><br>
            <a href="http://litmus.com" target="_blank" style="text-decoration: none; color: #75b6c9;">Read more →</a>
          </p>

        </td>
      </tr>
      </tbody></table>
  </div>
  <!--[if (gte mso 9)|(IE)]>
  </td>
  </tr>
  </table>
  <![endif]-->
</td>
#+END_EXAMPLE

*** My even 2 columns
#+BEGIN_EXAMPLE
@media only screen and (max-width:480px){
      td[class="articleBlockRightColumn"]{
        text-align:center !important;
      }      
      td[class="articleBlockLeftColumn"],
      td[class="articleBlockRightColumn"]{
        display:block !important;
        width:100% !important;
        padding-bottom:10px;
      }
}

$html_default = [
  'left'  => 'articleBlockLeftColumn',
  'right' => 'articleBlockRightColumn',
  'ad'    => 'bigAds',
];
?>
<table border="0" cellpadding="0" cellspacing="0" width="100%">
  <tr>
    <td align="left" valign="top" width="50%" class="<?php echo $html['left']; ?>">
      <table border="0" cellpadding="0" cellspacing="0" width="100%">
        <tr>
          <td align="left" valign="top">
            <h3>
              <a href="<?php echo $item['url']; ?>" target="_blank" style="text-decoration: none;">
                <?php
                print theme('nc_custom_templates_inline_native_article',
                  ['article' => $item]
                );
                echo $item['title'];?></a>
            </h3>
            <p><?php echo $item['summary']; ?> <?php
              if ($readmore['inline']) {
                print theme(
                  'nc_custom_templates_inline_read_more',
                  ['item' => $item,
                   'options'=> $readmore
                  ]);
              }
               ?></p>
            <?php
              if (!$readmore['inline']) {
                print theme(
                  'nc_custom_templates_inline_read_more',
                  ['item' => $item,
                   'options'=> $readmore
                  ]);
              }
            ?>
          </td>
        </tr>
      </table>
    </td>

    <td align="right" valign="top" width="50%" class="<?php echo $html['right']; ?>">
      <table border="0" cellpadding="0" cellspacing="0" width="100%">
        <tr>
          <td align="right" valign="top" class="<?php echo $html['ad']; ?>">
            <a href="<?php echo $dfp['a']; ?>">
              <img src="<?php echo $dfp['img']; ?>" />
            </a>
          </td>
        </tr>
      </table>
    </td>
  </tr>
  <tr><td>&nbsp;</td></tr>
</table>
#+END_EXAMPLE

*** My template
Presets
#+BEGIN_EXAMPLE
<?php
$_css_body = '-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%;width:100% !important; margin:0;padding:0';
$_css_preheader = 'display: none; font-size: 1px; line-height: 1px; max-height: 0px; max-width: 0px; opacity: 0; overflow: hidden;';

$_css_section_column = 'background-color:#ffffff;padding-right:10px !important;padding-left:10px !important;';
// It's ok to set td with padding-right and left if td will not display:block when it's in mobile
// If td will display:block, then wrap content with <table><tr><td style="padding: 1em"></td></tr></table> to set padding.
$_css_section_table = 'max-width:640px;';
$_css_section_top = 'padding-top:15px;';

 $_css_text_small = 'font-size:10px;color:#555555;font-family:Arial,Helvetica,sans-serif !important;';
  $_css_p = 'font-size:16px;line-height: 20px !important;margin: 1em 0;font-family: Arial, Helvetica, sans-serif;';
  $_css_h1 = 'font-family:Arial,Helvetica,sans-serif !important; font-size:30px; line-height:36px; font-weight:bold; color:#ffffff;padding:0; margin:0;';
  $_css_h2 = 'font-family:Arial,Helvetica,sans-serif !important;font-size:20px;line-height:26px; font-weight:bold; color:#ffffff;padding:0; margin:0;';
  $_css_h3 = 'font-family:Arial,Helvetica,sans-serif !important;font-size:16px;line-height:22px;font-weight:bold;color:#333333;padding:0; margin:0;';
  $_css_h3_a = 'font-family:Arial,Helvetica,sans-serif !important;font-size:16px;line-height:22px;font-weight:bold;color:#333333;padding:0; margin:0;text-decoration: none;';
  $_css_h4 = 'font-family:Arial,Helvetica,sans-serif !important;font-size:14px;line-height:20px;font-weight:bold;color:#333333;padding:0; margin:0;';
  $_css_h4_a = 'font-family:Arial,Helvetica,sans-serif !important;font-size:14px;line-height:20px;font-weight:bold;color:#333333;padding:0; margin:0;text-decoration: none;';
?>
<style type="text/css">
td[class="articleBlockFullColumn"] {
    padding-bottom:10px !important;
}

@media screen and (max-width:640px) {

}

@media only screen and (max-width: 480px) {
p {
    padding-left: 0px !important;
    padding-right: 10px !important;
}
td[class="mobilecenter"] {
  text-align: center !important;
}
td[class="articleImg"],
td[class="articleDiv"] {
      display:none;
}

}
</style>
#+END_EXAMPLE

Global
#+BEGIN_EXAMPLE
<body style="margin:0;padding:0;">
<table width="100%" height="100%" cellpadding="0" cellspacing="0" border="0" bgcolor="#F1F1F1">
  <tr>
    <td width="100%" valign="top" align="center">
      <div style="<?php echo $_css_preheader; ?>"><?php echo $_preview_text; ?></div>
      <center>
        <table width="100%" height="100%" cellpadding="0" cellspacing="0" border="0">
          <tr><td>Section 1</td></tr>
        </table>
      </center>
    </td>
  </tr>
</table>
</body>
#+END_EXAMPLE

Per section
#+BEGIN_EXAMPLE
<tr>
  <td align="center" valign="top" style="<?php echo $_css_section_column; ?>">
    <table border="0" cellpadding="0" cellspacing="0" width="100%" style="<?php echo $_css_section_table; ?>">
      <tr>
        <td align="center" valign="top" style="<?php echo $_css_section_top; ?>">
          <table border="0" cellpadding="0" cellspacing="0" width="100%">
            <?php // section title ?>
            <tr>
              <td align="left" valign="top">
                <h2 style="<?php echo $_css_section_title; ?>">Press Releases</h2>
                <hr noshade color="#eb1f2a" width="100%" size="1"
                    style="padding:0; margin:8px 0 8px 0; border:none; width:100%; height: 1px; color:#eb1f2a; background-color: #eb1f2a" />
              </td>
            </tr>
            <?php // section content ?>
            <tr>
              <td align="left" valign="top">
                <?php for ($i = 0; $i < count($_item); $i++) {
                              $content_item = $_item[$i];
                              print theme(
                                'nc_custom_templates_component_full_width',
                                [
                                  'item'     => $content_item,
                'readmore' => $readmore,
                'html'     => $full_width_html,
                ]
                );
                }
                ?>
              </td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
  </td>
</tr>
#+END_EXAMPLE

Section content
#+BEGIN_EXAMPLE
<?php
/**
 * Created by PhpStorm.
 * User: Li Li
 * Date: 8/3/2017 2:28 PM
 *
 * $html => [
 *   'row' => 'articleBlockFullColumn',
 *   'img' => [
 * 'class' => 'articleImg'],
 *   'ad' => 'bigAds',
 * ]
 */

$html_default = [
  'row' => 'articleBlockFullColumn',
  'h3' => 'color:#333333;font-weight:bold;font-size:20px;font-family:Arial,Helvetica,sans-serif !important;',
  'h3 a' => 'text-decoration: none;color:#333333',
	'p' => 'line-height: 20px !important;margin: 1em 0;font-family: Arial, Helvetica, sans-serif;',
  'img' => [
    'enable'  => 1, // To show article thumbnail if it has one?
    'class'   => 'articleImg',
    'w'       => 140,
    'h'       => 105,
    'style'   => 'width:140px; height:105px; vertical-align:top;',
    ],
  'div' => [
    'class' => 'articleDiv',
    'w' => 15,
  ],
];
?>

<table border="0" cellpadding="0" cellspacing="0" width="100%">
  <tr>
    <td align="left" valign="top" width="100%" class="<?php echo $html['row']; ?>">
      <table border="0" cellpadding="0" cellspacing="0" width="100%">
        <tr>
          <?php if (!empty($item['image']) && $html['img']['enable']): ?>
            <td class="<?php echo $html['img']['class']; ?>" align="center" valign="top">
              <a
                href="<?php echo $item['url']; ?>"
                target="_blank"><img alt=""
                                     src="<?php echo $item['image']; ?>"
                                     width="<?php echo $html['img']['w']; ?>"
                                     height="<?php echo $html['img']['h']; ?>"
                                     style="<?php echo $html['img']['style']; ?>"/></a>
            </td>
            <td class="<?php echo $html['div']['class']; ?>"
                width="<?php echo $html['div']['w']; ?>">&nbsp;</td>
          <?php endif; ?>

          <td align="left" valign="top">
            <h3 style="<?php echo $html['h3']; ?>"><a
                href="<?php echo $item['url']; ?>"
                target="_blank"
                style="<?php echo $html['h3 a']; ?>"><?php
                print theme('nc_custom_templates_inline_native_article',
                  ['article' => $item]
                );
                echo $item['title'];
                ?></a></h3>
            <p style="<?php echo $html['p']; ?>"><?php echo $item['summary']; ?> <?php
              if ($readmore['inline']) {
                print theme(
                  'nc_custom_templates_inline_read_more',
                  ['item' => $item,
                   'options'=> $readmore
                  ]);
              }
              ?>
            </p>
            <?php
            if (!$readmore['inline']) {
              print theme(
                'nc_custom_templates_inline_read_more',
                ['item' => $item,
                 'options'=> $readmore
                ]);
            }
            ?>
          </td>
        </tr>
      </table>
    </td>
  </tr>
  <tr><td>&nbsp;</td></tr>
</table>
#+END_EXAMPLE

Table with 1 col wrapper
#+BEGIN_EXAMPLE
$h_default = [
	'spacer' => '', // '' no spacer, top or bottom
	'content' => '',
	'align' => ['','right'], // first one is table then td
	'valign' => ['','top'],
	'class' => ['','mobilecenter'],
	'style' => ['',''],
];
?>
<table border="0" cellpadding="0" cellspacing="0" width="100%"
	<?php if ($h['align'][0]) {echo ' align="'.$h['align'][0].'"'; } ?>
	<?php if ($h['valign'][0]) {echo ' valign="'.$h['valign'][0].'"'; } ?>
	<?php if ($h['class'][0]) {echo ' class="'.$h['class'][0].'"'; } ?>
	<?php if ($h['style'][0]) {echo ' style="'.$h['style'][0].'"'; } ?>>
	<?php if (isset($h['spacer']) && $h['spacer'] == 'top'): ?>
		<tr><td>&nbsp;</td></tr>
	<?php endif; ?>
	<tr>
		<td <?php if ($h['align'][1]) {echo ' align="'.$h['align'][1].'"'; } ?>
			<?php if ($h['valign'][1]) {echo ' valign="'.$h['valign'][1].'"'; } ?>
			<?php if ($h['class'][1]) {echo ' class="'.$h['class'][1].'"'; } ?>
			<?php if ($h['style'][1]) {echo ' style="'.$h['style'][1].'"'; } ?>><?php echo $h['content']; ?></td>
	</tr>
	<?php if (isset($h['spacer']) && $h['spacer'] == 'bottom'): ?>
		<tr><td>&nbsp;</td></tr>
	<?php endif; ?>
</table>
#+END_EXAMPLE

Table with 2 cols
#+BEGIN_EXAMPLE
$_partnership_left  = theme(
  'nc_custom_templates_component_col_1',
  [
    'h' => [
      'spacer'  => '',
// '' no spacer, top or bottom
      'content' => "<a href='${_dfp_txt_1['href']}' target='_blank' style='ouline:none;display:inline-block;'><img src='${_dfp_txt_1['img']}' alt='' style='${_dfp_txt_1['img_style']}'></a>",
      'align'   => [ '', 'center' ],
// first one is table then td
      'valign'  => [ '', 'top' ],
      'class'   => [ '', 'mobilecenter' ],
      'style'   => [ '', 'padding: 0.4em' ],
    ],
  ]
);
$_partnership_right = theme(
  'nc_custom_templates_component_col_1',
  [
    'h' => [
      'spacer'  => '',
// '' no spacer, top or bottom
      'content' => "<h3 style='${_css_h3}'><a href='${_dfp_txt_1['href']}' target='_blank' style='${_css_h3_a}'>${_dfp_txt_1['title']}</a></h3>${_dfp_txt_1['content']}",
      'align'   => [ '', 'left' ],
// first one is table then td
      'valign'  => [ '', 'top' ],
      'class'   => [ '', '' ],
      'style'   => [ '', 'padding: 0.4em' ],
    ],
  ]
);
print theme(
  'nc_custom_templates_component_col_2',
  [
    'h' => [
      'table'   => [
        'align'  => '',
        'valign' => '',
        'class'  => '',
        'style'  => '',
      ],
      'spacer'  => '',
      'fixed'   => FALSE,
      'content' => [
        $_partnership_left,
        $_partnership_right
      ],
      'align'   => [ 'center', 'left' ],
      'valign'  => [ 'top', 'top' ],
      'class'   => [
        'partnershipBlockContentLeft',
        'partnershipBlockContentRight'
      ],
      'style'   => [ '', '' ], // padding: 0.4em
    ],
  ]
);
#+END_EXAMPLE

*** Inbox Preview
Litmus :: covers the most email clients and used by MailChimp and Campaign Monitor. Plus plan has Live Edit and Live Preivew
Email on Acid :: Basic plan covers unlimited tests. Fewer Android devices are supported compared with Litmus.

*** CSS and HTML Support across Devices
https://www.campaignmonitor.com/css/
https://templates.mailchimp.com/resources/email-client-css-support/

Gmail app is the only one doesn't support <style>

Gmail browser doesn't support <style> in <body> but supports <style> in <head>

<link> within <head> or <body> :: not support, browsers Outlook.com, Yahoo!, Gmail, AOL

@media :: not supported in
- Desktop :: Outlook 2007-16, Windows 10 Mail
- Mobile :: Gmail Android app IMAP, Gmail mobile wemail but supports in Gmail Android app, Gmail iOS app
- Webmail :: AOL Mail, Outlook.com

*** MJML
**** Install & Basics
#+BEGIN_EXAMPLE
npm install mjml

./node_modules/.bin/mjml -V

# To avoid typing ./node_modules/bin/
export PATH="$PATH:./node_modules/.bin"

# mjml version (e.g. 3.3.5)
mjml -V

# one time output html
mjml input.mjml

# one time output to a specific file
mjml input.mjml -o my-email.html

# watch a file
mjml -w input.mjml
#+END_EXAMPLE

Install Litmus Chrome Extension and follow the instructions to tweak the extension setting. Login to Litmus.com and open a local .html file.

Install Atom packages to edit .mjml in Atom: linter-mjml and mjml-preview

Tags or mj-elements styling
- a limited set of attributes can be used
- For now, must repeat for each tag the style you want to apply on it.
- Another way is to create custom component, sub-classing a standard one and have your styles defined by default.

[[https://mjml.io/try-it-live/templates/basic][Sample 1]]

**** <<<mjml:tag:mjml>>>
Contains mjml:tag:mj-head and mjml:tag:mj-body

**** <<<mjml:tag:mj-head>>>
Contains styles and meta elements. To insert custom head elements, registerMJHeadElement(<string> name, <funciton> handler) api from mjml-core

**** mj-head > mj-preview
<<<mjml:tag:mj-preview>>>
no other attributes
#+BEGIN_EXAMPLE
<mj-head>
    <mj-preview>Hello MJML</mj-preview>
</mj-head>
#+END_EXAMPLE

**** mj-head > mj-attributes
<<<mjml:tag:mj-attributes>>>
mj-all sets default attributes for every component inside your MJML document
Order: inline attributes > classes > default mj-attributes > defaultMJMLDefinition

#+BEGIN_EXAMPLE
<mjml>
  <mj-head>
    <mj-attributes>
      <mj-text padding="0" />
      <mj-class name="blue" color="blue" />
      <mj-class name="big" font-size="20px" />
      <mj-all font-family="Arial" />
    </mj-attributes>
  </mj-head>
  <mj-body>
    <mj-container>
      <mj-section>
        <mj-column>
          <mj-text mj-class="blue big">
            Hello World!
          </mj-text>
        </mj-column>
      </mj-section>
    </mj-container>
  </mj-body>
</mjml>
#+END_EXAMPLE

**** mj-head > mj-style
<<<mjml:tag:mj-style>>>
mj-style to apply styles to generated or native HTML elements
inline="inline" to set class in native HTML elememts
#+BEGIN_EXAMPLE
<mjml>
  <mj-head>
    <mj-style>
      @media all and (max-width: 480px) { div[style*="color:#F45e46;"] { text-align: center !important } }
    </mj-style>
    <mj-style inline="inline">
      .link-nostyle { color: inherit; text-decoration: none }
    </mj-style>
  </mj-head>
  <mj-body>
    <mj-container>
      <mj-section>
        <mj-column>

          <mj-image width="100" src="/assets/img/logo-small.png"></mj-image>

          <mj-divider border-color="#F45E43"></mj-divider>

          <mj-text font-size="20px" color="#F45e46" font-family="helvetica">
            Hello <a href="https://mjml.io" class="link-nostyle">World</a>
          </mj-text>

        </mj-column>
      </mj-section>
    </mj-container>
  </mj-body>
</mjml>
#+END_EXAMPLE

Target iPhone 5 and above mjml:tag:mj-hero:sample1
#+BEGIN_EXAMPLE
@media all and (max-width: 414px) {
  table[style*="color:#123456;"] { width:100%;}
  td[style*="font-family:Khand, Helvetica, sans-serif, Arial;font-size:18px;line-height:28px;color:#666465;"] {
    color: #000000 !important;
    background-color: rgba(255,255,255,0.5) !important;
  }
  tr.spacer-above-button {
     height:50px;
  }
}
#+END_EXAMPLE

Use css-class in any mj-element and change styles for mobile
#+BEGIN_EXAMPLE
<mj-style>
  @media ... {
    tr[class*="hidden"] {
      display:none;
    }
  }
<mj-style>
<mj-text css-class="hidden">
#+END_EXAMPLE

**** mj-head > mj-font 
<<<mjml:tag:mj-font>>>
#+BEGIN_EXAMPLE
<mjml>
  <mj-head>
    <mj-font name="Raleway" href="https://fonts.googleapis.com/css?family=Raleway" />
  </mj-head>
  <mj-body>
    <mj-container>
      <mj-section>
        <mj-column>
          <mj-text font-family="Raleway, Arial">
            Hello World!
          </mj-text>
        </mj-column>
      </mj-section>
    </mj-container>
  </mj-body>
</mjml>
#+END_EXAMPLE

**** mj-head > mj-title 
<<<mjml:tag:mj-title>>>
#+BEGIN_EXAMPLE
<mj-head>
  <mj-title>Hello MJML</mj-title>
</mj-head>
#+END_EXAMPLE

**** mj-head > mj-body > mj-container
<<<mjml:tag:mj-body>>> <<<mjml:tag:mj-container>>>
To insert custom elements either registerMJElement(<MJMLElement> class) api from mjml-core or via .mjmlconfig file.
Non-known element from mjml-core are ignored.
It should have only one root element which usually is mjml-container, which contains the entire content of your document.

mj-container was mj-body in version 1.x
- width :: unit px, default 600px
- background-color
- css-class :: rendered HTML is class="xx"

Inside container, you can have include, section and/or wrapper

**** mj-container > mj-include
<<<mjml:tag:mj-include>>>
Inside mjml > mj-body > mj-container
<mj-include path="./header" /> <!-- or 'header.mjml' -->

**** mj-container > mj-section
<<<mjml:tag:mj-section>>>
It should contain mj-column. Up to 4 columns.
Section has up to 600px width.

https://mjml.io/documentation/#mjml-section

Structure the columns in the order you want them to stack on mobile, then use direction attribute to change the order on desktop.

- direction :: ltr or rtl, default ltr
- padding :: default 20px 0
- padding-top, padding-x
- background-url :: default n/a
- background-repeat :: default repeat, no-repeat
- background-color :: default n/a,

**** mj-container > mj-wrapper
<<<mjml:tag:mj-wrapper>>>
Wrap multiple sections. Perfect place to set borders

https://mjml.io/documentation/#mjml-wrapper

- padding :: default 20px 0
- padding-top, padding-x
- direction :: default ltr, ltr / rtl
- vertical-align :: default top
- text-align :: default center
- full-width :: always define full-width="full-width", and don't have it in sections that the wrapper wraps.
  - I also find out if there are other sections that are also inside mj-container, define full-width only for that wrapper and don't define it for other sections

#+BEGIN_EXAMPLE
<mjml>
  <mj-body>
    <mj-container>
      <mj-section></mj-section>
      <mj-wrapper border="1px solid #000000" padding="50px 30px">
        <mj-section border-top="1px solid #aaaaaa" border-left="1px solid #aaaaaa" border-right="1px solid #aaaaaa" padding="20px">
          <mj-column>
            <mj-image padding="0" src="https://placeholdit.imgix.net/~text?&w=350&h=150" />
          </mj-column>
        </mj-section>
        <mj-section border-left="1px solid #aaaaaa" border-right="1px solid #aaaaaa" padding="20px" border-bottom="1px solid #aaaaaa">
          <mj-column border="1px solid #dddddd">
            <mj-text padding="20px"> First line of text </mj-text>
           <mj-divider border-width="1px" border-style="dashed" border-color="lightgrey" padding="0 20px" />
            <mj-text padding="20px"> Second line of text </mj-text>
          </mj-column>
        </mj-section>
      </mj-wrapper>
    </mj-container>
  </mj-body>
</mjml>
#+END_EXAMPLE

***** mj-container > <<<mjml:tag:mj-column>>>
Any mj-element included in a column will have a width equals to 100% of this column's width. e.g. mj-text

Inside a column, any standard element, or the ones you've defined and registered can be included.

But don't include another column or section.

- background-color :: default n/a

******** Auto sizing
2 columns, each column 50%, 3 columns each is 33%, etc.

******** Manual sizing
#+BEGIN_EXAMPLE
<mj-column width="300px">
 <!-- First column content -->
</mj-column>
<mj-column> 
 <!-- Second column content -->
</mj-column>
#+END_EXAMPLE

Once one column's width is set, you have to set manually each column size.

Always keep in mind that the maximum space to end up with a responsive layout is 600px.

- vertical-align :: default top, can be middle/bottom
- width :: default (100/number of columns %)

No padding is set by default

***** mj-container > <<<mjml:tag:mj-hero>>>
#+BEGIN_EXAMPLE
<mj-container>
  <mj-hero mode="fluid-height" background-width="600px" background-height="469px" background-url="https://via.placeholder.com/600x469/?text/600x469" background-color="#2a3448" padding="100px 0px">
    <!-- To add content like mj-image, mj-text, mj-button ... use the mj-hero-content component -->
    <mj-hero-content width="100%">
      <mj-text padding="20px" color="#ffffff" font-family="Helvetica" align="left" font-size="45" line-height="45px" font-weight="900">
        GO TO SPACE
      </mj-text>
      <mj-button href="https://mjml.io/" align="left">
        ORDER YOUR TICKET NOW
      </mj-button>
    </mj-hero-content>
  </mj-hero>
</mj-container>
#+END_EXAMPLE

Always specify background-color
mode :: fluid-height or fixed-height

#+BEGIN_EXAMPLE
<mj-container>
  <mj-hero mode="fixed-height" height="469px" background-width="600px" background-height="469px" background-url="https://via.placeholder.com/600x469/?text/600x469" background-color="#2a3448" padding="100px 0px">
    <!-- To add content like mj-image, mj-text, mj-button ... use the mj-hero-content component -->
    <mj-hero-content width="100%">
      <mj-text padding="20px" color="#ffffff" font-family="Helvetica" align="center" font-size="45" line-height="45px" font-weight="900">
        GO TO SPACE
      </mj-text>
      <mj-button href="https://mjml.io/" align="center">
        ORDER YOUR TICKET NOW
      </mj-button>
    </mj-hero-content>
  </mj-hero>
</mj-container>
#+END_EXAMPLE

mj-hero can be a mj-section <<<mjml:tag:mj-hero:sample1>>>
#+BEGIN_EXAMPLE
<mj-hero
  mode="fluid-height"
  height="420px"
  background-width="600px"
  background-height="420px"
  background-url="http://600x420.jpg"
  background-color="#FFFFFF"
  padding="0px">
  <mj-hero-content width="100%">
    <mj-text font-size="18px" font-family="Khand, Helvetica, sans-serif, Arial" font-weight="900">
      Title aligned to left
    </mj-text>
    <mj-table width="55%" color="#123456">
      <tr style="list-style: none;line-height:1">
        <td style="font-family:Khand, Helvetica, sans-serif, Arial;font-size:18px;line-height:28px;color:#666465;">
          This text aligned to the left and takes 55% width
        </td>
      </tr>
    </mj-table>
    <mj-spacer height="20px" css-class="spacer-above-button" />
    <mj-button background-color="#FF0025" font-size="16px" align="left" font-family="'Merriweather Sans', Helvetica, sans-serif, Arial" padding-left="25px">
      Learn more
    </mj-button>
    <mj-spacer height="20px" />
    <mj-text font-size="14px" font-weight="900" font-family="'Merriweather Sans', sans-serif;">
      Phone number&nbsp;&nbsp;&nbsp;<a href="http://a.com" style="color:#000000;text-decoration:none;">a.com</a>
    </mj-text>
    <mj-social color="#333333" align="left" text-mode="false" icon-size="16px" padding-left="25" padding-bottom="10" padding-top="10" mode="horizontal" display="linkedin:url facebook:url twitter:url youtubec:url" linkedin-href="https://www.linkedin.com/"
               linkedin-content=" "
               linkedin-icon-color="#A7A6A4" facebook-href="https://www.facebook.com/" facebook-content=" "
               facebook-icon-color="#A7A6A4"
               twitter-href="https://twitter.com/"
               twitter-content=" "
               twitter-icon-color="#A7A6A4" youtubec-href="https://www.youtube.com/"
               youtubec-content=" "
               youtubec-icon-color="#A7A6A4" youtubec-icon="http://16x16.jpg" />
    <mj-spacer height="30px" />
  </mj-hero-content>
</mj-hero>
<mj-section>
...
</mj-section>
#+END_EXAMPLE

**** mj-elements inside mj-column
***** mj-text
<<<mjml:tag:mj-text>>>
It can contain any HTML tag with any attributes.

- padding :: default 10px 25px
- line-height :: default 22px
- color :: default #000000
- font-family :: default Ubuntu, Helvetica, Arial, sans-serif
- font-size :: 13px
- align :: left

#+BEGIN_EXAMPLE
<mj-section background-color="#f0f0f0">
  <mj-column>
    <mj-text font-style="italic" font-size="20" color="#626262">
       My Company
    </mj-text>
    <mj-text>
      <h1>
        Hey Title!
      </h1>
    </mj-text>
 </mj-column>
</mj-section>
#+END_EXAMPLE

***** mj-button, Image header with text and button
- href ::
- padding :: 10px 25px
- inner-padding :: 10px 25px
- background-color :: #414141
- border-radius :: 3px
- font-size :: 13px
- font-weight :: bold
- font-family :: Ubuntu, Helvetic, Arial, sans-serif
- color :: #ffffff
- align :: center
- vertical-align :: middle
- line-height :: 120%, px/%/none

#+BEGIN_EXAMPLE
<mj-section background-url="http://1.bp.blogspot.com/-TPrfhxbYpDY/Uh3Refzk02I/AAAAAAAALw8/5sUJ0UUGYuw/s1600/New+York+in+The+1960's+-+70's+(2).jpg" background-size="cover" background-repeat="no-repeat">
  <!-- -In order to have the background rendered full-width in the column, 
  set the column width to 600px-->
  <mj-column width="600">

    <mj-text align="center" color="#fff" font-size="40" font-family="Helvetica Neue">Slogan here</mj-text>

    <mj-button background-color="#F63A4D" href="#">
      Promotion
    </mj-button>

  </mj-column>

</mj-section>
#+END_EXAMPLE

***** mj-image, Basic 2 columns with image on left and text on right
mj-image
- width :: px, default 100% (100% of the column width)
- align :: default center
- padding :: default 10px 25px
- padding-top, padding-x
- border-width :: default 4px
- border-style :: default solid, dashed/dotted
- border-color :: default #000000
- alt :: string
- href :: !!

#+BEGIN_EXAMPLE
<mj-section background-color="white">

  <!-- Left image -->
  <!-- column is 50% of total width,  mj-image is vertically and horizontally centered and image width is always 200 -->
  <mj-column>
    <mj-image width="200" src="http://via.placeholder.com/300x400/?text=300x400" />
  </mj-column>

  <!-- right paragraph -->
  <mj-column>
    <mj-text font-style="italic" font-size="20" font-family="Helvetica Neue" color="#626262">
      Find amazing places
    </mj-text>

    <mj-text color="#525252">
      Lorem ipsum dolor sit amet, consectetur adipiscing elit. Proin rutrum enim eget magna efficitur, eu semper augue semper. Aliquam erat volutpat. Cras id dui lectus. Vestibulum sed finibus lectus.</mj-text>

  </mj-column>
</mj-section>
#+END_EXAMPLE

***** mj-social
- text-mode :: default true, if true, *-content must be defined
- font-family
- color :: text color, default #333333
- align :: center
- icon-size :: default 20px
- padding :: default 10px 25px
- mode :: defualt horizontal, or vertical

- display :: default facebook twitter google. could be facebook:url, can add custom social network e.g. youtube

- *-href, *-content, *-rel, *-icon, *-icon-color :: * could be facebook, twitter, google, linkedin, pinterest, instagram

- *-icon for default facebook, twitter, etc. cannot be modified
- *-icon-color has to be defined for custom social medias e.g. youtubec

#+BEGIN_EXAMPLE
<mj-social color="#333333" align="left" 
text-mode="false" icon-size="16px" 
padding-right="25" padding-bottom="10" padding-top="10" 
mode="horizontal" 
display="linkedin:url facebook:url twitter:url youtubec:url" 
linkedin-href="..."
linkedin-content=" "
linkedin-icon-color="#A7A6A4" 
youtubec-href="..."
youtubec-content=" "
youtubec-icon-color="#A7A6A4" youtubec-icon="path to youtube icon image" />
#+END_EXAMPLE

***** mj-divider
Try to add horizontal border with some spacing using mj-divider
#+BEGIN_EXAMPLE
<mj-section padding-bottom="0" background-color="white">
  <mj-column width="100%">
    <mj-image src="https://avatars0.githubusercontent.com/u/16115896?v=3&s=200" width="50px" />
    <mj-divider horizontal-spacing="0" vertical-spacing="0" padding-top="20" padding-bottom="0" padding-left="0" padding-right="0" border-width="1px" border-color="#f8f8f8" />
  </mj-column>
</mj-section>
#+END_EXAMPLE

***** mj-spacer
blank space.  For some reason, try adding a section with a spacer only so that the email has the content in full width
#+BEGIN_EXAMPLE
<mj-section>
  <mj-column>
    <mj-text>A first line of text</mj-text>
    <mj-spacer height="50px" />
    <mj-text>A second line of text</mj-text>
  </mj-column>
</mj-section>
#+END_EXAMPLE

***** mj-table
- font-family ::
- width :: default 100%
- only accepts plain html
- Use it to have fixed width that's not gonna change when in mobile

mj-table always, as a whole, align left. If you want to center use mj-raw to mjml:raw:center table

mj-social aligns center

mj-table has right and left padding: 10px 25px

Use it to align icons with links. Notice the img has fixed width. Include this mj-table
#+BEGIN_EXAMPLE
<mj-table>
  <tr style="list-style: none;line-height:1">
    <td>
      <a href="https://twitter.com/RecastAI">
        <img width="25" src="https://cdn.recast.ai/newsletter/twitter.png" />
      </a>
    </td>
    <td>
      <a href="https://www.facebook.com/recastAI">
        <img width="25" src="https://cdn.recast.ai/newsletter/facebook.png" />
      </a>
    </td>
    <td>
      <a href="https://medium.com/@RecastAI">
        <img width="25" src="https://cdn.recast.ai/newsletter/medium.png" />
      </a>
    </td>
    <td>
      <a href="https://www.youtube.com/channel/UCA0UZlR8crpgwFiVaSTbVWw">
        <img width="25" src="https://cdn.recast.ai/newsletter/youtube.png" />
      </a>
    </td>
    <td>
      <a href="https://plus.google.com/u/0/+RecastAi">
        <img width="25" src="https://cdn.recast.ai/newsletter/google%2B.png" />
      </a>
    </td>
  </tr>
</mj-table>
#+END_EXAMPLE

#+BEGIN_EXAMPLE
<mj-column>
  <mj-table>
    <tr style="border-bottom:1px solid #ecedee;text-align:left;padding:15px 0;">
      <th style="padding: 0 15px 0 0;">Year</th>
      <th style="padding: 0 15px;">Language</th>
      <th style="padding: 0 0 0 15px;">Inspired from</th>
    </tr>
    <tr>
      <td style="padding: 0 15px 0 0;">1995</td>
      <td style="padding: 0 15px;">PHP</td>
      <td style="padding: 0 0 0 15px;">C, Shell Unix</td>
    </tr>
    <tr>
      <td style="padding: 0 15px 0 0;">1995</td>
      <td style="padding: 0 15px;">JavaScript</td>
      <td style="padding: 0 0 0 15px;">Scheme, Self</td>
    </tr>
  </mj-table>
</mj-column>
#+END_EXAMPLE

#+BEGIN_EXAMPLE
<mj-section>
  <mj-column>
    <mj-table>
      <tr style="list-style: none;line-height:1">
        <td width="46"><img width="46" src="http://via.placeholder.com/46x32/" /></td>
        <td width="10">&nbsp;</td>
        <td>
          <br>
          <span style="font-size:18px;font-weight:200;">Contact Us</span><br>
          <a href="tel:18881231234" target="_blank" style="text-decoration:none;color:#545759;">1-888-123-1234</a><br>
          <a href="mailto:a@xyz.com" target="_blank" style="text-decoration:none;color:#545759;">a@xyz.com</a><br>
          <a href="http://a.com" target="_blank" style="text-decoration:none;color:#545759;">www.a.com</a>
        </td>
      </tr>
    </mj-table>
  </mj-column>
</mj-section>
#+END_EXAMPLE

***** mj-raw
Not to be rendered by MJML engine

<<<mjml:raw:center table>>>
This won't work for Yahoo! Mail but works on all clients
#+BEGIN_EXAMPLE
<mj-column>
  <mj-text>...</mj-text>

  <!-- each mj-element under mj-column is <tr><td> content </td></tr>
  <mj-raw>
   
    <tr>
        <td>
            <table align="center" width="110" cellpadding="0" cellspacing="0" border="0">
                <tr>
                    <td align="center" width="30"><a href="#">
                      <img width="30" src="twitter.png" />
                    </a></td>
                    <td align="center" width="30"><a href="#">
                      <img width="30" src="twitter.png" />
                    </a></td>
                    <td align="center" width="30"><a href="#">
                      <img width="30" src="twitter.png" />
                    </a></td>
                </tr>
            </table>
        </td>
    </tr>
  </mj-raw>
</mj-column>
#+END_EXAMPLE

***** mj-hero
Display a section with a background image and some content inside (mj-text, mj-button, mj-image …) wrapped in mj-hero-content component

mjml:tag:mj-hero

***** mj-invoice
***** mj-location
***** mj-navbar
***** mj-carousel
***** mj-accordion
**** mj-group to group columns
Prevent columns from stacking on mobile.

Columns inside a group must have a width in percentage or auto sizing, but not in pixel

Section can have both column and group.

iOS 9 :: always remove space between columns inside a mj-group

**** Caveats
mj-image inside mj-colum will always have a maximum fixed width.

If there's one mj-column, then mj-image is 100% of the mj-column.

If there're 2 mj-columns, then mj-image is 50% of the whole width = 300px

If there're 3 mj-columns, mj-image is 196px.

You can align mj-image left or right inside a mj-column. And when you do that pay attention to the padding. Usually don't set padding:0
When in mobile, <p> has padding-left:10px. So you could do
#+BEGIN_EXAMPLE
<mj-section full-width="full-width">
  <mj-group>
    <mj-column width="50%">
      <mj-image src="logo1.jpg" width="103" align="left" padding="10px 0 0 10px" />
    </mj-column>
    <mj-column width="50%">
      <mj-image src="logo2.jpg" width="96" align="right" padding="10px 10px 0 0"/>
    </mj-column>
  </mj-group>
</mj-section>
#+END_EXAMPLE

mj-section, mj-column don't have left and right padding by default.

mj-image has padding:10px 25px by default

*** Non breaking
#+BEGIN_EXAMPLE
&nbsp; ::
&#x2011; :: hyphen
#+END_EXAMPLE

** Phone number
<a href="tel:+18475555555">1-847-555-5555</a>

// javascript
window.open('tel:+11231231234');

** Icons, Address Bar color
*** Icons
General Icon in scale of 48px
#+BEGIN_EXAMPLE
<link rel="icon" sizes="192x192" href="icon.png">
#+END_EXAMPLE

IE Tiles :: 4 sizes. Listed are standard size. 1.8 times is better.
#+BEGIN_EXAMPLE
<meta name="application-name" content="CenturyCutCook" />
<meta name="msapplication-TitleColor" content="#009900" />

<meta name="msapplication-sqaure70x70logo" content="icon_smalltitle.png">
<meta name="msapplication-sqaure150x150logo" content="icon_mediumitle.png">
<meta name="msapplication-sqaure310x150logo" content="icon_widetitle.png">
<meta name="msapplication-sqaure310x310logo" content="icon_largetitle.png">
#+END_EXAMPLE

Apple Icon :: Default 60x60
#+BEGIN_EXAMPLE
<link rel="apple-touch-icon" href="touch-icon-iphone.png">
<link rel="apple-touch-icon" sizes="76x76" href="touch-icon-ipad.png">
<link rel="apple-touch-icon" sizes="120x120" href="touch-icon-iphone-retina.png">
<link rel="apple-touch-icon" sizes="152x152" href="touch-icon-ipad-retina.png">
#+END_EXAMPLE

Apple :: Startup Image
Base Size :: 320x480. But different devices ask for different sizes. Follow this to implement
#+BEGIN_EXAMPLE
<link rel="apple-touch-startup-image" href="/startup.png">

<!-- iPad retina portrait startup image -->
<link href="https://placehold.it/1536x2008"
      media="(device-width: 768px) and (device-height: 1024px)
                 and (-webkit-device-pixel-ratio: 2)
                 and (orientation: portrait)"
      rel="apple-touch-startup-image">

<!-- iPad retina landscape startup image -->
<link href="https://placehold.it/1496x2048"
      media="(device-width: 768px) and (device-height: 1024px)
                 and (-webkit-device-pixel-ratio: 2)
                 and (orientation: landscape)"
      rel="apple-touch-startup-image">

<!-- iPad non-retina portrait startup image -->
<link href="https://placehold.it/768x1004"
      media="(device-width: 768px) and (device-height: 1024px)
                 and (-webkit-device-pixel-ratio: 1)
                 and (orientation: portrait)"
      rel="apple-touch-startup-image">

<!-- iPad non-retina landscape startup image -->
<link href="https://placehold.it/748x1024"
      media="(device-width: 768px) and (device-height: 1024px)
                 and (-webkit-device-pixel-ratio: 1)
                 and (orientation: landscape)"
      rel="apple-touch-startup-image">

<!-- iPhone 6 Plus portrait startup image -->
<link href="https://placehold.it/1242x2148"
      media="(device-width: 414px) and (device-height: 736px)
                 and (-webkit-device-pixel-ratio: 3)
                 and (orientation: portrait)"
      rel="apple-touch-startup-image">

<!-- iPhone 6 Plus landscape startup image -->
<link href="https://placehold.it/1182x2208"
      media="(device-width: 414px) and (device-height: 736px)
                 and (-webkit-device-pixel-ratio: 3)
                 and (orientation: landscape)"
      rel="apple-touch-startup-image">

<!-- iPhone 6 startup image -->
<link href="https://placehold.it/750x1294"
      media="(device-width: 375px) and (device-height: 667px)
                 and (-webkit-device-pixel-ratio: 2)"
      rel="apple-touch-startup-image">

<!-- iPhone 5 startup image -->
<link href="https://placehold.it/640x1096"
      media="(device-width: 320px) and (device-height: 568px)
                 and (-webkit-device-pixel-ratio: 2)"
      rel="apple-touch-startup-image">

<!-- iPhone < 5 retina startup image -->
<link href="https://placehold.it/640x920"
      media="(device-width: 320px) and (device-height: 480px)
                 and (-webkit-device-pixel-ratio: 2)"
      rel="apple-touch-startup-image">

<!-- iPhone < 5 non-retina startup image -->
<link href="https://placehold.it/320x460"
      media="(device-width: 320px) and (device-height: 480px)
                 and (-webkit-device-pixel-ratio: 1)"
      rel="apple-touch-startup-image">
#+END_EXAMPLE

*** Address Bar
Hide Safari UI (URL address bar)
#+BEGIN_EXAMPLE
<meta name="apple-mobile-web-app-capable" content="yes">
#+END_EXAMPLE

By default, iOS web content displays under the top black status bar. 
Push the content to the top and make the status transparent
#+BEGIN_EXAMPLE
// default is black
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
#+END_EXAMPLE

Address Bar color
#+BEGIN_EXAMPLE
<meta name="theme-color" content="#4285f4">
#+END_EXAMPLE

** Special Characters
In CSS conent attribute, you need to use CSS value
Convert tool
http://www.evotech.net/articles/testjsentities.html

*** Checkmark
#+BEGIN_EXAMPLE
Heavy checkmark &#10004;
Light checkmark &#128504;
Checkmark &#10003;
Square with checkmark &#9745;
#+END_EXAMPLE

** Geolocation
Chrome v50+ only supports geolocation for https
*** .getCurrentPosition
#+BEGIN_EXAMPLE
<button onclick="getLocation()">Get Location</button>
<p id="demo"></p>
<script>
var x = document.getElementById("demo");
function getLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(showPosition, showError);
  }
  else {
    x.innerHTML = "Not supported";
  }
}

function showPosition(position) {
 x.innerHTML = "Latitiude" + position.coords.latitude +
               "Longitude: " + position.coords.longitude;
}

function showError(e) {
  switch (e.code) {
    case: e.PERMISSION_DENIED:
     break;
    case: e.POSITION_UNAVAILABLE;
    case: e.TIMEOUT:
    case: e.UNKNOWN_ERROR:
  }
}
</script>
#+END_EXAMPLE

*** watchPosition
Same as getCurrentPosition but continuous track.

** Storage
#+BEGIN_EXAMPLE
if (typeof(Storage) !== "undefined") {
  // Use localStorage or sessionStorage
  // Store. value is always string
  localStorage.setItem("key","value");
  console.log(localStorage.getItem("key"));
  localStorage.clickcount = Number(localStorage.clickcount) + 1;
  console.log(localStorage.key);
} 
else {
  // Not supported
}
#+END_EXAMPLE
** Application Cache
~<html manifest="demo.appcache"~
.appcache file should be served in =text/cache-manifest= media type
#+BEGIN_EXAMPLE
CACHE MANIFEST
# Above should be first line
# Files that should be cached
/theme.css
NETWORK
# Files will not be cached
login.asp
# An asterisk indicates all other files require an internet connection
*
FALLBACK
/html/ /offline.html
# offline.html should be served in place of all files in /html/ directory
# if internet is not available

# Change the manifest file to update cache
#+END_EXAMPLE

** ARIA
<<<html:ARIA>>>
https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA/ARIA_Techniques

*** role attribute
- separator :: BS4 .dropdown-divider
- group :: BS4 .btn-group 
- button :: <a> without href
- search :: <form> define purpose

*** aria-* attributes
- aria-label :: inside <button> where label text can't be displayed
- aria-labelledby :: refer to an element's id where the element contains text for label purpose.
  - Can be nested 'parentID child1ID'

** Display price
#+BEGIN_EXAMPLE
<span class="price-49-cents">4.9</span>

.price-49-cents {
  font-size:70px;
}
.price-49-cents:after {
  content; "\00A2 \A per kWh";
  white-space: pre; /* wrap when line break is encountered */
  font-size:16px;
  /* line-height:16px; probably don't need it */
  vertical-align:top;
  display:inline-block;
}
#+END_EXAMPLE

* Javascript
** Loading Sequence
<script> tags without any attributes are downloaded together and executed immediately in order

- defer :: Works when src is defined. Download together, execute in order just before DOMContentLoaded
- async :: Works when src is defined. Download together, execute in any order they're downloaded
- async="false" :: Works when src is defined. Download together, execute in order as soon as all are downloaded

By default, all dynamically added scripts are async.

For example, if you want to load 2 javascript files and execute them in order but after they are all downloaded:
async="false" is needed.

#+BEGIN_EXAMPLE
[ '1.js',
  '2.js'
].forEach(function(src) {
  var script = document.createElement('script');
  script.src = src;
  script.async = false;
  document.head.appendChild(script);
});
#+END_EXAMPLE

** External Script, document.write
<<<js:external script>>>
Loading external script use this

#+BEGIN_EXAMPLE
(function () {
  var nodeScript = document.createElement('script');
  nodeScript.type = 'text/javascript';
  nodeScript.src = 'http://otherdomain.com/a.js';
  var node = document.getElementById('interstitial');
  node.appendChild(node);

  // Add to <head>
  // var node = document.getElementsByTagName('script')[0];
  // node.parentNode.insertBefore(gads, node);
})();
#+END_EXAMPLE

document.write inside external script (asynchronously loaded) cannot modify DOM 
You will need to use these to modify the DOM
#+BEGIN_EXAMPLE
// .appendChild(), .insertBefore(), .innerHTML
// jQuery ~.html('html')~ is equivalent to javascript ~$('').innerHTML ='html'~
#+END_EXAMPLE

Refer to tool:html:document.write

Example
https://support.jwplayer.com/customer/portal/articles/1406723#fndtn-method-1

Default JW player embed is single-line embed:
<script src="//content.jwplatform.com/players/MEDIAID-PLAYERID.js"> </script>

If this is async loaded, the player will not show because it has document.write

Instead, load this in <head>
<script src="//content.jwplatform.com/libraries/PLAYERID.js"> </script>

And a container :: <div id="myElement"></div>
Then dynamically load this
#+BEGIN_EXAMPLE
<script type="text/javaScript">
var playerInstance = jwplayer("myElement");
playerInstance.setup({
    file: "//content.jwplatform.com/videos/MEDIAID-TEMPLATEID.mp4"
    mediaid: "xxxxYYYY"
});
</script>
#+END_EXAMPLE
Where TEMPLATEID is the Source file name for a video content in JW UI (under Sources).

** Initialization
<<<js:Initialization>>>
Always initialize variables at the top including vars in loops
var myObj = {},
    myString = "",
    myArray = [],
    myBoolean = false,
    myRegex = /()/,
    myNumber = 0;

These values are considered as false

** Variable Scope
*** Hoisting
<<<js:hoisting>>>. Refer to js:Function
Variables defined outside of any functions are Global.
Only function can create local scope. Without using var to declare variables, those variables are global.

#+BEGIN_EXAMPLE
myFunction();

function myFunction() {
  carName = "Volvo";
  // carName is actually global
  var carName2 = "Freightliner";
  // carName2 is not global
  // Local var takes precedence when it's used inside a function
  // the inner var shadows the outer.
}
// Alternative way to get global var
console.log(window.carName);
#+END_EXAMPLE

#+BEGIN_EXAMPLE
// function and variable declaration are moved to the top of their
// scope (global or local). It's called hoisting
// which allows you to use them before they are declared
// Functions are hoisted first and then variables
// Function declarations have priority over variable declarations, but not variable assignments

showState("one", {}, 2, 0.98); // output: Ready

// function declaration
// Pros :: Can be used before function is declared
// Cons :: Can't conditionally declare a function
function showState() {
  console.log("Ready");
  // arguments[0] is "one"
} 

// function expression/definition/assignment
// Pros :: Can conditionally define a function
// Cons :: Can't be used before it is defined 
var showState = function() {
  console.log("Idle");
};

showState(); // output: Idle

// The function that is assigned to a variable doesn't have to anonymous.

really.long.external.scoped.name = function shortcut(n) {
 // regression
 shortcut(n-1);
 // Pass it self as a callback
 someFunction(shortcut);
}

#+END_EXAMPLE

*** let, const, var
A variable is defined by var then this variable is available to the closest function scope.

Always js:Initialization for variables declared by var

let and const are /block-scoped/

let declares a variable which is available to the block it is enclosed in.
A block can be a switch, for, or if statement which has one pair of {}
You can only 'let' declare the same variable once in the same block.
The same variable can be let declaired inside a subblock and it will have new scope but not overwrite the upper scope variable.
let declared variable must be declared before it is used or referenced.

Limitation about var
Use let in a loop, the variable can be re-binded for each iteration 
while var in a loop, only the final assigned value is passed unless a closure is used

#+BEGIN_EXAMPLE
for (var i = 1; i <= 5; i++) {
  setTimeout(
    function() {
      console.log(i);
    }, 1000*i);
  // 5 5 5 5 5
  
  setTimeout(
    function(x) {
      return function () {
        console.log(x);
      };
    }(i)
  , 1000*i);
  // 1 2 3 4 5
}
#+END_EXAMPLE

const is the same as let but it's read only. Uppercase naming.
The same const variable name can be redeclared to different value in sub block.
If const is an array or object, its child element or key/value is not protected by default.
Which means you can push to const arry or modify key/value.
const in the same block cannot be changed or redeclared or redeclared by let or var.

** Closure, Javascript Singleton
*** Syntax, When to use closure?

- When you don't want to change the variables in outer scope where the closure is in.
The outer scope can be global or any place where the closure is in.
- When you want to run the function later
- When you want to run the function later by providing just reference to other function
- When you want to run the function later by providing initial state
- When you want to do regression, don't want to affect outer scope and need more debugging

#+BEGIN_EXAMPLE
(function() {
  // Codes here runs immediately
})();
#+END_EXAMPLE

#+BEGIN_EXAMPLE
(function($) {
  // Use jQuery with the shortcut
  console.log($.browser);
  $(document).ready(function($) {
    // document ready
   }
  );
}(jQuery));

// Another form
jQuery(document).ready(function($) {
  // Use $ now
});
#+END_EXAMPLE

*** Singleton
<<<Javascript Singleton>>>

#+BEGIN_EXAMPLE
var Managers = {}; //namespace
// Singleton object CssManager
// Managers and singleton object CssManager has to be defined before they are used

Managers.CssManager = (function() {

// Private space in which all variables and methods are protected from the global scope
// Initialization of properties but it can't be instantialized.

var doc = document;
var setAttributes = function(element, attributes) {
  for (attribute in attributes) {
    element[attribute] = attributes[attribute];
  }
}
// Private space.

return {
  // Public members 
  addStyleSheet: function(id, url) {
    var newStyleSheet = document.createElement("link");
    setAttributes(newStyleSheet, {
      rel : "stylesheet",
      type: "text/css",
      id : id,
      href: url
    });
    document.getElementByTagName("head")[0].appendChild(newStyleSheet);
  },
  removeStyleSheet: function(id) {
    var currentStyleSheet = document.getElementById(id);
    if (currentStyleSheet) {
      currentStyleSheet.parentNode.removeChild(currentStyleSheet);
    }
  },
  swapStyleSheet: function(id, url) {
    this.removeStyleSheet(id);
    this.addStyleSheet(id, url);
  }
  // Public members
}
// return ends.

})();

#+END_EXAMPLE

*** Regression
This provides you more debugging info

#+BEGIN_EXAMPLE
var charsInBody = (function counter(elm) {
  // Notice :: this is not an anonymous function as we see before in a closure!
  if (elm.nodeType == 3) {
    return elm.nodeValue.length;
  }
  var count = 0;
  for (var i = 0, child; child = elm.childNodes[i]; i++) {
    count += counter(child);
  }
  return count;
})(document.body);
#+END_EXAMPLE

** Types, typeof, constructor
*** All types, typeof, constructor
| String    | js:String                                     |
| Number    | NaN is number. js:Number                      |
| Boolean   | true or false. Not FALSE/TRUE                 |
| Object    | js:Array, js:Date, js:Object, null, js:RegExp |
|           | js:Math, js:Error                             |
| Function  | a special type of object js:Function          |
| Symbol    | new in Edition 6                              |
|           |                                               |
| undefined | undefined or has not been assigned a value    |
| null      | a special type of object                      |

*** Number
<<<js:Number>>>
Used: js:Math

#+BEGIN_EXAMPLE
var foo = "55";
var myNumber = Number(foo);
if (!isNaN(myNumber)) {
  console.log("It is a number");
  // foo is a number
} 
#+END_EXAMPLE

*** String
<<<js:String>>>
s.length
s.charAt(s.length-1)
s.charCodeAt(s.length-1) :: UTF-16 code unit value
var myString = String.fromCharCode(65,66,67); // 'ABC'
s.indexOf("Paul"); // Case sensitive. Starts from the beginning. -1 not found
s.lastIndexOf("Paul"); // Case sensitive. Starts from the end
s.substr(0,4); // From start to 4th index
s.substring(0,4); // From start and take 4 characters. If stop is omitted, take the rest

#+BEGIN_EXAMPLE
s.slice(0,4); // Same as substring but start and stop can be both or either negative
// If start is negative, start from the end of string
// If stop is negative, stop to (s.length - 1) - Math.abs(s)
#+END_EXAMPLE

s.toLowerCase(); s.toUpperCase();

Don't use string1 == string2 to do case insensitive comparison. Use below including UTF8
string1.toUpperCase() === string2.toUpperCase()

*** Array
**** Basics
<<<JS:Array>>>
var a = new Array();
a[0] = "Paul";
a = ["P", "C", "S"]; // never put comma at the end of array
a[a.length-1] // last element
a[a.length]= "Z"; // append to last

**** If variable is array
#+BEGIN_EXAMPLE
console.log(Array.isArray(fruits)); // true or false
console.log(fruits instanceof Array) // true or false
#+END_EXAMPLE

**** array.pop(), array.shift(), array.push(), array.unshift()
a.pop(); // remove last element
a.shift(); // remove fist element
a.push("Z"); // add to the end of array. return new length
a[a.length]="Z"; // also append to last

a.unshift("Z"); // add to the beginning of array. return new length

**** array.concat()
var a = new Array("P", "C", "S");
var b = new Array(31,29,34);
a = a.concat(b); // Join arrays P, C, S, 31, 29, 34

**** array.slice()
var slice = a.slice(1,2); // C, S

**** array.splice(), remove a value from array if exists
var removed = a.splice(0,1,"Z","B"); // ["P"]
// First delete 1 element at index 0 and then add element Z and B 
// return the ones that are removed

Remove a value from array if it exists
var index = myArray.indexOf(item);
if (index !== -1) {
 myArray.splice(index, 1);
}

**** array.join(), array.toString(), array.valueOf()
var join = a.join(","); // "P,C,S"
a.toString() // also "P,C,S"
a.valueOf(); // also "P,C,S". Convert to primitive

**** array.sort(), array.reverse()
var sort = a.sort(); // sort as strings. case sensitive: C, P, S
function numericSort(anArray) {
 anArray.sort(function(a,b) {
  return a - b; // ascending order
  // return a.year - b.year; if it's an obj
});
 return anArray;
}

function randomSort(anArray) {
 anArray.sort(function(a, b) {return 0.5 - Math.random();});
 return anArray;
}

var reverse = a.reverse(); // S, C, P

**** array loop: for, array.forEach() 
for (var i = 0; i < fruits.length; i++) {
 fruits[i];
}

js:forEach
fruits.forEach(function(i) {
 console.log(i);
});

**** array.map(), array.filter() 
Do something while each item is iterated, join returned values into an array.
var result = a.map(function(i) { return i.toUpperCase(); }); // result is an array
console.log(a); // a is not affected!

a = a.filter(function(i) { 
   if ( true then remove condition ) { 
    return false; 
   }
   else {
    return true; // keep
   }
});

**** array.every(), array.some()
a.every(function(i) { return i[0] === "a"; }); // return true only if all returns are true
a.some(function(i)  { return i[0] === "a"; }); // return true if at least one return is true

**** array.reduce()
var sum = [0, 1, 2, 3].reduce(
 function(a,b) { return a=b; },
 0
);
// sum is integer 6

#+BEGIN_EXAMPLE
var flattened = [[0, 1], [2, 3], [4, 5]].reduce(
 function(a,b) { return a.concat(b); },
 []
);
// [0, 1, 2, 3, 4, 5]
#+END_EXAMPLE

array.reduce(callback[, initialValue])

If initialValue is provided, it will start at index 0. 
If not provided, it will start at index 1 and previousValue is the value at index 0 in the array.

callback has 4 arguments
- previousValue
- currentValue
- currentIndex
- array :: the input array was called upon

*** Date
<<<js:Date>>>
var date1 = new Date();
var date2 = new Date(77978); // milliseconds since 1970 01 01 GMT
var date3 = new Date(2017,0,31,15,35,20,20); // 2017 Jan 1 at 15:35:20 at 20 ms
var date4 = new Date("31 January 2016"); 
// "31 Jan 2016" "Jan 31 2016" "01-31-2016"

// Get and Set
var dayofmonth = date4.getDate(); // setDate
var dayofweek = date4.getDau(); // int, Sunday as 0. You can't set day
var month = date4.getMonth(); // int, January as 0. setMonth
var fullyear = date4.getFullYear(); // 4 digits. setFullYear
var datestring = date4.toDateString(); // Current time zone. "Wed 31 Dec 2003"

var currentDay = date4.getDate();
date4.setDate(currentDay + 28 ); // Plus 28 days

getHours(), getMinutes(), getSeconds(), getMilliseconds(), toTimeString()
setHours(), setMinutes(), setSeconds(), setMilliseconds()

// Date difference
var date1 = new Date();
var date2 = new Date('01-31-2016');
var timeDiff = date2.getTime() - date1.getTime(); // milliseconds
var diff Days = timeDiff / (1000*3600*24);

// Conversion getter
<<<js:time:iso>>>
date4.toISOString()
// e.g. 2011-10-05T14:48:00.000Z
// timezone is always zero UTC offset. 24 or 27 (I haven't seen one..) characters.

Compare current date with a future date
#+BEGIN_EXAMPLE
function checkFuture(futureDateString) {
  var futureMS = new Date(futureDateString).getTime();
  var currentMS = new Date().getTime();
  
  if (currentMS >= futureMS) {
    return true; // current date is beyond future date
  }
  return false;
}
checkFuture("01/03/2018"); // mm/dd/yyyy
#+END_EXAMPLE

*** Math
<<<js:Math>>>
Math.PI
Math.abs(-101);
Math.ceil(101.01); // 102
Math.floor(101.01); // 101
Math.round(101.01);
Math.pow(10, 2); // 100
parseInt("10"); // 10

var itemCost = 9.99 * 1.075; // 10.73925
itemCost.toFixed(2); // 10.74
*** RegExp 
**** search(), replace(), match()
#+BEGIN_EXAMPLE
var s = "Visit W3Schools!";
var n = s.search("W3Schools"); // 6. -1 if not found
var all = s.match("i"); // return all matches
var res = s.replace(/w3schools/i, "Microsoft");
var res = s.replace("W3Schools", "Microsoft");
#+END_EXAMPLE

**** RegExp
***** Ways to define regex
<<<js:RegExp>>>
#+BEGIN_EXAMPLE
var n = s.search(/w3schools/i); // Use forward slash. Return the first matched index
var pattern = /w3schools/i; // Define a pattern in a variable

// Need to escape \ with \\
var patternobj = new RegExp('w3schools','i'); // Define a pattern as a RegExp object 
var patternobj = new RegExp(/w3schools/,'i');

// Test a pattern
pattern.test("Perform a test on this string"); // true or false

// Return the first found text
pattern.exec("Perform an exec on this string"); // null if not found.

// Index
every time pattern.exec() or pattern.test() is run, the pattern.lastIndex is advanced.
Until .lastIndex gets to 0

// Return all matches
s.match(pattern);
#+END_EXAMPLE
***** Pattern and modifiers
=/pattern/modifiers=

Modifiers
| i | case-insensitive |
| g | find all match   |
| m | multiline        |

Brackets
| [abc]  | a character that is a, b or c      |
| [^abc] | a character that is not a, b nor c |
| [0-9]  | a digit                            |
| [^0-9] | a non-digit character              |
|        |                                    |

(x|y) one of x or y

Metacharacter
| .      | a character execpt newline or line terminator  |
| \w     | a word character including _ [A-Za-z0-9_]      |
| \W     | a non-word character. same as [$\w]            |
| \d     | a digit                                        |
| \D     | a non-digit character                          |
| \s     | whitespace                                     |
| \S     | a non-space character                          |
| \b     | word boundary                                  |
| \0     | a NUL character                                |
| \n     | a new line character                           |
| \f     | a form feed character. e.g. page/section break |
| \r     | a carriage return                              |
| \t     | a tab character                                |
| \v     | a vertical tab character                       |
| \uxxxx | a Unicode character \u0057 is w                |
| \xxx   | \127 is w                                      |
| \xdd   | \x57 is w                                      |
|        |                                                |

Quantifier
| n+     | at least one of n                |
| n*     | zero or more                     |
| n?     | zero or one                      |
| n{X}   | \d{4} a 4-digit string           |
| n{X,Y} | \d{3,4} a 3-to-4-digit string    |
| n{X,}  | \d{3,} a at-least-3-digit string |
| n$     | at the end                       |
| ^n     | at the beginning                 |
| (?=n)  | non greedy match                 |

***** Word Boundary \b and \B
#+BEGIN_EXAMPLE
var s = "Visit W3Schools";
var pattern = /\bW3/g; // return words that start with W3
pattern.exec(s); // W3
var patter = /\bVisit\b/g; // whole word
var patterB = /\BSchools/g; // return "Schools". Words that do not start or end with Schools
#+END_EXAMPLE

***** Non greedy match (?=n)
#+BEGIN_EXAMPLE
var s = 'Is this all there is';
var p = /is(?= all)/g;
s.match(p); // is
// (?= all) matches any string that is before ' all':  but the matched is not returned.
// The other way to intepret it is find any 'is' that has ' all' right behind
var p = /is(?! all)/g; // Find any 'is' that doesn't have ' all' right behind
#+END_EXAMPLE

***** Match Tags
<<<regex:match_tags>>>

Match all tags
#+BEGIN_EXAMPLE
'<[^>]*>'
#+END_EXAMPLE

Match one tag only
#+BEGIN_EXAMPLE
'<img[^>]*>'
'<(img|/?div|br)[^>]*>'
#+END_EXAMPLE

*** Function
<<<js:Function>>> Refer to js:hoisting
**** arguments
function add() {
  var sum = 0;
  for (var i = 0, j = arguments.length; i < j; i++) {
    sum += arguments[i];
  }
  return sum;
}
add(2,3,4,5);

function add() {
  var sum = 0;
  for (var i = 0, j = arguments.length; i < j; i++) {
    sum += arguments[i];
  }
  return sum;
}

// Use Spread Syntax js:spread

function add(firstValue, ...args) {
  var sum = 0;
  for (let value of args) {
    sum += value;
  }
  sum += firstValue;
  return sum;
}

add(2,3,4,5);
**** .apply(), .call()
<<<js:Function.apply>>> <<<js:Function.call>>>
.apply() :: Pass arguments as an array to a function which accepts multiple arguments
.call() :: Pass arguments as arguments to a function which accepts multiple arguments

funct.apply(thisArg, [argsArray])

thisArg :: pass thisArg into funct as this in funct
argsArray :: array or array-like object

Pass no more than 65536 arguments/elements in array.

var numbers = [5,6,2,3,7];
var max = Math.max.apply(null, numbers); // Equivalent to Math.max(5,6, ...);
var max = Math.max.call(null, 5,6,2,3,7);

.apply() and .call() are used when the number of arguments passed to a method is unknown.
They are also used to call a method on a varible (obj or array) which doesn't has that method as its property. 
- Loop arrays which don't have .forEach() such as NodeList 

*** Error
<<<js:Error>>>
#+BEGIN_EXAMPLE
try {
 throw "Too big"; // Manually throw an error
 var err = new Error("Too big");
 throw err;
}
catch(err) {
 console.log(
  err.message, // Standard
  err.description, // Microsoft.
  err.number, // Microsoft. same as linenumber
  err.linenumber, // FF and Chrome
  err.name, // Standard. Initial is Error but you can change it
  err.stack // Not standard but works in all browsers.. Stack trace.
 );
}
finally {
 // success or failure, run this
}
#+END_EXAMPLE
*** Prototype Object
<<<js:prototype>>>
Every js:Object has a prototype object.

prototype object's default properties and methods

- constructor :: property. get/set 
- hasOwnProperty('aProperty') :: 
  - bool. objA.hasOwnProperty('aProperty') not objA.prototype.hasOwnProperty('aProperty')
  - aProperty has to be direct (not objA.prototype.aProperty) and not inherited
- isPrototypeOf() :: 
  - <<<js:prototype.isPrototypeOf>>>
  - Parent.prototype.isPrototypeOf(SubParent.prototype) is true
  - Whether or not SubParent has some prototype properties removed, added or modified
  - js:instanceof 
- propertyIsEnumerable :: 
  - <<<js:prototype.propertyIsEnumerable>>>
  - js:Enumerable
  - objA.propertyIsEnumerable('prop') not objA.prototype.propertyIsEnumerable('prop')
  - return true if it's enumerable in js:for...in
  - inherited properties are not enumerable
  - but newly created properties or methods are enumerable!

Because protype object can be cloned and modified, that brings one OOP characteristic: js:inheritance

Also, if any prototype property is modified in the upper chain, the lower chain and its instantiated objects will be modified, too!

*** Type Conversion
Javascript conversion is automatic. 
var y = "5";
var x = + y;

General methods:
String(x) or x.toString() // convert to string
Number(x) // convert to numbers

**** Number to String
x.toString();
x.toExponential(2); // 2 decimal points: 9.66e+0
x.toFixed(2); // 2 decimal points
x.toPrecision(); // total number of digits
 
**** String to Number
parseInt("10"); // 10
parseInt("10.33"); // 10
parseInt("10.53"); // 10
parseInt("10 20 30"); // 10
parseInt("10 years"); // 10
parseInt("year 10"); // NaN

The same for parseFloat.

Always provide a base number :: parseInt("10", 10); // decimal base
** Loops and Breaks
*** for, while, do...while
#+BEGIN_EXAMPLE
var cars = ['a', 'b', 'c'];
for (i = 0, len = cars.length, text = ""; i< len; i++) {
 // Loop through all properties of Array.prototype
 // 3rd party libraries or frameworks might add methods or properties to Array.prototype
 // So this is not recommended for looping an Array
}
for (; i<len; i++)

while () {
}

do {
}
while (condition);
#+END_EXAMPLE

*** for...in
<<<js:for...in>>>
#+BEGIN_EXAMPLE
var myObj = {};
for (var prop in myObj) {
 console.log(myObj[prop]);
}
#+END_EXAMPLE

*** for...of
<<<js:for...of>>>
js:for...in interates over all enumerable properties of an object.
While for...of iterates over elements of any collection that has a [Symbo.iterator] property.

for...of interates over iterable objects :: Array, Map, Set, String, TypedArray, arguments but not objects!

for (let value of iterable) {
 console.log(value);
}

*** forEach
<<<js:forEach>>>

array.forEach(callback[, thisArg])

thisArg :: Pass a variable outside of .forEach() and change it inside .forEach() using /this/

callback :: 3 arguments
- currentValue
- index
- array

Return :: undefined. So .forEach() is not chainable

Elements appended after the call to forEach() begins will not be visited.
The value of element is changed before forEach() visits, it will reflect the change.
Elements removed before being visited will not be visited.

*** break and continue
=break= without a label reference, can only jump out of a loop or a switch
=continue= with or without a label, can only skip one loop iteration.
With a label reference, =break= can jump out of any code block.
A code block is a block of code between { and }
#+BEGIN_EXAMPLE
list: {
 text += cars[0] +  "<br>";
 text += cars[1] +  "<br>";
 break list;
 text += cars[3] +  "<br>";
}
#+END_EXAMPLE
** Enumerable
<<<js:Enumerable>>>
Except inherited properties, all methods and properties are enumerable in js:for...in
js:prototype.propertyIsEnumerable
js:Object.defineProperty

To make a method non enumerable
#+BEGIN_EXAMPLE
// CustomerBooking class and its method setFilm is already defined
Object.defineProperty(Customerbooking.prototype,'setFilm',
{enumerable:false});
#+END_EXAMPLE

** JSONP, JSON
*** JSONP
#+BEGIN_EXAMPLE
<script type="text/javascript" src="http://b.com/returnjsondata?callback=mycallback"></script>

Where b.com/returnjsondata returns a json object. 
And the whole <script> in yourwebsite.com will become 
mycallback({foo:'bar'});
#+END_EXAMPLE

*** JSON
JSON object names require double quotes.
String are wrapped in double quotes.
Boolean is true or false.
null can be used.
MIME type: application/json

var obj = JSON.parse(jsonString); // parse a json string

**** Deep Keys
#+BEGIN_EXAMPLE
var r1 = (((test || {}).level1 || {}).level2 || {}).level3;
if (typeof r1 !== 'undefined') {
}
#+END_EXAMPLE

** DOM Manipulation
*** If an element exists
#+BEGIN_EXAMPLE
var e = document.getElementById("abc");
if (!!e) {
 // exists
}

var e = document.getElementsByClassName('aClass');
if (e.length > 0) {
  // exists
}
#+END_EXAMPLE

*** Loop querySelectorAll
#+BEGIN_EXAMPLE
var divs = document.querySelectorAll('.aClass');
[].forEach.call(divs, function(div) {
  div.style.color="red";
});
#+END_EXAMPLE

*** Remove a class
Don't need to check existance
#+BEGIN_EXAMPLE
ELEMENT.classList.remove("CLASS_NAME");
ELEMENT.classList.add('hint');
#+END_EXAMPLE

*** Selected Option
#+BEGIN_EXAMPLE
var e = document.getElementById("selectElementID");
var i = e.selectedIndex;
var ep = e.options[i];
ep.value;
ep.text;
#+END_EXAMPLE

*** Element data attributes
#+BEGIN_EXAMPLE
<div id="id" data-primary="abc"></div>

var e = document.getElementById('id');
if (e.dataset.hasOwnProperty('primary')) {
  print e.dataset.primary;
}
#+END_EXAMPLE

** URI and URI Component Encode, Current URL
#+BEGIN_EXAMPLE
var url1 = "http://abc.com";
var url2 = "http://xyz.com/test.php?url=" + encodeURIComponent(url1);
// decodeURIComponent();

// When you want a working URL as a whole with URL parameters
var uri = "http://abc.com/folder name with space/file name with space.asp?abc=has space"
var uri_en = encodeURI(uri);
// decodeURI(str)
#+END_EXAMPLE

encodeURI do not encode these:
#+BEGIN_EXAMPLE
@*_+-./
#+END_EXAMPLE

Both encodeURI and encodeURIComponent don't encode single quotes.

Current URL
#+BEGIN_EXAMPLE
console.log(window.location.href);
// http://abc.com/xyz/ijk.php?m=123#def
// window.location.href = window.location.protocol + "//" 
// + window.location.host (abc.com)
// + window.location.pathname (/xyz/ijk.php, if homepage, '/')
// + window.location.search (?m=123)
// +  window.location.hash; (#def)
#+END_EXAMPLE

** Cookie
https://developer.mozilla.org/en-US/docs/Web/API/Document/cookie
#+BEGIN_EXAMPLE
cookieVal = "abc";
cookieKeyValPair = "litest=" + encodeURIComponent(cookieVal); 
// only one single cookie can be set/updated at a time
document.cookie = cookieKeyValPair;

// Optional cookie attribute values, preceded by a semi-colon separator
cookieKeyValPair += "; path='/mydir'"

// or
cookieKeyValPair += "; path=/"
#+END_EXAMPLE

Find a cookie value by a key
#+BEGIN_EXAMPLE
function getCookie(cname) {
    var name = cname + "=";
    var ca = document.cookie.split(';');
    for(var i=0; i<ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1);
        if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
    }
    return "";
}

getCookie('PHPSESSID');
#+END_EXAMPLE

** Object only, no Class
<<<js:Object>>>
*** new, Object.create
Every thing in Javascript is an object. No class.

Every object has a prototype object.

/Parent/ is an object with a constructor (because it's a function) and a prototype object.

When /new/ keyword is used, var parent = new Parent();, 
parent copies the Parent's prototype object and run the Parent's constructor.
If the constructor returns anything, parent will take it.
If the constructor returns nothing, the Parent object with prototype object and Parent's other properties defined in 
the constructor (this.xyz = ...) will be copied.

var SubParent.prototype = Object.create(Parent.prototype);
Copies Parent's prototype object and return it. So Parent's constructor is not run.
js:prototype

You can create an object with null as prototype :: Object.create(null);

You can create an object with extra properties
Object.create(Object.prototype, 
{
 foo: {writable: true, configuration: true, value: 'hello', get: ..., set: ..., otherthings: ...},
 bar: {...}
})

*** instanceof
<<<js:instanceof>>>
A useful operand that is for object to test instantiation
Syntax :: /object/ instanceof /constructor/
Return true if /constructor/.prototype exists in /object/'s prototype chain
- object :: an instance (an object)
- constructor :: Function object to test against. It has to be a function

Use instanceof to test instantiation, and use js:prototype.isPrototypeOf to test inheritance

*** Object.defineProperty
<<<js:Object.defineProperty>>>
[[https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty][MDN Object.defineProperty()]]

*** Example
#+BEGIN_EXAMPLE
function CustomerBooking(bookingId, customerName, film, showDate) {
/* This is a constructor. It is not a good way to define property
 * Better to use methods to set. But here should provide initialization
*/
  this.customerName = customerName;
  this.bookingId = bookingId;
  this.showDate = showDate;
  this.film = film;
// You can also call a method which is defined later to initialize properties.
}

CustomerBooking.prototype.getCustomerName = function() {
 return this.customerName;
}

CustomerBooking.prototype.setFilm = function(film) {
 this.film = film;
}

// Instantiate
var firstBooking = new CustomerBooking(1234,
 "Arnold Palmer", "Toy Story", "27 July 2004 20:15");

var enumerated = [];
for (var prop in firstBooking) {
 enumerated[enumerated.length] = prop;
}
// ["customerName","bookingId", "showDate", "film", "getCustomerName", ..., "setFilm"]

// A cinema can hold multiple CustomerBooking instances
function cinema() {
 this.bookings = new Array();
}

cinema.prototype.addBooking = function(bookingId, customerName, film, showDate) {
 this.bookings[bookingId] = new CustomerBooking(bookingId, customerName, film, showDate);
}

// Loop through bookings of a cinema
cinema.prototype.getBookingsTable = function() {
 var booking;
 var bookingsTableHTML = "<table border=1>";
 for (booking in this.bookings) {
  bookingsTable += this.bookings[booking].getBookdingId();
  ...
 }
 bookingsTableHTML += "</table>";
 return bookingsTableHTML;
}

var londonOdeon = new cinema(); // Constructor takes no parameters
londonOdeon.addBooking(342, "First Last", "Toy Story", "15 July 2004 20:15");
#+END_EXAMPLE

** Extending Native Object
Native prototype can't be deleted or replaced
But values of its properties can be modified or created

Create a new method in Array class which removes a member after checking if the method is already defined

#+BEGIN_EXAMPLE
Array.prototype.remove = Array.prototype.remove || function(member) {
 var i = this.indexOf(member);
 if (i > -1) {
  this.splice(index,1);
 } 
 return this;
}

// If a method (remove) is created in native class, but later it was assigned as a property
// error will show 
#+END_EXAMPLE

Newly added remove method is enumerable in js:for...in js:prototype.propertyIsEnumerable
Inherited properties are not enumerable
To filter out method in js:for...in

#+BEGIN_EXAMPLE
var props = [];
for (var prop in results) {
 results.hasOwnProperty(prop) && props.push(prop);
}
#+END_EXAMPLE

<<<Add "method" in Function class>>>
Then "method" exists in any function.
#+BEGIN_EXAMPLE
Function.prototype.method = function(name, func) {
 this.prototype[name] = func;
 return this;
}

// Parenizor is a custom class. Create a method called 'setValue'
Parenizor.method('setValue', function(v) {
 this.value = value;
 return this;
});
#+END_EXAMPLE

<<<Add "inherits" in Function class>>>
#+BEGIN_EXAMPLE
Function.method('inherits', function(parent) {
 // parent is a class that is already defined
 // make a new instance
 this.prototype = new parent();
 var d = {},
     p = this.prototype;
 this.prototype.constructor = parent;
 this.method('uber', function uber(name) {
  if (!(name in d)) {
   d[name] = 0;
  } 
  var f, r, t = d[name], v = parent.prototype;
  if (t) {
   while (t) {
    v = v .contructor.prototype;
    t -= 1;
   }
   f= v[name];
  }
  else {
   f = p[name];
   if (f == this[name]) {
    f = v[name];
   }
  }
  d[name] +=1;
  r = f.apply(this, Array.prototype.slice.apply(arguments, [1]));
  d[name] -=1;
  return r;
 });
 return this;
});
#+END_EXAMPLE

** Classical Inheritance, Parasitic Inheritance
<<<js:inheritance>>>
Classical inheritance is about the _is-a_ relationship.
Parasitic inheritance is about the _was-a-but-now's-a_ relationship.

*** Classical inheritance
Refer to: Add "method" in Function class, Add "inherits" in Function class

**** Example
#+BEGIN_EXAMPLE
function Parenizor(v) {
// enclose v with ( and )
 this.setValue(v);
}

Parenizor.prototype = {
  constructor: Parenizor, // This line is crucial as we are overwriting Parenizor.prototype rather than adding
  setValue: function(v) {
    this.value = v;
    return this;
  },
  getValue: function() {
    return this.value;
  },
  toString: function() {
    return '(' + this.getValue() + ')';
  }
};

myParenizor = new Parenizor(0); 
myString = myParenizor.toString(); // "(0)"

// Subclass inherits parent class Parenizor
function ZParenizor(v, w) {
 Parenizor.call(this, v); // call parent class parenizor constructor
 // You can also call other parent class constructor
 // OtherParenizor.call(this, v);

 // Define other properties that this subclass should have
 this.otherValue = w;
}

ZParenizor.prototype = Object.create(Parenizor.prototype); 
// Inherits parent class's all methods. 
// First create an instance of the parent class and assign it to the child class.

// Inherits other parent class's all methods
// mixin(ZParenizor.prototype, OtherParenizor.prototype);

ZParenizor.prototype.constructor = ZParenizor; 
// Set subclass constructor 
// but ZParenizor should have its own constructor which is ZParenizor.prototype.constructor.

// Modify subclass's inherited method toString 

ZParenizor.prototype.toString = function() {
  // ...
}

var zParenizor = new ZParenizor('v', 'w');

console.log(zParenizor instanceof ZParenizor); // true
console.log(zParenizor instanceof Parenizor); // true
#+END_EXAMPLE

** OOP Pattern

#+BEGIN_EXAMPLE
// Javascript Singleton
(function() {
  this.myApp = this.MyApp || {};
  var ns = this.myApp; // further shorten the keyboard typing

  // private properties
  var vehicleCount = 5;
  var vehicles = [];

  // Public properties

  ns.publicHello = 'This is public';

  // Define a Class
  // You can even separate the class definition into another javascript file
  // Just remember to include the necessary closure like the above
  ns.Vehicle = (function() {

    function Vehicle(year, make, model) {
      this.year = year;
      this.make = make;
      this.model = model;
    }

    Vehicle.prototype = {
      getInfo: function () {
        return this.year + ' ' + this.make + ' ' + this.model;
      },
      startEngine: function () {
        return 'Vroom';
      }
    };

    return Vehicle;
  }());

  // Define a sub Class
  ns.Car = (function(parent) {

    function Car(year, make, model) {
      parent.call(this, year, make, model);
      this.wheelQuantity = 4;
    }

    Car.prototype = Object.create(parent.prototype);
    Car.prototype.constructor = Car;
    Car.prototype.getInfo = function() {
      // Extend parent's method
      return 'Vehicle Type: Car ' + parent.prototype.getInfo.call(this);
    }

    return Car;
  }(ns.Vehicle));

}());

console.log(myApp.publicHello);

// Instantiate
var v = new myApp.Vehicle(2012, 'Toyota', 'Rav4');
console.log(v.getInfo());

var c = new myApp.Car(2012, 'Toyota', 'Rav4');
console.log(c.getInfo());
#+END_EXAMPLE

** Promise
Promise is now native in all browsers including Edge except IE.

IE polyfill https://github.com/stefanpenner/es6-promise
#+BEGIN_EXAMPLE
<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
#+END_EXAMPLE

#+BEGIN_EXAMPLE
function get(url) {
  // You should wrap all code into return
  return new Promise(function (resolve, reject) {
    // run resolve or reject function to resolve or reject a promise
    var req = new XMLHttpRequest();
    req.open('GET', url); // it can be set to async

    req.onload = function () {
      if (req.status == 200) {
        resolve(req.response);
      }
      else {
        reject(Error(req.statusText));
      }
    };

    req.onerror = function () {
      reject(Error("Network Error"));
    }

  });
}

get('story.json')
  .then(function (response) {
    console.log('Success!', response);
    // transform a value to the next .then
    // just return the value, you may modify it
    // The returned value has to be a non-promise
    return JSON.parse(response);
  }, function (error) {
    console.log('Failed!', error);
    return error;
  })
  .then(function (response) {
    console.log('JSON!', response);
  });

// If a 'then' just returns a value when it's resolved, use a shortform
get('story.json').then(JSON.parse).then(function(response) {
  console.log('JSON!', response);
});

// In 'then', you can return a promise
// a promise.then is a promise

function getJSON(url) {
  return get(url).then(JSON.parse);
}

getJSON('story.json').then(function(story) {
  return getJSON(story.chapterUrls[0]);
}).then(function(chapter1) {
  console.log('Got Chapter 1', chapter1);
});

// Store the result of a promise and reuse it
var storyPromise;

function getChapter(i) {
  storyPromise = storyPromise || getJSON('story.json');

  return storyPromise.then(function(story) {
    return getJSON(story.chapterUrls[i]);
  });
}

getChapter(0).then(function(chapter) {
  console.log(chapter);
  return getChapter(1);
}).then(function(chapter) {
  console.log(chapter);
});

// .catch(function(e) { ... }) equals to
// .then(undefined, function(e) { ... })

// Dynamically chained .then()
// Start with a resolved promise: Promise.resolve('initialValue')
// a reject promise: Promise.reject('initialValue')
getJSON('story.json')
  .then(function(story) {
    // addHTMLToPage(story.heading);
    return story.chapterUrls.reduce(function(sequence, chapterUrl) {
      return sequence
        .then(function() { return getJSON(chapterUrl); })
        .then(function(chapter) { /* addHtmlToPage(chapter.html); */ });
    }, Promise.resolve());
  })
  .then(function() { /* addTextToPage("All done"); */ })
  .catch(function(err) { /* addTextToPage("broken" + err.message); */ })
  .then(function() { /* document.querySelector('.spinner').style.display='none'; */ });

// Start a set of promises in parallel and create a promise that fulfils when all are fulfilled
getJSON('story.json')
  .then(function(story) {
    // addHTMLToPage(story.heading);
    return Promise.all(
      story.chapterUrls.map(getJSON)
    ); // not a callback. It's an array of Promises (not chained)
    // After promises are added to array as values, they are started already

    // Start a set of promises in parallel, chain them so that we get response in order

    return story.chapterUrls.map(getJSON)
      .reduce(function (sequence, chapterPromise) {

        return sequence
          .then(function () {
            return chapterPromise;
          })
          .then(function (chapter) {
            addHtmlToPage(chapter.html);
          });

      }, Promise.resolve());


  })
  .then(function() { /* ... */ })
  .catch(function(err) { /* ... */ })
  .then(function() { /* ... */ });
#+END_EXAMPLE

** Observable <<<js:observable>>>
A promise is a push mechanism that calls some code after the promise has been resolved or rejected with a single value.
An observable is like a promise, but it calls some code every time a new value becomes available, and can emit many values over time.

** Worker
IE 10 and above supports worker.
Workers are independent and separated from parent window. 
Don't try to access or modify parent window DOM. Do it indirectly.
#+BEGIN_EXAMPLE
var w;

if (typeof(Worker) !== "undefined") {
 if (typeof(w) == "undefined") {
  w = new Worker("demo_workers.js");
 }
 // Receive message from worker
 w.onmessage = function(event) {
  console.log(event.data);
 }
 
 w.onerror = function(error) {
  console.log(error.message, error.filename, error.lineno);
 }

 // Send message to worker
 w.postMessage(['First Name', 'Last Name']);
}

w.terminate();
w = undefined;

// demo_workers.js
var i = 0;

function timedCount() {
 i = i + 1;
 postMessage(i);
 setTimeout("timeCount()", 500);
}

close(); // Worker can close itself

// This is how worker receives a message
onmessage = function(e) {
  console.log("Message receved by worker from main window");
  var workerResult = 'Result: ' + (e.data[0] * e.data[1]);
  console.log('Posting message back to main window');
  postMessage(workerResult);
}

// Workers can spawn or create subworkers. URIs of subwokers are resolved relative to
// the parent worker's location rather than that of the owning page.

// Worker can load scripts within the same domain
// Scripts are loaded and executed in order.
importScripts('foo.js');
importScripts('foo.js','bar.js');

// Spawn a shared worker. IE doesn't support sharedWorker
// Worker Square and Worker Multiply2Numbers both use shared worker Multiply
// In sqaure.js and multiply2numbers.js

if (!!window.SharedWorker) {
 var sharedWorker = new SharedWorker("multiply.js");
 sharedWorker.port.postMessage([123,123]); // square.js
 sharedWorker.port.postMessage([123,789]); // multiply2numbers.js

 sharedWorker.port.start(); // Only needed in parent thread if onmessage is not defined
 // such as the shares worker is a callback of event listener in parent thread
 
 sharedWorker.port.onmessage = function(e) {
  //
  console.log(e.data); // receive from shared worker
 }
}

// In multiply.js shared worker
port.start(); // only needed if onmessage is not defined in parent thread

onconnect = function(e) {
 var port = e.ports[0];
 
 port.onmessage = function(e) {
  var workerResult = 'Result: ' + (e.data[0] * e.data[1]);
  port.postMessage(workerResult);
 }
}
#+END_EXAMPLE

** XMLHttpRequest
<<<XMLHttpRequest>>>
#+BEGIN_EXAMPLE
function loadDoc() {
 var xhttp = new XMLHttpRequest();

 // event handlers. Others: onloadstart, onprgress, onabort, onerror, onload, ontimeout, onloadend
 // Always use onload instead of onreadystatechange
 // onload = onreadystatechange and this.readyState ==4
 
 // XHR property: readyState
 // 0: request not initialized, 
 // 1: connection established
 // 2: request received, 
 // 3: processing request
 // 4: request finished and response is ready 
 
 xhttp.onload = function() {
  if (this.status == 200) {
   console.log(
      this.responseText // as text
    , this.responseXML // as it's XML data
    , this.statusText // "OK" or "Not Found"
   );
    
    console.log(xhttp.getAllResponseHeaders());
    xhttp.getResponseHeader("Last-Modified");

  } 
 };

 xhttp.open('GET', 'ajax_info.txt'
 , true // async
 , "username" // optional
 , "psw" // optional
 );

 /* After open() */
 xhttp.setRequestHeader(); // set request header. Especially if 'POST' form fields
 /* For POST
  * xhttp.setRequestHeader("Content-type",'application/x-www-form-urlencoded');
  */

 // For receiving a binary string
 // xhttp.overrideMimeType("text/plain; charset=x-user-defined");


 /* before send(); */

 xhttp.send(); // Nothing when 'GET'
 /* For POST
  * xhttp.send("fname=Henry&lname=Ford");
  */
 
 // binary data can be sent
 /* var blob = new Blob(['abc123'], {type: 'text/plain'});
  * xhttp.send(blob);
  * var myArray = new ArrayBuffer(512);
  * var longInt8View = new Uint8Array(myArray);
  * for (var i=0; i< longInt8View.length; i++) {
  *  longInt8View[i] = i % 255;
  * }
  * xhttp.send(myArray);
  */ 
}
#+END_EXAMPLE

*** application/x-www-form-urlencoded vs multipart/form-data
urlencoded has to transfer extra data if large amount of binary data is sent.

multipart/form-data
- Request header
  - Content-Type: multipart/form-data; boundary=--user-agent-sets-this-boundary
- Request Payload
#+BEGIN_EXAMPLE
--user-agent-sets-this-boundary
Content-Disposition: form-data; name="gv-inv_image"; filename="alectra-APP-dynamic-card.jpg"
Content-Type: image/jpeg



--user-agent-sets-this-boundary--
#+END_EXAMPLE

*** FormData to send file
Supports all browsers except IE 9 and below.

#+BEGIN_EXAMPLE
<input type="file" id="gv-inv_image">

var fileInputElement = document.getElementById('gv-inv_image');

var formData = new FormData();

formData.append("username", "Groucho");
formData.append("accountnum", 123456); // number 123456 is immediately converted to a string "123456"

// if value is not string or Blob or file, it will be converted to string

// HTML file input, chosen by user
formData.append("userfile", fileInputElement.files[0]);

// you can check the file before it gets uploaded

// JavaScript file-like object
var content = '<a id="a"><b id="b">hey!</b></a>'; // the body of the new file...
var blob = new Blob([content], { type: "text/xml"});

formData.append("webmasterfile", blob);

var request = new XMLHttpRequest();
request.open("POST", "http://foo.com/submitform.php");
request.send(formData);
// request content type is multipart/form-data
#+END_EXAMPLE

php
#+BEGIN_EXAMPLE
if (isset($_FILES['gv-inv_image'])) {
  $file         = $_FILES['gv-inv_image']['name'];
  $ext          = pathinfo($file, PATHINFO_EXTENSION);
  $filename = sha1(rand(25, 1920) . rand(72, 2560)) . '-' . time();
  $filename = strtoupper($filename) . '.' . $ext;
  if (move_uploaded_file($_FILES['gv-inv_image']['tmp_name'], '../uploads/' . $filename)) {
      $result = ['status' => 'OK', 'filename' => $filename];
  }
  else {
      $result = ['status' => 'ERR', 'message' => 'File Move Error.'];
  }
}
#+END_EXAMPLE

*** Receive binary as arraybuffer or blob
#+BEGIN_EXAMPLE
var oReq = new XMLHttpRequest();
oReq.open("GET", "/myfile.png", true);
oReq.responseType = "arraybuffer";

oReq.onload = funciton(event) {
 var arrayBuffer = oReq.response; // not .responseText
 if (arrayBuffer) {
  // Read arraybuffer
  var byteArray = new Uint8Array(arrayBuffer);
  for (var i=0; i < byteArra.byteLength; i++) {
   // do something
  }
  // Read arraybuffer.

  // Construct a blob from arraybuffer
  var blob = new Blob( [arrayBuffer], {type: "image/png"} ); 

 }
};

oReq.send();
#+END_EXAMPLE

Specify the received data is blob
#+BEGIN_EXAMPLE
var oReq = new XMLHttpRequest();
oReg.open("GET", "/myfile.png", true);
oReq.responseType = "blob";

oReq.onload = function(e) {
 var blob = oReq.response;
}

oReq.send();
#+END_EXAMPLE

** File handling
https://developer.mozilla.org/en-US/docs/Web/API/File/Using_files_from_web_applications

** Apply XSLT on XML
#+BEGIN_EXAMPLE
function loadXMLDoc(filename) {
 var xhttp = new XMLHttpRequest();
 xhttp.open("GET", filename, false);
 try {
  xhttp.responseType = "msxml-document";
 }
 catch(err) {}
 xhttp.send();
 return xhttp.responseXML;
}

var xml = loadXMLDoc('cdcatalog.xml');
var xsl = loadXMLDoc('cdcatalog.xsl');

var xsltProcessor = new XSLTProcessor();
xsltProcesser.importStylesheet(xsl);
resultDocument = xsltProcesser.transformToFragment(xml, document);
document.getElementById("example").appendChild(resultDocument);

#+END_EXAMPLE

** Apply XPath
#+BEGIN_EXAMPLE
var x=loadXMLDoc("books.xml");
var xml = x.responseXML;
path = "/bookstore/book[1]/title";

var nodes = xml.evaluate(path, xml, 
null, // namespaceResolver
XPathResult.ANY_TYPE, // resultType
null // If an existing XPathResult object is specified, it will be reused
); // Return xpathResult object 
var result = nodes.iterateNext();

while (result) {
 console.log(result.childNodes[0].nodeValue);
 result = nodes.iterateNext();
} 

#+END_EXAMPLE

** WebSocket <<<js:ws>>>
Javascript on client (e.g. web browser)
#+BEGIN_EXAMPLE
var connection = new WebSocket('ws://abc.com/echo', ['soap', 'xmpp']);
// ['soap', 'xmpp'] are subprotocols

// When connection is open, send some data
connection.onopen = function() {
 connection.send('Ping'); // send string
};

// When connection close
connection.onclose = function() {
  // do something
};

// Send ArrayBuffer as binary
var img = canvas_context.getImageData(0, 0,400, 320);
var binary = new Unit8Array(img.data.length);
for (var i = 0; i < img.data.length; i++) {
 binary[i] = img.data[i];
}
connection.send(binary.buffer);

// Send file as Blob
var file = document.querySelector('input[type="file"]').files[0];
connection.send(file);

connection.onerror = function(error) {
 console.log('WebSocket Error ' + error);
};

connection.onmessage = function(e) {
 console.log(e.data);
};

// Define binary type before onmessage to receive binary
connection.binaryType = 'arraybuffer'; // or blob
connection.onmessage = function(e) {
 console.log(e.data.byteLength);
};
#+END_EXAMPLE

** Mutation Observer
<<<js:MutationObserver>>>
[[https://developer.mozilla.org/en/docs/Web/API/MutationObserver][MDN MutationObserver]]
[[https://developer.mozilla.org/en-US/docs/Web/API/MutationRecord][MDN MutationRecord]]

#+BEGIN_EXAMPLE
MutationObserver = window.MutationObserver;

// callback function has 2 arguments
// mutations: an array of objects of type MutationRecord
// observer: this MutationObserver instance
var observer = new MutationObserver(function (mutations, observer) {
  mutations.forEach(function (mutation) {

    // A MutationRecord has properties
    // Some of them might be different based on MutationObserver's options

    // Loop addedNodes
    // addedNodes return NodeList which doesn't have .forEach
    // js:Function.call
    Array.prototype.forEach.call(
      mutation.addedNodes,
      function (addedNode) {
        if (addedNode.id == "bar") {
          console.log("bar was added!");
        }
      });
  });
});

// Define the parent element
var target = document.getElementById('foo');
// Or $('#foo').get(0)

// Which event should be observed
var config = {
  attributes: true,
  attributeOldValue: true, // set to true if attributes is set to true
  attributeFilter: true, // filter out an array of attribute local names in observation
  childList: true, // add/remove child elements including text nodes
  subtree: true, // any change to the subtree including all descendants
  characterData: true, // maybe image or multimedia changes?
  characterDataOldValue: true
};

observer.observe(target, config);

// You may stop observing later
observer.disconnect();
#+END_EXAMPLE

** Testing
*** Unit Testing
QUnit

** Worker
Workers are in external files, they don't have access to
- window object
- document obj
- parent obj
#+BEGIN_EXAMPLE
var w;
if (typeof(Worker) !== "undefined") {
  if (typeof(w) == "undefined") {
    w = new Worker("demo_workers.js");
  }
  w.onmessage = function(e) {
    console.log(e.data);
  }
}
else {
  // Worker not supported
}

// demo_workers.js
var i=0;
function timedCount() {
  i= i +1;
  postMessage(i);
  setTimeout("timedCount()", 500);
}
timedCount();
#+END_EXAMPLE

** iFrame
*** Communication Between Children Window and Parent Window
A parent window can have multiple iframes and iframes are loaded from other domain.

#+BEGIN_EXAMPLE
// Post message from iFrame to parent Window
// In iframe
parent.postMessage('the message','*');
// or window.top.postMessage

// In parent window
function receiveMessage(event) {
 if (event.origin !== 'http://otherdomain.com') return;
 console.log(event.data);
}
window.addEventListener("message", receiveMessage, false);
#+END_EXAMPLE

#+BEGIN_EXAMPLE
// Post message from parent window to iFrame
// In parent window
window.onload = function() {
  var receiver = document.getElementById("#iFrameID").contentWindow;
  receiver.postMessage('Hello', 'http://iframe.src.domain'); // '*' for any domain of any receiver
}

// In iFrame
window.onload = function() {
  function receiveMessage(e) {
    if (e.origin !== "http://parent.window.domain") return;
    alert(e.data);
  }
  window.addEventListener('message', receiveMessage);
}
#+END_EXAMPLE

*** Dynamic iframe height
This code requires the iframe domain is same origin.
#+BEGIN_EXAMPLE
<iframe id="preview_iframe" style="width:100%"
        onload="resize_iframe(this)"
        srcdoc="<?php echo str_replace('"', '&quot;', $html);?>"
>
</iframe>
<script>
function resize_iframe(iframe) {
  iframe.height= iframe.contentWindow.document.body.scrollHeight + 'px';
}
</script>
#+END_EXAMPLE

*** Responsive iframe
Refer to bootstrap:responsive helpers

** setTimeout recall
#+BEGIN_EXAMPLE
function runTimeout() {
  setTimeout(function() {
    if (window.googletag && googletag.apiReady) {
      // do something
    }
    else {
      //console.log('googletag is not ready');
      runTimeout();
    }
  }, 5000);
}
#+END_EXAMPLE

** CSS Media Viewport Size
<<<js:viewport size>>>
window.innerWidth is width including scrollbars
document.body.clientWidth is width excluding scrollbars

=var w = Math.max(window.innerWidth || 0, document.body.clientWidth)=
=var h = Math.max(window.innerHeight || 0, document.body.clientHeight)=

** Use Cases
*** Click to anchor
#+BEGIN_EXAMPLE
<div onclick="goToAnchor('gotoanchor-section-name')">
  something here
</div>

<div class="spacer" id="gotoanchor-section-name"></div>

<div> Content I want to go to </div>

<script>
  function goToAnchor(anchor) {
    var loc = document.location.toString().split('#')[0];
    document.location = loc + '#' + anchor;
    return false;
  }
</script>
#+END_EXAMPLE

*** Get radio value, Event on radio buttons
#+BEGIN_EXAMPLE
<input type="radio" name="genderS" value="1" checked> Male
<input type="radio" name="genderS" value="0"> Female

function getRadioValue(name) {
  var radios = document.getElementsByName(name);
  if (!!radios && radios.length > 0) {
    for (var i = 0, length = radios.length; i < length; i++) {
      if (radios[i].checked) {
        return radios[i].value; // only one radio can be logically checked, don't check the rest
      }
    }
  }
  return null;
}

getRadioValue('genderS');



#+END_EXAMPLE

* jQuery
** Closure and document ready

Closure
#+BEGIN_EXAMPLE
(function($){
  // can do something like 
  $.fn.function_name = function(x){};
})(jQuery);
#+END_EXAMPLE

Document ready shorthand

#+BEGIN_EXAMPLE
$(function(){

});
#+END_EXAMPLE

** Ajax
$.get(url[, data] [, success], [, dataType] )
$.post(url[, data] [, success], [, dataType] )
#+BEGIN_EXAMPLE
$.ajax({
 method: 'POST', // Default: GET
// Prior to 1.9.0, use type instead of method
 url: "some.php", // Default current page
 data: { name: "a", location: "Boston" } // Data send to server. Converted as URL parameters
// if data is not key/value pairs, change processData to false
 processData: true, 
// If data is not key/value pairs (object), say it's a DOMDocument, change it to false

 contentType: 'applicaton/x-www-form-urlencoded;charset=UTF-8', // Default. MIME type

 dataType: "json", // Default is not setting anything. MIME type of response
// > v1.5, this option can convert response to the MIME types you want
// "json xml" :: first it will try to convert to json. if failed, convert ot xml
// "script" :: the response is javascript, and it will be run afer it's received.

// cross domain should be automatically handled
// crossDomain: default false for same-domain requests, true for cross-domain requests

 context: document.body, // provide context for callbacks. If not set, this referrence
// in callbacks is the Ajax request settings

 cache: true, // You can only change cache for HEAD and GET requests.
 
 headers: {}, // Default. Add (or add to overwrite) request header

// Callback options
 beforeSend: function(jqXHR, settings) {
  // Modify jqXHR object before it is sent.
  // e.g. request header
  // For receiving binary string (image or any binary data)
  // jqXHR.overrideMimeType("text/plain; charset=x-user-defined");
 },
 error: function(jqXHR, textStatus, errorThrown) {
  // if request fails.
 },
 dataFilter: function( data, type) {
  // raw response data
  // dataType option
  // You should sanitize the data here so to match the dataType option
 },
 success: function( data, textStatus, jqXHR ) {
 }, 
 complete: function( jqXHR, textStatus) {}

})
/* Promise callbacks: .done, .fail, .always. In those callbacks, 
`this` reference is the `context` in the request. If `context` was not set, `this` 
will be the Ajax setting.
You can add multiple promise callbacks.
*/
.done(function(data, textStatus, jqXHRmsg) {
// .success() will be deprecated in v3.0


})
.fail(function(jqXHR, textStatus, errorThrown) {
// .error() will be deprecated in v3.0
})
.always(function(data|jqXHR, textStatus, jqXHR|errorThrown) {
// .complete() will be dprecated in v3.0

});
#+END_EXAMPLE

** <<<jQuery Selectors>>>, Loop through found elements
You can use all CSS Selectors

http://api.jquery.com/category/selectors/

#+BEGIN_EXAMPLE
$('li').each(function(i) {
 // i = 0, 1, etc.
 $(this).addClass("foo");
});
#+END_EXAMPLE

First matched element
#+BEGIN_EXAMPLE
var iframeId = $("#div-iframe").find('iframe').get(0).id;
#+END_EXAMPLE

** iFrame refer to parent
#+BEGIN_EXAMPLE
var parentVideoDiv = parent.jQuery('#videoplayer').parent('.the-content');
#+END_EXAMPLE

** Get parent element, sibling
#+BEGIN_EXAMPLE
var parentDiv = jQuery('#videoplayer').parent('.content');
var siblingDiv = parentDiv.prev(); // preceding sibling
#+END_EXAMPLE

** Pass $(this) to javascript function
$(this) is jQuery object, but this is a normal this
#+BEGIN_EXAMPLE
function doFunc(obj) {
  obj.className = 'hello'; // className is a normal javascript function
}
$('li').each(function() {
  doFunc(this);
});
#+END_EXAMPLE

** Replace class

#+BEGIN_EXAMPLE
parentDiv.removeClass('col-md-9').addClass('col-md-12');
#+END_EXAMPLE

Or remove a class if it exists or add a class if it doesn't

#+BEGIN_EXAMPLE
$('#id').toggleClass('col-md-9 col-md-12');
#+END_EXAMPLE

** Find inside an element
#+BEGIN_EXAMPLE
siblingDiv.find(".panel.panel-default");
#+END_EXAMPLE

** Move element
#+BEGIN_EXAMPLE
/* Before
.siblingDiv
.parentDiv
*/
siblingDiv.insertAfter(parentDiv);
/* After
.parentDiv
.siblingDiv
*/
#+END_EXAMPLE

** Add Style
#+BEGIN_EXAMPLE
var selector = jQuery('#id');
selector.attr('style', function(i,s) { return s + ' visible: visible !important' });
#+END_EXAMPLE

** Form
*** serialize
Checkboxes and radio buttons are included only if they're checked.
All seriailized form field elements must have name attribute.

#+BEGIN_EXAMPLE
$("#form_id").on("submit", function(e) {
 event.preventDefault();
 console.log($(this).serialize());
});
#+END_EXAMPLE

*** Disabled Field
Disabled fields are not editable, selectable, copyable and they are not submitted.
In order to select and copy value of a disabled field, you need to enable it when mouseover and disable it
when mouseout.

Can't register events directly on disabled fields. Events can be registered on its parent

#+BEGIN_EXAMPLE
$('.parent_container')
  .mouseover(function() { $(this).find('textarea').prop('disabled',false)})
  .mouseout(function() { $(this).find('textarea').prop('disabled',true)});
#+END_EXAMPLE

** Animate
*** Scroll
#+BEGIN_EXAMPLE
$("html,body").animate({ 
 scrollTop: $("[ng-controller=aController]").offset().top - 100 
});
#+END_EXAMPLE

** Viewport Change Event
js:viewport size
$(window).resize(function() {
  consoel.log($(window).width()); // integer without unit
});

** jQuery UI: Dialog
<<<jqueryui:dialog>>>

#+BEGIN_EXAMPLE
<div id="interstitial">
 <!-- script tag inside the container will be run every time the dialog is opend! 
      Consider remove script tag before .dialog and reattach javascript later.
      Content inside the container will be removed and then added to div.ui-dialog at the bottom of DOM.
 -->
</div>
#+END_EXAMPLE

#+BEGIN_EXAMPLE
jQuery(function(){
  jQuery("#interstitial").dialog({
    width: 'auto', /* no scrollbar, auto fit content */
    height:'auto',
    resizable: false,
    draggable: false, /* movable */
    closeOnEscape: true,

    /* Add extra buttons below the content
    buttons: [{
      text: 'ok',
      icons: {primary: "ui-icon-closethick"},
      click: function() {jQuery(this).dialog("close");}
    }],
    */

    modal: true, /* add background to isolate the modal box */
    create: function (event, ui) {
      jQuery("#ui-dialog-title-dialog").hide();
      /* custom background/overlay */
      jQuery(".ui-widget-content").css({"background-color":"transparent","background":"transparent","border":"none"});
      /* title bar is transparent */
      jQuery(".ui-dialog-titlebar").css({"background-color":"transparent","background":"transparent","border":"none"});

      jQuery(".ui-dialog-titlebar").removeClass('ui-widget-header');
      // Change the default title & close button to a custom link
      //jQuery(".ui-dialog-titlebar").html('<a href="#" role="button"><span class="myCloseIcon" style="color:white;">X close</span></a>')
     
      // You can still load/modify the content here and the width/height will still be auto fit
    },
    open: function() {
      /* custom background */
      jQuery('.ui-widget-overlay').addClass('custom-overlay');

      /* Customize the default close button: only X displays */
      jQuery(this).closest(".ui-dialog")
        .find(".ui-dialog-titlebar-close")
        .removeClass("ui-dialog-titlebar-close")
        .html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");
      jQuery(".ui-dialog-titlebar button").css({"border":"none"});

      /* Close dialog when click outside */
      jQuery('.ui-widget-overlay').bind('click',function(){
        jQuery("#interstitial").dialog('close');
      })
    },
    close: function() {
      /* custom background/overlay */
      /*
      * .ui-widget-overlay.custom-overlay
       {
       background-color: black;
       background-image: none;
       opacity: 0.9;
       }
      * */
      jQuery('.ui-widget-overlay').removeClass('custom-overlay');
    }
  });

  /* bind events for custom buttons created
  jQuery("span.myCloseIcon").click(function() {
    jQuery("#interstitial").dialog( "close" );
  });
  */
});
#+END_EXAMPLE

** jQuery UI: Sortable
#+BEGIN_EXAMPLE
$(function() {
    $("#slideshow-pictures").sortable({
      items:'.dz-preview',
      cursor: 'move',
      opacity: 0.5,
      containment: '#slideshow-pictures',
      distance: 20,
      tolerance: 'pointer'
    });
  });
#+END_EXAMPLE

* javascript Plugins
** TweenLite, TweenMax, Greensock
TweenMax has other common plugins included e.g. CSSPlugin where you can ease CSS property changes.
TweenLite has to manually include these plugins.

#+BEGIN_EXAMPLE
TweenLite.to( [target object], [duration in seconds], [destination values] );

TweenLite.to(active_slide,0.5,{marginLeft:'-50%',ease:Power3.easeOut});
#+END_EXAMPLE

*** dest:css, relative value
It's important that you remove all dashes (-) from the css property names and use camelCase.
#+BEGIN_EXAMPLE
TweenLite.to(logo, 2, {left:"542px",
                       backgroundColor:"black",
                       borderBottomColor:"#90e500",
                       color:"white"});
#+END_EXAMPLE

Adding a += or -= prefix tells GSAP to treat a value as relative to whatever it is when the tween renders the first time. For example, if "left" is currently 50px and you tween to "+=100px", it will end up at 150px. Don't forget to put quotes around the value.

#+BEGIN_EXAMPLE
TweenLite.to(logo, 0.5, {left:"+=100px"});
#+END_EXAMPLE

*** dest:ease, easeIn (begin), easeOut (the end), easeInOut (both)
https://greensock.com/docs/Easing

Power0 is linear

#+BEGIN_EXAMPLE
TweenLite.to(logo, 3, {left:"440px", ease:Bounce.easeOut});
#+END_EXAMPLE

*** dest:delay in seconds

*** Use Case
**** Slideshow
#+BEGIN_EXAMPLE
<section id="slider-wrap" class="home-slide inner">

  <div id="slides-frame">

    <div id="active-slide" class="slide-img"
         style="background:transparent url('1.jpg') no-repeat center 15%;background-size:cover;-webkit-transform: translateZ(0);">
      <div class="background-screen">
        <div class="page-wrap">
          <div class="slide-headline">
            <h2>Slide #1 Title</h2>
            <p class="quote">Slide #1 Paragraph</p>
            <p class="quote-name">Slide #1 Paragraph</p>
            <a href="#">Slide #1 Button</a>
          </div>
        </div>
      </div>
    </div>

    <div id="next-slide" class="slide-img"
         style="background:transparent url('2.jpg') no-repeat center 25%;background-size:cover;-webkit-transform: translateZ(0);">
      <div class="background-screen">
        <div class="page-wrap">
          <div class="slide-headline">
            <h2>Slide #2 Title</h2>
            <p class="quote">Slide #2 Paragraph</p>
            <p class="quote-name">Slide #2 Paragraph</p>
            <a href="#">Slide #2 Button</a>
          </div>
        </div>
      </div>
    </div> <!-- #next-slide -->

  </div> <!-- #slides-frame -->
</section>

<!-- @@ Slideshow Data: -->
<div id="slideshow-data" style="display:none!important;">
  <div class="slideshow-data-item"
       style="background:transparent url('1.jpg') no-repeat center 15%;background-size:cover;-webkit-transform: translateZ(0);">
    <div class="background-screen">
      <div class="page-wrap">
        <div class="slide-headline">
          <h2>Slide #1 Title</h2>
          <p class="quote">Slide #1 Paragraph</p>
          <p class="quote-name">Slide #1 Paragraph</p>
          <a href="#">Slide #1 Button</a>
        </div>
      </div>
    </div>
  </div>

  <div class="slideshow-data-item"
       style="background:transparent url('2.jpg') no-repeat center 25%;background-size:cover;-webkit-transform: translateZ(0);">
    <div class="background-screen">
      <div class="page-wrap">
        <div class="slide-headline">
          <h2>Slide #2 Title</h2>
          <p class="quote">Slide #2 Paragraph</p>
          <p class="quote-name">Slide #2 Paragraph</p>
          <a href="#">Slide #2 Button</a>
        </div>
      </div>
    </div>
  </div>

  <div class="slideshow-data-item"
       style="background:transparent url('3.jpg') no-repeat center left;background-size:cover;-webkit-transform: translateZ(0);">
    <div class="background-screen">
      <div class="page-wrap">
        <div class="slide-headline">
          <h2>Slide #3 Title</h2>
          <p class="quote">Slide #3 Paragraph</p>
          <p class="quote-name">Slide #3 Paragraph</p>
          <a href="#">Slide #3 Button</a>
        </div>
      </div>
    </div>
  </div>

</div> <!-- #slideshow-data -->
#+END_EXAMPLE

#+BEGIN_EXAMPLE
.page {
  max-width:1200px;
  width:90%;
  margin:0 auto;
}
.home-slide.inner {
  height: 550px; /* media query change height */
  overflow: hidden;
}
#slides-frame {
  width:200%!important;
  position:relative;
  height:550px;
}
#active-slide, #next-slide {
  position:relative;
  display:inline-block;
  width:50%;
  height:100%;
  vertical-align:top;
}
#slides-frame .background-screen {
  position:relative;
  height:100%;
  width:100%;
  overflow-y:hidden;
  background:rgba(0,0,0,0.35); /* darken bg image */
}
.slide-wrap {
  /* Text content width */
  width:1200px; /* media query change width */
  /* width:100%; */
  height:100%;
  overflow:visible;
  margin:0 auto;
}
.slide-headline {
  position:absolute;
  left:0;
  bottom:0;
  margin-bottom:155px; /* media query change margin-bottom */
}
#+END_EXAMPLE

#+BEGIN_EXAMPLE
window.onload = init();
function init() {
  slideshow_checker();
}
function slideshow_checker() {
  var slideshow_data = document.getElementById('slider-wrap');
  if (slideshow_data != null) {
    slideshow(0, 'time', 7000);
  }
}

var timer;
function slideshow(id, type, time_length) {

  var active_slide = document.getElementById('active-slide'),
    active_slide_style = active_slide.getAttribute('style');
  var next_slide = document.getElementById('next-slide');


  /* -- COUNT SLIDE NUM -- */
  var slideshow_data = document.getElementById('slideshow-data');
  var slides = slideshow_data.getElementsByClassName('slideshow-data-item');
  var slide_count = slides.length;

  var nxt_id, nxt_nxt_id, prev_id;
  nxt_id = (id + 1);
  prev_id = (id - 1);

  if (nxt_id == slide_count) {
    nxt_id = 0;
  }
  if ((id == 0)) {
    prev_id = (slide_count - 1);
  }

  //  arr_left.setAttribute('onclick','javascript:get_slide('+prev_id+')');
  //    arr_right.setAttribute('onclick','javascript:get_slide('+nxt_id+')');

  if (type == 'click') {
    var next_slide_data = slides[id].getAttribute('style');
    var next_slide_html = slides[id].innerHTML;
    next_slide.innerHTML = next_slide_html;
    next_slide.setAttribute('style', next_slide_data);

  }
  else {
    var next_slide_data = slides[nxt_id].getAttribute('style');
    var next_slide_html = slides[nxt_id].innerHTML;
    next_slide.innerHTML = next_slide_html;
    next_slide.setAttribute('style', next_slide_data);
  }

  timer = setTimeout(function () {
    TweenLite.to(active_slide, 0.5, {marginLeft: '-50%', ease: Power3.easeOut});
    setTimeout(function () {

      active_slide.setAttribute('style', next_slide.getAttribute('style'));

      TweenLite.to(active_slide, 0, {marginLeft: '0%'});

      active_slide.innerHTML = next_slide_html;

      /* -- RUN LOOP() --- */
      setTimeout(function () {
        if (type == 'time') {
          slideshow(nxt_id, 'time', 7000);
        }
        else {
          slideshow(nxt_id, 'time', time_length);
        }
      }, 0);

    }, 1000);
  }, time_length);

}
#+END_EXAMPLE

** Select2
https://select2.org/ Depends on jQuery

*** Basic
#+BEGIN_EXAMPLE
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>
#+END_EXAMPLE

#+BEGIN_EXAMPLE
<select class="js-example-basic-single" name="state">
  <option value="AL">Alabama</option>
    ...
  <option value="WY">Wyoming</option>
</select>
$(document).ready(function() {
    $('.js-example-basic-single').select2();
});
#+END_EXAMPLE

*** Internal Option data, <optgroup>
Select2 converts each <option> in this JSON
#+BEGIN_EXAMPLE
{
  "id": "value attribute" || "option text",
  "text": "label attribute" || "option text",
  "element": HTMLOptionElement
}

// <optgroup>

{
  "text": "label attribute",
  "children": [ option data object, ... ],
  "element": HTMLOptGroupElement
}
#+END_EXAMPLE

#+BEGIN_EXAMPLE
<select>
  <optgroup label="Group Name">
    <option>Nested option</option>
  </optgroup>
</select>
#+END_EXAMPLE

*** config:ajax
Supply JSON to Select2
#+BEGIN_EXAMPLE
{
  "results": [
    {
      "id": 1,
      "text": "Option 1"
    },
    {
      "id": 2,
      "text": "Option 2",
      "selected": true
    },
    {
      "id": 3,
      "text": "Option 3",
      "disabled": true
    }
  ]
}
#+END_EXAMPLE

ajax is triggered every time the user types in the search box.

By default, these parameters are sent
term :: search term
q :: same as term
_type :: a request type
page ::

e.g. https://api.github.com/search/repositories?term=sel&_type=query&q=sel

#+BEGIN_EXAMPLE
$('#mySelect2').select2({
  ajax: {
    url: 'https://api.github.com/orgs/select2/repos',
    data: function (params) {
      var query = {
        search: params.term,
        type: 'public'
      }

      // Query parameters will be ?search=[term]&type=public
      return query;
    }
  }
});
#+END_EXAMPLE

#+BEGIN_EXAMPLE
$('#mySelect2').select2({
  ajax: {
    url: '/example/api',
    processResults: function (data) {
      // Tranforms the top-level key of the response object from 'items' to 'results'
      return {
        results: data.items
      };
    }
  }
});
#+END_EXAMPLE

Pagination
#+BEGIN_EXAMPLE
$('#mySelect2').select2({
  ajax: {
    url: 'https://api.github.com/search/repositories',
    data: function (params) {
      var query = {
        search: params.term,
        page: params.page || 1
      }

      // Query parameters will be ?search=[term]&page=[page]
      return query;
    }
  }
});
#+END_EXAMPLE

If the response has pagination.more prop
#+BEGIN_EXAMPLE
{
  "results": [
    {
      "id": 1,
      "text": "Option 1"
    },
    {
      "id": 2,
      "text": "Option 2"
    }
  ],
  "pagination": {
    "more": true
  }
}
#+END_EXAMPLE

If not, then do it manually. response provides count_filtered that shows the total number.
#+BEGIN_EXAMPLE
processResults: function (data, params) {
    params.page = params.page || 1;

    return {
        results: data.results,
        pagination: {
            more: (params.page * 10) < data.count_filtered
        }
    };
}
#+END_EXAMPLE

*** config:data
Load local Javascript array to Select2
#+BEGIN_EXAMPLE
var data = [
    {
        id: 0,
        text: 'enhancement'
    },
    {
        id: 1,
        text: 'bug'
    },
    {
        id: 2,
        text: 'duplicate'
    },
    {
        id: 3,
        text: 'invalid'
    },
    {
        id: 4,
        text: 'wontfix'
    }
];

$(".js-example-data-array").select2({
  data: data
})

$(".js-example-data-array-selected").select2({
  data: data
})
#+END_EXAMPLE

*** config:templateResult, Template
#+BEGIN_EXAMPLE
function formatState (state) {
  if (!state.id) {
    return state.text;
  }
  var baseUrl = "/user/pages/images/flags";
  var $state = $(
    '<span><img src="' + baseUrl + '/' + state.element.value.toLowerCase() + '.png" class="img-flag" /> ' + state.text + '</span>'
  );
  return $state;
};

$(".js-example-templating").select2({
  templateResult: formatState
});
#+END_EXAMPLE

*** config:templateSelection, Change display of selected value
#+BEGIN_EXAMPLE
function formatState (state) {
  if (!state.id) {
    return state.text;
  }
  var baseUrl = "/user/pages/images/flags";
  var $state = $(
    '<span><img src="' + baseUrl + '/' + state.element.value.toLowerCase() + '.png" class="img-flag" /> ' + state.text + '</span>'
  );
  return $state;
};

$(".js-example-templating").select2({
  templateSelection: formatState
});
#+END_EXAMPLE

*** config:maximumSelectionLength
#+BEGIN_EXAMPLE
$(".js-example-basic-multiple-limit").select2({
  maximumSelectionLength: 2
});
#+END_EXAMPLE

*** config:placeholder
First option has to be empty without any selected option
#+BEGIN_EXAMPLE
<select class="js-example-placeholder-single js-states form-control">
  <option></option>
</select>

$(".js-example-placeholder-single").select2({
    placeholder: "Select a state",
    allowClear: true
});
#+END_EXAMPLE

placeholder can be an existing <option>
#+BEGIN_EXAMPLE
$('select').select2({
  placeholder: {
    id: '-1', // the value of the option
    text: 'Select an option'
  }
});
#+END_EXAMPLE

*** config:allowClear
Add a x for clearing
#+BEGIN_EXAMPLE
$('select').select2({
  placeholder: 'This is my placeholder',
  allowClear: true
});
#+END_EXAMPLE

*** config:width
Default is 'resolve' which is to take the style attribute of <select>, if not, fall back to computed element width ('element').

To make sure the field always takes 100% width of parent, use this
#+BEGIN_EXAMPLE
width: '100%'
#+END_EXAMPLE

*** config:tags
User can type a new option and then select it
#+BEGIN_EXAMPLE
<select class="form-control">
  <option selected="selected">orange</option>
  <option>white</option>
  <option>purple</option>
</select>

$(".js-example-tags").select2({
  tags: true
});

// multiple
<select class="form-control" multiple="multiple">
  <option selected="selected">orange</option>
  <option>white</option>
  <option selected="selected">purple</option>
</select>
#+END_EXAMPLE

*** config:tokenSeparators
User can type a space or a comma to add existing or type new option.
#+BEGIN_EXAMPLE
$(".js-example-tokenizer").select2({
    tags: true,
    tokenSeparators: [',', ' ']
})
#+END_EXAMPLE

*** config:createTag
After a new option is created by typing in config:tags, add properties to this new option
Reject creating a new option by returning null
#+BEGIN_EXAMPLE
$('select').select2({
  createTag: function (params) {
    var term = $.trim(params.term);

    if (term === '') {
      return null;
    }

    return {
      id: term,
      text: term,
      newTag: true // add additional parameters
    }
  }
});
#+END_EXAMPLE

*** config:insertTag
After a new option is created by typing in config:tags, do something about it
#+BEGIN_EXAMPLE
$('select').select2({
  insertTag: function (data, tag) {
    // Insert the tag at the end of the results
    data.push(tag);
  }
});
#+END_EXAMPLE

*** config:matcher, config:minimumInputLength, config:minimumResultsForSearch, Search
For single select, a search box is added to search each option. This search can be customized.

It only works for locally supplied data.

#+BEGIN_EXAMPLE
function matchCustom(params, data) {
    // If there are no search terms, return all of the data
    if ($.trim(params.term) === '') {
      return data;
    }

    // Do not display the item if there is no 'text' property
    if (typeof data.text === 'undefined') {
      return null;
    }

    // `params.term` should be the term that is used for searching
    // `data.text` is the text that is displayed for the data object
    if (data.text.indexOf(params.term) > -1) {
      var modifiedData = $.extend({}, data, true);
      modifiedData.text += ' (matched)';

      // You can return modified objects from here
      // This includes matching the `children` how you want in nested data sets
      return modifiedData;
    }

    // Return `null` if the term should not be displayed
    return null;
}

$(".js-example-matcher").select2({
  matcher: matchCustom,
  minimumInputLength: 3, // only start searching when the user has input 3 or more characters
  minimumResultsForSearch: 20 // at least 20 results must be displayed. -1 or Infinity to permanently hide the search box.
  // minimumResultsForSearch: Infinity,
});
#+END_EXAMPLE

*** Methods, add, select, clear
add
#+BEGIN_EXAMPLE
// after $.append, <select> will have the new option

<select id="mySelect2">
var data = {
    id: 1,
    text: 'Barn owl'
};

var newOption = new Option(data.text, data.id, false, false);
$('#mySelect2').append(newOption).trigger('change');

// create if not exists

// Set the value, creating a new option if necessary
if ($('#mySelect2').find("option[value='" + data.id + "']").length) {
    $('#mySelect2').val(data.id).trigger('change');
} else { 
    // Create a DOM Option and pre-select by default
    var newOption = new Option(data.text, data.id, true, true);
    // Append it to the select
    $('#mySelect2').append(newOption).trigger('change');
} 
#+END_EXAMPLE

select
#+BEGIN_EXAMPLE
$('#mySelect2').val('1'); // Select the option with a value of '1'
$('#mySelect2').trigger('change'); // Notify any JS components that the value changed

$('#mySelect2').val(['1', '2']);
$('#mySelect2').trigger('change'); // Notify any JS components that the value changed
#+END_EXAMPLE

clear
#+BEGIN_EXAMPLE
$('#mySelect2').val(null).trigger('change');
#+END_EXAMPLE

*** Method, get
#+BEGIN_EXAMPLE
// returns a array of objects
$('#mySelect2').select2('data');
$('#mySelect2').find(':selected');

// get value
$('#mySelect2').val();

// pure javascript will not work
// document.querySelector('#mySelect2').value;
#+END_EXAMPLE

#+BEGIN_EXAMPLE
$('#mySelect2').select2({
  // ...
  templateSelection: function (data, container) {
    // Add custom attributes to the <option> tag for the selected option
    $(data.element).attr('data-custom-attribute', data.customValue);
    return data.text;
  }
});

// Retrieve custom attribute value of the first selected element
$('#mySelect2').find(':selected').data('custom-attribute');
#+END_EXAMPLE

*** Method, open|close dropdown, if initialized, destroy
#+BEGIN_EXAMPLE
$('#mySelect2').select2('open');

$('#mySelect2').select2('close');

if ($('#mySelect2').hasClass("select2-hidden-accessible")) {
    // Select2 has been initialized
}

$('#mySelect2').select2('destroy');
#+END_EXAMPLE

Custom events need to be unbinded after destroy
#+BEGIN_EXAMPLE
// Set up a Select2 control
$('#example').select2();

// Bind an event
$('#example').on('select2:select', function (e) { 
    console.log('select event');
});

// Destroy Select2
$('#example').select2('destroy');

// Unbind the event
$('#example').off('select2:select');
#+END_EXAMPLE

*** Example
#+BEGIN_EXAMPLE
<button class="js-programmatic-destroy button">Destroy</button>
<button class="js-programmatic-init button">Re-initialize</button>

$(".js-programmatic-destroy").on("click", function () {
    $example.select2("destroy");
});

$(".js-programmatic-init").on("click", function () {
    $example.select2();
});
#+END_EXAMPLE

*** Events
change :: general Javascript select change
change.select2 :: only for Select2 <select> change
select2:selecting :: Triggered before a result is selected. This event can be prevented.
select2:select :: Triggered whenever a result is selected. select2:selecting is fired before this and can be prevented.

#+BEGIN_EXAMPLE
$('#mySelect2').on('select2:select', function (e) {
  var data = e.params.data;
  console.log(data);
});
#+END_EXAMPLE

Trigger an event
#+BEGIN_EXAMPLE
var data = {
  "id": 1,
  "text": "Tyto alba",
  "genus": "Tyto",
  "species": "alba"
};

$('#mySelect2').trigger({
    type: 'select2:select',
    params: {
        data: data
    }
});

$('#mySelect2').trigger('change.select2'); // Notify only Select2 of changes
#+END_EXAMPLE

** Owl Carousel Carousel
https://github.com/OwlCarousel2/OwlCarousel2

Bootstrap's carousel can only show one item like a slideshow.
Owl can have multiple items.

[[https://gist.github.com/levonlee/c198b0a3d0286066aa5ff450bd49cf5e][Example: Owl Carousel + Bootstrap Modal + Bootstrap Carousel]]

** Fine Uploader
https://github.com/FineUploader/fine-uploader
No dependency

** Dropzone
https://github.com/enyo/dropzone/

No dependency

*** Basics
Download the dist folder
#+BEGIN_EXAMPLE
<script src="/dist/dropzone.js"></script>
<link rel="stylesheet" href="/dist/dropzone.css">
<!-- /dist/min/* for production -->
#+END_EXAMPLE

Dropzone will be available as window.Dropzone and jQuery.fn.Dropzone (if jQuery is loaded)

Create Dropzone without javascript (auto discover), Dropzone.options
#+BEGIN_EXAMPLE
<form action="/file-upload" class="dropzone" id="my-awesome-dropzone">
  <!-- hidden input will be submitted -->
  <!-- <input type="hidden" name="addtionaldata" value="1" /> -->
  <div class="fallback">
    <input name="file" type="file" multiple />
  </div>
</form>

<!-- because it's auto discovered, you may need to setup the config -->
// "myAwesomeDropzone" is the camelized version of the HTML element's ID
Dropzone.options.myAwesomeDropzone = {
  paramName: "file", // The name that will be used to transfer the file
  maxFilesize: 2, // MB
  accept: function(file, done) {
    if (file.name == "justinbieber.jpg") {
      done("Naha, you don't.");
    }
    else { done(); }
  }
};
#+END_EXAMPLE

Create with javascript, must have url option.
#+BEGIN_EXAMPLE
// Prevent Dropzone from auto discovering this element:
Dropzone.options.myAwesomeDropzone = false;
// This is useful when you want to create the
// Dropzone programmatically later

// Disable auto discover for all elements:
Dropzone.autoDiscover = false;

// Dropzone class:
var myDropzone = new Dropzone("div#myId", { url: "/file/post"});

// jQuery
$("div#myId").dropzone({ url: "/file/post" });
#+END_EXAMPLE

The file will be posted in backend as
#+BEGIN_EXAMPLE
<input type="file" name="file" />
#+END_EXAMPLE

To make the whole page droppable
#+BEGIN_EXAMPLE
<!--
Don't forget to give this container the dropzone-previews class 
so the previews are formatted correctly.
 -->
<div id="previews" class="dropzone-previews"></div>

<button id="clickable">Click me to select files</button>

var myDropzone  = new Dropzone(document.body, {
  previewsContainer: ".dropzone-previews", // the element must have
  // You probably don't want the whole body
  // to be clickable to select files
  clickable: false
});

// or
<script>
  new Dropzone(document.body, { // Make the whole body a dropzone
    url: "/upload/url", // Set the url
    previewsContainer: "#previews", // Define the container to display the previews
    clickable: "#clickable" // Define the element that should be used as click trigger to select files.
  });
</script>
#+END_EXAMPLE

*** option:function:accept(file, done)
Invoke done() without arguments to accept and process the file.
Invoke done() with an error message to reject the file and show the message.
It won't be invoked if the file is too big or mime type doesn't match.
#+BEGIN_EXAMPLE
accept: function(file, done) {
  if (file.name == "justinbieber.jpg") {
    done("Naha, you don't.");
  }
  else { done(); }
}
#+END_EXAMPLE

*** option:previewsContainer null|string
HTMLElement or a CSS selector. The element should have the .dropzone-previews or dropzone class.

*** option:autoProcessQueue
False :: files will be added to the queue but the queue will not be processed automatically.
Call myDropzone.processQueue() to process the queue.

*** option:previewTemplate String, option:dict*
Default template <<<dropzone:default template>>>
#+BEGIN_EXAMPLE
<div class="dz-preview dz-file-preview">
  <div class="dz-details">
    <div class="dz-filename"><span data-dz-name></span></div>
    <div class="dz-size" data-dz-size></div>
    <!-- img's alt and src will change -->
    <img data-dz-thumbnail />
  </div>
  <div class="dz-progress"><span class="dz-upload" data-dz-uploadprogress><!-- style.width from 0% to 100% --></span></div>
  <div class="dz-success-mark"><span>✔</span></div>
  <div class="dz-error-mark"><span>✘</span></div>
  <div class="dz-error-message"><span data-dz-errormessage></span></div>
  <!-- <a class="dz-remove" href="javascript:undefined" data-dz-remove>Remove file</a> -->
</div>
<!-- Another preview -->
#+END_EXAMPLE

The default template might change from version to version. But console.log(file.previewElement) in any event will output.

.dz-preview gets .dz-processing when the file gets processed, .dz-success when it got uploaded and .dz-error

Make sure custom template has these attributes
- data-dz-name
- data-dz-size
- data-dz-thumbnail
- data-dz-uploadprogress
- data-dz-errormessage

Add a remove button (data-dz-remove)
#+BEGIN_EXAMPLE
<img src="removebutton.png" alt="Click me to remove the file." data-dz-remove />
#+END_EXAMPLE

*** option:addRemoveLInks null:true
Wording: dictCancelUpload, dictCancelUploadConfirmation and dictRemoveFile
dropzone:default template

*** option:translation
**** option:dictCancelUpload, dictCancelUploadConfirmation, dictRemoveFile

*** option:maxFiles int
#+BEGIN_EXAMPLE
Dropzone.options.myAwesomeDropzone = {
  maxFiles: 1,
  accept: function(file, done) {
    console.log("uploaded");
    done();
  },
  init: function() {
    this.on("maxfilesexceeded", function(file){
        alert("No more files please!");
      this.removeFile(file);
    });
  }
};
#+END_EXAMPLE

*** option:maxFilesize int (MB)
event:maxfilesexceeded is called and the whole dropzone element gets the class .dz-max-files-reached

*** option:event:init, add events
It's the best place to add custom events if options are used to setup the dropzone
#+BEGIN_EXAMPLE
// The recommended way from within the init configuration:
Dropzone.options.myAwesomeDropzone = {
  init: function() {
    this.on("addedfile", function(file) { alert("Added file."); });
  }
};
#+END_EXAMPLE

Use this to attach events if dropzone is defined programmatically
#+BEGIN_EXAMPLE
// This example uses jQuery so it creates the Dropzone, only when the DOM has
// loaded.

// Disabling autoDiscover, otherwise Dropzone will try to attach twice.
Dropzone.autoDiscover = false;
// or disable for specific dropzone:
// Dropzone.options.myDropzone = false;

$(function() {
  // Now that the DOM is fully loaded, create the dropzone, and setup the
  // event listeners
  var myDropzone = new Dropzone("#my-dropzone");
  myDropzone.on("addedfile", function(file) {
    /* Maybe display some more file information on your page */
  });
})
#+END_EXAMPLE

*** option:clickable null|true|false|an html element|a CSS selector|array of html
All of those elements will trigger an upload when clicked

*** option:acceptedFiles string of list
comma separated list of mime types of file extensions
#+BEGIN_EXAMPLE
image/*,applicaton/pdf,.psd
#+END_EXAMPLE

*** option:maxThumbnailFilesize (MB), thumbnailWidth, thumbnailHeight, thumbnailMethod
thumbnailMethod :: 'contain' or 'crop' when thumbnailWidth and thumbnailHeight are both defined!

*** event:addedfile
#+BEGIN_EXAMPLE
// Disabling autoDiscover, otherwise Dropzone will try to attach twice.
Dropzone.autoDiscover = false;
// or disable for specific dropzone:
// Dropzone.options.myDropzone = false;

$(function() {
  // Now that the DOM is fully loaded, create the dropzone, and setup the
  // event listeners
  var myDropzone = new Dropzone("#my-dropzone");
  myDropzone.on("addedfile", function(file) {
    /* Maybe display some more file information on your page */
  });
})
#+END_EXAMPLE

*** event:removedfile(file)
*** event:thumbnail(file, dataUrl)
*** event:processing(file)
when a file gets processed

*** event:uploadprogress(file, progress, bytesSent)
progress :: int from 0 to 100

*** event:error(file)
*** event:success(file, responseText)
Display something after a file is uploaded.

myDropzone.files has been appended.

#+BEGIN_EXAMPLE
Dropzone.options.myDropzone = {
  init: function() {
    this.on("success", function(file, responseText) {
      // Handle the responseText here. For example, add the text to the preview element:
      file.previewTemplate.appendChild(document.createTextNode(responseText));
    });
  }
};
#+END_EXAMPLE

Display thumbnail that is created on server after server processes the uploaded image
{ "imageUrl": "http://my.image/file.jpg" }
#+BEGIN_EXAMPLE
Dropzone.options.myDropzone = {
  init: function() {
    this.on("success", function(file, serverResponse) {
      // Called after the file successfully uploaded.

      // If the image is already a thumbnail:
      this.emit('thumbnail', file, serverResponse.imageUrl);

      // If it needs resizing:
      this.createThumbnailFromUrl(file, serverResponse.imageUrl);
    });
  }
};
#+END_EXAMPLE

*** event:complete(file)
*** event:canceled(file)
*** event:maxfilesexceeded(file)
*** event:maxfilesreached(file)
the number of files accepted reaches the maxFiles limit
*** FAQ
https://github.com/enyo/dropzone/wiki/FAQ#how-to-show-files-already-stored-on-server

*** Show error returned by server
Just return HTTP status code in the range of 400-500.
If response Content-Type is text/plain, the text will be returned as error message.
If it's application/json, dropzone uses the error property {"error": "File could not be saved."}

*** Show server response
See event:success(file, responseText)

*** Show files already stored on server
#+BEGIN_EXAMPLE
// Create the mock file:
var mockFile = { name: "Filename", size: 12345 };

// Call the default addedfile event handler
myDropzone.emit("addedfile", mockFile);

// And optionally show the thumbnail of the file:
myDropzone.emit("thumbnail", mockFile, "/image/url");
// Or if the file on your server is not yet in the right
// size, you can let Dropzone download and resize it
// callback and crossOrigin are optional.
myDropzone.createThumbnailFromUrl(file, imageUrl, callback, crossOrigin);

// Make sure that there is no progress bar, etc...
myDropzone.emit("complete", mockFile);

myDropzone.files.push(mockFile);

// If you use the maxFiles option, make sure you adjust it to the
// correct amount:
var existingFileCount = 1; // The number of files already uploaded
myDropzone.options.maxFiles = myDropzone.options.maxFiles - existingFileCount;
#+END_EXAMPLE

*** Sortable
#+BEGIN_EXAMPLE
  $(function() {
    $("#slideshow-pictures").sortable({
      items:'.dz-preview',
      cursor: 'move',
      opacity: 0.5,
      containment: '#slideshow-pictures',
      //distance: 20,
      tolerance: 'pointer',
      update: function (event, ui) {
        var queue = myDropzone.files;
        var newQueue = [];
        $('#slideshow-pictures .dz-preview .dz-filename [data-dz-name]').each(function (count, el) {
          var name = el.innerHTML;
          queue.forEach(function(file) {
            if (file.name === name) {
              newQueue.push(file);
            }
          });
        });
        myDropzone.files = newQueue;
      }
    });
  });

Dropzone.options.slideshowPictures = false;
Dropzone.autoDiscover = false;
var myDropzone = new Dropzone("#slideshow-pictures", {...});
#+END_EXAMPLE

* ES6-ES2015
<<<js:es6>>>
6 stands for 6th edition. 2015 is the year.
ES7-2016, ES8-2017

** Generator Function
You can treat each yield is a stop, and later code could be started when gen.next() is called.
You can assign variable = yield (async requests) and program like they are normal sync. Refer to last example
Refer to nodejs:co for yielding promises
#+BEGIN_EXAMPLE
function* idMaker() {
  var index = 0;
  while (index <3)
    yield index++;
}

var gen = idMaker();
// Generator function is not contructable
// don't use var gen = new idMaker;
// When GF is called, an iterator object is returned and 
// the body is not executed yet.

console.log(gen.next().value);
// when the iterator's next() is called for the first time, 
// the GF body is executed until the 1st yield expression
// when it's called the nth time, the nth yield expression is called.

// Say there are 3 yields in total, when gen.next() is called the 4th time or more
// it will be {value: undefined, done: true}

// Use GF in another GF
function* anotherGenerator(i) {
  var index = 0;
  while (index < 3) {
    index++;
    yield i + index;
  }
}
function* generator(i) {
  yield i;
  yield* anotherGenerator(i);
  yield i + 10;
}
var gen2 = generator(10);
console.log(gen2.next().value); // ...
// 10, 11, 12, 13, 20, done
#+END_EXAMPLE

Passing variable in next(). The variable passed will subsitute the whole yield statement for the previous iteration.
(after the previous yield, and before the next/current yield)
#+BEGIN_EXAMPLE
function* consumer(){
  while (true){
    var val = yield null;
    console.log('Got value', val);
  }
}

var c = consumer();
c.next(1)
// No 'Got value'
c.next(2)
// Got value 2
#+END_EXAMPLE

Usage
Without GF, you will write
#+BEGIN_EXAMPLE
fs.readFile('blog_post_template.html', function(err, tpContent){
  fs.readFile('my_blog_post.md', function(err, mdContent){
    console.log(tpContent, mdContent);
  });
});
#+END_EXAMPLE

With GF
#+BEGIN_EXAMPLE
function readFile(filepath) {
  return function(callback) {
    fs.readFile(filepath, callback);
  }
}

function run(genfun) {
  var gen = genfun();

  function next(err, answer) {
    var res;
    if (err) {
      return gen.throw(err);
    }
    else {
      res = gen.next(answer);
    }

    if (!res.done) {
      res.value(next);
    }
  }

  next();

}

run(function* () {
  try{
    var tpContent = yield readFile('blog_post_template.html');
    var mdContent = yield readFile('my_blog_post.md');
    console.log(tpContent, mdContent);
  }catch(e){
    console.error(e.message);
  }
});
#+END_EXAMPLE

** async/await
<<<js:async/await>>>

async function returns AsyncFunction object which is Promise.resolve. 

await one and only one Promise.

To wait for all promises to finish, use Promise.all

#+BEGIN_EXAMPLE
function resolveAfter2Seconds(x) {
  return new Promise(resolve => {
    setTimeout(() => {
      resolve(x);
    }, 2000);
  });
}


async function add1(x) {
  // start and await Promise in order
  const a = await resolveAfter2Seconds(20);
  const b = await resolveAfter2Seconds(30);
  return x + a + b;
}

add1(10).then(v => {
  console.log(v);  // prints 60 after 4 seconds.
});


async function add2(x) {
  // start Promise all together
  const p_a = resolveAfter2Seconds(20);
  const p_b = resolveAfter2Seconds(30);
  // await each Promise
  return x + await p_a + await p_b;
}

add2(10).then(v => {
  console.log(v);  // prints 60 after 2 seconds.
});
#+END_EXAMPLE

* NodeJS
** Install on Ubuntu
#+BEGIN_EXAMPLE
apt-get update
apt-get install build-essential libssl-dev
#+END_EXAMPLE

Get [[https://github.com/creationix/nvm/releases][nvm version number]] 0.33.1,
#+BEGIN_EXAMPLE
cd ~
curl -sL https://raw.githubusercontent.com/creationix/nvm/v0.33.1/install.sh -o install_nvm.sh
# check the install script
nano install_nvm.sh
bash install_nvm.sh
#+END_EXAMPLE

Directory ~/.nvm and ~/.profile file are created.

Log out and back again or source the file so that current session knows changes
=source ~/.profile=

List Node.js available versions ~nvm ls-remote~
#+BEGIN_EXAMPLE
nvm install 7.1.0
nvm use 7.1.0
# What versions are installed
nvm ls
# Current in-use node version
node -v
# Make one version as default for new sessions
nvm alias default 6.10.2
# Use the default version
nvm use default
# Install npm package to ./node_modules
npm install express
# Install package globally (available to other projects using the same Node.js version)
# ~/.nvm/node_version/lib/node_modules/package_name
npm install -g gulp
# Link global package into local sphere
npm link express

# Remove a package globally, just remove -g for locally
npm remove async -g

# What packages/modules are installed globally, just remove -g for locally
npm ls -g

# modules installed globally usually have an executable command for direct use
# if it's installed locally, usually run ./node_modules/module_name/bin/exec_cmd
#+END_EXAMPLE

https://github.com/nodejs/LTS

** Install on Windows
Download the .msi and install with NPM. Installation path: =C:\Program Files\nodejs\=
Download the latest .msi to upgrade. And upgrade any existing global packages.

Refer to phpstorm:nodejs

#+BEGIN_EXAMPLE
npm cache clean
# Check which global packages are outdated
npm outdated -g
# Update all global packages
npm update -g
# Update one global package
npm install -g <packagename>
#+END_EXAMPLE

** Global Object
console.log is actually global.console.log
https://nodejs.org/api/globals.html

*** __dirname, __filename
Full path of the directory/file of the current module/file

*** console <<<nodejs:console>>>
Backtick
#+BEGIN_EXAMPLE
var a = "World";
console.log(`Hello ${a}`); // Hello World
#+END_EXAMPLE

console.dir(obj[, options]) uses util.inspect()
#+BEGIN_EXAMPLE
showHidden <bool> true
depth <number> 2, can be null
colors <bool> false
#+END_EXAMPLE

*** process
**** process.argv
node app.js --user li --greeting "Good Day Sir"
console.log(process.argv);
//['nodejs installation full path', 'full path to module', '--user', 'li', '--greeting', 'Good Day Sir']

#+BEGIN_EXAMPLE
function grab(flag) {
  var index = process.argv.indexOf(flag);
  return (index === 01) ? null : process.argv[index+1];
}

var greeting = grab('--greeting');
#+END_EXAMPLE

**** stdout
#+BEGIN_EXAMPLE
var q = ['Q1', 'Q2'];
var a = [];
function ask(i) {
  process.stdout.write(`\n\n ${q[i]}`);
  process.stdout.write(' > ');
}

process.stdin.on('data', function(data) {
  answers.push(data.toString().trim());
  if (a.length < q.length) {
    ask(a.length);
  }
  else {
    process.exit();
  }
});

process.on('exit', function() {
  process.stdout.write(`${a[0]}, ${a[1]}, ${a[2]}`);
});

ask(0);
#+END_EXAMPLE

*** module
#+BEGIN_EXAMPLE
// ./lib/Person.js
// some code
module.exports = Person;
// literal object or any Javascript type
// module.exports is the object that is returned by the require statement

// ./app.js
var Person = require('./lib/Person'); // do not include .js
var ben = new Person('Ben');
var george = new Person('George');
#+END_EXAMPLE

*** Timing
#+BEGIN_EXAMPLE
var currentTime = 0;
var percentWaited = 0;

function writePercent(p) {
  process.stdout.clearLine();
  process.stdout.cursorTo(0);
  process.stdout.write(`waiting ... ${p}%`);
}

var interval = setInterval(functino() {
  currentTime += 500;
  percentWaited = Math.floor((currentTime/3000) * 100);
  writePercent(percentWaited);
}, 500);

setTimeout(function() {
  clearInterval(interval);
  writePercent(100);
  console.log("\n\n done \n\n");
}, 3000);

writePercent(percentWaited);
#+END_EXAMPLE

** Modules, Packages, Frameworks
*** Get version
~npm list~ for locally installed packages
~npm list -g~ for globally installed packages

~npm list -g --depth=0~ global installed packages at first level

~npm list express~

~npm view PKG_NAME version~ The latest available version of a package
view aliaes: info, show, v

~npm outdated~ Show if there're updates for locally installed packages
~npm outdated --global~ for globally installed packages

Update npm ~sudo npm install -g npm~

*** Global package and Scoped package
npm install -g @angular/cli
@ indicates angular/cli is a scoped package. 
Without @, package is installed in ~node_modules/packagename~
Scoped package is installed in ~node_modules/@angular/cli~
Thus, scoped package can group packages under one namespace

#+BEGIN_EXAMPLE
// package.json
"dependencies": {
  "@angular/cli": "^1.3.0"
}

// In code
require('@angular/cli')
#+END_EXAMPLE

*** Peer dependencies
A dependency says "I need this thing directly available to me"
A peerDependency says "If you want to use me, you need this ting available to you"

However, as of verison 3, npm does not install packages listed in peerDependencies sections.

But npm issues a warning when
- When any peer dependencies are missing
- or when the application or any of its other dependencies installs a different version of a peer dependency.

It is your job to copy all peer dependency packages to devDependencies to install them.

For example, you app depends on angular and your app doesn't have peerDependencies. However, angular has peerDependencies.

You will make sure to list any angular's peerDependencies into your app's devDepenedencies 

*** v8
#+BEGIN_EXAMPLE
var v8 = require('v8');
console.log('v8.getHeapStatistics()');
#+END_EXAMPLE

*** readline
#+BEGIN_EXAMPLE
var readline = require('readline');
var rl = readline.createInterface(process.stdin, process.stdout);
var aPerson = {
  name: '',
  sayings: []
}

rl.question("What is the name of a real person? ", function(a) {
  aPerson.name = a;
  rl.setPrompt(`What would ${aPerson.name} say? `);
  rl.prompt(); // display prompt
  rl.on('line', function(saying) {
    aPerson.sayings.push(saying.trim());
    if (saying.toLowerCase().trim() === 'exit') {
      rl.close();
    }
    else {
      rl.setPrompt(`What else would ${aPerson.name} say?  ('exit' to leave) `);
      rl.prompt();
    }

  });
});

rl.on('close', function() {
  console.log("5s is a real person that says %j", aPerson.name, aPerson.sayings);
  process.exit();
});
#+END_EXAMPLE

*** events
#+BEGIN_EXAMPLE
var events = require('events');
var emitter = new events.EventEmitter();

emitter.on('customEvent', function(msg, status) {
  console.log(`${status}: ${msg}`);
});

emitter.emit('customEvent', "Hello", 200);
#+END_EXAMPLE

*** util (native)
#+BEGIN_EXAMPLE
var EventEmitter = require('events').EventEmitter;
const util = require('util');
var Person = function(name) {
  this.name = name;
};

util.inherits(Person, EventEmitter);
// Add EventEmitter to Person's prototype
// Person inherits all from EventEmitter

var ben = new Person("Ben");

ben.on('speak', function(said) {
  console.log(`${this.name} said ${said}`);
});

ben.emit('speak', "I'm Ben");

// fully print an object
console.log(util.inspect(myObj, {showHidden: false, depth: null}));
// or this for short
cosole.log(util.inspect(myObj, false, null));
// console.dir actually uses util.inspect. See nodejs:console

util.format('%s:%s', 'foo'); // 'foo:%s'
util.format('%s:%s', 'foo', 'bar', 'baz'); 
// extra arguments are coerced into strings delimited by a space 
// 'foo:bar baz'
// %s > string, %d > integer or floating point value
// %i > integer, %f > floating point value
// %j > JSON
// %% > percent sign '%'
#+END_EXAMPLE

*** lodash
#+BEGIN_EXAMPLE
# npm i -g npm
npm i --save lodash

var _ = require('lodash');

var users = [
  { 'user': 'barney',  'age': 36, 'active': true },
  { 'user': 'fred',    'age': 40, 'active': false },
  { 'user': 'pebbles', 'age': 1,  'active': true }
];
 
_.find(users, function(o) { return o.age < 40; });
// => object for 'barney'
 
// The `_.matches` shorthand.
_.find(users, { 'age': 1, 'active': true });
// => object for 'pebbles'
 
// The `_.matchesProperty` shorthand.
_.find(users, ['active', false]);
// => object for 'fred'
 
// The `_.property` shorthand.
_.find(users, 'active');
// => object for 'barney'

var user = _.findIndex(users, {id: req.params.id});
var update = req.body;
if (update.id) {
  delete update.id;
}

if (!users[user]) {
  res.send('user not found');
}
else {
  var updatedUser = _.assign(users[user], update);
  // merge multiple objects from left to right for enumerable string keyed properties
  res.json(updatedUser);
}
#+END_EXAMPLE

**** _.identity(value)
returns the first argument it receives

var object = { 'a': 1 };
console.log(_.identity(object) === object); // => true

**** _.matches(source)
creates a function that performs a partical deep comparison between a given object and source, return true if the given object has equivalent prop values, else false.
Partial comparisons will match empty array and empty object source values against any array or object value, respectively.

#+BEGIN_EXAMPLE
var objects = [
  { 'a': 1, 'b': 2, 'c': 3 },
  { 'a': 4, 'b': 5, 'c': 6 }
];
 
_.filter(objects, _.matches({ 'a': 4, 'c': 6 }));
// => [{ 'a': 4, 'b': 5, 'c': 6 }]
#+END_EXAMPLE

**** _.find, _.findLast
Return the first element that the predicate function returns true.
#+BEGIN_EXAMPLE
_.find(collection, [predicate=_.identity], [fromIndex=0])
_.findLast(collection, [predicate=_.identity], [fromIndex=collection.length-1])

// Predicate function is passed with (value, index|key, collection)

var users = [
  { 'user': 'barney',  'age': 36, 'active': true },
  { 'user': 'fred',    'age': 40, 'active': false },
  { 'user': 'pebbles', 'age': 1,  'active': true }
];
 
_.find(users, function(o) { return o.age < 40; });
// => object for 'barney'
 
// The `_.matches` iteratee shorthand.
_.find(users, { 'age': 1, 'active': true });
// => object for 'pebbles'
 
// The `_.matchesProperty` iteratee shorthand.
_.find(users, ['active', false]);
// => object for 'fred'
 
// The `_.property` iteratee shorthand.
_.find(users, 'active');
// => object for 'barney'
#+END_EXAMPLE

**** _.iteratee
Creates a function that invokes func with the arguments of the created function.
func is
- a property name :: the created function returns the prop value for a given element.

#+BEGIN_EXAMPLE
_.iteratee([func=_.identity])

var users = [
  { 'user': 'barney', 'age': 36, 'active': true },
  { 'user': 'fred',   'age': 40, 'active': false }
];
 
// The `_.matches` iteratee shorthand.
_.filter(users, _.iteratee({ 'user': 'barney', 'active': true }));
// => [{ 'user': 'barney', 'age': 36, 'active': true }]
 
// The `_.matchesProperty` iteratee shorthand.
_.filter(users, _.iteratee(['user', 'fred']));
// => [{ 'user': 'fred', 'age': 40 }]
 
// The `_.property` iteratee shorthand.
_.map(users, _.iteratee('user'));
// => ['barney', 'fred']
 
// Create custom iteratee shorthands.
_.iteratee = _.wrap(_.iteratee, function(iteratee, func) {
  return !_.isRegExp(func) ? iteratee(func) : function(string) {
    return func.test(string);
  };
});
 
_.filter(['abc', 'def'], /ef/);
// => ['def']
#+END_EXAMPLE

**** _.property(path)
Creates a function that returns the value at path of a given object

#+BEGIN_EXAMPLE
var objects = [
  { 'a': { 'b': 2 } },
  { 'a': { 'b': 1 } }
];
 
_.map(objects, _.property('a.b'));
// => [2, 1]
 
_.map(_.sortBy(objects, _.property(['a', 'b'])), 'a.b');
// => [1, 2]
#+END_EXAMPLE

*** child_process
Exec is for short process
#+BEGIN_EXAMPLE
var exec = require('child_process').exec;
exec('ls', function(err, stdout) {
  if (err) throw err;
  console.log(stdout);
});
#+END_EXAMPLE

Spawn for ongoing process
#+BEGIN_EXAMPLE
var spawn = require('child_process').spawn;
var cp = spawn('node', ["app"]); // node app
cp.stdout.on("data", function(data) {
  // Output child process stdout
  console.log(`STDOUT: ${data.toString()}`);
});

cp.on("close", function() {
  console.log("Child process has ended.");
  process.exit();
});

setTimeout(function() {
  // maximum run time
  cp.stdin.write("stop");
}, 4000);
#+END_EXAMPLE

*** gulp

#+BEGIN_EXAMPLE
# Install gulp globally and locally.

npm install -g gulp
npm install --save-dev gulp
npm install gulp-util --save-dev
npm install gulp-coffee --save-dev
npm install gulp-concat --save-dev
npm install gulp-browserify --save-dev
npm install gulp-compass --save-dev
npm install jquery --save-dev
npm install mustache --save-dev

# gulpfile.js
var gulp=require('gulp'),
    gutil = require('gulp-util'),
    coffee = require('gulp-coffee'),
    browserify = require('gulp-browserify'),
    compase = require('gulp-compass'),
    concat = require('gulp-concat');

# run gulp will run this task
gulp.task('default', function() {
  console.log('hello from gulp');
});

// gulp-util, run `gulp log`
gulp.task('log', function() {
  gutil.log('Workflow starts');
});

var coffeeSources = ['components/coffee/tagline.coffee'];
var jsSources = [
  'components/scripts/1.js',
  'components/scripts/2.js'
];
var sassSources = ['components/sass/style.scss'];

gulp.task('coffee', function() {
  gulp.src(coffeeSources)
      .pipe(coffee({ bare: true })
         .on('error', gutil.log))
      .pipe(gulp.dest('components/scripts'));
});

gulp.task('js', ['coffee'], function() {
  gulp.src(jsSources)
      .pipe(concat('script.js'))
      .pipe(gulp.dest('builds/development/js'));
});

gulp.task('compass', function() {
  gulp.src(sassSources)
      .pipe(compoass({
            sass: 'components/sass',
            image: 'builds/development/images',
            style: 'expanded'
         })
         .on('error', gutil.log)
      )
      .pipe(gulp.dest('builds/development/css'));
});

gulp.task('watch', function() {
  gulp.watch(coffeeSources, ['coffee']);
});

#+END_EXAMPLE

*** grunt
Install grunt globally and locally
#+BEGIN_EXAMPLE
npm install grunt-cli -g
npm install grunt-cli --save-dev

npm install grunt-contrib-jshint --save-dev
npm install grunt-contrib-less --save-dev
npm install grunt-autoprefixer --save-dev
npm install grunt-browserify --save-dev
npm install grunt-contrib-watch --save-dev

npm install jquery

# GruntFile.js
module.exports = function(grunt) {

  grunt.initConfig({
    jshint: {
      files: ["*.js", "lib/*.js", "test/*.js"],
      options: {
        esnext: true,
        globals: {
          jQuery: true
        }
      }
    },
    less: {
      production: {
        files: {
          "public/css/style.css": ["less/*.less"]
        }
      }
    },
    autoprefixer: {
      single_file: {
        src: "public/css/style.css",
        dest: "public/css/style.css"
      }
    },
    browserify: {
      client: {
        src: ["app-client.js"],
        dest: "public/js/bundle.js"
      }
    },
    watch: {
      css: {
        files: ["less/*.less"],
        tasks: ["css"]
      },
      scripts: {
        files: ["app-client.js", "lib/*.js"],
        tasks: ["jshint", "browserify"]
      }
    }
  });

  grunt.loadNpmTasks("grunt-contrib-jshint");
  grunt.loadNpmTasks("grunt-contrib-less");
  grunt.loadNpmTasks("grunt-autoprefixer");
  grunt.loadNpmTasks("grunt-browserify");
  grunt.loadNpmTasks("grunt-contrib-watch");

  grunt.registerTask("css", ["less", "autoprefixer"]);
  grunt.registerTask("js", ["browserify"]);

  grunt.registerTask("default", ["jshint", "css", "js"]);
};

# ./app-client.js
var $ = require("jquery");
var printTerms = require("./lib/printTerms");

// jQuery code


# run grunt
grunt

# open another session and run
grunt watch
#+END_EXAMPLE

*** webpack <<<npm:webpack>>>
https://angular.io/guide/webpack ng:cli:webpack
**** Multiple bundles
#+BEGIN_EXAMPLE
entry: {
  app: 'src/app.ts',
  vendor: 'src/vendor.ts'
},

output: {
  filename: '[name].js'
}
#+END_EXAMPLE

**** Rules
#+BEGIN_EXAMPLE
module: {

 rules: [
   {
     test: /\.ts$/,
     loader: 'awesome-typescript-loader'
   },
   {
     test: /\.css$/,
     loaders: 'style-loader!css-loader'
   }
 ]

}
#+END_EXAMPLE

**** Plugins
#+BEGIN_EXAMPLE
const { UglifyJsPlugin } = require('webpack').optimize;

plugins: [
  new UglifyJsPlugin({
    // config options
  })
]
#+END_EXAMPLE

Webpack, the plugins, and the loaders are also installed as packages. They are listed in the updated packages.json.

**** resolve
Most import statements don't mention the extension. Tell Webpack to resolve extension-less file requests by looking for matching files with .ts extension or .js extension.
#+BEGIN_EXAMPLE
"resolve": {
    "extensions": [
      ".ts",
      ".js"
    ],
    "modules": [
      "./node_modules",
      "./node_modules"
    ],
    "symlinks": true
}
#+END_EXAMPLE

**** webpack.(common|dev|prod).js
webpack.common.js
#+BEGIN_EXAMPLE
var webpack = require('webpack');
var HtmlWebpackPlugin = require('html-webpack-plugin');
var ExtractTextPlugin = require('extract-text-webpack-plugin');
var helpers = require('./helpers');

module.exports = {
  entry: {
    'polyfills': './src/polyfills.ts',
    'vendor': './src/vendor.ts',
    'app': './src/main.ts'
  },

  resolve: {
    extensions: ['.ts', '.js']
  },

  module: {
    rules: [
      {
        test: /\.ts$/,
        loaders: [
          {
            loader: 'awesome-typescript-loader',
            options: { configFileName: helpers.root('src', 'tsconfig.json') }
          } , 'angular2-template-loader'
        ]
      },
      {
        test: /\.html$/,
        loader: 'html-loader'
      },
      {
        test: /\.(png|jpe?g|gif|svg|woff|woff2|ttf|eot|ico)$/,
        loader: 'file-loader?name=assets/[name].[hash].[ext]'
      },
      {
        test: /\.css$/,
        exclude: helpers.root('src', 'app'),
        loader: ExtractTextPlugin.extract({ fallbackLoader: 'style-loader', loader: 'css-loader?sourceMap' })
      },
      {
        test: /\.css$/,
        include: helpers.root('src', 'app'),
        loader: 'raw-loader'
      }
    ]
  },

  plugins: [
    // Workaround for angular/angular#11580
    new webpack.ContextReplacementPlugin(
      // The (\\|\/) piece accounts for path separators in *nix and Windows
      /angular(\\|\/)core(\\|\/)@angular/,
      helpers.root('./src'), // location of your src
      {} // a map of your routes
    ),

    new webpack.optimize.CommonsChunkPlugin({
      name: ['app', 'vendor', 'polyfills']
    }),

    new HtmlWebpackPlugin({
      template: 'src/index.html'
    })
  ]
};
#+END_EXAMPLE

webpack.dev.js extends webpack.common.js
#+BEGIN_EXAMPLE
var webpackMerge = require('webpack-merge');
var ExtractTextPlugin = require('extract-text-webpack-plugin');
var commonConfig = require('./webpack.common.js');
var helpers = require('./helpers');

module.exports = webpackMerge(commonConfig, {
  devtool: 'cheap-module-eval-source-map',

  output: {
    path: helpers.root('dist'),
    publicPath: '/',
    filename: '[name].js',
    chunkFilename: '[id].chunk.js'
  },

  plugins: [
    new ExtractTextPlugin('[name].css')
  ],

  devServer: {
    historyApiFallback: true,
    stats: 'minimal'
  }
});
#+END_EXAMPLE
The HtmlWebpackPlugin, added in webpack.common.js, uses the ~publicPath~ and ~filename~ in ~output~ to generate appropriate <script> and <link> tags into the index.html.

~output~ bundles in the dist folder, the dev server keeps all bundles in memory; it doesn't write them to disk. You won't find any files in the dist folder, at least not any generated from this development build.

Until the environment variable is set to production (webpack.DefinePlugin)
webpack.prod.js
#+BEGIN_EXAMPLE
var webpack = require('webpack');
var webpackMerge = require('webpack-merge');
var ExtractTextPlugin = require('extract-text-webpack-plugin');
var commonConfig = require('./webpack.common.js');
var helpers = require('./helpers');

const ENV = process.env.NODE_ENV = process.env.ENV = 'production';

module.exports = webpackMerge(commonConfig, {
  devtool: 'source-map',

  output: {
    path: helpers.root('dist'),
    publicPath: '/',
    filename: '[name].[hash].js',
    chunkFilename: '[id].[hash].chunk.js'
  },

  plugins: [
    new webpack.NoEmitOnErrorsPlugin(),
    new webpack.optimize.UglifyJsPlugin({ // https://github.com/angular/angular/issues/10618
      mangle: {
        keep_fnames: true
      }
    }),
    new ExtractTextPlugin('[name].[hash].css'),
    new webpack.DefinePlugin({
      'process.env': {
        'ENV': JSON.stringify(ENV)
      }
    }),
    new webpack.LoaderOptionsPlugin({
      htmlLoader: {
        minimize: false // workaround for ng2
      }
    })
  ]
});
#+END_EXAMPLE

Angular CLI set ENV in this way. The EnvironmentPlugin is shorthand for using the DefinePlugin on process.env keys.
#+BEGIN_EXAMPLE
const { EnvironmentPlugin } = require('webpack');
"plugins": [
new EnvironmentPlugin({
    "NODE_ENV": "production"
  }),
]
#+END_EXAMPLE

webpack.prod.js addtional plugins
- NoEmitOnErrorsPlugin :: stops the build if there is an error.
- UglifyJsPlugin :: minifies the bundles.
- ExtractTextPlugin :: extracts embedded css as external files, adding cache-busting hash to the filename.
- DefinePlugin :: use to define environment variables that you can reference within the application.
- LoaderOptionsPlugins :: to override options of certain loaders.

**** Use of webpack.(common|dev|prod).js
src/index.html
#+BEGIN_EXAMPLE
<!DOCTYPE html>
<html>
  <head>
    <base href="/">
    <title>Angular With Webpack</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <my-app>Loading...</my-app>
  </body>
</html>
#+END_EXAMPLE

src/main.ts
#+BEGIN_EXAMPLE
import { platformBrowserDynamic } from '@angular/platform-browser-dynamic';
import { enableProdMode } from '@angular/core';

import { AppModule } from './app/app.module';

if (process.env.ENV === 'production') {
  enableProdMode();
}

platformBrowserDynamic().bootstrapModule(AppModule);
#+END_EXAMPLE

polyfills.ts is a good place to configure browser environment for production or development
#+BEGIN_EXAMPLE
import 'core-js/es6';
import 'core-js/es7/reflect';
require('zone.js/dist/zone');

if (process.env.ENV === 'production') {
  // Production
} else {
  // Development and test
  Error['stackTraceLimit'] = Infinity;
  require('zone.js/dist/long-stack-trace-zone');
}
#+END_EXAMPLE

src/vendor.ts
#+BEGIN_EXAMPLE
// Angular
import '@angular/platform-browser';
import '@angular/platform-browser-dynamic';
import '@angular/core';
import '@angular/common';
import '@angular/http';
import '@angular/router';
 
// RxJS
import 'rxjs';
 
// Other vendors for example jQuery, Lodash or Bootstrap
// You can import js, ts, css, sass, ...
#+END_EXAMPLE

Highlights

- There are no <script> or <link> tags in the index.html. The HtmlWebpackPlugin inserts them dynamically at runtime.

- The AppComponent in app.component.ts imports the application-wide css with a simple import statement.

- The AppComponent itself has its own html template and css file. WebPack loads them with calls to require(). Webpack stashes those component-scoped files in the app.js bundle too. You don't see those calls in the source code; they're added behind the scenes by the angular2-template-loader plug-in.

- The vendor.ts consists of vendor dependency import statements that drive the vendor.js bundle. The application imports these modules too; they'd be duplicated in the app.js bundle if the CommonsChunkPlugin hadn't detected the overlap and removed them from app.js.

*** path <<<nodejs:path>>>
#+BEGIN_EXAMPLE
var path = require('path');
// path is native, get just the file name
console.log(path.basename(__filename));

// No trailing '/'
var dirUploads = path.join(__dirname, 'www', 'files', 'uploads');
#+END_EXAMPLE

*** fs
Default fs is not a Promise although it is async with callback.
Every function has a sync version. Just append Sync at the end.
They cannot be chained. Consider nodejs:bluebird or nodejs:co-fs
#+BEGIN_EXAMPLE
var fs = require('fs');
var data = require('./data1.json');
console.log(data.name); // data is an object
fs.readFile('./data1.json', 'utf-8', function(err, data) {
  // without specifying utf-8, file will be read as binary
  data = JSON.parse(data); // data is string
  console.log(data.name);
  // res.setHeader('Content-Type', 'text/html');
  // res.send(html);
});

// Read directory
fs.readdir('/root', function(err, data) {
  console.log(data); // data is array
  data.forEach(function(fname) {
    var file = path.join(__dirname, "lib", fname);
    var stats = fs.statSync(file);
    if (stats.isFile() && fname !== '.DS_Store') {
      fs.readFile(file, "UTF-8", function(err, data) {
        console.log(data);
      });
    } 
    
  });
});

// Write file
var tomString = '{ "name": "Tom" }';
fs.writeFile('tom.json', tomString, function(err) {});
var timmy = {
  name: 'Timmy'
};

fs.writeFile('timmy.json', JSON.stringify(timmy));

// Append file
fs.appendFile('timmy.json', 'more text \n');

// Rename file
fs.rename('./lib/project-config.js', './lib/config.json');

// Move file
fs.rename('./lib/project-config.js', './config.json');

// Remove file
fs.unlink('./lib/config.json');

// New folder
if (!fs.existsSync("lib")) {
  fs.mkdir("lib", function(err) {});
}

// Rename or move
fs.rename('./assets/logs', './logs');

// Remove folder, folder must be empty
fs.rmdir('./logs');

// Remove all files from a directory
fs.readdirSync('./logs').forEach(function(fileName) {
  fs.unlinkSync('./logs/' + fileName);
});

// File read stream
var stream = fs.createReadStream('./chat.log', 'UTF-8');
var data = "";
stream.once('data', function() {
  console.log('Start reading file');
});
stream.on("data", function(chunk) {
  process.stdout.write(` chunk: ${chunk.length} |`);
  data += chunk;
});
stream.on('end', function() {
  console.log(data.length);
});

// File write stream
var stream = fs.createWriteStream('result.md');
stream.write(`${data}\n`);
stream.close();
#+END_EXAMPLE

*** co-fs, co <<<nodejs:co-fs>>> <<<nodejs:co>>>
Default fs doesn't support Promise or Generator Function
#+BEGIN_EXAMPLE
npm install co-fs
npm install co

var fs = require('co-fs');
co(function* () {
  var data = yield fs.readFile('./data1.json', 'utf-8');
  // fs.readFile is a promise by using co-fs
  console.log(data);
});
#+END_EXAMPLE

Before co@4.0.0, co() returned a thunk, which is a callback, after it returns a promise
Chain
#+BEGIN_EXAMPLE
co(function* () {
  var result = yield Promise.resolve(true);
  return result;
})
.then(function (value) {
  console.log(value);
}, function (err) {
  console.error(err.stack);
});
#+END_EXAMPLE

Convert co-generator function into a regular function which returns a promise
#+BEGIN_EXAMPLE
var fn = co.wrap(function* (val) {
  return yield Promise.resolve(val);
});

fn(true).then(function (val) {
  // do something
});
#+END_EXAMPLE

Yieldables are
- promises
- thunks (functions)
- array (parallel execution)
- objects (parallel execution)
- generators (delegation)
- generator functions (delegation)

Resolve multiple promises in parallel
#+BEGIN_EXAMPLE
co(function* () {
  var a = Promise.resolve(1);
  var b = Promise.resolve(2);
  var res = yield [a,b];
}).catch(onerror);

function onerror(err) {
  console.error(err.stack);
}
#+END_EXAMPLE

*** http, https <<<nodejs:http>>>
It's sync request.
**** request
#+BEGIN_EXAMPLE
var https = require('https');
var fs = require('fs');

var options = {
  hostname: "en.wikipedia.org",
  port: 443,
  path: "/wiki/George_Washington",
  method: "GET"
};

var req = https.request(options, function(res) {
  var responseBody = "";
  console.log(`Server Status: ${res.statusCode}`);
  console.log("Response Headers: %j", res.headers);
  res.setEncoding("UTF-8");
  res.once("data", function(chunk) {
    console.log(chunk);
  });

  res.on("data", function(chunk) {
    console.log(`--chunk-- ${chunk.length}`);
    responseBody += chunk;
  });

  res.on("end", function() {
    fs.writeFile("george-w.html", responseBody, function(err) {
      if (err) throw err;
    });
    console.log("File downloaded");
  });

});

// Set timeout
req.on('socket', function(socket) {
  socket.setTimeout(8000);
  socket.on('timeout', () => {
    req.abort();
    console.log('timeout');
  });
});

req.on("error", function(err) {
  if (err.code === 'ECONNRESET') {
    console.log("Timeout occurs");
  }
  console.log(`problem: ${err.message}`);
});

req.end();
#+END_EXAMPLE

**** server
Simple HTTP server which gives responses

#+BEGIN_EXAMPLE
var http = require('http');
var fs = require('fs');
var path = require('path');
var jsonFile = require('./data/inventory'); //inventory.json
// jsonFile is a json object, not string

var server = http
  .createServer(function (req, res) {
    if (req.url === '/') {
      fs.readFile("./public/index.html", "UTF-8", function (err, html) {
        res.writeHead(200, {"Content-Type": "text/html"});
        // res.write(html); res.end();
        res.end(html);
      });
    }
    else if (req.url.match(/.css$/)) {
      var cssPath = path.join(__dirname, 'public', req.url);
      var fileStream = fs.createReadStream(cssPath, "UTF-8");
      res.writeHead(200, {"Content-Type": "text/css"});
      fileStream.pipe(res);
    }
    else if (req.url.match(/.jpg$/)) {
      var imgPath = path.join(__dirname, 'public', req.url);
      var imgStream = fs.createReadStream(imgPath); // binary
      res.writeHead(200, {"Content-Type": "image/jpeg"});
      imgStream.pipe(res);
    }
    else if (req.url === 'getallorders') {
      res.writeHead(200, {"Content-Type": "text/json"});
      res.end(JSON.stringify(jsonFile));
    }
    else if (req.url === 'instock') {
      listInStock(res);
    }
    else if (req.url === 'form') {

      if (res.method === "GET") {
        res.writeHead(200, {"Content-Type": "text/html"});
        fs.createReadStream("./public/form.html", "UTF-8").pipe(res);
      }
      else if (req.method === "POST") {
        var body = "";
        // body will be a url encoded string with key-value pairs
        req.on("data", function(chunk) {
          body += chunk;
        });

        req.on("end", function() {
          res.writeHead(200, {"Content-Type": "text/html"});
          res.end(`${body}`);
        });
      }

    }
    else {
      res.writeHead(200, {"Content-Type": "text/plain"});
      res.end("404 File Not Found");
    }
  })
  .listen(3000);

function listInStock(res) {
  var inStock = jsonFile.filter(function(item) {
    return item.avail === "In Stock";
  });
  res.end(JSON.stringify(inStock));
}
#+END_EXAMPLE

*** cors
You don't need to config Nginx!
#+BEGIN_EXAMPLE
npm install cors

var express = require('express');
var cors = require('cors');
var app = express();

// Enable CORS for all routes/requests
app.use(cors());
 
app.get('/products/:id', function (req, res, next) {
  res.json({msg: 'This is CORS-enabled for all origins!'});
});

# Enable for one route
# Don't put cors() in app.route()
app.get('/products/:id', cors(corOptions), function (req, res, next) {
  res.json({msg: 'This is CORS-enabled for all origins!'})
})

# Options
var corsOptions = {
  origin: 'http://example.com',
  optionsSuccessStatus: 200
}

# Multiple domains
var whitelist = ['http://example1.com', 'http://example2.com']
var corsOptions = {
  origin: function (origin, callback) {
    if (whitelist.indexOf(origin) !== -1) {
      callback(null, true)
    } else {
      callback(new Error('Not allowed by CORS'))
    }
  }
}

// use the same cors(corsOptions)
#+END_EXAMPLE

*** xml2js
https://github.com/Leonidas-from-XIV/node-xml2js
#+BEGIN_EXAMPLE
npm install --save xml2js

var parseString = require('xml2js').parseString;
var xml = "<root>Hello xml2js!</root>"
parseString(xml, function (err, result) {
    console.dir(result);
});
#+END_EXAMPLE

*** crypto
**** HMAC
SSL certificate changes from SHA1 to SHA256 which is SHA2 algorithm.

One ASCII character is 8 bits.
One UTF-8 character is between 8 bits to 32 bits.

One character is 2 hex characters (UTF-8, etc.)

Output size of SHA256 is 256 bits, which is 256/8*2 = 64 hex characters
Output size of SHA1 is 160, which is 40 hex characters

The secret/key of SHA256 should at least contain 256 bits. But I use 128 bits.. Which is 32 hex characters.

#+BEGIN_EXAMPLE
var crypto = require('crypto')
 , text = 'hello'
 , key = 'abcdeg' // better to have 32 hex characters, but length could be any
 , hash

let hmac = crypto.createHmac('sha256', key);
hmac.write(text);
hmac.end();
let hash = hmac.read().toString('hex');
#+END_EXAMPLE

**** encrypt, decrypt
<<<nodejs:decrypt>>>
Refer to php:openssl_decrypt

All AES, regardless 128/256 or key length, the output size depends on the input size
(floor(Input size / 16 bytes) + 1) * 16 bytes

#+BEGIN_EXAMPLE
const crypto = require('crypto');

const KEYAES = '64 hex characters'
const ALGORITHM = 'aes-256-cbc';

// store this keyAES256.toString('hex')
// convert hex to bytes
// keyAES256 = new buffer(keyAES256, 'hex');

function encrypt(plain_text) {
  var iv = crypto.randomBytes(16); // 16 text characters, 16 bytes or 32 hex characters
  // iv should be different every time

  var keyAES = new Buffer(KEYAES, 'hex');
  // var keyAES = crypto.randomBytes(32); // 32 text characters, 32 bytes or 64 hex characters
  // global KEYAES is keyAES.toString('hex')

  var cipher = crypto.createCipheriv(ALGORITHM, keyAES, iv);
  cipher.write('text to encrypt');
  cipher.end();
  
  var cipher_text = cipher.read().toString('hex');
  
  return cipher_text + '$' + iv.toString('hex');
}

function decrypt(cipher_text) {
  var cipher_blob = cipher_text.split("$");
  var ct = cipher_blob[0];
  var iv = new Buffer(cipher_blob[1], 'hex'); // get iv
  var keyAES = new Buffer(KEYAES, 'hex');

  decryptor = crypto.createDecipheriv(ALGORITHM, keyAES, iv);
  decryptor.write(ct, 'hex');
  decryptor.end();
  console.log(decryptor.read().toString('utf-8'));
}
#+END_EXAMPLE

*** body-parser
parse POST data. Refer to nodejs:express
~npm install body-parser~

var express = require('express');

*** httpster
#+BEGIN_EXAMPLE
npm install httpster -g
httpster -p 3000 -d ./public/

# Or httpster is installed locally
./node_modules/httpster/bin/httpster -p 3000 -d ./public/
#+END_EXAMPLE

*** express <<<nodejs:express>>>
**** Sample
#+BEGIN_EXAMPLE
// my-express.js
var express = require('express');
var app = express();
var bodyParser =  require('body-parser');

app.set('port', process.env.PORT || 3000);

var skierTerms = [{},{}]; // javascript array/object. global to the project/app. Only reset when app is restarted.
app.set('appData', skierTerms);

// app.use() adds middlewares which run first

app.use(bodyParser.json()); // any data sent to this app (API) as .json, the data will be parsed
app.use(bodyParser.urlencoded({ extended: true })); // also parse url encoded data
// false uses the `querystring` library which means the data could be string or array
// true uses the `qs` library which means the data could be any type

// log every request
app.use(function(req, res, next) {
  console.log(`${req.method} request for '${req.url}' - ${JSON.stringify(req.body)}`);
  next(); // eventually, res.send('output');, so here is next
});

// default is index.html, server static files
app.use(express.static(__dirname));

app.use('/message', function(req, res) {
  console.log('user requested endpoint');
  res.send('response is hello');
});

app.use(require('./routes/index'));
app.use(require('./routes/dict-api'));

app.listen(app.get('port'), function() {
  // optional callback
});

// visit localhost:3000/message
// node my-express.js
// PORT=4000 node my-express.js
#+END_EXAMPLE

#+BEGIN_EXAMPLE
// ./routes/dict-api.js
var express = require('express');
var router = express.Router();

router.use(bodyParser.json()); // any data sent to this app (API) as .json, the data will be parsed
router.use(bodyParser.urlencoded({ extended: false })); // also parse url encoded data

// same domain
router.get('/dict-api', function(req, res) {
  var skierTerms = req.app.get('appData');
  res.json(skierTerms); // send json variable, no need to stringify
});

router.post('/dict-api', function(req, res) {
  var skierTerms = req.app.get('appData');
  skierTerms.push(req.body);
  req.app.set('appData', skierTerms);
  res.json(skierTerms); // send json variable, no need to stringify
});

router.delete('dict-api/:term', function(req, res) {
  var skierTerms = req.app.get('appData');
  skierTerms = skierTerms.filter(function(def) {
    return def.term.toLowerCase() !== req.params.term.toLowerCase();
  });
  req.app.set('appData', skierTerms);
  res.json(skierTerms);
});

module.exports = router;
#+END_EXAMPLE

**** Routing
***** Callbacks
Instead of ~next()~ which skips to the next callback, ~next('route')~ can bypass all the remaining route callbacks of the current app.METHOD() or router.METHOD().
~next('router')~ to skip the rest of the router's middleware functions the router instance

#+BEGIN_EXAMPLE
app.get('/example/a', function (req, res) {
  res.send('Hello from A!')
})

app.get('/example/b', function (req, res, next) {
  console.log('the response will be sent by the next function ...')
  next()
}, function (req, res) {
  res.send('Hello from B!')
})

var cb0 = function (req, res, next) {
  console.log('CB0')
  next()
}

var cb1 = function (req, res, next) {
  console.log('CB1')
  next()
}

var cb2 = function (req, res) {
  res.send('Hello from C!')
}

app.get('/example/c', [cb0, cb1, cb2])

var cb0 = function (req, res, next) {
  console.log('CB0')
  next()
}

var cb1 = function (req, res, next) {
  console.log('CB1')
  next()
}

app.get('/example/d', [cb0, cb1], function (req, res, next) {
  console.log('the response will be sent by the next function ...')
  next()
}, function (req, res) {
  res.send('Hello from D!')
})
#+END_EXAMPLE

***** Response methods
****** res.send res.sendFile
#+BEGIN_EXAMPLE
// Content-Type is automatically sent when res.send is used
res.send(new Buffer('whoop'));
res.send({ some: 'json' }); // Array or Object, Express responds with JSON
res.send('<p>some html</p>'); // Content-Type text/html
res.status(404).send('Sorry, we cannot find that!');
res.status(500).send({ error: 'something blew up' });
#+END_EXAMPLE

****** res.write res.end
Quickly ends the response without any data.
#+BEGIN_EXAMPLE
// send multiple responses using res.write
res.write('1');
res.write('2');
res.setHeader('Content-Type', 'text/html');
res.end();
// res.status(404).end();
#+END_EXAMPLE

***** Parameters
#+BEGIN_EXAMPLE
Route path: /users/:userId/books/:bookId
Request URL: http://localhost:3000/users/34/books/8989
req.params: { "userId": "34", "bookId": "8989" }

app.get('/users/:userId/books/:bookId', function (req, res) {
  res.send(req.params)
})

Route path: /user/:userId(\d+)
Request URL: http://localhost:3000/user/42
req.params: {"userId": "42"}

Request URL: /mv?id=abc
req.query: {id: "abc"}
#+END_EXAMPLE

The name of route parameters must be made up of “word characters” ([A-Za-z0-9_]).

~-~ and ~.~ are literal characters - and .

For using ~*~ as regex, use ~{0,}~ for Express 4.x, use ~*~ for Express 5.

**** Error-handling middleware
Error-handling middleware are defined last.
A built-in error handler is added at the end.
If ~next(err)~ is called and there're no custom error handler, it'll be handled by the built-in error handler.
In non-production environment (NODE_ENV=production), stack trace is printed.

For a custom error handler, if the headers have already been sent to the client, you'll need to call next(err) to let
the built-in error handler to close the connection and fail the request.

~next(err)~ can be only called once otherwise there is an error

#+BEGIN_EXAMPLE
function errorHandler(err, req, res, next) {
  if (res.headersSent) {
    return next(err)
  }
  res.status(500)
  res.render('error', {error: err})
}
#+END_EXAMPLE

Simple sample:
#+BEGIN_EXAMPLE
// 4 arguments
app.use(function (err, req, res, next) {
  console.error(err.stack);
  res.status(500).send('Error!');
})
#+END_EXAMPLE

Multiple error handlers
#+BEGIN_EXAMPLE
# /index.js
app.use(logErrors)
app.use(clientErrorHandler)
app.use(errorHandler)

function logErrors (err, req, res, next) {
  console.error(err.stack)
  next(err)
}

function clientErrorHandler (err, req, res, next) {
  if (req.xhr) {
    res.status(500).send({ error: 'Something failed!' })
  } else {
    next(err)
  }
}

function errorHandler (err, req, res, next) {
  res.status(500)
  res.render('error', { error: err })
}
#+END_EXAMPLE

**** Built-in middleware
***** express.static for serving static assets
#+BEGIN_EXAMPLE
# syntax: express.static(root, [options])
# serve static files in /public directory
app.use(express.staic('public'));
#+END_EXAMPLE

**** View Engine (ejs)
#+BEGIN_EXAMPLE
npm install ejs --save

# app.js
app.set('view engine', 'ejs');
app.set('view', './views'); // default

app.locals.siteTitle = 'Website Name'; // available to all views
// persist through the life of the app

# ./routes/index.js
router.get('/', function(req,res) {
  var data = req.app.get('appData');
  var pagePhotos = [];

  data.speakers.forEach(function() {
    pagePhotos = pagePhotos.concat(item.artwork);
  });

  res.render('index', {
    pageTitle: 'Home',
    artwork: pagePhotos,
    pageID: 'home'
  });
});

# ./views/index.ejs
<!-- HTML Code -->
<%= siteTitle %>
<%= pageTitle %>

<body id="<%= pageID %>">

# if the variable is HTML, output as HTML
<%- varHTML %>

<% if (typeof pageTitle !== "undefined") { %>
  <script src="abc.js"></script>
<% } %>

<% if (artwork.length > 0) { %>
  <% for (i=0; i< artwork.length; i++) { %>
  <img src="/images/artwork/<%= artwork[i] %>" alt="Artwork <%= i %>">
  <% } %>
<% } %>

<% include partials/template/header.ejs %>
# partial can use the parent view variables
#+END_EXAMPLE

*** sails
#+BEGIN_EXAMPLE
npm install sails -g
mkdir sails
cd sails
# Create a sails project with backend only
sails new --no-front-end
# create an api
sails generate api user
# 2 files are created
# ./sails/api/controllers/UserController.js
# ./sails/api/models/User.js
#+END_EXAMPLE

Modify models/User.js, what attributes a user can have and the datatype?
#+BEGIN_EXAMPLE
module.exports = {
  attributes: {
    name: 'string'
  }
}
#+END_EXAMPLE

Start sails, default port is 1337 :: ~sails lift~

Perform CRUD by visiting url
#+BEGIN_EXAMPLE
localhost:1337/user/create?name=John
localhost:1336/user
#+END_EXAMPLE

*** koa
ES6
#+BEGIN_EXAMPLE
npm install koa
# koa-endpoint-demo.js
var koa = require('koa');
var app = new koa();
app.use(function* () {
  this.body = 'hello in the body tag';
});

app.listen(3000);
#+END_EXAMPLE

Run it in harmony
#+BEGIN_EXAMPLE
node --harmony koa-endpoint-demo.js
#+END_EXAMPLE

*** Promise
**** Basics
Promise is native, refer to nodejs:bluebird
#+BEGIN_EXAMPLE
var promise = new Promise(function(res, rej) {
  resolve();
  // or
  // reject();
});

promise.then(function() {
  console.log('then');
})
.catch(function() {
  console.error('failed');
});
#+END_EXAMPLE

**** http server example
#+BEGIN_EXAMPLE
const parseString = require('xml2js').parseString;

route.get('/auth/:site/:emailkey', function(req, res) {
  try {
    getUserInfo(req.params.site, req.params.emailkey, res);
  }
  catch (e) {
    res.json(e.message);
  } 
});

function getUserInfo(site, emailkey, res) {
  httpsRequest(httpsOptions)
    .then(function(body) {
      parseString(body, (err, result) => {
        res.json(result);
      });
    });
}

function httpsRequest(params) {
  return new Promise(function(resolve, reject) {
    let req = https.request(params, function(res) {
      let body = '';

      res.on('data', (chunk) => {
        body += chunk;
      });

      res.on('end', () => {
        promisesParser(body)
          .then((result) => {
            resolve(body);
          })
          .catch((err) => {
            reject(err);
          });
      });

    }); // https.request
    
    req.end();

  }); // Promise
}

function promiseParser(string) {
   return new Promise(function(resolve, reject) {
     parseString(string, function(err, result) {
       if (err) {
         reject(err);
       }
       else {
         resolve(result);
       }
     });
   });
}
#+END_EXAMPLE

*** bluebird <<<nodejs:bluebird>>>
#+BEGIN_EXAMPLE
npm install bluebird

var fs = require('fs');
var Promise = require('bluebird');
Promise.promisifyAll(fs);
// append Async after every fs object (e.g. methods)
fs.readFileAsync('./data1.json')
  .then(JSON.parse)
  .then(function (val) {
    console.log(val);
  })
  .catch(SyntaxError, function(e) {
    console.error("invalid json in file");
  })
  .catch(function(e) {
    console.error("unable to read file");
  });
#+END_EXAMPLE

*** node-dev, nodemon, reload
node-dev restart automatically when there's a change
#+BEGIN_EXAMPLE
npm install node-dev -g
npm install nodemon -g
node-dev app.js
# vs node app.js

# nodemon can watch on a list of file types or ignore a file/folder
nodemon -e js,jade app --watch /another/folder/to/watch --ignore feedback.json --ignore aFolder/
#+END_EXAMPLE

In Vagrant, use ~nodemon -L index.js~ for ~--legacy-watch~ restarting server

Create a WebSocket on the client and reload the browser when Express server is reloaded
#+BEGIN_EXAMPLE
npm install -g reload
npm install reload --save

var reload = require('reload');

# app.js
# after app.listen();
reload(server, app);

# In each route, add reload client js file.
router.get('/', function(req, rs) {
  res.write('<script src="/reload/reload.js"></script>');
});
#+END_EXAMPLE

*** jshint
Check javascript syntax
#+BEGIN_EXAMPLE
npm install jshint -g
jshint app.js

# In app.js, insert a comment at top to give extra instructions
# Use ES6 standard
/* jshint esnext: true */
#+END_EXAMPLE

*** ws
Refer to js:ws for client
#+BEGIN_EXAMPLE
npm install ws --save

var WebSocketServer = require('ws');
var wss = new WebSocketServer({port:3000});
wss.on('connection', function(ws) {
  wss.on('message', function(msg) {
    if (message === 'exit') {
      ws.close();
    }
    else {
      // broadcast
      wss.clients.forEach(function(client) {
        client.send(msg);
      });
    }
  });
  ws.send('Welcome to cyber chat');
});
#+END_EXAMPLE

*** socket.io
#+BEGIN_EXAMPLE
npm install socket.io --save

var express = require('express');
var http = require('http'); // socket.io requires http
var app = express();
var server = http.createServer(app).listen(3000);
var io = require('socket.io')(server); // change http server to a socket server
// Or io can be attached later: require('socket.io')();

app.use(express.static('./public'));

// socket is attached later
// io.attach(server);

io.on('connection', function(socket) {
  socket.on('chat', function(msg) {
    socket.broadcast.emit('message', message);
  });
  socket.emit('message', 'Welcome to cyber chat');
});

# socket.io-client.min.js
# main.js
var socket = io("http://localhost:3000");
socket.on('disconnect', function() {
  // do something
});
socket.on('connect', function() {
  // do something
});
socket.on('message', function(msg) {
  console.log(msg);
});

socket.emit('chat', input.value);
#+END_EXAMPLE

*** mocha, chai, nock, rewire, sinon
#+BEGIN_EXAMPLE
npm install mocha -g
npm install chai --save-dev
# nock is an http mocking and expectations library
npm install nock --save-dev
# rewire adds special setter and getter to modules to modify their values
# https://www.npmjs.com/package/rewire
npm install rewire --save-dev
npm install sinon --save-dev

# ./test/tools-spec.js
var expect = require('chai').expect;
var tools = require('../lib/tools'); // tools.js
var nock = require('nock');

// Test function printName()
describe('printName()', function() {
  // Test 1
  it("should print the last name first", function() {
    var results = tools.printName({ first: "Li", last: "Banks" });
    expect(results).to.equal("Banks, Alex");
  });
});

// Test async function loadWiki()
describe('loadWiki()', function() {
  this.timeout(5000); // default timeout is 2 seconds
  // Test 1
  it("Load Abraham Lincon's wiki page", function(done) {
    tools.loadWiki({ first: 'Abraham', last: 'Lincooln'}, function(html) {
      expect(html).to.be.ok;
      done(); // if done() is not run, test will fail
    });
  });
});
var expect = require('chai').expect;
var tools = require('../lib/tools'); // tools.js
var nock = require('nock');
var rewire = require('rewire');

var order = rewire('../lib/order');
// instead of require(), use rewire() which can change data later

// Test function printName()
describe('printName()', function() {
  // Test 1
  it("should print the last name first", function() {
    var results = tools.printName({ first: "Li", last: "Banks" });
    expect(results).to.equal("Banks, Alex");
  });
});

// Test async function loadWiki()
describe('loadWiki()', function() {
  //this.timeout(5000); // default timeout is 2 seconds

  before(function() {
    // before runs before all tests in this block
    // mock server, save testing time
    nock('https://en.wikipedia.org')
      .get('/wiki/Abraham_Lincoln')
      .reply(200, `--html-code--`);
  });

  // Test 1
  it("Load Abraham Lincon's wiki page", function(done) {
    tools.loadWiki({ first: 'Abraham', last: 'Lincooln'}, function(html) {
      //expect(html).to.be.ok;
      expect(html).to.equal('--html-code--');
      done(); // if done() is not run, test will fail
    });
  });
});

describe('Ordering Items', function() {
  beforeEach(function() {
    // beforeEach runs before each test in this block
    this.testData = [
      {sku: "AAA", qty: 10},
      {sku: "BBB", qty: 10}
    ];
    // modify data for testing purpose
    order.__set__("inventoryData", this.testData);
  });

  it('order an item when there are enough in stock', function(done) {
    order.orderItem('BBB', 3, function() {
      // orderItem subtracts 3 from inventory
      done();
    });
  });

});
var expect = require('chai').expect;
var tools = require('../lib/tools'); // tools.js
var nock = require('nock');
var rewire = require('rewire');
var sinon = require('sinon');

var order = rewire('../lib/order');
// instead of require(), use rewire() which can change data later

// Test function printName()
describe('printName()', function() {
  // Test 1
  it("should print the last name first", function() {
    var results = tools.printName({ first: "Li", last: "Banks" });
    expect(results).to.equal("Banks, Alex");
  });
});

// Test async function loadWiki()
describe('loadWiki()', function() {
  //this.timeout(5000); // default timeout is 2 seconds

  before(function() {
    // before runs before all tests in this block
    // mock server, save testing time
    nock('https://en.wikipedia.org')
      .get('/wiki/Abraham_Lincoln')
      .reply(200, `--html-code--`);
  });

  // Test 1
  it("Load Abraham Lincon's wiki page", function(done) {
    tools.loadWiki({ first: 'Abraham', last: 'Lincooln'}, function(html) {
      //expect(html).to.be.ok;
      expect(html).to.equal('--html-code--');
      done(); // if done() is not run, test will fail
    });
  });
});

describe('Ordering Items', function() {
  beforeEach(function() {
    // beforeEach runs before each test in this block
    this.testData = [
      {sku: "AAA", qty: 10},
      {sku: "BBB", qty: 10}
    ];
    // modify data for testing purpose
    order.__set__("inventoryData", this.testData);

    this.console = {
      // overwrite a function with a fake function
      log: sinon.spy()
    };

    order.__set__('console', this.console);

    this.warehouse = {
      packageAndShip: sinon.stub().yields(1098765)
    };

    order.__set__('warehouse', this.warehouse);

  });

  it('order an item when there are enough in stock', function(done) {
    var _this = this;

    order.orderItem('BBB', 3, function(done) {
      // orderItem subtracts 3 from inventory

      expect(_this.console.log.callCount).to.equal(2);

      done();
    });
  });

  describe('Warehouse interaction', function() {
    beforeEach(function() {
      this.callback = sinon.spy();
      order.orderItem("BBB", 2, callback);
    });

    it('receives a tracking number', function() {
      expect(this.callback.calledWith(1098765)).to.equal(true);
    });

    it('calls packageAndShip with the correct sku and quantity', function() {
      expect(this.warehouse.packageAndShip.calledWith("BBB",2)).to.equal(true);
    });

  });

});

# ./lib/tools.js
var https = require('https');
module.exports = {
  printName(person) {
    return `${person.last}, ${person.first}`;
  },
  loadWiki(person, callback) {
    var url = `https://en.wikipedia.org/wiki/${person.first}_${person.last}`;
    https.get(url, function(res) {
      var body = "";
      res.setEncoding('UTF-8');
      res.on("data", function(chunk) {
        body += chunk;
      });
      res.on("end", function() {
        callback(body);
      });
    });
  }
};

# ./lib/order.js
var inventoryData = require('../data/inventory');
var warehouse = require('./warehouse');

function findItem(sku) {
  var i = inventoryData.map(item => item.sku).indexOf(sku);
  if (i === -1) {
    console.log(`Item - ${sku} not found`);
    return null;
  } else {
    return inventoryData[i];
  }
}

function isInStock(sku, qty) {
  var item = findItem(sku);
  return item && item.qty >= qty;
}

function order(sku, quantity, complete) {
  complete = complete || function () {};
  if (isInStock(sku, quantity)) {
    console.log(`ordering ${quantity} of item # ${sku}`);
    warehouse.packageAndShip(sku, quantity, function (tracking) {
      console.log(`order shipped, tracking - ${tracking}`);
      complete(tracking);
    });
    return true;
  } else {
    console.log(`there are not ${quantity} of item '${sku}' in stock`);
    return false;
  }
}

module.exports.orderItem = order;

# run mocha
mocha
#+END_EXAMPLE

mocha command not found, add this to package.json
#+BEGIN_EXAMPLE
"scripts": {
  "test": "mocha -R spec"
}
#+END_EXAMPLE

~-R spec~ is used to console.log inside tests it()

*** supertest, cheerio
#+BEGIN_EXAMPLE
npm install supertest --save-dev
npm install cheerio --save-dev

# ./app.js is an express app

# ./test/app-spec.js
var request = require("supertest");
var expect = require('chai').expect;
var cheerio = require("cheerio");
var rewire = require('rewire');
var app = rewire('../app');

describe("Dictionary App", function () {

    it("Loads the home page", function(done) {
        request(app).get("/").expect(200).end(function(err, res) {
          var $ = cheerio.load(res.text); // jQuery DOM!
          var pageHeading = $("body>h1:first-child").text();
          expect(pageHeading).to.equal("Skier Dictionary");
          done();
        });
    });

    describe("Dictionary API", function () {

        beforeEach(function () {

        	this.defs = [
                {
                    term: "One",
                    defined: "Term One Defined"
                },
                {
                    term: "Two",
                    defined: "Term Two Defined"
                }
            ];

            app.__set__("skierTerms", this.defs);
        });

        it("GETS dictionary-api", function(done) {
            var defs = this.defs;
            request(app).get("/dictionary-api").expect(200).end(function(err, res) {
                var terms = JSON.parse(res.text);
                expect(terms).to.deep.equal(defs);
                done();
            });
        });

        it("POSTS dictionary-api", function(done) {
            request(app)
               .post("/dictionary-api")
               .send({ "term": "Three", "defined": "Term Three Defined"})
               .expect(200)
               .end(done);
        });

        it("DELETES dictionary-api", function(done) {
            request(app)
               .delete("/dictionary-api/One")
               .expect(200)
               .end(done);
        });

    });

});
#+END_EXAMPLE

*** istanbul
Code coverage report (testing).
#+BEGIN_EXAMPLE
npm install istanbul -g

# at ./
istanbul cover _mocha

# ./coverage/lconv-report/index.html
#+END_EXAMPLE

*** svgo <<<nodejs:svgo>>>
https://github.com/svg/svgo
#+BEGIN_EXAMPLE
# i found windows has permission issue if it's installed globally
npm install svgo
# optimize the svg
./node_modules/svgo abc.svg
# output the svg to data uri URL encoded
# enc, unenc, base64
svgo abc.svg --datauri enc

# output result STDOUT. if not, the file will be overwritten

svgo abc.svg --datauri enc -o -
#+END_EXAMPLE

<<<nodejs:svgo:move styles>>>

Usually it's good in IE11 but if it still doesn't work, refer to svg:ie11

AI already makes .svg and you want to move styles to inline
svgo abc.svg --enable inlineStyles

# Move style attribute from each node to attributes
svgo abc.svg --enable convertStyleToAttrs

** Custom Module
#+BEGIN_EXAMPLE
# my-module.js
# Export one property at a time
exports.myText = 'hello';

# Variables local to the module will be private

# my-square.js, square module
# Root of this module is a function
# Or you want to export a complete object in one assignment instead of building it one property at a time
# Assign it to `module.exports` instead of `exports`
module.exports = (width) => {
  return {
   area: () => width ** 2
  }
}

# module-demo.js
var myModule= require('./my-module.js');
const square = require('./my-square.js');
const mySquare = square(2);
console.log(myModule.myText);
console.log(`The area of my square is ${mySquare.area()}`);

# node module-demo.js

# Initiate the custom module, adding package.json file
npm init

# --save flag will add/remove dependency to package.js
npm install cors --save
npm remove cors --save

# delete ./node_modules and run this to install all dependencies
npm install
#+END_EXAMPLE

Call local functions
#+BEGIN_EXAMPLE
var _foo = function () {
  return ('foo');
}
var _bar = function () {
  return _foo();
}
module.exports = {
  foo: _foo,
  bar: _bar
};
#+END_EXAMPLE

*** package.json, node-inspector
npm install node-inspector -g

npm install
npm start (or test, publish, install)
npm run dev (custom process)
npm run debug

#+BEGIN_EXAMPLE
{
  "name": "ski-dictionary",
  "version": "1.0.0",
  "description": "A collection of skier terms and definitions",
  "main": "app.js",
  "scripts": {
    "predebug": "grunt",
    "debug": "open http://localhost:3000 & open http://localhost:8080/debug?port=5858",
    "prestart": "grunt",
    "start": "node app",
    "predev": "grunt",
    "dev": "open http://localhost:3000 & node-dev app & grunt watch"
  },
  "keywords": [
    "ski",
    "terms",
    "dictionary"
  ],
  "author": "Alex Banks",
  "license": "MIT",
  "dependencies": {
    "body-parser": "^1.14.1",
    "cors": "^2.7.1",
    "express": "^4.13.3",
    "jquery": "^2.1.4"
  },
  "devDependencies": {
    "grunt": "^0.4.5",
    "grunt-autoprefixer": "^3.0.3",
    "grunt-browserify": "^4.0.1",
    "grunt-contrib-jshint": "^0.11.3",
    "grunt-contrib-less": "^1.0.1",
    "grunt-contrib-watch": "^0.6.1"
  }
}
#+END_EXAMPLE

~npm install --production~ or when NODE_ENV environment variable is production, npm will not install modules listed in devDependencies

** npm dependency ~ vs ^
^1.2.3 will match any 1.x.x latest release but will miss 2.0.0
~1.2.3 will match any 1.2.x versions but will miss 1.3.0
^, caret, is the default now

* Angular
** 1.x AngularJS
*** Structure
https://ajax.googleapis.com/ajax/libs/angularjs/1.4.7/angular.js
jquery
common/common.module.js
// angular.module('ajsNgComponents', []);
common/config.js ng:config
common/filters.js ng:filter
common/fitlerableCategories.js ng:factory

*** Calling Order
app.config()
app.run() 
directive's compile functions (if exist)
app.controller()
directive's link functions

*** Config <<<ng:config>>>

<<<ng:html5mode>>>
#+BEGIN_EXAMPLE
angular
  .module('ajsNgComponents')
  .config(locatgionProviderConfig)
  // .config is to run a Provider function
  // ng:provider
  .value('layout','boxed_fullwidth')
  .value('layoutClass', {
    boxed_fullwidth: 'col-lg-3 col-md-4 col-sm-6 col-xs-12',
    boxed_left: 'col-lg-4 col-md-6 col-sm-6 col-xs-12',
    boxed_right: 'col-lg-4 col-md-6 col-sm-6 col-xs-12'
  });

// Enable html5mode
locatgionProviderConfig.$inject = ['$locationProvider'];
function locatgionProviderConfig($locationProvider) {
  $locationProvider.html5Mode({
    enabled: true,
    requireBase: false
  });
}
#+END_EXAMPLE

*** Run
Run injection is a bit different
#+BEGIN_EXAMPLE
app.run(ajsRun);
// Not app.run('ajsRun', ajsRun);

ajsRun.$inject = ['$rootScope'];
function ajsRun($rootScope) {

}

#+END_EXAMPLE

*** Filter <<<ng:filter>>>
#+BEGIN_EXAMPLE
angular
  .module('ajsNgComponents')
  .filter('singleListingFilter', singleListingFilter)
  .filter('item_category_value', item_category_value)
  .filter('ignore_empty_value', ignore_empty_value)
  .filter('translate', translate);

// $scope can't be injected to filter
// Instead, pass scope.varname as a param into filter.
// Or inject $rootScope

// In view
/*
<tr ng-repeat="detail in details | ignore_empty_value:aListing"
 ng-init="detail = aListing.post_meta.options[detailKey]">
  <td ng-bind="(detail.name | translate:detail)"></td>
  <td ng-bind="(detail.value | translate)"></td>
</tr>
*/

function singleListingFilter() {
  return function(items,var1) {
    var r = [];
    for (var i= 0, len=items.length; i< len; i++) {
      if (items[i].id == var1){
        r.push(items[i]);
        break;
      }
    }
    return r;
  };
}

// <td ng-bind="((x.options | item_category_value:detail:lwp_options) | translate)"></td>
function item_category_value() {
  return function(options, category, lwp_options) {
    var value = "";
    return value;
  };
}

function ignore_empty_value() {
  return function(items, aListing) {
    var r = [];
    angular.forEach(items, function(item) {
      if (aListing.post_meta.options[item].value) {
        r.push(item);
      }
    });
    return r;
  };
}

translate.$inject = ['$rootScope'];
function translate($rootScope) {
  return function(word, languages) {
    var r = word;
    if (typeof $rootScope.lang !== "undefined") {
      if ( typeof languages !== "undefined"
        && typeof languages['lang'] !== "undefined"
        && typeof languages['lang'][$rootScope.lang] !== "undefined") {
        r = languages['lang'][$rootScope.lang];
      }
      else {
        r = $rootScope.translate_text(word);
      }
    }
    return r;
  };
}
#+END_EXAMPLE

*** Factory <<<ng:factory>>>
Factory is better than app.value();
#+BEGIN_EXAMPLE
(function() {
  'use strict';
  angular
    .module('ajsNgComponents')
    .factory('filterableCategories', filterableCategories)
    .factory('clientId', clientIdFactory)
    .factory('apiToken', apiTokenFactory);

  // Inject $rootScope so that any method defined here can use
  filterableCategories.$inject = ['$rootScope'];
  function filterableCategories($rootScope) {
    return {
      getFilters: getFilters,
      getListingsFilterObjByURL: getListingsFilterObjByURL,
      getSelectedFiltersObjByURL: getSelectedFiltersObjByURL,
      getSearchInventoryDropdown: getSearchInventoryDropdown
    };

    function getFilters(filterable_categories, lwp_options) {
      // $rootScope can be used here
      var r = [];
      return r;
    }
  }
  
  function clientIdFactory() {
    return '123';
  }

  apiTokenFactory.$inject = ['clientId'];
  function apiTokenFactory(clientId) {
    var encrypt = function(data1, data2) {
      return data1+data2;
    }
    var secret = window.localStorage.getItem('secret');
    var apiToken = encrypt(clientId, secret);
    return apiToken;
  }

})();
#+END_EXAMPLE

*** Service <<<ng:service>>>
#+BEGIN_EXAMPLE
app.service('unicornLauncher', UnicornLauncherService);
UnicornLauncherService.$inject = ['apiToken'];
function UnicornLauncherService(apiToken) {
  this.launchedCount = 0;
  this.launch = function () {
    // Use apiToken to do something
    this.launchedCount++;
  }
}
#+END_EXAMPLE

*** Provider <<<ng:provider>>>
Provider is a service and it's the only thing can be inserted to .config

Instantiation happens in config
#+BEGIN_EXAMPLE
app.config(myProviderConfig);
myProviderConfig.$inject = ['myProviderProvider'];
function myProviderConfig(myProviderProvider){
  myProviderProvider.thingFromConfig = 'This was set in config';
});
#+END_EXAMPLE

Define myProvider
#+BEGIN_EXAMPLE
app.provider('myProvider', function(){
 // app.config() can only access the next 2 lines
 this._artist = '';
 this.thingFromConfig = '';

 this.$get = function(){
   var that = this;

   return {
     getArtist: function(){
       return that._artist;
     },
     thingOnConfig: that.thingFromConfig,
     unicornLauncher: newUnicornLauncher
   }

   newUnicornLauncher.$inject = ['apiToken'];
   function newUnicornLaunder(apiToken) {
     return new UnicornLauncherService(apiToken);
   }

 }
});
#+END_EXAMPLE

#+BEGIN_EXAMPLE
app.controller('myProvider', function($scope, myProvider){
  $scope.artist = myProvider.getArtist();
  $scope.data.thingFromConfig = myProvider.thingOnConfig;
});
#+END_EXAMPLE

*** Change URL without reloading page
First enable ng:html5mode

inject $location and $window
#+BEGIN_EXAMPLE
myNewUrl = '/path/?p=1&q=2';
$location.url(myNewUrl);
$location.replace();
$window.history.pushState(null, 'any', $location.absUrl());
#+END_EXAMPLE

** 2.x Angular
https://github.com/planetoftheweb/learnangular
https://github.com/coursefiles/angular2-essential-training

*** QuickStart seed
**** Install
Local dev env which is the same as [[https://embed.plnkr.co/?show%3Dpreview&show%3Dapp%252Fapp.component.ts][Online playground]]
https://angular.io/guide/setup

#+BEGIN_EXAMPLE
git clone https://github.com/angular/quickstart.git quickstart
cd quickstart
npm install
npm start
// Default port is localhost:3000
#+END_EXAMPLE

Backup ~.gitignore~ 

And remove git-related artifacts
#+BEGIN_EXAMPLE
# OS/X
xargs rm -rf < non-essential-files.osx.txt
rm src/app/*.spec*.ts
rm non-essential-files.osx.txt

# Windows cmd
for /f %i in (non-essential-files.txt) do del %i /F /S /Q
rd .git /s /q
rd e2e /s /q
#+END_EXAMPLE

**** .gitignore
#+BEGIN_EXAMPLE
.idea
node_modules
jspm_packages
npm-debug.log
debug.log
src/**/*.js
!src/systemjs.config.extras.js
!src/systemjs.config.js
!src/systemjs-angular-loader.js
*.js.map
e2e/**/*.js
e2e/**/*.js.map
_test-output
_temp
#+END_EXAMPLE

**** Files
https://angular.io/guide/setup-systemjs-anatomy

src/main.ts
It's loaded in index.html as in
~System.import('main.js').catch(function(err){ console.error(err); });~
Refer to ng:bootstrap

src/systemjs.config.js
It's loaded in index.html. Tells systemJS module loader where to find modules referenced in JS ~import~ statements.
e.g. ~import { Component } from '@angular/core'~

src/tsconfig.json :: how to transpile TypeScript files into JS files

src/app/app.module.ts :: ng:root module
src/app/app.component.ts :: tree of components ng:component

package.json
tslint.json :: Inspect TypeScript code and complains when there's violation
bs-config.json :: lite-server BrowserSync setting

*** SystemJS vs Webpack
Quickstart uses SystemJS to dynamically load files on demand on the client side. It's also called lazy load.
Angular CLI uses Webpack to prepare files. Also does file minifying, transpilation (e.g. from SASS to CSS).

*** package.json
https://angular.io/guide/npm-packages

**** devDependencies
#+BEGIN_EXAMPLE
"devDependencies": {
    "concurrently": "^3.2.0",
    "lite-server": "^2.2.2", // static file server
    "typescript": "~2.1.0", // tsc TypeScript compiler

    "canonical-path": "0.0.2",
    "tslint": "^3.15.1",
    "lodash": "^4.16.4",
    "jasmine-core": "~2.4.1",
    "karma": "^1.3.0",
    "karma-chrome-launcher": "^2.0.0",
    "karma-cli": "^1.0.1",
    "karma-jasmine": "^1.0.2",
    "karma-jasmine-html-reporter": "^0.2.2",
    "protractor": "~4.0.14",
    "rimraf": "^2.5.4",

    "@types/node": "^6.0.46",
    "@types/jasmine": "2.5.36"
}
#+END_EXAMPLE

**** dependencies
#+BEGIN_EXAMPLE
"dependencies": {
    "@angular/common": "~4.0.0", // common services, pipes, and directives provided by Angular
    "@angular/compiler": "~4.0.0", // Angular Template Compiler
    "@angular/core": "~4.0.0", // e.g. all metadata decorators, Component, Directive, dependency injection and component lifecycle hooks
    "@angular/forms": "~4.0.0",
    "@angular/http": "~4.0.0", // Angular's HTTP client.
    "@angular/platform-browser": "~4.0.0", // DOM and browser related. Native directives, pipes, etc. Help render into DOM.
    "@angular/platform-browser-dynamic": "~4.0.0", 
    // Include Providers and a bootstrap method for apps that compile templates on the client.
    // Don't use offline compilation, use this for bootstrapping during dev and for bootstrapping plunker samples
    "@angular/router": "~4.0.0", // Component router

    "angular-in-memory-web-api": "~0.3.0", // Angular simulates a remote server's web api without requiring an actual server or real HTTP calls.
    "systemjs": "0.19.40", // A dynamic module loader compatible with ES2015 module specs. Alternative webpack
    "core-js": "^2.4.1", // polyfill
    "rxjs": "5.0.1", // polyfill
    "zone.js": "^0.8.4" // polyfill
}
#+END_EXAMPLE

**** scripts
#+BEGIN_EXAMPLE
"scripts": {
    "build": "tsc -p src/",
    "build:watch": "tsc -p src/ -w",
    "build:e2e": "tsc -p e2e/",
    "serve": "lite-server -c=bs-config.json",
    "serve:e2e": "lite-server -c=bs-config.e2e.json",
    "prestart": "npm run build",
    "start": "concurrently \"npm run build:watch\" \"npm run serve\"",
    "pree2e": "npm run build:e2e",
    "e2e": "concurrently \"npm run serve:e2e\" \"npm run protractor\" --kill-others --success first",
    "preprotractor": "webdriver-manager update",
    "protractor": "protractor protractor.config.js",
    "pretest": "npm run build",
    "test": "concurrently \"npm run build:watch\" \"karma start karma.conf.js\"",
    "pretest:once": "npm run build",
    "test:once": "karma start karma.conf.js --single-run",
    "lint": "tslint ./src/**/*.ts -t verbose"
}
#+END_EXAMPLE

*** tsconfig.json, d.ts, lib.d.ts
https://angular.io/guide/typescript-configuration
http://www.typescriptlang.org/docs/handbook/tsconfig-json.html

Quickstart src/tsconfig.json
#+BEGIN_EXAMPLE
{
  "compilerOptions": {
    "target": "es5",
    "module": "commonjs",
    "moduleResolution": "node",
    "sourceMap": true,
    "emitDecoratorMetadata": true,
    "experimentalDecorators": true,
    "lib": [ "es2015", "dom" ],
    "noImplicitAny": true,
    "suppressImplicitAnyIndexErrors": true
  }
}
#+END_EXAMPLE

Angular CLI src/tsconfig.app.json extends ./tsconfig.json. See ./.angular-cli.json

d.ts file is a TypeScript Declaration file, which tells the compiler what libraries you load.

Libraries, such as jQuery and Angular extend the JavaScript environment with features and syntax.
~node_modules/@angular/core/~ folder contains several d.ts files. You don't need to do anything to get these typing files for Angular library packages.

lib.XXX.d.ts
Typescript includes many lib.XXX.d.ts files for you to load ambient declarations.
In tsconfig.json for Quickstart, there's a line to load lib.es2015.d.ts and lib.dom.d.ts
Based on the =--target=, TypeScript adds other declarations automatically like =Promose= if the target is =es6=
#+BEGIN_EXAMPLE
"lib": ["es2015", "dom"]
#+END_EXAMPLE

Since many libraries, e.g. jQuery, Jasmine and Lodash, do not include d.ts files in npm packages.

npm install these scoped packages =@types/*= and Typescript automatically recognizes them.
Quickstart dependencies have 2: ~@types/node~ ~@types/jasmine~

*** lite-server
https://www.npmjs.com/package/lite-server

*** CLI
https://github.com/angular/angular-cli
https://github.com/angular/angular-cli/wiki

**** Install & Update
#+BEGIN_EXAMPLE
# Install or update
npm install -g @angular/cli
#+END_EXAMPLE

Update :: update both the global package and your project's local package.

#+BEGIN_EXAMPLE
# Global package:

npm uninstall -g @angular/cli
npm cache clean
npm install -g @angular/cli@latest
Local project package:

rm -rf node_modules dist 
# use this in Windows Command Prompt
# rmdir /S/Q node_modules dist
# use this in Windows PowerShell
# rm -r -fo node_modules,dist
npm install --save-dev @angular/cli@latest
npm install
#+END_EXAMPLE

**** Generate Component, Directive, Pipes and Services
CLI adds reference in app.module.ts automatically.
#+BEGIN_EXAMPLE
# ng generate
ng g component my-new-component
ng g component ../newer-cmp
ng g component feature/new-cmp
ng g directive new-directive
ng g pipe new-pipe
ng g service new-service
ng g class new-class
ng g guard new-guard
ng g interface new-interface
ng g enum new-enum
ng g module new-module 
#+END_EXAMPLE

**** New project
#+BEGIN_EXAMPLE
ng new my-project
cd my-project
ng serve
#+END_EXAMPLE

src/index.html doesn't include any javascript files while quickstart includes some.

**** build
~ng build --prod~ :: Delete and add files to ./dist

All commands that build or serve your project, ~ng build/serve/e2e~, will delete the output directory (dist/ by default). This can be disabled via the ~--no-delete-output-path~ (or ~--delete-output-path=false~) flag.

**** eject <<<ng:cli:webpack>>>
Do this after you have stopped ~ng serve~. This will copy the webpack configuration and modify .angular-cli.json and package.json.
Do ~git status --ignored~ to see the webpack configurations.
After ~ng eject~, ng commands will not work. See changes in package.json. Such as: instead of ~ng serve~, do ~npm run build & npm run start~
You can now modify webpack configuration with real effects.

~ng eject --prod~ production environment. It includes UglifyJsPlugin
npm:webpack

Bundle files are main.ts, polyfills.ts and styles.css

*** Polyfills
[[https://angular.io/guide/browser-support][Other polyfills]]
#+BEGIN_EXAMPLE
<script src="node_modules/core-js/client/shim.min.js"></script>
#+END_EXAMPLE

*** Bootstrap
<<<ng:bootstrap>>>

Create a browser platform for dynamic compilation (JIT) and bootstraps the AppModule by referring to the root module app.module.ts
Refer to ng:root module
#+BEGIN_EXAMPLE
import { platformBrowserDynamic } from '@angular/platform-browser-dynamic';

import { AppModule } from './app/app.module';

platformBrowserDynamic().bootstrapModule(AppModule);
#+END_EXAMPLE

*** Root Module <<<ng:root module>>>

#+BEGIN_EXAMPLE
import { NgModule }      from '@angular/core';
import { BrowserModule } from '@angular/platform-browser';
import { AppComponent }  from './app.component';
// import { FormsModule } from '@angular/forms';

// This decorator makes AppModule as an Angular module class (NgModule class).
// a metadata object to tell Angular how to compile and launch the app
@NgModule({
  // Only put NgModule classes in imports array
  imports:      [ BrowserModule
    // , FormsModule
  ],
  // Only declarables - components, directives and pipes - belong in declarations array. Not NgModule classes
  declarations: [ AppComponent ],
  // Create components listed in the bootstrap array and insert each one into browser DOM
  // It's common to only include one tree of components, which is one file: app.component.ts
  bootstrap:    [ AppComponent ]
})
export class AppModule { }
#+END_EXAMPLE

*** ngModule
https://angular.io/guide/ngmodule

*** Component
<<<ng:component>>> is to create a new html element. It's also a directive with a template
Refer to ng:api:component

src/app/app.component.ts
#+BEGIN_EXAMPLE
import { Component } from '@angular/core';

// Decorator
@Component({
  selector: 'my-app',
  template: `<h1>Hello {{name}}</h1>`,
  inputs: ['inputVar1'],  // Use this or @Input. Refer to ng:input output
  outputs: ['outputVar1'], // Use this or @Output. Refer to ng:input output
})
export class AppComponent  { name = 'Angular'; }
#+END_EXAMPLE

*** Template
**** Files
src/app/[component-name]/[component-name].component.html
src/app/[component-name]/[component-name].component.css
src/app/[component-name]/[component-name].component.ts

src/app/heroes/heroes.component.ts
Use component-relative URLs, prefixed with ~./~
#+BEGIN_EXAMPLE
@Component({
  selector: 'toh-heroes',
  templateUrl: './heroes.component.html', // template or templateUrl, can't be both
  styleUrls:  ['./heroes.component.css'] // each css file is independent! Don't worry about CSS conflicts
  // , styles: [ ".btn {background-color: green;}", ".btn:hover {background-color: pink;}"]
})

export class HeroesComponent implements OnInit {
  /* name = 'abc'; 
     artists: string[]; // could be any
  */
  /* or 
     name: string;
     constructor() {
       this.name = 'abc';
       this.artists = ["1", "2"]
     }
  */

  heroes: Observable<Hero[]>;
  selectedHero: Hero;
  
 onClick(e) {
  // event
  // console.log(e);
  this.name = e.target.innerHTML;
 }

 addArtist(v) {
   if (v!=='') {
     this.artists.push({
       name: v,
       school: 'abc'
     });
   } 
 } 
  
 constructor(private heroService: HeroService) { }
 
  ngOnInit() {
    this.heroes = this.heroService.getHeroes();
  }
}
#+END_EXAMPLE

src/app/heroes/heroes.component.html
#+BEGIN_EXAMPLE
<div>
  <h2>My Heroes</h2>
  <ul class="heroes">
    <li *ngFor="let hero of heroes | async" (click)="selectedHero=hero">
      <span class="badge">{{hero.id}}</span> {{hero.name}}
    </li>
  </ul>
  <div *ngIf="selectedHero">
    <h2>{{selectedHero.name | uppercase}} is my hero</h2>
  </div>
</div>
#+END_EXAMPLE

**** ~{{ }}~
Nonsupported in ~{{ }}~
- Assignments
- Newing up variables
- Chaining expressions
- Incrementing/decrementing

A function can be run
#+BEGIN_EXAMPLE
<div>{{ wasWatched() }}</div>

export class MediaItemComponent { 
  wasWatched() {
    return true;
  }
}
#+END_EXAMPLE

**** Styles
Module bundler like Webpack can load sytles from external files at build time.
~styles: [require('my.component.css')]~

Use ~:host~ to target the host element (one element)

~:host-context()~ looks for a CSS class in any ancestor of the component host element, up to the document root. 
The :host-context() selector is useful when combined with another selector.

This applies a background-color style to all <h2> elements inside the component, 
only if some ancestor element has the CSS class theme-light.

#+BEGIN_EXAMPLE
:host-context(.theme-light) h2 {
  background-color: #eef;
}
#+END_EXAMPLE

~/deep/~ or ~>>>~ works to any depth of nested components, and it applies to both the view children and content children of the component.

This targets all <h3> elements, from the host element down through this component to all of its child elements in the DOM.
#+BEGIN_EXAMPLE
:host /deep/ h3 {
  font-style: italic;
}
#+END_EXAMPLE

Use ~/deep/~ and ~>>>~ selectors only with emulated view encapsulation. 
Emulated is the default and most commonly used [[https://angular.io/guide/component-styles#view-encapsulation][view encapsulation]]. Refer to ng:view encapsulation

Use ~<link>~ in template, path is relative to the root.
#+BEGIN_EXAMPLE
@Component({
  selector: 'hero-team',
  template: `
    <link rel="stylesheet" href="app/hero-team.component.css">
    <h3>Team</h3>
    <ul>
      <li *ngFor="let member of hero.team">
        {{member}}
      </li>
    </ul>`
})
#+END_EXAMPLE

Use ~@imports~ inside my.component.css
#+BEGIN_EXAMPLE
@import 'hero-details-box.css';
#+END_EXAMPLE

<<<ng:view encapsulation>>>
Default is ViewEncapsulation.Emulated, rename CSS code to scope the CSS to the component's view.
ViewEncapsulation.None adds CSS to the global styles.
ViewEncapsulation.Native uses browser's native shadow DOM to attach a shadow DOM to the component's host element.

If the encapsulation is set to ViewEncapsulation.Emulated and the component has no styles nor styleUrls, the encapsulation will automatically be switched to ViewEncapsulation.None.
#+BEGIN_EXAMPLE
@Component({
  selector: 'toh-heroes',
  templateUrl: './heroes.component.html',
  styleUrls:  ['./heroes.component.css'],
  encapsulation: ViewEncapsulation.Emulated
})
#+END_EXAMPLE

**** Event ~(eventType)~
https://angular.io/guide/template-syntax#event-binding

#+BEGIN_EXAMPLE
(click)="onClick($event)"
(input)="name=$event.target.value"
(keyup.enter)="addArtist(newArtist.value); newArtist.value=''"
#+END_EXAMPLE

$event is a DOM event object

**** Template Reference variable ~#var~
#+BEGIN_EXAMPLE
<input #newArtist (keyup.enter)="addArtist(newArtist.value); newArtist.value=''">
<button (click)="addArtist(newArtist.value); newArtist.value=''">Add</button>
#+END_EXAMPLE

~#newArtist~ can be used anywhere in the template.

**** One-way binding
#+BEGIN_EXAMPLE
// Instead of
<lable>Search <span *ngIf="name">for: {{ name }}</span></label>

// Use
<lable>Search <span *ngIf="name" [innerHTML]="' for: ' + name"></span></lable>
// [innerHTML] can be bind-innerHTML

// Or use
<span innerHTML="{{ ' for: ' + name }}"

// DOM element attribute
<img [src]="iconUrl"/>

// Bind clicked DOM element to a variable
<ul class="heroes">
  <li #selectedHero *ngFor="let hero of heroes | async" (click)="onClick(hero, selectedHero)">
    <span class="badge">{{hero.id}}</span> {{hero.name}}
  </li>
</ul>

// inside export class
onClick(item, myElement) {
  this.name = item.name;
  myElement.style.backgroundColor="red";
}
#+END_EXAMPLE

**** Two-way binding ~[(x)]~ ~[(ngModel)]~ ~[ngModel]~ ~(ngModelChange)~

#+BEGIN_EXAMPLE
<input #newArtist 
[value]="name"
(input)="name=$event.target.value"
(keyup.enter)="addArtist(newArtist.value); newArtist.value=''">

// It's equivalent to
<input #newArtist 
[(ngModel)]="name"
(keyup.enter)="addArtist(newArtist.value); newArtist.value=''">
#+END_EXAMPLE

#+BEGIN_EXAMPLE
<input
  [ngModel]="currentHero.name"
  (ngModelChange)="setUppercaseName($event)">
#+END_EXAMPLE

ngModel needs ng:FormsModule

**** @Input, @Output
<<<ng:input output>>>

media-item.component.ts
#+BEGIN_EXAMPLE
import { Component, Input } from '@angular/core';

@Component({
    selector: 'mw-media-item',
    templateUrl: './media-item.component.html',
    styleUrls: ['./media-item.component.css']
})
export class MediaItemComponent {
    // @Input('mediaItemToWatch') mediaItem;
    // The mediaItemToWatch is an alias of mediaItem
    // It's not recommended to have alias
    @Input() mediaItem;

    // strict typing
    @Input()  size: number | string;

    @Output() delete = new EventEmitter();
    // Notice delete is defined in sub component and exists inside mw-media-item DOM element

    onDelete() {
       // emit an event to the parent app.component.ts
       this.delete.emit(this.mediaItem);
    }

}
#+END_EXAMPLE

app.component.ts
#+BEGIN_EXAMPLE
export class AppComponent {
  onMediaItemDelete(mediaItem) {
    
  }

  firstMediaItem = {
    id: 1,
    name: "Firebug",
    medium: "Series",
    category: "Science Fiction",
    year: 2010,
    watchedOn: 1294166565384,
    isFavorite: false
  };
}
#+END_EXAMPLE

mediaItem can be used as a new property for binding ~[mediaItem]~ or ~{{mediaItem}}~
app.component.html
#+BEGIN_EXAMPLE
<section>
  <header>
    <h1>Media Watch List</h1>
    <p class="description">Keeping track of the media I want to watch.</p>
  </header>
  <mw-media-item 
    [mediaItem]="firstMediaItem"
    (delete)="onMediaItemDelete($event)"></mw-media-item>
</section>
#+END_EXAMPLE

media-item.component.html
#+BEGIN_EXAMPLE
<h2>{{ mediaItem.name }}</h2>
<div>Watched on {{ mediaItem.watchedOn }}</div>
<div>{{ mediaItem.category }}</div>
<div>{{ mediaItem.year }}</div>
<div class="tools">
  <a class="delete" (click)="onDelete()">
    remove
  </a>
  <a class="details">
    watch
  </a>
</div>
#+END_EXAMPLE

**** Structural directives (builtin) ~ngIf~ ~ngFor~ ~ngSwitch~ ~<ng-container>~

#+BEGIN_EXAMPLE
<div *ngIf="mediaItem.watchedOn">Watched on {{ mediaItem.watchedOn }} </div>
#+END_EXAMPLE

Even though ngIf is true, only <div> will display
#+BEGIN_EXAMPLE
<template [ngIf]="mediaItem.watchedOn">
  <div>Watched on {{ mediaItem.watchedOn }} </div>
</template>
#+END_EXAMPLE

ngFor :: refer to ng:pipe

ngSwitch
#+BEGIN_EXAMPLE
<div [ngSwitch]="hero?.emotion">
  <happy-hero    *ngSwitchCase="'happy'"    [hero]="hero"></happy-hero>
  <sad-hero      *ngSwitchCase="'sad'"      [hero]="hero"></sad-hero>
  <confused-hero *ngSwitchCase="'confused'" [hero]="hero"></confused-hero>
  <unknown-hero  *ngSwitchDefault           [hero]="hero"></unknown-hero>
</div>
#+END_EXAMPLE

Only one structural directive can be applied to one host element

~<ng-container>~
This is almost works like ~<template>~
#+BEGIN_EXAMPLE
<p>
  I turned the corner
  <span *ngIf="hero">
    and saw {{hero.name}}. I waved
  </span>
  and continued on my way.
</p>
#+END_EXAMPLE

In <select>, before we do and dropdown is empty because a browser won't display an <option> within a <span>.
#+BEGIN_EXAMPLE
<div>
  Pick your favorite hero
  (<label><input type="checkbox" checked (change)="showSad = !showSad">show sad</label>)
</div>
<select [(ngModel)]="hero">
  <span *ngFor="let h of heroes">
    <span *ngIf="showSad || h.emotion !== 'sad'">
      <option [ngValue]="h">{{h.name}} ({{h.emotion}})</option>
    </span>
  </span>
</select>
#+END_EXAMPLE

#+BEGIN_EXAMPLE
<div>
  Pick your favorite hero
  (<label><input type="checkbox" checked (change)="showSad = !showSad">show sad</label>)
</div>
<select [(ngModel)]="hero">
  <ng-container *ngFor="let h of heroes">
    <ng-container *ngIf="showSad || h.emotion !== 'sad'">
      <option [ngValue]="h">{{h.name}} ({{h.emotion}})</option>
    </ng-container>
  </ng-container>
</select>
#+END_EXAMPLE

**** Attribute directives (builtin) ~ngClass~ ~ngStyle~

media-list.component.html
#+BEGIN_EXAMPLE
<section>
  <mw-media-item
    [ngClass]="{'medium-movies': mediaItem.medium==='Movies', 'medium-series':mediaItem.medium==='Series'}" 
    *ngFor="let mediaItem of mediaItems"
    [mediaItem]="mediaItem"
    (delete)="onMediaItemDelete($event)"></mw-media-item>
</section>
#+END_EXAMPLE

~[class]~ or ~[style]~ with a string can also be used
#+BEGIN_EXAMPLE
<!-- Reset class to badCurly only -->
<div class="bad curly special"
     [class]="badCurly">Bad curly</div>

<!-- toggle the "special" class on/off with a property -->
<div [class.special]="isSpecial">The class binding is special</div>


<button [style.color]="isSpecial ? 'red': 'green'">Red</button>
<button [style.background-color]="canSave ? 'cyan': 'grey'" >Save</button>
<button [style.font-size.em]="isSpecial ? 3 : 1" >Big</button>
<button [style.font-size.%]="!isSpecial ? 150 : 50" >Small</button>
#+END_EXAMPLE

*** Pipe <<<ng:pipe>>>
**** Builtin pipes
https://angular.io/api?query=pipe

uppercase, lowercase, titlecase
***** [[https://angular.io/api/common/DatePipe][Date]]
~date_expression | date[:format]~
format
'medium': equivalent to 'yMMMdjms' (e.g. Sep 3, 2010, 12:05:08 PM for en-US)
'short': equivalent to 'yMdjm' (e.g. 9/3/2010, 12:05 PM for en-US)
'fullDate': equivalent to 'yMMMMEEEEd' (e.g. Friday, September 3, 2010 for en-US)
'longDate': equivalent to 'yMMMMd' (e.g. September 3, 2010 for en-US)
'mediumDate': equivalent to 'yMMMd' (e.g. Sep 3, 2010 for en-US)
'shortDate': equivalent to 'yMd' (e.g. 9/3/2010 for en-US)
'mediumTime': equivalent to 'jms' (e.g. 12:05:08 PM for en-US)
'shortTime': equivalent to 'jm' (e.g. 12:05 PM for en-US)

#+BEGIN_EXAMPLE
<p>Today is {{today | date}}</p>
<p>Or if you prefer, {{today | date:'fullDate'}}</p>
<p>The time is {{today | date:'jmZ'}}</p>
#+END_EXAMPLE

***** slice
slice:start[:end]
#+BEGIN_EXAMPLE
<h2>{{ mediaItem.name | slice:0:10 }}</h2>
#+END_EXAMPLE

**** Custom pipe
https://angular.io/guide/pipes

src/app/search.pipe.ts
#+BEGIN_EXAMPLE
import { Pipe, PipeTransform } from '@angular/core';

@Pipe({
  name: 'search',
  // Default is pure, which means the pipe doesn't change the data
  // pure: true,
})

export class SearchPipe implements PipeTransform {
  // pipe is used in ngFor, the first parameter is the pipe data without specifying in template
  transform(pipeData, pipeModifier) {
    return  pipeData.filter((eachItem)=> {
      return eachItem['name'].toLowerCase().includes(pipeModifier.toLowerCase()) 
          || eachItem['reknown'].toLowerCase().includes(pipeModifier.toLowerCase());
    });
  }

  // Another example for ngFor pipe. It returns an array
  transform(mediaItems) {
    var categories = [];
    mediaItems.forEach(mediaItem => {
      if (categories.indexOf(mediaItem.category) <= -1) {
        categories.push(mediaItem.category);
      }
    });
    return categories.join(', ');
  }

 /* Another transform interface example */
 /*
 transform(value: number, exponent: string): number {
    let exp = parseFloat(exponent);
    return Math.pow(value, isNaN(exp) ? 1 : exp);
 }
 */

}
#+END_EXAMPLE

app.html
#+BEGIN_EXAMPLE
<ul class="artistlist cf"
  *ngIf="query">
  <li class="artistlist-item cf"
    (click)="showArtist(item); query=''"
    *ngFor="let item of (artists | search: query)">
    <artist-item class="content" [artist]=item></artist-item>
  </li>
</ul>
#+END_EXAMPLE

*** Directive <<<ng:directive>>>
**** Custom attribute directive ~HostListener~ ~HostBinding~
It's better to add prefix 'my' to selector name
hightlight.directive.ts
#+BEGIN_EXAMPLE
import { Directive, ElementRef, HostListener, Input } from '@angular/core';

@Directive({
  selector: '[myHighlight]'
})
export class HighlightDirective {

  constructor(private el: ElementRef) { }

  @Input() defaultColor: string;

  @Input('myHighlight') highlightColor: string;

  @HostListener('mouseenter') onMouseEnter() {
    this.highlight(this.highlightColor || this.defaultColor || 'red');
  }

  @HostListener('mouseleave') onMouseLeave() {
    this.highlight(null);
  }

  private highlight(color: string) {
    this.el.nativeElement.style.backgroundColor = color;
  }
}
#+END_EXAMPLE

app.component.html
#+BEGIN_EXAMPLE
<h1>My First Attribute Directive</h1>

<h4>Pick a highlight color</h4>
<div>
  <input type="radio" name="colors" (click)="color='lightgreen'">Green
  <input type="radio" name="colors" (click)="color='yellow'">Yellow
  <input type="radio" name="colors" (click)="color='cyan'">Cyan
</div>
<p [myHighlight]="color">Highlight me!</p>

<p [myHighlight]="color" defaultColor="violet">
  Highlight me too!
</p>

<hr>
<p><i>Mouse over the following lines to see fixed highlights</i></p>

<p [myHighlight]="'yellow'">Highlighted in yellow</p>
<p myHighlight="orange">Highlighted in orange</p>
#+END_EXAMPLE

Another example using HostBinding which binds host (DOM) property to a getter or another property
favorite.directive.ts
#+BEGIN_EXAMPLE
import { Directive, HostBinding, Input } from '@angular/core';

@Directive({
  selector: '[mwFavorite]'
})
export class FavoriteDirective {
  @HostBinding('class.is-favorite') isFavorite; 
  // Use ~isFavorite = true~ to set a default
  @Input() set mwFavorite(value) {
    this.isFavorite = value;
  }
  /*
 @HostBinding('attr.something') get something() { 
    return this.somethingElse; 
 }
 */
}
#+END_EXAMPLE

media-item.component.html
#+BEGIN_EXAMPLE
<h2>{{ mediaItem.name }}</h2>
<template [ngIf]="mediaItem.watchedOn">
  <div>Watched on {{ mediaItem.watchedOn }}</div>
</template>
<div>{{ mediaItem.category }}</div>
<div>{{ mediaItem.year }}</div>
<div class="tools">
  <svg
    [mwFavorite]="mediaItem.isFavorite"
    class="favorite" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M12 9.229c.234-1.12 1.547-6.229 5.382-6.229 2.22 0 4.618 1.551 4.618 5.003 0 3.907-3.627 8.47-10 12.629-6.373-4.159-10-8.722-10-12.629 0-3.484 2.369-5.005 4.577-5.005 3.923 0 5.145 5.126 5.423 6.231zm-12-1.226c0 4.068 3.06 9.481 12 14.997 8.94-5.516 12-10.929 12-14.997 0-7.962-9.648-9.028-12-3.737-2.338-5.262-12-4.27-12 3.737z"
    />
  </svg>
  <a class="delete" (click)="onDelete()">
    remove
  </a>
  <a class="details">
    watch
  </a>
</div>
#+END_EXAMPLE

*** Model and Custom Component
src/app/app.component.ts
#+BEGIN_EXAMPLE
import { Component } from '@angular/core';
import { ArtistItemComponent } from './artists/artist-item/artist-item.component';

// Model
export class Artist {
  name: string,
  shortname: string,
  reknown: string,
  bio: string
}

@Component({
  selector: 'my-app',
  templateUrl: './app.component.html',
  styleUrls: ['./app.component.css']
})
export class AppComponent { 
  artists = ARTISTS;
  currentArtist: Artist;
}

var ARTISTS: Artist[] = [...]
#+END_EXAMPLE

src/app/app.component.html
#+BEGIN_EXAMPLE
<div class="card search">
  <h1 class="search-headline">Artist Directory</h1>
  <label class="search-label">search
    <span *ngIf="query"
      [innerHTML]="' for: ' + query"></span></label>
    <input class="search-input"
      [(ngModel)]="query" placeholder="type in search term here">
</div><!-- card search -->

<ul class="artistlist cf">
  <li class="artistlist-item cf"
    *ngFor="let item of artists">
    <artist-item class="content" [artist]=item></artist-item>
  </li>
</ul>
#+END_EXAMPLE

src/app/app.module.ts
#+BEGIN_EXAMPLE
import { NgModule } from '@angular/core';
import { BrowserModule } from '@angular/platform-browser';
import { FormsModule } from '@angular/forms';

import { AppComponent } from './app.component';
import { ArtistItemComponent } from './artists/artist-item/artist-item.component';

@NgModule({
  imports: [
    BrowserModule, FormsModule
  ],
  declarations: [
    AppComponent, ArtistItemComponent
  ],
  bootstrap: [
    AppComponent
  ]
})

export class AppModule {}
#+END_EXAMPLE

src/app/artists/artist-item/artist-item.component.ts
#+BEGIN_EXAMPLE
import { Component } from '@angular/core';

@Component({
  selector: 'artist-item',
  templateUrl: './artist-item.component.html',
  styleUrls: ['./artist-item.component.css'],
  inputs: ['artist']
})

export class ArtistItemComponent {}
#+END_EXAMPLE

src/app/artists/artist-item/artist-item.component.html
#+BEGIN_EXAMPLE
<img class="artist-img" 
  src="images/{{artist.shortname}}_tn.jpg"
  alt="{{artist.name}} photo">
<div class="artist-info">
  <h2 class="artist-name">{{ artist.name }}</h2>
  <h3 class="artist-reknown">{{ artist.reknown }}</h3>
</div>
#+END_EXAMPLE

*** Form
**** Template driven ~ngModel~ ~ngSubmit~
The form element has a name, then directly use ngModel
Template driven form requires <<<ng:FormsModule>>>
https://github.com/coursefiles/angular2-essential-training/blob/04_03b/app

https://github.com/coursefiles/angular2-essential-training/blob/04_03b/app/app.module.ts

src/app/media-item-form.component.ts
#+BEGIN_EXAMPLE
import { Component } from '@angular/core';

@Component({
  selector: 'mw-media-item-form',
  templateUrl: 'app/media-item-form.component.html',
  styleUrls: ['app/media-item-form.component.css']
})
export class MediaItemFormComponent {
  onSubmit(mediaItem) {
    console.log(mediaItem);
  }
}
#+END_EXAMPLE

src/app/media-item-form.component.html
#+BEGIN_EXAMPLE
<header>
  <h2>Add Media to Watch</h2>
</header>
<form
  #mediaItemForm="ngForm"
  (ngSubmit)="onSubmit(mediaItemForm.value)">
  <ul>
    <li>
      <label for="medium">Medium</label>
      <select name="medium" id="medium" ngModel>
        <option value="Movies">Movies</option>
        <option value="Series">Series</option>
      </select>
    </li>
    <li>
      <label for="name">Name</label>
      <input type="text" name="name" id="name" ngModel>
    </li>
    <li>
      <label for="category">Category</label>
      <select name="category" id="category" ngModel>
        <option value="Action">Action</option>
        <option value="Science Fiction">Science Fiction</option>
        <option value="Comedy">Comedy</option>
        <option value="Drama">Drama</option>
        <option value="Horror">Horror</option>
        <option value="Romance">Romance</option>
      </select>
    </li>
    <li>
      <label for="year">Year</label>
      <input type="text" name="year" id="year" maxlength="4" ngModel>
    </li>
  </ul>
  <button type="submit">Save</button>
</form>
#+END_EXAMPLE

**** Model driven, Validation
Model driven form requires <<<ng:ReactiveFormsModule>>> instead of FormsModule. Both can be loaded at the same time

<<<ng:FormGroup>>> <<<ng:FormControl>>> <<<ng:Validators>>>

https://github.com/coursefiles/angular2-essential-training/tree/04_04b/app

https://github.com/coursefiles/angular2-essential-training/blob/04_04b/app/app.module.ts

media-item-form.component.ts
#+BEGIN_EXAMPLE
import { Component } from '@angular/core';
import { FormGroup, FormControl, Validators } from '@angular/forms';

@Component({
  selector: 'mw-media-item-form',
  templateUrl: 'app/media-item-form.component.html',
  styleUrls: ['app/media-item-form.component.css']
})
export class MediaItemFormComponent {
  form;

  ngOnInit() {
    this.form = new FormGroup({
      medium: new FormControl('Movies'),
      name: new FormControl('', Validators.compose([
        Validators.required, // this field has to pass
        Validators.pattern('[\\w\\-\\s\\/]+')
      ])), // builtin validator
      /* if it's wrong, DOM will have ng-invalid css class but it's not mandatory
      name: new FormControl('', Validators.pattern('[\\w\\-\\s\\/]+')),
      */
      category: new FormControl(''),
      year: new FormControl('', this.yearValidator),
    });
  }  
  
  yearValidator(control) {
    if (control.value.trim().length === 0) {
      return null;
    }
    let year = parseInt(control.value);
    let minYear = 1800;
    let maxYear = 2500;
    if (year >= minYear && year <= maxYear) {
      return null;
    } else {
      return {
        'year': {
          min: minYear,
          max: maxYear
        }
      };
    }
  }

  onSubmit(mediaItem) {
    console.log(mediaItem);
  }
}
#+END_EXAMPLE

media-item-form.component.html
#+BEGIN_EXAMPLE
<form
  [formGroup]="form"
  (ngSubmit)="onSubmit(form.value)">
  <ul>
    <li>
      <label for="medium">Medium</label>
      <select name="medium" id="medium" formControlName="medium">
        <option value="Movies">Movies</option>
        <option value="Series">Series</option>
      </select>
    </li>
    <li>
      <label for="name">Name</label>
      <input type="text" name="name" id="name" formControlName="name">
      <div *ngIf="form.controls.name.errors?.pattern" class="error">
        Name has invalid characters
      </div>
    </li>
    <li>
      <label for="category">Category</label>
      <select name="category" id="category" formControlName="category">
        <option value="Action">Action</option>
        <option value="Science Fiction">Science Fiction</option>
        <option value="Comedy">Comedy</option>
        <option value="Drama">Drama</option>
        <option value="Horror">Horror</option>
        <option value="Romance">Romance</option>
      </select>
    </li>
    <li>
      <label for="year">Year</label>
      <input type="text" name="year" id="year" maxlength="4" formControlName="year">
      <div *ngIf="form.controls.year.errors?.year" class="error">
        Must be between 
        {{form.controls.year.errors?.year.min}} 
        and 
        {{form.controls.year.errors?.year.max}}
      </div>
    </li>
  </ul>
  <button type="submit" [disabled]="!form.valid">Save</button>
</form>
#+END_EXAMPLE

*** Service, Dependency Injection
Either use constructor or @Inject to include a service.
Define services in a provider, when service is injected, if it has been created before, reuse it. If not, create it.
Service is singleton and once it's been created, it will be injectable across the app's life time.

Unlike componet, directive and pipe, if a service needs other dependencies, the service needs @Injectable decorator. Refer to ng:http:get

Angular services :: Http, FormBuilder, Router

**** FormBuilder
<<<ng:FormBuilder>>> saves from importing FormControl and FormGroup

#+BEGIN_EXAMPLE
import { Component } from '@angular/core';
import { Validators, FormBuilder } from '@angular/forms';

@Component({
  selector: 'mw-media-item-form',
  templateUrl: 'app/media-item-form.component.html',
  styleUrls: ['app/media-item-form.component.css']
})
export class MediaItemFormComponent {
  form;

  constructor(private formBuilder: FormBuilder) {}

  ngOnInit() {
    this.form = this.formBuilder.group({
      medium: this.formBuilder.control('Movies'),
      name: this.formBuilder.control('', Validators.compose([
        Validators.required,
        Validators.pattern('[\\w\\-\\s\\/]+')
      ])),
      category: this.formBuilder.control(''),
      year: this.formBuilder.control('', this.yearValidator),
    });
  }

  yearValidator(control) {
    if (control.value.trim().length === 0) {
      return null;
    }
    let year = parseInt(control.value);
    let minYear = 1800;
    let maxYear = 2500;
    if (year >= minYear && year <= maxYear) {
      return null;
    } else {
      return {
        'year': {
          min: minYear,
          max: maxYear
        }
      };
    }
  }

  onSubmit(mediaItem) {
    console.log(mediaItem);
  }
}
#+END_EXAMPLE

**** Custom service and inject variable
https://github.com/coursefiles/angular2-essential-training/tree/05_06b/app
https://github.com/coursefiles/angular2-essential-training/tree/05_07b/app

app.module.ts
#+BEGIN_EXAMPLE
import { MediaItemService } from './media-item.service'; // inject as a class

// inject as a value
// https://angular.io/api/core/ValueProvider
const lookupLists = {
  mediums: ['Movies', 'Series']
};

@NgModule({
  imports: [ ... ],
  declarations: [ ... ],
  providers: [
    MediaItemService,
    { provide: 'lookupListToken', useValue: lookupLists }
  // Another value provider
  // , { provide: 'lookupListToken2', useValue: 'abc' }
  ],
  bootstrap: [
    AppComponent
  ]
})
export class AppModule {}
#+END_EXAMPLE

media-item.service.ts
#+BEGIN_EXAMPLE
export class MediaItemService {
  get() {
    return this.mediaItems;
  }
  
  add(mediaItem) {
    this.mediaItems.push(mediaItem);
  }
  
  delete(mediaItem) {
    let index = this.mediaItems.indexOf(mediaItem);
    if(index >= 0) {
      this.mediaItems.splice(index, 1);
    }
  }

  mediaItems = [
    {
      id: 1,
      name: "Firebug",
      medium: "Series",
      category: "Science Fiction",
      year: 2010,
      watchedOn: 1294166565384,
      isFavorite: false
    },
    {...}
  ];
}
#+END_EXAMPLE

media-item-list.component.ts
#+BEGIN_EXAMPLE
import { Component } from '@angular/core';

import { MediaItemService } from './media-item.service';

@Component({
  selector: 'mw-media-item-list',
  templateUrl: 'app/media-item-list.component.html',
  styleUrls: ['app/media-item-list.component.css']
})
export class MediaItemListComponent {
  mediaItems;

  constructor(private mediaItemService: MediaItemService) {}

  ngOnInit() {
    this.mediaItems = this.mediaItemService.get();
  }

  onMediaItemDelete(mediaItem) {
    this.mediaItemService.delete(mediaItem);
  }

}
#+END_EXAMPLE

media-item-form.component.ts
#+BEGIN_EXAMPLE
import { Component, Inject } from '@angular/core';
// Inject is for injecting the ValueProvider

import { Validators, FormBuilder } from '@angular/forms';

import { MediaItemService } from './media-item.service';

@Component({
  selector: 'mw-media-item-form',
  templateUrl: 'app/media-item-form.component.html',
  styleUrls: ['app/media-item-form.component.css']
})
export class MediaItemFormComponent {
  form;

  constructor(
    private formBuilder: FormBuilder,
    private mediaItemService: MediaItemService,
    @Inject('lookupListToken') public lookupLists) {}

  // private can be used inside the class here as this.xxx
  // public can be used outside the class such as in template as xxx

  ngOnInit() {
    this.form = this.formBuilder.group({ ... });
  }

  yearValidator(control) { ... }

  onSubmit(mediaItem) {
    this.mediaItemService.add(mediaItem);
  }
}
#+END_EXAMPLE

media-item-form.component.html
#+BEGIN_EXAMPLE
<form
  [formGroup]="form"
  (ngSubmit)="onSubmit(form.value)">
  <ul>
    <li>
      <label for="medium">Medium</label>
      <select name="medium" id="medium" formControlName="medium">
        <option *ngFor="let medium of lookupLists.mediums" value="{{medium}}">{{medium}}</option>
      </select>
    </li>
    ...li
  </ul>
</form>
#+END_EXAMPLE

**** OpaqueToken, InjectionToken
Use this rather than ValueProvider
OpaqueToken is deprecated, use InjectionToken
https://angular.io/guide/dependency-injection#injection-token

https://github.com/coursefiles/angular2-essential-training/tree/06_01b/app

providers.ts
#+BEGIN_EXAMPLE
import { OpaqueToken } from '@angular/core';

export const lookupListToken = new OpaqueToken('lookupListToken');

export const lookupLists = {
  mediums: ['Movies', 'Series']
};
#+END_EXAMPLE

app.module.ts
#+BEGIN_EXAMPLE
import { lookupListToken, lookupLists } from './providers';

@NgModule({
  imports: [ ...  ],
  declarations: [ ... ],
  providers: [
    MediaItemService,
    { provide: lookupListToken, useValue: lookupLists }
  ],
  bootstrap: [
    AppComponent
  ]
})
export class AppModule {}
#+END_EXAMPLE

media-item-form.component.ts
#+BEGIN_EXAMPLE
import { lookupListToken } from './provders';

 constructor(
    private formBuilder: FormBuilder,
    private mediaItemService: MediaItemService,
    @Inject(lookupListToken) public lookupLists) {}
#+END_EXAMPLE

**** Http
https://angular.io/guide/http

***** mock back end <<<ng:mock back end>>>
https://angular.io/guide/http#in-mem-web-api
https://angular.io/api/http/XHRBackend
https://github.com/coursefiles/angular2-essential-training/tree/06_03b/app

app.module.ts
#+BEGIN_EXAMPLE
import { NgModule } from '@angular/core';
import { BrowserModule } from '@angular/platform-browser';
import { ReactiveFormsModule } from '@angular/forms';
import { HttpModule, XHRBackend } from '@angular/http';

import { AppComponent } from './app.component';
import { MediaItemComponent } from './media-item.component';
import { MediaItemListComponent } from './media-item-list.component';
import { FavoriteDirective } from './favorite.directive';
import { CategoryListPipe } from './category-list.pipe';
import { MediaItemFormComponent } from './media-item-form.component';
import { MediaItemService } from './media-item.service';
import { lookupListToken, lookupLists } from './providers';
// new
import { MockXHRBackend } from './mock-xhr-backend';

@NgModule({
  imports: [
    BrowserModule,
    ReactiveFormsModule,
    HttpModule
  ],
  declarations: [
    AppComponent,
    MediaItemComponent,
    MediaItemListComponent,
    FavoriteDirective,
    CategoryListPipe,
    MediaItemFormComponent
  ],
  providers: [
    MediaItemService,
    { provide: lookupListToken, useValue: lookupLists },
    // new
    { provide: XHRBackend, useClass: MockXHRBackend }
  ],
  bootstrap: [
    AppComponent
  ]
})
export class AppModule {}
#+END_EXAMPLE

https://github.com/coursefiles/angular2-essential-training/blob/06_03b/app/mock-xhr-backend.ts
mock-xhr-backend.ts

***** get <<<ng:http:get>>>
http.get() returns an Observable<Response>. Refer to js:observable
Observable.map() is one of RxJS operators needed to be imported

RxJS is a 3rd party library implements async Observable pattern.

https://github.com/coursefiles/angular2-essential-training/tree/06_04b/app

It uses the paths defined in ng:mock back end

media-item.service.ts
#+BEGIN_EXAMPLE
// new
import { Injectable } from '@angular/core';
import { Http } from '@angular/http';
import 'rxjs/add/operator/map';

// This custom service class needs dependency injection, so it needs a decorator Injectable
@Injectable()
export class MediaItemService {
  constructor(private http: Http) {}

  get() {
    // new
    return this.http.get('mediaitems')
      .map(response => {
        return response.json().mediaItems;
      });
  }
  
  add(mediaItem) {
    this.mediaItems.push(mediaItem);
  }
  
  delete(mediaItem) {
    let index = this.mediaItems.indexOf(mediaItem);
    if(index >= 0) {
      this.mediaItems.splice(index, 1);
    }
  }

  mediaItems = [ {}, ... ];
}
#+END_EXAMPLE

media-item-list.component.ts
#+BEGIN_EXAMPLE
ngOnInit() {
    this.getMediaItems(this.medium);
}
getMediaItems(medium) {
    this.medium = medium;
    this.mediaItemService.get()
      .subscribe(mediaItems => {
        this.mediaItems = mediaItems;
      });
}
#+END_EXAMPLE

***** get with URLSearchParams
https://github.com/coursefiles/angular2-essential-training/tree/06_05b/app

media-item.service.ts
#+BEGIN_EXAMPLE
import { Injectable } from '@angular/core';
import { Http, URLSearchParams } from '@angular/http';
import 'rxjs/add/operator/map';
// Other Observable operators
// import 'rxjs/add/operator/catch'

@Injectable()
export class MediaItemService {
  constructor(private http: Http) {}

  get(medium) {
    let searchParams = new URLSearchParams();
    searchParams.append('medium', medium);
    // searchParams.set('medium', medium);
    return this.http.get('mediaitems', { search: searchParams })
      .map(response => {
        return response.json().mediaItems;
      });
  }
  
  add(mediaItem) { ... }
  
  delete(mediaItem) { ... }

  mediaItems = [ {}, ... ];
}
#+END_EXAMPLE

media-item-list.component.ts
#+BEGIN_EXAMPLE
ngOnInit() {
    this.getMediaItems(this.medium);
}
getMediaItems(medium) {
    this.medium = medium;
    this.mediaItemService.get(medium)
      .subscribe(mediaItems => {
        this.mediaItems = mediaItems;
      });
}
#+END_EXAMPLE

***** post, put, delete
https://github.com/coursefiles/angular2-essential-training/tree/07_01b/app

media-item.service.ts
#+BEGIN_EXAMPLE
import { Injectable } from '@angular/core';
import { Http, URLSearchParams } from '@angular/http';
import 'rxjs/add/operator/map';

@Injectable()
export class MediaItemService {
  constructor(private http: Http) {}

  get(medium) {
    let searchParams = new URLSearchParams();
    searchParams.append('medium', medium);
    return this.http.get('mediaitems', { search: searchParams })
      .map(response => {
        return response.json().mediaItems;
      });
  }
  
  add(mediaItem) {
    // new
    return this.http.post('mediaitems', mediaItem)
      .map(response => {});
  }
  
  delete(mediaItem) {
    // new
    return this.http.delete(`mediaitems/${mediaItem.id}`)
      .map(response => {});
  }
}
#+END_EXAMPLE

media-item-form.component.ts
#+BEGIN_EXAMPLE
import { Component, Inject } from '@angular/core';
import { Validators, FormBuilder } from '@angular/forms';

import { MediaItemService } from './media-item.service';
import { lookupListToken } from './providers';

@Component({
  selector: 'mw-media-item-form',
  templateUrl: 'app/media-item-form.component.html',
  styleUrls: ['app/media-item-form.component.css']
})
export class MediaItemFormComponent {
  form;

  constructor(
    private formBuilder: FormBuilder,
    private mediaItemService: MediaItemService,
    @Inject(lookupListToken) public lookupLists) {}

  ngOnInit() {
    this.form = this.formBuilder.group({
      medium: this.formBuilder.control('Movies'),
      name: this.formBuilder.control('', Validators.compose([
        Validators.required,
        Validators.pattern('[\\w\\-\\s\\/]+')
      ])),
      category: this.formBuilder.control(''),
      year: this.formBuilder.control('', this.yearValidator),
    });
  }

  yearValidator(control) {
    if (control.value.trim().length === 0) {
      return null;
    }
    let year = parseInt(control.value);
    let minYear = 1800;
    let maxYear = 2500;
    if (year >= minYear && year <= maxYear) {
      return null;
    } else {
      return {
        'year': {
          min: minYear,
          max: maxYear
        }
      };
    }
  }

  onSubmit(mediaItem) {
    // new
    this.mediaItemService.add(mediaItem)
      .subscribe();
  }
}
#+END_EXAMPLE

media-item-list.component.ts
#+BEGIN_EXAMPLE
import { Component } from '@angular/core';

import { MediaItemService } from './media-item.service';

@Component({
  selector: 'mw-media-item-list',
  templateUrl: 'app/media-item-list.component.html',
  styleUrls: ['app/media-item-list.component.css']
})
export class MediaItemListComponent {
  medium = '';
  mediaItems = [];

  constructor(private mediaItemService: MediaItemService) {}

  ngOnInit() {
    this.getMediaItems(this.medium);
  }

  onMediaItemDelete(mediaItem) {
    // new
    this.mediaItemService.delete(mediaItem)
      .subscribe(() => {
        this.getMediaItems(this.medium);
      });
  }

  getMediaItems(medium) {
    this.medium = medium;
    this.mediaItemService.get(medium)
      .subscribe(mediaItems => {
        this.mediaItems = mediaItems;
      });
  }
}
#+END_EXAMPLE

*** Route
**** base href, config and register routes
https://github.com/coursefiles/angular2-essential-training/tree/07_03b/app

index.html
#+BEGIN_EXAMPLE
<base href="/">
#+END_EXAMPLE

app.routing.ts
#+BEGIN_EXAMPLE
import { Routes, RouterModule } from '@angular/router';

import { MediaItemFormComponent } from './media-item-form.component';
import { MediaItemListComponent } from './media-item-list.component';

const appRoutes: Routes = [
  { path: 'add', component: MediaItemFormComponent },
  { path: ':medium', component: MediaItemListComponent },
  { path: '', pathMatch: 'full', redirectTo: 'all' }
];

export const routing = RouterModule.forRoot(appRoutes);
#+END_EXAMPLE

app.module.ts
#+BEGIN_EXAMPLE
import { routing } from './app.routing';

@NgModule({
  imports: [
    BrowserModule,
    ReactiveFormsModule,
    HttpModule,
    routing
  ],
  ...
})
#+END_EXAMPLE

**** router-outlet
app.component.html
Before, both form and list are loaded.
#+BEGIN_EXAMPLE
<section>
  <header>
    <h1>Media Watch List</h1>
    <p class="description">Keeping track of the media I want to watch.</p>
  </header>
  <mw-media-item-form></mw-media-item-form>
  <mw-media-item-list></mw-media-item-list>
</section>
#+END_EXAMPLE

After, form or list is loaded based on the current router state. The loaded component is the next sibling of the router-outlet HTML element.
#+BEGIN_EXAMPLE
<section>
  <header>
    <h1>Media Watch List</h1>
    <p class="description">Keeping track of the media I want to watch.</p>
  </header>
  <router-outlet></router-outlet>
</section>
#+END_EXAMPLE

https://angular.io/api/router/RouterOutlet

**** routerLink
app.component.html
#+BEGIN_EXAMPLE
<nav>
  <a routerLink="/">
    <img src="media/04.png" class="icon" />
  </a>
  <a routerLink="/Movies">
    <img src="media/03.png" class="icon" />
  </a>
  <a routerLink="/Series">
    <img src="media/02.png" class="icon" />
  </a>
</nav>
#+END_EXAMPLE

**** read route in component
media-item-list.component.ts
#+BEGIN_EXAMPLE
import { Component } from '@angular/core';
import { ActivatedRoute } from '@angular/router'; // new

import { MediaItemService } from './media-item.service';

@Component({
  selector: 'mw-media-item-list',
  templateUrl: 'app/media-item-list.component.html',
  styleUrls: ['app/media-item-list.component.css']
})
export class MediaItemListComponent {
  medium = '';
  mediaItems = [];
  paramsSubscription; // new

  constructor(
    private mediaItemService: MediaItemService,
    private activatedRoute: ActivatedRoute // new
  ) {}

  ngOnInit() {
    // before 
    // this.getMediaItems(this.medium);

    // now
    this.paramsSubscription = this.activatedRoute.params
      .subscribe(params => {
        let medium = params['medium'];
        if(medium.toLowerCase() === 'all') {
          medium = '';
        }
        this.getMediaItems(medium);
      });
  }
  
  // new
  ngOnDestroy() {
    this.paramsSubscription.unsubscribe();
  }

  onMediaItemDelete(mediaItem) {
    this.mediaItemService.delete(mediaItem)
      .subscribe(() => {
        this.getMediaItems(this.medium);
      });
  }

  getMediaItems(medium) {
    this.medium = medium;
    this.mediaItemService.get(medium)
      .subscribe(mediaItems => {
        this.mediaItems = mediaItems;
      });
  }
}
#+END_EXAMPLE

**** Navigate in code
Form submit and navigate in code
media-item-form.component.ts
#+BEGIN_EXAMPLE
import { Component, Inject } from '@angular/core';
import { Validators, FormBuilder } from '@angular/forms';
import { Router } from '@angular/router'; // new

import { MediaItemService } from './media-item.service';
import { lookupListToken } from './providers';

@Component({
  selector: 'mw-media-item-form',
  templateUrl: 'app/media-item-form.component.html',
  styleUrls: ['app/media-item-form.component.css']
})
export class MediaItemFormComponent {
  form;

  constructor(
    private formBuilder: FormBuilder,
    private mediaItemService: MediaItemService,
    @Inject(lookupListToken) public lookupLists,
    private router: Router) {}

  ngOnInit() {
    this.form = this.formBuilder.group({
      medium: this.formBuilder.control('Movies'),
      name: this.formBuilder.control('', Validators.compose([
        Validators.required,
        Validators.pattern('[\\w\\-\\s\\/]+')
      ])),
      category: this.formBuilder.control(''),
      year: this.formBuilder.control('', this.yearValidator),
    });
  }

  yearValidator(control) {
    if (control.value.trim().length === 0) {
      return null;
    }
    let year = parseInt(control.value);
    let minYear = 1800;
    let maxYear = 2500;
    if (year >= minYear && year <= maxYear) {
      return null;
    } else {
      return {
        'year': {
          min: minYear,
          max: maxYear
        }
      };
    }
  }

  onSubmit(mediaItem) {
    this.mediaItemService.add(mediaItem)
      .subscribe(() => {
        // new
        this.router.navigate(['/', mediaItem.medium]);
      });
  }
}
#+END_EXAMPLE

*** API
Search https://angular.io/api

<<<ng:api:component>>> https://angular.io/api/core/Component

*** Style Guide
**** File Structure <<<ng:file structure>>>
https://angular.io/guide/styleguide#file-tree

src/app/heroes/hero.component.ts
#+BEGIN_EXAMPLE
@Component({
  selector: 'toh-hero'
})
export class HeroComponent {}
#+END_EXAMPLE

src/app/heroes/hero-list/hero-list.component.ts
#+BEGIN_EXAMPLE
import { Component, OnInit } from '@angular/core';
 
import { Hero, HeroService } from '../shared';
 
@Component({
  selector: 'toh-heroes',
  template: `
      <pre>{{heroes | json}}</pre>
    `
})
export class HeroListComponent implements OnInit {
  heroes: Hero[] = [];
 
  constructor(private heroService: HeroService) { }
 
  ngOnInit() {
    this.heroService.getHeroes().subscribe(heroes => this.heroes = heroes);
  }
}
#+END_EXAMPLE

src/app/heroes/shared/hero.service.ts|spec.ts
#+BEGIN_EXAMPLE
import { Injectable } from '@angular/core';
import { Http }       from '@angular/http';

import { Hero } from './hero.model';
import { ExceptionService, SpinnerService, ToastService } from '../../core';
export class HeroService {
  constructor(private http: Http) { }

  getHeroes() {
    return this.http.get('api/heroes')
      .map((response: Response) => <Hero[]>response.json().data);
  }
}
#+END_EXAMPLE

src/app/heroes/shared/hero.model.ts
#+BEGIN_EXAMPLE
export class Hero {
  id: number;
  name: string;
}
#+END_EXAMPLE

src/app/heroes/shared/hero-button.component.ts|html|css|spec.ts

**** File name
Use dashes to separate words in file names (hero-list)
Use a dot to separate the descriptive name from the type (.component)
app/heroes/hero-list.component.ts

A file should have no more than 400 lines of code.
A small function should have no more than 75 lines.

**** Symbol name and file name
Use upper camel case for class names
#+BEGIN_EXAMPLE
// hero-list.component.ts
@Component({ ... })
export class HeroListComponent { }

// validation.directive.ts
@Directive({ ... })
export class ValidationDirective { }

// app.module.ts
@NgModule({ ... })
export class AppModule

// init-caps.pipe.ts
@Pipe({ name: 'initCaps' })
export class InitCapsPipe implements PipeTransform {}

// user-profile.service.ts
@Injectable()
export class UserProfileService { }
#+END_EXAMPLE

**** Bootstrapping
Use main.ts as the file name
Include error handling
Don't put logic in this file.
#+BEGIN_EXAMPLE
import { platformBrowserDynamic } from '@angular/platform-browser-dynamic';
import { AppModule }              from './app/app.module';
platformBrowserDynamic().bootstrapModule(AppModule)
  .then(success => console.log(`Bootstrap success`))
  .catch(err => console.error(err));
#+END_EXAMPLE

**** Directive selectors (lower camel case)

* Vue.js
** Builds
https://cdn.jsdelivr.net/npm/vue is the Runtime + Compiler UMD Minimized latest build

https://unpkg.com/vue is the same above but not minimized (development).

Runtime only is good for webpack.

[[https://cdn.jsdelivr.net/npm/vue/dist/][All latest builds]]

** Basics
#+BEGIN_EXAMPLE
<script src="https://unpkg.com/vue"></script>

<div id="app">
  <!-- bind attribute to a var -->
  <span v-bind:title="msg2">
    {{ message }}
  </span>
  <div>
    <span v-if="seen">Now you see me</span>
  </div>
  <div>
    <ol>
      <li v-for="todo in todos">
        {{ todo.text }}
      </li>
    </ol>
  </div>

  <button v-on:click="reverseMessage">Reverse Message</button>

  <!-- 2 way binding -->
  <div>
    <input v-model="message">
  </div>
</div>

<script>
  var my_vue_app = new Vue({
    el: '#app',
    data: {
      message: 'Hello Vue.js!',
      msg2: 'span title',
      seen: true,
      // my_vue_app.todos.push({ text: 'New item' })
      todos: [
        { text: 'Learn JavaScript' },
        { text: 'Learn Vue' },
        { text: 'Build something awesome' }
      ]
    },
    methods: {
      reverseMessage: function () {
        this.message = this.message.split('').reverse().join('')
      }
    }
  })
</script>
#+END_EXAMPLE

** Data and methods
<<<vue:data>>>

Root-level reactive properties need to be defined when the instance was first created.
#+BEGIN_EXAMPLE
var data = {a:1}
var vm = new Vue({
  data: data
});

vm.a === data.a // true, they refer to the same object
vm.a = 2 // then data.a is 2, too
data.a = 3 // and vice-versa vm.a === 3

vm.b = 'hi' // the properties in data are active only when the instance was first created.
// a new property is defined after initialization, so it won't trigger view update.
// Define all variables with default values you need in initialization.
#+END_EXAMPLE

Special instance properties and methods :: vm.$data, vm.$el, vm.$watch

Don't use arrow function
#+BEGIN_EXAMPLE
var data = { a: 1 }
var vm = new Vue({
  el: '#example',
  data: data
})
vm.$data === data // => true
vm.$el === document.getElementById('example') // => true
// $watch is an instance method
vm.$watch('a', function (newValue, oldValue) {
  // This callback will be called when `vm.a` changes
})
#+END_EXAMPLE

Some plugins allow components to access/change specific root-level properties e.g. this.$store vue:plugin:vuex, this.$router vue:router
This is specifically enabled in the plugin.

*** Mutation, Vue.set
<<<vue:data:mutation>>>
Mutation methods :: when these methods are called, the views will be updated.
push, pop, shift, unshift, splice, sort, reverse

e.g. my_vue_app.items.push({ message: 'Baz'});

Non-mutating methods always return a new array.

e.g. filter, concat
#+BEGIN_EXAMPLE
example1.items = example1.items.filter(function (item) {
  return item.message.match(/Foo/)
})
#+END_EXAMPLE

Add new prop reactivitely :: Don't use vm.items[indexOfItem] = newValue, instead use:
#+BEGIN_EXAMPLE
// Vue.set
Vue.set(example1.items, indexOfItem, newValue)

// Or

// Array.prototype.splice
example1.items.splice(indexOfItem, 1, newValue)
#+END_EXAMPLE

Don't use vm.items.length = newLenth, instead use:
#+BEGIN_EXAMPLE
example1.items.splice(newLength)
#+END_EXAMPLE

Add reactive properties to an object at root-level
#+BEGIN_EXAMPLE
var vm = new Vue({
  data: {
    userProfile: {
      name: 'Anika'
    }
  }
})

Vue.set(vm.userProfile, 'age', 27);

// or this.$set(this.userProfile, 'age', 27)
// or vm.$set
#+END_EXAMPLE

The other way to add a new prop is to rebuild the object using Object.assign() or _.extend()

#+BEGIN_EXAMPLE
/* Don't do it directly
Object.assign(this.userProfile, {
  age: 27,
  favoriteColor: 'Vue Green'
})
*/

this.userProfile = Object.assign({}, this.userProfile, {
  age: 27,
  favoriteColor: 'Vue Green'
})
#+END_EXAMPLE

vue:plugin:vuex:mutations

** Instance Lifecycle Hooks
Data observation > compile templates > mount instance to DOM > Update DOM when data changes

Don't use arrow function in those hooks e.g. ~created: () => console.log(this.a)~

[[https://vuejs.org/v2/guide/instance.html#Lifecycle-Diagram][Full lifecycle diagram and hooks]]

*** beforeCreate, created
run code after an instance is created

#+BEGIN_EXAMPLE
new Vue({
  data: {
    a: 1
  },
  created: function () {
    // `this` points to the vm instance
    console.log('a is: ' + this.a)
  }
})
// => "a is: 1"
#+END_EXAMPLE

*** vm.$mount(el), beforeMount, mounted
*** beforeUpdate, updated
*** beforeDestroy, destroyed

** Component
*** Basics
component name better to have all lowercase and must contain a hyphen.

Although these can be used in string templates
#+BEGIN_EXAMPLE
components: {
  'kebab-cased-component': { /* ... */ },
  camelCasedComponent: { /* ... */ },
  PascalCasedComponent: { /* ... */ }
}
#+END_EXAMPLE

#+BEGIN_EXAMPLE
<div id="app-7">
  <ol>
    <!--
      Now we provide each todo-item with the todo object
      it's representing, so that its content can be dynamic.
      We also need to provide each component with a "key",
      which will be explained later.
    -->
    <todo-item
      v-for="item in groceryList"
      v-bind:todo="item"
      v-bind:key="item.id">
    </todo-item>
  </ol>
</div>
#+END_EXAMPLE

#+BEGIN_EXAMPLE
Vue.component('todo-item', {
  props: ['todo'],
  template: '<li>{{ todo.text }}</li>'
})
var app7 = new Vue({
  el: '#app-7',
  data: {
    groceryList: [
      { id: 0, text: 'Vegetables' },
      { id: 1, text: 'Cheese' },
      { id: 2, text: 'Whatever else humans are supposed to eat' }
    ]
  }
})
#+END_EXAMPLE

Vue.component registers a component globally. Make a component available only in the scope of another instance/component by registering it with the components instance option:

#+BEGIN_EXAMPLE
var Child = {
  template: '<div>A custom component!</div>'
}
new Vue({
  // ...
  components: {
    // <my-component> will only be available in parent's template
    'my-component': Child
  }
})
#+END_EXAMPLE

Component should be used in a way that has 3 parts 
- props :: pass from parent to component
- events :: set parent based on events triggered from component
- slots :: customize, from parent, the look of the component
#+BEGIN_EXAMPLE
<my-component
  :foo="baz"
  :bar="qux"
  @event-a="doThis"
  @event-b="doThat"
>
  <img slot="icon" src="...">
  <p slot="main-text">Hello!</p>
</my-component>
#+END_EXAMPLE

*** DOM Template Parsing Caveats
Becuase <ul>, <ol>, <table> and <select> need to have certain elements appearing inside them and some elements such as <option> can only appear inside certain other elements, it will lead to parsing issues if you do this
#+BEGIN_EXAMPLE
<table>
  <my-row>...</my-row>
</table>
#+END_EXAMPLE

So better to do this
#+BEGIN_EXAMPLE
<table>
  <tr is="my-row"></tr>
</table>
#+END_EXAMPLE

camelCase vs. kebab-case


These limitations do not apply if you are using string templates from one of the following sources:
- <script type='text/x-template'>
- JavaScript inline template strings
- .vue components

So, prefer using string templates whenever possible.

*** Option data has to be a function
data is the initialization part that defines extra local data properties that are only available in the component.

3 simple-counter's have their own initializing part and scopes.
#+BEGIN_EXAMPLE
<div id="example-2">
  <simple-counter></simple-counter>
  <simple-counter></simple-counter>
  <simple-counter></simple-counter>
</div>

Vue.component('simple-counter', {
  template: '<button v-on:click="counter += 1">{{ counter }}</button>',
  data: function () {
    return {
      counter: 0
    }
  }
})
new Vue({
  el: '#example-2'
})
#+END_EXAMPLE

*** Option filters
Text formatting
#+BEGIN_EXAMPLE
<!-- in mustaches -->
{{ message | capitalize }}
<!-- in v-bind -->
<div v-bind:id="rawId | formatId"></div>

filters: {
  capitalize: function (value) {
    if (!value) return ''
    value = value.toString()
    return value.charAt(0).toUpperCase() + value.slice(1)
  }
}

// define globally
Vue.filter('capitalize', function (value) {
  if (!value) return ''
  value = value.toString()
  return value.charAt(0).toUpperCase() + value.slice(1)
})

// can be chained
{{ message | filterA | filterB }}

// can have arguments
{{ message | filterA('arg1', arg2) }}
#+END_EXAMPLE

*** Props down
Pass down prop from parent to child using child component's prop option.

When the parent property updates, it will flow down to the child but not the other way around.

#+BEGIN_EXAMPLE
Vue.component('child', {
  // declare the props
  props: ['message'],
  // like data, the prop can be used inside templates and
  // is also made available in the vm as this.message
  template: '<span>{{ message }}</span>'
})

// parent page
<child message="hello!"></child>

// dynamic binding a parent variable
<div>
  <input v-model="parentMsg">
  <br>
  <child v-bind:my-message="parentMsg"></child>
</div>

// pass all properties of the parent as props to the child
todo: {
  text: 'Learn Vue',
  isComplete: false
}

<todo-item v-bind="todo"></todo-item>

<todo-item
  v-bind:text="todo.text"
  v-bind:is-complete="todo.isComplete"
></todo-item>
#+END_EXAMPLE

Literal vs Dynamic
#+BEGIN_EXAMPLE
<!-- this passes down a plain string "1" -->
<comp some-prop="1"></comp>

<!-- this passes down an actual number -->
<comp v-bind:some-prop="1"></comp>
#+END_EXAMPLE

**** Don't mutate a prop of child component
You shouldn't mutate a prop insde a child component. Refer to vue:data:mutation

Because objects and arrays in JavaScript are passed by reference. So mutating the object or array inside the child will affect parent state.

Instead you should do the following:
- Define a local data prop that uses the prop's initial value as its initial value
#+BEGIN_EXAMPLE
props: ['initialCounter'],
data: function () {
  return { counter: this.initialCounter }
}
#+END_EXAMPLE

- Define a computed prop that is computed from the prop's value
#+BEGIN_EXAMPLE
props: ['size'],
computed: {
  normalizedSize: function () {
    return this.size.trim().toLowerCase()
  }
}
#+END_EXAMPLE

**** prop validation
When prop validation fails, Vue will produce a console warning (if using the development build). Note that props are validated before a component instance is created, so within default or validator functions, instance properties such as from data, computed, or methods will not be available.

#+BEGIN_EXAMPLE
Vue.component('example', {
  props: {
    // basic type check (`null` means accept any type)
    propA: Number,

    // multiple possible types
    propB: [String, Number],

    // a required string
    propC: {
      type: String,
      required: true
    },

    // a number with default value
    propD: {
      type: Number,
      default: 100
    },

    // object/array defaults should be returned from a
    // factory function
    propE: {
      type: Object,
      default: function () {
        return { message: 'hello' }
      }
    },

    // custom validator function
    propF: {
      validator: function (value) {
        return value > 10
      }
    }
  }
})
#+END_EXAMPLE

***** type
type can be one of the following instructors
String
Number
Boolean
Function
Object
Array
Symbol

In addition, type can also be a custom constructor function and the assertion will be made with an instanceof check.

*** Events Up
vue:event:component

*** DOM template
In non-string templates, camelCased prop names need to use their kebab-case equivalents
Refer to see what vue:string template is.
#+BEGIN_EXAMPLE
Vue.component('child', {
  // camelCase in JavaScript
  props: ['myMessage'],
  template: '<span>{{ myMessage }}</span>'
})
<!-- kebab-case in HTML -->
<child my-message="hello!"></child>
#+END_EXAMPLE

*** Except class and style :: parent attributes overwrite child component
Child component bs-date-input has this template
<input type="date" class="form-control">

But the child component is called from parent with the type attribute as well.
#+BEGIN_EXAMPLE
<bs-date-input
  data-3d-date-picker="true"
  class="date-picker-theme-dark"
  type="large"
></bs-date-input>
#+END_EXAMPLE

The final result is type="large" because the value provided to the component will replace the value set by the component.

Except class and style attributes.

*** Slots
Parent content will be discarded unless the child component template contains at least one <slot> outlet.

**** Basics
my-component template:
#+BEGIN_EXAMPLE
<div>
  <h2>I'm the child title</h2>
  <slot>
    This will only be displayed if there is no content
    to be distributed.
  </slot>
</div>
#+END_EXAMPLE

the parent
#+BEGIN_EXAMPLE
<div>
  <h1>I'm the parent title</h1>
  <my-component>
    <p>This is some original content</p>
    <p>This is some more original content</p>
  </my-component>
</div>
#+END_EXAMPLE

Result
#+BEGIN_EXAMPLE
<div>
  <h1>I'm the parent title</h1>
  <div>
    <h2>I'm the child title</h2>
    <p>This is some original content</p>
    <p>This is some more original content</p>
  </div>
</div>
#+END_EXAMPLE

**** Multiple slots
app-layout component with template
#+BEGIN_EXAMPLE
<div class="container">
  <header>
    <slot name="header"></slot>
  </header>
  <main>
    <slot></slot>
  </main>
  <footer>
    <slot name="footer"></slot>
  </footer>
</div>
#+END_EXAMPLE

Parent
#+BEGIN_EXAMPLE
<app-layout>
  <h1 slot="header">Here might be a page title</h1>
  <p>A paragraph for the main content.</p>
  <p>And another one.</p>
  <p slot="footer">Here's some contact info</p>
</app-layout>
#+END_EXAMPLE

Result
#+BEGIN_EXAMPLE
<div class="container">
  <header>
    <h1>Here might be a page title</h1>
  </header>
  <main>
    <p>A paragraph for the main content.</p>
    <p>And another one.</p>
  </main>
  <footer>
    <p>Here's some contact info</p>
  </footer>
</div>
#+END_EXAMPLE

**** Scoped slot
From parent, create a temporary variable with an alias name which holds the props object passed from the child (props.text defined in child)

This provides a way for parent to customize the look of a component.

child component
#+BEGIN_EXAMPLE
<div class="child">
  <slot text="hello from child"></slot>
</div>
#+END_EXAMPLE

Parent
#+BEGIN_EXAMPLE
<div class="parent">
  <child>
    <template slot-scope="props">
      <span>hello from parent</span>
      <span>{{ props.text }}</span>
    </template>
  </child>
</div>
#+END_EXAMPLE

Result
#+BEGIN_EXAMPLE
<div class="parent">
  <div class="child">
    <span>hello from parent</span>
    <span>hello from child</span>
  </div>
</div>
#+END_EXAMPLE

In 2.5.0+, slot-scope is no longer limited to <template> and can be used on any element or component.

Number of slots in parent do not need to match number of slots in component.

Parent :: customize the look for each list item
#+BEGIN_EXAMPLE
<my-awesome-list :items="items">
  <!-- scoped slot can be named too -->
  <li
    slot="item"
    slot-scope="props"
    class="my-fancy-item">
    {{ props.text }}
  </li>
</my-awesome-list>
#+END_EXAMPLE

my-awesome-list component template
#+BEGIN_EXAMPLE
<ul>
  <slot name="item"
    v-for="item in items"
    :text="item.text">
    <!-- fallback content here -->
  </slot>
</ul>
#+END_EXAMPLE

**** Destructuring for slot-scope
#+BEGIN_EXAMPLE
<child>
  <span slot-scope="{ text }">{{ text }}</span>
</child>
#+END_EXAMPLE

*** Dynamic component, v-bind:is, <component>, <keep-alive>
#+BEGIN_EXAMPLE
var vm = new Vue({
  el: '#example',
  data: {
    currentView: 'home'
  },
  components: {
    home: { /* ... */ },
    posts: { /* ... */ },
    archive: { /* ... */ }
  }
})

<component v-bind:is="currentView">
  <!-- component changes when vm.currentView changes! -->
</component>
#+END_EXAMPLE

If <transition> is used, wrap <keep-alive> inside <transition>
#+BEGIN_EXAMPLE
<keep-alive>
  <component :is="currentView">
    <!-- inactive components will be cached! -->
  </component>
</keep-alive>
#+END_EXAMPLE

*** Get Child Component One Time
$refs are only populated after the component has been rendered and it is not reactive.
#+BEGIN_EXAMPLE
<div id="parent">
  <user-profile ref="profile"></user-profile>
</div>

var parent = new Vue({ el: '#parent' })
// access child component instance
var child = parent.$refs.profile
#+END_EXAMPLE

*** Async Components
Define component as a factory function that asynchronously resolves the component definition.
The factory function will only be triggered when the component actually needs to be rendered and will cache the result for future re-renders.

Usually, component is defined using a name and an object of props.

A factory function can be used:
#+BEGIN_EXAMPLE
Vue.component('async-example', function (resolve, reject) {
  setTimeout(function () {
    // Pass the component definition to the resolve callback
    resolve({
      template: '<div>I am async!</div>'
    })
  }, 1000)
})
#+END_EXAMPLE

Webpack example
#+BEGIN_EXAMPLE
Vue.component('async-webpack-example', function (resolve) {
  // This special require syntax will instruct Webpack to
  // automatically split your built code into bundles which
  // are loaded over Ajax requests.
  require(['./my-async-component'], resolve)
})
#+END_EXAMPLE

**** Component factory function can return a Promise 
(with Webpack)
#+BEGIN_EXAMPLE
Vue.component(
  'async-webpack-example',
  // The `import` function returns a `Promise`.
  () => import('./my-async-component')
)

new Vue({
  // ...
  components: {
    'my-component': () => import('./my-async-component')
  }
})
#+END_EXAMPLE

**** Component factory function can also return an object
#+BEGIN_EXAMPLE
const AsyncComp = () => ({
  // The component to load. Should be a Promise
  component: import('./MyComp.vue'),
  // A component to use while the async component is loading
  loading: LoadingComp,
  // A component to use if the load fails
  error: ErrorComp,
  // Delay before showing the loading component. Default: 200ms.
  delay: 200,
  // The error component will be displayed if a timeout is
  // provided and exceeded. Default: Infinity.
  timeout: 3000
})
#+END_EXAMPLE
Refer to vue:router

*** Recursive and Circular Reference
A component can recursively invoke itself in its own template

When a component is registered globally using Vue.component, the global ID is auto set as the component's name option
#+BEGIN_EXAMPLE
Vue.component('unique-name-of-my-component', {
  // ...
})

name: 'unique-name-of-my-component'
#+END_EXAMPLE

**** Recursive
#+BEGIN_EXAMPLE
name: 'stack-overflow',
template: '<div><stack-overflow></stack-overflow></div>
#+END_EXAMPLE

**** Circular reference
tree-folder component
#+BEGIN_EXAMPLE
<p>
  <span>{{ folder.name }}</span>
  <tree-folder-contents :children="folder.children"/>
</p>
#+END_EXAMPLE

tree-folder-contents component
#+BEGIN_EXAMPLE
<ul>
  <li v-for="child in children">
    <tree-folder v-if="child.children" :folder="child"/>
    <span v-else>{{ child.name }}</span>
  </li>
</ul>
#+END_EXAMPLE

tree-folder needs tree-folder-contents and tree-folder-contents needs tree-folder.

It's ok if no module system is used to import components (Webpack or Browserify).

You should do this
#+BEGIN_EXAMPLE
beforeCreate: function () {
  this.$options.components.TreeFolderContents = require('./tree-folder-contents.vue')
}
#+END_EXAMPLE

*** inline-template
It makes the inner content as the component's template. Don't use it.
#+BEGIN_EXAMPLE
<my-component inline-template>
  <div>
    <p>These are compiled as the component's own template.</p>
    <p>Not parent's transclusion content.</p>
  </div>
</my-component>
#+END_EXAMPLE

*** X-Templates
Don't use.
#+BEGIN_EXAMPLE
<script type="text/x-template" id="hello-world-template">
  <p>Hello hello hello</p>
</script>
Vue.component('hello-world', {
  template: '#hello-world-template'
})
#+END_EXAMPLE

** Template Syntax
*** String template vs DOM template
String template <<<vue:string template>>>
#+BEGIN_EXAMPLE
Vue.component('my-component', {
  template: '<p>This is a String template, it iss passed as a string to the component.</p>'
})
#+END_EXAMPLE

DOM template
#+BEGIN_EXAMPLE
<body>
  <div id="app"> <!-- your App is runnning in this div --->
    <my-component></my-component>
  </div>

  <template id="template-for-my-component">
    {{ message }}
  </template>
</body>
#+END_EXAMPLE

*** v-once on text or element
one-time interpolations and remain cached
#+BEGIN_EXAMPLE
<span v-once>This will never change: {{ msg }}</span>

Vue.component('terms-of-service', {
  template: '\
    <div v-once>\
      <h1>Terms of Service</h1>\
      ... a lot of static content ...\
    </div>\
  '
})
#+END_EXAMPLE

*** v-html
<div v-html="rawHtml"></div>
Can't be used for components. Watch out for XSS

*** v-bind:attributeName, :attributeName
<button v-bind:disabled="isButtonDisabled">Button</button>
<button :disabled="isButtonDisabled">Button</button>

*** Expression
One single expression and it has a whitelist. Don't access user defined globals in template expressions.

#+BEGIN_EXAMPLE
{{ number + 1 }}
{{ ok ? 'YES' : 'NO' }}
{{ message.split('').reverse().join('') }}
<div v-bind:id="'list-' + id"></div>
#+END_EXAMPLE

*** Arguments :: v-bind:href, v-bind:class, v-on:click
**** v-bind:href, v-on:click
#+BEGIN_EXAMPLE
<a v-bind:href="url"> ... </a>
// bind element's href attribute to the value of the expression url
<a v-on:click="doSomething"> ... </a>
// shorthand
<a @click="doSomething">...</a>
#+END_EXAMPLE

**** v-bind:class

#+BEGIN_EXAMPLE
<div class="static"
     v-bind:class="{ active: isActive, 'text-danger': hasError }">
</div>
// <div class="static active"></div>
data: {
  isActive: true,
  hasError: false
}
#+END_EXAMPLE

Or 

#+BEGIN_EXAMPLE
<div v-bind:class="classObject"></div>

data: {
  classObject: {
    active: true,
    'text-danger': false
  }
}

// or even
data: {
  isActive: true,
  error: null
},
computed: {
  classObject: function () {
    return {
      active: this.isActive && !this.error,
      'text-danger': this.error && this.error.type === 'fatal'
    }
  }
}
#+END_EXAMPLE

Array
#+BEGIN_EXAMPLE
<div v-bind:class="[activeClass, errorClass]"></div>
data: {
  activeClass: 'active',
  errorClass: 'text-danger'
}

<div v-bind:class="[isActive ? activeClass : '', errorClass]"></div>
<div v-bind:class="[{ active: isActive }, errorClass]"></div>
#+END_EXAMPLE

When you use the class attribute on a custom component, those classes will be added to the component’s root element. Existing classes on this element will not be overwritten.

#+BEGIN_EXAMPLE
Vue.component('my-component', {
  template: '<p class="foo bar">Hi</p>'
})

<my-component class="baz boo"></my-component>

// the rendered HTML will be:
// <p class="foo bar baz boo">Hi</p>
// the same is also true for class bindings

<my-component v-bind:class="{ active: isActive }"></my-component>

// <p class="foo bar active">Hi</p>
#+END_EXAMPLE

**** v-bind:style
CSS vendor-prefixes are auto detected and added when v-bind:style is used
Use either camelCase or kebab-case for CSS property name
#+BEGIN_EXAMPLE
<div v-bind:style="{ color: activeColor, fontSize: fontSize + 'px' }"></div>
// kebob case
// <div v-bind:style="{ color: activeColor, 'font-size': fontSize + 'px' }"></div>

data: {
  activeColor: 'red',
  fontSize: 30
}

<div v-bind:style="styleObject"></div>
data: {
  styleObject: {
    color: 'red',
    fontSize: '13px'
  }
}
#+END_EXAMPLE

Array
#+BEGIN_EXAMPLE
<div v-bind:style="[baseStyles, overridingStyles]"></div>
#+END_EXAMPLE

You don't need to do this but since 2.3.0+
#+BEGIN_EXAMPLE
<div v-bind:style="{ display: ['-webkit-box', '-ms-flexbox', 'flex'] }"></div>
#+END_EXAMPLE
This will only render the last value in the array which the browser supports.

*** Modifiers :: v-on:submit.prevent
Refer to vue:event:modifiers
#+BEGIN_EXAMPLE
<form v-on:submit.prevent="onSubmit"> ... </form>
#+END_EXAMPLE

*** v-if, key attribute, v-show
When used together with v-if, v-for has a higher priority than v-if.

#+BEGIN_EXAMPLE
<h1 v-if="ok">Yes</h1>
<h1 v-else>No</h1>
#+END_EXAMPLE

Group with v-if on <template>. template element will not be included
#+BEGIN_EXAMPLE
<template v-if="ok">
  <h1>Title</h1>
  <p>Paragraph 1</p>
  <p>Paragraph 2</p>
</template>
#+END_EXAMPLE

v-else must immediately follow a v-if or v-else-if element.
#+BEGIN_EXAMPLE
<div v-if="Math.random() > 0.5">
  Now you see me
</div>
<div v-else>
  Now you don't
</div>
#+END_EXAMPLE

v-else-if since 2.1.0+
#+BEGIN_EXAMPLE
<div v-if="type === 'A'">
  A
</div>
<div v-else-if="type === 'B'">
  B
</div>
<div v-else-if="type === 'C'">
  C
</div>
<div v-else>
  Not A/B/C
</div>
#+END_EXAMPLE

key attribute marks an element unique which means elements shouldn't be reused unless it has the same key
#+BEGIN_EXAMPLE
<template v-if="loginType === 'username'">
  <label>Username</label>
  <input placeholder="Enter your username" key="username-input">
</template>
<template v-else>
  <label>Email</label>
  <input placeholder="Enter your email address" key="email-input">
</template>
#+END_EXAMPLE

v-show toggles the element’s display CSS property based on the truthy-ness of the expression value.

v-show doesn’t support the <template> element, nor does it work with v-else.

v-if vs v-show
It's expensive to toggle v-if, so use it when the condition is unlikely to change over time.

v-if is lazy means if it's false on initial render, it will not do anything, the conditional block won't be rendered until the condition becomes true for the first time.

v-show always render.

Use v-show if it needs to be toggled very often.

*** List, v-for
**** Basics
v-for has full access to parent scope properties

#+BEGIN_EXAMPLE
// array
<ul id="example-1">
  <li v-for="item in items">
    {{ item.message }}
  </li>
</ul>
var example1 = new Vue({
  el: '#example-1',
  data: {
    items: [
      { message: 'Foo' },
      { message: 'Bar' }
    ]
  }
})

<ul id="example-2">
  <li v-for="(item, index) in items">
    {{ parentMessage }} - {{ index }} - {{ item.message }}
  </li>
</ul>

var example2 = new Vue({
  el: '#example-2',
  data: {
    parentMessage: 'Parent',
    items: [
      { message: 'Foo' },
      { message: 'Bar' }
    ]
  }
})

<div v-for="item of items"></div>

// object
<ul id="v-for-object" class="demo">
  <li v-for="value in object">
    {{ value }}
  </li>
</ul>

new Vue({
  el: '#v-for-object',
  data: {
    object: {
      firstName: 'John',
      lastName: 'Doe',
      age: 30
    }
  }
})

<div v-for="(value, key) in object">
  {{ key }}: {{ value }}
</div>

<div v-for="(value, key, index) in object">
  {{ index }}. {{ key }}: {{ value }}
</div>
#+END_EXAMPLE

The default mode is only suitable when your list render output does not reply on child component state or temporary DOM state (e.g. form input values)

Provide a unqiue key attribute for each item.
#+BEGIN_EXAMPLE
<div v-for="item in items" :key="item.id">
  <!-- content -->
</div>
#+END_EXAMPLE

Refer to vue:data for mutation and non-mutating methods

**** Filtered/Sorted
#+BEGIN_EXAMPLE
<li v-for="n in evenNumbers">{{ n }}</li>

data: {
  numbers: [ 1, 2, 3, 4, 5 ]
},
computed: {
  evenNumbers: function () {
    return this.numbers.filter(function (number) {
      return number % 2 === 0
    })
  }
}
#+END_EXAMPLE

In case when computed properties are not feasible e.g. inside nested v-for loops
#+BEGIN_EXAMPLE
<li v-for="n in even(numbers)">{{ n }}</li>
data: {
  numbers: [ 1, 2, 3, 4, 5 ]
},
methods: {
  even: function (numbers) {
    return numbers.filter(function (number) {
      return number % 2 === 0
    })
  }
}
#+END_EXAMPLE

**** range
#+BEGIN_EXAMPLE
<div>
  <span v-for="n in 10">{{ n }} </span>
</div>
#+END_EXAMPLE

**** v-for on <template>
#+BEGIN_EXAMPLE
<ul>
  <template v-for="item in items">
    <li>{{ item.msg }}</li>
    <li class="divider"></li>
  </template>
</ul>
#+END_EXAMPLE

**** v-for with v-if
#+BEGIN_EXAMPLE
<li v-for="todo in todos" v-if="!todo.isComplete">
  {{ todo }}
</li>

// don't execute v-for at all
<ul v-if="todos.length">
  <li v-for="todo in todos">
    {{ todo }}
  </li>
</ul>
<p v-else>No todos left!</p>
#+END_EXAMPLE

**** v-for with a component
#+BEGIN_EXAMPLE
<my-component v-for="item in items" :key="item.id"></my-component>

// pass data to component
<my-component
  v-for="(item, index) in items"
  v-bind:item="item"
  v-bind:index="index"
  v-bind:key="item.id"
></my-component>
#+END_EXAMPLE

**** Example

Because it has to be at least one <li> in <ul> to be valid. ~is="todo-item"~ is needed.
#+BEGIN_EXAMPLE
<div id="todo-list-example">
  <input
    v-model="newTodoText"
    v-on:keyup.enter="addNewTodo"
    placeholder="Add a todo"
  >
  <ul>
    <li
      is="todo-item"
      v-for="(todo, index) in todos"
      v-bind:key="todo.id"
      v-bind:title="todo.title"
      v-on:remove="todos.splice(index, 1)"
    ></li>
  </ul>
</div>

Vue.component('todo-item', {
  template: '\
    <li>\
      {{ title }}\
      <button v-on:click="$emit(\'remove\')">X</button>\
    </li>\
  ',
  props: ['title']
})
new Vue({
  el: '#todo-list-example',
  data: {
    newTodoText: '',
    todos: [
      {
        id: 1,
        title: 'Do the dishes',
      },
      {
        id: 2,
        title: 'Take out the trash',
      },
      {
        id: 3,
        title: 'Mow the lawn'
      }
    ],
    nextTodoId: 4
  },
  methods: {
    addNewTodo: function () {
      this.todos.push({
        id: this.nextTodoId++,
        title: this.newTodoText
      })
      this.newTodoText = ''
    }
  }
})
#+END_EXAMPLE

*** Event, v-on, @attributeName
**** Basics
#+BEGIN_EXAMPLE
<div id="example-1">
  <button v-on:click="counter += 1">Add 1</button>
  <p>The button above has been clicked {{ counter }} times.</p>
</div>
var example1 = new Vue({
  el: '#example-1',
  data: {
    counter: 0
  }
})
#+END_EXAMPLE

**** Method calling
#+BEGIN_EXAMPLE
<div id="example-2">
  <!-- `greet` is the name of a method defined below -->
  <button v-on:click="greet">Greet</button>
</div>
var example2 = new Vue({
  el: '#example-2',
  data: {
    name: 'Vue.js'
  },
  // define methods under the `methods` object
  methods: {
    greet: function (event) {
      // `this` inside methods points to the Vue instance
      alert('Hello ' + this.name + '!')
      // `event` is the native DOM event
      if (event) {
        alert(event.target.tagName)
      }
    }
  }
})
// you can invoke methods in JavaScript too
example2.greet() // => 'Hello Vue.js!'
#+END_EXAMPLE

**** Inline with $event
#+BEGIN_EXAMPLE
<div id="example-3">
  <button v-on:click="say('hi')">Say hi</button>
  <button v-on:click="say('what')">Say what</button>
</div>
new Vue({
  el: '#example-3',
  methods: {
    say: function (message) {
      alert(message)
    }
  }
})

<button v-on:click="warn('Form cannot be submitted yet.', $event)">
  Submit
</button>
methods: {
  warn: function (message, event) {
    // now we have access to the native event
    if (event) event.preventDefault()
    alert(message)
  }
}
#+END_EXAMPLE

**** Event Modifiers
<<<vue:event:modifiers>>>

.stop, .prevent, .capture, .self, .once

#+BEGIN_EXAMPLE
<!-- the click event's propagation will be stopped -->
<a v-on:click.stop="doThis"></a>

<!-- the submit event will no longer reload the page -->
<form v-on:submit.prevent="onSubmit"></form>

<!-- modifiers can be chained :: chain stop and prevent. -->
<a v-on:click.stop.prevent="doThat"></a>

<!-- chain order matters. @click.prevent.self will prevent all clicks while @click.self.prevent will only prevent clicks on the element itself -->

<!-- just the modifier -->
<form v-on:submit.prevent></form>

<!-- use capture mode when adding the event listener -->
<!-- i.e. an event targeting an inner element is handled here before being handled by that element -->
<div v-on:click.capture="doThis">...</div>

<!-- only trigger handler if event.target is the element itself -->
<!-- i.e. not from a child element -->
<div v-on:click.self="doThat">...</div>

<!-- the click event will be triggered at most once. 2.1.4+ -->
<a v-on:click.once="doThis"></a>
#+END_EXAMPLE

**** Event Key Modifiers
<<<vue:event:key modifiers>>>

#+BEGIN_EXAMPLE
<!-- only call vm.submit() when the keyCode is 13 -->
<input v-on:keyup.13="submit">

<!-- also works for shorthand -->
<input @keyup.enter="submit">
#+END_EXAMPLE

Full list :: .enter, .tab, .delete (both Delete and Backspace), .esc, .space, .up, .down, .left, .right

Define custom key modifier aliase
#+BEGIN_EXAMPLE
// enable v-on:keyup.f1
Vue.config.keyCodes.f1 = 112
#+END_EXAMPLE

Directly use any valid key names provided by [[https://developer.mozilla.org/en-US/docs/Web/API/KeyboardEvent/key/Key_Values][KeyboardEvent.key]] as modifiers by converting them to kebab-case.
e.g. the handler will only be called if $event.key === 'PageDown'.
#+BEGIN_EXAMPLE
<input @keyup.page-down="onPageDown">
#+END_EXAMPLE

.ctrl, .alt, .shift, .meta (windows key or Mac's command key)
#+BEGIN_EXAMPLE
<!-- Alt + C -->
<input @keyup.alt.67="clear">

<!-- Ctrl + Click -->
<div @click.ctrl="doSomething">Do something</div>
#+END_EXAMPLE

.exact
#+BEGIN_EXAMPLE
<!-- this will fire even if Alt or Shift is also pressed -->
<button @click.ctrl="onClick">A</button>

<!-- this will only fire when only Ctrl is pressed -->
<button @click.ctrl.exact="onCtrlClick">A</button>
#+END_EXAMPLE

.left, .right, .middle

**** Event from child component. .sync
<<<vue:event:component>>>

#+BEGIN_EXAMPLE
<div id="counter-event-example">
  <p>{{ total }}</p>
  <button-counter v-on:increment="incrementTotal"></button-counter>
  <button-counter v-on:increment="incrementTotal"></button-counter>
</div>

Vue.component('button-counter', {
  template: '<button v-on:click="incrementCounter">{{ counter }}</button>',
  data: function () {
    return {
      counter: 0
    }
  },
  methods: {
    incrementCounter: function () {
      this.counter += 1
      this.$emit('increment')
    }
  },
})
new Vue({
  el: '#counter-event-example',
  data: {
    total: 0
  },
  methods: {
    incrementTotal: function () {
      this.total += 1
    }
  }
})
#+END_EXAMPLE

vm.$on can only listen events on teh current vm. But in order to listen from child components, you will need v-on in parent template
#+BEGIN_EXAMPLE
vm.$on('test', function (msg) {
  console.log(msg)
})
vm.$emit('test', 'hi')
// => "hi"
#+END_EXAMPLE

In parent, when adding a native even (e.g. click) on a component, @click.native="parentMethod" is required.

.sync
By default one-way data flow from parent to child. There's time when modifying parent prop is desired. But try to avoid this.
#+BEGIN_EXAMPLE
<comp :foo.sync="bar"></comp>

// got expanded to

<comp :foo="bar" @update:foo="val => bar = val"></comp>

// For the child component to update foo‘s value, it needs to explicitly emit an event instead of mutating the prop:

this.$emit('update:foo', newValue)
#+END_EXAMPLE

**** Event in Form, v-model
<<<vue:event:v-model>>>

#+BEGIN_EXAMPLE
<input v-model="something">
// is equivalent of
<input
  v-bind:value="something"
  v-on:input="something = $event.target.value">

// For a component
<custom-input
  :value="something"
  @input="value => { something = value }">
</custom-input>
#+END_EXAMPLE

Custom form input
The key point is the component has to have props: ['value'] and emit an input event with the new value

***** text
#+BEGIN_EXAMPLE
<script src="https://cdn.rawgit.com/chrisvfritz/5f0a639590d6e648933416f90ba7ae4e/raw/974aa47f8f9c5361c5233bd56be37db8ed765a09/currency-validator.js"></script>
<div id="app">
  <currency-input 
    label="Price" 
    v-model="price"
  ></currency-input>
  <currency-input 
    label="Shipping" 
    v-model="shipping"
  ></currency-input>
  <currency-input 
    label="Handling" 
    v-model="handling"
  ></currency-input>
  <currency-input 
    label="Discount" 
    v-model="discount"
  ></currency-input>
  
  <p>Total: ${{ total }}</p>
</div>

Vue.component('currency-input', {
  template: '\
    <div>\
      <label v-if="label">{{ label }}</label>\
      $\
      <input\
        ref="input"\
        v-bind:value="value"\
        v-on:input="updateValue($event.target.value)"\
        v-on:focus="selectAll"\
        v-on:blur="formatValue"\
      >\
    </div>\
  ',
  props: {
    value: {
      type: Number,
      default: 0
    },
    label: {
      type: String,
      default: ''
    }
  },
  mounted: function () {
    this.formatValue()
  },
  methods: {
    updateValue: function (value) {
      var result = currencyValidator.parse(value, this.value)
      if (result.warning) {
        this.$refs.input.value = result.value
      }
      this.$emit('input', result.value)
    },
    formatValue: function () {
      this.$refs.input.value = currencyValidator.format(this.value)
    },
    selectAll: function (event) {
      // Workaround for Safari bug
      // http://stackoverflow.com/questions/1269722/selecting-text-on-focus-using-jquery-not-working-in-safari-and-chrome
      setTimeout(function () {
      	event.target.select()
      }, 0)
    }
  }
})

new Vue({
  el: '#app',
  data: {
    price: 0,
    shipping: 0,
    handling: 0,
    discount: 0
  },
  computed: {
    total: function () {
      return ((
        this.price * 100 + 
        this.shipping * 100 + 
        this.handling * 100 - 
        this.discount * 100
      ) / 100).toFixed(2)
    }
  }
})
#+END_EXAMPLE

***** checkbox
By default, v-model on a component uses value as the prop and input as the event, but some input types such as checkboxes and radio buttons may want to use the value prop for a different purpose. Using the model option can avoid the conflict in such cases
#+BEGIN_EXAMPLE
Vue.component('my-checkbox', {
  model: {
    prop: 'checked',
    event: 'change'
  },
  props: {
    checked: Boolean,
    // this allows using the `value` prop for a different purpose
    value: String
  },
  // ...
})

<my-checkbox v-model="foo" value="some value"></my-checkbox>

// is equivalent to
<my-checkbox
  :checked="foo"
  @change="val => { foo = val }"
  value="some value">
</my-checkbox>
#+END_EXAMPLE

**** Use Event to transfer data between components that are not parent-child
#+BEGIN_EXAMPLE
var bus = new Vue()
bus.$emit('id-selected', 1)
// in component B's created hook
bus.$on('id-selected', function (id) {
  // ...
})
#+END_EXAMPLE

If it's more complex, refer to vue:state management

*** Form input, v-model
v-model will ignore the initial value, checked or selected.

**** textarea
#+BEGIN_EXAMPLE
<span>Multiline message is:</span>
<p style="white-space: pre-line;">{{ message }}</p>  <br>
<textarea v-model="message" placeholder="add multiple lines"></textarea>
#+END_EXAMPLE

**** checkbox
#+BEGIN_EXAMPLE
<input type="checkbox" id="checkbox" v-model="checked">
<label for="checkbox">{{ checked }}</label>

<!-- `toggle` is either true or false -->
<input type="checkbox" v-model="toggle">

// multiple checkboxes

<div id='example-3'>
  <input type="checkbox" id="jack" value="Jack" v-model="checkedNames">
  <label for="jack">Jack</label>
  <input type="checkbox" id="john" value="John" v-model="checkedNames">
  <label for="john">John</label>
  <input type="checkbox" id="mike" value="Mike" v-model="checkedNames">
  <label for="mike">Mike</label>
  <br>
  <span>Checked names: {{ checkedNames }}</span>
</div>

new Vue({
  el: '#example-3',
  data: {
    checkedNames: []
  }
})


#+END_EXAMPLE

**** radio
#+BEGIN_EXAMPLE
<input type="radio" id="one" value="One" v-model="picked">
<label for="one">One</label>
<br>
<input type="radio" id="two" value="Two" v-model="picked">
<label for="two">Two</label>
<br>
<span>Picked: {{ picked }}</span>

<!-- `picked` is a string "a" when checked -->
<input type="radio" v-model="picked" value="a">
#+END_EXAMPLE

**** select
#+BEGIN_EXAMPLE
<select v-model="selected">
  <option disabled value="">Please select one</option>
  <option>A</option>
  <option>B</option>
  <option>C</option>
</select>
<span>Selected: {{ selected }}</span>

new Vue({
  el: '...',
  data: {
    selected: ''
  }
})

<!-- `selected` is a string "abc" when selected -->
<select v-model="selected">
  <option value="abc">ABC</option>
</select>

// select multiple
<select v-model="selected" multiple>
  <option>A</option>
  <option>B</option>
  <option>C</option>
</select>
<br>
<span>Selected: {{ selected }}</span>

// select v-for
<select v-model="selected">
  <option v-for="option in options" v-bind:value="option.value">
    {{ option.text }}
  </option>
</select>
<span>Selected: {{ selected }}</span>

new Vue({
  el: '...',
  data: {
    selected: 'A',
    options: [
      { text: 'One', value: 'A' },
      { text: 'Two', value: 'B' },
      { text: 'Three', value: 'C' }
    ]
  }
})
#+END_EXAMPLE

**** Use v-bind with v-model to prepopulate
#+BEGIN_EXAMPLE
<input
  type="checkbox"
  v-model="toggle"
  v-bind:true-value="a"
  v-bind:false-value="b"
>

// when checked:
vm.toggle === vm.a
// when unchecked:
vm.toggle === vm.b

<input type="radio" v-model="pick" v-bind:value="a">
// when checked:
vm.pick === vm.a

<select v-model="selected">
  <!-- inline object literal -->
  <option v-bind:value="{ number: 123 }">123</option>
</select>
#+END_EXAMPLE

**** v-model modifiers
#+BEGIN_EXAMPLE
.lazy
<!-- synced after "change" instead of "input" -->
<input v-model.lazy="msg" >

.number :: typecast as a number
<input v-model.number="age" type="number">

.trim
<input v-model.trim="msg">
#+END_EXAMPLE

**** Event in v-model
vue:event:v-model

** Computed Property, Watchers
*** Computed property
#+BEGIN_EXAMPLE
<div id="example">
  <p>Original message: "{{ message }}"</p>
  <p>Computed reversed message: "{{ reversedMessage }}"</p>
  <!-- same as 
  <p>Reversed message: "{{ reverseMessage()  }}"</p>
  -->
</div>

var vm = new Vue({
  el: '#example',
  data: {
    message: 'Hello'
  },
  computed: {
    // a computed getter
    reversedMessage: function () {
      // `this` points to the vm instance
      return this.message.split('').reverse().join('')
    }
  }
  /* same as method
  methods: {
    reverseMessage: function () {
      return this.message.split('').reverse().join('')
    }
  }
  */
})
#+END_EXAMPLE

The computed property is cached until vm.$data.message is not changed. While method will run every time the view updates (re-render).

Hence, never define computed property without vm.$data e.g.
#+BEGIN_EXAMPLE
computed: {
  now: function () {
    return Date.now()
  }
}
#+END_EXAMPLE

vm.watch is to watch a property vm.data.propA change.

Try to avoid using watch too much, use computed property instead

Instead of
#+BEGIN_EXAMPLE
var vm = new Vue({
  el: '#demo',
  data: {
    firstName: 'Foo',
    lastName: 'Bar',
    fullName: 'Foo Bar'
  },
  watch: {
    firstName: function (newval, oldval) {
      this.fullName = newval + ' ' + this.lastName
    },
    lastName: function (newval, oldval) {
      this.fullName = this.firstName + ' ' + newval
    }
  }
})
#+END_EXAMPLE

Use
#+BEGIN_EXAMPLE
var vm = new Vue({
  el: '#demo',
  data: {
    firstName: 'Foo',
    lastName: 'Bar'
  },
  computed: {
    fullName: function () {
      return this.firstName + ' ' + this.lastName
    }
  }
})
#+END_EXAMPLE

Computed setter
#+BEGIN_EXAMPLE
computed: {
  fullName: {
    // getter
    get: function () {
      return this.firstName + ' ' + this.lastName
    },
    // setter
    set: function (newValue) {
      var names = newValue.split(' ')
      this.firstName = names[0]
      this.lastName = names[names.length - 1]
    }
  }
}
#+END_EXAMPLE

*** Watchers
#+BEGIN_EXAMPLE
<div id="watch-example">
  <p>
    Ask a yes/no question:
    <input v-model="question">
  </p>
  <p>{{ answer }}</p>
</div>

<!-- Since there is already a rich ecosystem of ajax libraries    -->
<!-- and collections of general-purpose utility methods, Vue core -->
<!-- is able to remain small by not reinventing them. This also   -->
<!-- gives you the freedom to use what you're familiar with. -->
<script src="https://cdn.jsdelivr.net/npm/axios@0.12.0/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lodash@4.13.1/lodash.min.js"></script>
<script>
var watchExampleVM = new Vue({
  el: '#watch-example',
  data: {
    question: '',
    answer: 'I cannot give you an answer until you ask a question!'
  },
  watch: {
    // whenever question changes, this function will run
    question: function (newQuestion) {
      this.answer = 'Waiting for you to stop typing...'
      this.getAnswer()
    }
  },
  methods: {
    // _.debounce is a function provided by lodash to limit how
    // often a particularly expensive operation can be run.
    // In this case, we want to limit how often we access
    // yesno.wtf/api, waiting until the user has completely
    // finished typing before making the ajax request. To learn
    // more about the _.debounce function (and its cousin
    // _.throttle), visit: https://lodash.com/docs#debounce
    getAnswer: _.debounce(
      function () {
        if (this.question.indexOf('?') === -1) {
          this.answer = 'Questions usually contain a question mark. ;-)'
          return
        }
        this.answer = 'Thinking...'
        var vm = this
        axios.get('https://yesno.wtf/api')
          .then(function (response) {
            vm.answer = _.capitalize(response.data.answer)
          })
          .catch(function (error) {
            vm.answer = 'Error! Could not reach the API. ' + error
          })
      },
      // This is the number of milliseconds we wait for the
      // user to stop typing.
      500
    )
  }
})
</script>
#+END_EXAMPLE

** Transition & Animation
*** <transition> wrapper component
Wrap v-if, v-show, dynamic components and component root nodes

**** CSS Transition
#+BEGIN_EXAMPLE
<div id="demo">
  <button v-on:click="show = !show">
    Toggle
  </button>
  <transition name="fade">
    <p v-if="show">hello</p>
  </transition>
</div>
new Vue({
  el: '#demo',
  data: {
    show: true
  }
})
.fade-enter-active, .fade-leave-active {
  transition: opacity .5s
}
.fade-enter, .fade-leave-to /* .fade-leave-active below version 2.1.8 */ {
  opacity: 0
}

// more examples using pure css
/* Enter and leave animations can use different */
/* durations and timing functions.              */
.slide-fade-enter-active {
  transition: all .3s ease;
}
.slide-fade-leave-active {
  transition: all .8s cubic-bezier(1.0, 0.5, 0.8, 1.0);
}
.slide-fade-enter, .slide-fade-leave-to
/* .slide-fade-leave-active below version 2.1.8 */ {
  transform: translateX(10px);
  opacity: 0;
}
#+END_EXAMPLE

Classes
*-enter :: before element inserted > one frame after element is inserted
*-enter-active :: before element is inserted > removed when transition/animation finishes. Use it to define during, delay and easing curve for the entering transition.
*-enter-to : one frame after element is inserted > transition/animation finishes.
*-leave :: leave transition is triggered > after one frame
*-leave-active :: leave transition is triggered > transition/animation finishes. Use it to define duration, delay and easing curve for the leaving transition.
*-leave-to :: one frame after a leave transition is triggered > transition/animation finishes.

*-enter is enter start, *-enter-to is enter end
*-leave is leave start, *-leave-to is leave end

v- prefix is used when <transition> has no name
 
**** CSS Animations
#+BEGIN_EXAMPLE
<div id="example-2">
  <button @click="show = !show">Toggle show</button>
  <transition name="bounce">
    <p v-if="show">Look at me!</p>
  </transition>
</div>

new Vue({
  el: '#example-2',
  data: {
    show: true
  }
})

.bounce-enter-active {
  animation: bounce-in .5s;
}
.bounce-leave-active {
  animation: bounce-in .5s reverse;
}
@keyframes bounce-in {
  0% {
    transform: scale(0);
  }
  50% {
    transform: scale(1.5);
  }
  100% {
    transform: scale(1);
  }
}
#+END_EXAMPLE

**** Custom Transition Class
Override the default class names such as Animate.css
#+BEGIN_EXAMPLE
<link href="https://cdn.jsdelivr.net/npm/animate.css@3.5.1" rel="stylesheet" type="text/css">
<div id="example-3">
  <button @click="show = !show">
    Toggle render
  </button>
  <transition
    name="custom-classes-transition"
    enter-active-class="animated tada"
    leave-active-class="animated bounceOutRight"
  >
    <p v-if="show">hello</p>
  </transition>
</div>
#+END_EXAMPLE

**** prop
#+BEGIN_EXAMPLE
<transition :duration="1000">...</transition>
<transition :duration="{ enter: 500, leave: 800 }">...</transition>
#+END_EXAMPLE

**** event hooks
When using JavaScript-only transitions, the done callbacks are required for the enter and leave hooks.

***** events
#+BEGIN_EXAMPLE
<transition
  v-on:before-enter="beforeEnter"
  v-on:enter="enter"
  v-on:after-enter="afterEnter"
  v-on:enter-cancelled="enterCancelled"
  v-on:before-leave="beforeLeave"
  v-on:leave="leave"
  v-on:after-leave="afterLeave"
  v-on:leave-cancelled="leaveCancelled"
>
  <!-- ... -->
</transition>
#+END_EXAMPLE

***** methods
#+BEGIN_EXAMPLE
// ...
methods: {
  // --------
  // ENTERING
  // --------
  beforeEnter: function (el) {
    // ...
  },
  // the done callback is optional when
  // used in combination with CSS
  enter: function (el, done) {
    // ...
    done()
  },
  afterEnter: function (el) {
    // ...
  },
  enterCancelled: function (el) {
    // ...
  },
  // --------
  // LEAVING
  // --------
  beforeLeave: function (el) {
    // ...
  },
  // the done callback is optional when
  // used in combination with CSS
  leave: function (el, done) {
    // ...
    done()
  },
  afterLeave: function (el) {
    // ...
  },
  // leaveCancelled only available with v-show
  leaveCancelled: function (el) {
    // ...
  }
}
#+END_EXAMPLE

When javascript-only transistions, better to add v-bind:css="false"

***** Example using Velocity.js
#+BEGIN_EXAMPLE
<!--
Velocity works very much like jQuery.animate and is
a great option for JavaScript animations
-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.2.3/velocity.min.js"></script>
<div id="example-4">
  <button @click="show = !show">
    Toggle
  </button>
  <transition
    v-on:before-enter="beforeEnter"
    v-on:enter="enter"
    v-on:leave="leave"
    v-bind:css="false"
  >
    <p v-if="show">
      Demo
    </p>
  </transition>
</div>

new Vue({
  el: '#example-4',
  data: {
    show: false
  },
  methods: {
    beforeEnter: function (el) {
      el.style.opacity = 0
    },
    enter: function (el, done) {
      Velocity(el, { opacity: 1, fontSize: '1.4em' }, { duration: 300 })
      Velocity(el, { fontSize: '1em' }, { complete: done })
    },
    leave: function (el, done) {
      Velocity(el, { translateX: '15px', rotateZ: '50deg' }, { duration: 600 })
      Velocity(el, { rotateZ: '100deg' }, { loop: 2 })
      Velocity(el, {
        rotateZ: '45deg',
        translateY: '30px',
        translateX: '30px',
        opacity: 0
      }, { complete: done })
    }
  }
})
#+END_EXAMPLE

**** Transition on Initial Render
Use appear attribute
#+BEGIN_EXAMPLE
// default only uses enter and leave
<transition appear>
  <!-- ... -->
</transition>

// specify more or custom CSS classes
<transition
  appear
  appear-class="custom-appear-class"
  appear-to-class="custom-appear-to-class" (2.1.8+)
  appear-active-class="custom-appear-active-class"
>
  <!-- ... -->
</transition>

// and custom javascript hooks
<transition
  appear
  v-on:before-appear="customBeforeAppearHook"
  v-on:appear="customAppearHook"
  v-on:after-appear="customAfterAppearHook"
  v-on:appear-cancelled="customAppearCancelledHook"
>
  <!-- ... -->
</transition>
#+END_EXAMPLE

**** Transition between elements
#+BEGIN_EXAMPLE
<transition>
  <button v-if="docState === 'saved'" key="saved">
    Edit
  </button>
  <button v-if="docState === 'edited'" key="edited">
    Save
  </button>
  <button v-if="docState === 'editing'" key="editing">
    Cancel
  </button>
</transition>

// It's equivalent to
<transition>
  <button v-bind:key="docState">
    {{ buttonMessage }}
  </button>
</transition>

// ...
computed: {
  buttonMessage: function () {
    switch (this.docState) {
      case 'saved': return 'Edit'
      case 'edited': return 'Save'
      case 'editing': return 'Cancel'
    }
  }
}
#+END_EXAMPLE

**** Transition modes
Default behavior is entering and leaving happens simultaneously.
#+BEGIN_EXAMPLE
<transition name="fade" mode="out-in">
  <!-- ... the buttons ... -->
</transition>
#+END_EXAMPLE

in-out :: new element transitions in first then when complete, the current element transitions out.
out-in :: current element transitions out first then when complete, the new element transitions in.

**** Transition between dynamic components
key attribute is not required
#+BEGIN_EXAMPLE
<transition name="component-fade" mode="out-in">
  <component v-bind:is="view"></component>
</transition>

new Vue({
  el: '#transition-components-demo',
  data: {
    view: 'v-a'
  },
  components: {
    'v-a': {
      template: '<div>Component A</div>'
    },
    'v-b': {
      template: '<div>Component B</div>'
    }
  }
})
#+END_EXAMPLE

*** List transition <transition-group>
Default is to turn the <transition-group> to <span>, change it to p in tag attribute. 
key attribute is required.

**** Animate entering and leaving
#+BEGIN_EXAMPLE
<div id="list-demo">
  <button v-on:click="add">Add</button>
  <button v-on:click="remove">Remove</button>
  <transition-group name="list" tag="p">
    <span v-for="item in items" v-bind:key="item" class="list-item">
      {{ item }}
    </span>
  </transition-group>
</div>

new Vue({
  el: '#list-demo',
  data: {
    items: [1,2,3,4,5,6,7,8,9],
    nextNum: 10
  },
  methods: {
    randomIndex: function () {
      return Math.floor(Math.random() * this.items.length)
    },
    add: function () {
      this.items.splice(this.randomIndex(), 0, this.nextNum++)
    },
    remove: function () {
      this.items.splice(this.randomIndex(), 1)
    },
  }
})

.list-item {
  display: inline-block;
  margin-right: 10px;
}
.list-enter-active, .list-leave-active {
  transition: all 1s;
}
.list-enter, .list-leave-to /* .list-leave-active below version 2.1.8 */ {
  opacity: 0;
  transform: translateY(30px);
}
#+END_EXAMPLE

**** Animate when order is changed, v-move, *-move class
Vue uses FLIP and FLIP doesn't work with elements set to display:inline. Set it to display: inline-block or place elements in a flex context.

#+BEGIN_EXAMPLE
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.14.1/lodash.min.js"></script>
<div id="flip-list-demo" class="demo">
  <button v-on:click="shuffle">Shuffle</button>
  <transition-group name="flip-list" tag="ul">
    <li v-for="item in items" v-bind:key="item">
      {{ item }}
    </li>
  </transition-group>
</div>

new Vue({
  el: '#flip-list-demo',
  data: {
    items: [1,2,3,4,5,6,7,8,9]
  },
  methods: {
    shuffle: function () {
      this.items = _.shuffle(this.items)
    }
  }
})

.flip-list-move {
  transition: transform 1s;
}
#+END_EXAMPLE


**** javascript hooks
By assigning different delay, list items can be transitioned in/out in the same order as they first appeared.

#+BEGIN_EXAMPLE
<script src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.2.3/velocity.min.js"></script>
<div id="staggered-list-demo">
  <input v-model="query">
  <transition-group
    name="staggered-fade"
    tag="ul"
    v-bind:css="false"
    v-on:before-enter="beforeEnter"
    v-on:enter="enter"
    v-on:leave="leave"
  >
    <li
      v-for="(item, index) in computedList"
      v-bind:key="item.msg"
      v-bind:data-index="index"
    >{{ item.msg }}</li>
  </transition-group>
</div>

new Vue({
  el: '#staggered-list-demo',
  data: {
    query: '',
    list: [
      { msg: 'Bruce Lee' },
      { msg: 'Jackie Chan' },
      { msg: 'Chuck Norris' },
      { msg: 'Jet Li' },
      { msg: 'Kung Fury' }
    ]
  },
  computed: {
    computedList: function () {
      var vm = this
      return this.list.filter(function (item) {
        return item.msg.toLowerCase().indexOf(vm.query.toLowerCase()) !== -1
      })
    }
  },
  methods: {
    beforeEnter: function (el) {
      el.style.opacity = 0
      el.style.height = 0
    },
    enter: function (el, done) {
      var delay = el.dataset.index * 150
      setTimeout(function () {
        Velocity(
          el,
          { opacity: 1, height: '1.6em' },
          { complete: done }
        )
      }, delay)
    },
    leave: function (el, done) {
      var delay = el.dataset.index * 150
      setTimeout(function () {
        Velocity(
          el,
          { opacity: 0, height: 0 },
          { complete: done }
        )
      }, delay)
    }
  }
})
#+END_EXAMPLE

*** Make transition reusable
#+BEGIN_EXAMPLE
Vue.component('my-special-transition', {
  template: '\
    <transition\
      name="very-special-transition"\
      mode="out-in"\
      v-on:before-enter="beforeEnter"\
      v-on:after-enter="afterEnter"\
    >\
      <slot></slot>\
    </transition>\
  ',
  methods: {
    beforeEnter: function (el) {
      // ...
    },
    afterEnter: function (el) {
      // ...
    }
  }
})
#+END_EXAMPLE

Functional component
#+BEGIN_EXAMPLE
Vue.component('my-special-transition', {
  functional: true,
  render: function (createElement, context) {
    var data = {
      props: {
        name: 'very-special-transition',
        mode: 'out-in'
      },
      on: {
        beforeEnter: function (el) {
          // ...
        },
        afterEnter: function (el) {
          // ...
        }
      }
    }
    return createElement('transition', data, context.children)
  }
})
#+END_EXAMPLE

*** State Transition
Achieve transition by changing state (e.g. prop) of data.

**** Watchers, Tween.js, Color.js
#+BEGIN_EXAMPLE
<script src="https://cdn.jsdelivr.net/npm/tween.js@16.3.4"></script>
<div id="animated-number-demo">
  <input v-model.number="number" type="number" step="20">
  <p>{{ animatedNumber }}</p>
</div>

new Vue({
  el: '#animated-number-demo',
  data: {
    number: 0,
    animatedNumber: 0
  },
  watch: {
    number: function(newValue, oldValue) {
      var vm = this
      function animate () {
        if (TWEEN.update()) {
          requestAnimationFrame(animate)
        }
      }
      new TWEEN.Tween({ tweeningNumber: oldValue })
        .easing(TWEEN.Easing.Quadratic.Out)
        .to({ tweeningNumber: newValue }, 500)
        .onUpdate(function () {
          vm.animatedNumber = this.tweeningNumber.toFixed(0)
        })
        .start()
      animate()
    }
  }
})
#+END_EXAMPLE

** Mixins
*** Local vs Global
#+BEGIN_EXAMPLE
// define a mixin object
var myMixin = {
  created: function () {
    this.hello()
  },
  methods: {
    hello: function () {
      console.log('hello from mixin!')
    }
  }
}
// define a component that uses this mixin
var Component = Vue.extend({
  mixins: [myMixin]
})
var component = new Component() // => "hello from mixin!"
#+END_EXAMPLE

Global mixin
#+BEGIN_EXAMPLE
// inject a handler for `myOption` custom option
Vue.mixin({
  created: function () {
    var myOption = this.$options.myOption
    if (myOption) {
      console.log(myOption)
    }
  }
})
new Vue({
  myOption: 'hello!'
})
// => "hello!"
#+END_EXAMPLE
Use global mixins sparsely and carefully, because it affects every single Vue instance created, including third party components. In most cases, you should only use it for custom option handling like demonstrated in the example above. It’s also a good idea to ship them as Plugins to avoid duplicate application.

*** Merge option with hook functions 
mixin will be called before the component's own hooks.
#+BEGIN_EXAMPLE
var mixin = {
  created: function () {
    console.log('mixin hook called')
  }
}
new Vue({
  mixins: [mixin],
  created: function () {
    console.log('component hook called')
  }
})
// => "mixin hook called"
// => "component hook called"
#+END_EXAMPLE

*** Merge option with Object value 
The component's options will take priority when conflict keys exist
#+BEGIN_EXAMPLE
var mixin = {
  methods: {
    foo: function () {
      console.log('foo')
    },
    conflicting: function () {
      console.log('from mixin')
    }
  }
}
var vm = new Vue({
  mixins: [mixin],
  methods: {
    bar: function () {
      console.log('bar')
    },
    conflicting: function () {
      console.log('from self')
    }
  }
})
vm.foo() // => "foo"
vm.bar() // => "bar"
vm.conflicting() // => "from self"
#+END_EXAMPLE

*** Custom Option Merge Strategies
#+BEGIN_EXAMPLE
Vue.config.optionMergeStrategies.myOption = function (toVal, fromVal) {
  // return mergedVal
}

var strategies = Vue.config.optionMergeStrategies
strategies.myOption = strategies.methods // the default strategy for most object-based options

// more advanced
const merge = Vue.config.optionMergeStrategies.computed
Vue.config.optionMergeStrategies.vuex = function (toVal, fromVal) {
  if (!toVal) return fromVal
  if (!fromVal) return toVal
  return {
    getters: merge(toVal.getters, fromVal.getters),
    state: merge(toVal.state, fromVal.state),
    actions: merge(toVal.actions, fromVal.actions)
  }
}
#+END_EXAMPLE

** Custom Directive
*** Basics
#+BEGIN_EXAMPLE
<input v-focus>

// Register a global custom directive called v-focus
Vue.directive('focus', {
  // When the bound element is inserted into the DOM...
  inserted: function (el) {
    // Focus the element
    el.focus()
  }
})
#+END_EXAMPLE

Register it locally for a component, using the directives option inside the component
#+BEGIN_EXAMPLE
directives: {
  focus: {
    // directive definition
    inserted: function (el) {
      el.focus()
    }
  }
}
#+END_EXAMPLE

*** Option - Hook Functions
Other than inserted, there're other optional hooks

- bind :: called only once, when the directive is first bound to the element. This is where you can do one-time setup work.
- inserted :: called when the bound element has been inserted into its parent node (this only guarantees parent node presence, not necessarily in-document).
- update :: called after the containing component’s VNode has updated, but possibly before its children have updated. The directive’s value may or may not have changed, but you can skip unnecessary updates by comparing the binding’s current and old values (see below on hook arguments).
- componentUpdated :: called after the containing component’s VNode and the VNodes of its children have updated.
unbind: called only once, when the directive is unbound from the element.

Shorthand for same behavior on bind and update
#+BEGIN_EXAMPLE
Vue.directive('color-swatch', function (el, binding) {
  el.style.backgroundColor = binding.value
})
#+END_EXAMPLE

**** Hooks are passed these arguments
Apart from el, you should treat these arguments as read-only and never modify them. If you need to share information across hooks, it is recommended to do so through element’s dataset.

- el :: The element the directive is bound to. This can be used to directly manipulate the DOM.
- binding :: An object containing the following properties.
  - name :: The name of the directive, without the v- prefix.
  - value :: The value passed to the directive. For example in v-my-directive="1 + 1", the value would be 2.
  - oldValue :: The previous value, only available in update and componentUpdated. It is available whether or not the value has changed.
  - expression :: The expression of the binding as a string. For example in v-my-directive="1 + 1", the expression would be "1 + 1".
  - arg :: The argument passed to the directive, if any. For example in v-my-directive:foo, the arg would be "foo".
  - modifiers :: An object containing modifiers, if any. For example in v-my-directive.foo.bar, the modifiers object would be { foo: true, bar: true }.
- vnode :: The virtual node produced by Vue’s compiler. See the VNode API for full details.
- oldVnode :: The previous virtual node, only available in the update and componentUpdated hooks.

*** Example
#+BEGIN_EXAMPLE
<div id="hook-arguments-example" v-demo:foo.a.b="message"></div>

Vue.directive('demo', {
  bind: function (el, binding, vnode) {
    var s = JSON.stringify
    el.innerHTML =
      'name: '       + s(binding.name) + '<br>' +
      'value: '      + s(binding.value) + '<br>' +
      'expression: ' + s(binding.expression) + '<br>' +
      'argument: '   + s(binding.arg) + '<br>' +
      'modifiers: '  + s(binding.modifiers) + '<br>' +
      'vnode keys: ' + Object.keys(vnode).join(', ')
  }
})
new Vue({
  el: '#hook-arguments-example',
  data: {
    message: 'hello!'
  }
})

// result
name: "demo"
value: "hello!"
expression: "message"
argument: "foo"
modifiers: {"a":true,"b":true}
vnode keys: tag, data, children, text, elm, ns, context, functionalContext, functionalOptions, functionalScopeId, key, componentOptions, componentInstance, parent, raw, isStatic, isRootInsert, isComment, isCloned, isOnce, asyncFactory, asyncMeta, isAsyncPlaceholder
#+END_EXAMPLE

Pass multiple values to directive
#+BEGIN_EXAMPLE
<div v-demo="{ color: 'white', text: 'hello!' }"></div>

Vue.directive('demo', function (el, binding) {
  console.log(binding.value.color) // => "white"
  console.log(binding.value.text)  // => "hello!"
})
#+END_EXAMPLE

** Render Functions & JSX
*** Render function
To avoid duplicating <slot> in string template
#+BEGIN_EXAMPLE
<anchored-heading :level="1">Hello world!</anchored-heading>

<script type="text/x-template" id="anchored-heading-template">
  <h1 v-if="level === 1">
    <slot></slot>
  </h1>
  <h2 v-else-if="level === 2">
    <slot></slot>
  </h2>
  <h3 v-else-if="level === 3">
    <slot></slot>
  </h3>
  <h4 v-else-if="level === 4">
    <slot></slot>
  </h4>
  <h5 v-else-if="level === 5">
    <slot></slot>
  </h5>
  <h6 v-else-if="level === 6">
    <slot></slot>
  </h6>
</script>

Vue.component('anchored-heading', {
  template: '#anchored-heading-template',
  props: {
    level: {
      type: Number,
      required: true
    }
  }
})
#+END_EXAMPLE

Use render function (reactive)
#+BEGIN_EXAMPLE
Vue.component('anchored-heading', {
  render: function (createElement) {
    return createElement(
      'h' + this.level,   // tag name
      this.$slots.default // array of children
    )
  },
  props: {
    level: {
      type: Number,
      required: true
    }
  }
})
#+END_EXAMPLE

**** createElement Arguments
#+BEGIN_EXAMPLE
// @returns {VNode}
createElement(
  // {String | Object | Function}
  // An HTML tag name, component options, or function
  // returning one of these. Required.
  'div',

  // {Object}
  // A data object corresponding to the attributes
  // you would use in a template. Optional.
  {
    // (see details in the next section below)
  },

  // {String | Array}
  // Children VNodes, built using `createElement()`,
  // or using strings to get 'text VNodes'. Optional.
  [
    'Some text comes first.',
    createElement('h1', 'A headline'),
    createElement(MyComponent, {
      props: {
        someProp: 'foobar'
      }
    })
  ]
)
#+END_EXAMPLE

#+BEGIN_EXAMPLE
{
  // Same API as `v-bind:class`
  'class': {
    foo: true,
    bar: false
  },
  // Same API as `v-bind:style`
  style: {
    color: 'red',
    fontSize: '14px'
  },
  // Normal HTML attributes
  attrs: {
    id: 'foo'
  },
  // Component props
  props: {
    myProp: 'bar'
  },
  // DOM properties
  domProps: {
    innerHTML: 'baz'
  },
  // Event handlers are nested under `on`, though
  // modifiers such as in `v-on:keyup.enter` are not
  // supported. You'll have to manually check the
  // keyCode in the handler instead.
  on: {
    click: this.clickHandler
  },
  // For components only. Allows you to listen to
  // native events, rather than events emitted from
  // the component using `vm.$emit`.
  nativeOn: {
    click: this.nativeClickHandler
  },
  // Custom directives. Note that the binding's
  // oldValue cannot be set, as Vue keeps track
  // of it for you.
  directives: [
    {
      name: 'my-custom-directive',
      value: '2',
      expression: '1 + 1',
      arg: 'foo',
      modifiers: {
        bar: true
      }
    }
  ],
  // Scoped slots in the form of
  // { name: props => VNode | Array<VNode> }
  scopedSlots: {
    default: props => createElement('span', props.text)
  },
  // The name of the slot, if this component is the
  // child of another component
  slot: 'name-of-slot',
  // Other special top-level properties
  key: 'myKey',
  ref: 'myRef'
}
#+END_EXAMPLE

**** createElement Constraints
All VNodes in the component tree must be unique. This is invalid
#+BEGIN_EXAMPLE
render: function (createElement) {
  var myParagraphVNode = createElement('p', 'hi')
  return createElement('div', [
    // Yikes - duplicate VNodes!
    myParagraphVNode, myParagraphVNode
  ])
}
#+END_EXAMPLE

Use factory function
#+BEGIN_EXAMPLE
render: function (createElement) {
  return createElement('div',
    Array.apply(null, { length: 20 }).map(function () {
      return createElement('p', 'hi')
    })
  )
}
#+END_EXAMPLE

**** render for v-if and v-for
**** render for v-model
**** redner for event & key modifiers
**** render for <slot>
Static slot contents as Arrays of VNodes from this.$slots
#+BEGIN_EXAMPLE
render: function (createElement) {
  // `<div><slot></slot></div>`
  return createElement('div', this.$slots.default)
}
#+END_EXAMPLE

Scoped slot
#+BEGIN_EXAMPLE
render: function (createElement) {
  // `<div><slot :text="msg"></slot></div>`
  return createElement('div', [
    this.$scopedSlots.default({
      text: this.msg
    })
  ])
}

// pass scoped slots to a child component
render (createElement) {
  return createElement('div', [
    createElement('child', {
      // pass `scopedSlots` in the data object
      // in the form of { name: props => VNode | Array<VNode> }
      scopedSlots: {
        default: function (props) {
          return createElement('span', props.text)
        }
      }
    })
  ])
}
#+END_EXAMPLE

*** JSX

** Plugin
<<<vue:plugin>>>
Third party plugins and libraries
https://github.com/vuejs/awesome-vue#components--libraries
*** Basics
Plugins usually add global-level functionality to Vue. There is no strictly defined scope for a plugin - there are typically several types of plugins you can write:
- Add some global methods or properties. e.g. vue-custom-element
- Add one or more global assets: directives/filters/transitions etc. e.g. vue-touch
- Add some component options by global mixin. e.g. vue-router
- Add some Vue instance methods by attaching them to Vue.prototype.
- A library that provides an API of its own, while at the same time injecting some combination of the above. e.g. vue-router

Official Vue.js plugins such as vue-router automatically calls Vue.use() if vue is available as a global variable.

#+BEGIN_EXAMPLE
MyPlugin.install = function (Vue, options) {
  // 1. add global method or property
  Vue.myGlobalMethod = function () {
    // something logic ...
  }
  // 2. add a global asset
  Vue.directive('my-directive', {
    bind (el, binding, vnode, oldVnode) {
      // something logic ...
    }
    ...
  })
  // 3. inject some component options
  Vue.mixin({
    created: function () {
      // something logic ...
    }
    ...
  })
  // 4. add an instance method
  Vue.prototype.$myMethod = function (methodOptions) {
    // something logic ...
  }
}
#+END_EXAMPLE

Use a Plugin
#+BEGIN_EXAMPLE
// calls `MyPlugin.install(Vue)`
Vue.use(MyPlugin)

Vue.use(MyPlugin, { someOption: true })
#+END_EXAMPLE

#+BEGIN_EXAMPLE
// When using CommonJS via Browserify or Webpack
var Vue = require('vue')

var VueRouter = require('vue-router')
// Don't forget to call this
Vue.use(VueRouter)
#+END_EXAMPLE

*** vuex Namespace in Plugin
vue:plugin:vuex:namespace in plugin

** Production Development
Without build tools, directly inject javascript
Prod :: https://cdn.jsdelivr.net/npm/vue
Dev :: https://unpkg.com/vue

** vue-router
<<<vue:plugin:router>>> <<<vue:router>>>
VueRouter:option:x => option:x
*** <router-view>, <router-link>, option:routes, this.$router, this.$route
#+BEGIN_EXAMPLE
<script src="https://unpkg.com/vue/dist/vue.js"></script>
<script src="https://unpkg.com/vue-router/dist/vue-router.js"></script>

<div id="app">
  <h1>Hello App!</h1>
  <p>
    <!-- use router-link component for navigation. -->
    <!-- specify the link by passing the `to` prop. -->
    <!-- `<router-link>` will be rendered as an `<a>` tag by default -->
    <!-- it gets .router-link-active class when the route is matched -->
    <router-link to="/foo">Go to Foo</router-link>
    <router-link to="/bar">Go to Bar</router-link>
  </p>
  <!-- route outlet -->
  <!-- component matched by the route will render here -->
  <router-view></router-view>
</div>
#+END_EXAMPLE

#+BEGIN_EXAMPLE
// 0. If using a module system (e.g. via vue-cli), import Vue and VueRouter
// and then call `Vue.use(VueRouter)`.

// 1. Define route components.
// These can be imported from other files
const Foo = { template: '<div>foo</div>' }
const Bar = { template: '<div>bar</div>' }

// 2. Define some routes
// Each route should map to a component. The "component" can
// either be an actual component constructor created via
// `Vue.extend()`, or just a component options object.
// We'll talk about nested routes later.
const routes = [
  { path: '/foo', component: Foo },
  { path: '/bar', component: Bar }
]

// 3. Create the router instance and pass the `routes` option
// You can pass in additional options here, but let's
// keep it simple for now.
const router = new VueRouter({
  routes // short for `routes: routes`
})

// 4. Create and mount the root instance.
// Make sure to inject the router with the router option to make the
// whole app router-aware.
const app = new Vue({
  router
}).$mount('#app')

// Now the app has started!
#+END_EXAMPLE

In any component, this.$router vue:router:router and this.$route vue:router:route are available
#+BEGIN_EXAMPLE
// Home.vue
export default {
  computed: {
    username () {
      // We will see what `params` is shortly
      return this.$route.params.username
    }
  },
  methods: {
    goBack () {
      window.history.length > 1
        ? this.$router.go(-1)
        : this.$router.push('/')
    }
  }
}
#+END_EXAMPLE

*** option:routes, $route.params, regex, option:routes[]:name, option:routes[]:component
#+BEGIN_EXAMPLE
const User = {
  template: '<div>User {{ $route.params.id }}</div>'
}

const router = new VueRouter({
  routes: [
    // dynamic segments start with a colon
    { path: '/user/:id', component: User }
  ]
})
#+END_EXAMPLE

**** regex pattern in option:routes
vue-router uses [[https://github.com/pillarjs/path-to-regexp][path-to-regexp]] whihc is used by Express as well.
The earlier a route is defined, the higher priority it gets.

#+BEGIN_EXAMPLE
import Vue from 'vue'
import VueRouter from 'vue-router'

Vue.use(VueRouter)

// The matching uses path-to-regexp, which is the matching engine used
// by express as well, so the same matching rules apply.
// For detailed rules, see https://github.com/pillarjs/path-to-regexp
const router = new VueRouter({
  mode: 'history',
  base: __dirname,
  routes: [
    { path: '/' },
    // params are denoted with a colon ":"
    { path: '/params/:foo/:bar' },
    // a param can be made optional by adding "?"
    { path: '/optional-params/:foo?' },
    // a param can be followed by a regex pattern in parens
    // this route will only be matched if :id is all numbers
    { path: '/params-with-regex/:id(\\d+)' },
    // asterisk can match anything
    { path: '/asterisk/*' },
    // make part of the path optional by wrapping with parens and add "?"
    { path: '/optional-group/(foo/)?bar' }
  ]
})

new Vue({
  router,
  template: `
    <div id="app">
      <h1>Route Matching</h1>
      <ul>
        <li><router-link to="/">/</router-link></li>
        <li><router-link to="/params/foo/bar">/params/foo/bar</router-link></li>
        <li><router-link to="/optional-params">/optional-params</router-link></li>
        <li><router-link to="/optional-params/foo">/optional-params/foo</router-link></li>
        <li><router-link to="/params-with-regex/123">/params-with-regex/123</router-link></li>
        <li><router-link to="/params-with-regex/abc">/params-with-regex/abc</router-link></li>
        <li><router-link to="/asterisk/foo">/asterisk/foo</router-link></li>
        <li><router-link to="/asterisk/foo/bar">/asterisk/foo/bar</router-link></li>
        <li><router-link to="/optional-group/bar">/optional-group/bar</router-link></li>
        <li><router-link to="/optional-group/foo/bar">/optional-group/foo/bar</router-link></li>
      </ul>
      <p>Route context</p>
      <pre>{{ JSON.stringify($route, null, 2) }}</pre>
    </div>
  `
}).$mount('#app')
#+END_EXAMPLE

**** Named routes, option:routes[]:name
#+BEGIN_EXAMPLE
const router = new VueRouter({
  routes: [
    {
      path: '/user/:userId',
      name: 'user',
      component: User
    }
  ]
})

<router-link :to="{ name: 'user', params: { userId: 123 }}">User</router-link>
router.push({ name: 'user', params: { userId: 123 }})
#+END_EXAMPLE

*** option:routes[]:components, multiple <router-view>'s
#+BEGIN_EXAMPLE
<router-view class="view one"></router-view>
<router-view class="view two" name="a"></router-view>
<router-view class="view three" name="b"></router-view>

const router = new VueRouter({
  routes: [
    {
      path: '/',
      components: {
        default: Foo,
        a: Bar,
        b: Baz
      }
    }
  ]
})
#+END_EXAMPLE

*** option:routes[]:redirect, option:routes[]:alias
A redirect means when the user visits /a, and URL will be replaced by /b, and then matched as /b. 

#+BEGIN_EXAMPLE
const router = new VueRouter({
  routes: [
    { path: '/a', redirect: '/b' }
  ]
})

const router = new VueRouter({
  routes: [
    { path: '/a', redirect: { name: 'foo' }}
  ]
})

const router = new VueRouter({
  routes: [
    { path: '/a', redirect: to => {
      // the function receives the target route as the argument
      // return redirect path/location here.
    }}
  ]
})
#+END_EXAMPLE

An alias of /a as /b means when the user visits /b, the URL remains /b, but it will be matched as if the user is visiting /a.

#+BEGIN_EXAMPLE
const router = new VueRouter({
  routes: [
    { path: '/a', component: A, alias: '/b' }
  ]
})
#+END_EXAMPLE

*** Route object, $route, this.$route, option:scrollBehavior
<<<vue:router:route>>>
https://router.vuejs.org/en/api/route-object.html
$route => this.$route, router.match(location)
#+BEGIN_EXAMPLE
router.beforeEach((to, from, next) => {
  // `to` and `from` are both route objects
})

const router = new VueRouter({
  scrollBehavior (to, from, savedPosition) {
    // `to` and `from` are both route objects
  }
})
#+END_EXAMPLE

$route.path :: absolute path e.g. /foo/bar
$route.params :: {} or key/value pairs of dynamic segments and star segments
$route.query :: {} or key/vale pairs of the query string /foo?user=1 $route.query.user == 1
$route.hash :: empty string or anything with #.
$route.fullPath :: string query and hash
$route.matched :: e.g. /foo/bar, then .matched is an array of objects in parent to child order.

*** option:scrollBehavior
#+BEGIN_EXAMPLE
const router = new VueRouter({
  routes: [...],
  scrollBehavior (to, from, savedPosition) {
    // return desired position
  }
})
#+END_EXAMPLE

savedPosition, is only available if this is a popstate navigation (triggered by the browser's back/forward buttons).

Should return either one of these
- { x: number, y: number }
- { selector: string, offset? : { x: number, y: number }}

Scroll to top for all route navigations
#+BEGIN_EXAMPLE
scrollBehavior (to, from, savedPosition) {
  return { x: 0, y: 0 }
}
#+END_EXAMPLE

#+BEGIN_EXAMPLE
scrollBehavior (to, from, savedPosition) {
  if (savedPosition) {
    return savedPosition
  } else {
    return { x: 0, y: 0 }
  }
}

// scroll to anchor
scrollBehavior (to, from, savedPosition) {
  if (to.hash) {
    return {
      selector: to.hash
      // , offset: { x: 0, y: 10 }
    }
  }
}
#+END_EXAMPLE

*** option:routes[]:props, component:props
Decouple $route in component. Before
#+BEGIN_EXAMPLE
const User = {
  template: '<div>User {{ $route.params.id }}</div>'
}
const router = new VueRouter({
  routes: [
    { path: '/user/:id', component: User }
  ]
})
#+END_EXAMPLE

Now
#+BEGIN_EXAMPLE
const User = {
  props: ['id'],
  template: '<div>User {{ id }}</div>'
}
const router = new VueRouter({
  routes: [
    { path: '/user/:id', component: User, props: true }

    // for routes with named views, you have to define the `props` option for each named view:
    {
      path: '/user/:id',
      components: { default: User, sidebar: Sidebar },
      props: { default: true, sidebar: false }
    }
  ]
})
#+END_EXAMPLE

option:routes[]:props is set to true, the route.params will be set as the component props.

props is an object
#+BEGIN_EXAMPLE
const router = new VueRouter({
  routes: [
    { path: '/hello/:name', component: Hello, props: true }, // Pass route.params to props
    { path: '/promotion/from-newsletter', component: Promotion, props: { newsletterPopup: false } },
    { path: '/static', component: Hello, props: { name: 'world' }}, // static values
  ]
})
#+END_EXAMPLE

props is a function
The URL /search?q=vue would pass {query: 'vue'} as props to the SearchUser component.
#+BEGIN_EXAMPLE
function dynamicPropsFn (route) {
  const now = new Date()
  return {
    name: (now.getFullYear() + parseInt(route.params.years)) + '!'
  }
}

const router = new VueRouter({
  routes: [
    { path: '/search', component: SearchUser, props: (route) => ({ query: route.query.q }) }
    { path: '/dynamic/:years', component: Hello, props: dynamicPropsFn }, // custom logic for mapping between route and props
  ]
})
#+END_EXAMPLE

*** React to params changes, component:watch, component:beforeRouteUpdate
<<<vue:router:react>>>
<<<vue:router:component:beforeRouteUpdate>>> <<<vue:router:component:watch>>>
params or query chnages won't trigger enter/leave navigation guards and hence this is needed to react to changes.
#+BEGIN_EXAMPLE
const User = {
  template: '...',
  watch: {
    '$route' (to, from) {
      // react to route changes...
    }
  }
}
#+END_EXAMPLE

#+BEGIN_EXAMPLE
const User = {
  template: '...',
  beforeRouteUpdate (to, from, next) {
    // react to route changes...
    // don't forget to call next()
  }
}
#+END_EXAMPLE

*** Nested routes, <router-view>, option:routes:children
/user/foo/profile (component:user and component:profile) and /user/foo/posts (component:user and component:posts)

#+BEGIN_EXAMPLE
<div id="app">
  <router-view></router-view>
</div>

const User = {
  template: `
    <div>User {{ $route.params.id }}</div>
    <router-view></router-view>
  `
}

const router = new VueRouter({
  routes: [
    { path: '/user/:id', component: User,
      children: [
        // UserHome will be rendered inside User's <router-view>
        // when /user/:id is matched
        { path: '', component: UserHome },

        {
          // UserProfile will be rendered inside User's <router-view>
          // when /user/:id/profile is matched
          path: 'profile',
          component: UserProfile
        },

        {
          // UserPosts will be rendered inside User's <router-view>
          // when /user/:id/posts is matched
          path: 'posts',
          component: UserPosts
        }
      ]
    }
  ]
})
#+END_EXAMPLE

**** option:routes:children[]:meta
#+BEGIN_EXAMPLE
const router = new VueRouter({
  routes: [
    {
      path: '/foo',
      component: Foo,
      children: [
        {
          path: 'bar',
          component: Bar,
          // a meta field
          meta: { requiresAuth: true }
        }
      ]
    }
  ]
})
#+END_EXAMPLE

#+BEGIN_EXAMPLE
router.beforeEach((to, from, next) => {
  if (to.matched.some(record => record.meta.requiresAuth)) {
    // this route requires auth, check if logged in
    // if not, redirect to login page.
    if (!auth.loggedIn()) {
      next({
        path: '/login',
        query: { redirect: to.fullPath }
      })
    } else {
      next()
    }
  } else {
    next() // make sure to always call next()!
  }
})
#+END_EXAMPLE

*** Programmatic Navigation, this.$router, router.*
<<<vue:router:router>>> <<<vue:router:router.push>>>
Both router and this.$router can be used in component. this.$router means vue-router is imported in every component.
~<router-link :to="...">~ is equivalent to ~router.push(...)~

params are ignored if a path is provided.

#+BEGIN_EXAMPLE
// literal string path
router.push('home')

// object
router.push({ path: 'home' })

// named route
router.push({ name: 'user', params: { userId: 123 }})

// with query, resulting in /register?plan=private
router.push({ path: 'register', query: { plan: 'private' }})
#+END_EXAMPLE

#+BEGIN_EXAMPLE
const userId = 123
router.push({ name: 'user', params: { userId }}) // -> /user/123
router.push({ path: `/user/${userId}` }) // -> /user/123
// This will NOT work
router.push({ path: '/user', params: { userId }}) // -> /user
#+END_EXAMPLE

**** router.push, router.replace, router.push.onComplete, router.push.onAbort
Callbacks as the 2nd and 3rd arguments.
onComplete :: after all async hooks are resolved
onAbort :: navigated to the same route, or to a different route before current navigation has finished.

If destination is the same as the current route and only params are changing (/users/1 -> /users/2), use beforeRouteUpdate to react.
vue:router:react

router.push(location, onComplete?, onAbort?)
router.replace(location, onComplete?, onAbort?) :: without pushing a new history entry

**** router.go(n)
Similar to window.history.go(n)

#+BEGIN_EXAMPLE
// go forward by one record, the same as history.forward()
router.go(1)

// go back by one record, the same as history.back()
router.go(-1)

// go forward by 3 records
router.go(3)

// fails silently if there aren't that many records.
router.go(-100)
router.go(100)
#+END_EXAMPLE

*** option:mode
Default is hash mode, change to history mode to change URL without a page reload.

#+BEGIN_EXAMPLE
const router = new VueRouter({
  mode: 'history',
  routes: [
    // some path
    // catch 404
    { path: '*', component: NotFoundComponent }
  ]
})
#+END_EXAMPLE

Apache
#+BEGIN_EXAMPLE
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /
  RewriteRule ^index\.html$ - [L]
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule . /index.html [L]
</IfModule>
#+END_EXAMPLE

nginx
#+BEGIN_EXAMPLE
location / {
  try_files $uri $uri/ /index.html;
}
#+END_EXAMPLE

*** Guards
- Navigation triggered.
- Call leave guards in deactivated components.
- Call global beforeEach guards.
- Call beforeRouteUpdate guards in reused components (2.2+).
- Call beforeEnter in route configs.
- Resolve async route components.
- Call beforeRouteEnter in activated components.
- Call global beforeResolve guards (2.5+).
- Navigation confirmed.
- Call global afterEach hooks.
- DOM updates triggered.
- Call callbacks passed to next in beforeRouteEnter guards with instantiated instances.

**** global, router.beforeEach, router.beforeResolve, router.afterEach
Guards/hooks may be resolved asynchronously, the navigation is considered pending before all hooks have been resolved (confirmed).
<<<vue:router:router.beforeEach>>>

#+BEGIN_EXAMPLE
const router = new VueRouter({ ... })

router.beforeEach((to, from, next) => {
  // ...
})
#+END_EXAMPLE

Always call next function to resolve.

next() :: move on to the next hook in the pipeline.
next(false) :: abort the current navigation. If the URL was changed (either manually by the user or via back button), it will be reset to that of the from route.
next('/') or next({ path: '/' }) :: redirect to a different location. The current navigation will be aborted and a new one will be started. A location object can be passed. Refer to vue:router:router.push
next(error) :: navigation will be aborted and the error will be passed to callbacks registered via router.onError().

router.beforeResolve is similar to router.beforeEach with the difference that resolve guards will be called right before the navigation is confirmed, after all in-component guards and async route components are resolved.

router.afterEach do not get a next function and cannot affect the navigation

#+BEGIN_EXAMPLE
router.afterEach((to, from) => {
  // ...
})
#+END_EXAMPLE

**** per-route, option:routes[]:beforeEnter
Same as vue:router:router.beforeEach
#+BEGIN_EXAMPLE
const router = new VueRouter({
  routes: [
    {
      path: '/foo',
      component: Foo,
      beforeEnter: (to, from, next) => {
        // ...
      }
    }
  ]
})
#+END_EXAMPLE

**** in-component, component:beforeRouteEnter, component:beforeRouteUpdate, component:beforeRouteLeave
#+BEGIN_EXAMPLE
const Foo = {
  template: `...`,
  beforeRouteEnter (to, from, next) {
    // called before the route that renders this component is confirmed.
    // does NOT have access to `this` component instance,
    // because it has not been created yet when this guard is called!
   
    // you can access to component instance via `vm`

    next(vm => {
      // it will be called when the navigation is confirmed
      // access to component instance via `vm`
    })
  },
  beforeRouteUpdate (to, from, next) {
    // called when the route that renders this component has changed,
    // but this component is reused in the new route.
    // For example, for a route with dynamic params `/foo/:id`, when we
    // navigate between `/foo/1` and `/foo/2`, the same `Foo` component instance
    // will be reused, and this hook will be called when that happens.
    // has access to `this` component instance.
  },
  beforeRouteLeave (to, from, next) {
    // called when the route that renders this component is about to
    // be navigated away from.
    // has access to `this` component instance.

    const answer = window.confirm('Do you really want to leave? you have unsaved changes!')
    if (answer) {
      next()
    } else {
      next(false)
    }    
  }
}
#+END_EXAMPLE

*** Fetch data
Fetch after navigation
#+BEGIN_EXAMPLE
<template>
  <div class="post">
    <div class="loading" v-if="loading">
      Loading...
    </div>

    <div v-if="error" class="error">
      {{ error }}
    </div>

    <div v-if="post" class="content">
      <h2>{{ post.title }}</h2>
      <p>{{ post.body }}</p>
    </div>
  </div>
</template>
export default {
  data () {
    return {
      loading: false,
      post: null,
      error: null
    }
  },
  created () {
    // fetch the data when the view is created and the data is
    // already being observed
    this.fetchData()
  },
  watch: {
    // call again the method if the route changes
    '$route': 'fetchData'
  },
  methods: {
    fetchData () {
      this.error = this.post = null
      this.loading = true
      // replace `getPost` with your data fetching util / API wrapper
      getPost(this.$route.params.id, (err, post) => {
        this.loading = false
        if (err) {
          this.error = err.toString()
        } else {
          this.post = post
        }
      })
    }
  }
}
#+END_EXAMPLE

Fetch before navigation
#+BEGIN_EXAMPLE
export default {
  data () {
    return {
      post: null,
      error: null
    }
  },
  beforeRouteEnter (to, from, next) {
    getPost(to.params.id, (err, post) => {
      next(vm => vm.setData(err, post))
    })
  },
  // when route changes and this component is already rendered,
  // the logic will be slightly different.
  beforeRouteUpdate (to, from, next) {
    this.post = null
    getPost(to.params.id, (err, post) => {
      this.setData(err, post)
      next()
    })
  },
  methods: {
    setData (err, post) {
      if (err) {
        this.error = err.toString()
      } else {
        this.post = post
      }
    }
  }
}
#+END_EXAMPLE

*** Lazy loading
Only load components when they are triggered by navigation
#+BEGIN_EXAMPLE
const Foo = () => Promise.resolve({ /* component definition */ })
import('./Foo.vue') // returns a Promise
#+END_EXAMPLE

Webpack
#+BEGIN_EXAMPLE
const Foo = () => import('./Foo.vue')

// everything is the same in router config
const router = new VueRouter({
  routes: [
    { path: '/foo', component: Foo }
  ]
})
#+END_EXAMPLE

Group multiple components and lazy load them

#+BEGIN_EXAMPLE
const Foo = () => import(/* webpackChunkName: "group-foo" */ './Foo.vue')
const Bar = () => import(/* webpackChunkName: "group-foo" */ './Bar.vue')
const Baz = () => import(/* webpackChunkName: "group-foo" */ './Baz.vue')
#+END_EXAMPLE

** State Management, Vuex
<<<vue:state management>>> <<<vue:plugin:vuex>>>
*** Basics, option:state
vuex is a vue:plugin

[[https://vuex.vuejs.org/en/][Vuex Doc]]

npm install vuex --save

./src/store/store.js (or index.js)
#+BEGIN_EXAMPLE
import Vue from 'vue'
import Vuex from 'vuex'

Vue.use(Vuex)

export default new Vuex.Store({
  state: {
    count: 0
  },
  mutations: {
    increment: state => state.count++, // shorthand for
    // increment (state) { state.count++ } 
    decrement: state => state.count--
  },
  actions: {
    // actions can be defined directly here to so that
    // they can interact with other actions/modules
  }
})
#+END_EXAMPLE

./src/main.js
#+BEGIN_EXAMPLE
import Vue from 'vue'
import App from './App'
import router from './router'
import store from './store/store' // new, if store/index.js is used, use ./store

Vue.config.productionTip = false

/* eslint-disable no-new */
new Vue({
  el: '#app',
  router,
  store, // new
  template: '<App/>',
  components: { App }

})
#+END_EXAMPLE

App.vue
#+BEGIN_EXAMPLE
<template>
  <div id="app">
    <img src="./assets/logo.png">
    <router-view/>
    <p>{{ count }}</p>
    <p>
      <button @click="increment">+</button>
      <button @click="decrement">-</button>
    </p>
  </div>
</template>

<script>

export default {
  name: 'app',
  computed: {
    count () {
      return this.$store.state.count
    }
  },
  methods: {
    increment () {
      this.$store.commit('increment')
    },
    decrement () {
      this.$store.commit('decrement')
    }
  }
}
</script>
#+END_EXAMPLE

*** mapState in component computed props
mapState is to get state as it is without calculation or maybe has to do calculations with local state.
It can save some keystrokes:
Before App.vue
#+BEGIN_EXAMPLE
<script>
export default {
  name: 'app',
  computed: {
    count () {
      return this.$store.state.count
    }
  },
  // some methods: {}
}
</script>
#+END_EXAMPLE

Use mapState
#+BEGIN_EXAMPLE
// in full builds helpers are exposed as Vuex.mapState
import { mapState } from 'vuex'

export default {
  // ...
  computed: mapState({
    // arrow functions can make the code very succinct!
    count: state => state.count,

    // passing the string value 'count' is same as `state => state.count`
    countAlias: 'count',

    // to access local state with `this`, a normal function must be used
    countPlusLocalState (state) {
      return state.count + this.localCount
    }
  })
}
#+END_EXAMPLE

Use array in mapState to map this.count to store.state.count
#+BEGIN_EXAMPLE
computed: mapState([
  // map this.count to store.state.count
  'count'
])
#+END_EXAMPLE

mapState returns an object inside the component's computed. How to combine with other computed properties?
#+BEGIN_EXAMPLE
computed: {
  localComputed () { /* ... */ },
  // mix this into the outer object with the object spread operator
  ...mapState({
    // ...
  })
}
#+END_EXAMPLE

*** option:getters, mapGetters in component computed props
getters or mapGetters are to get state and compute on it.

./src/store/store.js
#+BEGIN_EXAMPLE
const store = new Vuex.Store({
  state: {
    todos: [
      { id: 1, text: '...', done: true },
      { id: 2, text: '...', done: false }
    ]
  },
  getters: {
    doneTodos: state => {
      return state.todos.filter(todo => todo.done)
    },
    doneTodosCount: (state, getters) => {
      return getters.doneTodos.length
    },
    // pass parameter
    getTodoById: (state, getters) => (id) => {
      return state.todos.find(todo => todo.id === id)
    }
  }
})

store.getters.doneTodos // -> [{ id: 1, text: '...', done: true }]
store.getters.doneTodosCount // -> 1
store.getters.getTodoById(2) // -> { id: 2, text: '...', done: false }
#+END_EXAMPLE

In component
#+BEGIN_EXAMPLE
computed: {
  doneTodosCount () {
    return this.$store.getters.doneTodosCount
  }
}
#+END_EXAMPLE

mapGetters in component computed props
#+BEGIN_EXAMPLE
import { mapGetters } from 'vuex'

export default {
  // ...
  computed: {
    // mix the getters into computed with object spread operator
    ...mapGetters([
      'doneTodosCount',
      'anotherGetter',
      // ...
    ])
  }
}
#+END_EXAMPLE

Change name
#+BEGIN_EXAMPLE
...mapGetters({
  // map `this.doneCount` to `store.getters.doneTodosCount`
  doneCount: 'doneTodosCount'
})
#+END_EXAMPLE

*** option:mutations, commit/mapMutations in component, Synchronous
<<<vue:plugin:vuex:mutations>>>
Mutation is the only way to actually change state

Mutation is defined in Vuex and it has to be synchronous!

Add new prop to state
#+BEGIN_EXAMPLE
Vue.set(obj, 'newProp', 123)

// or rebuild the whole state
state.obj = { ...state.obj, newProp: 123 }
#+END_EXAMPLE

**** Mutation in store, commit in component
#+BEGIN_EXAMPLE
export default new Vuex.Store({
  state: {
    count: 1
  },
  mutations: {
    increment: state => state.count++, // shorthand for
    // increment (state) { state.count++ } 
  }
})
#+END_EXAMPLE

commit in component
#+BEGIN_EXAMPLE
methods: {
  increment () {
    this.$store.commit('increment')
  },
  decrement () {
    this.$store.commit('decrement')
  }
}
#+END_EXAMPLE

Mutation-Commit with payload
#+BEGIN_EXAMPLE
mutations: {
  increment (state, payload) {
    state.count += payload.amount
  }
}

// in component
methods: {
  increment: () {
    this.$store.commit('increment', {
      amount: 10
    })
    // object commit form
    /*
    this.$store.commit({
      type: 'increment',
      amound: 10
    })
    */
  }
}
#+END_EXAMPLE

**** mapMutations in component
save typing in component without typing commit
#+BEGIN_EXAMPLE
import { mapMutations } from 'vuex'

export default {
  // ...
  methods: {
    ...mapMutations([
      'increment', // map `this.increment()` to `this.$store.commit('increment')`

      // `mapMutations` also supports payloads:
      'incrementBy' // map `this.incrementBy(amount)` to `this.$store.commit('incrementBy', amount)`
    ]),
    ...mapMutations({
      add: 'increment' // map `this.add()` to `this.$store.commit('increment')`
    })
  }
}
#+END_EXAMPLE

**** Constant for Mutation
#+BEGIN_EXAMPLE
// mutation-types.js
export const SOME_MUTATION = 'SOME_MUTATION'

// store.js
import Vuex from 'vuex'
import { SOME_MUTATION } from './mutation-types'

const store = new Vuex.Store({
  state: { ... },
  mutations: {
    // we can use the ES2015 computed property name feature
    // to use a constant as the function name
    [SOME_MUTATION] (state) {
      // mutate state
    }
  }
})
#+END_EXAMPLE

*** option:actions with context, dispatch/mapActions in component, Asynchronous
Actions commit mutations

**** Basics
#+BEGIN_EXAMPLE
const store = new Vuex.Store({
  state: {
    count: 0
  },
  mutations: {
    increment (state) {
      state.count++
    }
  },
  actions: {
    increment (context) {
      // context exposes the same set of methods/props on the store instance
      // e.g. context.state, context.getters
      // but context is not the store instance
      context.commit('increment')
    }
    
    /* the above can be shortened to

    increment ({ commit }) {
      commit('increment')
    }
    */

  }
})
#+END_EXAMPLE

In component
#+BEGIN_EXAMPLE
this.$store.dispatch('increment')
#+END_EXAMPLE

**** mapActions and Asynchronous
store.js
#+BEGIN_EXAMPLE
actions: {
  // checkout only needs commit and state from context
  // products is a payload
  checkout ({ commit, state }, products) {

    // save the items currently in the cart
    const savedCartItems = [...state.cart.added]

    // send out checkout request, and optimistically
    // clear the cart
    commit(types.CHECKOUT_REQUEST)

    // the shop API accepts a success callback and a failure callback
    shop.buyProducts(

      products,

      // handle success
      () => commit(types.CHECKOUT_SUCCESS),

      // handle failure
      () => commit(types.CHECKOUT_FAILURE, savedCartItems)

    )
  }
}
#+END_EXAMPLE

In component
#+BEGIN_EXAMPLE
import { mapActions } from 'vuex'

export default {
  // ...
  methods: {
    ...mapActions([
      'increment', // map `this.increment()` to `this.$store.dispatch('increment')`

      // `mapActions` also supports payloads:
      'incrementBy' // map `this.incrementBy(amount)` to `this.$store.dispatch('incrementBy', amount)`
    ]),
    ...mapActions({
      add: 'increment' // map `this.add()` to `this.$store.dispatch('increment')`
    })
  }
}
#+END_EXAMPLE

**** Series of actions, return Promise
#+BEGIN_EXAMPLE
actions: {
  actionA ({ commit }) {
    return new Promise((resolve, reject) => {
      setTimeout(() => {
        commit('someMutation')
        resolve()
      }, 1000)
    })
  },
  actionB ({ dispatch, commit }) {
    return dispatch('actionA').then(() => {
      commit('someOtherMutation')
    })
  }
}
#+END_EXAMPLE

#+BEGIN_EXAMPLE
store.dispatch('actionA').then(() => {
  // ...
})
#+END_EXAMPLE

**** Series of actions, async/await
js:async/await
#+BEGIN_EXAMPLE
// assuming `getData()` and `getOtherData()` return Promises

actions: {
  async actionA ({ commit }) {
    commit('gotData', await getData())
  },
  async actionB ({ dispatch, commit }) {
    await dispatch('actionA') // wait for `actionA` to finish
    commit('gotOtherData', await getOtherData())
  }
}
#+END_EXAMPLE

*** option:modules
#+BEGIN_EXAMPLE
const moduleA = {
  state: { ... },
  mutations: { ... },
  actions: { ... },
  getters: { ... }
}

const moduleB = {
  state: { ... },
  mutations: { ... },
  actions: { ... }
}

const store = new Vuex.Store({
  modules: {
    a: moduleA,
    b: moduleB
  }
})

store.state.a // -> `moduleA`'s state
store.state.b // -> `moduleB`'s state
#+END_EXAMPLE

Register a module after the store has been created
#+BEGIN_EXAMPLE
// register a module `myModule`
store.registerModule('myModule', {
  // ...
})

// register a nested module `nested/myModule`
store.registerModule(['nested', 'myModule'], {
  // ...
})

store.unregisterModule(moduleName)
#+END_EXAMPLE

**** Module local state and rootState
#+BEGIN_EXAMPLE
const moduleA = {
  state: { count: 0 },
  mutations: {
    increment (state) {
      // `state` is the local module state
      state.count++
    }
  },

  getters: {
    doubleCount (state, rootState) {
      // rootState is root state
      return state.count * 2 + rootState.count
    }
  }

  actions: {
    incrementIfOddOnRootSum ({ state, commit, rootState }) {
      // local state
      if ((state.count + rootState.count) % 2 === 1) {
        commit('increment')
      }
    }
  }
}
#+END_EXAMPLE

**** Namespace
Namespaced getters and actions will receive localized getters, dispatch and commit. In other words, you can use the module assets without writing prefix in the same module.
#+BEGIN_EXAMPLE
const store = new Vuex.Store({
  modules: {
    account: {
      namespaced: true,

      // module assets
      state: { ... }, // module state is already nested and not affected by namespace option
      getters: {
        isAdmin () { ... } // -> getters['account/isAdmin']
      },
      actions: {
        login () { ... } // -> dispatch('account/login')
      },
      mutations: {
        login () { ... } // -> commit('account/login')
      },

      // nested modules
      modules: {
        // inherits the namespace from parent module
        myPage: {
          state: { ... },
          getters: {
            profile () { ... } // -> getters['account/profile']
          }
        },

        // further nest the namespace
        posts: {
          namespaced: true,

          state: { ... },
          getters: {
            popular () { ... } // -> getters['account/posts/popular']
          }
        }
      }
    }
  }
})
#+END_EXAMPLE

In component
#+BEGIN_EXAMPLE
computed: {
  ...mapState({
    a: state => state.some.nested.module.a,
    b: state => state.some.nested.module.b
  })
},
methods: {
  ...mapActions([
    'some/nested/module/foo',
    'some/nested/module/bar'
  ])
}
#+END_EXAMPLE

Or this
#+BEGIN_EXAMPLE
computed: {
  ...mapState('some/nested/module', {
    a: state => state.a,
    b: state => state.b
  })
},
methods: {
  ...mapActions('some/nested/module', [
    'foo',
    'bar'
  ])
}
#+END_EXAMPLE

Or
#+BEGIN_EXAMPLE
import { createNamespacedHelpers } from 'vuex'

const { mapState, mapActions } = createNamespacedHelpers('some/nested/module')

export default {
  computed: {
    // look up in `some/nested/module`
    ...mapState({
      a: state => state.a,
      b: state => state.b
    })
  },
  methods: {
    // look up in `some/nested/module`
    ...mapActions([
      'foo',
      'bar'
    ])
  }
}
#+END_EXAMPLE

**** rootGetters
#+BEGIN_EXAMPLE
modules: {
  foo: {
    namespaced: true,

    getters: {
      // `getters` is localized to this module's getters
      // you can use rootGetters via 4th argument of getters
      someGetter (state, getters, rootState, rootGetters) {
        getters.someOtherGetter // -> 'foo/someOtherGetter'
        rootGetters.someOtherGetter // -> 'someOtherGetter'
      },
      someOtherGetter: state => { ... }
    },

    actions: {
      // dispatch and commit are also localized for this module
      // they will accept `root` option for the root dispatch/commit
      someAction ({ dispatch, commit, getters, rootGetters }) {
        getters.someGetter // -> 'foo/someGetter'
        rootGetters.someGetter // -> 'someGetter'

        dispatch('someOtherAction') // -> 'foo/someOtherAction'
        dispatch('someOtherAction', null, { root: true }) // -> 'someOtherAction'

        commit('someMutation') // -> 'foo/someMutation'
        commit('someMutation', null, { root: true }) // -> 'someMutation'
      },
      someOtherAction (ctx, payload) { ... }
    }
  }
}
#+END_EXAMPLE

**** Namespace in Plugin Development
<<<vue:plugin:vuex:namespace in plugin>>>
#+BEGIN_EXAMPLE
// get namespace value via plugin option
// and returns Vuex plugin function
export function createPlugin (options = {}) {
  return function (store) {
    // add namespace to plugin module's types
    const namespace = options.namespace || ''
    store.dispatch(namespace + 'pluginAction')
  }
}
#+END_EXAMPLE

*** option:strict, strict mode
In strict mode, whenever Vuex state is mutated outside of mutation handlers, an error will be thrown. This ensures that all state mutations can be explicitly tracked by debugging tools.
#+BEGIN_EXAMPLE
const store = new Vuex.Store({
  // ...
  strict: process.env.NODE_ENV !== 'production'
})
#+END_EXAMPLE

*** option:watch
watch(getter: Function, cb: Function, options?: Object)

Reactively watch a getter function's return value, and call the callback when the value changes. The getter receives the store's state as the only argument. Accepts an optional options object that takes the same options as Vue's vm.$watch method.

To stop watching, call the returned handle function.

*** option:plugin
plugins option that exposes hooks for each mutation. A Vuex plugin is simply a function that receives the store as the only argument
#+BEGIN_EXAMPLE
const myPlugin = store => {
  // called when the store is initialized
  store.subscribe((mutation, state) => {
    // called after every mutation.
    // The mutation comes in the format of `{ type, payload }`.
  })
}

const store = new Vuex.Store({
  // ...
  plugins: [myPlugin]
})
#+END_EXAMPLE

*** App Structure, Example
[[https://github.com/vuejs/vuex/tree/dev/examples/shopping-cart][Shopping Cart Example]]
#+BEGIN_EXAMPLE
├── index.html
├── main.js
├── api
│   └── ... # abstractions for making API requests
├── components
│   ├── App.vue
│   └── ...
└── store
    ├── index.js          # where we assemble modules and export the store
    ├── actions.js        # root actions
    ├── mutations.js      # root mutations
    └── modules
        ├── cart.js       # cart module
        └── products.js   # products module
#+END_EXAMPLE

./api/shop.js
#+BEGIN_EXAMPLE
/**
 * Mocking client-server processing
 */
const _products = [
  {"id": 1, "title": "iPad 4 Mini", "price": 500.01, "inventory": 2},
  {"id": 2, "title": "H&M T-Shirt White", "price": 10.99, "inventory": 10},
  {"id": 3, "title": "Charli XCX - Sucker CD", "price": 19.99, "inventory": 5}
]

export default {
  getProducts (cb) {
    setTimeout(() => cb(_products), 100)
  },

  buyProducts (products, cb, errorCb) {
    setTimeout(() => {
      // simulate random checkout failure.
      (Math.random() > 0.5 || navigator.userAgent.indexOf('PhantomJS') > -1)
        ? cb()
        : errorCb()
    }, 100)
  }
}
#+END_EXAMPLE

./store/index.js
#+BEGIN_EXAMPLE
import Vue from 'vue'
import Vuex from 'vuex'
import * as actions from './actions'
import * as getters from './getters'
import cart from './modules/cart'
import products from './modules/products'
import createLogger from '../../../src/plugins/logger'

Vue.use(Vuex)

const debug = process.env.NODE_ENV !== 'production'

export default new Vuex.Store({
  actions,
  getters,
  modules: {
    cart,
    products
  },
  strict: debug,
  plugins: debug ? [createLogger()] : []
})
#+END_EXAMPLE

./store/modules/products.js
#+BEGIN_EXAMPLE
import shop from '../../api/shop'
import * as types from '../mutation-types'

// initial state
const state = {
  all: []
}

// getters
const getters = {
  allProducts: state => state.all
}

// actions
const actions = {
  getAllProducts ({ commit }) {
    shop.getProducts(products => {
      commit(types.RECEIVE_PRODUCTS, { products })
    })
  }
}

// mutations
const mutations = {
  [types.RECEIVE_PRODUCTS] (state, { products }) {
    state.all = products
  },

  [types.ADD_TO_CART] (state, { id }) {
    state.all.find(p => p.id === id).inventory--
  }
}

export default {
  state,
  getters,
  actions,
  mutations
}
#+END_EXAMPLE

./components/App.vue
#+BEGIN_EXAMPLE
<template>
  <div id="app">
    <h1>Shopping Cart Example</h1>
    <hr>
    <h2>Products</h2>
    <product-list></product-list>
    <hr>
    <cart></cart>
  </div>
</template>

<script>
import ProductList from './ProductList.vue'
import Cart from './Cart.vue'
export default {
  components: { ProductList, Cart }
}
</script>
#+END_EXAMPLE

./component/ProductList.vue
#+BEGIN_EXAMPLE
<template>
  <ul>
    <li v-for="p in products">
      {{ p.title }} - {{ p.price | currency }}
      <br>
      <button
        :disabled="!p.inventory"
        @click="addToCart(p)">
        Add to cart
      </button>
    </li>
  </ul>
</template>

<script>
import { mapGetters, mapActions } from 'vuex'
export default {
  computed: mapGetters({
    products: 'allProducts'
  }),
  methods: mapActions([
    'addToCart'
  ]),
  created () {
    this.$store.dispatch('getAllProducts')
  }
}
</script>
#+END_EXAMPLE

** Dev - Webpack Template
*** Basics
Install node module vue-cli
#+BEGIN_EXAMPLE
npm install -g vue-cli
vue init webpack my-project
cd my-project
npm install
npm run dev
#+END_EXAMPLE

Other template can be used

#+BEGIN_EXAMPLE
# vue init <template-name> <project-name>
vue init webpack-simple my-project
# Template on github
vue init username/repo my-project
# Template on Bitbucket
vue init bitbucket:username/repo my-project
# for a tag or branch
vue init bitbucket:username/repo#branch my-project
# local template
vue init ~/fs/path/to-custom-template my-project
#+END_EXAMPLE

[[https://vuejs-templates.github.io/webpack/structure.html][Webpack Template Doc]]

*** npm
Default port is 8080 and it can be auto adjusted.
It loads the [[https://github.com/vuejs-templates/webpack][vuejs-templates/webpack]]
npm run dev includes
- webpack + vue-loader for single file Vue components
- state preserving hot-reload
- state preserving compilation error overlay
- Lint-on-save with ESLint
- Source maps

npm run build :: build for production
- UglifyJS
- html-minifier https://github.com/kangax/html-minifier
- CSS across all components extracted into a single file and minified with [[https://github.com/ben-eb/cssnano][cssnano]]
- Static assets compiled with versio hashes for efficient long-term caching and an auto-generated production index.html with proper URLs to these generated assets
- Use ~npm run build --report~ to build with bundle size analytics

npm run unit :: unit tests run in PhantomJS with Karma + Mocha + karma-webpack
- support ES2015+ in test files
- support all webpack loaders
- easy mock injection

num run e2e :: end-to-end tests with Nightwatch
- run tests in multiple browsers in parallel
- works with one command out of the box
  - Selenium and chromedrive dependencies automatically handled
  - automatically spawns the Selenium Server

*** Structure
#+BEGIN_EXAMPLE
.
├── build/                      # webpack config files for dev and prod. Don't touch unless to customize Webpack loaders
│   └── ...                     # e.g. webpack.base.conf.js
├── config/
│   ├── index.js                # main project config. vue:webpack:integrate backend
│   └── ...
├── src/                        # app files
│   ├── main.js                 # app entry file
│   ├── App.vue                 # main app component
│   ├── components/             # ui components
│   │   └── ...
│   └── assets/                 # module assets (processed by webpack)
│       └── ...
├── static/                     # pure static assets (directly copied and not processed by Webpack)
├── test/
│   └── unit/                   # unit tests
│   │   ├── specs/              # test spec files
│   │   ├── index.js            # test build entry file
│   │   └── karma.conf.js       # test runner config file
│   └── e2e/                    # e2e tests
│   │   ├── specs/              # test spec files
│   │   ├── custom-assertions/  # custom assertions for e2e tests
│   │   ├── runner.js           # test runner script
│   │   └── nightwatch.conf.js  # test runner config file
├── .babelrc                    # babel config
├── .postcssrc.js               # postcss config
├── .eslintrc.js                # eslint config
├── .editorconfig               # editor config
├── index.html                  # index.html template. Webpack will generate assets and auto inject into it during dev and builds.
└── package.json                # build scripts and dependencies
#+END_EXAMPLE

*** Linter configuration
Modify ./.eslintrc.js
Add under rule
#+BEGIN_EXAMPLE
"semi": [2, "always"]
#+END_EXAMPLE

Preset standard is set. [[https://github.com/standard/standard/blob/master/docs/RULES-en.md][Checkout all the rules]].

*** CSS Pre-processor
This boilerplate has pre-configured LESS, SASS, Stylus adn PostCSS.
Just install the appropriate webpack loader.

#+BEGIN_EXAMPLE
npm install sass-loader node-sass --save-dev
#+END_EXAMPLE

After, in *.vue components
#+BEGIN_EXAMPLE
<style lang="scss">
/* write SASS! */
</style>
#+END_EXAMPLE

lang="scss" corresponds to the CSS-superset syntax (with curly braces and semicolons).
lang="sass" corresponds to the indentation-based syntax.

Standalone CSS Files
Import global and custom style files from your root App.vue component
#+BEGIN_EXAMPLE
<!-- App.vue -->
<style src="./styles/global.less" lang="less"></style>
#+END_EXAMPLE

For other 3rd party, e.g. Bootstrap, place them inside /static and reference them directly in index.html.

*** Processed Static Assets => /src/assets
In *.vue components, all templates and CSS are parsed by vue-html-loader and css-loader to look for asset URLs.

~<img src="./logo.png">~ and ~background: url(./logo.png)~, is a relative asset path and will be resolved by Webpack as a module dependency.

These assets may be inlined/copied/renamed during build.

Recommended :: put each component in its own directory with its static assets right next to it and continue to use relative path.

- Relative URLs :: e.g. ./assets/logo.png will be interpreted as a module dependency. They will be replaced with an auto-generated URL based on your Webpack output configuration.

- Non-prefixed URLs :: e.g. assets/logo.png will be treated the same as the relative URLs and translated into ./assets/logo.png.

- URLs prefixed with ~ :: are treated as a module request, similar to require('some-module/image.png'). You need to use this prefix if you want to leverage Webpack's module resolving configurations. For example if you have a resolve alias for assets, you need to use <img src="~assets/logo.png"> to ensure that alias is respected.

- Root-relative URLs :: e.g. /assets/logo.png are not processed at all.

Files in ./src/assets/ or any webpack processed assets may be copied to $(build.assetsRoot)$(build.assetsSubDirectory)

If assets are inserted via JavaScript like computed property, you need to do it in this way
#+BEGIN_EXAMPLE
computed: {
  background () {
    return require('./bgs/' + this.id + '.jpg')
  }
}
#+END_EXAMPLE

Limitation :: all images under ./bgs/ will be included in the final build.

Files in ./static/ will be directly copied to $(build.assetsPublicPath)$(build.assetsSubDirectory). Refer to vue:webpack:config:index.js

Files in ./static/ should be referenced as absolute path like /static/[filename]. If $(build.assetsSubDirectory) is changed, you need to change in the reference as well.

*** Integrate with Backend
<<<vue:webpack:integrate backend>>>
**** Proxy requests to a backend
In ~config/index.js~, edit dev.proxyTable option
Proxy the request /api/posts/1 to http://jsonplaceholder.typicode.com/posts/1.
#+BEGIN_EXAMPLE
module.exports = {
  // ...
  dev: {
    proxyTable: {
      // proxy all requests starting with /api to jsonplaceholder
      '/api': {
        target: 'http://jsonplaceholder.typicode.com',
        changeOrigin: true,
        pathRewrite: {
          '^/api': ''
        }
      }
    }
  }
}
#+END_EXAMPLE

It uses [[https://github.com/chimurai/http-proxy-middleware][http-proxy-middleware]]

#+BEGIN_EXAMPLE
proxyTable: {
  '**': {
    target: 'http://jsonplaceholder.typicode.com',
    filter: function (pathname, req) {
      return pathname.match('^/api') && req.method === 'GET'
    }
  }
}
#+END_EXAMPLE

**** Backend path
Default ./config/index.js
<<<vue:webpack:config:index.js>>>
#+BEGIN_EXAMPLE
var path = require('path')

module.exports = {
  build: {
    index: path.resolve(__dirname, 'dist/index.html'),
    // has to be absolute
    // e.g. path.resolve(__dirname, 'resources/views/index.blade.php'),

    assetsRoot: path.resolve(__dirname, 'dist'), // final after build is /dist/static
    // path.resolve(__dirname, 'public/');

    assetsSubDirectory: 'static', // changing this also means absolute paths for real static assets need to be changed 
    assetsPublicPath: '/',
    productionSourceMap: true
  },
  dev: {
    port: 8080,
    proxyTable: {}
  }
}
#+END_EXAMPLE

*** .vue file vue-loader
.vue file name
Add attribute ~lang~ to chnage language :: <style lang="sass">

<template> :: default html, 0 or 1 template block.
<script> :: default js (ES2015 if babel-loader or buble-loader exists). - or 1 script block. require() can be used. With ES2015, import and export can also be used. The result is to export a Vue.js component option object. An extended constructor created by Vue.extend() can also be exported.

<style> :: default css. 
- Multiple blocks. 
- Can have scoped or mobile attributes.
- vue:loader:scoped css, vue:loader:css modules
- can have mixed encapsulation modes

**** scoped css
<<<vue:loader:scoped css>>>

Scoped to current component.

#+BEGIN_EXAMPLE
<style scoped>
.example {
  color: red;
}
</style>

<template>
  <div class="example">hi</div>
</template>
#+END_EXAMPLE

Parent component's styles will not leak into child components.
However, a child component's root node will be affected by both the parent's scoped CSS and the child's scoped CSS.
So that the parent can style the child root element for layout purpose.

Deep selector
#+BEGIN_EXAMPLE
<style scoped>
.a >>> .b { /* ... */ }
</style>

// will be compiled into
.a[data-v-f3f3eg9] .b { /* ... */ }

// may use /deep/ combinator instead for >>> in other pre-processors, like SASS
#+END_EXAMPLE

**** CSS Modules
<<<vue:loader:css modules>>>
https://vue-loader.vuejs.org/en/features/css-modules.html

** Ajax, axios
https://github.com/axios/axios
https://rubyplus.com/articles/5051-Using-vue-cli-and-axios-in-Vue-js-2

#+BEGIN_EXAMPLE
npm install axios --save

// just import it and use it wherever you want
<script>
  import axios from 'axios'

  export default {
    name: 'app',
    data: function () {
      return {
        articles: []
      }
    },
    methods: {
      fetchArticles: function () {
        axios.get('http://localhost:3000/articles').then((response) => {
          this.articles = response.data
        }, (error) => {
          console.log(error)
        })
      }
    },
    mounted: function () {
      this.fetchArticles()
    }
  }
</script>
#+END_EXAMPLE
* Prerender.io
https://github.com/prerender/prerender

Install middleware on .htaccess to rewrite search engine traffic to prerender server

example.com is your site and its .htaccess is
#+BEGIN_EXAMPLE
# Change YOUR_TOKEN to your prerender token and uncomment that line if you want to cache urls and view crawl stats
# Change http://example.com (at the end of the last RewriteRule) to your website url

<IfModule mod_headers.c>
    #RequestHeader set X-Prerender-Token "YOUR_TOKEN"
</IfModule>

<IfModule mod_rewrite.c>
    RewriteEngine On

    <IfModule mod_proxy_http.c>
        RewriteCond %{HTTP_USER_AGENT} baiduspider|facebookexternalhit|twitterbot|rogerbot|linkedinbot|embedly|quora\ link\ preview|showyoubot|outbrain|pinterest|slackbot|vkShare|W3C_Validator [NC,OR]
        RewriteCond %{QUERY_STRING} _escaped_fragment_
        
        # Only proxy the request to Prerender if it's a request for HTML
        RewriteRule ^(?!.*?(\.js|\.css|\.xml|\.less|\.png|\.jpg|\.jpeg|\.gif|\.pdf|\.doc|\.txt|\.ico|\.rss|\.zip|\.mp3|\.rar|\.exe|\.wmv|\.doc|\.avi|\.ppt|\.mpg|\.mpeg|\.tif|\.wav|\.mov|\.psd|\.ai|\.xls|\.mp4|\.m4a|\.swf|\.dat|\.dmg|\.iso|\.flv|\.m4v|\.torrent|\.ttf|\.woff))(.*) http://service.prerender.io/http://example.com/$2 [P,L]
    </IfModule>
</IfModule>
#+END_EXAMPLE

Install prerender on prerender server
#+BEGIN_EXAMPLE
$ git clone https://github.com/prerender/prerender.git
$ cd prerender
$ npm install
$ node server.js
#+END_EXAMPLE

Prerender will now be running on http://localhost:3000. If you wanted to start a web app that ran on say, http://localhost:8000, you can now visit the URL http://localhost:3000/http://localhost:8000 to see how your app would render in Prerender.

:3000/http://:8000 may return something that is 504. Don't worry it will work after Rewrite.

Change options in ./server.js

For better result, add this to every page and search engine will add ~?_escaped_fragment_=~ to the URL
#+BEGIN_EXAMPLE
<meta name="fragment" content="!">
#+END_EXAMPLE

html5 push state :: URL ~http://example.com/user/1~ becomes ~http://example.com/user/1?_escaped_fragment_=~
hashbang :: ~http://example.com/#!/user/1~ becomes ~http://example.com/?_escaped_fragment_=/user/1~

* SEO
** Google Analytics
Under Admin, you can build Views. Views can have Filters. Views collect data.
Changes on Views and Filters will affect future data only.

Under Views, there're a lot of reports. Apply Segments to reports to filter out data 
without destroying Views data.

*** Bounce
A bounce is counted when there's only one pageview in one user session

*** Add Google Search Console to a property
There will be a new section in the report called Search Console
Need to go back to Search Console to see keywords report
GA shows keyword only for non-google-logged-in users that use google to search

*** Campaigns and Goals track across user session
*** Channel is the traffic source :: organic search, direct, referral, social, etc.
*** Behavior is content :: Speed, Search, Events
*** Conversions :: Goals, Ecommerce, Multi-Channel Funnels, Attribution
*** Goal vs Event
http://www.metricmogul.co.uk/5-simple-differences-between-goals-and-events-in-google-analytics-and-when-to-use-them/

- A goal provides additional data such as conversion rate
- A goal will only record once per session. Newsletter sign up twice with 2 emails, only one conversion is recorded.
- An event can be anything. A goal has to be a destination, duration, pages per session or based on an event.
- A goal can be based on an event. 
- Goal flow report.

Events are good for
- Downloaded file (shows which pages have the pdf file link)
- Link (outbound)

*** Filter applied on View
You should always have a View without Filters to capture all data.

A Filter is to filter out the types of traffic you don't want and save the data to your View.
- Filter might take 24 hours to activate
- Filter will limit the stats data from the moment it is fully activated

In order to show only traffic that are on a set of pages, you can:
- Figure out a Regex statement and use it as the filter that is inside the View > Default Segment.
  ○ You can't save this filter. You have to do it manually every time you want the report
  ○ You can see the filtered results right away and you can see previous stats
- Use javascript to submit Custom Variable on those pages and set to Page-level. 
  ○ Create a new View with Admin > Property > View > Filter 
  ○ You have to wait 24 hours to let the stats to be recorded from then
  ○ You can't see the previous stats

You can refer to this for constructing your ga:regex in Admin > Property > View > Filter or the normal filter.

*** Segment
A Segment is to filter out the ~user sessions~ that you don't want without destroying your View data.

Say you have 2 segments: All Users and New Users. Metrics inside each type of report will be divided into 2 so that you can compare.

Say you want to use Segment to only include user sessions that have been to a url.
Go to the newly created Segment, you will still see those user sessions have been to other pages.

*** Tracking Code :: gtag.js, analytics.js
The most recent version is gtag.js. [[https://developers.google.com/analytics/devguides/collection/gtagjs/][Documentation]]. [[https://developers.google.com/analytics/devguides/collection/gtagjs/migration][Migrate from analytics.js to gtag.js]].
The most recent version is analytics.js. [[https://developers.google.com/analytics/devguides/collection/analyticsjs/][Documentation is here.]]

*** Regular Expressions <<<ga:regex>>>
https://support.google.com/analytics/answer/1034324?hl=en

Use ~\~ to escape. Need to escape ~.~

http://www.mysite.com/shopping?qsrc=35&o=0&x=ref&stf=CA:LO&q=lava+lamp

Use ~(q=[^&]*)~ to grab ~q=lava+lamp~ in Request URI

*** ga Object Methods

*** Track Object Methods

There're different methods in Tracker Object

ga('method_name',...);

*** send
Used in ga:goal and funnel
You can send an action of a hitType with corresponding fields

ga('[trackerName.]send', [hitType], [...fields], [fieldsObject]);

Use ga:fieldsObject

**** hitType: pageview
Used in ga:goal and funnel
ga('send', 'pageview', [page], [fieldsObject]);

*** get(fieldName)

*** set(fieldName|fieldsObject, [fieldValue])

*** fieldsObject
<<<ga:fieldsObject>>>

**** hitCallback

#+BEGIN_EXAMPLE
var form = document.getElementById('signup-form');

// Adds a listener for the "submit" event.
form.addEventListener('submit', function(event) {

  // Prevents the browser from submitting the form
  // and thus unloading the current page.
  event.preventDefault();

  // Sends the event to Google Analytics and
  // resubmits the form once the hit is done.
  ga('send', 'event', 'Signup Form', 'submit', {
    hitCallback: function() {
      form.submit();
    }
  });

  // or 
  ga('send', 'event', 'Signup Form', 'submit', {
    transport: 'beacon'
  });
  
  form.submit();
});
#+END_EXAMPLE

*** Funnel and Goal (send pageview)
<<<ga:goal and funnel>>>
Goal is defined in Admin > Account > Property > View
Funnel is step to a Goal.

Goal or funnel must use the pageview hitType.

When path is very dynamic, you may need to send pageview with a static path in order to capture goal or funnel destination URL.

And you may need to filter out those destination URL's in another GA View. Don't filter the current GA View.

View the Virtual Pageview in Reporting > Real-Time > Content
View the converted goal in real time Reporting > Real-Time > Conversions

#+BEGIN_EXAMPLE
ga('send', 'pageview', '/ga_goal/goal1/goal1_variant1.html');
ga('send', 'pageview', '/ga_goal/goal1/goal1_variant2.html');
ga('send', 'pageview', '/ga_goal/goal1/step1/goal1_variant1.html');
ga('send', 'pageview', '/ga_goal/goal1/step2/goal1_variant1.html');
...
#+END_EXAMPLE

*** Scroll (send event)
Reporting > Behavior > Events
Category > Action > Label > Value

Syntax: 
gtag('event', eventName, eventParameters);
ga('send', 'event', [eventCategory], [eventAction], [eventLabel], [eventValue], [fieldsObject]);

eventName :: string is eventAction

#+BEGIN_EXAMPLE
gtag('event', 'play', {
  'event_category': 'Videos',
  'event_label': 'Fall Campaign'
});
#+END_EXAMPLE

#+BEGIN_EXAMPLE
<script>
// scroll depth compared to the root element
var element_to_track = 'html';
var scroll_reach = 0;
var temp_scroll_reach = 0;
var scroll_reach_pixels = 0;
var temp_scroll_reach_pixels = 0;

$(window).scroll(function(){
  temp_scroll_reach = Math.floor(
    100 *
    ( $(window).scrollTop() + $(window).height() - $(element_to_track).position().top)
    / $(element_to_track).height()
  );
  temp_scroll_reach_pixels =
    Math.floor($(window).scrollTop() + $(window).height());
  if(temp_scroll_reach > scroll_reach){
    scroll_reach = temp_scroll_reach;
    scroll_reach_pixels = temp_scroll_reach_pixels;
  }
});

function sendGAreq() {
  // Old ga.js
  // _trackEvent(category, action, opt_label, opt_value, opt_noninteraction)
  //_gaq.push(['_trackEvent', 'Scroll Depth', 'Percentage', '', scroll_reach]);
  //_gaq.push(['_trackEvent', 'Scroll Depth', 'Pixels', '', scroll_reach_pixels]);
  // New analytics.js
  // ga('send', 'event', [eventCategory], [eventAction], [eventLabel], [eventValue], [fieldsObject]);
  ga('send', 'event', 'Scroll Depth', 'Percentage', '', scroll_reach);
  ga('send', 'event', 'Scroll Depth', 'Pixels', '', scroll_reach);
}

/* report only after a user exists the website */
$(window).bind('beforeunload', function() {sendGAreq();});
</script>
#+END_EXAMPLE

*** Filter (View)
Custom Filter - Advanced

Extract 2 values from 2 fields (Field A and B), and output that to a field.

The output field can be a Custom Field or a system field (e.g. Request URI, override the field value) or a User Defined value.

Request URI includes URL parameters but without domain and protocol

Custom Field 1 and 2 are used only in filters. Appears on GA report Audience > Custom > Custom Variables

User Defined value can be set in javascript and it's a single value. Appears on GA report Audience > Custom > User Defined

Example, only include traffic that URI has utm_source=MV_* and utm_medium=email

Advanced Filter
Field A (utm_source=MV_[^&]*)
Field B (utm_medium=email)
Output to Custom Field 1: $A1&$B1

Setting Field 1 and 2 are required, Override Output Field

Custom Filter
Include, Custom Field 1, utm_source=[^&]*&utm_medium=email

*** Too Many Self-referrals
Reporting > Acquisition > All Traffic > Referrals, you will find the website's url is the source
And the percentage is high compared to other Referral Sources.
3 reasons:
1. Users sessions idle for 30 minutes and become active. This should be < 10% of traffic
2. Cross domain (need to bring it down to 0 self-referral)
3. A lot of traffic and sessions are created by spammers to a landing page 
(most likely homepage with url parameters)  with a fake referral path as the website.

Click on the website URL (referral source), you will see Referral Path (that's From traffic)
Add secondary dimension "Full Referrer" to see the referrer's domain and full path.

Since self-referrals can be faked and real self-referrals should be small amount, you can filter out
self-referrals in GA.

Go to Admin > Account > Property > Tracking Info > Referral Exclusion List > add domain
abc.com also matches www.abc.com because domain name CONTAINS

You cannot use View Filter to filter out referral domain...

You can also create a segment without affecting the data. 
Conditions > Filter: Sessions, Exclude > Source / Medium > contains > OHG.com / referral

** Google Search Console
Position is the average of the topmost position.
A keyword with position 1 and only 1 impression means there's a user search that keyword and it happens the url appears at position 1.
Different users have different search results.

Add a new property for https if the website is upgraded from http. Stats are separated.

Google recommends creating 2 properties per root domain per schema (http/https). domainroot.com and www.domainroot.com

https://support.google.com/webmasters/

** Google Trends
A B
- must contain both words
- order doesn't matter
- other words can be added before, after or in-between
- Spelling is exact

"A B"
- exact phrase inside double quotation marks
- other words can only be added before or after

A + B
- A or B

A - B
- contain A but exclude B

center + centre + centere
- include alternative spellings. Consider each version of a word a different search.

Special characters
Apostrophe, single quotes and parentheses will be ignored
~women's tennis world ranking~ you get result for ~womens tennis world ranking~

Terms vs Topics
- Term is literal match
 - banana matches "banana sandwich"
 - "banana sandwich" matches "banana for lunch" and "peanut butter sandwich"

- Topic is a group of terms that share the same concept in any language.
 - London matches "capital of the UK"
 - also matches "Londres" which is London in Spanish

** Keyword, Google Keyword Planner, Google AdWords
Page title 65 characters. A list of keywords (<=3) with separators can be used. Order matters.
Only one <h1>

*** Hiking > hike > backpacking > backpack
*** Google AdWords
Default broad match :: ~hiking tour northern california~
  - match with queries with any order and any additional words
  - match with synonyms
  - partial match is allowed "best hiking" query matches ~hiking tour northern california~
Phrase match with double quotes :: any queries match ~"hiking tour northern california"~ in any order with additional words
Exact match and only these words :: ~[hiking tours northern california]~

~-dog~, ~-wallpaper~, ~-screensavers~, ~-pictures~ to ignore queries that have this negative word

** Link building, Search Visibility
Website A has 10 links to your site and website B has 5 links to your site.

You have 2 domains (linking root domains) that have a total of 15 links (external links) to your site.

Followed vs nofollow links.

Search Visibility represents estimated click-through rate based on the average ranking position of all of your tracked keywords.
e.g. CTR of position #1 is 33-45%.

** ObservePoint
Site audit :: check js errors, GA tagging, etc.

** Moz.com
Moz uses Jumpshot's clickstream data combined with Google AdWords.

*** Free tools
Keyword Explorer :: free for 20 queries per month
MozBar :: Chrome extension to show Page Authority, Domain Authority, MozRank, MozTrust

*** Keyword Explorer
Some other competitors are Raven SEO Tools, SEMrush.com, WordTracker
Pro :: 5k queries per month
Difficulty
- Low :: 20-35
- Middle :: 36-50
- Tough :: 51-65
- Very difficult :: 66-80

Usually you should invest on high volume keyword with lower difficulty.

When you search on Google, it tells number of results. The more results means more competition.

Keyword Analysis is about to analyze how people use keywords to search content that you provide (e.g. you provide California Vacations)
- Groups :: food? activity?
- Concepts
- Phrase pattern :: people search vacation ideas more than vacation packages
- Prefix
- Suffix
- Synonyms
- Plurals :: people use singular when they want to be specific and plurals when they want general info

*** Open Site Explorer (Pro)

** Optimize Images
https://moz.com/ugc/10-tips-for-optimizing-your-images-for-search

Google Image sitemaps https://support.google.com/webmasters/answer/178636
Google Image guildlines https://support.google.com/webmasters/answer/114016

** SERP Features
https://moz.com/blog/mega-serp-a-visual-guide-to-google
https://moz.com/learn/seo/serp-features

** Remove URL from Google Index
This is to permanently remove a url from Google Search
- Make the URL return 404 or 410 status
- Don't block access to that URL using robots.txt
- Return meta tag ~<meta name="robots" content="noindex, nofollow">~
- Return `X-Robots-Tag` HTTP header
#+BEGIN_EXAMPLE
<Files ~ "\.pdf$">
  Header set X-Robots-Tag "noindex, nofollow"
</Files>

$apacheURL = (strlen($_SERVER['REQUEST_URI'])) ?
  substr($_SERVER['REQUEST_URI'],1) : $_SERVER['REQUEST_URI'];
$noIndexNoFollow = array(
  "~^subscriber-services/trucking-renewal(.*)~i",
  "~^lookup-subscription(.*)~i",
  "~^users/(.*)~i",
  "~^user/(.*)~i",
);

if (!empty($apacheURL)) {
  foreach ($noIndexNoFollow as $key => $value) {
    $matches = array();
    if (preg_match($value, $apacheURL, $matches)) {
      header("X-Robots-Tag: noindex, nofollow", true);
    }
  }
}
#+END_EXAMPLE

Go to Google Search Console and Fetch as Google to manually tell Google update index for that URL 
To check if the URL is removed: Make a [[https://www.google.com/webmasters/tools/removals][removal request]] and it will tell you if the URL is removed.

** robots.txt
Default
#+BEGIN_EXAMPLE
User-agent: *
Disallow: /wp-admin/
Disallow: /wp-content/plugins/
Disallow: /readme.html
Disallow: /refer/

Sitemap: http://www.codeinwp.com/post-sitemap.xml

# Allow a useragent
# User-agent: PowerMapper
# Allow: /
#+END_EXAMPLE

* UX
** Optimal Workshop
Usability Testing
Tree testing :: test how well readers can find specific content through navigation
Card sorting :: how readers would sort or categorize content sections
First click testing :: what is the first click if readers want specific content?

* Linux
** Explain Shell
[[http://explainshell.com][Explain Shell]]

** System Version, Distro

| =uanme -a=          | all info     |
| =uname -r=          | Kernal       |
|                     |              |
| =cat /etc/*release= | Linux distro |
| =cat /etc/issue=    |              |
| =cat /proc/version= |              |
| =lsb_release -a=    | Ubuntu only  |
|                     |              |

** Environment and Shell Variables
Child processes inherit the environmental variables of the parent process.

List all env. variables :: ~printenv~ or ~env~
Get an env. variable :: ~printenv HOME~ or ~echo $HOME~

Set an env. variable for the current shell and all processes started from current shell :: ~export TERM=xterm-256color~
Set an env. variable using a shell variable :: ~export TEST_VAR~

Set variable only for current shell :: VARNAME="value"

Set permanently for all future bash sessions, add such line to .bashrc file in $HOME
Set permanently and system wide (all users, all processes) add set variable in /etc/environment
~sudo nano /etc/environment~, then logout from current user and login again.

Use ~env~ to modify the environment that programs run in
#+BEGIN_EXAMPLE
env VAR1="blahblah" command_to_run command_options
#+END_EXAMPLE

List all variables - shell, environmental, local and shell functions :: ~set~
List only shell and environmental variables only :: ~(set -o posix; set)~

Shell and env. variables should in uppercase while local variables should be in lowercase

Set a shell variable :: ~TEST_VAR='Hello World!'~
Confirm a variable is not an env. variable :: ~printenv | grep TEST_VAR~
Search a variable :: ~set | grep TEST_VAR~

Demote an env. variable to shell variable :: ~export -n TEST_VAR~
Unset a shell or env. variable :: ~unset TEST_VAR~


| PWD    | Current directory                           |
| OLDPWD | Previous directory. ~cd -~                  |
| _      | The most recent previously executed command |
|        |                                             |
|        | Shell Variables                             |
|        |                                             |

** User Management, Superuser, sudo
*** Create and delete a user, Add user to sudo group
<<<linux:user>>>
=sudo adduser corey=
=sudo deluser corey=

sudo is a group
As root user, run this to add the user to the sudo group
#+BEGIN_EXAMPLE
gpasswd -a username sudo
# or
# usermod -aG sudo username
#+END_EXAMPLE

gpasswd is the same as to add user to a group
#+BEGIN_EXAMPLE
sudo usermod -aG agroupname ausername
# -aG keeps the existing groups the user belongs to and add the user to another group
#+END_EXAMPLE

Use useradd for non-interactive (Docker)
=--usergroup, -U= :: Create a group with the same nanme as the user. 
=--create-home, -m= :: Create home directory if does not exist.
=--shell, -s= :: Assign a default shell for this user. ~/bin/false~ returns false then exit (logout).
#+BEGIN_EXAMPLE
useradd --user-group --create-home --shell /bin/false newusername
#+END_EXAMPLE

=-o -u 1000= :: change UID to 1000, -o is to allow duplicate UID

*** User Group
Run ~visudo~ to see permissions given to each group
And check sudo environment variable setting

#+BEGIN_EXAMPLE
root ALL=(ALL:ALL) ALL
#+END_EXAMPLE
User root can run sudo as all hosts (1st ALL), all users, all groups and apply to all commands.

Start with % means is a group
#+BEGIN_EXAMPLE
%sudo   ALL=(ALL:ALL) ALL 
#+END_EXAMPLE

Which group a user belongs to ~groups username~

[[https://www.digitalocean.com/community/tutorials/how-to-edit-the-sudoers-file-on-ubuntu-and-centos][More info]]

*** List all users =cut -d: -f1 /etc/passwd` or `cat /etc/passwd=
- Login username
- Password (always x)
- UID (<500 are system accounts, > 500 are users)
- Group ID (GID)
- Comment field
- Location of HOME directory
- Default shell for the user

*** Switch to superuser 
- Debian =sudo su=
- RedHat =sudo -=

*** Login to another user, Run command as another user
Login (need to type password) ~/bin/su - username~
Run as a user (need to type password) ~/bin/su - username -c 'whoami'~

As root user, run as another user without typing password ~sudo -H -u username bash -c 'whoami'~
Where -H is to use the target user's home directory

*** Sudo run multiple commands
~sudo bash -c 'apt-get update;apt-get install'~

*** Pass password as a file to sudo
<<<linux:sudo:password>>>
~sudo -S your_script -var1 </path/to/file.txt~

*** Require no password when sudo is run as another user
<<<linux:sudo:nopassword>>>
User abc has sudo privilege. When abc is signed in and run a script/command that requires sudo, system will ask for password
~sudo ./path/to/script.sh~

Bypass so password input is not required

Instead of changing ~/etc/sudoers~ file directly, create/edit a file ~/etc/sudoers.d/mybypass~
#+BEGIN_EXAMPLE
# See if there are some sample
sudo ls -al /etc/sudoers.d/
# found one sample
sudo cat /etc/sudoers.d/mybypass
# have to use visudo to edit /etc/sudoers and /etc/sudoers.d/anyfile files.
# -f is to specify a file, otherwise is the default /etc/sudoers file
sudo visudo -f /etc/sudoers.d/mybypass
# Add this line
abc ALL = (root) NOPASSWD: /path/to/script.sh
# allow user abc on ALL hosts to run a specific command without entering password
# all other sudo commands will still require a password

# ~/etc/sudoers.d/mybypass file should have permission 0440 and owner:group is root:root
#+END_EXAMPLE

** SSH
<<<linux:ssh>>>

*** Transfer Client Key to Host
Generate a private key on your local machine ~ssh-keygen -t rsa~
Under folder ~/Users/username/.ssh/~ id_rsa.pub is the public key and id_rsa is the private key
Show the public key and later copy to cloud server
~cat ~/.ssh/id_rsa.pub~

When using private key you might encounter ~Permissions 0777 for '~/.ssh/id_rsa_your_private_key' are too open~
Use ~chmod 400 ~/.ssh/id_rsa_your_private_key~ to fix it

**** Manual way
On the remote server, login as a normal user ~sudo su - username~
Create ~/.ssh directory ~mkdir .ssh~ ~chmod 700 .ssh~
Create file and paste the public key ~nano .ssh/authorized_keys~

Or concatenate it onto ~authorized_keys~ file manually
#+BEGIN_EXAMPLE
# backup first
cp authorized_keys authorized_keys_Backup
cat id_rsa.pub >> authorized_keys
#+END_EXAMPLE

Change permission ~chmod 600 .ssh/authorized_keys~

Add a name to id_rsa.pub
#+BEGIN_EXAMPLE
cat yourpubkey.pub
ssh-rsa longstring yourname@yourhost
#+END_EXAMPLE

**** Fast way
This will append the client public key to remote host's ~/.ssh/authorized_keys
~ssh-copy-id remoteusername@123.45.56.78~
Or specify a public key file
~ssh-copy-id -i ~/.ssh/mykey remoteusername@123.45.56.78~

**** Remove passphrase for private key id_rsa
#+BEGIN_EXAMPLE
# Make a backup
cp ~/.ssh/id_rsa ~/.ssh/id_rsa.backup
rm ~/.ssh/id_rsa

# remove passphrase
openssl rsa -in ~/.ssh/id_rsa -out ~/.ssh/id_rsa_new
# enter old passphrase
cp ~/.ssh/id_rsa_new ~/.ssh/id_rsa
#+END_EXAMPLE

*** ssh config
Create ssh host alias and the private key to use in =~/.ssh/config= file
cd ~/.ssh && nano config, ~chmod 600 ~/.ssh/config~
#+BEGIN_EXAMPLE
Host scotch
    HostName scotch.io
    User nick

Host example2
    HostName example.com
    User root

Host example3
    HostName 64.233.160.0
    User userxyz123
    Port 56000
    ServerAliveInterval 240
    ServerAliveCountMax 2

Host amazon1
    HostName ec2.amazon.com
    User ec2-user
    IdentityFile /path/to/special/privatekey/amazon.pem
#+END_EXAMPLE

Sends a packet to the server every 240 seconds (4 minutes). If the client does not receive a response after 2 tries, it closes the connection.

In Putty, under Connection > Seconds between keepalives > 240

*** Use Private Key from SSH Server to connect
AWS uses .pem file as the private key on its SSH server.
Convert this .pem file in PuttyGen and later uses it to connect to AWS
Refer to aws:ssh

*** Restart SSH
General :: ~service ssh restart~
Ubuntu :: ~sudo systemctl reload sshd~ (16.04) or ~sudo systemctl restart sshd~ (16.04) or ~sudo restart ssh~ (14.04)

*** Backup sshd_config file
#+BEGIN_EXAMPLE
sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.factory-defaults
sudo chmod a-w /etc/ssh/sshd_config.factory-defaults
#+END_EXAMPLE

*** Disallow SSH as root user, SSH Daemon Config
<<<linux:ssh:disallow_root>>>
Login as root then
~nano /etc/ssh/sshd_config~
Change ~PermitRootLogin yes~ to no
Restart SSH
Before logout, open another terminal to see if it works.

Default SSH port is 22

*** Disable Password Authentication
Force to use public key only instead of plain password only
~nano /etc/ssh/sshd_config~
Replace ~#PasswordAuthentication yes~ with ~PasswordAuthentication no~
These are supposed to be default. If not, change to as below
#+BEGIN_EXAMPLE
PubkeyAuthentication yes
ChallengeResponseAuthentication no
#+END_EXAMPLE

Restart SSH

*** Random password

#+BEGIN_EXAMPLE
# base64 will likely to have = at the end, remove that to have length 16
openssl rand -base64 17

# hex has only number and lowercased letters
openssl rand -hex 16
#+END_EXAMPLE

*** SSH tunneling
Port forwarding is also called tunneling.

Say your IMAP port 143 to gmail is blocked by Wi-fi firewall. 

Default ssh port is 22. Default https port is 443.

For Github and BitBucket, you can directly change to use port 443 without doing anything.

If you have control of the target server's ssh server, simply just add port 443 to /etc/ssh/sshd_config and use -p 443 locally.

#+BEGIN_EXAMPLE
Host github.com
  Hostname ssh.github.com
  Port 443

Host bitbucket.org
  Hostname altssh.bitbucket.org
  Port 443
#+END_EXAMPLE

**** Port Forwarding via a single intermediate host
In the intermediate host with ssh server installed, add the line ~Port 443~ to /etc/ssh/sshd_config, ~sudo systemctl reload sshd~, ~sudo ufw allow 443/tcp~

Check if it connects from local ~ssh -p 443 my.server.com~

Then open, listen and forward port 10143 to destination imap.google.com at port 143 using intermediate host at 443
#+BEGIN_EXAMPLE
ssh -L localhost:10143:mail.google.com:143 -p 443 user@my.server.com
#+END_EXAMPLE

Refer to network:port on port range you should use

Change email client setting to use localhost at port 10143

Multiple redirections can be set up in the same tunnel
#+BEGIN_EXAMPLE
# add -f to go into background and -N to not launch a shell
ssh -L localhost:10143:mail.google.com:143 localhost:10022:target.server.com:22 -p 443 user@my.server.com
#+END_EXAMPLE

#+BEGIN_EXAMPLE
ssh -p 10022 target_server_user@localhost
scp -P 10022 localhost:/target/server/path/ /local/path/
rsync -av -e "ssh -p 10022" /target/server/path localhost:/local/path/
#+END_EXAMPLE

**** SOCKS server
Run a SOCKS server on a given port, and set applications to use SOCKS, either natively or forcibly.
When the app uses SOCKS, all its network connections are routed through the SOCKS server which forwards it to all your server on internet.

Open port 443 on my.server.com like the above solution.

Install tsocks on localhost ~sudo apt-get install tsocks~ and configure tsocks, /etc/tsocks.conf, near the end, change it to
#+BEGIN_EXAMPLE
server -127.0.0.1 port = 1080
#+END_EXAMPLE

Bind traffic to local port 1080 to the jump host. Run locally
~ssh -D 1080 -p 443 user@my.server.com~

Run applications using tsocks. Run locally:
~tsocks skype tsocks kopete tsocks kmail tsocks ftp someserver.com tsocks ssh user@target.server.com~

Notes
- FTP has to be in passive mode
- Some applications might not support tsocks

** fail2ban
<<<linux:fail2ban>>>
Ban access to services (e.g. SSH) for max tries and ban time based on service's log.

Check if it's installed ~ll /etc/fail2ban~

Install ~sudo apt-get update~ ~sudo apt-get install fail2ban~
Create jail.local based on jail.conf by commenting out every line
#+BEGIN_EXAMPLE
awk '{ printf "# "; print; }' /etc/fail2ban/jail.conf | sudo tee /etc/fail2ban/jail.local
#+END_EXAMPLE

Modify jail.local ~sudo nano /etc/fail2ban/jail.local~

By default, fail2ban is enabled for sshd service only and disabled for every service (allow every access).
#+BEGIN_EXAMPLE
[DEFAULT]
ignoreip = 127.0.0.1/8
# 600 seconds = 10 minutes
bantime = 600
maxretry = 3
# 3 tries within 10 minutes
findtime = 600

# For a service, fail2ban can search if a log file has certain text and mark it as a authentication failure
[nginx-http-auth]
enabled = true
# regex pattern is defined in /etc/fail2ban/filter.d/ngix-http-auth.conf
# You usually don't modify these .conf files
#+END_EXAMPLE

Restart the service ~sudo service fail2ban restart~

To see which service has fail2ban enabled ~sudo fail2ban-client status~

To see detail about a service that has fail2ban enabled ~sudo fail2ban-client status sshd~

To unban an IP for service ~sudo fail2ban-client set apache unbanip 111.111.111.111~

[[https://www.digitalocean.com/community/tutorials/how-to-protect-ssh-with-fail2ban-on-ubuntu-14-04][More info]]

[[https://www.digitalocean.com/community/tutorials/how-to-protect-an-apache-server-with-fail2ban-on-ubuntu-14-04][Apache and fail2ban]]

** System 
Resource Limits
=sudoedit /etc/security/limits.conf=

System Logs
| /var/log/syslog   | general system log                         |
| /var/log/auth.log | system auth logs                           |
| /var/log/mail.log | system mail logs                           |
| /var/log/messages | general log messages                       |
| /var/log/dmesg    | kernel ring buffer msg, e.g. system bootup |
|                   |                                            |

Search a word `warthog` in .gz files
=zgrep -i warthog /var/log/*.gz= 

** Filesystem
*** /dev /mnt /media
=/dev/sd*1= :: sd for SATA or SCSI drive, numeric 1 for partition, * for a, b, etc.
=/dev/hd*1= :: hd for IDE drive, * for a, b, etc.
=/media/win1=
 - virtual directory  where files are accessed file here. 
 - Equivalent to d:\. One or more partitions can be assigned to one media

=sudo mkdir /media/win2= :: create a virtual directory is easy
=sudo mkdir /mnt/my_mount= :: also creates a virtual directory

=sudo mount -t ext4 /dev/sda1 /mnt/my_mount= :: Mount a partitioned device to a virtual directory
=sudo gedit /etc/fstab=
, =/dev/hdb1 media/win1 vfat users,rw,owner,umask=000 0 0=
, then reload =sudo mount -a=
- Permanently mount during bootime

*** /etc system configuration files
*** Disk space
| =df -h=                 | Disk usage on OS                                    |
|                         | h for human-readable.                               |
| =du -sh=                | Current folder size. -s shows total only            |
| =du -sh ./*=            | List sizes of 1st level child folders and files     |
| =du -sh ./wp-content/*= | List sizes of 1st level child folders of one folder |
|                         |                                                     |

Disk usage in current folder including all sub folders but excluding one sub folder
du --exclude=./wp-content/uploads --exclude=./wp-content/error_log -sh

du --exclude-from 'path/to/files.txt'

#+BEGIN_EXAMPLE
# Only get down to 1 level. When max-depth > 0, -s cannot be used.
du --max-depth=1 -h

# sort by size
du --max-depth=1 -h | sort -h

# Do not count subdirectories size
du --max-depth=1 -Sh
#+END_EXAMPLE

*** File permission
**** Change permission - chmod
Octal mode. [[https://chmod-calculator.com/][Convert to Octal Mode]] [[http://permissions-calculator.org/decode/][Convert to Permissions Bit]]
#+BEGIN_EXAMPLE
chmod 400 ~/path/to/file.php
#+END_EXAMPLE

| Permissions | Binary | Octal | Description       |
| ---         |    000 |     0 | No permissions    |
| --x         |    001 |     1 | Execute only      |
| -w-         |     10 |     2 | Write only        |
| -wx         |     11 |     3 | Write and execute |
| r--         |    100 |     4 | Read-only         |
| r-x         |    101 |     5 | Read and execute  |
| rw-         |    110 |     6 | Read and write    |
| rwx         |    111 |     7 | full              |
|             |        |       |                   |

owner-group-public

400 :: r-------- e.g. ssh private keys in ~/.ssh/
440 :: read for owner and group, but none for public
555 :: read and execute (can't modify) for all
700 :: full for owner
*755 :: rwxr-xr-x (e.g. wordpress directory) Default directory permission and default executable file permission <<<chmod:755>>>
*777 :: -rwxrwxrwx Directory's full permission
600 :: owner can read and write file
*644 :: -rw-r--r-- (e.g. wordpress .php files) <<<chmod:644>>>
*660 :: rw-rw---- (e.g. wp-config.php) <<<chmod:660>>>
666 :: anyone can read and write. File full permission. <<<chmod:666>>>
664 :: rw-rw-r-- <<<chmod:664>>>

By default, umask is 0022. 
A file's full permission is 666. So new file has this default permission: 666-022 = 644
A directory's full permission is 777. So new directory has default permission: 777-022 = 755

Return umask simply run ~umask~

Permanently set umask in ~/.bashrc =umask 0022=

chmod a-w /path/to/afile

u = user that owns the file
g = group that owns the file
o = other (everyone else)
a = all (everybody)

r = read, w = write, x = execute

a-w :: remove write permission for all

wp:check file permissions

**** Change owner:group for a folder - chown
#+BEGIN_EXAMPLE
sudo chown -R user:group aFolder
#+END_EXAMPLE

List files or directories that are not a user or group
#+BEGIN_EXAMPLE
find . -type d -not -group test -o -type f -not -user test
#+END_EXAMPLE

*** Symbolic Link
Symbolic link abc at user home folder, point it to existing folder xyz at user home folder
#+BEGIN_EXAMPLE
# ln -s source_file myfile
ln -s ~/xyz ~/abc
# Relative Path
# you are at ~/abc/xyz, you want to creat ~/abc/xyz/sym to point to existing folder ~/abc/efg/source
ln -s ../eft/source/ sym
#+END_EXAMPLE

Directly go to the actual folder by calling ~/abc
#+BEGIN_EXAMPLE
cd -P ~/abc
#+END_EXAMPLE

*** Search Files or Directories, Sort by size <<<bash:find>>>
By file or directory name
#+BEGIN_EXAMPLE
ls -l my_scr?pt
ls -l my*
ls -l my_s*t
ls -l my_scr[ai]t
ls -l f[a-i]ll
ls -l f[!a]ll
#+END_EXAMPLE

<<<linux:find>>> :: Return path of matched files or directories

Search by name of files :: -name -iname
#+BEGIN_EXAMPLE
find ./targetFolder -type f -name "abc*"
#+END_EXAMPLE

Name case insensitive use -iname instead of -name

Search by name of directories
#+BEGIN_EXAMPLE
find ./targetFolder -type d -name "abc*"
#+END_EXAMPLE

Combine search criteria
AND
#+BEGIN_EXAMPLE
# Start with abc and file extension is php
find -name 'abc*' -name '*.php'

# Start with abc and file extension is not php
find -name 'abc*' ! -name '*.php'
#+END_EXAMPLE

OR
#+BEGIN_EXAMPLE
find -name '*.php' -o -name '*.txt'
#+END_EXAMPLE

Search by size (K, M, G for kb, mb and gb)
#+BEGIN_EXAMPLE
find . -type f -size +10000K
#+END_EXAMPLE

Search by modified date
#+BEGIN_EXAMPLE
# Search text files that are modified less than 14 days ago
find . -type f -mtime -14 ! -iname '*.jpg' ! -iname '*.png'

# Modified between 50 and 100 days ago
find . -type f mtime +50 -mtime -100
#+END_EXAMPLE

Recent modified files recursive (file status change)
#+BEGIN_EXAMPLE
# last 5 minute
find -cmin -5
# Last day 1440, Last 31 days 44640
#+END_EXAMPLE

~-iname~ case insensitive while ~-name~ is case sensitive

Chain find command with other commands
#+BEGIN_EXAMPLE
# {} is each result of find.
# \; denotes the end of ls command
find . -size +100M -exec ls -lh {} \;
#+END_EXAMPLE

Get top 10 largest files in current folder
#+BEGIN_EXAMPLE
find . -type f -exec du -Sh {} + | sort -rh | head -n 10
#+END_EXAMPLE

Assume it's at ~ folder, and here's the structure
#+BEGIN_EXAMPLE
~/1/2/3
~/a/1/2/3
~/afile
#+END_EXAMPLE

At ~, ~find .~ will return
#+BEGIN_EXAMPLE
./1
./a
/afile
#+END_EXAMPLE

The depth of ~./1~ and ~./a~ is 1.

While at ~, =find ~/= will return
#+BEGIN_EXAMPLE
/home/user/1
/home/user/a
/home/user/afile
#+END_EXAMPLE

The depth of =/home/user/1= and =/home/user/a= related to =~= is 1

To find any folder that is named ~1~ but not at first level
#+BEGIN_EXAMPLE
find ~ -mindepth 1 -iname 1
#+END_EXAMPLE

File count and Exclude Path
#+BEGIN_EXAMPLE
# Exclude abc/.git directory
find abc/ -type f -not -path "abc/.git/*" | wc -l
# If abc is the current directory
find . -type f -not -path "./.git/*" | wc -l

# Count for files and folders
find . | wc -l
#+END_EXAMPLE

Check file permissions wp:check file permissions

*** Search Text in Files
<<<linux:grep>>>

#+BEGIN_EXAMPLE
grep --color -HRi "google.com" /root/dir

# Only file names
grep --color -HRi "abc" /root/dir | cut -d: -f1

# Unique file names
grep --color -HRi "abc" /root/dir | cut -d: -f1 | sort -u

# Exclude file types
grep --color -HRi --exclude=\*.{pdf,jpg,JPG,mp3,png,bmp,sql} "abc" .

# Return 5 trailing lines and 10 leading lines for each match
grep -A 5 -B 10 prefork.c /etc/httpd/conf/httpd/conf
#+END_EXAMPLE

- --color :: hightlight
- -H :: return only the file names
- -R :: recursive
- -i :: ignore case 
- -I :: process binary files as if they don't contain matching data
- -A NUM :: number of trailing lines of text
- -B NUM :: number of leading lines of text

*** Folder structure
#+BEGIN_EXAMPLE
which tree
# apt-get install tree
# list only folders without files
tree -d test/

# list everything
tree test/

# List first level child folder only for the current folder
tree -d -L 1
#+END_EXAMPLE

*** Compare files in 2 directories
#+BEGIN_EXAMPLE
diff --brief -Nr dir1/ dir2/
# -N shows difference of file existance

diff -r dir1/ dir2/
# shows text comparison as well
#+END_EXAMPLE

*** Compare text files
#+BEGIN_EXAMPLE
diff file1.txt file2.txt
# < means the line belongs to the left file
# > means the line belongs to the right file
#+END_EXAMPLE

*** Delete folders with a name
#+BEGIN_EXAMPLE
# Test it first
find ~/www -iname WEB-INF -exec ls {} \;
# Delete files in those folders
find ~/www -iname WEB-INF -exec rm -rf {} \;
#+END_EXAMPLE

*** cp <<<bash:cp>>>
#+BEGIN_EXAMPLE
# Copy a sub folder abc/ in the current directory to a new directory ~/xyz with everything preserved
cp -a abc/ ~/xyz

# Duplicate subfolder abc and name it xyz
cp -a abc xyz
#+END_EXAMPLE

-a :: -dR --preserve=all
-d :: --no-dereference --preserve=links
-P, --no-dereference :: never follow symbolic links in SOURCE
-R :: recursive

*** tar
**** Compress and Read .tar file
#+BEGIN_EXAMPLE
# /home/targetFolder
cd /home
tar -cvzpf backup.tar.gz targetFolder

# Read .tar file
tar -tf backup.tar
# Read .tar.gz file
tar -tzf backup.tar.gz

# Count number of files
tar -tzf backup.tar.gz | wc -l

# targetFolder/index.html
# targetFolder/subfolder/index.html
# ...

# Exclude a folder
tar -cvzpf backup.tar.gz targetFolder --exclude='wp-content/uploads' --exclude='anotherFolder'

# Compress the current folder and save the archive in current folder
cd /home/targetFolder
tar -cvzpf backup.tar.gz .
# Compress the current folder and save the archive in one level above
tar -cvzpf ../backup.tar.gz .

# The archive structure is
# ./index.html
# ./subfolder/index.html
# ...
#+END_EXAMPLE

Options
- -z :: use gzip method
- -c :: create a new archive
- -v :: verbose
- -p :: preserve permissions (default for superuser)
- -f :: use archive file as result or input. It follows the output/input filename
- --exclude :: wrap in '' if it contains spaces
- --exclude='*/*/*' :: ignore 3 levels deep

**** Uncompress
#+BEGIN_EXAMPLE
# Read the tar file first
tar -tf backup.tar.gz

# If file structure is
# targetFolder/index.html
# targetFolder/subfolder.html ...
# And put targetFolder so that /anotherfolder/targetFolder
# Copy .tar.gz to /anotherfolder
cd /another
tar -xvzf backup.tar.gz

# If you don't want to copy .tar.gz to /anotherfolder, 
tar -xvzf /any/path/to/backup.tar.gz -C /anotherfolder

# If file structure is
# ./index.html
# ./subfolder/index.html ...
# Then copy backup.tar.gz to /anotherfolder/targetFolder
cd /anotherfolder/targetFolder
tar -xvzf backup.tar.gz

# tar -xvzf /any/path/to/backup.tag.gz -C /anotherFolder/targetFolder

# Uncompress file.gz, not file.tar.gz, 
gzip -d file.gz 
# The gz file will disappear
#+END_EXAMPLE

Options
- -x :: extract

*** rsync
Dry run first: ~rsync -rlvzuPn --size-only $SOURCE $DESTINATION~

By default, rsync finds files that need to be transferred using a "quick check" algorithm that looks for files that have changed in size or in last-modified time. Any changes in the other preserved attributes (as requested by options) are made on the destination file directly when the quick check indicates that the file's data does not need to be updated.

-I, --ignore-times: Normally rsync will skip any files that are already the same size and have the same modification timestamp. This option turns off this “quick check” behavior, causing all files to be updated.

--size-only: This modifies rsync’s “quick check” algorithm for finding files that need to be transferred, changing it from the default of transferring files with either a changed size or a changed last-modified time to just looking for files that have changed in size. This is useful when starting to use rsync after using another mirroring system which may not preserve timestamps exactly.

-u: skip files that are newer in $DESTINATION

--delete: To delete extra files from the receiving side (ones that aren't on the sending side), but only for the directories that are being synchronnized. By default, rsync does not delete files on the receiving side.

-r: recursive
-l: symlink
-z: compress
-v: verbose
-i: Very useful! Display change-summary for all updates, also use with --stats
-P: --progress --partial, show progress and to resume interrupted transfers 
-n: dry run

-t: actually is very crucial. This tells rsync to transfer modification times along with the files and update them on the remote system. Unless --size-only is used, missing -t or -a will cause the next transfer to behave as if it used -I, causing all files to be updated.
	
This command will not sync files with different permissions, ownership and modification time.
Review the results and remove dry run `-n` before running again.

-a: -rlptgoD
-p: the receiving rsync to set the destinaion permissions to be the same as the source permissions.
-g: To set the group of the destination file to be the same as the source file. Only if dest is run as super-user
-o: To set the owner of the destination file to be the same as the source file. Only if dest is run as super-user
-D: is equivalent to ~--devices --specials~

--devices: To transfer character and block device files to the remote system to recreate these devices.
--specials: To transfer special files such as named sockets and fifos.

--stats: show file-transfer stats: number of files, number of files transferred, Total file size in bytes, Total transferred file size

--chown :: refer to -og, change owner:group on dest

--exclude 'public_html/database.txt': exclude a file

--exclude-from '/home/backup/exclude.txt': exclude multiple files and folders

exclude.txt
#+BEGIN_EXAMPLE
sources
public_html/database.*
downloads/test/*
#+END_EXAMPLE

**** Change summary, compare 2 directories
rsync -rlvzPitn --size-only wp-content/themes/my-theme/ sshconfighostname:/var/www/mylivesite/wp-content/themes/my-theme/
#+BEGIN_EXAMPLE
.d..t...... ./
<f.st...... footer.php
<f.st...... front-page.php
.f..t...... functions.php
<f.st...... header.php
.f..t...... index.php
.f..t...... page--coupon-image_tpl.php
.f..t...... page--coupons_tpl.php
.f..t...... style.css
.d..t...... lb/
cd+++++++++ lb/api-localbusiness/
<f+++++++++ lb/api-localbusiness/cf-form-post.php
<f+++++++++ lb/api-localbusiness/cf-form-post_rel0.php
<f+++++++++ lb/api-localbusiness/cf-form-post_rel2.php
.d..t...... lb/css/
.f..t...... lb/css/font.css
<f.st...... lb/css/style.css
.d..t...... lb/font/
.d..t...... lb/font/trade-gothic/
.f..t...... lb/font/trade-gothic/bold.eot
.f..t...... lb/font/trade-gothic/bold.otf
.d..t...... lb/img/
.f..t...... lb/img/alectra-logo.eps
.d..t...... lb/img/bg/
.f..t...... lb/img/bg/lp-bg_001.jpg
.f..t...... lb/img/bg/lp-bg_002.jpg
.d..t...... lb/img/icons/
.f..t...... lb/img/icons/contact.png
.f..t...... lb/img/icons/social-facebook.png
.d..t...... lb/img/icons/coupon/
.f..t...... lb/img/icons/coupon/icon-01.svg
.f..t...... lb/img/icons/coupon/icon-02.svg
.d..t...... lb/img/logos/
.f..t...... lb/img/logos/brampton-hydro.png
.f..t...... lb/img/logos/enersource.png
.d..t...... lb/js/
.f..t...... lb/js/app.js
.f..t...... lb/js/bicubic-interpolation.js
#+END_EXAMPLE

YXcstpoguax

Y is update type
- < means a file is being transferred to the remote
- > means a file is being transferred to the local
- c means a local change/creation is occuring for the item (on the receiving side)
- h means the item is a hard link to another item
- . means the item is not being updated (though it might have attributes that are modified)
- * means the rest of the itemized-output area contains a message (e.g. "deleting")

X is file-type :: f for a file, d for directory, L for symlink, D for a device, S for a special file (named sockets and fifos)

cstpoguax are attributes. 
- "." stands for no change. 
- A newly created item replaces each letter with a "+"
- An identical item replaces the dots with spaces
- An unknown attribute replaces each letter with a "?" (could happen when talking to an older rsync)

- c: checksum is different
- s: file size is different and will be updated
- t: modification time is different and is being updated to the sender's value (requires -t or --times)
- T: modification time will be set to the transfer time
- p: permissions are different and are being updated to the sender's value (requires --perms)
- o: owner is different and is being updated to the sender's value (requires --owner)
- g: group is different and is being updated to the sender's value (requires --group)
- u: reserved for future use
- a: ACL information changed
- x: Extended attribute information changed.

**** Examples
#+BEGIN_EXAMPLE
# Dry, recursive, symlink, verbose, compress
# show progress and make it possible to re-rsync if connection is lost
# show changes in detail for each transferred file
# update time on destination
# don't transfer file if dest has mod time newer
# update owner and group on dest to be the same as source
# change owner:group on dest

rsync -rlvzPituogn --chown=www-data:www-data wp-content/ remote:path/to/wp-content
#+END_EXAMPLE

Transfer everything from remote to local
- verbose
- show overall stats
- show individual file log
- show progress and re-sync possible
- compress

#+BEGIN_EXAMPLE
rsync -avziPn --stats $(devhost):$(devhostdir)/wp-content/uploads/ wp-content/uploads
#+END_EXAMPLE

** head, tail
<<<linux:tail>>>

Last 5 lines
#+BEGIN_EXAMPLE
tail -n5 /path/to/file
#+END_EXAMPLE

Keep tailing
#+BEGIN_EXAMPLE
tail -f /var/log/messages
#+END_EXAMPLE

Used in chain
#+BEGIN_EXAMPLE
ls -t | tail -n3
#+END_EXAMPLE

** Processes
| =ps -ef=                   | List of running processes      |
| =sudo ls -l /proc/PID/exe= | file path for command, sub PID |
| =ps -f -p 123=             | List file of a running process |

ps options
- f or F :: full format. F for Ubuntu
- e :: all processes. same as -A
- p :: PID. same as p and --pid

*** pgrep, pkill

#+BEGIN_EXAMPLE
# Search a process by file name, return PID
pgrep newcomgo

# Kill a process by file name
pkill newcomgo
#+END_EXAMPLE

*** Run executable in background for all sessions
This should be enough. If not, use bash:screen
#+BEGIN_EXAMPLE
nohup ./bin/newcomgo &
#+END_EXAMPLE

*** jobs
#+BEGIN_EXAMPLE
# Add ~&~ to put process list into background
(tar -cf 1.tar /home/1; tar -cf 2.tar /home/2)&

# run a script file in background
./test5.sh &

# If terminal session is ended (SIGHUP), background processes will be stopped, too
# Use nohup to block SIGHUP signals being sent to the process
nohup ./test1.sh &
# It produeces a file `nohup.out` in the directory that the script is in which contains STDOUT and STDERR.
# No output to any terminals.

# To prevent background processes from seding error to terminal
./test5.sh 2> /dev/null &
#+END_EXAMPLE

Run ~jobs~ to show what processes are running in background
Use ~jobs -l~ to list the PID
~kill PID~ or ~kill -KILL PID~

*** top <<<linux:top>>>
First line: current time, system up time, number of users logged in, load average (1, 5, 15 minutes; >2 is busy). 
Second line: total processes: running, sleeping, stopped and zombie (have finished but parent process hasn't responded)

Third line: CPU utilization: us (user), sy (system), ni (nice: time running niced user processes), wa (time waiting for I/O completion), hi (time spent servicing hardware interrupts), si (software interrupts), st (stolen from this vm by the hypervisor)

Memory usage
	- Line 1 reflects physical memory: total, used, free and buffers
	- Line 2 reflects virtual memory: total, used, free and cached 

Detailed for each process
| PID  | The process ID of the process             |
| USER | The user name of the owner of the process |
| PR   | The priority of the process               |
| NI   | The nice value of the process             |
	- NI: The nice value of the process
	- VIRT: The total amount of virtual memory used by the process
	- RES: The amount of physical memory the process is using
	- SHR: The amount of memory the process is sharing with other processes
	- S: The process status (D = interruptible sleep, R = running, S = sleeping, T = traced
	- or stopped, or Z = zombie)
	- %CPU: The share of CPU time that the process is using
	- %MEM: The share of available physical memory the process is using
	- TIME+: The total CPU time the process has used since starting
	- COMMAND: The command line name of the process (program started)


Type `f` for interaction: set sort, display more fields/columns

*** Multiple commands && vs || vs ;
Commands behind ; are always run
Command behind && is run only when the previous returns success
Command behind || is always run
So || is the opposite of &&

#+BEGIN_EXAMPLE
false; echo 'yes'
true; echo 'yes'
false && echo 'yes'
false || echo 'yes'
#+END_EXAMPLE

** Memory
Total memory: =grep MemTotal /proc/meminfo=
More info: =cat /proc/meminfo=
Memory usage: =free -ltm -c 2 -s 2= or just =free -m=
Delay 2 seconds and repeat 2 times: =-c 2 -s 2=
=-m=: in megabyte. e.g. -g
=-t=: show Total
=-l=: show Low and High
Another way: =vmstat -s=
To see memory usage for each process, use linux:top or =htop=

** Service
~service --status-all~
- List all services (on '+', off '-', managed by Upstart '?') 

~systemctl~ :: List running services only with more detail

~service~ operates on the files in ~/etc/init.d~ which is an old init system.
~systemctl~ operates on ~/etc/systemd~. File in this folder will be used first otherwise fall back to old init.

** Network
All active NIC and IP addresses: =ifconfig=
All enabled and disabled NIC: =ifconfig -a=
View one NIC (interface): =ifconfig eth0=

Ethernet interface: eth0, eth1
Wireless network interface: wlan0, wlan1
Loopback interface for system internal communication: =lo=

*** /etc/network/interfaces file
For Ubuntu and Debian.
#+BEGIN_EXAMPLE
iface eth0 inet static
# only one address, call static
  address 192.168.1.5
# netmask defines ip's within this range is considered under the same LAN
  netmask 255.255.255.0
# When this machine talks to an ip out of this LAN, a gateway is needed
  gateway 192.168.1.254
# DNS
  dns-nameservers 192.168.1.254 8.8.8.8
#+END_EXAMPLE

Set interface to dhcp
#+BEGIN_EXAMPLE
auto eth0
iface eth0 inet dhcp
#+END_EXAMPLE

After changing interfaces file, turn off and on the interface
#+BEGIN_EXAMPLE
sudo ifdown eth0 && sudo ifup eth0
#+END_EXAMPLE

*** DNS
<<<linux:dns>>>
~/etc/nsswitch.conf~ and the line starting with ~hosts: ~ defines which files Linux should look for the IP of a domain.

#+BEGIN_EXAMPLE
hosts: files mdns4_minimal [NOTFOUND=return] dns
#+END_EXAMPLE

First, ~/etc/hosts~ file.
#+BEGIN_EXAMPLE
127.0.0.1 localhost
127.0.1.1 your-computer-name
# 127.0.1.1 is fine when the computer is a client
# If the machine is a server and it has a static IP, should set it
#+END_EXAMPLE

Second, it's a list of DNS nameservers you define. 
There's a package called ~resolvconf~ which handles the DNS nameservers. I guess if you change /etc/network/interfaces file to use ~dns-nameservers~, it will add nameservers to ~/etc/resolv.conf~ which cannot be changed manually.
Thus, a list of DNS nameservers that are being used can be retrieved ~cat /etc/resolv.conf~

To check if a domain is resovled, these commands are run based on ~/etc/resolv.conf~
#+BEGIN_EXAMPLE
getent hosts google.com
host google.com
dig google.com
#+END_EXAMPLE

dig can only follow through DNS management. If there's redirect done in Apache, Nginx or other codes, it won't follow through them.

Use linux:curl to track further.

dig finds A record
#+BEGIN_EXAMPLE
dig google.com
# Or
dig google.com +short
#+END_EXAMPLE

Query MX record
#+BEGIN_EXAMPLE
dig google.com MX
#+END_EXAMPLE

Query All DNS records
#+BEGIN_EXAMPLE
dig google.com ANY
#+END_EXAMPLE

DNS Reverse Look-up
#+BEGIN_EXAMPLE
dig -x 72.30.38.140
#+END_EXAMPLE

[[https://www.whatsmydns.net/][DNS Propagation Checker]]

*** Get Server's Public IP
<<<linux:get public ip>>>
#+BEGIN_EXAMPLE
ip addr show eth0 | grep inet | awk '{ print $2; }' | sed 's/\/.*$//'
# or
curl http://icanhazip.com
#+END_EXAMPLE

*** CIDR Netmask (Network Mask)
CIDR netmask
- 10.0.75.5/32 = 10.0.75.5 AND 255.255.255.255 = 10.0.75.5 (a single host)
- 10.0.75.5/24 = 10.0.75.5 AND 255.255.255.0 = 10.0.75.0 
	(10.0.75.5 is in the 10.0.75.0 subnet)
- 10.0.75.5/16 = 10.0.75.5 AND 255.255.0.0     = 10.0.0.0
- 10.0.75.5/8  = 10.0.75.5 AND 255.0.0.0       = 10.0.0.0

Private IPv4 address spaces
- 10.0.0.0 - 10.255.255.254 = 10.0.0.0/8 (16 million number of addresses)
- 172.16.0.0 - 172.31.255.255 = 172.16.0.0/12 (255.240.0.0) (1 million number of addresses)
- 192.168.0.0 - 192.168.255.255 = 192.168.0.0/16 (65,536 number of addresses)

Internal network Class A :: 10.0.0.0 - 10.255.255.254 (10.0.0.0/8, total hosts: 16 million)
Internal network Class B :: 172.16.0.1 - 172.16.255.254 (127.16.0.0/16, total hosts: 65,534)
Internal network Class C :: 192.168.0.1 -192.168.0.254 (192.168.0.0/24, total hosts: 254)

*** Port <<<network:port>>>
If a port is in use =telnet localhost 9000=, if it's connected, it's in use.
List all ports in use: =netstat -lp= or =netstat -nlp= to list in numeric form.
Search a port =netstat -nlp | grep 8000=

netstat options
- l :: show only listening sockets
- p :: show PID and name of the program to which each socket belongs.
- n :: show numerical addresses instead of symbolic host, port or user names

List all command files (open files) that are using an Internet address (-i)
~-P~ is to print port number
~lsof -Pi~

Filter any address of port 80 :: ~lsof -i :80~
Full format
#+BEGIN_EXAMPLE
[46][protocol][@hostname|hostaddr][:service|port]

# 4 or 6 for IPv4 or IPv6
#+END_EXAMPLE

It's better to use telnet IP_address port_number in an external computer to connect to a port to check
if it's in use.

In Windows, to see if a port is being used in a local computer
#+BEGIN_EXAMPLE
netstat -an | find "8080"

// From outside, just telnet host port (or telnet host:port on Unix systems) to see if the connection is refused, accepted, or timeouts
#+END_EXAMPLE

Use open ports that are in the range of 1024-49151.
0-1023 are well known ports
1024-65535 are registered ports
49152-65535 are dynamic ports and should not be prescribed to a protocol (e.g. random)

*** Wireless network adapters =iwconfig=

*** Test email address if valid without sending
#+BEGIN_EXAMPLE
nslookup -q=mx gmail.com
#+END_EXAMPLE

You will see this:
#+BEGIN_EXAMPLE
Server:         192.168.1.200
Address:        192.168.1.200#53

Non-authoritative answer:
gmail.com       mail exchanger = 10 alt1.gmail-smtp-in.l.google.com.
gmail.com       mail exchanger = 20 alt2.gmail-smtp-in.l.google.com.
gmail.com       mail exchanger = 5 gmail-smtp-in.l.google.com.
gmail.com       mail exchanger = 30 alt3.gmail-smtp-in.l.google.com.
gmail.com       mail exchanger = 40 alt4.gmail-smtp-in.l.google.com.

Authoritative answers can be found from:
alt1.gmail-smtp-in.l.google.com internet address = 173.194.205.26
alt1.gmail-smtp-in.l.google.com has AAAA address 2607:f8b0:400d:c02::1a
alt2.gmail-smtp-in.l.google.com internet address = 74.125.141.26
alt2.gmail-smtp-in.l.google.com has AAAA address 2607:f8b0:400c:c06::1a
gmail-smtp-in.l.google.com      internet address = 108.177.112.26
gmail-smtp-in.l.google.com      has AAAA address 2607:f8b0:4001:c12::1b
alt3.gmail-smtp-in.l.google.com internet address = 64.233.190.26
alt3.gmail-smtp-in.l.google.com has AAAA address 2800:3f0:4003:c01::1b
alt4.gmail-smtp-in.l.google.com internet address = 209.85.203.26
alt4.gmail-smtp-in.l.google.com has AAAA address 2a00:1450:400b:c03::1a
#+END_EXAMPLE

Choose any one or the root one to telnet
#+BEGIN_EXAMPLE
telnet gmail-smtp-in.l.google.com 25
# if it's connected, it will say 220
# Then you first have to say HELO hi-whatever
HELO hi
# setup a From email, with <> brackets
mail from: <youremail@gmail.com>
# then specify the target email which you want to test
rcpt to: <test@gmail.com>
# If the target email is good, it will say 250 OK
# 550 and its message may say Recipient address rejected: User unknown in virtual alias table
quit
#+END_EXAMPLE

** Firewall 
<<<linux:firewall>>> <<<linux:ufw>>>

Should be installed by default. ~sudo aptitude install ufw~ or ~sudo apt-get install ufw~
~sudo ufw status verbose~ to check if status is active.
~sudo ufw disable~ and ~sudo ufw enable~ to restart firewall
Or just reload ~sudo ufw reload~
~sudo ufw reset~

ufw comes with some profiles each of them is a setting for a service/app. Get all profiles ~sudo ufw app list~
#+BEGIN_EXAMPLE
Available applications:
  Nginx Full
  Nginx HTTP
  Nginx HTTPS
  OpenSSH
#+END_EXAMPLE

Refer to nginx:ufw for further info. 

Default setting is no restriction on outgoing connection, deny all incoming connection

Allow OpenSSH app/profile first ~sudo ufw allow OpenSSH~ then ~sudo ufw enable~ enable ufw

Review setting ~sudo vi /etc/default/ufw~

Make sure ~IPV6=yes~ in setting.
Make sure DEFAULT_FORWARD_POLICY="ACCEPT" if docker is installed

Allow a service ~sudo ufw allow ssh~
Allow a port ~sudo ufw allow 22/tcp~
Allow a port range ~sudo ufw allow 1000:2000/tcp~
Allow an IP ~sudo ufw allow from 192.168.255.255~

Allow HTTP web server ~sudo ufw allow 80/tcp~
Allow SSL/TLS ~sudo ufw allow 443/tcp~
Allow SMTP email ~sudo ufw allow 25/tcp~

List all rules ~sudo ufw status numbered~
Delete a rule ~sudo ufw delete [number]~

Or you can see added rules in command style ~sudo ufw show added~
Then you delete ~sudo ufw delete allow 22~

** Timezone, NTP
<<<linux:timezone>>>
Set timezone first ~sudo dpkg-reconfigure tzdata~

Make sure Network Time Protocol daemon (NTP) is installed ~which ntpd~
Install ~sudo apt-get update~ ~sudo apt-get install ntp~
Do a sync 
~sudo service ntp stop~ 
~sudo ntpd -gq~
~sudo service ntp start~

Port 123 has to be open (but I think the default ufw setting is ok)

For Debian/Ubuntu, /etc/timezone file stores the timezone. Default :: Etc/UTC

All timezones are stored in /usr/share/zoneinfo/$TZ

For Toronto, it's /usr/share/zoneinfo/America/Toronto file but it's a link to Montreal file.

Make this link to /etc/localtime and then change the timezone

Refer to docker:timezone

** Hardware
PCI devices: =lspci=
USB devices: =lsusb=
Most of devices: =lshal=

** Package & Repository
=cat /etc/apt/sources.list=

Repositories
- Main
- Universe: maintained by Ubuntu community
- Backports: newest version of pkg
- Multiverse: not free pkg
- Restricted: hardware drivers etc.

*** Package Management
**** Debian only =yum=
~yum check-update~ only checks if any updates are available for installed packages only.

~yum~ doesn't need to ~apt-get update~ like Ubuntu. In fact, ~yum update~ updates every currently installed package which is equivalent to Ubuntu ~apt-get update; apt-get upgrade~

Try to avoid ~yum upgrade~ as it forces the removal of obsolete packages. Same as ~yum update --obsoletes~

~yum list tree~ to list package 'tree' info

~yum list installed tree~ If it returns error, it means the package tree is not installed.

**** =dpkg= lowest level Ubuntu, Debian
List installed packages: =dpkg -l= 
How to read dpkg output
- First 3 columns show Desired action, Package status and Error flags
- Desired action
  - unknown (u), install (i), hold (h), remove  (r), purge (p)
- Package Status
  - Not-installed :: ~n~
  - Config-files :: ~c~
  - Half-installed :: ~H~
  - Unpacked :: ~U~
  - Half-configured :: ~F~
  - Triggers-awaiting :: ~W~
  - Triggers-pending ::	~t~
  - Installed :: ~i~
- Error flags
  - <empty> = (none), R = Reinst-required

If a package is installed: =dpkg -l wget=
Search if a package is installed: =dpkg -l | grep wget= or ~dpkg -l 'wget*'~

More info of an installed package :: ~dpkg -s openssh-client~

See forward/reverse dependencies of a package use ~apt-cache showpkg javacc~

List files owned by a package =dpkg -L cron=

Find which package owns a file =dpkg -S /etc/crontab=

**** =apt-get= =apt-cache= Ubuntu
Update list of available packages (/var/lib/apt/lists/) :: ~apt-get update~

Install or upgrade a package :: ~apt-get install openssh-client~

To simulate what would happen if you upgrade/install a package (press ~n~ to cancel)
~apt-get -s install openssh-client~

To upgrade all installed packages :: ~apt-get upgrade~

To simulate what would happen if upgrade all (press ~n~ to cancel) :: ~apt-get -V -s upgrade~

Remove previously downloaded packages (/var/cache/apt/archives)
~apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*~ 

For Ubuntu lower than 14.04, use ~dpkg -l~ to list all installed packages on Ubuntu
Otherwise, use ~apt list --installed~

To see if a package is installed :: ~apt list -a --installed openssh-client~

Search package by regex name (return name and description only): =apt-cache search php=
Search packages with name starting php (return names only) :: =apt-cache pkgnames php5=
All packages' names (return names only) :: =apt-cache pkgnames=

Find out dependencies of a package: =apt-cache showpkg php5-xmlrpc=
- Other packages must be installed before php5-xmlrpc (under Dependencies)
- Other packages depend on php5-xmlrpc (under Reverse Depends)
- Different versions of this package you can install (under Provides)

To compare installed version of a package with remote version :: ~apt-cache policy openssh-client~

**** =aptitude= Highest Level Debian
It's not installed by default on Ubuntu
It removes orphan packages automatically

List installed packages :: ~aptitude~

See if a package is installed :: ~aptitude search package_name~
- Before each package name, if you see `i` the package is installed
- package is virtual (installed) :: ~v~
- package is deleted but not configuration files :: ~c~
- no trace at all or ~v~, it's not installed :: ~p~
- There might be a second character which indicates the action to be performed on the package.

*** Ubuntu Packages
**** openssh-client
Includes scp
#+BEGIN_EXAMPLE
apt-get update && apt-get -y install openssh-client
#+END_EXAMPLE

**** sendmail <<<linux:sendmail>>>

#+BEGIN_EXAMPLE
apt-get install sendmail
# get the hostname of the machine/container
hostname
# say hostname is abc123
cat /etc/hosts
# You should see something like this
127.0.0.1 localhost
# add this line to the end
127.0.0.1 localhost localhost.localdomain abc123
# Run the sendmail config, answer Y to everything, sendmail will be restarted after
sudo sendmailconfig
# restart apache
service apache2 restart

# you may need to run sendmailconfig again to do the config
# check other configs
cat /etc/mail/sendmail.conf
cat /etc/cron.d/sendmail
cat /etc/mail/sendmail.mc

# in case you want to restart sendmail
service sendmail restart
# or
/etc/init.d/sendmail restart

# run this to see which emails are sent/stuck in queue
sendmail -bq
#+END_EXAMPLE

You should setup logging in app level, such as php:ini:mail

Executable is /usr/sbin/sendmail

**** ssmtp <<<linux:ssmtp>>>
ssmtp is a simple alternative to linux:sendmail and it doesn't depend on it.
- sendmail can receive emails
- sendmail has mail queues
- ssmtp is good for only one user to send emails

**** postfix <<<linux:postfix>>>
It's more sophisticated than sendmail.
https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-postfix-on-ubuntu-16-04
https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-postfix-as-a-send-only-smtp-server-on-ubuntu-16-04
apt-get install postfix will remove sendmail automatically

**** rtorrent
#+BEGIN_EXAMPLE
apt-get install rtorrent
#+END_EXAMPLE

Press Enter to enter and you will see ~load.normal>~ at the bottom

Paste the link and press enter to load the torrent file, to download it, press up or down arrow and C-s to start the download.

C-q :: quit. Execute twice, it shuts down without sending a stop signal
C-s :: start download
C-d :: Stop an active download or remove an already stopped download
C-k :: stop and close an active download
C-r :: hash check a torrent before upload/download begins
Left or right arrow :: redirect to previous or next screen
Up or down arrow :: to select a torrent file. Selected one will have * in front.

*** Ubuntu troubleshooting
**** Unmet dependencies
Run these
#+BEGIN_EXAMPLE
sudo apt-get clean
sudo apt-get update
sudo apt-get -f install
# check if it returns error that about disk full error
# fix disk full error first
# install the package again
sudo apt-get install make
#+END_EXAMPLE

If it still doesn't work or it has error, run these
#+BEGIN_EXAMPLE
sudo dpkg --configure -a
sudo apt-get -f install
#+END_EXAMPLE

If the output is below, it means it failed.
#+BEGIN_EXAMPLE
0 upgraded, 0 newly installed, 0 to remove and 1 not upgraded.
#+END_EXAMPLE

Next solution is to run
#+BEGIN_EXAMPLE
sudo apt-get -u dist-upgrade
#+END_EXAMPLE

If it shows any held packages, it is best to eliminate them. Packages are held because of dependency conflicts that apt cannot resolve. Try this command to find and repair the conflicts:
#+BEGIN_EXAMPLE
sudo apt-get -o Debug::pkgProblemResolver=yes dist-upgrade
#+END_EXAMPLE

If it cannot fix the conflicts, it will exit with:
0 upgraded, 0 newly installed, 0 to remove and 6 not upgraded.

Delete the held packages one by one, running dist-upgrade each time, until there are no more held packages. Then reinstall any needed packages. Be sure to use the --dry-run option, so that you are fully informed of consequences:
#+BEGIN_EXAMPLE
sudo apt-get remove --dry-run package-name
#+END_EXAMPLE

Since removing the package you are trying to install may not be ideal, you might also try finding a repository that has the packages you need to satisfy the dependencies.

Finally, if all else fails, you can attempt to satisfy the dependencies yourself, either by finding and installing the necessary packages, or by installing them from source and then creating “deb” packages for them.

https://askubuntu.com/questions/140246/how-do-i-resolve-unmet-dependencies-after-adding-a-ppa

**** /boot directory is full
If it's full 100% ~df -h~, all apt commands will not run.

Run this to get installed kernels except the currently running one.
#+BEGIN_EXAMPLE
sudo dpkg --list 'linux-image*'|awk '{ if ($1=="ii") print $2}'|grep -v `uname -r`
#+END_EXAMPLE

Also keep track of the 2 newest versions. ~uname -r~ to check the current kernel version. e.g.
#+BEGIN_EXAMPLE
linux-image-4.4.0-31-generic
linux-image-4.4.0-36-generic
linux-image-4.4.0-38-generic
linux-image-4.4.0-42-generic
linux-image-4.4.0-45-generic
linux-image-4.4.0-47-generic
linux-image-4.4.0-51-generic
linux-image-4.4.0-53-generic
linux-image-extra-4.4.0-31-generic
linux-image-extra-4.4.0-36-generic
linux-image-extra-4.4.0-38-generic
linux-image-extra-4.4.0-42-generic
linux-image-extra-4.4.0-45-generic
linux-image-extra-4.4.0-47-generic
linux-image-extra-4.4.0-51-generic
linux-image-extra-4.4.0-53-generic
#+END_EXAMPLE

Current kernel version is 4.4.0-34-generic

Remove other kernels except the current one and the 2 newest ones.

#+BEGIN_EXAMPLE
# before delete, check which will be deleted first
ll /boot/*-4.4.0-{31,36,38,42,45,47}-*
sudo rm -rf /boot/*-4.4.0-{31,36,38,42,45,47}-*
#+END_EXAMPLE

~df -h~ will show the space is reduced. Fix apt-get
#+BEGIN_EXAMPLE
sudo apt-get -f install
#+END_EXAMPLE

If you run into an error that includes a line like "Internal Error: Could not find image (/boot/vmlinuz-3.2.0-56-generic)", then run the command ~sudo apt-get purge linux-image-3.2.0-56-generic~ (with your appropriate version).

Now apt-get should work. Finally, ~sudo apt-get autoremove~ to clear out the old kernel image packages that have been orphaned by the manual boot clean.

Run ~sudo apt-get update~ and maybe ~sudo apt-get upgrade~ after.

https://askubuntu.com/a/430944/481813

** Input and Output
*** File Descriptors
File descriptors. First 3 are reserved.
| 0 | STDIN  | Standard input         |
| 1 | STDOUT | Standard output (echo) |
| 2 | STDERR | Standard error         |

#+BEGIN_EXAMPLE
# Redirect stdout, creates if not exist or overwrites a file
ls -al goodfile > stdoutlogfile
# same as 2>, 3> etc.

# Redirect stdout, creates if not exist or appends to a file
ls -al goodfile >> stdoutlogfile
# same as &>>, 2>>, 3>> etc.

# Redirect stderr
ls -al badfile 2> errorlogfile

# Redirect stdout and stderr to different files
ls -al goodfile badfile 2> errorlogfile 1> normalOutput

# Redirect stdout and stderr to the same file
ls -al goodfile badfile &> errorAndOutput
#+END_EXAMPLE

<<<bash:tee>>>

#+BEGIN_EXAMPLE
# Redirect stdout of a commannd to a file and display stdout
date | tee testfile

# Redirect stdout to a file and pass stdout to another command as stdin
date | tee testfile | less

# Capture stdout of a command to a variable
output=$(date)

# Capture stdout and stderr of a command to a variable
output=$(command_which_has_stdout_and_stderr 2>&1)

# Redirect stdout of a command to one or multiple files and save stdout to a variable
# a file must be behind a tee command
# By default tee overwrites the file. Use -a to append to the end
$output = $(date | tee testfile1 testfile2)

# Redirect stdout to a variable and display to terminal in real time (not to stdout!)
# Works on Ubuntu and RedHat
$output = $(date | tee /dev/tty)

# Redirect one file descriptor (M, default 1) to another file descriptor (N) M>&N
# Redirect a manually made error 
echo "This is an error" >&2

# Change a file descriptor to a file
exec 2>errorLogFile
echo "This is STDOUT and STDOUT is not changed to a file yet"
exec 1>stdOutFile
echo "This doesn't display as STDOUT is redirected to a file"
echo "This is an error and in errorLogFile" >&2
#+END_EXAMPLE

Up to 9 open file descriptors can be used at a time.
#+BEGIN_EXAMPLE
# Open a custom file descriptor to a file
exec 3>customLog
echo "This goes to file descriptor 3" >&3
# Open a custom file descriptor and redirects to STDOUT
exec 4>&1

# If you want to change the reserved file descriptors. Always backup and change back
exec 5>&1
exec 6>&2

# Backup STDIN is a little different
exec 7<&0
#+END_EXAMPLE

*** Array
#+BEGIN_EXAMPLE
# define empty array
myarray=()

# define array with values
myarray=( one two three four five )

# define array with strings
myarray=( 'Hello World' 'Another item' )

# Get at index 0
echo ${myarray[0]}

# print array as a whole delimited by space
echo ${myarray[@]}

# print array as a whole delimited by newline
printf "%s\n" "${myarray[@]}"

# Convert an array to string variable delimited by newline
printf -v stringvar "%s\n" "${myarray[@]}"

# Remove the final newline
stringvar=${stringvar%?}

# Append to array
myarray+=('foo')
myarray+=("$line")

# Append only if it's new
containsElement() {
 local e
 for e in "${@:2}"; do [[ "$e" == "$1" ]] && return 0; done
 return 1 
}
if ! containElement "$line" "${myarray[@]}"; then
 myarray+=("$line")
fi

# Length
echo Number of elements in array: ${#myarray[@]}

# Loop array
for i in "${myarray[@]}"; do
  echo "$i"
done

#+END_EXAMPLE

*** echo and print
#+BEGIN_EXAMPLE
echo -e "Hello\nWorld"; 
# echo newline -e to use \n etc
# always wrap variable in double quotes to preserve newline character
echo "$output"
#+END_EXAMPLE

*** printf
Print multilines
#+BEGIN_EXAMPLE
printf '%s\n%s\n' "$line1" "$line2"
#+END_EXAMPLE

*** Read command output line by line
#+BEGIN_EXAMPLE
multiple_commands_output=""
output=$(drush command output contains multiple lines);
count=1
while IFS=$'\n' read -r line; do
  echo "Line number $count: $line"
  count=$[ $count + 1 ] 
done <<< "$output"

multiple_commands_output="$multiple_commands_output""$output"$'\n'

# You don't have to change back IFS as it only affects the while loop
# newline character is \n
# read -r :: to ignore all backslashes
#+END_EXAMPLE

*** Date format <<<bash:date>>>
date +%F :: YYYY-MM-DD
date +%H :: 00..23
date +%M :: minute 00..59
date +%S :: second 00..60
date +%T :: HH:MM:SS
date +%Z :: time zone e.g. EDT

date +%FT%T%Z :: 2017-10-13T16:39:02UTC
date +%FT%H%M%S :: 2017-10-13T16-39-02 use this as it is filename safe

*** String Operators
#+BEGIN_EXAMPLE
# A string is delimited by :
# Get the last element
foo=1:2:3:4:5
echo ${foo##*:}

# '##' means greedy front trim
# * matches any character
# until the last ':'
# also work for space as delimiter
# ${foo##* }

# Concatenate string variables
z=""
a="Hello\n"
b="World\n"
c="!"

z="$z""$a"
z="$z""$b"

# insert a newline
z="$z""$c"$'\n'

#+END_EXAMPLE

*** String comparison
#+BEGIN_EXAMPLE
# Start with 'node'
if [[ $a == node* ]]; then

# Start with a string 'Hello World'
[[ $a == "Hello World"* ]]
#+END_EXAMPLE

*** Numeric comparison
Not floating-point values
| Equal            | $n1 -eq $n2 |
| greater or equal | $n1 -ge $n2 |
|                  | $n1 -gt $n2 |
|                  | $n1 -le $n2 |
|                  | $n1 -lt $n2 |
| not equal        | $n1 -ne $n2 |
|                  |             |

*** Bash: shell variable with default value
./yourcustom.sh var1 var2

#+BEGIN_EXAMPLE
this_var1=$1
this_var2=${10}
# maximum 11 variables
this_var3=${3:-"_"}
# if var3 is not provided, then default is string _
#+END_EXAMPLE

*** <<<Bash if>>>
#+BEGIN_EXAMPLE
 if [ conditions ]; then
  # commands
 elif [ conditions ]; then
  # more commands
 elif [ conditions ]; then
  # more commands
 else
  # more commands
 fi
#+END_EXAMPLE

** curl wget
*** curl <<<linux:curl>>>
**** Basic
#+BEGIN_EXAMPLE
dlDir=/home/lili/download/
dlFileName = ${dlDir}123.xml
curl "http://abc.com/123.xml" -L -o ${dlFileName}
#+END_EXAMPLE

**** Return HTTP response header only
=curl -m 120 -IL "http://url.com" >> /path/to/log.log=
e.g Drupal Cron URL response status
#+BEGIN_EXAMPLE
#!/bin/bash
curl -sL -o /dev/null -w "%{http_code}\n" "http://drupalcronurl" >> /path/to/your/cronlog
#+END_EXAMPLE

**** Download with HTTPS or HTTP authentication
Popup form or server authentication
=curl https://a.com/b.aspx -u user:password -L -o /path/to/xml.xml=

**** <<<cURL download only after or before a date>>>
Works for ftp and Http
#+BEGIN_EXAMPLE
fileLocalTime=$(date -r "$localfile")
curl $remote_file_path -u $user:$password -o $localfile -R -z "${fileLocalTime}"
# default is "after"
# add a dash before date string will result in "before".
fileLocalTimeNew=$(date -r "$localfile")
if [ "$fileLocalTime" == "$fileLocalTimeNew" ]; then
 echo "the same"
else
 echo $fileLocalTime
 echo $fileLocalTimeNew
fi
#+END_EXAMPLE

**** HTTP POST
#+BEGIN_EXAMPLE
# default POST is application/x-www-form-urlencoded
curl -X POST -d "test=that&test2=that2" http://..

# explict -H 'Content-Type: application/x-www-form-urlencoded'

# with a data file
curl -X POST -d "@data.txt" http://..

# json
curl -X POST -H 'Content-Type: application/json' -d "{\"test\": \"that\"}" http://..

# with a data file
curl -X POST -d "@data.json" http://..
#+END_EXAMPLE

**** Options

| L          | Follow through all redirects                                  |
| o          | redirect STDOUT to a file                                     |
| O          | save file using same file name in current folder              |
| I          | get header response only                                      |
| m          | timeout in seconds                                            |
| H          | request header. =-H "Accept-Charset: ISO-8859-1,utf-8;q=0.7"= |
| limit-rate | limit download speed: --limit-rate=200k. use k, m or g        |
| s          | suppress STDOUT                                               |
| w          | rewrite STDOUT                                                |
| R          | Keep remote file timestamp. --remote-time                     |
| z          | cURL download only after or before a date                     |
|            |                                                               |
 
*** wget
Compared to curl, wget's advantages are:
- recursive
- continue downloading after broken transfer
- Specify cookies in get request
- Has redirect-following
- Capture response such as time stamping from the remote resource.

Disadvantages are only HTTP/HTTPS/FTP, Basic auth over HTTP proxy, no SOCKS support

wget [option]... [URL]...

#+BEGIN_EXAMPLE
http://[username:password@]host[:port]/directory/file
ftp://[username:password@]host[:port]/directory/file
#+END_EXAMPLE

Download all subfolders and files of an FTP folder
#+BEGIN_EXAMPLE
cd ~
wget --user=hello --password='mypassword' -cr ftp://server/path/to/test
# Default depth is 5, change it
wget -r -l 2 ftp://... 
# for infinite depth :: -l inf

# path/to/test is 3 depths, by default, 2 more levels can be downloaded

# ~/server/path/to/test/* will be downloaded

# -nH ~/path/to/test will be downloaded
# -nH --cut-dirs=1 ~/to/test will be downloaded
# -nH --cut-dirs=2 ~/test will be downloaded
# --cut-dirs=1 ~/server/to/test will be downloaded

# --ftp-user or --http-user can also be used. There's no difference

# Ignore folders (not file)
wget -cr -X path/to/folder/ignore/ ftp://server/path/to/folder/

# folder path/to/folder/ignore/ will not be downloaded

# wildcards can also be used
wget -cr -X path/to/folder/ignore*/ ftp://server/path/to/folder/

# ignore multiple folders
-X path/to/folder/ignore1,path/to/folder/ignore2

# Only include certain folders -I, exactly the same as -X

# Only download files -A
-A books*,zelazny*196[0-9],gif,jpg

gif and jpg are normal letters, they match the ending part of a file (not exactly file extension)

# Ignore certain files -R, exactly the same as -A

# -N to retrieve timestamps so if local files are newer, skip download.
# -c :: enable continue download

# --limit-rate=20k :: limit download speed to 20kb/s, m or g can also be used

# -b :: put command run in background

# -O path/to/local/file :: output to a local file. Change downloaded filename

# Logging
# -v :: default
# -q :: complete quiet
# -nv :: only error and basic info are printed

#+END_EXAMPLE

In summary, to download everything under ftp://server/path/to/test to ~/test

#+BEGIN_EXAMPLE
cd ~
wget --user=abc --password='pass' -cr -l inf -N -nH --cut-dirs=2 ftp://server/path/to/test
#+END_EXAMPLE

Download and update a subfolder
You have downloaded ftp://server/path/to/test/* to ~/test
Now you want to only re-download ftp://server/path/to/test/1/* and update ~/test/1
#+BEGIN_EXAMPLE
cd ~
wget -cr -l inf -N -nH --cut-dirs=3 -P test/ ftp://server/path/to/test/1

# -P :: default is . (current folder) Prefix local directory
#+END_EXAMPLE

[[https://www.gnu.org/software/wget/manual/wget.html][Manual]]

** upx <<<linux:upx>>>
Executable file packer (compresser)

#+BEGIN_EXAMPLE
apt-get install upx-ucl

# Most compressed level. Result file go.upx
upx --brute go
#+END_EXAMPLE

** Commands
*** screen <<<bash:screen>>>
Simply run ~screen~ creates a screen session.

In a screen session, multiple shell windows can be open from a single SSH session.

See if it's installed ~which screen~.

For help :: ~C-a ?~ 
Create a window :: ~C-a c~
Switch between windows: ~C-a n~ or ~p~ for previous window
Detach a window from the screen session and can be reattached later ::  ~C-a d~
If network connection fails in one screen session, screen will automatically detach the session.
Reattach (when connection drops or you have detached froma a screen) :: ~screen -r~ or a specific screen
~screen -r 12345.pts-0.xxxx~ or simply ~screen -r 12345~

To get an alert when there's output registered on a specific screen, on that screen run ~Ctrl-a M~ and then switch to other screen
Or get an alert when there's no output ~C-a _~

Lock a screen session when you need to go away ~C-a x~

Stop the screen session :: ~C-a k~ or ~exit~ for each screen window.

List all screen sessions and status :: ~screen -ls~

See window list ~C-a "~ it's double quote ~S-'~
Rename current window :: ~C-a A~

Run a background process after SSH signout
#+BEGIN_EXAMPLE
screen
nohup ./main &
C-a d
exit
#+END_EXAMPLE

*** Run Sequentially
=lspci; lsusb=
If the first command not successful, 2nd command will not run: =lspci && lspci=

*** =man=
=man -k processes= Search `processes` in command names and description
=man -f ls= Search in command names and title

*** =cd -= Navigate to previous directory (back)
*** =wc=
| =-l= | Line Count      | =ps -ef \vert wc -l= |
| =-w= | Word Count      |                      |
| =-c= | Byte Count      |                      |
| =-m= | Character Count |                      |
|      |                 |                      |

*** Replace String  =sed= 
<<<bash:sed>>>
Replace all (g) Nick with John case-insensitive
cat report.txt | sed 's/Nick/John/gi' > report_new.txt

sed SCRIPT INPUTFILE...
or 
sed OPTIONS... [SCRIPT] [INPUTFILE...]

SCRIPT
- s command :: 's/{regexp}/{replacement}/{flags}'
  - {regexp} :: For literal string, wrap each letter in [ and ] and for ^ do [\^]
    - e.g. literal string '&#x1f;' =sed 's/[&][#][x][1][f][;]//gi' -i c.xml=
    - literal string '&#^x1f;' =sed 's/[&][#][\v][x][1][f][;]//gi' -i c.xml=
  - {replacement} :: You can use & to subsitute the whole matched portion of the pattern.

Refer to [[https://stackoverflow.com/questions/29613304/is-it-possible-to-escape-regex-metacharacters-reliably-with-sed][regexp and replacement escape]]

OPTIONS
- -e SCRIPT :: run several inline SCRIPT's described above
- -f SCRIPT-FILE :: Run commands in SCRIPT-FILE's
- -i :: files are edited in-place
  - -i :: original files are overwritten, no backup files are created
  - -i.backup or -i .backup (only Mac) :: copy original to *.backup and change original files
- :: 

For deleting only
sed "s/deletethis//g" -i input.txt
sed 's/&#x1f;//gi' -i c.xml
For multiple files
sed 's/Nick/John/gi' *.txt
No backup
sed 's/Nick/John/gi' -i.backup *.txt
create backup files

[[https://www.gnu.org/software/sed/manual/sed.txt][man sed]]

*** Concatenate String with File
Append to the beginning
echo returns a newline
echo '<?xml version="1.0"?>' | cat - input.txt > output.txt

'-' after 'cat' means to take the stdin from last command

Append to the end
echo 'end line' | cat input.txt - > output.txt

*** Change Encoding
Change from UCS-2 to UTF-8
iconv -f UCS-2 -t UTF-8 input.xml > output.xml

*** Comment out every line in a file and save as a new file
Add '# ' in front of every line
jail.conf is the source file, and jail.local is the destination file.
After it's run, jail.conf is not affected.
#+BEGIN_EXAMPLE
awk '{ printf "# "; print; }' /etc/fail2ban/jail.conf | sudo tee /etc/fail2ban/jail.local
#+END_EXAMPLE

*** sudo
Install sudo =apt-get update && apt-get install -y sudo less=
Run sudo interactive =sudo -i=

*** SHA, salt hashing
<<<image:lucee:salt>>>
./luceehashing.sh UIloginPassword salt
#+BEGIN_EXAMPLE
#!/bin/bash

SHA_ALGORITHM=256
SHA_COUNT=5

LUCEE_PASSWORD=${1:-"_"}
LUCEE_SALT=${2:-"_"}

if [ $LUCEE_PASSWORD == "_" ]; then
  LUCEE_PASSWORD=topsecret
fi
if [ $LUCEE_SALT == "_" ]; then
  LUCEE_SALT=$(uuidgen | tr a-z A-Z)
fi

COUNT=1
LUCEE_HASH=$(echo -n "${LUCEE_PASSWORD}:${LUCEE_SALT}" | shasum -a $SHA_ALGORITHM | cut -f1 -d' ')
while [ $COUNT -lt $SHA_COUNT ]; do
  LUCEE_HASH=$(echo -n $LUCEE_HASH | shasum -a $SHA_ALGORITHM | cut -f1 -d' ')
  COUNT=$((COUNT + 1))
done

echo "Lucee Admin Values"
echo "  hspw = $LUCEE_HASH"
echo "  salt = $LUCEE_SALT"
#+END_EXAMPLE

*** byobu
Create multiple terminals and switch between.
=apt-get install byobu=

*** =w3m= Command line web browser
Ubuntu
#+BEGIN_EXAMPLE
apt-get install w3m
# S-Q to quit
#+END_EXAMPLE

*** set, <<bash:set>>>
#+BEGIN_EXAMPLE
set -ex; command1; command2; ...
#+END_EXAMPLE

-x :: enable a mode of the shell where all executed commands are printed to the terminal.
-e :: under common situation, exit when there's an error

** Cheat
#+BEGIN_EXAMPLE
sudo apt-get update && sudo apt-get upgrade
sudo apt-get install python-pip
sudo pip install cheat
cheat -v
#+END_EXAMPLE

Modify ~/.bashrc
#+BEGIN_EXAMPLE
# If not running interactively, don't do anything
case $- in
  *i*) ;;
    *) return;;
esac

export EDITOR="/usr/bin/nano"
export CHEATCOLORS=true

# don't put duplicate lines or lines starting with space in the history.
HISTCONTROL=ignoreboth
#+END_EXAMPLE

Add to autocompletion
#+BEGIN_EXAMPLE
cd /etc/bash_completion.d/
# sudo wget https://raw.githubusercontent.com/chrisallenlane/cheat/master/cheat/autocompletion/cheat.bash
# cheat.bash is as follows
function _cheat_autocomplete {
    sheets=$(cheat -l | cut -d' ' -f1)
    COMPREPLY=()
    if [ $COMP_CWORD = 1 ]; then
	COMPREPLY=(`compgen -W "$sheets" -- $2`)
    fi
}

complete -F _cheat_autocomplete cheat
#+END_EXAMPLE

~cheat -d~ lists the directories that cheat sheets should be saved. One is ~/.cheat, the other is system
Each cheat sheet is a file, like ~/.cheat/ping
#+BEGIN_EXAMPLE
# some comments
ping -c 15 www.example.com

# another usage
ping ...
#+END_EXAMPLE

~cheat -s packets~ search all cheat sheets that has `packets` in commands and description.
Also return cheat sheet name

~cheat ping~ show the `ping` cheat sheet

** Makefile
Install in Ubuntu :: sudo apt-get update && sudo apt-get install make

Create a Makefile in current folder
#+BEGIN_EXAMPLE
include env_make
# include a file which defines some variables

NAME=myimagename
VERSION=0.1.0
REPO=mydockerreponame
# define some variables

# Define dynamic variable
filename := file_$(shell date +%FT%T%Z).log

.PHONY: default build
# This tells make to not look elsewhere for commands default and build
# Instead, run default and build as they are defined in this Makefile
# Usually include all commands in this Makefile

# command in Makefile is called target. Syntax of Makefile is
# target ...: prerequisites ...
#     recipe
#     ...
#     ...

# A prerequisite is a file/command. It means to include a file

# A recipe is an action (command). Every recipe line has to start with a tab character

default:
	@echo "Some description"
# If you run `make` in current folder without specifying which command, the first command will be run
# @echo means it doesn't print out the actual command

all: build
# the all command runs the build command

build:
	sudo docker build -t $(NAME):$(VERSION) --rm .

push:
	docker push $(NAME)/$(REPO):$(VERSION)

release: build
	make push -e VERSION=$(VERSION)
# `make release` runs `build` first, then run `push` with a parameter
# can't put push as a prerequisite after `build` because it has to be run using a parameter

testecho:
	@echo $$FOO
# make testecho FOO="a b c"
# actually @echo $(foo) then ~make testecho foo="a b c"~

testsub:
	@echo otheraction $(filter-out $@,$(MAKECMDGOALS))

# make testsub a b c
# $@ is the target name, which is testsub
# $(MAKECMDGOALS) is the list of targets, which is testsub a b c

# This method requires you to put these 2 lines to the end of Makefile (remove leading #'s)

#%:
#	@:

# %: is a target which matches every target
# @: is a recipe in which @ is the same as @echo. : means do nothing

# Escaping $ might be needed for running sub command

start:
	docker rm -f $$(docker ps -a -q)

runrecipeinmiddle:
	- echo do something
	- $(MAKE) build

# - in front of command means ignore the exit status of the command so that a non-zero exit would not stop the recipe
#+END_EXAMPLE

Makefile :: make your-recipe
Makefile.test :: make -f Makefile.test your-recipe
Makefile.live :: make -f Makefile.live your-recipe

** Nano
- Save :: Ctrl + O 
- Exit :: Ctrl + x
- Display line number and cursor position: C-c
- Uncut or paste text C-u
- Search :: C-w or F6

- Select and copy, paste
 - ~Alt + Shift + A~ or ~C-6~ to set mark, move cursor to selct
 - ~Alt + Shift + 6~ or ~M-6~ to copy or use C-k to cut text
 - C-u to paste

- Turn off word wrap :: Esc, release, then $ (shift+4)

By default, nano covert tab to 4 spaces. Turn off ~Shift + Alt + Q~

** Ubuntu Unity

| C-M t   | open Terminal          |
| M-<F2>  | run command/open app   |
| Super-T | Open Trash             |
| Super-F | Open Files             |
| Alt-`   | Switch between windows |
|         | of the current app     |
|         |                        |

** Ubuntu Personal Package Archive PPA
Add a LibreOffice package from PPA to Software Sources
=sudo add-apt-repository ppa:libreoffice/ppa=, then =sudo apt-get update=
Remove the package source
=sudo add-apt-repository --remove ppa:libreoffice/ppa=, =apt-get update=

Remove it and downgrade back to previous version before using PPA
=sudo apt-get install ppa-purge=, =sudo ppa-purge ppa:libreoffice/ppa=

** Production Server Setup
linux:user :: Add a normal user, add the user to sudo group
linux:ssh :: Add ssh public key to the new user's .ssh folder
linux:ssh:disallow_root :: Disallow SSH in as root
linux:sudo:nopassword :: require no password for non-root users with sudo privilige/group
linux:firewall :: configure firewall, open ports
linux:timezone :: setup timezone and sync time

* Domain Server, DNS Server, SSL/https
Refer to linux:dns
A hostname :: a sub domain. e.g. www

A records :: redirect hostname.domainname.com to an IP address. For the barebone domain name, the hostname is @

AAAA records :: same as A records but they are IPv6. Nowadays, both AAAA and A are needed

ANAME :: It's like CNAME. Name (from source domain) could be @. The value has to be another (target) apex domain. DNS resolves the target fully qualified domain name (FQDN) to an IP or multiple and also synthesize A records of the domain that points to the IP(s) of the FQDN. Since the target FQDN's IP is returned on the first lookup, it's faster than ALIAS record.

CNAME records :: point another subdomain (hostname) to an A record (e.g. hostname.domainname.com). It should only be used when there are no other records on that name. Don't use the bare domain in CNAME on the left hand side.

ALIAS records :: same as CNAME but it can coexist with other records on that name. It resolves the target domain to one or more A records. ALIAS's name can be (from source domain) anything, the value can be (target) any other external domain.

URL records :: redirect the name to the target name using HTTP 301 status code.

TXT record :: Google Search Console may add TXT @ google-site-verification=[code] TTL 1 Hour to verify site ownership.

The ~A~, ~CNAME~, ~ALIAS~ records causes a name to resolve to an IP. Vice-versa, the ~URL~ record redirects the name to a destination. The ~URL~ record is simple and effective way to apply a redirect for a name to another name, e.g. to redirect www.example.com to example.com

The ~A~ name must resolve to an IP, the ~CNAME~ and ~ALIAS~ record must point to a name.

The general rule is:

- use an A record if you manage what IP addresses are assigned to a particular machine or if the IP are fixed (this is the most common case)
- use a CNAME record if you want to alias a name to another name, and you don't need other records (such as MX records for emails) for the same name
- use an ALIAS record if you are trying to alias the root domain (apex zone) or if you need other records for the same name
- use the URL record if you want the name to redirect (change address) instead of resolving to a destination.

On bare/apex domain, usually A, ALIAS or ANAME record can be used. Only DNS Made Easy supports ANAME and DNSimple and others support ALIAS. ANAME and ALIAS are not industry standards.

** MX records
- HOSTNAME :: e.g. use @ for barebone
- Mail Providers Mail Server (or Value) :: always end with "." e.g. alt4.aspmx.l.google.com.
- Priority :: the smaller the more important

** redirect.center, redirect.name
If URL record is not available, use CNAME and [[http://redirect.center/][redirect.center]] and redirect.name
Instructions: https://milanaryal.com/domain-redirecting-and-url-forwarding-with-a-simple-dns-record/

redirect.center is especially good for redirect subdomain www.abc.com to google.com/path if the domain host doesn't support Domain Forwarding with path.

To redirect naked domain, use Forward Domain.

#+BEGIN_EXAMPLE
# redirect google.example.com to google.com
google.example.com IN CNAME google.com.redirect.center

# redirect google.example.com to google.com with a 302 status code
google.example.com IN CNAME google.com.opts-statuscode-302.redirect.center

# If a user try to visit www.oldwebsite.com/about/ will redirect to path www.newwebsite.com/about/:
www.oldwebsite.com  IN  CNAME  www.newwebsite.com.opts-uri.redirect.center

# opts-statuscode-{code} :: HTTP Status Code to be used in the redirect. 302, HTTP Status Code
# opts-uri :: Append URI (if any) to the target URL
# opts-slash
# jobs.my-domain.com to http://www.my-domain.com/jobs
# jobs IN CNAME to www.my-domain.com.opts-slash.jobs.redirect.center
# multiple path components, jobs.my-domain.com to www.my-domain.com/jobs/xyz
# jobs IN CNAME to www.my-domain.com.opts-slash.jobs.opts-slash.xyz.redirect.center

# Use redirect.name instead of readirect.center
# redirect google.example.com to google.com
google.example.com            IN  CNAME  alias.redirect.name
_redirect.google.example.com  IN  TXT    Redirects to https://www.google.com

# redirect google.example.com to google.com with options
google.example.com            IN  CNAME  alias.redirect.name
_redirect.google.example.com  IN  TXT    Redirects from /* to https://www.google.com/*

# Redirects to [target], where target is the target URL
# Redirects from [path] to [target], where path is a path to match on the hostname
# Redirects permanently to [target], where permanently redirects with a 301 status code (defaults to 302 otherwise)
#+END_EXAMPLE

** Domain Forwarding
Naked domain forwarding
Forward abc.com to http://google.com
abc.com/xyz will become google.com/xyz in the address bar

Forward abc.com to http://google.com/xyz
Some domain host and registration service might support that.
abc.com/ijk will become google.com/xyz/ijk in the address bar

Subdomain forwarding can be done as well.

** Addon domain
It's an addtional domain that the system stores as a subdomain
abc.com is registered in GoDaddy. Change nameservers to another domain host say ns.googlehosting.com ns2.googlehosting.com
Then in googlehosting, set it up as an addon domain :: abc.com > subdomain abc.xyz.com, then specify the document root

abc.com will appear as parked on abc.xyz.com on the googlehosting

** Park domain
To park a domain means to make the domain as idle. Nameservers will be set to Default for example in GoDaddy.

** AutoSSL in WHM/cPanel
WHM and cPanel provides free SSL certificates for VPS and Dedicated server users.
http://www.inmotionhosting.com/support/edu/whm/creating-and-managing-accounts/using-auto-ssl

It uses SHA256 TLS v1 and expires every 90 days. TLS v1 must be disabled for eCommerce site by June 30, 2018. For non-eCommerce site, it's ok.

First is to enable AutoSSL for WHM users. AutoSSL will check all root domains under the user account.

AutoSSL will include certificates for www. domains. e.g. www.yourrootdomain.com, www.yoursub.yourrootdomain.com 
yoursub.yourrootdomain.com is set up by you and you didn't setup www.yoursub.yourrootdomain.com

Use hosting nameservers in domain registrar. Log in WHM as root. Go to Manage AutoSSL.
Providers :: cPanel (powered by Comodo)
Options :: check all options especially "Allow AutoSSL to replace invalid or expiring non-AutoSSL certificates"
Manage Users :: Enable AutoSSL for relevant users
Click on Run AutoSSL for All Users
Check Logs

SSL certificates should be now installed.

Check each domain SSL certificate using cPanel. SSL/TLS > Certificates (CRT)
http://www.inmotionhosting.com/support/website/cpanel/add-delete-autossl-cpanel

** SSL Testing Tools
<<<ssl:test>>>
https://www.whynopadlock.com/
https://www.ssllabs.com/ssltest/index.html
Qualys https://www.ssllabs.com/ssltest/index.html

* Docker
** Version, Info, Installation
Brief :: ~docker --version~
Server and Client :: ~sudo docker version~
Full :: ~sudo docker info~

"Docker for Windows" needs Windows Hyper-V enabled. Command prompt is admin.

After installation, make sure linux:firewall DEFAULT_FORWARD_POLICY="ACCEPT"

Use ~systemctl~ for managing Docker service.

Users in user group ~docker~ can run docker commands without sudo.

#+BEGIN_EXAMPLE
# replace your username with ${USER}
sudo usermod -aG docker ${USER}
# to apply the new group membership, you can log out and back in, or run this
su - ${USER}
# print name (-n, --name) instead of a number and show group IDs (-G)
id -nG
#+END_EXAMPLE

*** Install on Digital Ocean
https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-16-04
#+BEGIN_EXAMPLE
# Add GPG key
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
# Add Docker repo to APT sources so that Docker is the most up to date
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
sudo apt-get update
# query the APT cache, it will show docker-ce is from the docker repo
apt-cache policy docker-ce
sudo apt-get install -y docker-ce
# check if Docker is running
sudo systemctl status docker
#+END_EXAMPLE

** Command Help ~docker docker-subcommand --help~
** Images
List all images :: ~docker images~
List all dangling images which can be removed :: ~docker images -f "dangling=true"~

Remove all dangling images (-q is to return IDs only)
~docker rmi $(docker images -f "dangling=true" -q --no-trunc)~

Remove all none images
~docker rmi $(docker images | grep "none" | awk '/ / { print $3 }')~

Download an image :: ~docker pull phusion/baseimage~ or with a tag ~docker pull phusion/baseimage:0.9.18~
Remove an image :: ~docker rmi imageName~
Save an image to tar file :: ~docker save -o /path/docker-image-file.tar docker-image-name~
Import a tar to image :: ~docker load -i /path/docker-image-file.tar~

Search image in Docker repository :: ~docker search ubuntu~

~docker image inspect php:7.0-fpm~ to see image setting

Extract Dockerfile from an image. Use one or more of below
- Use image:dockerfile-from-image
- docker image inspect <image-name>
- docker history --no-trunc <image-name>
- sudo ./test.sh <image-name>

#+BEGIN_EXAMPLE
#!/bin/bash
docker history --no-trunc "$1" | \
sed -n -e 's,.*/bin/sh -c #(nop) \(MAINTAINER .*[^ ]\) *0 B,\1,p' | \
head -1
docker inspect --format='{{range $e := .Config.Env}}
ENV {{$e}}
{{end}}{{range $e,$v := .Config.ExposedPorts}}
EXPOSE {{$e}}
{{end}}{{range $e,$v := .Config.Volumes}}
VOLUME {{$e}}
{{end}}{{with .Config.User}}USER {{.}}{{end}}
{{with .Config.WorkingDir}}WORKDIR {{.}}{{end}}
{{with .Config.Entrypoint}}ENTRYPOINT {{json .}}{{end}}
{{with .Config.Cmd}}CMD {{json .}}{{end}}
{{with .Config.OnBuild}}ONBUILD {{json .}}{{end}}' "$1"
#+END_EXAMPLE

*** Build an image based on Dockerfile
With one Dockerfile in a folder (resource). Run to build :: ~docker build -t your-image-name .~

Multiple Dockerfiles (Dockerfile1, Dockerfile2) in the current folder
~docker build -t your-image-name -f Dockerfile2 .~

Dockerfile and resource are in different folders
~docker build -t your-image-name -f /path/Dockerfile.yourname /path/to/docker/~

Build a lot of times while testing a Dockerfile
#+BEGIN_EXAMPLE
docker build --force-rm=true --no-cache==true -t my-image-name .
#+END_EXAMPLE

** run
*** Interactive mode with tty ~-it~
If there's an  error, ~cannot enable tty mode on non tty input~, try ~-i~ only.

*** Run an image in a container and keep running in background
#+BEGIN_EXAMPLE
docker run --name wordpressdb -v=/vagrant/mydbdump:/tmp/mydbdump \
-v=/mydbdata:/var/lib/mysql \
-e MYSQL_ROOT_PASSWORD=password -e MYSQL_DATABASE=wordpress \
-d mysql:5.7.9
#+END_EXAMPLE

Container name :: wordpressdb
Image name :: mysql:5.7.9
Detached mode (in background) :: -d
Insert environment variables :: -e

*** Run an image in a temp container only once, then remove the container
A MySQL container, wordpressdb, created by mysql:5.7.9 image, is already running.

Start up another container using the same image
In this temp container, wordpressdb container can be discovered as wpdb (alias).
Then import a .sql file to wpdb
The temp container is then removed.

Refer to docker:link

#+BEGIN_EXAMPLE
docker run -it --rm \
-v=/vagrant/mydbdump:/tmp/mydbdump \
--link wordpressdb:wpdb mysql:5.7.9 \
sh -c \
'exec mysql -h"$WPDB_PORT_3306_TCP_ADDR" \
-P"$WPDB_PORT_3306_TCP_PORT" \
-uroot -p"$WPDB_ENV_MYSQL_ROOT_PASSWORD" \
wordpress < /tmp/mydbdump/pantheon_db_sql'
#+END_EXAMPLE

*** Link
<<<docker:link>>> is deprecated and it relies on Docker in default bridge network mode.

*** --name and --hostname
Specify the container name using --name
Inside the container, the container is called --hostname=value
~docker run --hostname=value~ OR ~docker run -h value~
Combine --name and --hostname as much as you can

** Containers
List containers :: ~docker ps -a~
Stop and Start :: ~docker stop containerName~ ~docker start containerName~
Restart :: ~docker restart containerName~

Stop and remove :: ~docker rm -f containerName~
Stop and remove all containers :: ~docker rm -f $(docker ps -a -q)~
Stop and remove all exited containers :: ~docker rm $(docker ps -qa --no-trunc --filter "status=exited")~

Container log :: ~docker logs -f containerName~ -f to follow log output

- docker inspect
~docker inspect containerName~
Container network IP and settings :: ~NetworkSetting > IPAddress~
Volume :: ~Config > Volumes~ and ~Mounts~

- docker cp
Copy files from container ~ghost~ to docker host :: ~docker cp -L ghost:/usr/src/ghost/config.js ./config.js~
Copy files from docker host to container :: ~docker cp -L ./config.js ghost:/usr/src/ghost/config.js~
Copy a folder, result /var/www/transfer/web :: ~docker cp web/. ghost:/var/www/transfer/web~
Copy a folder, result /var/www/transfer/web :: ~docker cp web/ ghost:/var/www/transfer~
-L :: copy symbol link
-a :: copy file permissions as well as userid:groupid

SRC_PATH specifies a file
- DEST_PATH does not exist
  the file is saved to a file created at DEST_PATH
- DEST_PATH does not exist and ends with /
  Error condition: the destination directory must exist.
- DEST_PATH exists and is a file
  the destination is overwritten with the source file’s contents
- DEST_PATH exists and is a directory
  the file is copied into this directory using the basename from SRC_PATH

SRC_PATH specifies a directory
- DEST_PATH does not exist
  DEST_PATH is created as a directory and the contents of the source directory are copied into this directory
- DEST_PATH exists and is a file
  Error condition: cannot copy a directory to a file
- DEST_PATH exists and is a directory
 - SRC_PATH does not end with /. (that is: slash followed by dot)
   the source directory is copied into this directory
 - SRC_PATH does end with /. (that is: slash followed by dot)
   the content of the source directory is copied into this directory

Memory usage for all containers ~docker stats -a~

*** Save a running container to an image
First exit the container first
~docker commit -m "added node.js" -a "Author Name" 123456 my/ubuntu-nodejs~

Container id :: 123456. get this from ~docker ps -a~
New image name :: my/ubuntu-nodejs

*** Execute commands inside a running container
Login to container with bash open :: ~docker exec -it containerName bash -I~
Long command (pure-pw only exists in container)
~docker exec -it containerName pure-pw useradd bob2 -f longpathto/passwd -m -u ftpuser -d /home/ftpusers/bob2~
Run multiple commands
~docker exec -it containerName bash -c 'cd /var/log; tar -cv ./file.log'~

** Network
#+BEGIN_EXAMPLE
# List networks
docker network ls

# Info about a network
docker network inspect the_network_id

# Remove networks
# returns error when last bridge is removed. It's normal
docker network rm $(docker network ls | grep "bridge" | awk '/ / { print $1 }')
#+END_EXAMPLE

** Volume
#+BEGIN_EXAMPLE
# List all volumes
docker volume ls

# Info about a volume
docker volume inspect the_vol_id

# Remove volumes
docker volume rm $(docker volume ls -qf dangling=true)
#+END_EXAMPLE

** Dockerfile
*** CMD, RUN, ENTRYPOINT
There can only be one ~CMD~ in a Dockerfile or a chain of Dockerfiles included as in parent images.
If there're multiple, only the last one will run.
~CMD~ is to provide defaults for a container that is already created from an image and running.
~RUN~ runs a command and commits the result to an image at build time.
~CMD~ doesn't execute anything at build time and it's not committed to the image.
~ENTRYPOINT~ Docker's default entrypoint is ~/bin/sh -c~. Actually every ~RUN <your command>~ is ~/bin/sh -c <your command>~
Docker allows you to specify a different entrypoint for ~docker run~ e.g. ~docker run -it ubuntu <your command>~ is to run ~/bin/sh -c <your command>~ <your command> could be ~bash~
~CMD~ is just to provide paremeters to ENTRYPOINT when ~docker run~ is run. e.g. Ubuntu ~CMD ["bash"]~ then you can run ~docker run -it ubuntu~ to run ~/bin/sh -c bash~ directly

Example :: without ENTRYPOINT, this needs to run ~docker run redisimg redis -H something -u toto get key~
With ENTRYPOINT, ~ENTRYPOINT ["redis", "-H", "something", "-u", "toto"]~, only this needs to run
~docker run redisimg get key~

There're 3 forms of ~CMD~
#+BEGIN_EXAMPLE
# exec form, json array
CMD ["executable", "param1", "param2"]

# as default parameters to ENTRYPOINT
CMD ["param1","param2"]

# shell form
CMD command param1 param2
#+END_EXAMPLE

exec form doesn't have variable substitution
CMD ["echo", "$HOME"] won't output $HOME variable

Use shell form ~CMD [ "sh", "-c", "echo $HOME" ]~ or
~CMD echo $HOME~ at default shell of the running container

*** ADD vs COPY
COPY <src>... <dest>
COPY ["<src>",... "<dest>"] (this form is required for paths containing whitespace)

ADD and COPY are the same except 
- ADD allows src to be an URL
- If the src is an archive (tar) it will be unpacked

Always use COPY if it can do what you want

*** Timezone
<<<docker:timezone>>>

#+BEGIN_EXAMPLE
ENV TZ=America/Toronto
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
#+END_EXAMPLE

*** Debian (Jessie)
When building an image using Debian, a lot of these:
debconf: delaying package configuration, since apt-utils is not installed

#+BEGIN_EXAMPLE
ARG DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y apt-utils
#+END_EXAMPLE

** Docker Compose
=docker-compose --version=
=docker-compose up -d=
=docker-compose up -d --force-recreate= Force restart or recreate containers
=docker-compose down -v= remove containers and volumes
=docker-compose down ---rmi local= remove only images that don't have a custom tag set by the `image` field
=docker-compose down --rmi all= remove all images used by any service

=docker-compose build= build new image if there's any build directive
=docker-compose up -d= doesn't build image, it will use existing image
=docker-compose up -d --build= build new image and run

*** Ubuntu 16.04 Installation
[[https://github.com/docker/compose/releases][Grab latest docker-compose version]] say it's 1.16.1

#+BEGIN_EXAMPLE
sudo curl -o /usr/local/bin/docker-compose -L "https://github.com/docker/compose/releases/download/1.16.1/docker-compose-$(uname -s)-$(uname -m)"
# add execute permission
sudo chmod +x /usr/local/bin/docker-compose
docker-compose -v
# Test
nano docker-compose.yml
my-test:
  image: hello-world
# run
docker-compose up
docker rm <container-id>
docker rmi hello-world
#+END_EXAMPLE

*** YML
It has to be this name ~docker-compose.yml~ and don't include this file in sub directories.

Docker Engine version (docker version) 

| Compose file format | Docker Engine release |
|             3.0;3.1 |               1.13.0+ |
|                 2.1 |               1.12.0+ |
|                 2.0 |               1.10.0+ |
|                 1.0 |                1.9.1+ |

**** version (top level)
#+BEGIN_EXAMPLE
version: '2'
#+END_EXAMPLE

**** volumes (top level)
Check volumes created by Docker =docker volume ls=
Create a volume =docker volume create --name dbdata=
Remove a volume =docker volume rm dbdatavolume=

#+BEGIN_EXAMPLE
volumes:
# Named volume which can be used in all services
# this volume isn't mapped to anything in docker host!
# top-level volumes can't specify path to named volume.. You have to install other Docker plugin
  dbdata:
#+END_EXAMPLE

**** networks (top level)
Every time ~docker-compose up~ creates a single network (per app) which all services in the app are on.
Let's say yml file is a folder called foldername
This avoids the need to use links
#+BEGIN_EXAMPLE
networks:
# network name is foldername_app_net
  app_net:
# bridge on a single host (default) and overlay on a Swarm
    driver: bridge
    ipam:
      driver: default
      config:
      - subnet: 172.18.0.0/16
        gateway: 172.18.0.1
#+END_EXAMPLE

Then in a service, specify the ip
#+BEGIN_EXAMPLE
services:
 db:
   image: mysql:5.7.9
   container_name: db
   hostname: db
   networks:
     app_net:
       ipv4_address: 172.18.0.2
   restart: always
#+END_EXAMPLE

***** Use network defined in another docker-compose
#+BEGIN_EXAMPLE
# ./app1/docker-compose.yml
networks:
  app_net:
    driver: bridge
    ipam:
      driver: default
      config:
      - subnet: 172.16.2.0/24
        gateway: 172.16.2.1
services:
  lucee:
    ...
    networks:
      app_net:
        ipv4_address: 172.16.2.3

# ./app2/docker-compose.yml
networks:
  app1_app_net:
    external: true
services:
  nodejs:
    ...
    networks:
      app1_app_net:
        ipv4_address: 172.16.2.4
#+END_EXAMPLE

**** services

#+BEGIN_EXAMPLE
services:
  lucee:
    build: .
    # use Dockerfile to build an image
    image: cflucee:latest
    # specify image name which can be later used in other service
    # When there's build in yml, you need to add --build
    # docker-compose up -d --build
    container_name: lucee
    ports:
      - "80:80"
      - "8888:8888"
    volumes:
      - /host/path/to/folder1:/root/db/
      - /host/path/to/folder2:/var/log/nginx
    # equivalent to -t in docker run
    tty: true
    networks:
      app_net:
        ipv4_address: 172.18.0.3
#+END_EXAMPLE

~EXPOSE~ in Dockerfile and ~-p~ in ~docker run -p 8080~
- Neither specify EXPOSE nor -p
  - service in container will not be accessible from anywhere except from the container itself
- Only specify EXPOSE
  - The service in the container is not accessible from outside Docker, but from inside other Docker containers.
  - Good for inter-container communication
- Specify EXPOSE and -p
 - The service in the container is accessible from anywhere, even outside Docker
- Specify -p but not EXPOSE
 - It's like only specify EXPOSE

**** Pass arguments from Compose to Dockerfile
docker-compose.yml
#+BEGIN_EXAMPLE
version: '2'
services:
  web:
    build:
      context: ./web
      args:
        REQUIREMENTS: "envs/dev.env"
#+END_EXAMPLE

Dockerfile
#+BEGIN_EXAMPLE
FROM python:3.5
ENV PYTHONUNBUFFERED 1
ENV APP_ROOT /usr/src/app
ARG REQUIREMENTS
...
COPY $REQUIREMENTS $APP_ROOT/
#+END_EXAMPLE

** Docker for Windows
*** PowerShell Auto Complete
Win + x > PowerShell (Admin)
Run these
#+BEGIN_EXAMPLE
# To allow downloaded scripts signed by trusted publishers to run on this computer
Set-ExecutionPolicy RemoteSigned
# Type y, check if this return RemoteSigned
get-executionpolicy
# Install PowerShell module posh-docker, it may also install NuGet package manager
Install-Module posh-docker

# Enable autocompletion for the current PowerShell only
Import-Module post-docker

# To make it persistent across all PowerShell sessions, we need to import the module to ~$PROFILE~
# Run this directly on PowerShell to create a profile if not exists and add the line
if (-Not (Test-Path $PROFILE)) {
    New-Item $PROFILE –Type File –Force
}

Add-Content $PROFILE "`nImport-Module posh-docker"

# check
cat $PROFILE
#+END_EXAMPLE

** image:debian:jessie - Debian 8 <<<image:debian:jessie>>>
Parent: scratch (perfect for building base images such as debian and busybox

** image:debian:stretch - Debian 9 <<<image:debian:stretch>>>
** image:buildpack-deps:jessie-scm
Parent: buildpack-deps:jessie-curl
Available: git, curl, wget, openssh-client

** image:buildpack-deps:stretch-curl
Parent: image:debian:stretch

** image:php:5.6.31-apache-jessie
<<<image:php:apache>>>
Short name: php:5.6.31-apache
Parent: debian:jessie
[[https://github.com/docker-library/php/blob/0bb4068bd639ba98631bc2999e0d20cae583ec00/5.6/jessie/apache/Dockerfile][Dockerfile]]

PHP_INI_DIR :: /usr/local/etc/php (/conf.d)
APACHE_CONFDIR :: /etc/apache2
APACHE_ENVVAR ::  /etc/apache2/envvars
APACHE_RUN_USER :: www-data
APACHE_DOCUMENT_ROOT, WORKDIR :: /var/www/html
EXPOSE 80
CMD ["apache2-foreground"]
/usr/local/bin/apache2-foreground

If you want to get some from PHP's source, you can extract, use and delete it.
#+BEGIN_EXAMPLE
FROM php:7.0-apache
RUN docker-php-source extract \
    # do important things \
    && docker-php-source delete
#+END_EXAMPLE

Install PHP Core Extensions
#+BEGIN_EXAMPLE
FROM php:7.0-fpm
RUN apt-get update && apt-get install -y \
        libfreetype6-dev \
        libjpeg62-turbo-dev \
        libmcrypt-dev \
        libpng-dev \
    && docker-php-ext-install -j$(nproc) iconv mcrypt \
    && docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ \
    && docker-php-ext-install -j$(nproc) gd
#+END_EXAMPLE

Install PECL Extensions
#+BEGIN_EXAMPLE
FROM php:7.1-fpm
RUN pecl install redis-3.1.0 \
    && pecl install xdebug-2.5.0 \
    && docker-php-ext-enable redis xdebug
FROM php:5.6-fpm
RUN apt-get update && apt-get install -y libmemcached-dev zlib1g-dev \
    && pecl install memcached-2.2.0 \
    && docker-php-ext-enable memcached
#+END_EXAMPLE

Install other extensions
#+BEGIN_EXAMPLE
FROM php:5.6-apache
RUN curl -fsSL 'https://xcache.lighttpd.net/pub/Releases/3.2.0/xcache-3.2.0.tar.gz' -o xcache.tar.gz \
    && mkdir -p xcache \
    && tar -xf xcache.tar.gz -C xcache --strip-components=1 \
    && rm xcache.tar.gz \
    && ( \
        cd xcache \
        && phpize \
        && ./configure --enable-xcache \
        && make -j$(nproc) \
        && make install \
    ) \
    && rm -r xcache \
    && docker-php-ext-enable xcache
#+END_EXAMPLE

The docker-php-ext-* scripts can accept an arbitrary path, but it must be absolute (to disambiguate from built-in extension names), so the above example could also be written as the following:

#+BEGIN_EXAMPLE
FROM php:5.6-apache
RUN curl -fsSL 'https://xcache.lighttpd.net/pub/Releases/3.2.0/xcache-3.2.0.tar.gz' -o xcache.tar.gz \
    && mkdir -p /tmp/xcache \
    && tar -xf xcache.tar.gz -C /tmp/xcache --strip-components=1 \
    && rm xcache.tar.gz \
    && docker-php-ext-configure /tmp/xcache --enable-xcache \
    && docker-php-ext-install /tmp/xcache \
    && rm -r /tmp/xcache
#+END_EXAMPLE

copy host config/php.ini to /usr/local/etc/php/php.ini (name has to be exact) or copy php-prod.ini to /usr/local/etc/php/conf.d/

*** Sample
#+BEGIN_EXAMPLE
FROM php:5.6.31-apache-jessie

# apt-utils has to be installed to avoid throwing errors during installation on Debian
RUN set -ex; \
    \
    apt-get update && apt-get install -y \
            apt-utils \
            nano \
            libfreetype6-dev \
            libmcrypt-dev \
            libjpeg62-turbo-dev \
            libpng-dev \
    && \
    apt-get clean && rm -rf /var/lib/apt/lists/* && \
    \
    docker-php-ext-install -j$(nproc) iconv mcrypt && \
    docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ && \
    docker-php-ext-install -j$(nproc) gd mysqli mysql pdo pdo_mysql pcntl zip opcache

COPY config/php-prod.ini /usr/local/etc/php/conf.d/

RUN { \
                echo 'opcache.memory_consumption=128'; \
                echo 'opcache.interned_strings_buffer=8'; \
                echo 'opcache.max_accelerated_files=4000'; \
                echo 'opcache.revalidate_freq=2'; \
                echo 'opcache.fast_shutdown=1'; \
                echo 'opcache.enable_cli=1'; \
        } > /usr/local/etc/php/conf.d/opcache-recommended.ini

# enable apache modules
RUN a2enmod rewrite expires

VOLUME /var/www/html

# TODO chown -R www-data:www-data /var/www/html

CMD ["apache2-foreground"]
#+END_EXAMPLE

** image:mysql:5.7.9
<<<image:mysql>>>
Parent :: image:debian:jessie
user:group :: mysql:mysql
Executable :: mysqld

EXPOSE 3306

*** Load configs
Startup config :: /etc/mysql/my.cnf and any .cnf files under /etc/mysql/conf.d 
Mount host directory to /etc/mysql/conf.d in container using ~-v~ in docker run

Instead of loading custom conf.d directory, tags (--tag-name) can be used adjust the configs

For container that couldn't have more than 128M memory, use innodb-buffer-pool-size to scale it down.
#+BEGIN_EXAMPLE
docker run --name my-mysql-container \
  -e MYSQL_ROOT_PASSWORD=my-secret-pw \
  -d mysql:5.7.9 \
  --character-set-server=utf8mb4 \
  --collation-server=utf8mb4_unicode_ci
  --innodb-buffer-pool-size=50M
#+END_EXAMPLE

In docker-compose.yml
#+BEGIN_EXAMPLE
command:
  mysqld --innodb-buffer-pool-size=50M
#+END_EXAMPLE

*** Environment vars
-e :: set environment vars. None of these will have effect if the container is started with a data dir that already contains a db.

MYSQL_ROOT_PASSWORD :: required
MYSQL_DATABASE :: opt. a db to be created on image startup
MYSQL_USER, MYSQL_PASSWORD :: opt. create a user for MYSQL_DATABASE.

These vars can be loaded through a file
#+BEGIN_EXAMPLE
-e MYSQL_ROOT_PASSWORD_FILE=/run/secrets/mysql-root
#+END_EXAMPLE

*** Import .sql on image startup
Poibt a directory that has a .sh, .sql, and .sql.gz to a dir in container

#+BEGIN_EXAMPLE
-v /host/path/to/db-dir:/docker-entrypoint-initdb.d
#+END_EXAMPLE

Importing needs a lot of memory. If host doesn't have 128M memory, try to import it locally and then rsync the persist data folder to host and chown -R 999:docker /path/to/persistdir accordingly on host.

*** Access, view logs, db dump
#+BEGIN_EXAMPLE
docker exec -it my-mysql-container bash
docker logs my-mysql-container
docker exec some-mysql sh -c \
  'exec mysqldump --all-databases -uroot -p"$MYSQL_ROOT_PASSWORD"' > /some/path/on/your/host/all-databases.sql
#+END_EXAMPLE

*** Persist data
A place to persist db data on host :: /my/own/datadir

#+BEGIN_EXAMPLE
-v /my/own/datadir:/var/lib/mysql
#+END_EXAMPLE

For dev where db data can be imported and disposed when needed, use volume (e.g. dbdata)
#+BEGIN_EXAMPLE
version: '2'

volumes:
  dbdata:

networks:
  app_net:
    driver: bridge
    ipam:
      driver: default
      config:
      - subnet: 172.18.0.0/16
        gateway: 172.18.0.1

services:
  db:
    image: mysql:5.7.9
    container_name: db
    volumes:
      - "dbdata:/var/lib/mysql"
      - "/my/own/datadir:/docker-entrypoint-initdb.d"
    networks:
      app_net:
        ipv4_address: 172.18.0.2
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: d7
      MYSQL_DATABASE: d7
      MYSQL_USER: d7
      MYSQL_PASSWORD: d7
#+END_EXAMPLE

*** Example

#+BEGIN_EXAMPLE
docker run -it --name my-db-container \
  -v dbdata:/var/lib/mysql \
  -v /path/to/db-dir:/docker-entrypoint-initdb.d \
  -e MYSQL_ROOT_PASSWORD=d7 \ 
  -e MYSQL_DATABASE=d7 \ 
  -e MYSQL_USER=d7 \ 
  -e MYSQL_PASSWORD=d7 \
  -d mysql:5.7.9
#+END_EXAMPLE

** image:lucee
<<<docker:image:lucee>>>
Image name: [[https://hub.docker.com/r/lucee/lucee4-nginx/][lucee/lucee4-nginx]]
Parent Images: lucee/lucee4 > tomcat:8.0.36-jre8 > openjdk:8-jre > buildpack-deps:stretch-curl

*** docker-compose.yml Dockerfile
docker-compose.yml
#+BEGIN_EXAMPLE
version: '2'
networks:
  app_net:
    driver: bridge
    ipam:
      driver: default
      config:
      - subnet: 172.16.2.0/24
        gateway: 172.16.2.1
services:
  lucee:
    build: .
    image: cflucee:latest
    container_name: lucee
    ports:
      - "80:80"
      - "8888:8888"
    volumes:
      - /home/you/db/access:/root/db/
      - /home/you/www:/var/www
      # Scheduled tasks are setup in http://127.0.0.1:8888/lucee/admin/web.cfm
      # /home/you/www/WEB-INF/lucee/scheduler/scheduler.xml > /var/wwww/WEB-INF/lucee/scheduler/scheduler.xml
      - /home/you/logs/tomcat:/usr/local/tomcat/logs
      - /home/you/logs/nginx:/var/log/nginx
      - /home/you/logs/lucee:/opt/lucee/web/logs
    networks:
      app_net:
        ipv4_address: 172.16.2.3

#+END_EXAMPLE

Dockerfile
#+BEGIN_EXAMPLE
FROM lucee/lucee4-nginx:4.5.1.024

ENV TZ=America/Toronto
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# Copy UcanAccess
COPY ucanaccess/* /usr/local/tomcat/lib/

# Custom tags
# Custom tags are manually copied to each host's root folder...
COPY config/customtags/* /opt/lucee/web/customtags/
# COPY config/customtags/* /opt/lucee/server/lucee-server/context/library/

# Tomcat configs
# COPY catalina.properties server.xml web.xml /usr/local/tomcat/conf/
COPY config/tomcat/server.xml /usr/local/tomcat/conf/
COPY config/tomcat/context.xml /usr/local/tomcat/conf/
# COPY config/tomcat/legacy_js.xml /usr/local/tomcat/conf/Catalina/127.0.0.1/legacy_js.xml

# Custom setenv.sh to load Lucee
COPY setenv.sh /usr/local/tomcat/bin/
RUN chmod a+x /usr/local/tomcat/bin/setenv.sh

# Default setenv.sh https://github.com/lucee/lucee-dockerfiles/blob/master/4.5/setenv.sh
# Added UcanAccess

# NGINX configs
COPY config/nginx/ /etc/nginx/
# /etc/nginx/nginx.conf :: Default not modified https://github.com/lucee/lucee-dockerfiles/blob/master/lucee-nginx/4.5/nginx.conf
# /etc nginx/default.conf :: https://github.com/lucee/lucee-dockerfiles/blob/master/lucee-nginx/4.5/default.conf

# Add datasources. Default https://github.com/lucee/lucee-dockerfiles/blob/master/4.5/lucee-server.xml
COPY config/lucee/lucee-server.xml /opt/lucee/server/lucee-server/context/lucee-server.xml

# Lucee server PRODUCTION configs
# COPY config/lucee/lucee-web.xml.cfm /opt/lucee/web/lucee-web.xml.cfm

# Deploy codebase to container
# COPY index.cfm /var/www
#+END_EXAMPLE

*** Add ucanaccess db driver to TomCat, Add M$ Access Datasources
Refer to docker:image:tomcat

Add Access datasource on yourdomain.com:8888/lucee/admin/server.cfm
Type: Other - JDBC Driver
Datasource name: abc
Class: net.ucanaccess.jdbc.UcanaccessDriver
Database: jdbc:ucanaccess:///home/MyName/www/database/MyMsAccessDB.mdb

Create a datasource using UI. One of the Lucee setting files will have this line in <datasources>
#+BEGIN_EXAMPLE
<data-source allow="511" 
blob="false" 
class="net.ucanaccess.jdbc.UcanaccessDriver" 
clob="false" connectionTimeout="1" custom="" database="" dbdriver="Other" 
dsn="jdbc:ucanaccess:///home/MyName/www/database/MyMsAccessDB.mdb" 
host="" metaCacheTimeout="60000" name="abc" 
password="abc test password" 
storage="false" validate="false"/>
#+END_EXAMPLE

*** Lucee server and web settings
Lucee server setting :: /opt/lucee/server/lucee-server/context/lucee-server.xml
Individual website setting :: /opt/lucee/web/lucee-web.xml.cfm

*** Custom tags (.cfm|.cfc) under /opt/lucee/web/customtags/
*** Change Lucee Server Admin UI password
[[https://gist.github.com/jlamoree/6c1fc89ca3b8ce2581eb76dadeb1ee53][Use this with a salt]] to generate hspw in Lucee server setting <cfLuceeConfiguration hspw="" salt="" version="4.5">
Refer to image:lucee:salt. It seems like you should use the salt that is in the default lucee-server.xml.
Can't use a random salt.

*** How does it work with Nginx?
Lucee operates on TomCat port 8888 using 127.0.0.1. Nginx forwards 80 incoming traffic to port 8888. 
By default, only *.cfm|cfc|cfr files are forwarded to 8888. Add more files to /etc/nginx/conf.d/default.conf

#+BEGIN_EXAMPLE
location ~* \.(cfm|cfc|cfr|jpe?g|js|css|png|gif|html)$ {
    proxy_pass http://127.0.0.1:8888;
    proxy_redirect off;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Server $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_connect_timeout 600;
    proxy_send_timeout 600;
    proxy_read_timeout 600;
    send_timeout 600;
  }
#+END_EXAMPLE

*** Virtual Directory and TomCat
Virtual Directory. Setup docker:image:tomcat:vd first, then setup forwarding
#+BEGIN_EXAMPLE
location ~* /legacy_js {
  proxy_pass http://127.0.0.1:8888;
  proxy_redirect off;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-Server $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_connect_timeout 600;
  proxy_send_timeout 600;
  proxy_read_timeout 600;
  send_timeout 600;
}
#+END_EXAMPLE

*** Add hosts

#+BEGIN_EXAMPLE
server {
  listen 80 default_server;
  server_name domain1.com;
  index  index.cfm index.html index.htm;
  root   /var/www/site1;
  server_name_in_redirect off;

  include allcf/common.conf;

  location ~* (/legacy_js)|(\.(cfm|cfc|cfr|jpe?g|js|gif|css|png|html)$) {
    proxy_pass http://127.0.0.2:8888;
    proxy_redirect off;
    proxy_set_header Host 127.0.0.2;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Server $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_connect_timeout 600;
    proxy_send_timeout 600;
    proxy_read_timeout 600;
    send_timeout 600;
  }

}

server {
  listen 80;
  server_name domain2.com;
  index  index.cfm index.html index.htm;
  root   /var/www/site2;
  server_name_in_redirect off;

  include allcf/common.conf;

  location ~* (/legacy_js)|(\.(cfm|cfc|cfr|jpe?g|js|gif|css|png|html)$) {
    proxy_pass http://127.0.0.3:8888;
    proxy_redirect off;
    proxy_set_header Host 127.0.0.3;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Server $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_connect_timeout 600;
    proxy_send_timeout 600;
    proxy_read_timeout 600;
    send_timeout 600;
  }

}
#+END_EXAMPLE

Add hosts in docker:image:tomcat:host

*** Scheduled Tasks
Create them in /lucee/admin/web.cfm
Checkout this file /var/www/WEB-INF/lucee/scheduler/scheduler.xml

** image:tomcat
<<<docker:image:tomcat>>>
Image name: tomcat:8.0.36-jre8

*** Settings
The default webapps (including TomCat Admin Console, localhost:8080/manager/html and .jar files) is in /usr/local/tomcat/webapps
The default connector port is 8080.

docker:image:lucee deletes this webapps folder, place it under /usr/local/tomcat/lucee which contains all .jar files.

Include that directory in catelina.properties in common.loader=${catalina.home}/lucee/*.jar

Define a <web-app> with multiple servlets in ${catalina.home}/web.xml to handle all .html and .cf(m|c) files.

When the web-app and Lucee servlet are built, new Lucee admin paths (context) are built :: 
127.0.0.1:8888/lucee/admin/server.cfm and web.cfm
Corresponding paths are /opt/lucee/server(/lucee-server) and opt/lucee/web

In ${catalina.home}/server.xml, define Host(s) as usual. 
Each <Host> has appBase="webapps" which is a folder under /usr/local/tomcat. Using the empty webapps folder is fine.

Each <Host> can have multiple <Context> with different path/docBase. 
The root directory of each Host can have:
- META-INF folder :: context.xml (server-dependent config, e.g. datasource),
- WEB-INF folder ::  web.xml (server-independent config, e.g. servlet mappings, docker:image:lucee:tasks)

If there's ${catalina.home}/context.xml, all hosts have these settings and 
override <Context> set in <Host> in server.xml and override ~<Context>~ in any ~META-INF/context.xml~ under all hosts:
${catalina_home}/[enginename]/[host]/META-INF/context.xml

The only time ~path~ attribute in ~<Context>~ has any effect is in the server.xml

*** Install UcanAccess JDBC driver to enable M$ Access datasource
Copy these jar files
#+BEGIN_EXAMPLE
COPY ucanaccess/* /usr/local/tomcat/lib/
#+END_EXAMPLE
ucanaccess-4.0.1.jar
lib/*.jar (commons-lang, commons-logging, hsqldb, jackcess)

Add these 2 lines to setenv.sh
#+BEGIN_EXAMPLE
UCANACCESS_HOME=/usr/local/tomcat/lib;
export UCANACCESS_HOME;
#+END_EXAMPLE

docker:image:lucee
#+BEGIN_EXAMPLE
COPY setenv.sh /usr/local/tomcat/bin/
RUN chmod a+x /usr/local/tomcat/bin/setenv.sh
#+END_EXAMPLE

*** Setup Virtual Directory per Host
<<<docker:image:tomcat:vd>>>
In /usr/local/tomcat/conf/server.xml, you can see how many hosts are defined. e.g.
#+BEGIN_EXAMPLE
<Server port="8005" shutdown="SHUTDOWN">
  <Listener className="org.apache.catalina.startup.VersionLoggerListener" />
  <Listener className="org.apache.catalina.core.AprLifecycleListener" SSLEngine="on" />
  <Listener className="..." />

  <Service name="Catalina">
    <Connector executor="tomcatThreadPool"
               port="8888" protocol="HTTP/1.1"
               connectionTimeout="20000"
               redirectPort="8443" />

    <Connector port="8009" protocol="AJP/1.3" redirectPort="8443" />

    <Engine name="Catalina" defaultHost="127.0.0.1">
      <Host name="127.0.0.1"  appBase="webapps"
            unpackWARs="true" autoDeploy="true">
        <Valve className="org.apache.catalina.valves.RemoteIpValve"
               remoteIpHeader="X-Forwarded-For"
               requestAttributesEnabled="true" />
        <Valve className="org.apache.catalina.valves.AccessLogValve" directory="logs"
               prefix="localhost_access_log" suffix=".txt"
               pattern="%h %l %u %t &quot;%r&quot; %s %b" />

        <Context path="" docBase="/var/www/">
          <JarScanner scanClassPath="false"/>
        </Context>
        <!-- You can define virtual directory here or follow the way of adding vd.xml-->
        <!-- 
        <Context path="/legacy_js" docBase="/path/outside/var/www/legacy_js"></Context>
        -->
      </Host>
    </Engine>
    
  </Service>

</Server>
#+END_EXAMPLE

Method 1 is to add a <Context> tag in a <Host> in server.xml. But for me it doesn't work when multiple hosts
need to have the same vd and it creates a lot of other problems.

General rule :: don't include more than 1 <Context> in each <Host> in server.xml

Method 2 is to create a file legacy_js.xml under ${catalina_home}/conf/Catalina/127.0.0.1/
Where Catalina is the engine name and 127.0.0.1 is the Host name.
#+BEGIN_EXAMPLE
# legacy_js.xml
<?xml version='1.0' encoding='utf-8'?>
<Context docBase="/root/vd/legacy_js/"></Context>
#+END_EXAMPLE

~http://127.0.0.1/legacy_js/abc.js~ points to ~/root/vd/legacy_js/abc.js~

If it's foo#bar.xml then ~http://127.0.0.1/foo/bar/abc.js~

Method 2 is not tested for multiple hosts usage...

Method 3 is tested.

Create relative symbolic link for docker usage.
/var/www/site2/legacy_js point to ../site1/source_legacy_js

#+BEGIN_EXAMPLE
cd /var/www/site2
ln -s ../site1/source_legacy_js/ legacy_js
#+END_EXAMPLE

TomCat can't follow relative symbolic link..
Add this line to ${catalina_home}/context.xml for TomCat 8
#+BEGIN_EXAMPLE
<Resources allowLinking="true"></Resources>
# For TomCat 7, add attribute allowLinking="true" to the only <Context>
#+END_EXAMPLE

I recently found out Method 3 doesn't work.. Here's Method 4. 
Don't reverse proxy to TomCat at all, if vd has only static files. In nginx default.conf
#+BEGIN_EXAMPLE
location ~* ^/legacy_js {
  # nginx serve the static files
}
location ~* \.(cfm|cfc|cfr|jpe?g|js)
#+END_EXAMPLE

*** Add host
<<<docker:image:tomcat:host>>>
Host name should be 127/8 ip address otherwise you need to setup DNS.
Refer to docker:image:tomcat:log

#+BEGIN_EXAMPLE
<Host name="127.0.0.2" appBase="webapps">
  <Valve className="org.apache.catalina.valves.RemoteIpValve"
         remoteIpHeader="X-Forwarded-For"
         requestAttributesEnabled="true" />
  <Valve className="org.apache.catalina.valves.AccessLogValve" directory="logs"
         prefix="localhost_access_log" suffix=".txt"
         pattern="%h %l %u %t &quot;%r&quot; %s %b" />

  <Context path="" docBase="/var/www/site1/">
    <JarScanner scanClassPath="false"/>
  </Context>
</Host>

<Host name="127.0.0.3" appBase="webapps">
<Valve className="org.apache.catalina.valves.RemoteIpValve"
       remoteIpHeader="X-Forwarded-For"
       requestAttributesEnabled="true" />
<Valve className="org.apache.catalina.valves.AccessLogValve" directory="logs"
       prefix="localhost_access_log" suffix=".txt"
       pattern="%h %l %u %t &quot;%r&quot; %s %b" />
<Context path="" docBase="/var/www/site2/">
  <JarScanner scanClassPath="false"/>
</Context>
<Context docBase="/var/www/vd/legacy_js/" path="/legacy_js"></Context>
</Host>
#+END_EXAMPLE

*** Restrict Access
Refer to docker:image:tomcat:log

#+BEGIN_EXAMPLE
<!-- RemoteAddrValue is %a in log -->
<Valve className="org.apache.catalina.valves.RemoteAddrValve"
       allow="allow.com" />
<!-- RemoteHostValue is %h in log -->
<Valve className="org.apache.catalina.valves.RemoteHostValve"
       allow="127.0.0.1,10.100.1.2" />
#+END_EXAMPLE

*** Logging
<<<docker:image:tomcat:log>>>
Google :: tomcat access log value
pattern
- %h :: remote host name. Or IP if enableLookups for the connector is false
        If request is passed from Nginx (proxy_pass), it's 127.0.0.1
        If request is directly from Internet, it's the requester's IP

- %a :: Remote IP address. Same as %h but IP only
        If request is passed from Nginx (proxy_pass), it's 127.0.0.1
        If request is directly from Internet, it's the requester's IP.

- %v :: Local server name.
        If request is passed from Nginx (proxy_pass), it's the name of <Host> in Tomcat
        If request is directly from Internet, it's the request domain name
- %A :: Local IP address. Tomcat server public IP
- %{local}p :: local port. Which is 80 or 8888 where is set in <Connector>
- %{remote}p :: remote port. IDK.. Maybe random
- %{xxx}i :: incoming header value. e.g. %{X-Forwarded-Host}
- %{xxx}o :: outgoing header value

** image:stilliard/pure-ftpd
<<<docker:image:ftp>>>
Image name: stilliard/pure-ftpd:hardened
Parent image: debian:jessie

https://github.com/stilliard/docker-pure-ftpd
By default, it only supports FTP not SFTP

Dockerfile
#+BEGIN_EXAMPLE
FROM stilliard/pure-ftpd:hardened

# e.g. you could change the defult command run:
CMD /run.sh -c 30 -C 5 -l puredb:/etc/pure-ftpd/pureftpd.pdb -E -j -R -P $PUBLICHOST -p 30000:30009

# /usr/sbin/pure-ftpd

# -c 50, --maxclientsnumber (no more than 50 people at once)
# -C 10, --maxclientsperip (no more than 10 requests from the same ip)
# -l puredb:/etc/pure-ftpd/pureftpd.pdb, --login (login file for virtual users)
# -E, --noanonymous (only real users)
# -j, --createhomedir (auto create home directory if it doesn't already exist)
# -R, --nochmod (prevent usage of the CHMOD command)

# -tls 1, Enables optional TLS support

# In Compose

# -P IP/Host setting for PASV support, passed in your the PUBLICHOST env var
# -p PASV port range
#+END_EXAMPLE

docker-compose.yml
#+BEGIN_EXAMPLE
version: '2'
networks:
  app_net:
    driver: bridge
    ipam:
      driver: default
      config:
      - subnet: 172.16.3.0/24
        gateway: 172.16.3.1
services:
  myftp:
    build: .
    image: myftp:latest
    container_name: newcomftp
    environment:
      - PUBLICHOST=ftp.yourdomain.com
    ports:
      - "21:21"
      - "30000-30009:30000-30009"
# open these many ports to support Passive Mode..
    volumes:
      - /host/storefiles/ftp:/home/ftpusers
      - /host/config/ftp/passwd:/etc/pure-ftpd/passwd
# a single `pureftps.passwd` file contains the user database
#     - /host/config/ftp/ssl:/etc/ssl/private
# a single `pure-ftpd.pem` file with server's SSL certificates for TLS support
    networks:
      app_net:
        ipv4_address: 172.16.3.3
#+END_EXAMPLE

Makefile
#+BEGIN_EXAMPLE
FTPCONFIG=/etc/pure-ftpd/passwd/pureftpd.passwd

.PHONY: default info start stop restart list adduser deluser

default:
	@echo "make [command]. Available commands are:"
	@echo "info, start, stop, restart, list, adduser, deluser"

info:
	@echo "List all virutal user: make list"
	@echo "Add a new user abc and make parent folder to /FTP"
	@echo 'make adduser username="abc" folder="FTP"'
	@echo 'Add a new user abc and make parent folder to root /'
	@echo 'make adduser username="abc" folder=""'
	@echo 'Delete a user abc: make deluser username="abc"'

start:
	sudo docker-compose up -d --build

stop:
	sudo docker-compose down -v

restart:
	sudo docker-compose down -v && sudo docker-compose up -d --build

enter:
	sudo docker exec -it newcomftp bash -I

list:
	@echo "<account>:<password>:<uid>:<gid>:<gecos>:<home directory>:<upload bandwidth>:<download bandwidth>:<upload ratio>:<download ratio>:<max number of connections>:<files quota>:<size quota>:<authorized local IPs>:<refused local IPs>:<authorized client IPs>:<refused client IPs>:<time restrictions>"
	sudo cat ~/config/ftp/passwd/pureftpd.passwd

adduser:
	sudo docker exec -it myftp pure-pw useradd $$username -f $(FTPCONFIG) -m -u ftpuser -d /home/ftpusers/$$folder

deluser:
	sudo docker exec -it myftp pure-pw userdel $$username -f $(FTPCONFIG) -m
#+END_EXAMPLE

Pureftp Manual
- [[https://download.pureftpd.org/pub/pure-ftpd/doc/README.Virtual-Users][Add User]]
- [[https://download.pureftpd.org/pub/pure-ftpd/doc/FAQ][FAQ]]
- ~man pure-ftpd~
- Start running ~/usr/sbin/pure-ftpd $some_flags~

** image:dockerfile-from-image
<<<image:dockerfile-from-image>>>
https://github.com/levonlee/dockerfile-from-image

docker run -v /var/run/docker.sock:/var/run/docker.sock dockerfile-from-image <IMAGE_TAG_OR_ID>
e.g.
docker run -v /var/run/docker.sock:/var/run/docker.sock dockerfile-from-image ubuntu

For windows
docker run -v //var/run/docker.sock:/var/run/docker.sock dockerfile-from-image ubuntu

Dockerfile (added one line: RUN chmod)
#+BEGIN_EXAMPLE
FROM alpine:3.2
MAINTAINER CenturyLink Labs <clt-labs-futuretech@centurylink.com>

RUN apk --update add ruby-dev ca-certificates && \
    gem install --no-rdoc --no-ri docker-api && \
    apk del ruby-dev ca-certificates && \
    apk add ruby ruby-json && \
    rm /var/cache/apk/*

ADD dockerfile-from-image.rb /usr/src/app/dockerfile-from-image.rb
RUN chmod +x /usr/src/app/dockerfile-from-image.rb

ENTRYPOINT ["/usr/src/app/dockerfile-from-image.rb"]
CMD ["--help"]
#+END_EXAMPLE

dockerfile-from-image.rb (same as GitHub)
#+BEGIN_EXAMPLE
#! /usr/bin/env ruby
require 'docker'
require 'optparse'

NONE_TAG = '<none>:<none>'
NOP_PREFIX = '#(nop) '

options = {}
commands = []

# Default to -h if no arguments
ARGV << '-h' if ARGV.empty?

OptionParser.new do |opts|
  opts.banner = "Usage: dockerfile-from-image.rb [options] <image_id>"

  opts.on("-f", "--full-tree", "Generate Dockerfile for all parent layers") do |f|
    options[:full] = f
  end

  opts.on_tail("-h", "--help", "Show this message") do
    puts opts
    exit
  end
end.parse!

image_id = ARGV.pop
abort('Error: Must specify image ID or tag') unless image_id

# Collect all image tags into a hash keyed by layer ID.
# Used to look-up potential FROM targets.
tags = Docker::Image.all.each_with_object({}) do |image, hsh|
  tag = image.info['RepoTags'].first
  hsh[image.id] = tag unless tag == NONE_TAG
end

loop do
  # If the current ID has a tag, render FROM instruction and break
  # (unless this is the first command)
  if !options[:full] && commands && tags.key?(image_id)
    commands << "FROM #{tags[image_id]}"
    break
  end

  begin
    image = Docker::Image.get(image_id)
  rescue Docker::Error::NotFoundError
    abort('Error: specified image tag or ID could not be found')
  end

  cmd = image.info['ContainerConfig']['Cmd']

  if cmd && cmd.size == 3
    cmd = cmd.last

    if cmd.start_with?(NOP_PREFIX)
      commands << cmd.gsub(NOP_PREFIX,'').gsub(/^USER[ |\t]+\[(.*)\]/,'USER \1')
    else
      commands << "RUN #{cmd}".split.join(' ')
    end
  end

  image_id = image.info['Parent']
  break if image_id == ''
end

puts commands.reverse
#+END_EXAMPLE

** image:ubuntu
~docker run -it --rm ubuntu /bin/bash~

trusty: 14.04
xenial (latest): 16.04

#+BEGIN_EXAMPLE
services:
  nodejs:
    image: ubuntu:latest
    
tty: true
#+END_EXAMPLE

** image:node
node:boron
Latest version 6.x (LTS)
Parent image: buildpack-deps:jessie
Available: git, openssh-client

Use ~docker logs -f container_name~ to tail log

** image:golang
golang:1.8
Parent image: buildpack-deps:jessie-scm
Available: make
Environment vars: GOPATH=/go
GOROOT: /usr/local/bin/
WORKDIR $GOPATH

~docker run -it --rm --name testgo golang:1.8 /bin/bash -I~ to go in

Running ~exec hello~ inside container will exit the container

To download, compile and run and exit the container:
#+BEGIN_EXAMPLE
docker run --rm golang:1.8 sh -c "go get github.com/golang/example/hello/... && exec hello"
#+END_EXAMPLE

To download the compiled hello command to host directory /tmp/bin:
~docker run --rm -v /tmp/bin:/go/bin golang:1.8 go get github.com/golang/example/hello/...~
Then run ~/tmp/bin/hello~ where hello is the parent directory name
(For private repo, add ~-it~ for inputing username and password)

* Go
** Basics, Command
Go is just an executable script file. Uninstall on Windows, go to Control Panel if you install using msi
On Linux, uninstall by just replacing the bin folder

Install on Windows using zip, extract it to C:\go so C:\go\bin exists. Add C:\go\bin to PATH. GOPATH is C:\Users\username\go
Refer to phpstorm:golang

#+BEGIN_EXAMPLE
echo $GOPATH
go version

# godoc <package_name>
godoc fmt

gofmt main.go
# -w write file
gofmt -w main.go

# Format all files in directory
go fmt ./...

# List environment variables
go env

# GOROOT = usr/local/go
# GOARCH and GOOS possible values
# cat $GOROOT/src/go/build/syslist.go
 
# Compile packages and dependencies based on 1 go file
go build main.go

# A package file name should be only lowercase letters

# Folder structure in GOPATH directory
# ./bin holds executables (compiled
# ./pkg
# ./src holds packages. In this folder, run go install
# to compile and executables in ./bin
# Change GOOS and GOARCH then go install again

# Standard library including builtin package are under $GOROOT/src, e.g. $GOROOT/src/fmt
# Or go online https://golang.org/pkg/fmt/
#+END_EXAMPLE

In Go Playground, the system time is always the same
http://play.golang.org

[[https://github.com/golang/go/wiki/IDEsAndTextEditorPlugins][Supported IDEs]]

*** go run -race *.go
-race is to detect data race
./compare.go
#+BEGIN_EXAMPLE
package main
import (...)
func f1
func f2
#+END_EXAMPLE

./main.go
#+BEGIN_EXAMPLE
package main
import (...)
func main() {
  f1()
}
#+END_EXAMPLE

** Syntax, Program Flow
Opening and closing brackets have to be in one line
#+BEGIN_EXAMPLE
// for ... {
// } else if x ==0 {
// } else {
#+END_EXAMPLE

Define variable in block
#+BEGIN_EXAMPLE
if x :=-42; x < 0 {
  // x will only be available in the if block
}
#+END_EXAMPLE

Switch
#+BEGIN_EXAMPLE
import (
  "math/rand"
  "time"
)

rand.Seed(time.Now().Unix())

result := ""

switch dow := rand.Intn(6) + 1; dow {
// between 0 and 6. Result is between 1 and 7
  case 1:
    result = "Sunday!"
  case 7:
    result = "Saturday!"
  default:
    result = "Weekday!"
}
fmt.Println(result)

// Conditional expression in switch!
x := -42;
switch {
  case x < 0:
    result = "Less than zero"
  case x == 0:
    result = "Equal to zero"
  default:
    result = "Greater than zero"
}
// By default, it breaks and goes to the end of switch if there's one case matched.
// break is not necessary but `fallthrough` replaces `break` in an opposite way
#+END_EXAMPLE

for
#+BEGIN_EXAMPLE
sum = 0
for i := 0; i < 10; i++ {
  sum += i
}

for sum < 1000 {
 sum += sum
 fmt.Println(sum)
 if sum > 200 {
   goto endofprogram
 }
}

endofprogram : fmt.Println("end of program")
// Use `break` or `continue` statements just like other language
#+END_EXAMPLE

** Standard Library of packages
*** builtin
http://golang.org/pkg/builtin/

**** new(), make()
new() :: Allocate but not initial memory. Results in 0 storage but return a memory address
make() :: Allocate and initialize memory. Results in non-zeroed storage and return a memory address

Zeroed storage means it can't accept value

Initialize complex objects before adding values. Declarations without make() can cause a panic
#+BEGIN_EXAMPLE
m := make(map[string]int)
m["key"] = 42
// map[key:42]
#+END_EXAMPLE

Memory is deallocated by garbage collector (GC).

GC clears objects that are out of scope or set to nil

*** fmt
**** Output
#+BEGIN_EXAMPLE
package main
import (
  fmt
)
func main() {
  str1 := "one"
  str2 := "two"
  aNumber := 42
  // var aNumber int
  // default aNumber is zero
  // Implicit typing using :=
  isTrue := true
  
  // Explicit: const anInteger int = 42
  // Implicit const aString = ".."
   
  fmt.Println(str1, str2) // "one two"
  
  stringLength, err := fmt.Println(str1, str2)
  // function can return multiple values, a string and an error

  if err == nil {
    fmt.Println("String Length", stringLength)
  }

  // Without the if err == nil, it will throw an error because error is not defined
  // Use _ to ignore the err variable even if it's not returned
  stringLength, _ := fmt.Println(str1, str2)
  fmt.Println("String Length", stringLength)

  fmt.Printf("Value of aNumber: %v\n", aNumber)
  fmt.Printf("Value of isTrue: %v\n", isTrue)
  fmt.Printf("Value of aNumber as float: %.2f\n", float64(aNumber)) // 42.00
  fmt.Printf("Data types: %T, %T, %T, %T",
     str1, str2, aNumber, isTrue
  )
  // string, string, int, bool
  

  // Return a string
  myString := fmt.Sprintf("data types: %T, %T, %T, %T", str1, str2, aNumber, isTrue)
  fmt.Print(myString)
}
#+END_EXAMPLE

%v :: only values
%+v :: add field names when printing struct
%#v :: add field names and name of the struct type when printing struct
%T :: type
%% :: literal %

Sprintf(format string, a ...interface{}) string :: format and return a string
Use this to convert a struct into string ~str := fmt.Sprintf("%#v", val)~

Fprintf(w io.Writer, format string, a ...interface{}) (n int, err error)

**** Input
#+BEGIN_EXAMPLE
import ("fmt")
  
func main() {
  var s1,s2 string
  fmt.Scanln(&s1, &s2)
  // Scan one line from terminal input, demilited by space
  fmt.Println(s1, s2)
}
#+END_EXAMPLE

#+BEGIN_EXAMPLE
import (
  "fmt"
  "bufio"
  "os"
  "strconv"
  "strings"
)

func main() {
  // := is to declare and assign value to a new variable
  reader := bufio.NewReader(os.stdin)
  fmt.Print("Enter text: ")
  str, _ := reader.ReadString('\n')
  // Single quote means it's a byte not a string
  fmt.Print(str)
  // one two three

  fmt.Print("Enter text: ")
  str, _ = reader.ReadString('\n')
  f, err := strconv.ParseFloat(strings.TrimSpace(str), 64)
  if err != nill {
    fmt.Println(err)
  } else {
    fmt.Println("Value of number: ", f);
  }
}
#+END_EXAMPLE

*** strings
strings.ToUpper(str)
strings.Title(str) // Initial capped
strings.EqualFold(str1, str2) // case-insensitive compare
// default == is case-sensitive
strings.Contains(str, "exp") // true/false

*** math
#+BEGIN_EXAMPLE
import (
  "fmt"
  "math/big"
  "math"
)
i1, i2, i3 := 12, 45, 68
intSum := i1 + i2 + i3 // Good!

f1, f2, f3 := 23.5, 65.1, 76.3
floatSum := f1 + f2 + f3 // Not good

var b1, b2, b3, bigSum big.Float
b1.SetFloat64(23.5)
b2.SetFloat64(65.1)
b3.SetFloat64(76.3)
bigSum.Add(&b1, &b2).Add(&bigSum, &b3)
fmt.Printf("BigSum = %.10g\n", &bigSum)

circleradius := 15.5
circumference := circleRadius * math.Pi
fmt.Printf("Circumference: %.2f\n", circumference)
#+END_EXAMPLE

*** time
#+BEGIN_EXAMPLE
import (
  "fmt"
  "time"
)

t := time.Date(2009, time.November, 10, 23, 0,0,0, time.UTC)
now := time.Now()
fmt.Printf("Go launched at %s\n", t)
now.Month()
now.Day()
now.Weekday()

tomorrow := now.AddDate(0,0,1)

longFormat := "Monday, January 2, 2006"
fmt.Println("Tomorrow is ", tomorrow.Format(longFormat))

shortFormat := "1/2/06"

t := time.Now()

fmt.Printf("%d %02d %02d %02d %02d %02d\n",
t.Year(), t.Month(), t.Day(),
t.Hour(), t.Minute(), t.Second())
#+END_EXAMPLE

#+BEGIN_EXAMPLE
start := time.Now()
// ...
end := time.Now()
delta := end.Sub(start)
// Or
fmt.Println(time.Since(start).Seconds())
#+END_EXAMPLE

*** sort
http://golang.org/pkg/sort

*** io, os, path
#+BEGIN_EXAMPLE
import (
  "io"
  "os"
  "io/ioutil"
  "path/filepath"
)

func main() {
  content := "Hello from Go!"
  file, err :=os.Create("./fromString.txt")
  checkError(err)
  
  defer file.Close()

  ln, err := io.WriteString(file, content)

  checkError(err)
  
  fmt.Printf("All done with file of %v characters", ln)
  
  // convert a string to binary
  bytes := []byte(content)
  // 0644 is file permission
  ioutil.WriteFile("./fromBytes.txt", bytes, 0644)
  
  // Read a file
  fileName := "./hello.txt"
  // read as binary
  content, err := ioutil.ReadFile(fileName)
  checkError(err) 
  // binary/byte
  fmt.Println(content)
  result := string(content)
  fmt.Println(result)

  // Reader a directory
  root, _ := filepath.Abs(".")
  
  fmt.Println(root)

  err := filepath.Walk(root, processPath)
  checkError(err)

}

func checkError(err error) {
  if err != nil {
    // Stop if there's an error
    panic(err)
  }
}

func processPath(path string, info os.Fileinfo, err error) error {
  if err != nil {
    return err
  }

  // not root
  if path != "." {
    if info.IsDir() {
      fmt.Println("Directory:", path)
    } else {
      fmt.Println("File:", path)
    }
  }
  
  return nil
}
#+END_EXAMPLE

Print OS environments
#+BEGIN_EXAMPLE
// To set a key/value pair, use `os.Setenv`. To get a
// value for a key, use `os.Getenv`. This will return
// an empty string if the key isn't present in the
// environment.
os.Setenv("FOO", "1")
fmt.Println("FOO:", os.Getenv("FOO"))
fmt.Println("BAR:", os.Getenv("BAR"))

// Use `os.Environ` to list all key/value pairs in the
// environment. This returns a slice of strings in the
// form `KEY=value`. You can `strings.Split` them to
// get the key and value. Here we print all the keys.
fmt.Println()
for _, e := range os.Environ() {
     pair := strings.Split(e, "=")
     fmt.Println(pair[0])
}
#+END_EXAMPLE

*** path/filepath
#+BEGIN_EXAMPLE
filepath.Walk("../images/", func(path string, info os.FileInfo, err error) {
  if info.IsDir() {
    return nil
  }
  fmt.Println(path)
  return nil
})
#+END_EXAMPLE

*** encoding/json, encoding/csv
Refer to golang:net/http:json
#+BEGIN_EXAMPLE
json.NewDecoder(r io.Reader) *Decoder
json.Unmarshal(data []byte, v interface{}) error

// convert any json string to struct
import ("encoding/json" "fmt" "reflect") 

var input = `
{
  "response_type": "in_channel",
  "text": "hello text",
  "attachments": [
    { "text": "attachment text" }
  ]
}
`
var val map[string]interface{}

if err := json.Unmarshal([]byte(input), $val); err != nil {
  panic(err)
}

fmt.Println(val)
// map[response_type:in_channel text:hello text attachments:[map[text:attachment text]]]
for k, v := range val {
  fmt.Println(k, reflect.TypeOf(v))
}
#+END_EXAMPLE

#+BEGIN_EXAMPLE
import (
 "os"
 "encoding/csv"
)

f, err := os.Open("../abc.txt")
checkError(err)
defer f.Close()

rdr := csv.NewReader(f)
rdr.Comma = '\t'
rdr.TrimLeadingSpace = true
rows, err := rdr.ReadAll()
checkError(err)
for i, row := range rows {
  fmt.Println(row[i])
}
#+END_EXAMPLE

*** log
Output to stdout

#+BEGIN_EXAMPLE
import ( "log" )
log.Println(string(body))
#+END_EXAMPLE

Write to os.Stdout os.Stderr
#+BEGIN_EXAMPLE
import (
"io"
"io/ioutil"
"log"
"os"
)
var (
  Trace *log.Logger
  Info *log.Logger
  Warning *log.Logger
  Error *log.Logger
)
func Init(
  traceHandle io.Writer,
  infoHandle io.Writer,
  warningHandle io.Writer,
  errorHandle io.Writer) {
  Trace = log.New(traceHandle, 
     "TRACE: ",
     log.Ldate|log.Ltime|log.Lshortfile)

  Info = log.New(infoHandle, 
     "INFO: ",
     log.Ldate|log.Ltime|log.Lshortfile)

  Warning = log.New(warningHandle, 
     "WARNING: ",
     log.Ldate|log.Ltime|log.Lshortfile)

  Error = log.New(errorHandle, 
     "ERROR: ",
     log.Ldate|log.Ltime|log.Lshortfile)

  // log.New(out io.Writer, prefix string, flag int)
}

func main() {
  // system devices that support io.Writer interface
  Init(ioutil.Discard, os.Stdout, os.Stdout, os.Stderr)
  
  // write to stdout
  Info.Pringln("...")
}
#+END_EXAMPLE

Write to file
#+BEGIN_EXAMPLE
file, err := os.OpenFile("file.txt", os.O_CREATE|os.WRONLY|os.O_APPEND, 0666)
if err != nil {
  log.Fatalln("Failed to open log file", output, ":", err)
}

multi := io.MultiWriter(file, os.Stdout)

MyFile := log.New(multi,
       "PREFIX: ",
       log.Ldate|log.Ltime|log.shortfile)
#+END_EXAMPLE

log.Fatalln("...") same as Println() but followed by a call to os.Exit(1)
log.Panicln() same as Println() but followed by panic()

*** os/exec
**** Basics
#+BEGIN_EXAMPLE
import (
  "fmt"
  "os"
  "os/exec"
)

func main() {
  cmd := "curl"
  args := []string{"https://..."}
  
  /* if command contains wildecard *
     exec.Command("/bin/sh", "-c", "mv ./source_dir/* ./dest_dir")
   */

  // Simply run
  if err := exec.Command(cmd, args...).Run(); err != nil {
    fmt.Println(os.Stderr, err)
    os.Exit(1)
  }
  fmt.Println("Success!")
  // Simply run.

  // Run and catch STDOUT
  var (
    cmdOut []byte
    err error
  )

  if cmdOut, err = exec.Command(cmd, args...).Output(); err != nil {
    fmt.Fprintln(os.Stderr, "An error: ", err)
    os.Exit(1)
  }
  
  result := string(cmdOut)
  // Run and catch STDOUT
  
  // Catch output line by line as a stream
  // Use cmd.Start() and cmd.Wait()
  // Catch stdout by adding pipe

  cmd2 := exec.Command(cmd, args...)
  cmdReader, err := cmd2.StdoutPipe()
  if err != nil {
    fmt.Fprintln(os.Stderr, "Error creating StdoutPipe for cmd", err)
    os.Exit(1)
  }
  
  // import "bufio"
  scanner := bufio.NewScanner(cmdReader)
  go func() {
    for scanner.Scan() {
      fmt.Printf("Output header | %s\n", scanner.Text())
    }
  }()

  err = cmd2.Start()
  if err != nil {
    fmt.Fprintln(os.Stderr, "Error starting Cmd", err)
  }
  
  err = cmd2.Wait()
  if err != nil {
    fmt.Fprintln(os.Stderr, "Error waiting for Cmd", err)
    os.Exit(1) 
  }
  // Catch output line by line as a stream.
}
#+END_EXAMPLE

**** SSH command
#+BEGIN_EXAMPLE
type SSHCommander struct {
	User string
	IP   string
}

func (s *SSHCommander) Command(cmd ...string) *exec.Cmd {
	arg := append(
		[]string{
			fmt.Sprintf("%s@%s", s.User, s.IP),
		},
		cmd...,
	)
	return exec.Command("ssh", arg...)
}

func main() {
	commander := SSHCommander{"root", "50.112.213.24"}

	cmd := []string{
		"apt-get",
		"install",
		"-y",
		"jq",
		"golang-go",
		"nginx",
	}

	if err := commander.Command(cmd...); err != nil {
		fmt.Fprintln(os.Stderr, "There was an error running SSH command: ", err)
		os.Exit(1)
	}
}
#+END_EXAMPLE

**** Cmd
Customize a command before it gets run by Run, Output or CombinedOutput methods
#+BEGIN_EXAMPLE
cmd := "git"
args := []string{"status"}

cmd2 := exec.Command(cmd, arg...)
// Working directory otherwise is the process's current dir
cmd2.Dir = "/home/user/"
#+END_EXAMPLE

*** net/http
**** HTTP request
#+BEGIN_EXAMPLE
resp, err := http.Get("http://example.com/")
...
resp, err := http.Post("http://example.com/upload", "image/jpeg", &buf)
...
resp, err := http.PostForm("http://example.com/form",
	url.Values{"key": {"Value"}, "id": {"123"}})
#+END_EXAMPLE

#+BEGIN_EXAMPLE
import (
  "io/ioutil"
  "net/http"
  "encoding/json"
  "strings"
  "math/big"
)

type Tour struct {
  Name, Price string
}

func main() {
  url := "http://..."
  resp, err := http.Get(url)
  checkError(err)
  fmt.Printf("Response type: %T\n", resp)

  // Important!!!
  defer resp.Body.Close()

  bytes, err := ioutil.ReadAll(resp.body)
  checkError(err)
  content := string(bytes)
  fmt.Pritnln(content)
  
  tours := toursFromJson(content)
  fmt.Println(tours)
 
  for _, tour := range tours {
    // price is a string and convert to float
    price, _, _ := big.ParseFloat(tour.Price, 10, 2, big.ToZero)
    fmt.Printf("%v $%.2f\n", tour.Name, price)
  }
}

func toursFromJson(content string) []Tour {
  tours := make([]Tour, 0, 20)

  decoder := json.NewDecoder(strings.NewReader(content))
  
  _, err := decoder.Token()
  checkError(err)

  var tour Tour
  for decoder.More() {
    err := decoder.Decode(&tour)
    checkError(err)
    tours = append(tours, tour)
  }

  return tours
}

#+END_EXAMPLE

HTTP POST json
#+BEGIN_EXAMPLE
tmp := `{"text": "delayed response", "attachments": [{ "text": "test"}]}`
// or
// tmp, err := json.Marshal(myStruct)
req := bytes.NewBuffer([]byte(tmp))
resp, err := http.Post(sc.ResponseURL, "application/json", req)
checkError(err)
body, _ := ioutil.ReadAll(resp.Body)
fmt.Println(string(body))
#+END_EXAMPLE

**** HTTP server
***** Use http.Handle
#+BEGIN_EXAMPLE
import (
  "fmt"
  "net/http"
  "html/template"
)

// default Handler
type Hello struct{}

// Implement handler that is an interface
func (h Hello) ServeHTTP(w http.ResponseWriter, r *http.Request) {
  fmt.Fprintf(w, "<h1>hello</h1>")
}

// func Handle(pattern string, handler Handler)
// type Handler interface {
//  ServeHTTP(resp, *request)
// }

func main() {
  var h Hello
  err := http.ListenAndServe(":4000", h)
  // addr string, handler Handler
  // if handler is nil, DefaultServeMux is used
  // or localhost:4000 (only localhost:4000 listens. multiple domain, non localhost, can be resolved to the same server)
  checkError(err)
}
#+END_EXAMPLE

***** Use http.HandleFunc
#+BEGIN_EXAMPLE
// HandleFunc add handlers to DefaultServeMux
http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
  fmt.Fprintf(w, "hello html")
})

fmt.Println(http.ListenAndServe(":4000", h))
checkError(err)
#+END_EXAMPLE

***** Template
#+BEGIN_EXAMPLE
import "html/template"

type Page struct {
  Name string
}

func main() {
  templates := template.Must(template.ParseFiles("templates/index.html"))

  http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
    p := Page{Name: "Gopher"}

    if err := templates.ExecuteTemplate(w, "index.html", p); err !=  nil {
      http.Error(w, err.Error(), http.StatusInternalServerError)
    }
  })
}
#+END_EXAMPLE

index.html
#+BEGIN_EXAMPLE
{{.Name}}
#+END_EXAMPLE
If url.name is defined, then that will be displayed

***** Read POST data
****** Content-Type json <<<golang:net/http:json>>>
#+BEGIN_EXAMPLE
type test_struct struct {
  Test string
  IsNew bool // JSON booleans
  Age float64 // JSON numbers
  myArray []interface{} // JSON arrays
  myObj map[string]interface{} // JSON objects
  isNull nil // JSON null
}

func test(w http.ResponseWriter, r *http.Request) {
  // Read body as a whole
  body, err := ioutil.ReadAll(r.Body)
  checkError(err)
  log.Println(string(body))
  
  //decoder := json.NewDecoder(r.Body)
  var t test_struct
  err = json.Unmarshal(body, &t)
  checkError(err)
  fmt.Fprintf(w, t.Test)

  // Get Header
  if a := r.Header.Get("x-hub-signature"); len(a) == 0 {
    panic()
  }
   
}

func main() {
  http.HandleFunc("/test", test)
}
#+END_EXAMPLE

See linux:curl:post

****** Content-Type:application/x-www-form-urlencoded
#+BEGIN_EXAMPLE
r.ParseForm()
r.Form.Get("key")
res := r.FormValue("<your param name>")
#+END_EXAMPLE

****** Return Json as application/json
#+BEGIN_EXAMPLE
func testjson(w http.ResponseWriter, r *http.Request) {
  body, err := ioutil.ReadAll(r.Body)
  checkError(err)
  type slackResponse struct {
    ResponseType string `json:"response_type"`
    Text string `json:"text"`
    Attachments []map[string]string `json:"attachments"`
  }
  a2 := []map[string]string{map[string]string{"text": string(body)}}
  resp := slackResponse{"in_channel", a2}
  js, err := json.Marshal(resp)
  checkError(err)
  w.Header().Set("Content-Type", "application/json")
  w.Write(js)

  /* Or you can just output a json string
  var p = `{
  "response_type": "in_channel",
  "attachments": [
     {  "text": "%s" }
   ]
}`
   resp := fmt.Sprintf(p, string(body))
   w.Header().Set("Content-Type", "application/json")
   fmt.Fprintf(w, resp)
  */

}
func main() {
  http.HandleFunc("/json", testjson)
}
#+END_EXAMPLE

More complicated value `attachments`
#+BEGIN_EXAMPLE
// this is the json to construct
// {"response_type":"in_channel","text":"hello text","attachments":[{"text":"attachment text"},{"text2":{"name":"hello"}}]}

type Profile struct {
	Response_type string `json:"response_type"`
	Text          string `json:"text"`
	Attachments []interface{} `json:"attachments"`
}

func main() {
	a2 := make([]interface{}, 2)
	a2[0] = map[string]string{"text": "attachment text"}
	a2[1] = map[string]map[string]string{"text2": map[string]string{"name": "hello"}}
	profile := Profile{"in_channel", "hello text", a2}
        js, err := json.Marshal(profile)
        checkError(err)
	fmt.Println(string(js))
	str := fmt.Sprintf("%#v", profile)
	fmt.Println(str)
}
#+END_EXAMPLE

** Custom package, Third Party Package
For third-party packages, godoc.org and github.com/avelino/awesome-go
https://www.lynda.com/Go-tutorials/What-you-should-know-before-watching-course/439416/472998-4.html?srchtrk=index%3a1%0alinktypeid%3a2%0aq%3ago+language%0apage%3a1%0as%3arelevance%0asa%3atrue%0aproducttypeid%3a2
$GOPATH/src/mypkg
#+BEGIN_EXAMPLE
package main
// define a package name.

// main() is the starting point in go run
func main() {
  n1, l1 := FullName("Zaphod", "Beeblerox")
}

// captital P means this method is public instead of private in this package
func Println() {
}

func addValues(value1 int, value2 int) int {
// can also be value1, value2 int
  return value1 + value2
}

func addAllValues(values ...int) int {
  sum := 0
  for i := range values {
    sum += values[i]
  }
  return sum
}

func FullName(f, l string) (string, int) {
  full := f + " " + l
  length := len(full)
  return full, length
}

func FullNameNakedReturn(f, l string) (full string, length int) {
  // The returned variables have already been declared
  // Don't use :=
  full = f + " " + l
  length = len(full)
  return
}

# mypkg.Println(...)

import (
  // github.com/username/reponame/foldername/example.go
  "github.com/username/reponame/foldername"
  // alias
  stdimage "image"
)

#+END_EXAMPLE

All packages and codes should be under one go workspace which the folder at GOPATH.
Assuming GOPATH is ~/go in Windows installation.

#+BEGIN_EXAMPLE
cd ~/go
mkdir -p src/github.com
git clone ../gitusername/myreponame
~/go/src/github.com/gitusername/reponame/pkg1/pkg1.go
~/go/src/github.com/gitusername/reponame/pkg2/pkg2.go

# build all necessary packages
go get github.com/gitusername/reponame/...
# ~/go/bin/pkg1 (executable)
# ~/go/bin/pkg2 (executable)

# Build one package
go get github.com/gitusername/reponame/pkg1/...
# ~/go/bin/pkg1 (executable)

# At ~/go/src/github.com/gitusername/reponame, run this to see if there's compile error
go build ...

# At ~/go/src/github.com/gitusername/reponame, run this to format all .go files
go fmt ./...
#+END_EXAMPLE

** Types
*** Basic
float32 float54
complex64 complex128
Integers:
 int8 int16 int32 int64
 only positive numbers and zero (unsigned): uint8 uint16 uint32 uint64
 byte uint int uintptr

Data collections:
 Arrays Slices Maps Structs

Language organization:
 Functions Interfaces Channels

Data management
 Pointers

Type conversion
#+BEGIN_EXAMPLE
var int1 int = 5
var float1 float64 = 42
var s := `{ "votes": { "option": "3"} }`
sum := float64(int1) + float1
// convert string to byte
bytevar := []byte(s)

// convert string array to string
stringArray := []string{"Hello","world","!"}
justString := strings.Join(stringArray," ")

// Convert string to float golang:strconv
f, err := strconv.ParseFloat(strings.TrimSpace(str), 64)

// Delcare only for multiple variables
var (
  count int
  sum float64
)

var a, b string
a, b := "", ""
#+END_EXAMPLE

*** array
Array can't be sorted or resized
#+BEGIN_EXAMPLE
var colors [3]string
colors[0] = "Red"
colors[1] = "Green"
fmt.Println(colors)
// [Red Green]
fmt.Println(colors[1])
// Green

// Define in one line
var numbers = [5]int{5,3,1,2,4}

// Array length
// len(colors)

for i := 0; i < len(colors); i++ {
  fmt.Println(colors[i])
}

for i := range colors {
  fmt.Pritnln(colors[i])
}
#+END_EXAMPLE

*** slice
slice is built on top of array
#+BEGIN_EXAMPLE
var colors = []string{"Red", "Green", "Blue"}
fmt.Println(colors)
// The same as array

// Add item to end of slice
colors = append(colors, "Purple")
// Remove the first item in slice
colors = append(colors[1:len(colors)])
// Below is the same to remove the firs item in slice
// as the default on the right of : is the length of the slice
colors = append(colors[1:])
// Remove the last item in slice
// the default on the left of : is 0
colors = append(colors[:len(colors)-1])

// Declare a slice using make
numbers := make([]int, 5, 10)
// 5 is inital size, 10 is capacity (optional)
// Current capacity cap(numbers)
// Define 5 values, then add another item, 
numbers = append(numbers, 123)
// cap(numbers) is 2+10 = 12

// import("sort")
sort.Ints(numbers) // ascending
#+END_EXAMPLE

*** map
Map is an unorderd collection of key-value pairs

#+BEGIN_EXAMPLE
states := make(map[string]string)
// empty: map[]
states["WA"] = "Washington"
states["OR"] = "Oregon"
// map[WA:Washington OR:Oregon]

delete(states, "OR")

for k, v := range states {
  fmt.Printf("%v: %v\n", k, v)
}

// create a slice to hold keys of a map
keys :=make([]string, len(states))
i := 0
for k := range states {
  keys[i] = k
  i++
}

sort.Strings(keys)

for i := range keys {
  fmt.Println(states[keys[i]])
}
#+END_EXAMPLE

*** struct, interface
Struct is a data structure. Similar to Java's classes: encapsulate data and methods. No inheritance.

Every value in Go is an instance of a type, and every type is an implementation of at least one interface, the interface without any methods.

You may see function like this.
#+BEGIN_EXAMPLE
func Errorf(format string, a ...interface{}) {}

// ...interface{} means it can be multiple values of all types
#+END_EXAMPLE

#+BEGIN_EXAMPLE
type Dog struct {
  Breed string
  Weight int
  Sound string
}

// Define method for a Struct
func (d Dog) Speak() {
  // d is a reference (copy) of the original object
  // changing d here doesn't affect the variable in global scope
  fmt.Println(d.Sound)
}

func (d *Dog) SpeakThreeTimes() {
  // d is a point to the original object
  // Changing d here also changes the variable in global scope
  d.Sound = fmt.Sprintf("%v! %v! %v!", d.Sound, d.Sound, d.Sound)
  fmt.Println(d.Sound)
}

// Define an interface
type Animal interface {
  SpeakWord() string
}

func (d Dog) Speak() string {
  return "Woof!"
}

// Attach interface to other class

type Cat struct {
  // ...
}

func (c Cat) Speak() string {
  return "Meow!"
}

func main() {
  poodle := Dog{"Poodle", 34, "Woof"}
  // fmt.Println(poodle)
  // {Poodle, 34, Woof}

  // dump field name and values
  fmt.Printf("%+v\n", poodle)
  // {Breed:Poodle Weight:34 Sound:Woof}
  
  poodle.Sound = "Arf"
  
  poodle.Speak()

  poodle2 := Animal(Dog{})
  // This dog has an interface!
  // Or this dog is converted to interface Animal
  fmt.Println(poodle2)

  // Attach interface to multiple objects of different types
  animals := []Animal{Dog{}, Cat{}}
  for _, animal := range animals {
    // _ means to throw away the index
    fmt.Println(animal.Speak())
  }

}
#+END_EXAMPLE

*** pointer
#+BEGIN_EXAMPLE
// craete a pointer
var p *int
if p != nil {
  fmt.Println(*p)
} else {
  fmt.Println("p is nil")
}

var v int = 42
p = &v
// explict
var value1 float64 = 42.13
pointer1 := &value1
fmt.Println(*p)

*pointer1 = *pointer1 / 42
// both value1
fmt.Println(*pointer, value1)
#+END_EXAMPLE

*** error
#+BEGIN_EXAMPLE
import "errors"

myError := errors.New("My error string")
fmt.Println(myError)
// str := myError.Error()

attendance := map[string]bool{
  "Ann": true,
  "Mike": true}

attended, ok := attendance["Mike"]
if ok {
  // do things  
} else {
  // return error
}
#+END_EXAMPLE

** Concurrency
#+BEGIN_EXAMPLE

// Avoid race condition
var mu sync.Mutex
var wg sync.WaitGroup
wg.Add(len(paths))

for _, path := range paths {
  go func(path string) {
    pixels := getPixels(path)
    mu.Lock()
    {
      images = append(images, pixels)
    }
    mu.Unlock()
    wg.Done()
  }(path)
}
#+END_EXAMPLE

** Structure
#+BEGIN_EXAMPLE
# $GOPATH
./src/libraries
./src/palindrome
./src/stringutil

# Go to the directory that has a go file that has main() function
# and run go install
#+END_EXAMPLE

Defer
defer keyword only works within a function
Deferred statements are FILO and are run at the end of the current function, 
rather than waiting for the entire application
Good for disconnect database
#+BEGIN_EXAMPLE
defer fmt.Println("Statement 1")
defer fmt.Println("Statement 2")
defer fmt.Println("Statement 3")
defer fmt.Println("Undeferred statement")
// Undeferred statement, 3, 2, 1
#+END_EXAMPLE

** Shrink compiled binary file size
#+BEGIN_EXAMPLE
# same as go get, go install
go build -ldflags="-s -w" cmd/go
#+END_EXAMPLE

It strips the DWARF tables needed for debugging, but keeps the annotations needed for stack traces (also panic as well)

Then use linux:upx to further compress it.

** Project <<<project:golang>>>
*** Github Webhook
main.go
#+BEGIN_EXAMPLE
package main

import (
	"fmt"
	"net/http"
	"io/ioutil"
	"os"
	"os/exec"
	"log"
	"crypto/hmac"
	"crypto/sha1"
	"encoding/hex"
	"encoding/json"
	"errors"
	"strings"
)

type test_struct struct {
	Repository map[string]interface{}
}

type GitHubHookContext struct {
	Signature string
	Event string
	Id string
	Payload []byte
}

type CIFolder struct {
	repo string
	Path string
}

func checkError(err error) {
	if err != nil {
		panic(err)
	}
}

func signBody(secret, body []byte) []byte {
	computed := hmac.New(sha1.New, secret)
	computed.Write(body)
	return []byte(computed.Sum(nil))
}

func verifySecret(secret []byte, signature string, body []byte) bool {

	const signaturePrefix = "sha1="
	const signatureLength = 45 // len(SignaturePrefix) + len(hex(sha1))

	if len(signature) != signatureLength || !strings.HasPrefix(signature, signaturePrefix) {
		return false
	}

	actual := make([]byte, 20)
	hex.Decode(actual, []byte(signature[5:]))

	return hmac.Equal(signBody(secret, body), actual)
}

func ParseGitHubHookContext(secret []byte, r *http.Request) (*GitHubHookContext, error) {

	hc := GitHubHookContext{}

	if hc.Signature = r.Header.Get("x-hub-signature"); len(hc.Signature) == 0 {
		return nil, errors.New("No signature!")
	}
	log.Println("Signature: ", hc.Signature)

	if hc.Event = r.Header.Get("x-github-event"); len(hc.Event) == 0 {
		return nil, errors.New("No event!")
	}
	log.Println("Event: ", hc.Event)

	if hc.Id = r.Header.Get("x-github-delivery"); len(hc.Id) == 0 {
		return nil, errors.New("No event Id!")
	}
	log.Println("ID: ", hc.Id)

	body, err := ioutil.ReadAll(r.Body)
	if err != nil {
		return nil, err
	}

	if !verifySecret(secret, hc.Signature, body) {
		return nil, errors.New("Invalid signature")
	}

	hc.Payload = body
	return &hc, nil
}

func pullGitHub(path string) {
	var args []string
	args = []string{"reset", "--hard"}
	runCommands(path, "git", args, "git reset error: ")
	args = []string{"clean", "-df"}
	runCommands(path, "git", args, "git clean error: ")
	args = []string{"checkout", "master"}
	runCommands(path, "git", args, "git checkout master error: ")
	args = []string{"pull"}
	runCommands(path, "git", args, "git pull error: ")
}

func runCommands(path string, cmd string, args []string, msg string) {
	var (
		cmdOut []byte
		err error
	)
	outputArgs := strings.Join(args, " ")
	log.Println("Running ", cmd, outputArgs)
	actual := exec.Command(cmd, args...)
	actual.Dir = path
	if cmdOut, err = actual.Output(); err != nil {
		log.Println(os.Stderr, msg, err)
		os.Exit(1)
	}

	log.Println(string(cmdOut))
}

func main() {
	http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		secret := os.Getenv("GB_WEBHOOK_KEY")
		hc, err := ParseGitHubHookContext([]byte(secret), r)
		if err != nil {
			log.Printf("Failed processing hook! ('%s')", err)
			panic(err)
		} else {

			if hc.Event == "push" {
				//log.Println(string(hc.Payload))
				var t test_struct
				err = json.Unmarshal(hc.Payload, &t)
				checkError(err)

				switch reponame := t.Repository["full_name"]; reponame {
				case "NewcomDev/nodejs":
					pullGitHub("/home/newcom/www/nodejs-dev")
				}

			}
		}

		fmt.Fprintf(w, "hello html")
		//out := fmt.Sprintf("%#v", r.URL)
		//fmt.Fprintf(w, out)
	})

	fmt.Println(http.ListenAndServe(":49162", nil))
}
#+END_EXAMPLE

#+BEGIN_EXAMPLE
sudo docker run -it --rm --name testgo -v /home/newcom/digitalocean/docker/newcomgo:/go golang:1.8 /bin/bash -I
# Inside Golang
go build main.go

# Go to project folder
./main
#+END_EXAMPLE

** To Learn
Concurrency in Go
Goroutine
- a lightweight synchronized thread managed by the runtime
Channel
- a typed conduit for msgs between goroutines
Select
- Lets a goroutine wait for multiple communication operations

Web Frameworks (REST)
- Beego, Martini, Gorilla, Gocraft, Revel

Database Drivers
- Standard db functions: database/sql
- Driver interfaces: database/sql/driver
- https://github.com/golang/go/wiki/SQLDrivers

* Vagrant
** Install
Install Oracle VM Virtualbox first
https://www.virtualbox.org/wiki/Downloads
VirtualBox Oracle VM VirtualBox Extension Pack is needed
https://www.vagrantup.com/docs/virtualbox/
VirtualBox version 5.0.x and 5.1.x are supported by Vagrant 1.x

Simply install the latest version of VirtualBox to upgrade

Error: "VT-x/AMD-V hardware acceleration is not available"
On Windows, check if Hyper-V is on by going to Windows Features.
Turn it off. As Windows takes over the hardware acceleration.

~optionalfeatures.exe~ goes directly to Windows Features.

Then reboot and change UEFI or BIOS setting
- name might be "Intel VT-x, VT-d, Virtualization Extensions, Vanderpool" under Chipset, Northbridge or CPU configuration.

Simply install the latest version to upgrade
https://www.vagrantup.com/downloads.html

#+BEGIN_EXAMPLE
vagrant --version
# 1.x
where vagrant

# download image and create Vagrantfile
vagrant init hashicorp/precise64
vagrant up && vagrant ssh
#+END_EXAMPLE

** Vagrant VM, VirtualBox
#+BEGIN_EXAMPLE
# Status of all Vagrant VM's
vagrant global-status --prune

# List all running VirtualBox VMs
# vboxmanage.exe is not in PATH, change directory
cd /c/Program Files/Oracle/VirtualBox
vboxmanage list runningvms

# VirtualBox version
vboxmanage --version
#+END_EXAMPLE

** Frequent commands
#+BEGIN_EXAMPLE
# force to run provision
vagrant up --provision
# or
vagrant reload --provision

# remove the current vagrant VM
vagrant destroy -f

# shut down and boot up
vagrant halt
vagrant up

# Hibernate
vagrant suspend

# Shut down and up
vagrant reload

# current vagrant vm running status
vagrant status

# Show current vagrant vm ssh config
vagrant ssh-config
# Usually it's 127.0.0.1:2222, notice the port may change as vagrant will auto select port if it's in use
#+END_EXAMPLE

** Vagrantfile
ruby language
#+BEGIN_EXAMPLE
# -*- mode: ruby -*-
# vi: set ft=ruby :
ENV["LC_ALL"] = "en_US.UTF-8"
# In case host couldn't pass locale into vagrant

hostname = livagrantdev
cpus = 2
memory = 2048

@importmysql = <<SCRIPT
echo "docker run -it --rm -v /vagrant/mydbdump:/tmp/mydbdump"\
" --link wordpressdb:wpdb mysql:5.7.9 sh -c"\
" 'exec mysql"\
' -h"$WPDB_PORT_3306_TCP_ADDR" -P"$WPDB_PORT_3306_TCP_PORT"'\
' -uroot -p"$WPDB_ENV_MYSQL_ROOT_PASSWORD"'\
' wordpress < /tmp/mydbdump/pantheon_db.sql'\
"'" >> /home/vagrant/import_db.sh
chmod +x /home/vagrant/import_db.sh
SCRIPT

Vagrant.configure(2) do |config|
# config.vm
	config.vm.box = username/boxname
# optional
# config.vm.box_version = "1.1.0"
# config.vm.box_url = "http://"

# hostname, appears when you vagrant ssh - vagrant@yourhostname
config.vm.hostname = hostname

# network
	config.vm.network "private_network", ip: "192.168.33.10"
# VMs in the the private network (VirtualBox) can communicate
# Give a static IP
	config.vm.network "forwarded_port", guest: 22, host: 2222, id: "ssh"
	config.vm.network "forwarded_port", guest: 80, host: 8080, auto_correct: true
# On local host (windows), 192.168.33.10:8080

# Synced folder
# default /vagrant
# Create a root folder (readonly) in guest machine to hold Dockerfiles for docker provisioner
# Create that folder if it doesn't exist in guest machine
	config.vm.synced_folder "./build/docker", "/docker_builds", create: true, mount_options: ["ro"]

	config.vm.provider "virtualbox" do |vb|
	 vb.memory = memory
	 vb.cpus = cpus
	 vb.name = hostname
	 # The name appears on VirtualBox GUI
	 #  Can override any settings config.vm, config.ssh, config.winrm and config.vagrant
	end

# Provision
# Upload File using SSH user (vagrant)
	config.vm.provision "file", source: "~/.gitconfig", destination ".gitconfig"


# In line Shell
	config.vm.provision "shell", inline: @importmysql
# Path to script file Shell
# config.vm.provision "shell",

# Provisioner docker - install docker on the VM and pull images!
config.vm.provision "install_docker", type: "docker" do |d|
	d.pull_images "mysql:5.7.9"
	d.pull_images "wordpress"
# Need to create a root folder in guest machine to pull Dockerfile
	d.build_image "/docker_builds", args: "-t li-nginx-alpine -f /docker_builds/Dockerfile.li-nginx-alpine"
# This is the same as
# docker build -t li-nginx-alpine -f /docker_builds/Dockerfile.li-nginx-alpine /docker_builds/

end

# Provisioner docker_compose: install docker_compose on the VM!
# Require plugin `vagrant-docker-compose`
config.vm.provision "docker_compose_plugin", type: "docker_compose"

# config.ssh
# config.winrm
# config.vagrant

end
#+END_EXAMPLE

Do a loop
#+BEGIN_EXAMPLE
(1..3).each do |i|
	config.vm.define "node-#{i}" do |node|
		node.vm.provision "shell",
			inline: "echo hello from node #{i}"
	end
end
#+END_EXAMPLE

** Vagrant plugin
Install vagrant-docker-compose plugin which installs Docker Compose as a provisioner 
~vagrant plugin install vagrant-docker-compose~

https://github.com/leighmcculloch/vagrant-docker-compose

Install vagrant-vbguest which automatically installs VirtualBox Guest Additions (VBGA) on Vagrant VM.
~vagrant plugin install vagrant-vbguest~

To prevent updating VBGA when ~vagrant up~, add ~config.vbguest.auto_update = false~ in Vagrantfile. This happens when .box file has older version of vbguest while Vagrant on host has a newer version.

Update all installed plugins ~vagrant plugin update~

List all installed plugins ~vagrant plugin list~

Uninstall a plugin ~vagrant plugin uninstall vagrant-docker-compose~

After Vagrant core is upgraded, you might need to auto upgrade existing plugins ~vagrant plugin expunge --reinstall~

vagrant plugin install vagrant-docker-compose
#+BEGIN_EXAMPLE
Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/trusty64"

  config.vm.provision :docker
  config.vm.provision :docker_compose
end
#+END_EXAMPLE

** Box
A VirtualBox, ~.box~ file, is a compressed box on top of which a VM can run.
Box has a namespace ~username/boxname~ as in ~hashicorp/precise64~

#+BEGIN_EXAMPLE
# export the running VM to a new box file
vagrant package --output boxfile.box

# decompress a box file to ~/.vagrant.d/boxes
vagrant box add boxname boxfile.box

# boxname is an installed Vagrant box
# destroy current running Vagrant box
vagrant destroy -f
# and
rm Vagrantfile
# Setup another Vagrantfile which uses the newly created box
cofnig.vm.box = "boxname"

# To package an installed Vagrant box (of a specific provider and version)
# into a .box file
vagrant box repackage <boxname> <provider> <version>

# remove a vagrant box
vagrant box remove boxname
# or
vagrant box remove boxname --box-version=0.1.7

# List all installed Vagrant boxes
vagrant box list

# Check if the box used in the current folder is up-to-date
vagrant box outdated

# if it's not outdated and before destroy current Vagrant machine, update the box
vagrant box update
vagrant box update --box boxname
# Destroy the current Vagrant machine and up again.
#+END_EXAMPLE

Vagrant .box should have these qualities:
- vagrant as a user and map /vagrant to the current folder in host
- be able to install as the Vagrant provision plugin instructs. 

The ubuntu/xenial64 has a lot of trouble with that and hence it's not a good Vagrant box to start with.

*** bento/ubuntu-16.04
vagrant box add bento/ubuntu-16.04

** Custom Box
https://github.com/levonlee/vagrant/tree/master/wordpress
https://blog.engineyard.com/2014/building-a-vagrant-box
https://scotch.io/tutorials/how-to-create-a-vagrant-base-box-from-an-existing-one

** SSH using Putty
Download PuttyGen to accept OpenSSH key as vagrant provides.

PuttyGen > Load > ~/.vagrant.d/ folder and select browse all files, select insecure_public_key
PuttyGen > Save public key file as insecure_public_key.ppk and save it to the same folder. Close PuttyGen and go back to Putty
Putty > Connection > SSH > Auth, browse and select that ppk file.
Connect using Putty!

Specify the username for login: Putty > Connection > Data > Auto-login username

~/.vagrant.d/ is the global. Different box has ./.vagrant/ folder. Run ~vagrant ssh-config~ to identify the $HOSTNAME $PORT $LOGINNAME
Convert the Identityfile to .ppk with SSH-2-RSA with 2048 bits and save it to the same folder.

* Apache
** Basics
Run this to get Apache version, root and config file ~httpd -V~ or ~apache2 -v~ in Ubuntu

** Ubuntu install
apt-get update; apt-get install apache2

service apache2 restart

Refer to image:php:apache to get configs

Show all loaded modules :: ~apache2ctl -M~

Show parsed vhost settings and run settings :: ~apache2ctl -S~
#+BEGIN_EXAMPLE
VirtualHost configuration:
*:80                   172.17.0.7 (/etc/apache2/sites-enabled/000-default.conf:1)
ServerRoot: "/etc/apache2"
Main DocumentRoot: "/var/www/html"
Main ErrorLog: "/var/log/apache2/error.log"
Mutex default: dir="/var/lock/apache2" mechanism=fcntl
Mutex mpm-accept: using_defaults
Mutex watchdog-callback: using_defaults
Mutex rewrite-map: using_defaults
PidFile: "/var/run/apache2/apache2.pid"
Define: DUMP_VHOSTS
Define: DUMP_RUN_CFG
User: name="www-data" id=33
Group: name="www-data" id=33
#+END_EXAMPLE

Sites :: /etc/apache2/sites-enabled/
Sample
#+BEGIN_EXAMPLE
<VirtualHost *:80>
        # The ServerName directive sets the request scheme, hostname and port that
        # the server uses to identify itself. This is used when creating
        # redirection URLs. In the context of virtual hosts, the ServerName
        # specifies what hostname must appear in the request's Host: header to
        # match this virtual host. For the default virtual host (this file) this
        # value is not decisive as it is used as a last resort host regardless.
        # However, you must set it for any further virtual host explicitly.
        #ServerName www.example.com

        ServerAdmin webmaster@localhost
        DocumentRoot /var/www/html/public

<Directory /var/www/html/public>
                Options Indexes FollowSymLinks MultiViews
                AllowOverride All
                Order allow,deny
                allow from all
</Directory>

        # Available loglevels: trace8, ..., trace1, debug, info, notice, warn,
        # error, crit, alert, emerg.
        # It is also possible to configure the loglevel for particular
        # modules, e.g.
        #LogLevel info ssl:warn

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

        # For most configuration files from conf-available/, which are
        # enabled or disabled at a global level, it is possible to
        # include a line for only one particular virtual host. For example the
        # following line enables the CGI configuration for this host only
        # after it has been globally disabled with "a2disconf".
        #Include conf-available/serve-cgi-bin.conf
</VirtualHost>
#+END_EXAMPLE

** Production Setup
<<<apache:production>>>

This guide is for httpd. Optimize Webhost Setup
~nano /etc/httpd/conf/httpd.conf~

#+BEGIN_EXAMPLE
Timeout 30
KeepAlive on
MaxKeepAliveRequests 50
KeepAliveTimeout 15
#Changes to prefork module
<IfModule prefork.c>
  StartServers 3
  MinSpareServers 2
  MaxSpareServers 5
  ServerLimit 256
  MaxClients 10
  MaxRequestsPerChild 1000
</IfModule>
#+END_EXAMPLE

Search ~AllowOverrride~ and set it to All for
#+BEGIN_EXAMPLE
<Directory />
  Options FollowSymLinks
  AllowOverride All
</Directory>
#+END_EXAMPLE

And

#+BEGIN_EXAMPLE
# AllowOverride controls what directives may be placed in .htaccess files.
# It can be "All", "None", or any combination of the keywords:
# Options FileInfo AuthConfig Limit
#
AllowOverride All
#+END_EXAMPLE

Restart Apache ~service httpd restart~

** Force to download a PDF file
The path doesn't matter
#+BEGIN_EXAMPLE
<FilesMatch "aPDFfile.pdf">
  ForceType application/octet-stream
  Header add Content-Disposition "attachment"
</filesMatch>
#+END_EXAMPLE

** Wordpress Redirect
RewriteRule with redirect flag [R] is to redirect URL. Without it, RedirectRule maintains the URL on LHS in the address bar.
Redirect and RedirectMatch is to redirect
Redirect means the URL in the address bar will change

RewriteRule without proxy flag [P] is to maintain the URL on LHS in RewriteRule and served to $_SERVER['REQUEST_URI']
RewriteRule with [P] is to change the URL to the one on RHS in RewriteRule and pass it to the proxy
[P] requires mod_proxy enabled

The only way to modify $_SERVER['REQUEST_URI'] is to do a redirect or with the [P] flag.

RewriteRule is relative to the directory that the current .htaccess is in for both RHS and LHS.
RewriteBase only affects the dest of RewriteRule (RHS) only if dest is a relative path

Redirect /dealdays to /DealDays
#+BEGIN_EXAMPLE
# custom RewriteRule goes before the wordpress block
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /
  RewriteRule ^dealdays/?(.*)$ /DealDays/$1 [R=302,L]
  RewriteRule ^abc/?(.*)$ /subdir/abc.php [L]
</IfModule>
# custom RewriteRule end

# BEGIN WordPress
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.php [L]
</IfModule>

# END WordPress

# default wordpress htaccess block is to redirect to index.php if it's not a file and not a directory
# Rules below the block has to be either a file or an existing directory

RewriteRule ^dealdays/(.*)$ /DealDays/$1 [R=301,L]
# If redirect to another url, use
# Redirect is prefix match and append additional path info beyond the matched URL-path to the new/target URL.
# a.com/dealdays2 to b.com/dealdays2, a.com/dealdays2/foo.txt to b.com/dealdays2/foo.txt, a.com/dealdays2/xyz to b.com/dealdays2/xyz
# Redirect syntax :: Redirect [status] [URL-path] URL
# [URL-path] is case-sensitive beginning with slash. relative path is not allowed
# URL may be either an absolute URL beginning with scheme and hostname or a URL-path beginning with a slash
Redirect 301 /dealdays2 http://b.com/dealdays2

# Redirect without appending additional path info
# RedirectMatch is like Redirect but regex
# syntax :: RedirectMatch [status] regex URL
RedirectMatch 302 ^/dealdays2/?$ http://b.com/dealdays2

# case insensitive just add (?i) in front of the pattern
RedirectMatch 302 (?i)^dealdays2/?$  /dealdays/
#+END_EXAMPLE

Redirect root domain only but not other URI. e.g. mysite.com or www.mysite.com redirect to abc.com but not mysite.com/xyz to abc.com/xyz
#+BEGIN_EXAMPLE
RewriteEngine on
RewriteCond %{HTTP_HOST} ^(www\.)?mysite\.com [NC]
# no www :: RewriteCond %{HTTP_HOST} ^mysite\.com [NC]

RewriteCond %{REQUEST_URI} ^/$
# Rewriterule ^(.*)$ http://abc.com/ [L,R=301]
Rewriterule ^$ http://abc.com/ [L,R=301]
#+END_EXAMPLE

Redirect www.abc.com to abc.com
#+BEGIN_EXAMPLE
RewriteCond %{HTTP_HOST}  ^www.abc.com [NC]
RewriteRule ^(.*) http://abc.com/$1 [L,R=301]
#+END_EXAMPLE

** ReWrite a path to sub directory with .htaccess
URL /inventory/* rewrite to /my-app/public/*

./my-app/public/index.php is where the app starts
./my-app/app/*.* are the app codes
./my-app/public/theme/*.* and ./my-app/public/uploads/*.* have the assets

./.htaccess
#+BEGIN_EXAMPLE
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
RewriteRule ^inventory/?$ /my-app/public/index.php [L]
RewriteRule ^inventory/(.*)$ /my-app/public/$1 [L]
</IfModule>
#+END_EXAMPLE

./my-app/public/.htaccess
#+BEGIN_EXAMPLE
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /my-app/public/
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /my-app/public/index.php [L]
</IfModule>
#+END_EXAMPLE

** RewriteCond
Rewrite based on time
#+BEGIN_EXAMPLE
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
RewriteRule ^dealdays/?(.*)$ /DealDays/$1 [R=302,L]
RewriteCond %{TIME_YEAR}%{TIME_MON}%{TIME_DAY}%{TIME_HOUR} >2017110521
RewriteRule ^DealDays/?(.*)$ / [R=302,L]
</IfModule>
#+END_EXAMPLE

** Rewrite flags
L|last :: stop processing other rules
NC|nocase
P|proxy :: handle request by mod_proxy

QSA|qsappend :: Default behavior of RewriteRule is to discard the existing query string, and replace it with the newly generated one. Use it to cause the query string to be combined
e.g. ~RewriteRule "/pages/(.+)" "/page.php?page=$1" [QSA]~
/pages/123?one=two will be mapped to /page.php?page=123&one=two

** Redirect to HTTPS
<<<apache:https>>>
#+BEGIN_EXAMPLE
RewriteEngine On 
RewriteCond %{SERVER_PORT} 80 
# or
# RewriteCond %{HTTPS} off

# test one page
# RewriteCond %{REQUEST_URI} ^/page-path-name/$

RewriteRule ^(.*)$ https://www.example.com/$1 [R,L]
# or
# RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI} [R,L]
#+END_EXAMPLE

A specific domain
#+BEGIN_EXAMPLE
RewriteEngine On 
RewriteCond %{HTTP_HOST} ^example\.com [NC]
RewriteCond %{SERVER_PORT} 80 
RewriteRule ^(.*)$ https://www.example.com/$1 [R,L]
#+END_EXAMPLE

Force SSL on a specific folder. Place this .htaccess in that folder
#+BEGIN_EXAMPLE
RewriteEngine On 
RewriteCond %{SERVER_PORT} 80 
RewriteCond %{REQUEST_URI} folder 
RewriteRule ^(.*)$ https://www.example.com/folder/$1 [R,L]
#+END_EXAMPLE

* Nginx
** Install on Ubuntu 16.04
#+BEGIN_EXAMPLE
sudo apt-get update
sudo apt-get install nginx
#+END_EXAMPLE

*** Config Firewall <<<nginx:ufw>>>
This is optional if firewall ~ufw~ doesn't exist.

Nginx registers itself as a service with firewall ~ufw~
~sudo ufw app list~

Output
#+BEGIN_EXAMPLE
Available applications:
  Nginx Full
  Nginx HTTP
  Nginx HTTPS
  OpenSSH
#+END_EXAMPLE

Nginx Full: This profile opens both port 80 (normal, unencrypted web traffic) and port 443 (TLS/SSL encrypted traffic)
Nginx HTTP: This profile opens only port 80 (normal, unencrypted web traffic)
Nginx HTTPS: This profile opens only port 443 (TLS/SSL encrypted traffic)

Enable Nginx HTTP
#+BEGIN_EXAMPLE
sudo ufw allow 'Nginx HTTP'
sudo ufw status
#+END_EXAMPLE

Output
#+BEGIN_EXAMPLE
Status: active

To                         Action      From
--                         ------      ----
OpenSSH                    ALLOW       Anywhere                  
Nginx HTTP                 ALLOW       Anywhere                  
OpenSSH (v6)               ALLOW       Anywhere (v6)             
Nginx HTTP (v6)            ALLOW       Anywhere (v6)
#+END_EXAMPLE

*** Service Check
Use service if systemctl doesn't exist.

systemctl status nginx

Output
#+BEGIN_EXAMPLE
● nginx.service - A high performance web server and a reverse proxy server
   Loaded: loaded (/lib/systemd/system/nginx.service; enabled; vendor preset: enabled)
   Active: active (running) since Mon 2016-04-18 16:14:00 EDT; 4min 2s ago
 Main PID: 12857 (nginx)
   CGroup: /system.slice/nginx.service
           ├─12857 nginx: master process /usr/sbin/nginx -g daemon on; master_process on
           └─12858 nginx: worker process
#+END_EXAMPLE

systemctl stop/start/restart/reload/disable/enable nginx

restart drops connection, use reload to not drop connection
disable nginx service, default the nginx service is to start automatically

** /etc/nginx /var/log
Config directory.

*** /etc/nginx/sites-available/
The directory where per-site "server blocks" can be stored.
Nginx will not use config files in this directory unless they are linked to the ~sites-enabled~ directory.

There should be a default file you can use. /etc/nginx/sites-available/default
#+BEGIN_EXAMPLE
server {
        listen 80 default_server;
        listen [::]:80 default_server;

        root /var/www/html;
        index index.html index.htm index.nginx-debian.html;

        server_name _;

        location / {
                try_files $uri $uri/ =404;
        }
}
#+END_EXAMPLE

ATTENTION! Only one server block can have default_server
Search if there is any file has default_server
#+BEGIN_EXAMPLE
grep -R default_server /etc/nginx/sites-enabled/
#+END_EXAMPLE

#+BEGIN_EXAMPLE
sudo cp /etc/nginx/sites-available/default /etc/nginx/sites-available/example.com
sudo nano /etc/nginx/sites-available/example.com
#+END_EXAMPLE

/etc/nginx/sites-available/example.com
#+BEGIN_EXAMPLE
server {
        listen 80;
        listen [::]:80;

        root /var/www/example.com/html;
        index index.html index.htm index.nginx-debian.html;

        server_name example.com www.example.com;

        location / {
                try_files $uri $uri/ =404;
        }
}
#+END_EXAMPLE

Enable the server block and restart Nginx

sudo ln -s /etc/nginx/sites-available/example.com /etc/nginx/sites-enabled/

In order to avoid a possible hash bucket memory problem that can arise from adding additional server names, we will go ahead and adjust a single value within our /etc/nginx/nginx.conf file. Open the file now:
#+BEGIN_EXAMPLE
sudo nano /etc/nginx/nginx.conf
#+END_EXAMPLE

Within the file, find the server_names_hash_bucket_size directive. Remove the # symbol to uncomment the line:
#+BEGIN_EXAMPLE
http {
    . . .

    server_names_hash_bucket_size 64;

    . . .
}
#+END_EXAMPLE

Check syntax
#+BEGIN_EXAMPLE
sudo nginx -t
sudo systemctl restart nginx
#+END_EXAMPLE

*** /etc/nginx/sites-enabled/
The directory where enabled per-site "server blocks" are stored.

*** /etc/nginx/snippets/
This directory contains config fragments that can be included elsewhere in the Nginx config.

*** /var/log/nginx/access.log
Every request to your web server is recorded

*** /var/log/nginx/error.log

** Command Line
stop, quit, reopen, reload :: ~nginx -s reload~
Version in short :: ~nginx -v~

** Config nginx.conf
Main global config /etc/nginx/nginx.conf

#+BEGIN_EXAMPLE
user www-data;
worker_processes 4;
pid /run/nginx.pid;

events {
  ...
}

http {
  sendfile off;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 65;
  types_hash_max_size 2048;
  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  access_log /var/log/nginx/access.log ;
  error_log /var/log/nginx/error.log;

  include /etc/nginx/conf.d/*.conf;
} 
#+END_EXAMPLE

Define server(s) in /etc/nginx/conf.d/default.conf
#+BEGIN_EXAMPLE
# comment starts here.
# You should always add a server to catch any requests without "Host" header
server {
  listen 80;
  server_name ""; # this line can be omitted if version > 0.8.48
  return 444;
}

# another server
server {

}
#+END_EXAMPLE

** Server
Include directives :: listen, server_name, root, index
Include blocks :: location

#+BEGIN_EXAMPLE
server {
  listen 80 default_server;
# or without any default_server in listen, the first server with listen is the default server
# listen 80;

# listen actually is a combo of ip and port 192.168.1.1:80
# nginx first identify which ip:port has the incoming request, then try to match the server_name from the request
# if no server_name matches, then it goes to the default_server for ip:port
# If no ip is set in ip:port, then 0.0.0.0 is used
# If no port is set in ip:port, then 80 is used
# If no listen is set, then 0.0.0.0:80 is used
# If only ip is specified (no port), it has a higher specificity than only port is specified.

  server_name example.org www.example.org;
  
# server_name :: can contain wildcards that either at start or end.
# *.example.org matches www.example.org and www.sub.exmple.org as well.
# nginx first searches for the exact match of a prefix given by literal strings (no regex, no wildcard)
# If not found, then checks for leading wildcard first then trailing wildcard (no regex)
# In each case if there're multiple matches, the longest match will be used
# Then nginx checks server_name given by regex in the order listed
# The first matching regex stops the search and nginx will use that server_name
# If no regex is matched, then uses the most specific prefix found earlier

# server_name regex always starts with ~. Recommended to always start with ^ and end with $
# e.g. server_name ~^www\d+\.example\.net$;
# regex containing { and/or } should be quoted entirely
# e.g. server_name "~^(?<name>\w\d{1,3}+)\.example\.net$"
# named capture :: later $name can be used
# always use named capture as $1 will be passed down to any sub directives and server_name is usually
# one of the top directives

# Special server_name :: "" you can do this
# server_name example.org "";
# This matches any server name
# server_name _;

  index index.cfm index.html index.htm;
  root /var/www;

# root combines with uri to get a file. e.g. /var/www/uripart1/uripart2
# If the result is a directory and doesn't have an index file (e.g. index.cfm set in index)
# Then it will return 403 forbidden
# Turn on autoindex will list files in directory
# autoindex on; 

# include any common config files. /etc/nginx/common/*.conf
  include common/common.conf
}
#+END_EXAMPLE

** Server name redirect

#+BEGIN_EXAMPLE
server {
  server_name .mydomain.com;
# this matches *.mydomain.com
  return 301 http://www.adifferentdomain.com$request_uri;
}
#+END_EXAMPLE

** location
location blocks are usually under server blocks
#+BEGIN_EXAMPLE
# location syntax
# location optional_modifier location_match {...}
# location only matches URI without URL parameters

# modifier =
location = /page1 {
  # exact match
  # if there is a match, return this immediately
}

# modifier ^~, non regex match
location ^~ /site {
  # This is a prefix match: /site/*
  # If this match (with ^~) is the longest prefix match, return immediately
}

# no modifier, the location_match part is a prefix
location /site {
  # This is also a prefix match: handles /site, /site/*, /site/page1/index.html
  # If this match (without ^~) is the longest prefix match, 
  # save for the moment and move on to regex matches
}

# modifier ~ or ~*, regex match
location ~ \.(jpe?g|png|gif|ico)$ {
  # ~ case-sensitive, ~* is case-insensitve
  # By now, if there is a prefix match (also longest prefix match), it's already stored in memory
  # These regex matches are checked by the listed order
  # Stop searching for the first matching regex, and return immediately
  # If no regex match, then return the previous found longest prefix match

  # So if there's a regex match, then the regex match will be used

  # Also notice, if there're any regex matches that are within the longest prefix match, 
  # those will be evaluated, in listed order, before any of the other regex matches.
}

# one location can "jump" to another location
root /var/www/main;
location / {
  rewrite ^/rewriteme/(.*)$ /$1 last;
  try_files $uri $uri.html $uri/ /fallback/index.html;
}

location /fallback {
  root /var/www/another;
}

# /rewriteme/hello > /hello > /hello, /hello.html, /hello/, /fallback/index.html

# one location can "jump" to another location :: custom 404
root /var/www/main;
location / {
  error_page 404 /another/whoops.html;
}

location /another {
  root /var/www;
}
#+END_EXAMPLE

** proxy_pass directive
*** Basic
If proxy_pass is specified with a URI, then when a request is passed to the server, the part of a normalized request URI matching the location is replaced by a URI specified in the directive
#+BEGIN_EXAMPLE
location /name/ {
    proxy_pass http://127.0.0.1/remote/;
# or http://127.0.0.1/
}
#+END_EXAMPLE

If proxy_pass is specified without a URI, the request URI is passed to the server in the same form as sent by a client when the original request is processed, or the full normalized request URI is passed when processing the changed URI
#+BEGIN_EXAMPLE
location /some/path/ {
    proxy_pass http://127.0.0.1;
}
#+END_EXAMPLE

proxy_pass can have URI parts if it's under a non-regex location block
#+BEGIN_EXAMPLE
location / {
  proxy_pass http://127.0.0.1:8888/long/uri;
# There's no trailing '/'
}
#+END_EXAMPLE

proxy_pass without URI under a regex location block will pass URI to the proxy
#+BEGIN_EXAMPLE
location ~* \.(cfm|...|html)$) {
  proxy_pass http://127.0.0.1:8888;
}
#+END_EXAMPLE

proxy_pass with URI under a regex location block will throw an error. 
To avoid error, set a variable which holds the original or modified URI to pass

#+BEGIN_EXAMPLE
location ~* \.(cfm|...|html)$) {
  set $request_url /site2$request_uri;
  if ($request_uri ~* ^/legacy_js) {
    set $request_url $request_uri;
  }
  proxy_pass http://127.0.0.1:8888$request_url;
}
#+END_EXAMPLE

*** Sample
#+BEGIN_EXAMPLE
location / {
  proxy_pass http://127.0.0.6:8888;
  proxy_set_header Host 127.0.0.6;
  proxy_redirect off;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-Server $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_connect_timeout 600;
  proxy_send_timeout 600;
  proxy_read_timeout 600;
  send_timeout 600;
}
#+END_EXAMPLE

*** Sample: Redirect a path to a different proxy
<<<nginx:redirect path to proxy>>>
wp:redirect path to wp
#+BEGIN_EXAMPLE
server {
  listen 80;
  server_name abc.com www.abc.com;

# this doens't work in wordpress! location ^~ /subpath
  location ^~ /subpath/ {
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Host $http_host;
    proxy_pass http://127.0.0.1:8787/;
  }
  
  location / {
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Host $http_host;
    proxy_pass http://127.0.0.1:9977;
  }
}
#+END_EXAMPLE

** Rewrite Directive
Case insensitve match. Source folder is CMS, and any case variants of CMS can be redirected
#+BEGIN_EXAMPLE
rewrite (?i)^/cms/?$ /CMS/index.cfm last;
rewrite (?i)^/cms/(.*)$ /CMS/$1 last;
#+END_EXAMPLE

Flag ~last~ :: Not to pass any more rewrite-module directives in the current ~server~ or ~location~ block

* Git
** Show config
#+BEGIN_EXAMPLE
# List all active config for the current folder
git config --list

# List global config only
git config --global --list

# Edit or check all global config
git config --global --edit

# Get all files that forms each config
git config --list --show-origin

# Find path to git.exe
which git.exe

# change username and email for the current repo
git config user.email myname@abc.omc
git config user.name "My Name"
#+END_EXAMPLE

** Working Tree
<<<git:Working_Tree>>>
- untracked :: it was never staged nor committed
- tracked :: it was previously committed, but it is not staged
- staged :: ready for commit
- dirty or modified :: file is changed but not staged

** diff

Working Copy -> git add -> Index -> git commit -> HEAD

HEAD^ is the previous commit

git diff: Between Working Copy and Index

git diff --cached: Between HEAD and Index

git diff HEAD: Between Working Copy and HEAD

git diff HEAD^: Between Working Copy and HEAD^

** Show file names only between 2 commits
Show file names only for 1 commit
#+BEGIN_EXAMPLE
git diff-tree --no-commit-id --name-only -r <SHA>
#+END_EXAMPLE

Show file names only between 2 commits
#+BEGIN_EXAMPLE
git --no-pager diff --name-only SHA1 SHA2
#+END_EXAMPLE

** Stash, Reset, Clean
git:Working_Tree

- git reset --hard :: clean working tree, go back to last commit but keep the untracked.
- git clean -dfn :: remove untracked files

- git stash :: Save and remove working directory changes
=git stash list= List all stashes
=git stash apply= Apply latest stash
=git stash apply stash@{2}= Apply 2nd latest stash
=git stash drop stash@{0}= Remove latest stash

** Commit an empty folder
In the empty folder add .gitignore file
#+BEGIN_EXAMPLE
# Not to ignore .gitignore
!.gitignore
# Or you intend to keep the folder empty, exclude everything
*
#+END_EXAMPLE

** Checkout vs Reset vs Revert
Let's current branch has c1, c2 and c3 commits in order

~git checkout c1~ :: sets branch to commit 1 in a detached HEAD state. 
HEAD is not at tip of branch. It's at that commit. Not changing anything. git checkout <branchname> to go back to HEAD

~git checkout c1 .~ or ~git checkout -f c1 -- .~ sets branch to commit c1 but about to make a commit c4 (Changes to be committed) that is after c3.
c4 contains all the necessary changes for going back to c1.

~git reset c1~ :: sets branch to commit 1.
Reset rewrites history. Only use it for local changes that are never pushed to remote.

~git revert c1 --no-edit~ undoes commit 1 and creates a commit. --no-edit means to skip the commit message.

** Branch
*** Duplicate current branch and switch to it 
#+BEGIN_EXAMPLE
git checkout -b newbranch
#+END_EXAMPLE

Create a local branch and then push to a new remote branch

#+BEGIN_EXAMPLE
git checkout -b newbranch
git add . && git commit -m "..."
git push --set-upstream origin newbranch
#+END_EXAMPLE

*** Duplicate current branch to a commit and switch 
git checkout -b newbranch <SHA1>
*** Delete branch
git branch -d branchname= or =-D=

*** Rename current branch
git branch -m new-branch-name

*** Commit difference between 2 branches 
=git log master..li=

For a specific file ~git log master..li path/to/file~

*** File difference between 2 branches 
=git diff --name-status master..origin/master= or 
=git diff --stat --color master..origin/master=
| Missing file or line in remote branch | D or - |
| New file or line in remote branch     | A or + |
| Both are modified                     | M      |

*** Find authors of all remote/local branches and tags
#+BEGIN_EXAMPLE
git for-each-ref --format='%(committerdate) %09 %(authorname) %09 %(refname)' | sort -k5n -k2M -k3n -k4n
#+END_EXAMPLE

*** Make current branch exactly as another branch
Make current branch li exactly the same as remote branch origin/master
#+BEGIN_EXAMPLE
git checkout li
git reset --hard origin/master
#+END_EXAMPLE

*** Find most recent ancestor of 2 branches
#+BEGIN_EXAMPLE
git merge-base branch2 branch3
#+END_EXAMPLE

*** Revert to common ancestor
You have a feature branch and master branch. Both have remote branches and are in sync.
Branch feature has some commits that master doesn't have and master are ahead of feature.

Keep the commits in feature but undo those commits and make a new commit in feature.

Find the most recent ancestor of feature and master
git merge-base feature master

Say the commit is common1
Make a new branch to test if it's a real common ancestor
git checkout feature
git checkout -b featuretest common1
git log master..featuretest // You should see nothing and featuretest is not ahead of master

Then make feature to go back to that commit without changing history

=== Method 1 ===
git checkout feature
~git checkout common1 .~ or ~git checkout -f c1 --.~
git commit -m "reset to common1"
Now you can merge master into feature
git merge --no-commit master

=== Method 2 ===
// Revert commits one by one
// Get commits from an old commit to HEAD
git log common1..HEAD
// or
git rev-list common1..HEAD
git revert --no-commit D
git revert --no-commit C
git revert --no-commit B
...
git commit -m "reset to common1"

=== Method 3 ===
// Caution! You are rewriting history on feature branch at local and remote
git checkout feature
git reset --hard common1
git push -f

*** Orphan Branch with no parent
github:gh-pages

** Merge
*** --no-commit vs --squash
--no-commit creates a merge commit if it can be fast-forwarded. If not, fix the conflict and git add files then commit.
--squash merges and modifies working tree but doesn't make a commit at all. Commit after is not a merge commit. Just a normal commit.

*** Abort merge
git merge --abort

** Rebase
feature branch has 1 commit ahead (C4) and 1 commit behind master (C3) and their common ancestor is C2
#+BEGIN_EXAMPLE
git checkout feature
git rebase master
git checkout master
git merge feature
#+END_EXAMPLE

The result is feature and master are exactly the same: C2 -> C3 -> C4

** Show merge commit
After merge or rebase happened, a merge commit is created. 
git status gives :: C0 > C1 > merge commit abc

See what this merge commit abc consists of. Take a look at the git status of abc, you will find 
Merge: C1 xyz

Show file names only :: git diff --name-only C1..abc
Show commits in a merge commit :: git log C1..abc
Show file names in each commit in a merge commit :: git show --name-only C1..abc
Show changes of a file that is caused by the merge commit :: git diff C1..abc -- path/to/file

** Fork
Sync a fork with original repo
Add a remote: upstream
#+BEGIN_EXAMPLE
git clone git@github.com:YOUR-USERNAME/YOUR-FORKED-REPO.git
cd into/cloned/fork-repo
git remote -v
git remote add upstream git://github.com/ORIGINAL-DEV-USERNAME/REPO-YOU-FORKED-FROM.git
git remote -v
git fetch upstream
git pull upstream master
#+END_EXAMPLE

** Remove tracking for commited files
A file is commited but you don't want to track it anymore in the future.
Remember the file will still be in Git but future clone won't grab the file.
=git update-index --assume-unchanged path/to/file.txt=

If you change your mind and want to track it again:
=git update-index --no-assume-unchanged path/to/file.txt=

Don't track a folder of files which are already commited
First try to run this because this will work with file names with space
=git ls-files -z myFolderToIgnore/ | xargs -0 git update-index --assume-unchanged=

Path is relative.

If you encounter error =xargs: git: bad file number=, run this
=git ls-files -- myFolderToIgnore/ | xargs -l git update-index --assume-unchanged=

List all assumed unchanged files
#+BEGIN_EXAMPLE
git ls-files -v | grep '[[:lower:]]'
#+END_EXAMPLE

** Remove a commited file from file but leave in filesystem
Delete a file from Git (top of the current branch) but leave the file in filesystem
The file becomes Untracked File
#+BEGIN_EXAMPLE
git rm --cached file.txt
#+END_EXAMPLE

Remove a folder
=git rm -r --cached .emacs.d/=

Add file to local or global ignore so that the file won't appear as Untracked File and prevent 
from staging the file when =git add .=

** Remove large files and folders

#+BEGIN_EXAMPLE
git gc
# Get the top 10 biggest files. It will take about a minute for it to run
git rev-list --objects --all | grep "$(git verify-pack -v .git/objects/pack/*.idx | sort -k 3 -n | tail -10 | awk '{print$1}')"

# path/to/bigfile1, path/to/bigfile2
# filter-branch runs on the current branch and filter through from top (HEAD) to oldest
git filter-branch --index-filter 'git rm --cached --ignore-unmatch path/to/bigfile1' HEAD
# repeat for every file

# To remove a directory
git filter-branch --index-filter 'git rm -r --cached --ignore-unmatch path/to/folder1' HEAD

# To remove files and subdirectories (except hidden files) of a directory
git filter-branch --index-filter 'git rm -r --cached --ignore-unmatch sites/default/files/*' HEAD

# filter-branch creates backups of your original refs namespaced under ~refs/original~
# Run this to delete the backed up refs, allowing the large objects to be garbage collected
git for-each-ref --format="%(refname)" refs/original/ | xargs -n 1 git update-ref -d

# if all big files are in one branch only, just delete the branch will remove all the references
# git branch -D branch-name
# Prune all reflog references from the branch on back.
# git reflog expire --expire=now branch-name

# Prune all reflog references from now to the first commit
git reflog expire --expire=now --all

# Repack the repo by running gc and pruning old objects
git gc --prune=now

# Push changes back to remote repo. All branches (refs under ~refs/heads~)
# I found I can push one branch only
git push --all --force

# Make sure tags are current and pushed to remote
git push --tags --force
#+END_EXAMPLE

--index-filter :: modify a repo's staging
--cached :: remove a file from the index not the disk
--ignore-unmatch :: prevent ~git rm~ from failing if the file isn't there
HEAD :: to remove from the start

Say git filter-branch is run once, and the backup ~refs/original~ is not deleted, the subsequent filter-branch will not run
Add -f to force it to run and overwrite ~refs/original~
#+BEGIN_EXAMPLE
git filter-branch -f --index-filter [...]
#+END_EXAMPLE

~git filter-branch [...] HEAD~ just shrinks the current branch and leave the other branches intact. 
Say feature branch is a copy of master, then run filter-branch on feature. master branch and others are not affected. But now feature branch diverged from master.
The get-top-10-biggest-files command returns the same files after filter-branch and the cleanup mentioned above are done. Because it's just one branch that you cleaned up, big files are still in other branches.
You won't notice a big change in total git:repo size, as it's just one branch that had the big files removed.
I didn't try ~git push --force~ to update a real remote branch.
Let's say the repo is at /path/to/repo, and you duplicate master branch to shrinksize branch. Run filter-branch and the cleanup.
Then you create another folder /path/to/duplicaterepo, and clone only the shrinksize branch from the original repo

#+BEGIN_EXAMPLE
cd /path/to
mkdir duplicaterepo
cd duplicaterepo
git clone file:///path/to/repo --branch shrinksize --single-branch
cd repo
du -sh .git/objects
# push branch shrinksize to another remote as master branch
git remote add anotherremote ...
git push anotherremote shrinksize:master
#+END_EXAMPLE

** Commit History
=git log --graph=
=git log -3= Last 3 commits
=git log --grep=<pattern>= Search commit message

** Local Ignore, Global Ignore, git status -u
Show untracked files
#+BEGIN_EXAMPLE
git status -u
#+END_EXAMPLE

Add file or directory paths to
- .git/info/exclude/ (will not be committed)
- .gitignore file (will be commited)

Just =touch .gitignore= in order to create a file with just the extension

Add global ignore file `~\.gitignore_global` 
and run `git config --global core.excludesfile ~/.gitignore_global`

Show all ignored files
~git status --ignored~

Check why a file is ignored
~git check-ignore -v path/to/filename~

After 1.8.2, ~**~ can be used to mean zero or more sub-directories
~bin/~ ignores any folder named bin
~/bin/~ ignores one folder named bin relative to the .gitignore file

However, if there're more than 1 folder
~wp-content/uploads/~ only ignore /wp-content/uploads.
Use ~**/wp-content/uploads/~ to ignore any folder that has path ~wp-content/uploads~

#+BEGIN_EXAMPLE
/main/**/bin/
#+END_EXAMPLE

Negate
An optional prefix ! which negates the pattern; any matching file excluded by a previous pattern will become included again. If a negated pattern matches, this will override lower precedence patterns sources.
#+BEGIN_EXAMPLE
# Ignore everything
*

# But don't ignore these files...
!.gitignore
!script.pl
!template.latex
# etc...

# ...even if they are in subdirectories. (don't ignore first level subdirectories)
# without this line, script.pl will only be included in the root directory
!*/
#+END_EXAMPLE

If you want to ignore a folder but don't ignore a file, create .gitignore in that folder
#+BEGIN_EXAMPLE
*
!.gitignore
!*.sql
!*/
#+END_EXAMPLE

https://www.atlassian.com/git/tutorials/gitignore

*** Wordpress .gitignore
#+BEGIN_EXAMPLE
*~
.DS_Store
.svn
.cvs
*.bak
*.swp
Thumbs.db
wp-config.php
wp-content/uploads/
wp-content/blogs.dir/
wp-content/upgrade/
wp-content/backup-db/
wp-content/advanced-cache.php
wp-content/wp-cache-config.php
wp-content/cache/*
wp-content/cache/supercache/*
*.log
error_log
wp-content/plugins/error_log
wp-content/cache/
wp-content/backups/
sitemap.xml
sitemap.xml.gz
sql-admin/
#+END_EXAMPLE

*** NodeJS, NPM .gitignore
#+BEGIN_EXAMPLE
node_modules
npm-debug.log
#+END_EXAMPLE

** Customize Settings per folder
For a single repository, attributes should be placed in ~$GIT_DIR/info/attributes~ file.
~$GIT_DIR~ is the repository. But this file won't be commited.

If you want to commit, ~.gitattributes~ file in the root ~$GIT_DIR~ or any sub folders.

#+BEGIN_EXAMPLE
# Syntax
# pattern attr1 attr2 ...
*.txt text*.js text*.html text*.md text*.json text*.svg text

# text is an attribute without value. `Set [attr] to true`

*.pdf -text

# text is again an attribute without value but prefixed with -. `Unset [attr] or Set [attr] to false`

*.txt text eol=lf

# Set text to true and Set eol to a value lf
#+END_EXAMPLE

** Git Windows
GUI gitk
~start path/to/filename~ to tell Windows to open a file

Run tree command ~cmd //c tree~

*** Line Feed, Long Path
Always don't do any conversion when files are added to local index or codes are checked out to local filesystem.
=git config --global core.autocrlf false=
Do git clone again.

You may encouter =file name too long= or =pathname too long= error.
Change the git setting
=git config --system core.longpaths true=

*** Special characters in filename
You can git clone in Linux, tar it and untar it using 7zip on Windows. 7zip will change the filenames to fit in Windows.

*** File name case-insensitive
Git has 2 file names the same except casing. After clone to Windows, you will find Changes not staged for commit.

If the files are not important and you are not going to modify them on Windows, you can tell your local Windows Git not to checkout those files.

#+BEGIN_EXAMPLE
git config core.sparsecheckout true
echo '*' >.git/info/sparse-checkout
echo '!unwanted_dir/unwanted_filename' >>.git/info/sparse-checkout
# I found just unwanted_dir/ is not enought, have to repeat each problematic files returned by `git status`
git read-tree --reset -u HEAD
git status
#+END_EXAMPLE

If the files are important, you can use Git in ~Bash on Windows~, it will checkout files with case-sensitive names. But all other Windows applications including Git Windows and phpStorm will report wrong Git info. Keep using Bash on Windows to Git.

It's better to fix the file names on Linux, commit and push and work on local.. 

** Multiple Github accounts and https
You manage 2 Github accounts.
git clone does not require credentials for https
When you push to the remote which is under Github account A, Windows asks you for credentials
After that, your credentials for account A is stored under Windows Credential Store Panel (WCSP).
You can add account A to an account B's repository as a collaborator.
Any push will be made by account A.

You have to delete 2 Github credentials from WCSP and then push commits to account B's repository 
and then use account B's credential if you want to completely switch account.

If you want to switch between multiple Github accounts frequently, use SSH instead of https

SSH might be blocked in public internet networks though.

Git has upgraded credential helper from manager to wincred.
git config --global crendential.helper wincred

** Clone to an empty folder
#+BEGIN_EXAMPLE
cd ~/expressjs
# add .git at the end
# --bare means to clone all branches
git clone --bare https://githublink/express.git .git
git config --bool core.bare false
git reset --hard
#+END_EXAMPLE

** Clone or Pull to existing repository
*** Existing repo is not git initialized
The existing repo has some other files that need to keep but not version controlled.
In the existing repo run
#+BEGIN_EXAMPLE
git init
git remote add origin PATH/TO/REPO
# Path/to/repo could be https://github.com/username/reponame.git
git fetch --all
git reset --hard origin/master
# dump all untracked changes and checkout remote master branch
#+END_EXAMPLE

*** Existing repo is git initialized
Pull from remote and put changes to staged without commit (ready to commit)
#+BEGIN_EXAMPLE
git pull --no-rebase --squash -Xtheirs origin master
# origin can be a different upstream in URL format
# git://github.com/pantheon-systems/drops-7.git
# the remote that's pulled from usually has the same codebase as your current local repo
#+END_EXAMPLE

** Clone a subdirectory
Just clone examples/shopping-cart directory from branch dev
#+BEGIN_EXAMPLE
git init <repo>
cd <repo>
git remote add origin https://github.com/vuejs/vuex.git
git config core.sparsecheckout true
echo "examples/shopping-cart/*" >> .git/info/sparse-checkout
git pull --depth=1 origin master
#+END_EXAMPLE

Result is ./<repo>/examples/shopping-cart

** Track local branch with a remote branch <<<git:upstream>>>
#+BEGIN_EXAMPLE
git branch --set-upstream master origin/master
#+END_EXAMPLE

List all local branches' upstream remotes
#+BEGIN_EXAMPLE
git branch -vv
#+END_EXAMPLE

** List all remote repo
#+BEGIN_EXAMPLE
# List all remote URL's 
git remote -v
#+END_EXAMPLE

** Repo size, maintenance <<<git:repo size>>>
#+BEGIN_EXAMPLE
git gc
git count-objects -vH
# I found this better
du -hs .git/objects
#+END_EXAMPLE

** Number of tracked files
Doesn't include directories. Only files
~git ls-files | wc -l~

** GitHub Push to New Repo with local repo
Create a new repo on Github.com without creating any .gitignore, README nor license
On local, git init, add .gitignore, git add . and check if files are ignored, git commit -m "1st commit"

Add a remote
~git remote add origin ssh_or_github_https_link_with_.git_at_the_end~

List all remotes ~git remote -v~
Remove a remote 'origin' ~git remote rm origin~

Local branch is not set to sync with remote until you do the first push with '-u'
~git push -u origin master~

Finally check ~cat .git/config~ to see if local branch "master" has setup a remote
#+BEGIN_EXAMPLE
[branch "master"]
        remote = origin
        merge = refs/heads/master
#+END_EXAMPLE

You may encounter 403 Forbidden and HTTP request failed errors. Try to use SSH or modify the HTTPS url
#+BEGIN_EXAMPLE
https://[GITHUB_USERNAME]@github.com/[GITHUB_USERNAME]/[REPO_NAME].git
Instead of the original
https://github.com/[GITHUB_USERNAME]/[REPO_NAME].git
#+END_EXAMPLE

** Add a remote, remove a remote and its branches
#+BEGIN_EXAMPLE
git remote add origin https://...
git remote -v
git remote rm origin
#+END_EXAMPLE

** Push to 2 remotes
An existing remote: origin
#+BEGIN_EXAMPLE
git remote add origin ssh_or_github_https_link_with_.git_at_the_end
# check remotes
git remote -v
# cat .git/config
[remote "origin"]
  url=ssh://.../repo.git
  fetch= +refs/heads/*:refs/remotes/origin/*
#+END_EXAMPLE

Method 1: Configure Origin as a Multi-Remote Destination
Add another push URL for origin within ~.git/config~
Commits will be pushed to both remote destinations automatically on ~git push origin~
#+BEGIN_EXAMPLE
[remote "origin"]
  url=ssh://.../repo.git
  url = git@github.com:username/reponame.git
  fetch= +refs/heads/*:refs/remotes/origin/*
#+END_EXAMPLE

Method 2: Add another remote github
#+BEGIN_EXAMPLE
git remote add github git@github.com:username/reponame.git
# or a https directly from github
# Push and track the current local branch master
git push -u github master
#+END_EXAMPLE

** Tag
#+BEGIN_EXAMPLE
# list all tags
git tag
# search tags
git tag -l "v1.8.5*"

# Make annotated tag and assign to the HEAD
git tag -a v1.4 -m "tagging message"

# Show a tag
git show 

# make lightweigth tag and assign to the HEAD
git tag v1.4-lw

# lightweight tag doens't show anything when git show

# Attach an annotated tag at a specific commit
git tag -a v1.2 0fceb02

git push origin [tagname]
# or
git push origin --tags

git describe --long --match 'live*'
# live-10-g7digits
# HEAD is now 10 commits ahead of tag live
#+END_EXAMPLE

** Github API
REST API v3 :: https://developer.github.com/v3/

Get repo size
#+BEGIN_EXAMPLE
# for public repo, auth is not required
curl https://api.github.com/repos/:owner/:reponame | grep size

# for private repo
curl -u ownername:password https://api.github.com/repos/:owner/:reponame | grep size
#+END_EXAMPLE

** Github Pages
You can add /docs folder to your repository on master and enable GitHub Pages in the repository setting
Or you can create an orphan branch called gh-pages

If you don't have branch gh-pages or /docs in master branch, just click on Launch automatic page generator and it will
create the gh-pages branch with Jekyll files.

Your project website is https://levonlee.github.io/reponame

<<<github:gh-pages>>> 
git checkout --orphan gh-pages
git rm -rf .
git commit -m "GitHub Pages"

For User or Organization Site, create repo levonlee.github.io and add index.html and push to repo

*** SVG, View HTML
http://rawgit.com/ 

Image files other than SVG can be served directly from GitHub using Raw Repo Path. Except SVG

Blob Repo Path
https://github.com/levonlee/reponame/blob/master/folder1/s1.svg

Raw Repo Path
https://github.com//levonlee/reponame/raw/master/folder1/s1.svg

RawGit Path
/levonlee/reponame/master/folder1/s1.svg

Development (Traffic limited)
https://rawgit.com/ + RawGit Path
Production (No traffic limit, permanently cached, no url query param)
https://cdn.rawgit.com/ + RawGit Path

*** Markdown
![Alt text](http://url/to/img.png)

** Troubleshooting
*** unable to create thread: Resource temporarily unavailable
It could stop you from pushing to remote repo
Try using ssh server instead.

*** warning: suboptimal pack - out of memory
This may happen in shared hosting with limited resources..
#+BEGIN_EXAMPLE
Counting objects: 2422, done.
Delta compression using up to 48 threads.
warning: suboptimal pack - out of memory
fatal: inflate: out of memory52/2395)
error: failed to push some refs to 'user@host:directory/repo-name.git'
#+END_EXAMPLE

Pay attention to the Delta compression using 48 threads. Change it to only 1 thread
#+BEGIN_EXAMPLE
git config --global pack.threads 1
#+END_EXAMPLE

fatal: unable to create threaded lstat
#+BEGIN_EXAMPLE
git config core.preloadIndex false
# or
# git config --global core.preloadIndex false
#+END_EXAMPLE

* BitBucket
** Basic
BitBucket can create priviate repo for free! Limit each repo to 1gb.

Create a private repo on BitBucket UI.

For existing local Git repo, add a remote

#+BEGIN_EXAMPLE
cd /path/to/local/repo
git remote add bb https://username@bitbucket.org/username/reponame.git
# git push -u bb localbranch
# e.g. git push -u bb master
# git push -u bb localbranch:repobranch
# e.g. git push -u bb master:masteronbb
#+END_EXAMPLE

~git push -u remotename localbranch~ pushes the code to a remote and set the remote as upstream remote.

By default, ~git push~ pushes code at current local branch to the same branch on upstream remote.

See git:upstream to change local branch's upstream remote branch

.git/config
#+BEGIN_EXAMPLE
[branch "master"]
	remote = origin
	merge = refs/heads/master
#+END_EXAMPLE

git branch -vv
#+BEGIN_EXAMPLE
   localbranch1 hexcode [origin/localbranch1] last commit msg
 * master       hexcode [origin/master] last commit msg
   localbranch2 hexcode [origin/localbranch2] last commit msg
#+END_EXAMPLE

* Pantheon
** Deploy
#+BEGIN_EXAMPLE
terminus site deploy --site=<s> --env=<e> --sync-content --cc
terminus env:deploy my-site.test --sync-content --note="Deploy core and contrib updates" --cc
#+END_EXAMPLE

** pantheon.yml
In the code directory. You need to commit to take effect.

PHP supported version :: 5.3, 5.5, 5.6, and 7.0.
Drush version: 5, 7, or 8. 8 is recommended

** Drush
<<<Pantheon Drush>>>
#+BEGIN_EXAMPLE
terminus drush "<drush command> <drush args>" --site=<> --env=<> 
terminus remote:drush site-name.env-name drush-command
terminus remote:drush site-name.env-name -- ws --tail
terminus env:clear-cache site-name.env-name
terminus remote:drush <site>.<env> -- cc all
#+END_EXAMPLE

If a module is updated via Pantheon terminus drush up, original module folder will be saved to /drush-backups/pantheon/date/modules/modulename

In order for drush cc all to clear Varnish cache, [[https://pantheon.io/docs/pantheon_api-module/][pantheon_api]] module (in Pantheon upstream) must be enabled.

<<<pantheon:drupal:alias>>>
Download Pantheon Aliases
terminus sites aliases

Drush version (5, 7, or 8) 8 is recommended for all Drupal version.
terminus drush "status" --site=<> --env=<>

.drush folder is at one level higher than the code folder
You can put custom drush commands into this folder. For example,
drush @pantheon.SITE.ENV dl utf8mb4_convert-7.x
Will put utf8mb4_convert/utf8mb4_convert.dursh.inc under .drush/ folder
Then you clear drush cache before using the new command
drush @pantheon.SITE.ENV cc drush

** WP CLI <<<WP CLI Pantheon>>>

#+BEGIN_EXAMPLE
terminus wp 'option get home' --site=<site> --env=dev
#+END_EXAMPLE

** Drupal Core Update
<<<pantheon:drupal:core>>>
*** UI
Create a multidev of the current Live, then hit the upgrade button.
Check everything. If it's ok, do this on Dev, then pull code from Dev to Test, and then Live
Done!

To update other multidevs, after Dev master is updated, pull code from Dev to multidev and run update.php
Check Status from Pantheon.

*** Manual pull from upstream to resolve conflicts
Check on Pantheon UI to find out the Upstream : Settings > About site
e.g. https://github.com/pantheon-systems/drops-7

#+BEGIN_EXAMPLE
# add a remote
git remote add pantheon-drops-7 git://github.com/pantheon-systems/drops-7.git
git fetch pantheon-drops-7
git rebase pantheon-drops-7/master
# resolve conflicts
git add .
git rebase --continue
git push origin branchname(e.g. master)
#+END_EXAMPLE

I found that the UI pull from upstream can resolve the following error while in manual pull
So use UI pull whenever possible.
#+BEGIN_EXAMPLE
First, rewinding head to replay your work on top of it...
Applying: Adding project shell
fatal: mode change for modules/pantheon/pantheon_api/pantheon_api.install, which is not in current HEAD
error: could not build fake ancestor
Patch failed at 0001 Adding project shell
The copy of the patch that failed is found in: .git/rebase-apply/patch

When you have resolved this problem, run "git rebase --continue".
If you prefer to skip this patch, run "git rebase --skip" instead.
To check out the original branch and stop rebasing, run "git rebase --abort".
#+END_EXAMPLE

** Drupal Cron
Pantheon runs cron within 5 to 10 minutes of half past each hour: 4:30pm, 5:30pm, 6:30pm, etc.
=drush pantheon_cron 3600=
This bootstraps the site and invokes drupal_cron_run.

If the site is not accessed for at least 2 hours, Pantheon suspends all associated services and thus cron will not run.

** Determine Environment
<<<pantheon:environment>>>
#+BEGIN_EXAMPLE
if (defined('PANTHEON_ENVIRONMENT') && PANTHEON_ENVIRONMENT == 'dev') {} 
#+END_EXAMPLE

Not including Drush and on dev web environment
#+BEGIN_EXAMPLE
if (isset($_SERVER['PANTHEON_ENVIRONMENT'])) {
 // Web only excluding Drush 
 if ($_SERVER['PANTHEON_ENVIRONMENT'] == 'dev') {
  // Web only excluding Drush and on dev
 }
}
#+END_EXAMPLE

** Disable Newrelic
https://pantheon.io/docs/new-relic

Newrelic may inject javascript in pages.. Disable it

Drupal (sites/default/settings.php)
#+BEGIN_EXAMPLE
if (function_exists('newrelic_ignore_transaction')) {
 newrelic_ignore_transaction();
}
#+END_EXAMPLE

** Cookie <<<pantheon:cookie>>>
https://pantheon.io/docs/cookies

cookies set by javascript or at client side must have this name structure :: STYXKEY[a-zA-Z0-9_-]
e.g. STYXKEY_my-key-name

So that php can read them. And cookies set in this way should change the value on client side once it's been set.

Content pages with same cookies (with this name structure) and same url will be cached.

A cookie can be set in PHP in a response to prevent caching
#+BEGIN_EXAMPLE
if ((preg_match($regex_path_match, $_SERVER['REQUEST_URI'])) {
  $domain =  $_SERVER['HTTP_HOST'];
  setcookie('NO_CACHE', '1', time()+0, '/path-to-page', $domain);
}
#+END_EXAMPLE

See pantheon:varnish to prevent caching on certain pages by setting http header.

Cookie limit for Pantheon Edge is 10K. Any larger cookies are dropped as if there is no cookie and header ~X-Cookies-Dropped: 1~ will be added.

Varnish will not try to respond to the request from its cache or store the response if any of these cookies is present:
- Cookies beginning with ~SESS~ that are followed by numbers and lowercase letters.
- Drupal uses SESS-prefixed cookies for its own session tracking
- Make sure you use different SESS-prefixed cookies for ignoring caching so that there's no conflict with Drupal
- Correct: SESSfollowbylowercasewordwithnumbers123
- Incorrect: SESS_hello, SESS-123, mycustomSESS, Sessone, sess123testing, SESSFIVE
- Wordpress doesn't use PHP session cookies. Plugin [[https://wordpress.org/plugins/wp-native-php-sessions/][Wordpress Native PHP Sessions]] allows custom code to use ~$_SESSIONS~ but it's pulled from db.
- Other [[https://pantheon.io/docs/caching-advanced-topics/][cache-busting cookie patterns]]
#+BEGIN_EXAMPLE
NO_CACHE
S+ESS[a-z0-9]+
fbs[a-z0-9_]+
SimpleSAML[A-Za-z]+
PHPSESSID
wordpress[A-Za-z0-9_]*
wp-[A-Za-z0-9_]+
comment_author_[a-z0-9_]+
duo_wordpress_auth_cookie
duo_secure_wordpress_auth_cookie
bp_completed_create_steps # BuddyPress cookie used when creating groups
bp_new_group_id # BuddyPress cookie used when creating groups
wp-resetpass-[A-Za-z0-9_]+
(wp_)?woocommerce[A-Za-z0-9_-]+
#+END_EXAMPLE

Default cookie lifetime is 2,000,000 seconds and session lifetime is 200,000 seconds in Drupal's default.settings.php

Any logged in pages will not be cached. If different content is shown based on a user's location, either use frontend or use STYXKEY cookie as described above so that caching is possible.

** Domain
Connect Domain: www.example.com and example.com
In your DNS:
A @ ip_from_pantheon
AAAA @ value_from_pantheon
CNAME www live-example.pantheonsite.io (Pantheon live URL)

** Global CDN
Fastly's edge cloud platform. 36 global points of presence (PoPs). Cache entire pages at the edge not just static assets.

Each PoP is an edge server which is proxy cache.

Cache key is the entire URL plus query string.

** HTTPS
*** Redirect to HTTPS
https://pantheon.io/docs/domains/

#+BEGIN_EXAMPLE
// wordpress
if (isset($_SERVER['PANTHEON_ENVIRONMENT']) && php_sapi_name() != 'cli') {
  // Redirect to https://$primary_domain/ in the Live environment
  if ($_ENV['PANTHEON_ENVIRONMENT'] === 'live'):
    /** Replace www.example.com with your registered domain name */
    $primary_domain = 'www.example.com';
  else:
    // Redirect to HTTPS on every Pantheon environment.
    $primary_domain = $_SERVER['HTTP_HOST'];
  endif;
  $base_url = 'https://'. $primary_domain;
  define('WP_SITEURL', $base_url);
  define('WP_HOME', $base_url);
  if ($_SERVER['HTTP_HOST'] != $primary_domain
      || !isset($_SERVER['HTTP_X_SSL'])
      || $_SERVER['HTTP_X_SSL'] != 'ON' ) {

    // Name transaction "redirect" in New Relic for improved reporting (optoinal)
    if (extension_loaded('newrelic')) {
      newrelic_name_transaction("redirect");
    }
    header('HTTP/1.0 301 Moved Permanently');
    header('Location: '. $base_url . $_SERVER['REQUEST_URI']);
    exit();
  }
}

// D7
if (isset($_SERVER['PANTHEON_ENVIRONMENT']) && php_sapi_name() != 'cli') {
  // Redirect to https://$primary_domain/ in the Live environment
  if ($_ENV['PANTHEON_ENVIRONMENT'] === 'live'):
    /** Replace www.example.com with your registered domain name */
    $primary_domain = 'www.example.com';
  else:
    // Redirect to HTTPS on every Pantheon environment.
    $primary_domain = $_SERVER['HTTP_HOST'];
  endif;
  $base_url = 'https://'. $primary_domain;
  if ($_SERVER['HTTP_HOST'] != $primary_domain
      || !isset($_SERVER['HTTP_X_SSL'])
      || $_SERVER['HTTP_X_SSL'] != 'ON' ) {

    // Name transaction "redirect" in New Relic for improved reporting (optional)
    if (extension_loaded('newrelic')) {
      newrelic_name_transaction("redirect");
    }
    header('HTTP/1.0 301 Moved Permanently');
    header('Location: '. $base_url . $_SERVER['REQUEST_URI']);
    exit();
  }
}

// D8
if (isset($_SERVER['PANTHEON_ENVIRONMENT']) && php_sapi_name() != 'cli') {
  // Redirect to https://$primary_domain/ in the Live environment
  if ($_ENV['PANTHEON_ENVIRONMENT'] === 'live'):
    /** Replace www.example.com with your registered domain name */
    $primary_domain = 'www.example.com';
  else:
    // Redirect to HTTPS on every Pantheon environment.
    $primary_domain = $_SERVER['HTTP_HOST'];
  endif;
  if ($_SERVER['HTTP_HOST'] != $primary_domain
      || !isset($_SERVER['HTTP_X_SSL'])
      || $_SERVER['HTTP_X_SSL'] != 'ON' ) {

    // Name transaction "redirect" in New Relic for improved reporting (optoinal)
    if (extension_loaded('newrelic')) {
      newrelic_name_transaction("redirect");
    }

    header('HTTP/1.0 301 Moved Permanently');
    header('Location: '. 'https://'. $primary_domain . $_SERVER['REQUEST_URI']);
    exit();
  }
  // Drupal 8 Trusted Host Settings
  if (is_array($settings)) {
    $settings['trusted_host_patterns'] = array('^'. preg_quote($primary_domain) .'$');
  }
}
#+END_EXAMPLE

*** HSTS: HTTP Header
After redirection to HTTPS is setup, set the HTTP Strict Transport Security (HSTS) header to stop client communicating to HTTP.
A+ SSL rating will be achieved in [[https://www.ssllabs.com/ssltest/][SSL Labs]].

Wordpress: install LH HSTS plugin
#+BEGIN_EXAMPLE
terminus remote:wp <site>.<env> -- plugin install lh-hsts --activate
# Once enabled, this header will be sent in response
Strict-Transport-Security: max-age=15984000; includeSubDomains; preload

# D7
terminus remote:drush <site>.<env> -- pm-enable hsts --yes
# Visit the module configuration page (/admin/config/security/hsts).
# Check the Enable HTTP Strict Transport Security checkbox, set Max Age to 15552000 and click Save Configuration.
# Once installed and configured, the following header will be sent in responses:
strict-transport-security: max-age=15552000

# D8
terminus remote:drush <site>.<env> -- pm-enable hsts --yes
# Visit the module configuration page (/admin/config/system/hsts).
# Check the Enable HTTP Strict Transport Security checkbox, set Max Age to at least 1 year and click Save Configuration.
# Once installed and configured, the following header will be sent in responses:
strict-transport-security: max-age=31536000
#+END_EXAMPLE

** Varnish <<<pantheon:varnish>>>
[[https://wordpress.org/plugins/pantheon-advanced-page-cache/][Wordpress plugin Pantheon Advanced Page Cache]]
[[https://pantheon.io/docs/wordpress-cache-plugin/][Clear cache functions on Wordpress]]
[[https://www.varnish-software.com/wiki/content/tutorials/wordpress/wp_step_by_step.html][Varnish step-by-step guide to making a wordpress site fly]]

Varnish doesn't cache page requests with cookies and it respects the HTTP header that you set in PHP.
Pantheon sets Varnish to ignore most cookies so that pages can be cached.

To troubleshoot whether a page is cached, examine the response HTTP header Age. If Age stays at 0, means the page is not cached.

If there's a HTTP header ~Cache-Control: no-cache, must-revalidate, post-check=0, pre-check=0~, Varnish will not cache the page.
e.g. drupal_set_message sets ~no-cache~ in HTTP header.

Set HTTP header for preventing certain pages from caching
#+BEGIN_EXAMPLE
// wordpress
if (preg_match($regex_path_match, $_SERVER['REQUEST_URI'])) {
    add_action( 'send_headers', 'add_header_nocache', 15 );
}
function add_header_nocache() {
  header( 'Cache-Control: no-cache, must-revalidate, max-age=0' );
}

// D7
  if (preg_match($regex_path_match, $_SERVER['REQUEST_URI'])) {
    drupal_page_is_cacheable(FALSE);
    $conf['page_cache_maximum_age'] = 0;
  }

// D8
$build['#cache']['max-age'] = 0;
#+END_EXAMPLE
See pantheon:cookie to prevent caching on certain pages by setting NO_CACHE cookie

Pantheon Varnish will ignore the following GET parameters when caching:
- Prefixed with 2 underscores ~__~
- Prefixed with ~utm_~

PHP read values of these GET parameter as ~PANTHEON_STRIPPED~

Varnish configuration file (.vcl) is not supposed to edit.

** Object Cache - Redis
Enable Redis in Pantheon Dashboard Settings > Add Ons > Add
For Wordpress, no more is needed because the WP Redis plugin is loaded via drop-in file
Install Redis module https://www.drupal.org/project/redis or run terminus to install
#+BEGIN_EXAMPLE
terminus remote:drush <site>.<env> -- en redis -y
#+END_EXAMPLE

Edit [[https://pantheon.io/docs/redis/][sites/default/settings.php]]
#+BEGIN_EXAMPLE
// D7
/ All Pantheon Environments.
if (defined('PANTHEON_ENVIRONMENT')) {
  // Use Redis for caching.
  $conf['redis_client_interface'] = 'PhpRedis';

  // Point Drupal to the location of the Redis plugin.
  $conf['cache_backends'][] = 'sites/all/modules/redis/redis.autoload.inc';
  // If you've installed your plugin in a contrib directory, use this line instead:
  // $conf['cache_backends'][] = 'sites/all/modules/contrib/redis/redis.autoload.inc';

  $conf['cache_default_class'] = 'Redis_Cache';
  $conf['cache_prefix'] = array('default' => 'pantheon-redis');

  // Do not use Redis for cache_form (no performance difference).
  $conf['cache_class_cache_form'] = 'DrupalDatabaseCache';

  // Use Redis for Drupal locks (semaphore).
  $conf['lock_inc'] = 'sites/all/modules/redis/redis.lock.inc';
  // Or if you've installed the redis module in a contrib subdirectory, use:
  // $conf['lock_inc'] = 'sites/all/modules/contrib/redis/redis.lock.inc';

}

// D8
if (defined('PANTHEON_ENVIRONMENT')) {
  // Include the Redis services.yml file. Adjust the path if you installed to a contrib or other subdirectory.
  $settings['container_yamls'][] = 'modules/redis/example.services.yml';

  //phpredis is built into the Pantheon application container.
  $settings['redis.connection']['interface'] = 'PhpRedis';
  // These are dynamic variables handled by Pantheon.
  $settings['redis.connection']['host']      = $_ENV['CACHE_HOST'];
  $settings['redis.connection']['port']      = $_ENV['CACHE_PORT'];
  $settings['redis.connection']['password']  = $_ENV['CACHE_PASSWORD'];

  $settings['cache']['default'] = 'cache.backend.redis'; // Use Redis as the default cache.
  $settings['cache_prefix']['default'] = 'pantheon-redis'; 

  // Always set the fast backend for bootstrap, discover and config, otherwise this gets lost when redis is enabled.
  $settings['cache']['bins']['bootstrap'] = 'cache.backend.chainedfast';
  $settings['cache']['bins']['discovery'] = 'cache.backend.chainedfast';
  $settings['cache']['bins']['config']    = 'cache.backend.chainedfast';
}
#+END_EXAMPLE

Install Redis locally https://redis.io/download
Use Redis Connection Info from Dashboard
#+BEGIN_EXAMPLE
redis> keys *
 1) "pantheon-rediscache_menu:links:management:tree-data:en:27cbcc1096e9daf2c319c2c"
 2) "pantheon-rediscache:features_module_info"
 3) "pantheon-rediscache_bootstrap:bootstrap_modules"
 4) "pantheon-rediscache_menu:menu_item:b38e608d4f709b7c1fcb6ac5f6dd2ab72a9a034"

# set and check
redis> SET key1 "Hello"
OK
redis> EXISTS key1
(integer) 1
redis> EXISTS key2
(integer) 0
redis>

# find a key
redis> KEYS *a*
$17
englash bigkahuna
redis> KEYS engl?sh
$23
englosh englash english
redis> KEYS engl[ia]sh
$15
englash english

# clear cache
redis> flushall
OK

# Number of keys in cache
redis> DBSIZE
:0
#+END_EXAMPLE

** Clear Cache
Use ~terminus env:clear-cache~ to debug clear cache failure.

* AWS
** SSH
<<<aws:ssh>>>
Each instance has a Key Pair, shown as Key Name in Instance.

When Key Pair is created for the first time, a .pem file is downloaded.

Convert this pem file to ppk in PuttyGen. "Save private key" using RSA with 2048 bits.
If RSA is not available in old PuttyGen, use SSH-2 RSA.

Start up a Putty session using user_name@public_dns_name. For user_name, you can use root.
If it's not right, it will prompt you to use the correct one. For Amazon Linux AMI (t2 micro image), use ec2-user

Port is 22, type is SSH. Under Putty > Category > Connection > SSH > Auth, select the new .ppk file.

Copy from remote to local
#+BEGIN_EXAMPLE
# copy a file
scp user@remotehost.comorip:/path/to/foo.md /path/to/local/
# copy a folder
scp -r user@remotehost.comorip:/path/to/foo /path/to/local/
# copy a folder to the current folder, then the result is ./foo
scp -r user@remotehost.com:/path/to/foo .
# copy all files/folders of a folder to the current folder without creating ./foo
scp -r user@remotehostcom:/path/to/foo/. .
#+END_EXAMPLE

If port is not 22, it has to be specified ~-P 2222~.
If the default private key doesn't work, use =-i ~/.ssh/your_private_key_file=

** Amazon Linux AMI
I use t2 micro image.

#+BEGIN_EXAMPLE
yum install php-mysql php-devel
yum install php-mbstring
chown -R root:www /var/www/html
chmod -R 755 /var/www/html
service httpd restart
service mysqld start
mysql_secure_installation
#+END_EXAMPLE

Then do apache:production setup

Add these to MySQL config file ~nano /etc/my.cnf~

#+BEGIN_EXAMPLE
[mysqld]
key_buffer_size = 16M
read_buffer_size = 256K
read_rnd_buffer_size = 512K
query_cache_size = 16M
#+END_EXAMPLE

Restart MySQL ~service mysqld restart~
Check php configuration php:config

*** Update an instance
Simply create a screen session and run ~sudo yum update~ and 'y'
Reboot the instance.

** S3 <<<aws:s3>>>
By default, the maximum number of buckets is 100. Creating bucket and enable logging in bucket doesn't cost anything. Create a user in IAM with access key and assign the following policy and assign the policy:

First create a group policy with ListAllMyBuckets permission then add a new user to that group. 
The user policy is Allow All for 2 resources =arn:aws:s3:::<bucket_name>= and =arn:aws:s3:::<bucket_name>/*=

#+BEGIN_EXAMPLE
{
    "Effect": "Allow",
    "Action": [
        "s3:ListAllMyBuckets"
    ],
    "Resource": "arn:aws:s3:::*"
},
{
    "Effect": "Allow",
    "Action": [
        "s3:*"
    ],
    "Resource": [
        "arn:aws:s3:::<bucket_name>",
        "arn:aws:s3:::<bucket_name>/*",
    ]
}
#+END_EXAMPLE

For the properties of the bucket, you can set a tag with key =application= and value is the website name.

*** Storage Classes
STANDARD: 
STANDARD_IA (infrequent class): Retrieval fee. Real-time retrieval. Good for larger objects (>128kb).
GLACIER: Retrieval fee. Retrieval time is hours.
REDUCED_REDUNDANCY: less durability and availability. Best for storing thumbnail images.

* Database
** Basics
*** Modeling Optimization
First normal form (1NF) :: every field should have one value. (Not comma separated values)

Second normal form (2NF) :: If you have multiple primary keys (composite keys) in a table, 
every field should be unique to all of those composite keys.
e.g. CourseID and Date are 2 primary keys in table A. Field CourseTitle is unique to courseID. courseTitle should not be in 
table A. Create a new table B to include CourseID and CourseTitle.

Third normal form (3NF) :: Say you have CourseID, Date, Room, Seats in table A.
Seats is unique to Room. You should create table B to hold Room, Seats and include just Room in table A.

*** Transaction and ACID
- Atomic :: All parts involved should be either success or failure as a whole.
- Consistent :: cannot result in a situation that violates any of the integrity rules.
- Isolated :: all relevant data is locked until the transaction is finished. (Race condition)
 - Pessimistic Locking :: Once locked, others can't even read (be refused or have to wait)
 - Optimistic Locking :: Once one request lock data, other requests can read 
but roll back when try to write to db while lock is encountered.
- Durable :: Once success, always success.

*** Index
One table can have only one clustered index which is by default the primary key column.
You may make another column as non-clustered index. 
Each non-clustered index creates a new table which includes the clustered index column and the new column (sorted).
When a new row is added to the main table, a new row is also added to each non-cluster indexed table.

** Access
*** Null
#+BEGIN_EXAMPLE
IsNull(col1) return true or false
Nz(col1,'') return '' if col1 is null
#+END_EXAMPLE

Sometimes IsNull() and Nz() don't work, e.g. UcanAccess,
Use NVL() which is the same as Nz(). Or use col1 IS NULL

*** Coldfusion Datetime
#+BEGIN_EXAMPLE
<cfset dStart = DateFormat(form.startdate, "mm/dd/yyyy")>

SELECT *
FROM aTable
WHERE DateStart >= #CreateDate(Year(now()),Month(now()),Day(now()))#
AND DateEnd <= #CreateDate(Year(now()),Month(now()),DaysInMonth(now()))#
AND DateStart BETWEEN #dStart# AND #CreateDate(Year(dStart),Month(dStyart),DaysInMonth(dStart))#
#+END_EXAMPLE

*** Random Order
#+BEGIN_EXAMPLE
SELECT *
FROM aTable
ORDER BY rnd(INT(NOW*id)-NOW*id)

<!--- OR
rnd(aTable.ID)
--->
#+END_EXAMPLE

*** Troubleshooting
**** "Record is too large"
This is because the size of a single record is around 2K. 
You can change the data type for some of fields to Long Text (>Access 2013) or Memo (<= Access 2000)

**** "Application uses a value of the wrong type for the current operation"
It's possibly due to you are using Microsoft Access with Unicode driver in ColdFusion and you insert to a memo or long text field. 
~cf_sql_longvarchar~ doesn't work. You should use ~<cfqueryparam cfsqltype="CF_SQL_CLOB" value="#description#">~ instead. 

** MySQL
*** Version, Settings
~service mysql status~
In console :: =SHOW VARIABLES LIKE "%version%";=

To check if it's MariaDB, just =SELECT VERSION();=

**** charset, collation
<<<mysql:charset>>> <<<mysql:collation>>>
Default charset is utf8, collation is utf8_general_ci
which is 3 bytes. utf8mb4 is 4 bytes
MySQL server default charset and collation

SELECT @@character_set_database, @@collation_database;
ALTER DATABASE db_name CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
ALTER TABLE {tbl_name} CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
ALTER TABLE {tbl_name} MODIFY "field_name" "field_type" CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;

In order to enable utf8mb4, you need to change my.cnf setting and restart MySQL
mysqld (client) is used on Pantheon instead of libmysqlclient
The following settings becomes available on mysqld (MySQL) server version > 5.5.14 and default since 5.7.7
As of Nov 25, 2016, Pantheon MySQL (innodb) version is 5.6.26 
#+BEGIN_EXAMPLE
[mysqld]
innodb_large_prefix=true
innodb_file_format=barracuda
innodb_file_per_table=true
#+END_EXAMPLE

mysqld (client) > 5.0.9, libmysqlclient > v. 5.5.3, has to support utf8mb4 charset

The major problem here is that for an indexed string column (primary key column) MySQL has 767 bytes limit.
In utf8, it's 767/3=255 characters varchar(255). In utf8mb4, it's 767/4=191 characters varchar(191).
If MySQL server doesn't have the above setting, the indexed column should contain less than 191 characters.
But those columns already have varchar(255) defined, you will need to re-create the indexes
ALTER TABLE tbl_name CHANGE index_col index_col VARCHAR(191) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;

That's actually what Wordpress does: resize the indexed columns for some tables and make every table and field utf8mb4.

Until Nov 25, 2016, Pantheon doesn't make those settings to MySQL server, so you will need to manually do the same as Wordpress.

Referred by d7:mysql:charset

**** Memory, InnoDB Buffer
name, default
innodb-buffer-pool-size, innodb-buffer-pool-chunk-size :: 128M
max-allowed-packet :: 4M, total BLOB data size for a single row

**** Last Update time for a table in a database
#+BEGIN_EXAMPLE
SELECT UPDATE_TIME, TABLE_SCHEMA, TABLE_NAME
FROM   INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA NOT LIKE '%information_schema%'
AND TABLE_SCHEMA LIKE '%your_db_name%'
AND TABLE_NAME LIKE '%your_db_table_name%'
#+END_EXAMPLE

#+BEGIN_EXAMPLE
SELECT MAX(UPDATE_TIME), TABLE_SCHEMA
FROM   INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA NOT LIKE '%information_schema%'
GROUP BY TABLE_SCHEMA
ORDER BY MAX(UPDATE_TIME)
#+END_EXAMPLE

*** Install
#+BEGIN_EXAMPLE
# Ubuntu
apt-get update; apt-get install mysql-server
service mysql start

# Debian
yum install php-mysql
service httpd restart
service mysqld start

# both
mysql_secure_installation
#+END_EXAMPLE

**** MySQL does not start after installation, Ubuntu
~No directory, logging in with HOME=/~ and ~service mysql status~ shows it is inactive.
This is new.. Change the owner:group for relevant folders
#+BEGIN_EXAMPLE
chown -R mysql:mysql /var/lib/mysql /var/run/mysqld
#+END_EXAMPLE

**** Reset root password, Ubuntu
ERROR 1045: Access denied for user: 'root@localhost' (Using password: NO) or yes

#+BEGIN_EXAMPLE
# stop
sudo /etc/init.d/mysql stop
# skip permission check
sudo /usr/sbin/mysqld --skip-grant-tables --skip-networking &
# start mysql client without a password
mysql -u root
FLUSH PRIVILEGES;
# Update root password
SET PASSWORD FOR root@'localhost' = PASSWORD('password');
# If you have a mysql root account that can connect from everywhere, you should also do:
UPDATE mysql.user SET Password=PASSWORD('password') WHERE User='root';
# Alternate
USE mysql
UPDATE user SET Password = PASSWORD()
WHERE Host = 'localhost' And User='root';
# Alternate for root can access from everywhere
USE mysql
UPDATE user SET Password = PASSWORD('password');
WHERE Host = '%' AND User = 'root';

FLUSH PRIVILEGES;
exit
service mysql restart
# or
sudo /etc/init.d/mysql stop
sudo /etc/init.d/mysql start
#+END_EXAMPLE

*** Data Types
**** <<<MySQL Integer>>>
SIGNED :: contains negative, 0 and positive
UNSIGNED :: contains 0 and positive
- TINYINT
- SMALLINT
- MEDIUMINT
- INT :: ~INT(10)~ 10 is display-width. INT(1) and INT(10) UNSIGNED max is the same: 4,294,967,295
- BIGINT

**** <<<MySQL Date and Time>>>
- TIME :: format 'HH:MM:SS' from '-838:59:59.000' to '838:59:59.000'

1 Year ago
post_date > DATE_SUB(NOW(), INTERVAL 1 YEAR)

Date comparison

#+BEGIN_EXAMPLE
CAST(post_date AS DATE) > '2014-01-01'
FROM_UNIXTIME(intTime) > '2014-01-01'
FROM_UNIXTIME(intTime) BETWEEN '2014-01-01 00:00:00' AND '2014-12-31 23:59:00'
#+END_EXAMPLE

Unix Time
#+BEGIN_EXAMPLE
DATE_FORMAT(FROM_UNIXTIME(intTime),'%Y-%m-%d %H:%i:%s') :: default date format
UNIX_TIMESTAMP(NOW())
#+END_EXAMPLE

**** <<<MySQL String>>>
https://dev.mysql.com/doc/refman/5.7/en/string-functions.html

Concatenate user variable
#+BEGIN_EXAMPLE
SET @s3 = 'http://s3.amazonaws.com/abc/';
SELECT REGEXP_REPLACE(thumbnail.uri, "^(s3://)(.*)", CONCAT(@s3,'\\2')) AS thumbnail
#+END_EXAMPLE

Concatenate columns or strings of one row. It doesn't skip empty string but it does skip NULL values.
#+BEGIN_EXAMPLE
CONCAT_WS(',', colA, colB, 'Column C Value')
WHERE url_alias.source = CONCAT('node/', n.nid)

-- if there any value that is NULL, CONCAT returns NULL
CONCAT_WS(',', NULL, '123', NULL) -- 123
CONCAT_WS(',', NULL, NULL) -- empty value
CONCAT_WS(',', NULL, '123', '', NULL) -- 123,,
#+END_EXAMPLE

replace all occurances, case-sensitve. multibyte safe
#+BEGIN_EXAMPLE
SELECT REPLACE('www.mysql.com', 'w', 'Ww');
#+END_EXAMPLE

Use regex_replace to do more complicated find and replace. MariaDB driver on host is required.
#+BEGIN_EXAMPLE
SELECT REGEXP_REPLACE("stackoverflow", "(stack)(over)(flow)", '\\2 - \\1 - \\3')
#+END_EXAMPLE

String delimited list
#+BEGIN_EXAMPLE
substring_index ( substring_index ( context,',',1 ), ',', -1) ) 
substring_index ( substring_index ( context,',',2 ), ',', -1) ) 
substring_index ( substring_index ( context,',',3 ), ',', -1) ) 
substring_index ( substring_index ( context,',',4 ), ',', -1) )
it means 1st value, 2nd, 3rd, etc.
#+END_EXAMPLE
Explanation: original string is "34,7,23,89", substring_index( context,',', 3) returns "34,7,23". The outer substring_index takes the value returned by the inner substring_index and the -1 allows you to take the last value. So you get "23" from the "34,7,23".

See mysql:string:list:temp table for more

**** <<<MySQL Null>>>
IFNULL(column_name, 0)
WHERE column_name IS NOT NULL

*** REGEXP
<<<MySQL REGEX>>>

Unless the field is binary, REGEXP is case-insensitive.

#+BEGIN_EXAMPLE
WHERE aut_name REGEXP "^w"
WHERE aut_name REGEXP "^I am \"Great!\""
// escape double quotes
#+END_EXAMPLE

*** Update Fields in Multiple Tables
#+BEGIN_EXAMPLE
UPDATE node, node_revision
SET node.comment=1,
    node_revision.comment = 1
WHERE node_revision.nid = node.nid AND node.type <> 'blog'
#+END_EXAMPLE

Update Joined Tables
#+BEGIN_EXAMPLE
UPDATE tableA a
JOIN tableB b ON a.a_id = b.a_id
JOIN tableC c ON b.b_id = c.b_id
SET b.val = a.val+c.val,
a.val2 = 'new'
WHERE a.val > 10 AND c.val > 10
#+END_EXAMPLE

*** LIMIT in Sub Query
Can't directly use LIMIT in sub query
This doesn't work
#+BEGIN_EXAMPLE
SELECT *
FROM wp_posts
WHERE wp_posts.ID IN (
SELECT p2.ID FROM wp_posts p2 WHERE p2.post_type IN ('posts')
LIMIT 5
)
#+END_EXAMPLE

Do this
#+BEGIN_EXAMPLE
SELECT *
FROM wp_posts
WHERE wp_posts.ID IN (
SELECT * FROM (SELECT p2.ID FROM wp_posts p2 WHERE p2.post_type IN ('posts') LIMIT 5) AS sq1
)
#+END_EXAMPLE

Remember if the outter query has LIMIT, then it will overwrite any subquery's LIMIT

*** EXISTS
If only checking existance in other tables but not returning any data from other tables, always use `EXISTS` or `NOT EXISTS`

The following returns nodes that have field_dealer = 101615 and field_ad_status = active but not returning any fields from 
tables field_data_*.

#+BEGIN_EXAMPLE
SELECT count(*) FROM node AS n
WHERE n.type='ad_listing'
AND n.status = 1
AND EXISTS (
 SELECT *
 FROM field_data_field_dealer d
 INNER JOIN node nsub ON nsub.nid=d.entity_id AND d.bundle='ad_listing' AND d.field_dealer_target_id IN (101615)
 WHERE nsub.nid=n.nid
)
AND EXISTS (
 SELECT *
 FROM field_data_field_ad_status s
 INNER JOIN node nsub ON nsub.nid=s.entity_id AND s.bundle='ad_listing' AND s.field_ad_status_value = 'active'
 WHERE nsub.nid=n.nid
)
#+END_EXAMPLE

*** UNION
#+BEGIN_EXAMPLE
select_statement_1
UNION [ALL]
select_statement_2
UNION [ALL]
select_statement_3
...
...
#+END_EXAMPLE

- In a UNION query, there are at least two SELECT statements.

- The two SELECT statements must have the same number of columns and the the columns must have compatible data types.

- The column headings in each of the SELECT statements do not have to have the same name. The column headings in the result of a UNION query are always taken from the first SELECT statement.

- If you want to sort the result set of the UNION operation, you can only put an ORDER BY clause after the last SELECT statement. ORDER BY clause can't be specified in any other SELECT statements in the UNION query.

- The column(s) used in ORDER BY clause can only be taken from the first SELECT statement.

- If you don't specify an ORDER BY clause in the UNION query, the result set is always sorted by the first column.

- If you use UNION ALL, the entire result set from the second SELECT statement is appended to the first SELECT statement. In this case, there could be duplicate records in the unioned result set.

- If you only use UNION, MySQL removes duplicate rows from the final result set.

#+BEGIN_EXAMPLE
select s.id as id, score.score, course.course, null as certificate
from student s
  left join s_score score on score.sid = s.id
  left join s_course course on score.sid = s.id
union all
select s.id as id, null, null, cert.certificate
from student s
  left join s_certificate cert on cert.sid = s.id
order by id
#+END_EXAMPLE

*** CASE, IF(), IFNULL(), NULLIF()
https://dev.mysql.com/doc/refman/5.7/en/control-flow-functions.html

#+BEGIN_EXAMPLE
SELECT IF(1>2,2,3); // 3
SELECT IF(1=1,2,3); // 2
SELECT IF(STRCMP('1', '1') = 0, 2, 3); // 2
#+END_EXAMPLE

#+BEGIN_EXAMPLE
mysql> SELECT CASE 1 WHEN 1 THEN 'one'
    ->     WHEN 2 THEN 'two' ELSE 'more' END;
        -> 'one'
mysql> SELECT CASE WHEN 1>0 THEN 'true' ELSE 'false' END;
        -> 'true'
mysql> SELECT CASE BINARY 'B'
    ->     WHEN 'a' THEN 1 WHEN 'b' THEN 2 END;
        -> NULL
#+END_EXAMPLE

*** Concatenate values of a column across multiple rows about the same record
<<<mysql:concat columns>>> mysqlfiddle
#+BEGIN_EXAMPLE
SELECT s.id, s.firstname, s.lastname
,GROUP_CONCAT(DISTINCT ts.score ORDER BY ts.testDate SEPARATOR ', ') AS student_scores
,GROUP_CONCAT(DISTINCT liConCat2(c.course, c.year) SEPARATOR 0x1E) AS courses
FROM student s 
     LEFT JOIN testScore ts ON ts.sid = s.id
     LEFT JOIN s_course c ON c.sid = s.id
GROUP BY s.id
ORDER BY s.lastname
#+END_EXAMPLE

GROUP_CONCAT only concatenates non-null values. If all values are null, null will be returned.

GROUP_CONCAT by default only handles 1024 letters. Change it for the current session
#+BEGIN_EXAMPLE
SET SESSION group_concat_max_len = 65535;
#+END_EXAMPLE

If there're multiple fields that have multiple values, e.g. a student can have multiple scores and multiple courses, and they are joined,

Total number of rows are for one student is: N(courses of student) X N(scores of student),
N(x) is number of x, when x is zero, N(0) = 1.

When you do GROUP_CONCAT on course, use DISTINCT inside.

Concatenate multiple fields
~GROUP_CONCAT(DISTINCT liConCat2(c.course, c.year) SEPARATOR 0x1E) AS courses~

**** Concatenate strings, use a different separator
- 0x1F (31): unit (fields) separator
- 0x1E (30): record separator
- 0x1D (29): group separator
#+BEGIN_EXAMPLE
GROUP_CONCAT(foo SEPARATOR 0x1D)
$array = explode(chr(29),$s);
#+END_EXAMPLE

*** User Variable
#+BEGIN_EXAMPLE
SET @s3 = 'http://s3.amazon.com/abc/';
SELECT @s3
#+END_EXAMPLE

*** Routines
Procedure and User Defined Functions are stored under the schema as routines

e.g. Schema (database) is pantheon, pantheon.tables are all tables and pantheon.routines

<<<mysql:routine:characteristics>>>
#+BEGIN_EXAMPLE
characteristic:
    COMMENT 'string'
  | LANGUAGE SQL
  | [NOT] DETERMINISTIC
  | { CONTAINS SQL | NO SQL | READS SQL DATA | MODIFIES SQL DATA }
  | SQL SECURITY { DEFINER | INVOKER }
#+END_EXAMPLE

Don't specify LANGUAGE SQL

A routine is considered “deterministic” if it always produces the same result for the same input parameters, and “not deterministic” otherwise. If neither DETERMINISTIC nor NOT DETERMINISTIC is given in the routine definition, the default is NOT DETERMINISTIC. To declare that a function is deterministic, you must specify DETERMINISTIC explicitly.

Non-deterministic examples are data modification, have UPDATE, INSERT or DELETE statement(s).
Default without ~SET GLOBAL log_bin_trust_function_creators = 1;~ is ~NOT DETERMINISTIC~
Without specifying DETERMINISTIC and with the default setting, this error throws:
#+BEGIN_EXAMPLE
This function has none of DETERMINISTIC, NO SQL, or READS SQL DATA in its declaration and binary logging is enabled (you *might* want to use the less safe log_bin_trust_function_creators variable)
#+END_EXAMPLE

{ CONTAINS SQL | NO SQL | READS SQL DATA | MODIFIES SQL DATA }

- CONTAINS SQL Default, indicates that the routine does not contain statements that read or write data. Examples of such statements are SET @x = 1 or DO RELEASE_LOCK('abc'), which execute but neither read nor write data.
- NO SQL :: indicates that the routine contains no SQL statements.
- READS SQL :: DATA indicates that the routine contains statements that read data (for example, SELECT), but not statements that write data.
- MODIFIES SQL DATA :: indicates that the routine contains statements that may write data (for example, INSERT or DELETE).

The parameter list enclosed within parentheses must always be present. If there are no parameters, an empty parameter list of () should be used. Parameter names are not case sensitive.

*** Procedure
**** Syntax
#+BEGIN_EXAMPLE
CREATE
    [DEFINER = { user | CURRENT_USER }]
    PROCEDURE sp_name ([proc_parameter[,...]])
    [characteristic ...] routine_body

proc_parameter:
    [ IN | OUT | INOUT ] param_name type

mysql:routine:characteristics
#+END_EXAMPLE

- IN :: Default. It passes a value into a procedure. The procedure might modify the value, but the modification is not visible to the caller when the procedure returns. 
- OUT :: passes a value from the procedure back to the caller. Its initial value is NULL within the procedure, and its value is visible to the caller when the procedure returns. An INOUT parameter is initialized by the caller, can be modified by the procedure, and any change made by the procedure is visible to the caller when the procedure returns.

For each OUT or INOUT parameter, pass a user-defined variable in the CALL statement that invokes the procedure so that you can obtain its value when the procedure returns. If you are calling the procedure from within another stored procedure or function, you can also pass a routine parameter or local routine variable as an IN or INOUT parameter.

Routine parameters cannot be referenced in statements prepared within the routine

Each SELECT statement that does not insert into a table or a variable will produce a result set.
#+BEGIN_EXAMPLE
mysql> delimiter //

mysql> CREATE PROCEDURE simpleproc (OUT param1 INT)
    -> BEGIN
    ->   SELECT COUNT(*) INTO param1 FROM t;
    -> END//
Query OK, 0 rows affected (0.00 sec)

mysql> delimiter ;

mysql> CALL simpleproc(@a);
Query OK, 0 rows affected (0.00 sec)

mysql> SELECT @a;
+------+
| @a   |
+------+
| 3    |
+------+
1 row in set (0.00 sec)
#+END_EXAMPLE

**** Prepare Statement, Convert delimited string into temp table
A prepare statement is unique to a session. If it's not deallocated, it will be deallocated automatically when the session ends.
<<<mysql:string:list:temp table>>>
#+BEGIN_EXAMPLE
DROP PROCEDURE IF EXISTS `getArticlesByCats`;
CREATE PROCEDURE getArticlesByCats(IN pDelim VARCHAR(32), IN pStr TEXT )
DETERMINISTIC
MODIFIES SQL DATA
  BEGIN
    DROP TABLE IF EXISTS li_temp_explode;
    CREATE TEMPORARY TABLE li_temp_explode (id INT AUTO_INCREMENT PRIMARY KEY NOT NULL, word VARCHAR(40));
    SET @sql := CONCAT('INSERT INTO li_temp_explode (word) VALUES (', REPLACE(QUOTE(pStr), pDelim, '\'), (\''), ')');
    PREPARE myStmt FROM @sql;
    EXECUTE myStmt;
    DEALLOCATE PREPARE myStmt;
    -- Later use the temp table in IN statement
    SELECT *
    FROM node n
    WHERE EXISTS(
      SELECT * 
      FROM cats c
      WHERE c.cid IN (
        SELECT CAST(word AS UNSIGNED)
        FROM li_temp_explode
      )
    )
  END;
#+END_EXAMPLE
word column is string

#+BEGIN_EXAMPLE
CALL `getArticlesByCats`(',', '1,31,5,6,7,8,9,10');
SELECT * FROM li_temp_explode;
#+END_EXAMPLE

*** User Defined Function <<<mysql:udf>>>
A UDF always returns a value.

Syntax
#+BEGIN_EXAMPLE
CREATE
    [DEFINER = { user | CURRENT_USER }]
    FUNCTION sp_name ([func_parameter[,...]])
    RETURNS type
    [characteristic ...] routine_body

func_parameter:
    param_name type

type:
    Any valid MySQL data type

mysql:routine:characteristics
#+END_EXAMPLE

#+BEGIN_EXAMPLE
SET @lis3 = 'http://s3.amazonaws.com/abc/';
SET @lifs = 'http://abc.com/sites/default/files/';
SET @litt = 'http://abc.com/';
SET @lir1 = '^(s3://)(.*)';
SET @lir2 = CONCAT(@lis3, '\\2');
SET @lir3 = '^(public://)(.*)';
SET @lir4 = CONCAT(@lifs, '\\2');

DROP FUNCTION IF EXISTS `liFileUri`;

CREATE FUNCTION `liFileUri` (`uri` VARCHAR(255)) 
  RETURNS VARCHAR(255)
DETERMINISTIC
NO SQL
  BEGIN
    RETURN REGEXP_REPLACE(REGEXP_REPLACE(uri, @lir1, @lir2), @lir3, @lir4);
  END;

DROP FUNCTION IF EXISTS `liConCat2`;
CREATE FUNCTION `liConCat2`(`v1` TEXT, `v2` TEXT)
  RETURNS TEXT
DETERMINISTIC
NO SQL
  BEGIN
    DECLARE s TEXT;
    IF (v1 IS NULL AND v2 IS NULL)
    THEN SET s = NULL;
    ELSE SET s = CONCAT_WS(0x1F, v1, v2);
    END IF;
    RETURN s;
  END;

-- UDF can't have optional parameter. e.g. have to create liConCat3 to concat 3 fields

DROP FUNCTION IF EXISTS `liFixNull`;
CREATE FUNCTION `liFixNull`(`text` TEXT)
  RETURNS TEXT
DETERMINISTIC
  BEGIN
-- Use this with CONCAT('aString', liFixNull(aColumn)) is useful because CONCAT returns NULL if any is null
    RETURN CASE text
           WHEN 'NULL' THEN NULL
           WHEN '' THEN NULL
           ELSE text
           END;
  END;
#+END_EXAMPLE

*** SQL Fiddle <<<mysqlfiddle>>>
http://sqlfiddle.com/ http://dbfiddle.uk/

Schema
#+BEGIN_EXAMPLE
CREATE TABLE student (
`id` INT(6) UNSIGNED AUTO_INCREMENT PRIMARY KEY, 
`firstname` VARCHAR(20) NOT NULL,
`lastname` VARCHAR(20) NOT NULL,
`reg_date` TIMESTAMP
);

INSERT INTO student ( firstname, lastname, reg_date )
VALUES 
( 'first1', 'last1', current_timestamp),
( 'first2', 'last2', current_timestamp),
( 'first3', 'last3', current_timestamp)
;

CREATE TABLE s_score (
`id` INT(6) UNSIGNED AUTO_INCREMENT PRIMARY KEY, 
`sid` INT(6) UNSIGNED NOT NULL,
`score` INT(3) UNSIGNED NOT NULL
);

INSERT INTO s_score ( sid, score )
VALUES 
( 1, 20 ),
( 1, 30 ),
( 2, 40 )
;

CREATE TABLE s_course (
`id` INT(6) UNSIGNED AUTO_INCREMENT PRIMARY KEY, 
`sid` INT(6) UNSIGNED NOT NULL,
`course` VARCHAR(20)
);

INSERT INTO s_course ( sid, course )
VALUES 
( 1, 'Math'),
( 1, 'English' ),
( 2, 'PHP' )
;
#+END_EXAMPLE

*** Dump, Restore
#+BEGIN_EXAMPLE
mysqldump -u user -p database_name > database_name_backup.sql

# dump specific tables
mysqldump -u user -p database_name t1 t2 t3 > a.sql

# Use config file to avoid typing password
mysqldump --defaults-extra-file=/path/to/.mydb.cnf -u user db_name > db_name_bk.sql
#+END_EXAMPLE

.mydb.cnf
#+BEGIN_EXAMPLE
[mysqldump]
password='enclosedwithdoublequotes'
#+END_EXAMPLE

MySQL is inside a container some-mysql and dump it on host
#+BEGIN_EXAMPLE
docker exec some-mysql sh -c 'exec mysqldump --all-databases -uroot -p"your-passowrd"' > /some/path/on/your/host/all-databases.sql
#+END_EXAMPLE

Restore
#+BEGIN_EXAMPLE
cat backup.sql | docker exec -i CONTAINER /usr/bin/mysql -u root --password=root DATABASE
#+END_EXAMPLE

** MSSQL
*** Modify column values if exist (CASE WHEN)
#+BEGIN_EXAMPLE
SELECT colOne,
varColTwo = 
CASE colTwo
 WHEN 1 THEN 1
 WHEN 0 THEN 3
END,
varImage = 
CASE
 WHEN len(colImage) > 0 THEN 'http://abc.com/images/' + colImage
 ELSE ''
END
FROM aTable
ORDER BY varColTwo DESC,
CASE 
 WHEN colFour = 1 THEN colFive
 WHEN colFour = 2 THEN colSix
END ASC      
#+END_EXAMPLE

*** Concatenate Multiple Columns to Single Column as String
A doc has multiple categories. Concatenate the categories delimited by commas.

#+BEGIN_EXAMPLE
SELECT doc.intDocID
      ,doc.varTitle
      ,STUFF(
          (SELECT ',' + CAST( t2.catID AS varchar(10) )
           FROM tblDocCat t2
           WHERE t2.intDocID = doc.intDocID
           FOR XML PATH('')
          ),
          1,
          1,
          ''
       ) AS docCats
#+END_EXAMPLE

**** STUFF
This deletes the first letter of a column and returns the rest.
STUFF first deletes a substring from aCol at start:1 and length_to_delete:1
and then insert a string at the start position
#+BEGIN_EXAMPLE
STUFF(aCol, 1,1, '')
#+END_EXAMPLE

*** Export as CSV - BCP
<<<mssql:bcp>>>
bcp.exe is in 
C:\Program Files\Microsoft SQL Server\90\Tools\Binn\

#+BEGIN_EXAMPLE
bcp "Select * from fullDatabasename.dbo.tableName" queryout "c:\aFolder\aFile.csv" -c -t"\",\"" -r"\"\n\"" -T
#+END_EXAMPLE

Table name in full :: DEDP225.[dev.todaystrucking].dbo.[tblDocument]

| c | Ascii                            |
| t | field terminator. Comma          |
| r | row terminator. New line :: "\n" |
| T | trusted connection               |

**** Escape % if bcp is in batch file
#+BEGIN_EXAMPLE
bcp "SELECT * FROM aTable WHERE email LIKE '%%@%%.%%'"
#+END_EXAMPLE

**** Save long query in Global Temporary table (GTT)
#+BEGIN_EXAMPLE
SELECT *
INTO ##myglobaltemptable
FROM tableA
#+END_EXAMPLE

Drop the GTT after bcp: =DROP TABLE ##myglobaltemptable=

#+BEGIN_EXAMPLE
bcp ##myglobaltemptable out "c:\folder\file.csv" -c -t"\",\"" -r"\"\n\"" -T
#+END_EXAMPLE

**** Get all columns
#+BEGIN_EXAMPLE
DECLARE @colnames VARCHAR(max);
SELECT @colnames = COALESCE(@colnames + ',', '') + char(39)+ column_name +char(39) 
FROM INFORMATION_SCHEMA.COLUMNS where TABLE_NAME='%yourtablename%'; 
SELECT @colnames
#+END_EXAMPLE

It returns ='col1','col2',...,'colLast'=

Export to header.csv
=bcp "SELECT 'col1','col2',...,'colLast'" queryout "c:\header.csv" -c -t"\",\"" -r"\"\n\"" -T=

**** Last step
Both header and data files need to be fixed.
Insert a double quote at the beginning of the file and delete the last double quote at the end of it.
Insert a new line at the end of the header file.

Combine 2 files
=copy /b c:\header.csv+c:\folder\file.csv c:\export.csv=

*** Export as XML
By default, it's UTF-8 encoded. datetime will be automatically converted to XML format.
If value is NULL, the xml node will not be generated.
By default, MSSQL will add =<CR><LF>= into the Unicode XML data stream every 2033 characters.
Use bcp with option -r to add no new line.

**** Query
#+BEGIN_EXAMPLE
SELECT CustomerID as "@id",
CompanyName,
Address as "address/street",
City as "address/city",
Region as "address/region",
PostalCode as "address/zip",
Country as "address/country",
ContactName as "contact/name",
ContactTitle as "contact/title",
NULLIF(Phone,'') as "contact/phone",
-- If value is NULL, the xml node will not be generated
Fax as "contact/fax"
FROM Customers
FOR XML PATH('Customer'), ROOT('doc')
#+END_EXAMPLE

Result
#+BEGIN_EXAMPLE
<doc>
  <Customer id="ALFKI">
    <CompanyName>Alfreds Futterkiste</CompanyName>
    <address>
      <street>Obere Str. 57</street>
      <city>Berlin</city>
      <zip>12209</zip>
      <country>Germany</country>
    </address>
    <contact>
      <name>Maria Anders</name>
      <title>Sales Representative</title>
      <phone>030-0074321</phone>
      <fax>030-0076545</fax>
    </contact>
  </Customer>
  ...
</doc>
#+END_EXAMPLE

INNER JOIN Multiple records
#+BEGIN_EXAMPLE
SELECT d.docID
,(
SELECT c.category AS category
FROM tblDocCats dc
 INNER JOIN tblCategory c ON c.catID = dc.catID
WHERE dc.docID = d.docID
FOR XML PATH(''), TYPE
) AS categories
FROM doc d
FOR XML PATH('item'), ROOT('items')
#+END_EXAMPLE

Result
#+BEGIN_EXAMPLE
<items>
 <item>
  <docID></docID>
  <categories>
   <category></category>
   ...
  <categories>
 <item>
</items>
#+END_EXAMPLE

This
#+BEGIN_EXAMPLE
,(
SELECT c.category AS name, c.catID as ID
FROM tblDocCats dc
 INNER JOIN tblCategory c ON c.catID = dc.catID
WHERE dc.docID = d.docID
FOR XML PATH('category'), TYPE
)
#+END_EXAMPLE
will result as
#+BEGIN_EXAMPLE
<items>
 <item>
  <docID></docID>
  <category>
   <name></name>
   <id></id>
  <category>
  <category>
   <name></name>
   <id></id>
  </category>
  ...
 <item>
</items>
#+END_EXAMPLE

**** Different modes
FOR XML AUTO
#+BEGIN_EXAMPLE
<servername.dbo.Customers ID="C11" Name="..." Address="..." />
#+END_EXAMPLE

FOR XML RAW
#+BEGIN_EXAMPLE
<row ID="C11" Name="..." Address="..." />
#+END_EXAMPLE

FOR XML PATH
#+BEGIN_EXAMPLE
<row>
  <ID></ID>
  <Name></Name>
  <Address></Address>
</row>
#+END_EXAMPLE

**** bcp
#+BEGIN_EXAMPLE
bcp "query..." queryout C:\file.xml -T -w -r
#+END_EXAMPLE

| r | no value means don't add any newline character for every 2033 characters or new row |
| w | Use Unicode characters                                                              |
| S | server_name[\instance_name]                                                         |

Save long query as stored procedure. You can't save FOR XML in Global Temporary Table.
dev.todaystrucking is the database name. Inside the real SELECT, you can refer to table as
dbo.tablename not DEDP225.[dev.todaystrucking].dbo.tablename
#+BEGIN_EXAMPLE
USE [dev.todaystrucking]
GO

IF OBJECT_ID('dbo.usp_exporttr') IS NOT NULL DROP PROC dbo.usp_exporttr
GO

CREATE PROC dbo.usp_exporttr AS

SET NOCOUNT ON

SELECT ...
FOR XML PATH('item'), ROOT('items')

RETURN
GO
#+END_EXAMPLE

Then creat another query in MS SQL Server Management Studio and run
#+BEGIN_EXAMPLE
EXEC xp_cmdshell 'bcp "EXEC [dev.todaystrucking].dbo.usp_exporttr" queryout "c:\a.xml" -S (local) -T -w -r'
#+END_EXAMPLE

You may receive "SQL Server blocked access to procedure 'sys.xp_cmdshell' of component 'xp_cmdshell' because this component is turned off as part of the security configuration"

Just go to bcp folder and run as a command line mssql:bcp
#+BEGIN_EXAMPLE
bcp "EXEC [dev.todaystrucking].dbo.usp_exporttr" queryout "c:\a.xml" -S (local) -T -w -r
#+END_EXAMPLE

The exported xml file will have UCS-2 encoding which is a preceding version of UTF-16.
This encoding is in BOM. For SQL Server lower than 2016, you can't set encoding to UTF-8.

**** bcp clean up
You can run these in Git Bash on Windows
Change encoding to UTF-8
iconv -f UCS-2 -t UTF-8 a.xml > b.xml

Add xml declaration
echo '<?xml version="1.0"?>' | cat - b.xml > c.xml

Delete xml:invalid_characters bash:sed
sed "s/&#x1f;//gi; s/&#x1e;//gi;" c.xml > d.xml

*** Copy to Excel
C-a and C-c, C-v in Excel
For datetime, you can ~=now()~ in a new cell, format paint the datetime columns.

In the ~=now()~ cell, you can check out the Custom format. It's yyyy-mm-dd h:mm
You can change it to yyyy-mm-dd h:mm:ss AM/PM

*** Migrate to MySQL
Export MSSQL to a bak file. mssql:backup
https://stackoverflow.com/questions/156279/how-to-import-a-sql-server-bak-file-into-mysql

If the bak file is less than 10gb, follow this:
https://www.silicongadget.com/software/database/import-mssql-bak-files-to-mysql/2955/
- Restore MSSQL database using the bak file using MS SQL Server Express Edition
- Use MySQL Workbench to connect to the MSSQL database and then migrate to MySQL

*** Connections
Number of active connections by database
#+BEGIN_EXAMPLE
SELECT 
    DB_NAME(dbid) as DBName, 
    COUNT(dbid) as NumberOfConnections,
    loginame as LoginName
FROM sys.sysprocesses
WHERE dbid > 0
GROUP BY dbid, loginame

-- 2017 new query

SELECT @@ServerName AS server
 ,NAME AS dbname
 ,COUNT(STATUS) AS number_of_connections
FROM sys.databases sd
LEFT JOIN sys.sysprocesses sp ON sd.database_id = sp.dbid
GROUP BY NAME
#+END_EXAMPLE

*** Last access
#+BEGIN_EXAMPLE
SELECT d.name,
last_user_seek = MAX(last_user_seek),
last_user_scan = MAX(last_user_scan),
last_user_lookup = MAX(last_user_lookup),
last_user_update = MAX(last_user_update)
FROM sys.dm_db_index_usage_stats AS i
JOIN sys.databases AS d ON i.database_id=d.database_id
GROUP BY d.name
#+END_EXAMPLE

*** Backup
<<<mssql:backup>>>
https://docs.microsoft.com/en-us/sql/relational-databases/backup-restore/create-a-full-database-backup-sql-server
Export database to bak file.
SQL Management Studio Tool > right click on a database and
Tasks > Backup > Use Full backup, specify a destination (path to bak).
Use overwrite settings in Options.
Then click on Script > Script to file. You will get a .sql:
#+BEGIN_EXAMPLE
BACKUP DATABASE [aDatabase] TO DISK ='N'C:\afile.bak' WITH NOFORMAT, INIT, 
NAME = N'aDatabase-Full Database Backup', 
SKIP, NOREWIND, NOUNLOAD,  STATS = 10
GO
#+END_EXAMPLE

Make filename dynamic (remove spaces if necessary):
#+BEGIN_EXAMPLE
DECLARE @filename nvarchar(200) = ''
SELECT @filename = 'C:\test-' + convert(varchar(23), getdate(), 126) + '.bak'
BACKUP DATABASE [aDatabase] TO
 DISK =  @filename WITH NOFORMAT, INIT,  
 NAME = N'aDatabase-Full Database Backup', SKIP, NOREWIND, NOUNLOAD,  STATS = 10
GO
#+END_EXAMPLE

Run this .sql file:
#+BEGIN_EXAMPLE
sqlcmd -S sqlservername -i C:\sqlFileName.sql
#+END_EXAMPLE

* DFP
** Why async is required
Video companion requires async
pubService.refresh requires async
POST request requires async. GET request with larger than 2048 bytes not supported.

However, it's better to use sync mode for rich media creative unless the creative is in friendly frames

** Competition Calculation
- List of candidate line items
- select the best line item
- select the best creative associated with the winning line item
- DFP remnant and Ad Exchange/Adsense line items are evaluated 
to see if they have line items with a higher yield
- the best creastive associated with the winning line item is selected
- creative returned to the browser. Dynamic allocation.

** Key-Value Targeting
Slot-level targeting is recommended
#+BEGIN_EXAMPLE
googletag.defineSlot('/123/travel/asia/food', [728, 90], "div-id")
         .addService(googletag.pubads())
         .setTargeting("interests", ["sports", "music"]);
#+END_EXAMPLE

Page-level targeting
#+BEGIN_EXAMPLE
googltag.pubads().setTargeting("topic", "basketball");
#+END_EXAMPLE

** Exclusive Ads on Specific Page
Let's say there're 2 LBs and 2 BBs throughout the website.
999/LB1, 999/LB2, 999/BB1, 999/BB2
For a specific page, Line Item A takes over all ad units.
For another specific page, Line Item B takes over all ad units.

The perfect way
Create multilevel ad units and make them Special Ad Units. 
999/LB1/exclusive, 999/LB2/exclusive
999/BB1/exclusive, 999/BB2/exclusive

On those specific pages:
- Use the new tags of multilevel and special ad units on HTML instead of the original ones.
- setTargetting on HTML and on DFP so that Line Item A and B can be distinguished.

The better way
Multilevel and Special ad units are only avaiable in Premium. Here's the way for SBS
- 999/LB1_exclusive, 999/LB2_exclusive
- 999/BB1_exclusive, 999/BB2_exclusive
- Use the new tags on HTML instead of the original ones
- setTargetting on HTML and DFP so that Line Item A and B 

The workaround way
If you don't have control on HTML, you can:
- For Line Item A and B
  - On DFP
    - add Key-Value pair exclusive is exclusive
    - add Key-Value pair sponsor is lineitemA
  - In HTML, for those specific pages
    - setTargeting("exclusive","exclusive");
    - setTargeting("sponsor","lineitemA");
- For other normal line items
  - On DFP
    - add Key-Value par 'exclusive is not ~exclusive' (~ means contain and * means begin with)
  - In HTML, do nothing (remain the same)

** DFP in email
[[https://support.google.com/dfp_premium/answer/2623168?hl=en][Simplified URL tags on DFP Help]]

#+BEGIN_EXAMPLE
<a href="http://my.com/ad/ad_unit_name/728x90/">
 <img width="728" height="90" alt=""
  src="http://pubads.g.doubleclick.net/gampad/ad?iu=/networkid/ad_unit_name&sz=728x90&c=[todays_date][account]" />
</a>
#+END_EXAMPLE

Base URL :: http://pubads.g.doubleclick.net/gampad/[request-type]?[parameters]

Request Type
| ad   | simple image creative                               |
| jump | log click and redirect to destination URL           |
| adx  | return raw code of creative                         |
| clk  | only log click but no redirect. Only in DFP Premium |
|      |                                                     |

Parameters
| iu       | for all request types                                                   |
| sz       | for ad, jump and adx                                                    |
| t        | for ad, jump and adx. key-value pairs                                   |
| excl_cat | competitive exclusions                                                  |
| c        | for ad, jump and adx. cache buster. only number                         |
| m        | for adx. Specify file type to return. m=text/html                       |
| submodel | for all request types. Mobile device name                               |
| u_w      | for all request types. Mobile device screen height.                     |
| title    | required if mutliple ad tags use the same ad unit code on the same page |
| mob      | Indicaste it's a mobile request.                                        |

#+BEGIN_EXAMPLE
<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script>
var ad_unit = 'ad_unit_name';
var ad_unit_size = '728x90';
var rnd=Math.floor(Math.random() * (999999 - 10 +1)) + 10;
var theUrl='//pubads.g.doubleclick.net/gampad/adx?iu=/' + ad_unit 
	+ '&sz=' + ad_unit_size + '&c=' + rnd;
var xmlHttp = null;
xmlHttp = new XMLHttpRequest();
xmlHttp.open( "GET", theUrl );
xmlHttp.send();
xmlHttp.onreadystatechange=function() {
  if (xmlHttp.readyState==4 && xmlHttp.status==200) {
    xmlDoc = $.parseHTML( xmlHttp.response );
    adlink = $(xmlDoc).find('a').attr('href');
    if (typeof adlink == "undefined") adlink = "http://www.example.com";
      window.location = adlink;
  }
}
</script>
#+END_EXAMPLE

PHP, DFP creative type Custom. Get response line by line
#+BEGIN_EXAMPLE
$url = "http://pubads.g.doubleclick.net/gampad/adx?iu=/12343/ad_unit_name&sz=230x20&c=". REQUEST_TIME."&m=text/html";
$json = @file_get_contents($url);
if ($json !== FALSE) {
  $lines = explode("\n", $json);
  $link = ( isset($lines[0]) ) ? trim($lines[0]) : 'default';
}
#+END_EXAMPLE

Wordpress example wp:filter:template_include

** Responsive
Add a size to the ad unit /networkid/adunitname
You can specify one or more sizes for a line item that uses this ad unit.
And upload each creative and specify the size. You can have creative bigger than the size you specify.

#+BEGIN_EXAMPLE
googletag.cmd.push(function() {
  var leaderboard_mapping = googletag.sizeMapping()
  .addSize([1280, 800], [[970, 250], [970, 90], [728, 90]])
  .addSize([600, 800], [468, 60]) // viewport size is width and height both > 600 and 800
  .addSize([0, 0], [[320, 50], [320, 100]]) // Map any viewport size
/* This will only display the ad if it's mobile or tablet viewport size
  .addSize([0, 0], []) // [] means don't try to call an ad
  .addSize([320, 700], [300, 250]) // Mobile or tablet
  .addSize([1050, 200], [])
*/
  .build();
  
  googletag.defineSlot('/networkid/adunitname'
           , [728, 90] // If there is an error in the mapping or if the browser size can't be determined
                       // the size specified here in .defineSlot will be used. 
           , 'div-id')
           .defineSizeMapping(leaderboard_mapping)
           .addService(googletag.pubads());
});
#+END_EXAMPLE

** Macro in Third Party Code, Custom Code
CACHEBUSTER :: time in integer
CLICK_URL_UNESC :: normal click macro
CLICK_URL_ESC :: escaped click macro (&, ? , %)

VIEW_URL_UNESC, VIEW_URL_ESC :: required in Custom Code

If DFP macro comes at the start of the URL chain, the unescaped macro should be used.
IF DFP macro comes at the end of the URL chain, the escaped macro should be used. (DFP macro is passed as a parameter to 3rd party server)

<<<dfp:third party code>>>
Third Party Code with macro automatically inserted
#+BEGIN_EXAMPLE
<!-- url parameter ncu is inserted, ord's [timestamp] is replaced by CACHEBUSTER -->
<script src="http://bs.serving-sys.com/Serving/adServer.bs?c=28&cn=display&pli=1074030166&w=728&h=90&ncu=$$%%CLICK_URL_UNESC%%$$&ord=%%CACHEBUSTER%%&ifrm=-1&z=0"></script>
<noscript>
<!-- insert CLICK_URL_UNESC in href -->
<a href="%%CLICK_URL_UNESC%%http://bs.serving-sys.com/Serving/adServer.bs?cn=brd&pli=1074030166&Page=&Pos=944448101" target="_blank">
<img src="http://bs.serving-sys.com/Serving/adServer.bs?c=8&cn=display&pli=1074030166&Page=&Pos=944448101" border=0 width=728 height=90></a>
</noscript>
#+END_EXAMPLE

Sometimes you need to have DFP inserted the macros in third party code mode, and then use that in Custom Code.

<<<dfp:custom code>>>
VIEW_URL_UNESC or VIEW_URL_ESC should be included otherwise impression won't be tracked.
In preview, this view macro returns empty but that's normal. It has value when the creative is served.

** Creative Type: Third Party Code - Video

#+BEGIN_EXAMPLE
<script src="//content.jwplatform.com/players/xxx-xxx.js?v=%%CACHEBUSTER%%"></script>
#+END_EXAMPLE

Viewbix
#+BEGIN_EXAMPLE
<iframe width="300" height="250" 
src="http://www.viewbix.com/frame/1234-567-890?w=300&h=250&ord=%%CACHEBUSTER%%" 
frameborder="0" scrolling="no" allowTransparency="true"></iframe>
#+END_EXAMPLE

** Creative Type: HTML5
Upload zip file or single html file

** Creative Type: DoubleClick Tag, DCM Tag
DCM, previously known as DFA (for advertisers), is DoubleClick Campaign Manager, part of the DoubleClick Marketing Solutions.

[[https://support.google.com/dcm/partner/answer/2826636][DCM placement tags]]

Always use Internal redirect tag for DFP. Sometimes this tag is not given by agency, you will need to convert it to this type.
Ins tag is recommended for ad servers other than DFP because it has active view capability.

ddm/jump tag (redirect to final destination) has to be loaded with ddm/ad tag.

Other tags like ddm/trackimp, ddm/trackclk, ddm/clk don't have to be loaded with ddm/ad tag.

*** Standard tags (ddm/jump, ddm/ad)
#+BEGIN_EXAMPLE
<A HREF="https://ad.doubleclick.net/ddm/jump/Nxxxx.site-keyname/Byyyyyyy.Pzzzz;sz=widthxheight;kw=[keyword];ord=[timestamp]?">
 
<IMG SRC="https://ad.doubleclick.net/ddm/ad/Nxxxx.site-keyname/Byyyyyyy.Pzzzz;sz=widthxheight;ord=[timestamp];dc_lat=N;dc_rdid=Czzzz;tag_for_child_directed_treatment=I?" BORDER=0 WIDTH=X HEIGHT=Y ALT="Click Here"></A>
#+END_EXAMPLE

Nxxx: DCM account id
Byyyy: DCM campaign ID
.Pzzzz: DCM placement ID
dc_lat=N: key-value pair for mobile app to pass if the user has enabled "Limit Ad Tracking"
dc_rdid=Czzz: key-value pair for mobile app to pass resettable device identifiers in the form of IDFA for iOS or advertising ID (AdID) for Android
tag_for_child_directed_treatment=I: key-value pair for mobile app to pass info about if a request may come from a user under the age of 13

*** iframe/javascript tags  (ddm/adi, ddm/adj)
#+BEGIN_EXAMPLE
<IFRAME SRC=""https://ad.doubleclick.net/ddm/adi/N1234.123456yoursite.com/B1234567.123456789;sz=300x250;ord=[timestamp];dc_lat=;dc_rdid=;tag_for_child_directed_treatment=?"" WIDTH=300 HEIGHT=250 MARGINWIDTH=0 MARGINHEIGHT=0 HSPACE=0 VSPACE=0 FRAMEBORDER=0 SCROLLING=no BORDERCOLOR='#000000'>
<SCRIPT language='JavaScript1.1' SRC=""https://ad.doubleclick.net/ddm/adj/N1234.123456yoursite.com/B1234567.123456789;abr=!ie;sz=300x250;ord=[timestamp];dc_lat=;dc_rdid=;tag_for_child_directed_treatment=?"">
</SCRIPT>
<NOSCRIPT>
<A HREF=""https://ad.doubleclick.net/ddm/jump/N1234.123456yoursite.com/B1234567.123456789;abr=!ie4;abr=!ie5;sz=300x250;ord=[timestamp]?"">
<IMG SRC=""https://ad.doubleclick.net/ddm/ad/N1234.123456yoursite.com/B1234567.123456789/B10762433.143897886;abr=!ie4;abr=!ie5;sz=300x250;ord=[timestamp];dc_lat=;dc_rdid=;tag_for_child_directed_treatment=?"" BORDER=0 WIDTH=300 HEIGHT=250 ALT=""Advertisement""></A>
</NOSCRIPT>
</IFRAME>
#+END_EXAMPLE

*** javascript (ddm/adj)
#+BEGIN_EXAMPLE
<SCRIPT language='JavaScript1.1' SRC=""https://ad.doubleclick.net/ddm/adj/N1234.123456yoursite.com/B1234567.123456789;sz=300x250;ord=[timestamp];dc_lat=;dc_rdid=;tag_for_child_directed_treatment=?"">
</SCRIPT>
<NOSCRIPT>
<A HREF=""https://ad.doubleclick.net/ddm/jump/N1234.123456yoursite.com/B1234567.123456789;sz=300x250;ord=[timestamp]?"">
<IMG SRC=""https://ad.doubleclick.net/ddm/ad/N1234.123456yoursite.com/B1234567.123456789;sz=300x250;ord=[timestamp];dc_lat=;dc_rdid=;tag_for_child_directed_treatment=?"" BORDER=0 WIDTH=300 HEIGHT=250 ALT=""Advertisement""></A>
</NOSCRIPT>
#+END_EXAMPLE

*** Pre-fetch tags (ddm/pfadx)
#+BEGIN_EXAMPLE
# VAST 2.0
https://ad.doubleclick.net/ddm/pfadx/Nxxxx.site-keyname/Byyyyyyy;kw=[keyword]; sz=widthxheight;ord=[timestamp];dc_lat=N;dc_rdid=Czzzz;tag_for_child_directed_treatment=I;dcmt=text/xml

# VAST 3.0
https://ad.doubleclick.net/ddm/pfadx/Nxxxx.site-keyname/Byyyyyyy;kw=[keyword]; sz=widthxheight;ord=[timestamp];dc_lat=N;dc_rdid=Czzzz;tag_for_child_directed_treatment=I;dcmt=text/xml;dc_vast=3

# VAST 4.0
https://ad.doubleclick.net/ddm/pfadx/Nxxxx.site-keyname/Byyyyyyy;kw=[keyword]; sz=widthxheight;ord=[timestamp];dc_lat=N;dc_rdid=Czzzz;tag_for_child_directed_treatment=I;dcmt=text/xml;dc_vast=4
#+END_EXAMPLE

*** Click tracker (ddm/clk)
#+BEGIN_EXAMPLE
https://ad.doubleclick.net/ddm/clk/[ad ID];[placement ID];[verifier]?[click-through URL]
#+END_EXAMPLE

*** Internal redirect tag
https://ad.doubleclick.net/ddm/ad/N1234.123456yoursite.com/B1234567.123456789;sz=320x548

#+BEGIN_EXAMPLE
# Image URL
https://ad.doubleclick.net/ddm/ad/Nxxxx.site-keyname/Byyyyyyy.n;sz=widthxheight;dc_expa=URL

# Click-through URL
https://ad.doubleclick.net/ddm/jump/Nxxxx.site-keyname/Byyyyyyy.n;sz=widthxheight
#+END_EXAMPLE

dc_expa: Ping an encoded URL in order to track real-time expansions of rich media display expanding creatives.

Grab the attribute data-dcm-placement value from either iframe or Ins tag and also the size
#+BEGIN_EXAMPLE
https://ad.doubleclick.net/ddm/ad/[data-dcm-placement];sz=widthxheight
#+END_EXAMPLE

*** Ins tag
In DFP, always use internal redirect tag. May also deploy DCM tag as a custom creative by adding DFP macros. [[https://support.google.com/dfp_premium/answer/1656861?hl%3Den&ref_topic%3D28160][Instructions]]

#+BEGIN_EXAMPLE
Iframe
<ins class='dcmads' style='display:inline-block;width:300px;height:250px'
    data-dcm-placement='N1234.123456yoursite.com/B1234567.123456789'
    data-dcm-rendering-mode='script'
    data-dcm-https-only
    data-dcm-resettable-device-id=''
    data-dcm-app-id=''>
  <script src='https://www.googletagservices.com/dcm/dcmads.js'></script>
</ins>

Javascript
<ins class='dcmads' style='display:inline-block;width:300px;height:250px'
    data-dcm-placement='N1234.123456yoursite.com/B1234567.123456789'
    data-dcm-rendering-mode='script'
    data-dcm-https-only
    data-dcm-resettable-device-id=''
    data-dcm-app-id=''>
  <script src='https://www.googletagservices.com/dcm/dcmads.js'></script>
</ins>
#+END_EXAMPLE

** Wallpaper, Site Skin

On DFP
#+BEGIN_EXAMPLE
<script type="text/javascript">
  (function() {
  'use strict';
  parent.jQuery(document).ready(function() {
  var backgroundAdwidth = 480; // TODO: find out the background image width
  var backgroundAdheight = 860; // TODO: find out the background image height
  var backgroundAdLeftImage = '%%VIEW_URL_UNESC%%%%FILE:JPG1%%';
  var backgroundAdRightImage = '%%VIEW_URL_UNESC%%%%FILE:JPG2%%';
  var backgroundAdLinkLeft = '%%CLICK_URL_UNESC%%%%DEST_URL%%';
  var backgroundAdLinkRight = backgroundAdLinkLeft;
  var backgroundAdMainContentDivWidth = 996;
  var backgroundAdExtraTopSpace = 100; // Set to 0 if you don't want extra top space
  parent.jQuery('body').prepend('<div id="background-ad-right"></div><div id="background-ad-left"></div>');
  var jsLink1 = "<script type='text/javascript'>" +
  "var backgroundAdwidth = " + backgroundAdwidth + ";" +
  "var backgroundAdheight = " + backgroundAdheight +";" +
  "var backgroundAdMainContentDivWidth = " + backgroundAdMainContentDivWidth + ";" +
  "var backgroundAdExtraTopSpace = " + backgroundAdExtraTopSpace + ";" +
  "</scr" + "ipt>";
  parent.jQuery('head').append(jsLink1);
  var jsLink2 = parent.jQuery("<script type='text/javascript' src='http://yours.com/js/backgroundskinad.js'>");
  parent.jQuery('head').append(jsLink2);
  var cssLink = parent.jQuery("<link rel='stylesheet' href='http://yours.com/css/media-w1200-w992.css'>");
  parent.jQuery('head').append(cssLink);
  parent.jQuery('#background-ad-left, #background-ad-right').css({
  'position': 'fixed',
  'z-index': '1',
  'cursor': 'pointer',
  'height': backgroundAdheight
  });
  parent.jQuery('#background-ad-left').css({
  'background': 'url(' + backgroundAdLeftImage + ') no-repeat right top'
  });
  parent.jQuery('#background-ad-right').css({
  'background': 'url(' + backgroundAdRightImage + ') no-repeat left top'
  });
  parent.jQuery('#background-ad-left').click(function() {
  window.open(backgroundAdLinkLeft);
  });
  parent.jQuery('#background-ad-right').click(function() {
  window.open(backgroundAdLinkRight);
  });
  });
  })();
</script>
#+END_EXAMPLE

On Web Server
backgroundskinad.js
#+BEGIN_EXAMPLE
jQuery(document).ready(function($) {
  var backgroundAdMainContentDivWidth = 996;
  var backgroundAdExtraTopSpace = 0;
  function setBackgroundAdPositionX() {
    var adPosition = new Array();
    var viewportWidth = $(window).width();
    var leftSpace = (viewportWidth-backgroundAdMainContentDivWidth)/2;
    if (leftSpace > 0) {
      if (leftSpace <= backgroundAdwidth) {
        adPosition['adWidthRealtime'] = leftSpace;
        adPosition['adHorizontalSpacing'] = 0;
      } else {
        adPosition['adWidthRealtime'] = backgroundAdwidth;
        adPosition['adHorizontalSpacing'] = leftSpace - backgroundAdwidth;
      }
    }
    else {
      adPosition['adWidthRealtime'] = 0;
      adPosition['adHorizontalSpacing'] = 0;
    }

    $('#background-ad-left').css({
      'left': adPosition['adHorizontalSpacing'],
      'width': adPosition['adWidthRealtime']
    });

    $('#background-ad-right').css({
      'right': adPosition['adHorizontalSpacing'],
      'width': adPosition['adWidthRealtime']
    });
    return adPosition;
  }

  function setBackgroundAdPositionY() {
    var topspace = backgroundAdExtraTopSpace - $(window).scrollTop();
    // nav HTML element height
    if ($('#newcom-header-masthead').length && $('#newcom-header-masthead').height()) {
      topspace += $('#newcom-header-masthead').height();
    }
    topspace = (topspace > 0) ? topspace : 0;
    $('#background-ad-left, #background-ad-right').css('top', topspace + 'px');
  }

  function wallpaperFixViewport() {
    $('.cover-slogan, .cover-logo').addClass("m-clear");
    $('#newcom-single-left').toggleClass("col-md-9 col-md-8");
    $('#newcom-single-right').toggleClass("col-md-3 col-md-4");
    $('#newcom-page-news-middle').toggleClass("col-md-7 col-md-6");
    $('#newcom-page-news-right').toggleClass("col-md-3 col-md-4");
    $('#newcom-taxonomy-videoseries-middle').toggleClass("col-md-7 col-md-6");
    $('#newcom-content-sidebar-page-left').toggleClass("col-md-9 col-md-8");
    $('#newcom-content-sidebar-page-right').toggleClass("col-md-3 col-md-4");
    $('#newcom-page-middle').toggleClass("col-md-7 col-md-6");
    $('#newcom-page-right').toggleClass("col-md-3 col-md-4");
    $('#newcom-search-middle').toggleClass("col-md-7 col-md-6");
    $('#newcom-search-right').toggleClass("col-md-3 col-md-4");

    $('div.row div.col-md-8 div.row div.col-md-3 div.well').toggleClass("pa-sm");

    $('#div-gpt-placeholder-1, #div-gpt-placeholder-2').toggleClass('center-block');

    // Enlarge column of a parent if it has a child
    var videoDiv = $( "#yourspecialchild" ).parent( ".the-content" ).parent( ".col-md-9" );
    if (videoDiv.length) {
      videoDiv.toggleClass("col-md-9 col-md-12");
      // Move
      var titleDiv = videoDiv.prev();
      if (titleDiv.length) {
        titleDiv.toggleClass("col-md-3 col-md-12");
        titleDiv.insertAfter(videoDiv);
      }
    }

  }

  function setBackgroundMobile() {
    if (typeof backgroundAdMobile300x90 !== 'undefined' && backgroundAdMobile300x90) {
      var ad = jQuery('<a href="' + backgroundAdLink +'" target="_blank"></a>').append(jQuery('<img />',{
        width: 300,
        height: 90,
        src: backgroundAdMobile300x90
      }));

      if (jQuery("#background-ad-mobile").length) {
        jQuery("#background-ad-mobile").append(ad);
      }
      else {
        var subpages = '#wrapper div.row div.col-md-8';
        if (jQuery(subpages).length) {
          var html = jQuery('<div id="background-ad-mobile"></div>').append(ad);
          jQuery(subpages).first().prepend(html);
        }
      }
    }
  }

  $(window).load(function() {
    wallpaperFixViewport();
//  setBackgroundMobile();
    setBackgroundAdPositionX();
    setBackgroundAdPositionY();
    $("#div-gpt-placeholder-0-oop").hide();
  });

  $(window).resize(function() {setBackgroundAdPositionX();});
  $(window).scroll(function() {setBackgroundAdPositionY();});

});
#+END_EXAMPLE

media-w1200-w992.css
#+BEGIN_EXAMPLE
@media (min-width:1200px){
  .col-lg-1, .col-lg-2, .col-lg-3, .col-lg-4, .col-lg-5, .col-lg-6, .col-lg-7, .col-lg-8, .col-lg-9, .col-lg-10, .col-lg-11, .col-lg-12{
    width:auto;
    float:none;
  }

  .container{
    width:990px
  }

  .col-md-1, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6, .col-md-7, .col-md-8, .col-md-9, .col-md-10, .col-md-11{
    float:left
  }

  .col-md-12{
    width:100%
  }

  .col-md-11{
    width:91.66666666666666%
  }

  .col-md-10{
    width:83.33333333333334%
  }

  .col-md-9{
    width:75%
  }

  .col-md-8{
    width:66.66666666666666%
  }

  .col-md-7{
    width:58.333333333333336%
  }

  .col-md-6{
    width:50%
  }

  .col-md-5{
    width:41.66666666666667%
  }

  .col-md-4{
    width:33.33333333333333%
  }

  .col-md-3{
    width:25%
  }

  .col-md-2{
    width:16.666666666666664%
  }

  .col-md-1{
    width:8.333333333333332%
  }

  .col-md-pull-12{
    right:100%
  }

  .col-md-pull-11{
    right:91.66666666666666%
  }

  .col-md-pull-10{
    right:83.33333333333334%
  }

  .col-md-pull-9{
    right:75%
  }

  .col-md-pull-8{
    right:66.66666666666666%
  }

  .col-md-pull-7{
    right:58.333333333333336%
  }

  .col-md-pull-6{
    right:50%
  }

  .col-md-pull-5{
    right:41.66666666666667%
  }

  .col-md-pull-4{
    right:33.33333333333333%
  }

  .col-md-pull-3{
    right:25%
  }

  .col-md-pull-2{
    right:16.666666666666664%
  }

  .col-md-pull-1{
    right:8.333333333333332%
  }

  .col-md-push-12{
    left:100%
  }

  .col-md-push-11{
    left:91.66666666666666%
  }

  .col-md-push-10{
    left:83.33333333333334%
  }

  .col-md-push-9{
    left:75%
  }

  .col-md-push-8{
    left:66.66666666666666%
  }

  .col-md-push-7{
    left:58.333333333333336%
  }

  .col-md-push-6{
    left:50%
  }

  .col-md-push-5{
    left:41.66666666666667%
  }

  .col-md-push-4{
    left:33.33333333333333%
  }

  .col-md-push-3{
    left:25%
  }

  .col-md-push-2{
    left:16.666666666666664%
  }

  .col-md-push-1{
    left:8.333333333333332%
  }

  .col-md-offset-12{
    margin-left:100%
  }

  .col-md-offset-11{
    margin-left:91.66666666666666%
  }

  .col-md-offset-10{
    margin-left:83.33333333333334%
  }

  .col-md-offset-9{
    margin-left:75%
  }

  .col-md-offset-8{
    margin-left:66.66666666666666%
  }

  .col-md-offset-7{
    margin-left:58.333333333333336%
  }

  .col-md-offset-6{
    margin-left:50%
  }

  .col-md-offset-5{
    margin-left:41.66666666666667%
  }

  .col-md-offset-4{
    margin-left:33.33333333333333%
  }

  .col-md-offset-3{
    margin-left:25%
  }

  .col-md-offset-2{
    margin-left:16.666666666666664%
  }

  .col-md-offset-1{
    margin-left:8.333333333333332%
  }
}
#+END_EXAMPLE

** Interstitial Ad
Load third party code into 1x1 floating ad unit. Insert DFP macro as a third party code first. Refer to dfp:third party code

#+BEGIN_EXAMPLE
// Outside of the div
var dfpSlots = {}; // non single request mode

googletag.cmd.push(function() {
 // non single request mode
 dfpSlots.floating = googletag.defineOutOfPageSlot('/123456/floating', 'interstitial').addService(googletag.pubads()); 

 // single request mode
 // googletag.defineOutOfPageSlot('/123456/floating', 'interstitial').addService(googletag.pubads());

 googletag.pubads().addEventListener('slotRenderEnded', function (event) {
   if (event.slot.getAdUnitPath() === '/123456/floating') {
     document.getElementById('interstitial').style.display = 'none';
   }
 });

});

<div id='interstitial'>
  <script type='text/javascript'>
    googletag.cmd.push(function() { googletag.display('interstitial'); });
  </script>
</div>
#+END_EXAMPLE

On DFP, Custom Code :: postMessage to website to create jQuery UI dialog and later receives a message to create content inside the iframe
#+BEGIN_EXAMPLE
<script type="text/javascript">
  (function() {
    'use strict';
    var temp = '%%VIEW_URL_UNESC%%'; // Custom Code requires VIEW_URL_UNESC or VIEW_URL_ESC macro..
    window.onload = function() {
      function receiveMessage(e) {
        if (e.data == 'load_interstitial_ad') {
          var html = '<div style="width:640px;height:480px;">' +
              '<script src="insert third party code"'+'>'+'</'+'script>'+
              '<noscript>' +
              '<a href="insert_third_party_code" target="_blank"><img src="insert_third_party_code" border=0 width=640 height=480></a>'+
              '</noscript>'+ 
            '</div>';
          document.write(html);
        }
      }
      window.addEventListener('message', receiveMessage);
      var sendData = {action:"dfp_load_interstitial_ad", width:"640", height:"480"};
      parent.postMessage(sendData,'*');
    }
  })();
</script>
#+END_EXAMPLE

On website :: once received message from iframe, load internal script and only load it once
#+BEGIN_EXAMPLE
var dfpInterstitial = {};
dfpInterstitial.loadCount=0;

function newcomReceiveMessage(e) {
  if (e.data == 'dfp_load_interstitial_ad' && dfpInterstitial.loadCount == 0) {
    dfpInterstitial.loadCount++;
    dfpInterstitial.width =e.data.width;
    dfpInterstitial.height =e.data.height;
    // var cssLink = parent.jQuery("<link rel='stylesheet' href='https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.2/themes/ui-lightness/jquery-ui.css'>");
    // jQuery('head').append(cssLink);

    ['//ajax.googleapis.com/ajax/libs/jqueryui/1.10.2/themes/ui-darkness/jquery-ui.css',
     '/wp-content/themes/xxx/css/interstitial.css'].forEach(function (src) {
      var _css = document.createElement("link");
      _css.rel = 'stylesheet';
      _css.type = 'text/css';
      _css.href = src;
      document.head.appendChild(_css);
    });

    [ 'https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.2/jquery-ui.min.js','/sites/all/themes/abc/js/interstitial.js'
    ].forEach(function(src) {
      var script = document.createElement('script');
      script.src = src;
      script.async = false;
      document.head.appendChild(script);
    });
    // var jsLink = jQuery("<script type='text/javascript' src='http://yourwebsite.io/interstitial.js'>");
    // jQuery('head').append(jsLink);
  }
}
window.addEventListener('message', newcomReceiveMessage, false);
#+END_EXAMPLE

On website, interstitial.js :: make ad unit div as a dialog using jQuery UI. jqueryui:dialog
jQuery UI Dialog runs script inside the container twice. The script is setup in DFP which only posts or receives message.
Even though the same message is posted twice but the dfpInterstitialCount ensures this javascript only runs once.
#+BEGIN_EXAMPLE
jQuery(function(){
  var targetDialog = '#interstitial'; // TODO
  var iframeId = jQuery(targetDialog).find('iframe').get(0).id;
  var adWidth = dfpInterstitial.width;
  var adHeight = dfpInterstitial.height;

  jQuery(targetDialog).dialog({
    width: 'auto',
    height: 'auto',
    resizable: false,
    draggable: false,
    closeOnEscape: true,
    modal: true,
    create: function (event, ui) {
      jQuery("#ui-dialog-title-dialog").hide();
      jQuery(".ui-widget-content").css({"background-color":"transparent","background":"transparent","border":"none"});
      jQuery(".ui-dialog-titlebar").css({"background-color":"transparent","background":"transparent","border":"none"});
      jQuery(".ui-dialog-titlebar").removeClass('ui-widget-header');

      // In Single Request Mode, every time .display() is called, the div will refilled with new ad
      // In Non-Single-request mode, you need to do .refresh(). 
      if (typeof dfpSlots !== "undefined" && typeof dfpSlots.floating !== "undefined") {
        googletag.cmd.push(function() {
          googletag.pubads().refresh([dfpSlots.floating]);
        });
      }
      jQuery(targetDialog).find('iframe').width(adWidth);
      jQuery(targetDialog).find('iframe').height(adHeight);
    },
    open: function() {
      jQuery('.ui-widget-overlay').addClass('custom-overlay');
      jQuery(this).closest(".ui-dialog")
        .find(".ui-dialog-titlebar-close")
        .removeClass("ui-dialog-titlebar-close")
        .html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");
      jQuery(".ui-dialog-titlebar button").css({"border":"none"});
      jQuery('.ui-widget-overlay').bind('click',function(){
        jQuery(targetDialog).dialog('close');
      })
    },
    close: function() {
      jQuery('.ui-widget-overlay').removeClass('custom-overlay');
    }
  });

  setTimeout(function () {
    jQuery(targetDialog).show();
    var receiver = document.getElementById(iframeId).contentWindow;
    receiver.postMessage('load_interstitial_ad', '*');
  }, 3000);

});
#+END_EXAMPLE

/wp-content/themes/xxx/css/interstitial.css
#+BEGIN_EXAMPLE
.ui-widget-overlay.custom-overlay {
  background-color: black;
  background-image: none;
  opacity: 0.7;
}
#+END_EXAMPLE

Interstitial as JW Player is a bit complicated. [[https://gist.github.com/levonlee/1e162c34af377d04364295d027a33c96][Gist]]

** Pre-roll or Linear Video Ad
- The ad unit should have a Video (VAST) size: 640x360v
- In the line item, select the same video size as the inventory size and also select the ad unit
- Add a new Creative Set and select Linear then Video (not VPAID) for pre-roll, mid-roll or post-roll.
- Upload the video file that a higher resolution e.g. 1920x1080. DFP will create all lower resolution videos.
- Your video creative is setup. You need to generate the tag for the ad unit.
- Use [[https://developers.google.com/interactive-media-ads/docs/sdks/html5/vastinspector][Video Suite Inspector]] to test the video ad. If the ad unit is newly created, it could take an hour to preview the video ad..
- Delivery > Troubleshoot > Video simulates the request taking under/over delivery into account.

DFP Video Tag
#+BEGIN_EXAMPLE
https://pubads.g.doubleclick.net/gampad/ads?sz=640x360&iu=/{network_id}/{VAST_code_name}&ciu_szs=640x90&impl=s&gdfp_req=1&env=vp&output=xml_vast2&unviewed_position_start=1&url=[referrer_url]&description_url=[description_url]&correlator=[timestamp]
#+END_EXAMPLE

In the tag, use JW Player Targeting Macros to add values into these url parameters:
The url of the page where the ad will appear
`&url=__page-url__`
`&correlator=__timestamp__`
`&description_url=__referrer__`

e.g. DFP tag in JW is
#+BEGIN_EXAMPLE
https://pubads.g.doubleclick.net/gampad/ads?sz=640x360&iu=/{network_id}/{VAST_code_name}&ciu_szs=640x90&impl=s&gdfp_req=1&env=vp&output=xml_vast2&unviewed_position_start=1&url=__page-url__&description_url=__referrer__&correlator=__timestamp__
#+END_EXAMPLE

In JW, specify the div id which the companion ad will be in and on the website:
#+BEGIN_EXAMPLE
<div id="newcomjwplayerbanner" style="width:640px;height:90px;margin-bottom: 10px;"></div>
<div id="newcomjwplayer">
  <script type="application/javascript" src="//content.jwplatform.com/players/{video_id}-{player_id}.js"></script>
</div>
#+END_EXAMPLE

** Native Ad, Native Styles, Custom Rendering
Custom Rendering can only be used in mobile apps.

Create a native ad format under Delivery > Creatives > Native Styles
Associate this native format with an ad unit. A native format is basically a HTML/CSS template with some placeholders
which can be later defined when you upload a creative of Native type to a line item.
Create a line item with Inventory sizes = Standard and Native format, and target the ad unit.
Upload a creative of Native type. Specify the placeholders.

** SafeFrame API
Custom creative
#+BEGIN_EXAMPLE
<div id="container">
    <script>
      function updateInViewPercentage() {
         var text = $sf.ext.inViewPercentage() + '%';
         document.getElementById('percentage').innerHTML = text;
      }

      $sf.ext.register(728, 90, function(status, data) {
        // 728,90 are inital size of the creative
        // register is needed for calling other $sf.ext.xxx
        // Do nothing. This test doesn't make use of this callback.
      });

      return false;
    };
    </script>
    <span>
        <strong>$sf.ext.inViewPercentage</strong>
    </span>
    <button onclick="updateInViewPercentage();">In view pecentage</button>
    <div id="percentage"></div>
</div>
#+END_EXAMPLE

Preview creative doesn't enable SafeFrame. The creative has to be deployed.
When console shows FriendlyFrame, it shows the container is not SafeFrame.

[[https://support.google.com/dfp_premium/answer/6023110][Other SafeFrame methods]]

** Events

#+BEGIN_EXAMPLE
googletag.pubads().addEventListener('slotRenderEnded', function (event) {
  if (event.slot.getAdUnitPath() === '/123456/adunit_name') {
    document.getElementById('div-gpt-ad-1403025754774-0-oop').style.display = 'none';
  }
});
#+END_EXAMPLE

** Google Publisher Console
To open, append to URL ?googfc=1 (display console after page is loaded)
or ?google_console (keyboard to toggle console display)
C-F10

Or make a bookmark ~javascript: googletag.openConsole();~

** Passback tag
Situation 1
1. The webpage makes a call to the DFP ad server using the DFP ad tag
2. DFP ad server returns an ad containing a third-party ad tag
3. Third-party ad tag calls the third-party ad server for an ad
4. Third-party ad server doesn't have an eligible ad, so returns a passback ad tag
5. Passback ad tag makes a call to DFP to serve an ad matching the specified targeting criteria
6. DFP server returns an ad that matches the passback ad tag targeting criteria

Situation 2
1. Passback ad tag makes a call to DFP to serve an ad matching the specified targeting criteria
2. DFP server returns an ad that matches the passback ad tag targeting criteria

** Downloaded impression
DFP provides a System Query called Downloaded Impressions to compare with the old impression counting

Ad server impressions and Impressions are the old impression counting
Ad server downloaded impressions are the new impression counting

Also now a new metric called Request Type to divide:
- Goolge Publisher Tag
- Video Tag
- GPT Simple URL
- GPT Light
- Amp Ad Tag

For Simple URL Tags, used in email, which do not allow javascript
- Use ~ad~ request type to get the image with ~&d_imp=1&d_imp_hdr=1~ appended
- Use ~adx~ request type to get the URL from http header ~google-delayed-impression~ or ~google-3rdparty-delayed-impression~
  with ~&d_imp=1&d_imp_hdr=1~ appended in the ~adx~ request
- Ping the URL
- Return or output the image as raw

Notes
- ~&d_imp=1&d_imp_hdr=1~ does not return downloaded impression tracking link from ~ad~ request
- ~adx~ does not return a useful ~img src~ because its response is supposed to put into iframe where javascript is used

Wordpress Gist
https://gist.github.com/levonlee/888f5f5b0a33acebe2b20ecbbff3b106

** Anti Adblocke
https://gist.github.com/levonlee/da658dd8d6c91f093fc90aeca4653ae7

** Benchmarks
Sizmek Benchmarks
Based on 2016 H1 report, CTR (click-through rate = clicks / impressions) is around 0.14% in North America and South Asia is the highest 0.28% for standard banner.

Rich Media CTR is around from 6 to 8 times higher than standard banner.

Programmatic Rich Media that is not confined to the iFrame performs around 145% better than polite.

Doubleclick Insights
https://www.doubleclickbygoogle.com/insights/

LiveIntent, AdButler, PowerInbox

* XML
** XML DOM
Everything is a node
nodeType :: 1 - element, 2 - attribute, 3 - text, 4 - comment, 5 - document
nodeName :: read-only, text node name is #text, document node name is #document
nodeValue :: element node value is undefined

var elements = xmlDoc.getElementByTagName("title");
console.log(elements.length);
var element = elements[0];
var elementToRemove = xmlDoc.getElementsByTagName('book')[0];
xmlDoc.documentElement.removeChild(y);
element.parentNode.removeChild(element); // remove myself

xde = xmlDoc.documentElement; 
newNode = xmlDoc.createElement('book'); // create element node
newTitle = xmlDoc.createElement('title');
newText = xmlDoc.createTextNode('A Notebook'); // create text node
newTitle.appendChild(newText); // add text node to element node
newNode.appendChild(newTitle); // add element node to element node

y = xmlDoc.getElementsByTagName('book')[0];
xde.replaceChild(newNode, y); // replace an element node
aTextNode.replaceData(0,8,"Easy"); // replace data of text node (from start to 8 in length)
// Use nodeValue, it's easier

var attributes = element.attributes;
var attribute = element.getAttribute('lang');
var attributeNode = element.getAttributeNode('lang');
attributeNode.nodeValue;
attributeNode.nodeValue = "new attribute value";
element.setAttribute('category', 'food');

element.removeAttributeNode(attributeNode); // remove an attribute node
element.removeChild("category"); // remove an attribute node by name
// remove multiple attribute nodes, you will have to loop all

var x = element.childNodes[0].nodeName;

*** Navigate
var fc = element.firstChild;
var lc = element.lastChild;
fc.parentNode;
var nc = fc.nextSibling;
nc.previousSibling;

function get_nextSibling(n) {
 // Bypass empty text node while traversing
 var y = n.nextSibling;
 while (y.nodeType != 1) {
  y = y.nextSibling;
 }
 return y;
}

** Do not parse < and &
#+BEGIN_EXAMPLE
<![CDATA
]]>
#+END_EXAMPLE

** Comment
#+BEGIN_EXAMPLE
<!-- Same as HTML but double -- is not allowed -->
#+END_EXAMPLE

** XML newline is always LF
** XML Element node name can contain -, _ and . but not space
** Attribute value should be HTML entity encoded
Mainly enocde the double quotes " to &quot;
> &gt;
< &lt;

** <<<XML namespace>>>
#+BEGIN_EXAMPLE
<root 
xmlns:h="http://www.w3.org/TR/html4/"
xmlns:f="http://www.w3schools.com/furniture">

<h:table>
  <h:tr>
    <h:td>Apples</h:td>
    <h:td>Bananas</h:td>
  </h:tr>
</h:table>

<f:table>
  <f:name>African Coffee Table</f:name>
  <f:width>80</f:width>
  <f:length>120</f:length>
</f:table>

</root>
#+END_EXAMPLE

** XSLT
XSLT stands for XSL (Extensible Stylesheet Language) Transformations
XSLT uses XPath to navigate through elements.

XSLT code
#+BEGIN_EXAMPLE
<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="/">
<!-- Associate the template with the root of the XML source document -->
<!-- A template contains rules to apply when a specified node is match -->
  <h2>My CD Collection</h2>
    <table border="1">
      <tr bgcolor="#9acd32">
        <th style="text-align:left">Title</th>
        <th style="text-align:left">Artist</th>
      </tr>
      <xsl:for-each select="catalog/cd">
<!-- for-each loop, select contains XPath expression -->
<!-- select="catelog/cd[artist='Bob Dylan']" -->
<!-- =, !-, &lt;, &gt; -->
     <xsl:sort select="artist" />
<!-- sort -->
      <tr>
        <td><xsl:value-of select="title"/></td>
        <td><xsl:value-of select="artist"/></td>
        <xsl:if test="price &gt; 10">
        <td><xsl:value-of select="price"/></td>
        </xsl:if>
<!-- choose, when, otherwise -->
       <xsl:choose>
        <xsl:when test="price &lt; 10">
         <td bgcolor=""><xsl:value-of select="price"/></td>
        </xsl:when>
        <!-- Multiple when's -->
        <xsl:otherwise>
         <td><xsl:value-of select="price"/></td>
        </xsl:otherwise>
       </xsl:choose>
<!-- choose, when, otherwise. -->
      </tr>
      </xsl:for-each>
<!-- Close a loop -->
    </table>
</xsl:template>
</xsl:stylesheet>
#+END_EXAMPLE

XML file
#+BEGIN_EXAMPLE
<?xml version="1.0" encoding="UTF-8"?>
<catalog>
  <cd>
    <title>Empire Burlesque</title>
    <artist>Bob Dylan</artist>
    <country>USA</country>
    <company>Columbia</company>
    <price>10.90</price>
    <year>1985</year>
  </cd>
  <cd>...</cd>
  ...
</catalog>
#+END_EXAMPLE

Template and subtemplates
#+BEGIN_EXAMPLE
<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="/">
 <html>
 <body>
  <xsl:apply-templates/>
 </body>
 </html>
</xsl:template>

<xsl:template match="cd">
 <p>
 <xsl:apply-templates select="title"/>
 <xsl:apply-templates select="artist"/>
 </p>
</xsl:template>

<xsl:template match="title">
 Title: <xsl:value-of select="."/>
 <br />
</xsl:template>

<xsl:template match="title">
 Artist: <xsl:value-of select="."/>
 <br />
</xsl:template>
</xsl:stylesheet>
#+END_EXAMPLE

** Invalid characters 
<<<xml:invalid_characters>>>

Characters :: &#x1F; &#x1E;

change to version 1.1 or get rid of the characters
#+BEGIN_EXAMPLE
<?xml version="1.1" encoding="UTF-8" ?>
#+END_EXAMPLE

* DevOps
Methodologies
1. People over process over tools
2. Continuous delivery
3. Lean Management
 - Work in small batches
 - Work in progress limits
 - Feedback loops
 - Visualization
4. Visible ops change control
 - Eliminate fragile artifacts
 - Crate a repeatable build process
 - Manage dependencies
 - Create an environment of continous improvement
5. Infrastructure as code
 - Systems treated like code
 - Checked into source control
 - Reviewed, built and tested
 - Managed programmatically

10 Best practices
- Chaos Moneky
- Blue/Green Deployment
- Dependency Injection
- Andon Cords (anyone can pull to stop the production line)
- The Cloud (fast API services)
- Embedded Teams
- Blameless Postmortems
 - The people whose actions have contributed to an accident can give a detailed account of 5 W's
 - And they can give this detailed account without fear of punishment
 - The detailed account gives an understanding of the mechanism, pathology, and operation of the failure
 - The account also guarantees that it will repeat
 - It's a meeting within 48 hours of the incident
 - Have a third party run it
- Public Status Page
- Developers on Call
- Incident Command System

Provision :: Making a server ready for operation, including hardware, OS, system services, network connectivity
Deployment :: automatically deploying and upgrading applications on a server
Orchestration :: performing coordinated operations across multiple systems
Configuration management :: management of change control for system configuration after initial provision; maintaining and upgrading
the application and application dependencies

Imperative/procedural :: commands necessary to produce a desired state are defined and executed
Declarative/functional :: a desired state is defined, relying on the tool to configure a system to match that state

Idempotent :: the ability to execute repeatedly, resulting in the same outcome

Self service :: the ability for an end user to initiate a process without having to go through other people

Continuous integration :: is the practice of automatically building and unit testing the entire application frequently. Ideally, every source code check in.

Continuous Delivery :: is the addtional practice of deploying every change to to a production like environment and performing automated integration and acceptance testing.

Continuous Deployment :: extends this to where every change goes through full enough automated testing.

CI Phases and corresponding tools
- Version control
- CI systems (Jenkin, CloudBees, Bamboo, CircleCI, TravisCI)
- Build (Make/Rake, Maven, Gulp)
- Test (JUnit, golint/gofmt, RuboCop, Robot, Protractor, Cucumber, Selenium, Sauce Labs, ApacheBench, JMeter, Brakeman, Veracode)
- Artifact repository (Artifactory, Nexus, Docker Hub, AWS S3)
- Deployment (Rundeck, UrbanCode, ThoughtWorks, Deployinator)

Docker Swarm, Google Kubernetes, Apache Mesos

* Tools
** phpStorm
Help > Default Keymap Reference
*** Installation and 64 bit
Just install the new version and it will guide you to uninstall and keep the settings.
For activation, choose License server, address is http://idea.lanyus.com/ 
(last time http://idea.qinxi1992.cn/)

Install Java SE Development Kit (JDK) 64 bit
Open C:\Program Files (x86)\JetBrains\PhpStorm 10.0.3\bin\PhpStorm64.exe
Help > About, you should see
JRE: amd64
JVM: 64-bit
If not, set environment variable `JAVA_HOME` to C:\Program Files\Java\jdk1.8.0_101 and restart PhpStorm64.exe
Inside PhpStorm, Help > Edit Custom VM Options 
and change `-Xms` and `-Xmx` to	`-Xms4g` and `-Xmx4g`
Restart PhpStorm64.exe and open multiple projects to test RAM.
Finally, edit the shortcut to use PhpStorm64.exe

Help > Check for Update > Change setting to don't auto check update.
You can still use it to update plugins manually in this way.

*** Change config directories
https://intellij-support.jetbrains.com/hc/en-us/articles/207240985-Changing-IDE-default-directories-used-for-config-plugins-and-caches-storage

Before doing that, export settings so that you can import them later.

Help | Edit Custom Properties…

idea.config.path=c:/work/idea/caches/trunk-config
idea.system.path=c:/work/idea/caches/trunk-system
idea.plugins.path=c:/work/idea/caches/trunk-plugins

*** Open big file
Ensure phpStorm is running in 64bit.

https://intellij-support.jetbrains.com/hc/en-us/articles/206544519
This is called idea.config.path
Create a custom idea.properties file in one these locations. This is called 
For Windows: in %USERPROFILE%\.IntelliJIdeaXX or %USERPROFILE%\.IdeaICXX,
For Windows: actually %USERPROFILE%\.PhpStorm2017.1\config
For *NIX: in ~/.IntelliJIdeaXX or ~/.IdeaICXX
For macOS: in ~/Library/Preferences/IntelliJIdeaXX or ~/Library/Preferences/IdeaICXX

Or Help > Edit Custom Properties to create it and edit

Don't change the system idea.properties at install-path/bin e.g.
#+BEGIN_EXAMPLE
# in kb
idea.max.intellisense.filesize=50000
#+END_EXAMPLE

**** Plugin: JB SDK Bintray Downloader
Install JetBrains Plugin
Find Action > Get JB SDK
Select the most recent version to download and then install: e.g. jbsdk8u152b941_windows_x64.tar.gz
%USERPROFILE%\.PhpStorm2017.1\config\jdks\ holds JB SDK libraries downloaded using the plugin

About should show
JRE: 1.8.0_152-release-b941 amd64
JVM: OpenJDK 64-Bit Server VM by JetBrains s.r.o

Find Action > Switch IDE Boot SDK to switch between installed runtimes. Always use the JetBrains version.

*** Find file
Navigate > File
Find directory: ~name/~ or ~name\~

Find file
CamelHumps :: ~sap~ matches ~StrangeAnimalPage.html~
snake_case :: ~s a p~ matches ~strange_animal_page.html~
Files in nested directories :: ~a/a/s a p~ matches ~calendar\Animals\Animaux\StrangeAnimalPage.html~ and ~strange_animal_page.html~ in the same folder
e.g. for Drupal, ~s/a/m/custom/*.md~ matches ~sites/all/modules/custom/*.md~ files

*** HTML (CSS and Javascript)
**** Show Applied Styles
Right click on element and select _Show Applied Sytles for Tag_

**** CSS vendor prefix
e.g. all vendor prefixes for box-sizing. Type -box-sizing and hit tab.
 
*** Regex Find
Find function name that contains =_node_=
~function[\s+].*_node~

*** XPath
You need to make the xml file part of a project to use Evaluate XPath... (right click) 

*** Emmet
**** How it works
snippets.json store something like "m": "margin:|;"
**** CSS
***** margin (m), color (c), border (bd)
m10 TAB for margin: 10px;
m10-20 TAB for margin: 10px 20px;
m-10--20 TAB for margin: -10px -20px;
m1.5 TAB for margin: 1.5em;
m1.5rem TAB for margin: 1.5rem;
m10p30e5x TAB for margin: 10% 30em 5ex;

p :: percentage
e :: em
x :: ex

/Color/
c#fc0

/border/
border
bd5#0s

s :: solid 

*** Show unprintable characters (TAB)
Find Action (Ctrl+Shift+A) > search Show Whitespaces

*** Convert to Tab/Spaces for indentation
Find Action > To Tab

*** Surround with Live Template
Select a text abc and wrap it into a function call

Settings > Live Templates > under user, +, Live Template >
Abbreviation :: lifc
Description :: Surround with function call
Template text :: ~$END$($SELECTION$)~
Context :: Everywhere

Then select the text, Surround with

*** Custom code folding regions
Select the block of code you want to fold
C-M-t or "surround with"
Choose either NetBeans style or VisualStudio style. Don't mix 2 styles.

*** Multiple cursors
Alt and click to create a cursor. Esc to reduce to only one cursor

*** MySQL
When there're multiple statements (multiple ;), Ctrl + Enter (or to Execute from Menu) prompts a list of statements to run:
- Smallest statement. 
  - The smallest of the possible statements is executed. For example, when the cursor is inside a subquery, the subquery is executed.
- Largest statement. 
  - The largest possible statement is executed. 
  - e.g., when the cursor is inside a subquery, an outer statement is executed.
- Largest statement or batch. 
  - For Transact-SQL (SQL Server and Sybase), the current batch of statements is executed. For all other dialects - the same as the previous option.
- Whole script. All the statements are executed. (This item always appears and always appear last)

You can also Ctrl + A to select all statements and Ctrl + Enter to run all of them.

*** Return all query results
Click on the Wrench icon on the toolbar of the Database Console tool window.
Switch to Database | Data Views page, specify 0 in the Result set page size field, and click OK.
Default is 500.

That way you can export all rows to csv file.

*** nodejs <<<phpstorm:nodejs>>>
Enable ES6 for Settings > Languages & Frameworks > Javascript > JavaScript language version > ECMAScript 6
Install plugin NodeJS, restart phpStorm after Node and NPM are installed on Windows. 
Enable ~Node.js Core library~ in Settings > Languages & Frameworks > Node.js and NPM
Node interpreter looks like ~C:\Program Files\nodejs\node.exe~

*** Golang Plugin <<<phpstorm:golang>>>
Search for Go, install plugin and restart phpStorm
Setup SDK, which is c:\go

*** Makefile support plugin
*** Docker support
In Docker for Windows > Settings > General
Choose Expose daemon on tcp://localhost:2375 without TLS

In phpStorm, Settings > Build, Execution, Deployment > Docker, create Docker with a + button.

Default should work, so just OK

API URL: tcp://localhost:2375
Certificates folder: blank
Docker Compose executable: docker-compose
VirtualBox shared folders: VM Path - /c/Users, Local path - C:\Users
 
You should see Docker under the bottom bar, select and connect to it. Now you should see the running containers and available images.

*** Vue.js
JetBrains plugin repository

** Emacs
*** Install & Configuration
Download for Windows https://ftp.gnu.org/pub/gnu/emacs/windows/
This version: emacs-24.5-bin-i686-mingw32.zip
Extract it to C:\emacs, so you will have C:\emacs\emacs-24.5-bin-i686-mingw32\
Make a shortcut of this file /bin/runemacs.exe and copy to your notes folder say C:\c\notes\
Then right click, select Properties of the shortcut and change the ~Start In~ to =C:\c\notes= 
Set a HOME user environment variable in Windows as ~C:\c\notes~
Include a file ~.emacs~ in ~C:\c\notes~ 
Your home folder in Emacs is ~C:\c\notes~
~/.emacs 
~(setq org-catch-invisible-edits 'smart)~

**** M-x
| customize-themes | Load a theme |
|                  |              |

*** Basics
#+NAME: tab:emacs-basics
| Help             |                                               |
|------------------+-----------------------------------------------|
| C-h f            | Search by command, get shortcut               |
| C-h v            | Get variable value                            |
|                  |                                               |
| File             |                                               |
|------------------+-----------------------------------------------|
| C-x C-s          | Save                                          |
| C-x C-c          | quit emacs                                    |
| C-x C-f          | Open file, Create file                        |
|                  |                                               |
| Editing          |                                               |
|------------------+-----------------------------------------------|
| _underlined_     |                                               |
| ~verbatim~       |                                               |
| =verbatim=       |                                               |
| +strike_through+ |                                               |
| /Italics/        |                                               |
| C-c .            | Insert timestamp                              |
|                  |                                               |
| C-k              | Remove line, Delete Line                      |
| C-x u            | Undo                                          |
| C-a              | Beginning of line                             |
| C-e              | End of line                                   |
| C-h k            | Explain what key-combo will do                |
| C-S-Bksp         | Kill whole line                               |
| C-x u            | undo                                          |
|                  |                                               |
| <q               | =#+BEGIN_QUOTE=                               |
| <H               | =#+BEGIN_HTML=                                |
| <c               | =#+BEGIN_CENTER=                              |
| <e               | =#+BEGIN_EXAMPLE=                             |
| c-c ;            | =#+BEGIN_COMMENT=                             |
|                  |                                               |
| Headline         |                                               |
|------------------+-----------------------------------------------|
| TAB              | Local tree fold/unfold                        |
| C-u TAB          | Global tree fold/unfold                       |
| C-u C-u C-u TAB  | Show all                                      |
|                  |                                               |
| Table            | <<<emacs:table>>>                             |
|------------------+-----------------------------------------------|
| C-c -            | Insert a horizontal line below                |
| M-S-<down>       | Insert a new row above                        |
| C-c <RET>        | Insert horizontal line and a new row below    |
| M-S-<up>         | Delete a current row                          |
|                  |                                               |
| M-S-<right>      | Insert new column on the right                |
| M-S-<left>       | Delete current column                         |
|                  |                                               |
| C-c <SPC>        | Blank current field                           |
| C-c `            | Edit current field                            |
|                  |                                               |
| S-<TAB>          | Move to previous field                        |
| M-<up>/<down>    | Move a row                                    |
| M-<left>/<right> | Move a column                                 |
|                  |                                               |
| C-c \vert{}      | After text is selected, convert to table      |
|                  |                                               |
| Moving           |                                               |
|------------------+-----------------------------------------------|
| C-l              | Scroll current line to center                 |
| C-x b            | switch to another buffer                      |
| M-<              | Move to beginning of buffer                   |
| M->              | Move to end of buffer                         |
| M-g M-g          | Go to a line                                  |
| C-c C-j          | org-goto. Search in headlines only            |
|                  |                                               |
| Windows          |                                               |
|------------------+-----------------------------------------------|
| C-x 0            | remove current window                         |
| C-x 1            | Close all other windows; Or close help window |
| C-x 2            | Split horizontally                            |
| C-x 3            | split vertically                              |
| C-x o            | move to other window                          |
|                  |                                               |
| Regions          | (selection)                                   |
|------------------+-----------------------------------------------|
| C-space          | Start region, then move cursor to select      |
| C-x h            | Copy all in buffer                            |
| C-g              | deactive mark                                 |
|                  |                                               |
| Kill & Copy      |                                               |
|------------------+-----------------------------------------------|
| C-w              | kill region (cut)                             |
| M-w              | copy to kill-ring (shared with other buffers) |
| C-y              | yank                                          |
|                  |                                               |
| Search           |                                               |
|------------------+-----------------------------------------------|
| C-s, C-r         | search string, forward/backward               |
| Return           | quit searching                                |
| M-C-s            | forward regex search                          |
| M-C-r            | backward regex search                         |
|                  |                                               |

*** Headline <<<emacs:headline>>>
| C-u TAB          | Global tree fold/unfold             |
| C-u C-u C-u TAB  | Show all                            |
|                  |                                     |
| C-c C-n          | Next heading                        |
| C-c C-p          | Previous heading                    |
| C-c C-f          | Next heading same level             |
| C-c C-b          | Previous heading same level         |
|                  |                                     |
| C-c C-u          | Backward to higher level heading    |
|                  |                                     |
| M-S-<right>      | Increase heading level of an item   |
|                  | and its child items                 |
| M-S-<left>       | Same as above but decrease          |
|                  |                                     |
| M-<right>/<left> | Decrease/increase level of a        |
|                  | parent item only                    |
|                  |                                     |
| S-<TAB>          | In table, go to previous cell       |
|                  | In other places, global fold/unfold |
|                  |                                     |

C-x n s :: Work on one section
C-x n w :: Back to outline

C-c C-j :: jump to different heading. C-g to exit. up/down to move headline, ~/~ sparse-tree search

M-<RET> or C-<RET> :: insert heading

**** Drawer
C-c C-x d :: Create a drawer

:MYDRAWER: 
This is inside the drawer

:END:

*** Symbol and Escape <<<emacs:escape>>>

#+BEGIN_EXAMPLE
\vert{}
which escapes |
#+END_EXAMPLE

[[http://orgmode.org/worg/org-symbols.html][Table of Symbols]]

Insert a tab character =Ctrl+q tab=

*** =TODO=
#+BEGIN_EXAMPLE
=** TODO=
#+END_EXAMPLE
S-left/right :: Cycle through *TODO*, *DONE* and empty.

*** Sparse Tree, Search
C-c / r :: Search regex, C-c C-c to quit.
M-g M-n :: Next match
M-g M-p :: Previous match

*** Link <<<emacs:link>>>
[[http://orgmode.org/manual/Link-format.html#Link-format][Here's description of the link]]

| C-c C-l | add or modify link                             |
|         | Or cusor to the right of end and hit BACKSPACE |
|---------+------------------------------------------------|
| C-c &   | Go back to previous position                   |
| C-c C-c | Update radio targets                           |

#+BEGIN_EXAMPLE
=[[My Target]]= 
By defalt, it leads to a text search
#+END_EXAMPLE

#+BEGIN_EXAMPLE
[[Link]] "Link" matches an exact headline
#+END_EXAMPLE

#+BEGIN_EXAMPLE
Something is referred to later in the file <<internal target>>
[[internal target]] will go to the target
#+END_EXAMPLE

#+NAME: Table One
| a  | table      |
|----+------------|
| of | four cells |
|----+------------|

#+BEGIN_EXAMPLE
Go to a named section [[Table One]]
#+END_EXAMPLE

<<<emacs:radio>>>
#+BEGIN_EXAMPLE
<<<Radio target>>>
This causes each occurence of 'Radio target' in normal text to become activated as a link
Emacs only update radio targets when the file is first loaded. To manual update, C-c C-c
#+END_EXAMPLE

** Chrome
*** Command Menu (DevTools > C+S P)
**** Coverage (Show coverage)
*** Capture full size screenshot
F12, mobile view, click on the top right tool button of the main website window

*** Block Request or Domain
Block a certain file request or any files from a domain. Network > right click on a file and Block Request

*** Get all events of an element in Console
getEventListeners($0);

*** Inject CSS file in Console
=jQuery(document.head).append('<link rel="stylesheet" href="path_to_my_css">');=

*** Flash Couldn't Load Plugin
Properites > Security, give Full Control for Everyone in this folder
C:\Users\you\AppData\Local\Google\Chrome\User Data\PepperFlash\some.version.number

*** Allow XMLHttpRequest for local files
#+BEGIN_EXAMPLE
chrome.exe --allow-file-access-from-files
#+END_EXAMPLE

*** Allow CORS locally
May need to close all Chrome instances. Mine opens the Chromium version not the regular Chrome.
#+BEGIN_EXAMPLE
chrome.exe --disable-web-security --user-data-dir
#+END_EXAMPLE

*** XPath <<<XPath>>>
In DevTools > Elements, search using Xpath, e.g. find all h4 element //h4
[[http://www.freeformatter.com/xpath-tester.html][xPath Online tools]]
| /nodename/               | select all nodes with name                                                        |
| ~/~                      | select from the root node                                                         |
| //                       | select nodes from the current node that match the select no matter where they are |
| .                        | select the current node                                                           |
| ..                       | select the parent of the current node                                             |
| @                        | select attribute                                                                  |
|                          |                                                                                   |
| store/book[1]            | first book element                                                                |
| store/book[last()]       | last book element                                                                 |
| store/book[last()-1]     |                                                                                   |
| store/book[position()<3] | first 2 book elements                                                             |
| store/book[price>35.00]  | all book elements that have price element with a value greater than 35.00         |
| store/book/title[@lang]  | lang attributes of all title elements in book elements                            |
|                          |                                                                                   |
| ~*~                      | match any element node                                                            |
| @*                       | match any attribute node. Have at least one attribute                             |
|                          |                                                                                   |

Select multiple paths
//book/title | //book/price

**** Axis Syntax
axisname::nodetest[predicate]

axisname is the relationship name
- self
- child
etc.

nodetest is a node name to test

| child::book     | book nodes that are children of the current node |
| attribute::lang | lang attribute of the current node               |
| child::*        | children elements of the current node            |
| child::text()   | text node of the current node                    |
| child::node()   |                                                  |

**** XPath Operators
+ - * div
mod (division remainder) :: 5 mod 2 
=|= combine 2 node-sets
= != < <= > >=
or :: price=9.8 or price=9.7
and

*** Extension - Google Tag Assistant
*** Extension - [[https://chrome.google.com/webstore/detail/postman/fhbjgbiflinjbdggehcddcbncdddomop?utm_source%3Dchrome-app-launcher-info-dialog][Postman]]
Fire GET and POST requests.
For POST request, insert data in Body and change Header > Content-Type to application/x-www-form-urlencoded; charset=UTF-8

*** Flush DNS Caches in Chrome
Even ipconfig /flushdns is run, Chrome still caches the DNS
Navigate to ~chrome://net-internals/#dns~ and press "Clear host cache" button

** Firefox
*** Make all new windows open in Private Mode
- Visit about:config and click "Yes, I'll be careful"
- Search for =browser.privatebrowsing.autostart=
- Change value to True

** Windows
*** Win 7
Install KB3138612 and KB3145739 to boost Windows Update

*** Win 10
**** Boot to Safe Mode with Boot Options Menu
Start Menu > Power > hold Shift and click Restart
Or use command line where you need to wait 1 minute ~shutdown.exe /r /o~

**** Install a printer loop in "Type a printer name"
Run ~bcdedit.exe /set nointegritychecks on~ and restart Windows 10 to disable the driver signature enforcement
Or Shift click on Power > Restart, choose Troubleshoot > Startup Settings > Restart, after restart choose F7 to disable driver signature enforcement

**** Windows version Run `winver`
Windows 10, version 1607 also known as the Anniversary Update
1703 Windows 10 Creators Update

**** Upgrade from Windows 7
Make sure to do all critical and optional Windows Updates to ensure all drivers are up-to-date.
Use Lenovo System Update to update all drivers and BIOS.
If you experience black or blank screen during reboot to install Win 10, 
go to BIOS and change Display setting to Integrated (disable Discrete). Reboot and do the upgrade again.

**** Ubuntu Bash on Windows
Turn on Developer Mode
You need to have Win 10 Anniverary Update, Creators Update is recommended.
Make sure OS Build is not below 14393 
Win + X > Settings > System > About
Win + X > Settings > Update and Security > For developers > Developer Mode

Enable Windows Subsystem for Linux feature
Search Windows Features > turn on Windows Subsystem for Linux (beta)

Reboot then open a command prompt, run ~bash~ and type ~y~ to install Ubuntu on Windows.
If you see "Unsupported console settings", right click on the cmd top bar > Properties > uncheck Use legacy console
Windows 10 has a new cmd prompt.
Create a UNIX user and password which have no relationship to Windows username and password
The user will be added to sudo group and will signed-in automatically every Bash instance.

A Bash session with Windows admin privileges (run cmd as admin) may ~cd /mnt/c/Users/Administrator~
which is a directory restricted by Windows.
While a Bash session without admin privileges would see Permission Denied.

Ubuntu is installed at ~%localappdata%\lxss\~, don't modify files using Windows tools and apps here!

Mount /mnt/c or /mnt/e is drive C: and E:. Store files in any mount and modify files using Windows or Linux apps.
It's not possible to modify file permissions under /mnt/(your_drive)/. scp from here to remote will have files/directories full permission! Change those on remote host after scp..

You can copy remote files to any places other than /mnt/(your_drive). But don't open these files using Windows apps!
Permissions can be playe around in any places other than /mnt/(your_drive)

**** Win 10 Build Update History
https://support.microsoft.com/en-us/help/4018124/windows-10-update-history

**** Startup Programs and Change HOMEDRIVE, HOMEPATH
Run ~shell:startup~ to find out the folder and copy shortucts of programs
That will return the startup folder for your user account only.
To find out the startup folder for all users, run ~shell:common startup~

Active Directory might override some environment variables such as ~HOMEDRIVE~ ~HOMEPATH~
Create a batch file C:\Windows\System32\userinit.cmd
#+BEGIN_EXAMPLE
@ECHO OFF
SET HOMEDRIVE=C:
SET HOMEPATH=\Users\%USERNAME%
SET HOMESHARE=\\localhost\C$\Users\%USERNAME%
@START C:\Windows\system32\userinit.exe
#+END_EXAMPLE

Set the registry key ~HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit~ to 'C:\Windows\System32\userinit.cmd,'
Userinit default value is 'C:\Windows\system32\userinit.exe,'

*** Win Server 2003
**** System Information
run ~winmsd.exe~ and look for processor to find out the bit count

**** Update_Windows.exe error
It consumes a lot of CPU and slows down the server. 2017/07/07. It's a hack..
[[https://answers.microsoft.com/en-us/windows/forum/windows_other-performance/server-2003-updatewindowsexe/974869b1-712c-438d-98ea-1dd935d359bc][Solution]]: Go to C:\Windows\Debug, Tools > Folder Options > View > Uncheck Hide Protected Operating System Files
The batch files are referring to bitcoin mining website.. 
Ctrl+Alt+Del > Task Manager to stop Update_Windows.exe, then delete Update_Windows.exe, debug.exe, debug.bat, dll.bat

*** PowerSehll
**** Get-Command - gcm
Get manual of a command e.g. Select-String
#+BEGIN_EXAMPLE
gcm Select-String | select -expand definition
#+END_EXAMPLE

**** Search text in files
#+BEGIN_EXAMPLE
Get-ChildItem -Path "C:\path" -recurse | Select-String -Pattern "find me" | group path | select -Unique name

# dir is an alias of Get-ChildItem, sls is an alias of Select-String
# Since -Path and -Pattern are the default parameters in Get-ChildItem and Select-String, they can be omitted
Get-ChildItem "c:\path" -recurse | Select-String "find me" | group path | select -unique name

# current directory is ".\"

# Exclude some binary files by file extension so that it runs faster
dir ".\" -recurse -Exclude *jpg, *jpeg, *png, *pdf | sls "<body>" | group path | select -unique name

# also exclude a folder, ? is alias of where
dir ".\" -recurse -Exclude *jpg, *jpeg, *png, *pdf | ?{ $_.FullName -NotLike "C:\fullpath\.git\*" } | sls "<body>" | group path | select -unique name

# exclude multiple sub folders
dir ".\" -recurse -Exclude *jpg, *jpeg, *png, *pdf, *.mp4, *.ogv, *.webm, *pdf, *.png, *.svg, *.otf, *.eot, *.woff, *.ttf | ?{ $_.FullName -NotLike "C:\fullpath\.git\*" -and $_.FullName -NotLike "C:\fullpath\abc\*" } | sls "<body>" | group path | select -unique name

# test dir without sls first to make sure you have the right "where" clause
#+END_EXAMPLE

**** Create script file
create C:\test.ps1
Run it
#+BEGIN_EXAMPLE
& "C:\test.ps1"
#+END_EXAMPLE

Pass parameters, always use param in the first line in the relevant scope
#+BEGIN_EXAMPLE
---- Begin script foo.ps1 ----
param([string]$foo = "foo", [string]$bar = "bar")
Write-Host "Arg: $foo"
Write-Host "Arg: $bar"
----  End script foo.ps1  ----
PS C:\> .\foo.ps1 -foo "foo" -bar "bar"
Arg: foo
Arg: bar
#+END_EXAMPLE

Function
#+BEGIN_EXAMPLE
function foo([string]$foo = "foo", [string]$bar = "bar")
{
  Write-Host "Arg: $foo";
  Write-Host "Arg: $bar";
}

function foo()
{
  param([string]$foo = "foo", [string]$bar = "bar");
  Write-Host "Arg: $foo";
  Write-Host "Arg: $bar";
}
#+END_EXAMPLE

Scriptblocks
#+BEGIN_EXAMPLE
PS C:\>& {param([string]$foo = "foo", [string]$bar = "bar") Write-Host "Arg: $foo"; Write-Host "Arg: $bar"; }
Arg: foo
Arg: bar
#+END_EXAMPLE

*** Wireless hotspot
Tested with Win10
First, check if wireless adapter supports ~Hosted Network supported: Yes~
#+BEGIN_EXAMPLE
netsh wlan show drivers
# Create a wireless Hosted Network
netsh wlan set hostednetwork mode=allow ssid=WindowsCentral key="yourkey"
# Start the newly created Microsoft Hosted Virtual Adapter
netsh wlan start hostednetwork  
#+END_EXAMPLE

WinKey + x and select Network Connections, select any network adapter (LAN or wireless) currently have an internet connection,
Properties > Sharing > Allow ohter network users to connect through this computer's Internet connection > Home networking connection select the newly created "Local Area Connection* 13 (or other numbers)"

Start and stop the Microsoft Hosted Virtual Adapter
#+BEGIN_EXAMPLE
netsh wlan stop hostednetwork
netsh wlan start hostednetwork
netsh wlan set hostednetwork mode=disallow
netsh wlan set hostednetwork mode=allow
#+END_EXAMPLE

Change setting
#+BEGIN_EXAMPLE
netsh wlan set hostednetwork ssid=Your_New_SSID
netsh wlan set hostednetwork key="abc"
# View
netsh wlan show hostednetwork
netsh wlan show hostednetwork setting=security
#+END_EXAMPLE

It's not easy to delete the hostednetwork setting
HKEY_LOCAL_MACHINE\system\currentcontrolset\services\wlansvc\parameters\hostednetworksettings
Right-click the HostedNetworkSettings DWORD key, select Delete, and click Yes to confirm deletion.
Reboot

*** Windows Virtual PC
Install XP Mode on Windows 10 Pro and only Pro version can install
- Google Windows XP Mode and download the en-us version
- Enable Hyper-V in BIOS
- In Win 10, run optionalfeatures.exe to go to Windows Features, enable all Hyper-V. Restart Windows
- Control Panel > Admin Tools > Hyper-V manager
- Download 7-Zip. Choose 64-bit if Win is 64.
- Extract the downloaded XP mode file, go to folder Sources and find xpm file. right click and choose 7-zip > Open archive
- Find ~VirtualXPVHD~, extract it and rename to ~VirtualXPVHD.vhd~ file
- Open Hyper-V Manager, go to Virtual Switch Manage to create a Virtual Switch
  - Type External, use default for others so that VM can use internet
- In Hyper-V Manager, select the one and only local virtualization server on the left pane.
- Action > New > Virtual Machine
  - Specify a name
  - Use Generation 1
  - RAM should 512MB or 1024MB
  - Select a Virutal Switch
  - Select an existing Virtual Hard Disk
  - Next, Finish
- On the right pane in Hyper-V Manager, click Connect then Start
- Set Region and Time
- License is required..
- Turn off Windows Update. Expect to see some driver installation failed
- Most likely, internet doesn't work. Turn off VM. 
  - Settings > Add Hardware > Legacy Network Adapter
  - Choose the Virtual Switch, Apply. Start VM

*** Find physical path by shared path
On server, run ~net share~

*** Process Monitor procmon.exe
To troubleshoot a process, e.g. OUTLOOK.EXE
Filter > Filter, or Ctrl+L, add Process Name is not OUTLOOK.exe Exclude, Apply
Tools > Count Occurrences > Column: Result, double click on each Result to filter events

*** Dosbox
http://www.dosbox.com/download.php?main=1

This is to run old DOS programs.
Double click to install to C:\DOSBox
Put all your old DOS programs to, e.g. C:\OLDGAMES

Then go to cmd, run C:\DOSBox\dosbox.exe

#+BEGIN_EXAMPLE
Z:\>MOUNT C C:\OLDGAMES
Z:\>C:
C:\>run your dos commands!
#+END_EXAMPLE

To automate the mount commands, double click on DOSBox-v-numberConfiguration, and a dosbox.conf text file pops up.
Add these 2 under [autoexec]
#+BEGIN_EXAMPLE
[autoexec]
MOUNT C C:\CT
C:
#+END_EXAMPLE

*** Batch Script
F7 in command prompt to review command history for the current window

**** Setting
Usually at the top of a .bat file. @ in front makes the command apply to itself only
@echo off :: turn off output of the command itself

**** Comment
Rem Your comment in one line

*** FART
<<<windows:FART>>> [[http://fart-it.sourceforge.net/][Download]]
Replace text in files
Replace original_text with new_text for all files
fart.exe -i -r "C:\Dir\To\Files\*.txt" original_text new_text

Remove original_text for all files under current folder
fart.exe -i -r --remove *.txt "original text"

Say you want to remove double quotes. You will need to escape " with \"
And you need to use -C for using \, \t, \n etc.
fart -i -C --remove *.txt "\""

- -i :: case insensitive
- -w :: whole word
- -r :: recursive
- -f :: Find and replace filename instead of contents
- -B :: Also find and replace in binary files
- -p :: preview. no action

I realize fart sometimes cannot find files.. Use Linux

*** Windows Credential Store Panel
<<<Windows Credential Store Panel>>>
User Accounts > Your Account > Manage your credentials
Or Credential Manager
Instead of Web Credentials, choose Windows Credentials

OneNote needs a password to sync this notebook. Delete any records MicrosoftOffice15_Data:Live:cid=some set of numbers
Which have no username and restart OneNote.

*** MAC address
~getmac /v /fo list~

*** Meter an Ethernet Connection
Run regedit: HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\NetworkList\DefaultMediaCost
Right click on the key > Permissions > Advanced > ~Change~ next to Owner on the top 
Type ~Administrators~ and Check Names
Check the box next to *Replace owner on subcontainers and objects* and click *OK*
Back in the *Permissions for DefaultMediaCost* window, click *Administrators* to select the group
Assign *Full Control Allow*, then *OK*
Right click /DefaultMediaCost > Ethernet/ and /Modify/
Change from 1 to 2 for metered (DWORD 32-bit, Base Hexadecimal)
 
*** Troubleshoot "Installation Directory must be on a local hard drive"
Install .msi using admin privilege
Shift+Right Click on the msi file and select copy path
Open cmd run as admin and run: =msiexec /i "the path"=

** Exchange Online, Office 365
*** Shared Mailbox
Shared mailbox doesn't require a license and quota is 50gb each. If it exceeds the quota, it will be locked.

After it's added from Admin, user has to restart Outlook in order to see the shared mailbox. 
It takes one hour for new members to see the new shared mailbox.

**** Open Shared Mailbox in OWA
Click on your picture and select Open another mailbox
Type the shared mailbox name

**** Add Alias and Move Messages
Add secondary email address to a shared mailbox and then setup Rules to that shared mailbox
Logon to OWA and open the shared mailbox primary email address
Gear > Options > Mail > Automatic processing > Inbox rules
Say the primary email is: abc@abc.com and a secondary email is: xyz@abc.com
You want to move emails sent to xyz@abc.com to a sub folder in the shared mailbox.
You need to use ~it includes these words in the message header = xyz@abc.com~

**** Add Members
A new member by default has full access:
Read, manage, and send as (send as the mailbox email address).

** SharePoint
Site collection can have multiple subsites.
Each site collection must have one top-level site.
Defautl site collection and top-level site: yourcompany.sharepoint.com
The default Team Site (yourcompany.sharepoint.com/TeamSite) is a top-site of the defautl site collection 

See all site collections, Sharepoint admin center > site collections

Manage subsites and top-level site, go to one of the subsites and then click on Site Settings
or go to the top-level site then Site Settings

*** Site Permissions
3 core default SharePoint permission groups: Owners, Members, Visitors.

You can add "Everyone except external" to a group. 

Site Settings > People and Groups > Select the desired group > New

** Office 2016
*** One-time-purchase Office License
Enter product key on a hard copy (card) on office.com/myaccount, get a digital product key.

To find out the digital product key of Office which is one-time-purchase.

[[https://support.office.com/en-us/article/Manage-multiple-one-time-purchase-Office-installs-that-use-the-same-Microsoft-account-b2897d43-9ec1-4040-9cf0-2bafa416e071?ui%3Den-US&rs%3Den-US&ad%3DUS&fromAR%3D1][Detailed Instructions]]

Office 2016 32-bit on Win 64-bit
cscript "C:\Program Files (x86)\Microsoft Office\Office16\OSPP.VBS" /dstatus 

Office 2016 64-bit on Win 64-bit
cscript "C:\Program Files\Microsoft Office\Office16\OSPP.VBS" /dstatus

Office 2013 32-bit on Win 64-bit
cscript "C:\Program Files (x86)\Microsoft Office\Office15\OSPP.VBS" /dstatus

Office 2013 64-bit on Win 64-bit
cscript "C:\Program Files\Microsoft Office\Office15\OSPP.VBS" /dstatus

*** Outlook
**** Export Contacts as CSV and Reimport to Outlook 
There's no option in Outlook for Mac to export contacts as CSV. OWA exports contacts without Company field.
First, go to Outlook for Mac, select all contacts and drag them to a folder as VCF files.
Open cmd on Windows, go to the folder with VCF files and run =copy /B *.vcf all_in_one.vcf=
Use vCard to [[http://labs.brotherli.ch/vcfconvert][LDIF/CSV Converter]] to convert all_in_one.vcf to CSV
Open the csv in Excel and Save as CSV so that file uses CR+LF
Go to OWA, delete all contacts
Always use PC Outlook to import CSV. OWA barely functions.

**** Import Contacts
Import from .pst file handles the field mapping automatically.
Import from .csv you would need to Clear Map and Default Map.

**** Rules: Multiple Senders
Create a new contact folder and put contacts with emails.
Create a rule which can be triggered when anyone in the contact folder belongs to "From"
The rule is called "Sender is in specified Address Book"

**** Rebuild OST
Make a copy of the .ost file before delete. Then open Outlook again.
If you can't copy/delete .ost file, close Outlook, Skype for Business and Office applications.

**** Rebuild .srs file
When rules don't work automatically but work manually, you should rename your-profile-name.srs at
C:\Users\%username%\AppData\Roaming\Microsoft\Outlook

**** Outlook for Mac
***** Troubleshooting
Sorry, we're having server problems, so we can't add Office 365 SharePoint right now. Please try again later.

- Quit all Outlook and Office apps
- Spotlight search and open KeyChain Access
- Under Keychains > login on the right, delete all of these search results
  - Exchange
  - Office
  - ADAL
- Launch Outlook

*** OneNote
OneNote sync issue or remove crendentials. Refer to Windows Credential Store Panel

Move a OneOnte on SharePoint to personal OneDrive
- Export the whole Notebook to a local .onepkg file
- Open the .onepkg file and then File > Share > Move Notebook (you may need to Add a Place first)

Ctrl + M to open another OneNote window

*** Troubleshooting
**** Outlook CSV Import 
A file error has occured in the Comma Separated Values translator while initializing a translator to build a field map.
That's because the CSV file does not use CR+LF. Open it in Excel and Save As

** Jira
*** Story
In an agile framework, user stories are the smallest units of work.
User stories are sketched out by the product owner, and then the entire product team collectively determins detailed requirements.
As a {type of user}, I want {goal} so that I {receive benefit}.

*** Kanban board
Board Setting > Setup Kanban backlog
Assign status (To Do, In Progress, In Review, Done, etc.) to Kanban backlog
Number of cards (issues) can be controlled for each column (In Progress, Done)

Setup priorities of issues as swimlanes

Reports: Control Chart, Cumulative Flow Diagram

** YouTrack
*** Default field: State
Settings > Custom Fields Settings > Fields List > State
See which values are considered as Resolved, others are Unresolved.
Use this as a query keyword #resolved or #unresolved

** Image
*** Sample Image
http://placehold.it/350x150

http://via.placeholder.com/300x250/?text=hello+world

http://via.placeholder.com/300/ffffff/000000/?text=hello+world

Hex, first is background color and then text color

http://via.placeholder.com/300/ffffff/?text=hello+world

Auto text color

*** Convert image to favicon (.ico)
https://converticon.com/

*** Image Stock
https://www.freeimages.com/
http://publicdomainarchive.com/
https://unsplash.com/
Vintage http://nos.twnsnd.co/

Paid https://www.stocksy.com/

** Website Status
StatusCake - Free

** Website Security, Testing
[[https://www.qualys.com/][Qualys]] :: vulnerability test

HTML link to another domain with target="_blank", better add this so that window.opener object doesn't exist on the new page in new tab.
#+BEGIN_EXAMPLE
<a href="anotherdomain.gg" target="_blank" rel="noopener">...</a>
#+END_EXAMPLE

** WCAG, AODA, Web Content Accessibility Guidelines
SortSite by powermapper

Keyboard accessbile for non link elements and non form elements
#+BEGIN_EXAMPLE
<div onclick="doSumat();" onkeypress="doSumat();" tabindex="">
#+END_EXAMPLE

<iframe title="" style="border:0px;">

frameborder="0" is obsolete.

if <input> has no <label>, then add title attribute

PDF and Office documents need to set Title, Advanced > Language in Document Properties

PDF and Office document image has to have title attribute.

Acrobat DC :: Edit > Manage Tools > add Accessibility to the right pane

Accessibility > Full Check > Click on items need alternate text to find on page and then doubleclick to select and then right click Tag as Figure

Accessibility > Autotag Document will retag the whole document. The best approach is to add tag to image/figure because autotag might add links wrong based on text context. Do this:

Accessbility > Reading Order > Show Order Panel. Right click on the figure and Tag

Add Adobe Reader download link
http://www.adobe.com/ca/legal/permissions/icons-web-logos.html#adobereader

#+BEGIN_EXAMPLE
<a href="http://www.adobe.com/go/getreader" target="_blank"><img src="get-reader-158x39.png" alt="Get Adobe Reader DC"></a>
#+END_EXAMPLE

PDF/UA-1 compliance. PDF needs to have this XMP metadata to mark it as PDF/UA-1 compliant.
Tools > Print Production > Preflight, choose PDF Standards or Acrobat Pro DC 2015 Profiles as profile, choose the wrench tool icon (Select single fixups), expand to Document info and Metadata and choose Set PDF/UA-1 entry and then Fix.

meta viewport

Skip to content link, right below <body>
#+BEGIN_EXAMPLE
<a id="skip-nav" href="#main-content">Skip to content</a>
<div id="main-content"></div>
#skip-nav {
  position: absolute;
  top: -1000px;
  left: -1000px;
  height: 1px;
  width: 1px;
  text-align: left;
  overflow: hidden;
}
#skip-nav:active,
#skip-nav:focus,
#skip-nav:hover {
  width: auto;
  height: auto;
  position:static;
  overflow: visible;
}
#+END_EXAMPLE

Color Contrast Ratio
WCAG 2.0 level AA requires a contrast ratio of 4.5:1 for normal text and 3:1 for large text. Level AAA requires a contrast ratio of 7:1 for normal text and 4.5:1 for large text.
https://webaim.org/resources/contrastchecker/
http://leaverou.github.io/contrast-ratio/

** Screencast + Audio
[[https://getsharex.com/][ShareX]] Download the portable version, Task Settings > Capture > Screen recorder > Screen recording options...
Click Download to download the latest FFmpeg.exe
Under Sources, hit Refresh until you see the right Audio source.
Then go back to UI, Capture > Screen recording

** Video
*** Youtube Download
http://www.clipconverter.cc

*** Kodi
**** Settings
- Display Chinese characters, you need to go to 
Settings > Appearance > Fonts > Arial based

- Add apps to Homepage e.g. Video 
Settings > Appearance > Settings > Add-on

**** File Manager
- https://aznhusband.github.io/ App: icdrama

- http://fusion.tvaddons.ag/
Install from zip file
Folder xbmc-repos > english > 
	- repository.exodus-1.0.1.zip (Exodus repository)
	- repository.xbmchub-1.0.6.zip (TVADDONS.ag Addon Repository)
	- chinese-repository.kodi-addons-chinese-1.0.2.zip (Kodi Add-ons of Chinese)
	- chinese-repository.kodi-repo.zip (Joname's repo)
	- chinese-repository.xbmc-addons-chinese-1.2.0.zip (Chinese Add-ons repository)

- http://srp.nu
Install from zip file
Folder isengard > all > superrepo.kodi.isengard.all-0.7.04.zip (Superrepo All repository)

**** Addons
Video
Exodus (Exodus Artwork) Use Torba, Putlocker as the video sources (Exodus repository)
Phoenix (TVADDONS.ag Addon Repository)git s
icdrama.se (Superrepo All repository)
azdrama.net (Superrepo All repository)

Subtitle
163sub (Chinese Add-ons repository)
Sub HD (Chinese Add-ons repository)
subom (Chinese Add-ons repository)

zimuku (Chinese Add-ons repository)

** Google
*** Google Public DNS
8.8.8.8
8.8.4.4
*** Google S2
Get favicon of any website
http://www.google.com/s2/favicons?domain=http://superuser.com/

*** Google Material Icons
https://material.io/icons/

Use it as font:
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<i class="material-icons md-18">face</i>
// font-size: 18px
// md-dark, md-light
// md-inactive

It has svg!

*** Google reCaptcha
https://developers.google.com/recaptcha/intro

**** Client - Basic
#+BEGIN_EXAMPLE
<html>
  <head>
    <title>reCAPTCHA demo: Simple page</title>
     <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  </head>
  <body>
    <form action="?" method="POST">
      <div class="g-recaptcha" data-sitekey="your_site_key"></div>
      <br/>
      <input type="submit" value="Submit">
    </form>
  </body>
</html>
#+END_EXAMPLE

**** Client - Defer loading, explict rendering one widget/instance
#+BEGIN_EXAMPLE
<script type="text/javascript">
  var onloadCallback = function() {
    alert("grecaptcha is ready!");
    grecaptch.render('html_element', {
      'sitekey' : 'your_site_key'
    });
  };
</script>

<form action="?" method="POST">
      <div id="html_element"></div>
      <br>
      <input type="submit" value="Submit">
</form>

<script src="https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit"
        async defer>
</script>
#+END_EXAMPLE

**** Client - Multiple reCaptcha widgets/instance
#+BEGIN_EXAMPLE
<html>
  <head>
    <title>reCAPTCHA demo: Explicit render for multiple widgets</title>
    <script type="text/javascript">
      var verifyCallback = function(response) {
        alert(response);
      };
      var widgetId1;
      var widgetId2;
      var onloadCallback = function() {
        // Renders the HTML element with id 'example1' as a reCAPTCHA widget.
        // The id of the reCAPTCHA widget is assigned to 'widgetId1'.
        widgetId1 = grecaptcha.render('example1', {
          'sitekey' : 'your_site_key',
          'theme' : 'light'
        });
        widgetId2 = grecaptcha.render(document.getElementById('example2'), {
          'sitekey' : 'your_site_key'
        });
        grecaptcha.render('example3', {
          'sitekey' : 'your_site_key',
          'callback' : verifyCallback,
          'theme' : 'dark'
        });
      };
    </script>
  </head>
  <body>
    <!-- The g-recaptcha-response string displays in an alert message upon submit. -->
    <form action="javascript:alert(grecaptcha.getResponse(widgetId1));">
      <div id="example1"></div>
      <br>
      <input type="submit" value="getResponse">
    </form>
    <br>
    <!-- Resets reCAPTCHA widgetId2 upon submit. -->
    <form action="javascript:grecaptcha.reset(widgetId2);">
      <div id="example2"></div>
      <br>
      <input type="submit" value="reset">
    </form>
    <br>
    <!-- POSTs back to the page's URL upon submit with a g-recaptcha-response POST parameter. -->
    <form action="?" method="POST">
      <div id="example3"></div>
      <br>
      <input type="submit" value="Submit">
    </form>
    <script src="https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit"
        async defer>
    </script>
  </body>
</html>
#+END_EXAMPLE

**** api.js options
| onload |                    | Optional. The name of your callback function to be executed once all the dependencies have loaded. |
| render | explict onload     | Optional. Whether to render the widget explicitly.                                                 |
|        |                    | Defaults to onload, which will render the widget in the first g-recaptcha tag it finds.            |
| hl     | See language codes | Optional. Forces the widget to render in a specific language.                                      |
|        |                    | Auto-detects the user's language if unspecified.                                                   |

**** class="g-recaptcha" tag attributes
| tag attribute         | grecaptcha.render parameter | Value   | Default | Description                                 |
| data-sitekey          | sitekey                     |         |         | Your sitekey.                               |
| data-theme            | theme                       | dark    | light   | Optional. Color                             |
|                       |                             | light   |         |                                             |
| data-type             | type                        | audio   | image   | Optional.                                   |
|                       |                             | image   |         |                                             |
| data-size             | size                        | compact | normal  | Optional.                                   |
|                       |                             | normal  |         |                                             |
| data-tabindex         | tabindex                    |         | 0       | Optional.                                   |
| data-callback         | callback                    |         |         | Optional.                                   |
|                       |                             |         |         | To execute when the user submits            |
|                       |                             |         |         | a successful response: g-recaptcha-response |
| data-expired-callback | expired-callback            |         |         | Optional.                                   |
|                       |                             |         |         | To execute when recaptcha response expires  |
|                       |                             |         |         | and the user needs to solve a new CAPTCHA   |

**** JavaScript API
***** grecaptcha.render(container,parameters)	
Renders the container as a reCAPTCHA widget and returns the ID of the newly created widget.
container :: The HTML element to render the reCAPTCHA widget.  Specify either the ID of the container (string) or the DOM element itself.
parameters :: An object containing parameters as key=value pairs, for example, {"sitekey": "your_site_key", "theme": "light"}. See grecaptcha.render parameters.

***** grecaptcha.reset(opt_widget_id)	
Resets the reCAPTCHA widget.
opt_widget_id
  Optional widget ID, defaults to the first widget created if unspecified.

***** grecaptcha.getResponse(opt_widget_id)
Gets the response for the reCAPTCHA widget.
opt_widget_id
  Optional widget ID, defaults to the first widget created if unspecified.

**** Server Validation
For web users, a new field (g-recaptcha-response) will be populated in HTML and you can get the user’s response in one of three ways:

1. g-recaptcha-response POST parameter when the user submits the form on your site
2. grecaptcha.getResponse(opt_widget_id) after the user completes the CAPTCHA challenge
3. As a string argument to your callback function if data-callback is specified in either the g-recaptcha tag attribute or the callback parameter in the grecaptcha.render method

URL: https://www.google.com/recaptcha/api/siteverify
METHOD: POST

Parameters
secret :: Required. The shared key between your site and reCAPTCHA.
response :: Required. The user response token provided by reCAPTCHA, verifying the user on your site.
remoteip :: Optional. The user's IP address.

API Response
#+BEGIN_EXAMPLE
{
  "success": true|false,
  "challenge_ts": timestamp,  // timestamp of the challenge load (ISO format yyyy-MM-dd'T'HH:mm:ssZZ)
  "hostname": string,         // the hostname of the site where the reCAPTCHA was solved
  "error-codes": [...]        // optional
}
#+END_EXAMPLE

Error codes
missing-input-secret :: The secret parameter is missing.
invalid-input-secret :: The secret parameter is invalid or malformed.
missing-input-response :: The response parameter is missing.
invalid-input-response :: The response parameter is invalid or malformed.
bad-request :: The request is invalid or malformed.

PHP
#+BEGIN_EXAMPLE
  private function validateReCaptcha() {
    if (!isset($_POST['g-recaptcha-response']))
      return FALSE;
    $C_CAPTCHA                = $_POST['g-recaptcha-response'];
    $C_CAPTCHA_google_request = [
      'url'     => 'https://www.google.com/recaptcha/api/siteverify',
      'options' => [
        'secret'   => 'your-key',
        'response' => $C_CAPTCHA,
      ],
    ];

    $ch      = curl_init();
    $options = [
      CURLOPT_URL            => $C_CAPTCHA_google_request['url'],
      CURLOPT_POSTFIELDS     => http_build_query($C_CAPTCHA_google_request['options']),
      CURLOPT_FOLLOWLOCATION => 1,
      CURLOPT_HEADER         => 0,
      CURLOPT_RETURNTRANSFER => 1,
    ];
    curl_setopt_array($ch, $options);
    $C_CAPTCHA_google_result = json_decode(curl_exec($ch), TRUE);
    curl_close($ch);

    if (is_array($C_CAPTCHA_google_result) && $C_CAPTCHA_google_result['success'] === TRUE) {
      return TRUE;
    }
  }
#+END_EXAMPLE

**** CSS
The button might be too large for width < 320px
#+BEGIN_EXAMPLE
@media only screen and (max-width: 320px) {
  .g-recaptcha {
    transform:scale(0.77);
    -webkit-transform:scale(0.77);
    transform-origin:0 0;
    -webkit-transform-origin:0 0;
  }
}
#+END_EXAMPLE

*** Google Search - Advanced
https://bynd.com/news-ideas/google-advanced-search-comprehensive-list-google-search-operators/

*** Gmail
Use Gmail SMTP to send emails

Turn off 2-Step-Verification or use the [[https://support.google.com/accounts/answer/185833?hl%3Den][App Password]]. 

If you can't setup App Password, it's because 2-Step-Verification is not turned on.

In that case, [[https://support.google.com/accounts/answer/6010255?hl%3Den][Let less secure apps use your account]].

Which is here: https://myaccount.google.com/lesssecureapps

** Translation
<<<tool:Poedit>>>
Open .pot and .po files in [[https://poedit.net/][Poedit]]

[[https://localise.biz/free/poeditor][Online Editor]]. Send .po file to customer who will translate online and they can save and send back the translated .po!

** HTML Minimizer, document.write
Online minimizer
- http://www.willpeavy.com/minifier/
- https://www.textfixer.com/html/compress-html-compression.php
- http://htmlcompressor.com/compressor/

Node.js minimizer
- https://www.npmjs.com/package/html-minifier

<<<tool:html:document.write>>>
Online convert a single line html to document.write
- http://accessify.com/tools-and-wizards/developer-tools/html-javascript-convertor/
- http://www.andrewdavidson.com/convert-html-to-javascript/

document.write("string") where string has to escape:
- double quotes ~\"~
- backward slash ~\\~
- forward slash ~\/~ as "</tag>" causes an error

Use document.write is not a good idea and the usage will be blocked only when all the following conditions are met:

- The user is experiencing a very poor network connectivity,
- The script is parser-blocking (neither async nor defer attributes) and is not already in the browser cache,
- The instruction is added in the top level document (e.g. iframes won’t be concerned),

Use e.innerHTML('') to insert elements, refer to js:external script to load javascript

** Email
*** SendGrid
You can create website specific users who can use to authenticate SMTP and API.
Sign to main account and go to Settings > Credentials

Add a header X-SMTPAPI as JSON to assign category shown on SendGrid.com Stats and Activity
Drupal way =$message['header']['X-SMTPAPI'] = '{"category": ["fromwebsiteA"]}' =

- Drupal
Use the SMTP Authentication Support module (smtp) and go to /admin/config/system/smtp to config
Install Options - turn this module on
SMTP server: smtp.sendgrid.net
SMTP port: 465 (587 is being used...)
Use encripted protocol: Use SSL
- Wordpress
Install plugin [[https://wordpress.org/plugins/sendgrid-email-delivery-simplifiedd][SendGrid]]

**** Whitelabel
2 types of whitelabel: domain and email link.
- Domain whitelabel 
adds a SPF (Sender Policy Framework) record to your domain and DKIM (DomainKeys Indentified Mail) entries,
which authorizes and authenticates SendGrid sending on behalf of your domain. It basically removes "sent on behalf of SendGrid" or "via"
message that some email providers dispaly.

The sent domain is the domain of the email address from "From".

Usually, you need to create one subdomain per main domain. e.g. delivery.yourdomain.com

With Automated Security checked, SendGrid will show you to create 3 CNAME records for your DNS registrar.

Some DNS registrar might not support _ in subdomains. In this case, don't check Automated Security.

Without Automated Security checked, 1 MX and 2 TXT records are provided from SendGrid.

- Email link whitelabel 
adds a CNAME record for a a subdomain that you choose, which masks click and open-tracking links to your domain 
rather than a SendGrid domain. e.g. In email body there's a link yourdomain.com. Before email link whitelabel is setup,
the sent out email with this link changed to SendGrid domain. After whitelabel is setup, this link is changed to yourchoice.yourdomain.com

This subdomain has to be different from the Domain whitelable subdomain.

SendGrid will show you 2 CNAMES per subdomain setup.

*** Send test HTML email for free
https://htmlmail.pro/ use your Gmail to send HTML emails.

** E-commerce
*** Chase E-xact Gateway
Chase Paymentech

Chase Payment Gateway
Test mode form goes to https://rpm.demo.e-xact.com/payment
Normal mode form goes to https://checkout.e-xact.com/payment

Payment Page Settings
General
	Return to Your Site URL is hard coded. It's shown when a user comes to Payment Page and sees a Return to Website if the user doesn't want to proceed. And it also serves as a go back link when timeout happens.
Receipt Page
	AUTO-POST, AUTO-GET don't display a receipt on Chase Payment Gateway but instead post the transcaction result to your website
	POST, GET display a receipt on chase Payment Gateway and a button including a link to GET or POST back to your website.
	Unfortunately, this link cannot be dynamic.
	
	Relay Response
	Transaction result is POST to your site and your site responds with HTML which E-xact later displays. The response is usually a custom receipt. If response is not received in 25 seconds, E-xact will display its own receipt.
	You can give a dynamic relay response url in the submit form rather than a static url setup in E-xact Payment Page setting page. The form field is x_relay_url
	If replay response is required, in submit form you should add a hidden form field
	<input name="x_relay_response" value="TRUE" type="hidden">
	Silent Post
	Same as replay response but the response is ignored. The sequence of silent post and relay response is not guaranteed!

Chase Payment Gateway Form
Create a Payment Page and you will get transaction_key, page_id, response_key

Do not expose transaction_key, page_id, response_key!!

Form field for submit (required fields)
x_login :: page_id
x_invoice_num :: your internal order id $order_number
x_fp_sequence :: Random number e.g. your internal order id. $order_number
x_fp_timestamp :: Requests expire after 15 minutes. Time in seconds. php :: time(). $x_fp_timestamp
x_amount :: positive number. $x_amount
x_fp_hash :: string. 
	HMAC-MD5 hash from the transaction_key and concatenation of the values for x_login, x_fp_sequence, x_fp_timestamp, x_amount and (if given) x_currency_code. Separated by ^.
	php : 
	hash_hmac('MD5', 
	$page_id. '^' . $order_number. '^' . $x_fp_timestamp. '^' . $x_amount. '^CAD'
	, $transaction_key);
x_show_form :: 'PAYMENT_FORM', constant

Post back data and fields
https://hostedcheckout.zendesk.com/hc/en-us/articles/114094066114#10.1
x_response_code
	1 for approved, 2 for process but not approved, 3 for not processed including cancel
	
x_response_reason_code
	1 for approved, 2 for declined, 3 for error
x_response_reason_text

x_invoice_num :: the same as x_fp_sequence in TandT case
x_fp_sequence

x_test_request
	boolean. If it's in test mode, true
exact_ctr
	string. Receipt string. Successful or failed, always return a string. Always show!
exact_issname
	string. Issuing Bank name
exact_issconf
	string. Issuing Bank Confirmation Number
x_fp_timestamp
x_MD5_Hash

You need to validate the post back value if 
$_POST['x_MD5_Hash'] == md5($response_key. $_POST['x_login'] . $_POST['x_trans_id'] . $_POST['x_amount']);

** W3C
<<<W3C>>>
- Working Draft
- Last Call
- Candidate Recommenation (CR, Standard)
- Proposed Recommendation (PR)
- Recommendation (REC)

** Adobe Creative Cloud
If you have error 146 and an app update failed, you might need to reinstall Creative Cloud Desktop App and then update individual app.

** Adobe Photoshop
*** Image Resize
- Preserve Details (enlargement)
- Bicubic Smoother (enlargement)
- Bicubic Sharper (reduction)

** Adobe Illustrator
*** Setting
Preferences > General > enable Scale Strokes & Effects

Control Panel > Document Setup
When nothing is selected, on the top below menu, you will see a Control Panel.
Document Setup can set Units and Bleed.

~View > Smart Guides~ Show Smart Guides (alignment suggestion)
~View > Show Grid~ Show grids inside and outside artboards

*** Panels, Workspace, Artboard
Add extra panels ~Window Menu~
- Align along with Transform and Pathfinder
- Info without Navigator
- Type > Character panel

Default Panels
**** Layers Panel
- Change path color
- Template and Dim images to
  - That layer has raster images. Used as a background to draw vector path on top of it
- Move objects inside or to a different layer

**** Artboards Panel, Artboard Tool ~Shift + O~
  - Change canvas size, orientation and other settings which you see when creating a document
  - May also change the current artboard in the Artboard Tool
  - Export individual artboard to different file format File > Export > Export for Screens
  - Show Center Mark (center point)

Save as a new workspace. Reset to default workspace.

*** Hand, Zoom, Screen mode, View, Rulers, Guides
Hand Tool ~H~ or ~Spacebar~ to temporary change to hand tool

Zoom tool (z)
- ~Alt + Click~ zoom out
- ~Ctrl + 0~ view whole or double click on hand tool
- ~Ctrl + 1~ view at 100% or double click on zoom tool

Cycle through screen modes for presentation ~F~

A View is a view which shows a portion with correct zoom and boundaries.

View Menu > Create a new view

Show Rulers ~Ctrl + R~
- Drag from one ruler to create a guide line
- Or double click on the ruler to create a guide
- Lock Guides in View Menu >  Guides > Lock Guides
- Draw a shape and make it guides :: View > Guides > Make Guides

*** Repeat the previous action
~Ctrl + D~ e.g.
- Duplicate an object after Alt + Drag
- after scaling with the Copy action.

*** Move, Select
Shift + Arrow :: move 10px

Ctrol + click on an object :: temporary select an object
Ctrol + Drag :: temporary select multiple objects

*** Pencil and Brush tools
Free hand draw.
Pencil Tool (N) can only apply regular stroke.
Double click on the Pencil Tool on the left to changeL
- smoothness
- Closing path pixel amount

When about to close the path, hold down Alt. When you see a circle in the cursor, release the mouse.
The path will be closed.

Redraw part of the path to reshape part of the path

Brush (B) is the same as pencil but can add pattern and image in path.
- Window > Brush

*** Basic Shapes
**** Line, arc, spiral, rectangular grids, polar grid
In the left menu 
- line (\)
- arc
- spiral (Shift, Up and Down to increase # of rings )
- rectangular grids
- polar grid

**** Rectangle, Ellipse
In the left menu
- Rectangle tool (M)
- Rounded Rectangle Tool 
- Ellipse tool (L) :: 
- Polygon Tool :: Up or Down to change the number of sides
- Star Tool :: Up or Down to change the number of angles.
- Flare Tool

For any shape tool
- ~Alt + Click~ to draw a new shape with the same center point of another shape
- ~Ctrl + Drag~ to make the shape fatter or skinnier.

*** Drawing Modes
Shift + D :: change drawing mode: normal, behind, inside

*** Transform Object
**** Change Anchor Points or Control Handles
Direct Selection Tool ~A~
- ~Alt + Drag~ on anchor point to change only on one side

**** Group, Ungroup Objects, Isolation mode, Lasso Tool
- ~Ctrol + G~ Group multiple objects
- ~Shift + Ctrol + G~ Ungroup
Isolation mode: Double click on a group to go to sub group

Lasso Tool ~Q~
- Manual select multiple objects and then group them.

**** Duplicate Object
Alt + Drag :: with ~Shift~ to duplicate it horizontally or vertically
Repeat the previous action ~Ctrl + D~

**** Offset an object
Offset anchor points to create another object
Object > Offset Path

**** Scale, Shear
Scale Tool ~S~. Double click to scale numerically.
May also change the reference point to scale to withtout Double click.

Shear Tool. Double click to shear numerically.

**** Rotate and Reflect Object
Rotation Tool ~R~
Choose another reference point to rotate
~Alt + Drag~ while rotating and release will make a copy after rotation
Then may repeat the action to make several copies ~Ctrl + D~

Reflect Tool ~O~ Symmetry
When the tool is selected, the reference point by default is the center point.
Change the reference point and then drag.
Use ~Shift~ to rotate vertically or horizontally
Hold down ~Alt~ while drag and then release to copy the reflection object

May also right click on the object, select Transform > Reflect and select copy. Later move that object in place

**** Free Transform Tool
Mouse operations only ~E~
Rotate, scale, change aspect ratio

**** Transform Each
Object Menu > Transform > Transform Each ~Ctrl + Alt + Shift + D~

Transform based on one of the 9 points. 

*** Fill and Stroke
Default Fill and Stroke ~D~
No fill ~\~
Select multiple objects, press ~I~, then select a color. All objects will be filled in that color.

**** Gradient
Select an object, go to Window > Gradient, select a Type.

On the left menu, select Gradient Tool ~G~, then draw line inside the object.

May apply gradients to both stroke and fill for an object.

**** Stroke
Show outline only ~Ctrl+Y~
Click on Stroke on the top menu (Control Panel), when a path/object is selected.

May change the width of a stroke partially or dynamically using Width Tool ~Shift + W~

*** Color, Swatch
**** Color Setting
Edit > Color Settings
North America General Purpose 2
RGB: sRGB IEC61966-2.1
CMYK: US Web Coated SWOP v2
Choose Preserve for RGB and CMYK
Enable all Ask When Opening, Ask When Pasting

**** Process, Global, Spot Color
Process color means that color only applies to an object. 
Changing that process color only changes color of that object.
Changing a global color means all objects using that global color will change color.

To create a global color
Open Window > Swatches
Apply a color for an object. Select or create a group. New Swatch, select Global

Spot color is usually provided by a vendor/company which, for example, provides specific ink.
To further ensure the spot color is always accurate on finished products (e.g. prints).

**** Import Export Swatch
.ase file. Window > Swatches

*** Appearance
Window > Appearance
Add overall effects on all objects or on a specific object
Change attributes: Stroke, Fill, Opacity
May stack stroke and fill effects.
May use pattern in Fill 
Add Live Effects (fx) or Effect (top menu): Drop Shadow, Warp etc.
Save appearances as graphic styles
Select an object with some Appearances, then open Window > Graphic Styles, create new
Apply that new Graphic Style on another object in the same .ai file.
In the Graphic Styles window, Select unused graphic styles, and remove.
Save the rest Graphic Styles, and hit Save Graphic Styles as Library.
Open a new ai file, in the Graphic Styles Window, load User Defined.
Then you can apply the Graphic Style across ai files.

*** Complex Shapes, Compound Path, Pathfinder, Shape Builder
Compound Path
- 2 Paths: Inner and outer circles
- Select both paths and Ctrl+8 to make a compound path
- Later double click on the compound path, inner circle can be resized!

Pathfinder
- Window > Pathfinder. You can't change the paths after it's applied
- Shape modes: the result is a single path of the end shape
  - Unite
  - Minus Front :: Back path mius front path. Punch a front path hole in back path.
  - Intersect
  - Exclude :: Front + Back - intersect
- Pathfinders mode: the result is a bunch of paths that form the end shape
  - Divide :: Front + Back but with shapes cut at any intersection
  - Trim
  - Merge
  - Crop
  - Outline
  - Minus Back 

Shape Builder
- Left menu: Shift + M
- Result is like Pathfinder's Pathfinders mode.
- Select both paths and draw straight line to indicate which area should bring front
- Draw straight line while holding ~Alt~ is to subtract

*** Eraser
Eraser fixes path around edges. Shift + E
[ or ] to increase the size

Make sure to select a path then erase. Otherwise all paths will be erased.

*** Pen Tool
Pen Tool ~P~
- Point, click and move to create straight line
- ~Alt + Drag~ to bend any path at any point
- Draw curve line with Pen Tool
  - Start point: Click and drag to the direction that the curve starts
  - End point: click and drag to the opposite direction that the curve ends
  - Change handle pdirection of an anchor point
    - Direct Selection Tool ~A~ and change the handle direction
  - Remove "whip": remove the handle of an anchor point
    - ~Alt + Click~ on the anchor point
- No fill or fill none ~\~ when necessary
- Direct Select Tool ~A~ to change anchor points and handles

Add Anchor Point Tool ~+~
Delete Anchor Point Tool ~-~
Anchor Point Tool ~Shift + C~
- Turn a point into anchor point (no handle, angle)
- ~Click + Drag~ to create 2 handles

*** Type Tool
~T~
Convert between Point Type and Area Type ~Type > Convert to Point Type~
- Point Type :: one line. It scales when it's resized
- Area Type :: Fit text into a box. It doesn't scale when it's resized

Panels
- Window > Character
  - Character, Paragraph, OpenType
- Window > Character Styles
  - Used to save Character or Paragraph styles defined above
  - Character Styles, Paragraph Styles

Wrap text around an object
- Select the object that text should wrap around
- Object > Text Wrap > Make
- ~Object > Text Wrap > Text Wrap Options~ to change the offset
- Right click on the same object, Arrange > Bring to Front

Type on a Path Tool
- e.g. curve path

Change Font Size Shortcuts
- ~shift + ctrl + > or <~ 2 points at a time
- ~shift + alt + ctrl + > or <~ 10 points at a time

Change Tracking of Font (horizontal space between characters)
- ~opt + right or left arrow~

Paragraph spacing ~opt + up or down arrow~

Adobe Typekit :: Sync Fonts with local Desktop as long as Creative Clouds are installed locally

Turn Type into Paths ~Type > Create Outlines~

*** Copy from InDesign
- Select objects in InDesign and paste in AI.
- View > Outline, you will clipping mask. Get rid of it!
- Object > Clipping Mask > Release
- Select the outest outline and delete it.
- View > Preview to turn off Outline view.

*** Resize canvas to selection
Object > Artboards > Fit to Selected Art

*** Raster Image
Place an image ~File > Place~
The image is linked from Illustrator to the image file.
Illustrator can see any changes on the image file. 

Links Panel ~Window > Links~

Embed and Unembed (relink)

Clipping Mask
- Draw a circle shape on top of the image
- Select both the circle and the image
- ~Object > Clipping Mask > Make~ or right click ~Make Clipping Mask~
- Double click to change the circle or image
- Later right click on the image, ~Release clipping mask~ to remove the circle mask

Image Trace
Select the image, ~Window > Image Trace~

Convert Image Tracing to Paths
Select the Image Tracing object and ~Object > Expand~ or ~Expand~ in the top Image Tracing control panel
Once expanded, image cannot be traced again.

*** Crop image
You CAN crop raster images in Illustrator.

Draw a rectangle above the raster image.
Select both the rectangle and the image
choose Object > Clipping Mask > Make.
change blending mode to "darken" from transparency tab
choose Object > Flatten Transparency..> OK
Choose Object > Expand...
Now you have trimmed raster object.

*** Export Assets
Window > Asset Export.
Add objects one by one to Asset Export

*** Export SVG
Select the object on the artboard then ~File > Save As > svg~
Turn font into path :: Select all text > Type > Create Outlines

CS6 
- ~Save As~ all objects on one or multiple artboards.
- Can't ~Export~ selection or Export multiple artboards
- The artboard size is the viewport size in SVG

CC version
- All or selected artboards can be Exported as SVG.
- Selected objects can be exported separately using ~File > Export Selection~
- Add an object as Asset and Export Asset
- Copy the object and paste in Dreamweaver!

SVG Profile :: SVG 1.1
Fonts. 
- Type: SVG. If there's small text, use Convert to Outline which converts all Type to paths
- Subsetting: None
- Image Location :: Embed. Usually don't include raster image in SVG
- Don't check ~Preserve Illustrator Editing Capabilities~ because it increases file size

Styling :: Inline Style or Presentation Attributes
Font :: Convert to Outlines
Images :: Preserve
Minify but not Responsive

*** Scripts
Save script file in C:\Program Files (x86)\Adobe\Adobe Illustrator CS6\Presets\en_US\Scripts\

Restart AI and the script can be executed under File > Scripts >

** Adobe Color CC
https://color.adobe.com/create/color-wheel/
https://www.lynda.com/Creative-Cloud-tutorials/Kuler-Essential-Training/136175-2.html

Analogous
Create variants of the Base color which is always the center point. 
All 5 colors have the same saturation but differ in hue.

Monochormatic
Same Hue value, but different saturation and brightness values.

Triad
Create contrast colors.

Complementary
Opposite colors.

Compound
2 sets of opposite colors and for each set create another analogous color

Shades
Only different in brightness.

Use Mobile App: Adobe Capture to capture colors.

** Training
*** Microsoft Virtual Academy MVA
Free https://mva.microsoft.com
Put in the Exam code, e.g. 70-480 to get free training resources
*** Microsoft Certification exam list
https://www.microsoft.com/en-us/learning/exam-list.aspx

*** Microsoft Certification List and Study Group
[[https://borntolearn.mslearn.net/certification][A list of certifications and exams required for each certification]]
[[https://borntolearn.mslearn.net/certification/developer][Study group for each exam and certification]]

*** Microsoft Online Proctored Exams
https://www.microsoft.com/en-us/learning/online-proctored-exams.aspx
Install the software and do a hardware test.
Sign in http://microsoft.com/learning to take an exam half an hour early
Click "Your benefits & exams" then "Start a previously scheduled online proctored exam"

** Work Ethics
*** Remove Credentials
- Windows Credential Store Panel
- Chrome
- Git remove remotes ~git remote rm abc~ this also deletes all branches of the remote
- ~/.ssh/config
- rm -rf /mnt/e/li/
- phpStorm remove all projects

** TeamViewer
1）完整卸载并删除现有TeamViewer安装过的版本
2）删除：%AppData%\Teamviewer、%tmp%\TeamViewer
3）删除：C:\Users\Administrator\AppData\Local\TeamViewer
4）删除：HKCU\Software\TeamViewer、HKLM\SOFTWARE\TeamViewer
5）下载Teamviewer对应版本，安装方式选个人非商业用途，然后打补丁即可！

如果想让破解补丁用于便携版，可装一次安装版，然后打完补丁后把下面三个文件：
TeamViewer.exe、TeamViewer_Service.exe、TeamViewer_Desktop.exe 
复制出来替换到便携版即可！

http://www.zdfans.com/6351.html

** Font
Install OTF (OpenType Font) over TTF (TrueType Font).

For web, always include WOFF (Web Open Font Format), then TTF then OTF. WOFF is good for SEO

As you can see OTF is newer and based on TTF but it's much smaller.

TTF rendered in different devices has non-equal pixels.

*** Google Font (GF)
Can be downloaded and installed on Desktop as .ttf and for website .woff or .woff2

#+BEGIN_EXAMPLE
# subset / scripts, Latin subset is always included if available and need not be specified.
<link rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Roboto+Mono&subset=greek">

# Multiple fonts
https://fonts.googleapis.com/css?family=Tangerine|Inconsolata|Droid+Sans

# Multiple styles/wegihts (,)
https://fonts.googleapis.com/css?family=Tangerine:bold,bolditalic|Inconsolata:italic|Droid+Sans

http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,300italic,400italic,600italic
#+END_EXAMPLE

text with url encoded value
#+BEGIN_EXAMPLE
https://fonts.googleapis.com/css?family=Inconsolata&text=Hello%20World
#+END_EXAMPLE

[[https://developers.google.com/fonts/docs/getting_started#enabling_font_effects_beta][effect]]
#+BEGIN_EXAMPLE
https://fonts.googleapis.com/css?family=Rancho&effect=shadow-multiple

// font-effect- class prefix
<div class="font-effect-shadow-multiple">This is a font effect!<div>
#+END_EXAMPLE

*** Open source alternative, identify font
http://alternatype.net/

Identify font: https://www.whatfontis.com/

*** Monoid
https://github.com/JB-Dmitry/monoid

*** Hasklig
https://github.com/i-tu/Hasklig Extend Source Code Pro

*** Poppin, GF
*** Museo, GF
*** Roboto Slab, GF
* TODO Inspectlet.com
* TODO QUnit
* TODO Lynda Bootstrap Layout Responsive Single-Page Design
* TODO Lynda Bootstrap 3: Advanced Web Development
* TODO Learn Continuous Integration "Pantheon Build Drupal with Composer on Travis"
* TODO Learn SPF and whitelabel
* TODO Learn tool Zeplin
* TODO Blowfish hashing algorithm using random salt which is stored in db
* TODO Learn ARIA html:ARIA
* TODO Lynda Web Project Workflows with Gulp.js, Git, and Browserify
* TODO Lynda Agile Project Management
* TODO Lynda Javascript: Enhancing the DOM
* TODO Lynda Firebase, Travis CI, Heroku
* TODO Lynda: Foundations of Programming: Object-Oriented Design
* TODO JavaScript HTML5 Animation Framework: GSAP or Tween https://greensock.com/
* TODO Lynda: MVC Frameworks for Building PHP Web Applications with Drew Falkman
* TODO Book: Design Patterns: Elements of Reusable Object-Oriented Software (Addison-Wesley)
* TODO Book: Code Complete (2nd Edition, Microsoft Press)
* TODO Let's Encrypt
* TODO custom-elements-everywhere.com, williams sonoma
* TODO gridbyexample.com

* TODO BrowserStack and BeHat
* DONE Chase Payment
* DONE Lynda [[https://www.behance.net/][Behance.net]]
* DONE Lynda Illustrator CC for Web Design: Core Concepts, Aesthetics, Image Optimization, Wireframing, SVG
* DONE Lynda Adobe Illustrator Essential
* DONE Learn Bootstrap CSS framework
* DONE learn emacs org mode
